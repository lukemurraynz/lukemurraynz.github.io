<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.1">
<title data-rh="true">Lukes Tech Blog - Unleashing the power of the cloud and other technologies! | luke.geek.nz</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://luke.geek.nz/img/social-card.png"><meta data-rh="true" name="twitter:image" content="https://luke.geek.nz/img/social-card.png"><meta data-rh="true" property="og:url" content="https://luke.geek.nz/page/5/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" property="og:title" content="Lukes Tech Blog - Unleashing the power of the cloud and other technologies! | luke.geek.nz"><meta data-rh="true" name="description" content="Embark on a tech journey with Luke, a Microsoft Azure MVP, as he delves into the cutting-edge realm of Microsoft and Azure Cloud technologies. Explore, learn, and stay ahead in the dynamic world of cloud computing!"><meta data-rh="true" property="og:description" content="Embark on a tech journey with Luke, a Microsoft Azure MVP, as he delves into the cutting-edge realm of Microsoft and Azure Cloud technologies. Explore, learn, and stay ahead in the dynamic world of cloud computing!"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://luke.geek.nz/page/5/"><link data-rh="true" rel="alternate" href="https://luke.geek.nz/page/5/" hreflang="en"><link data-rh="true" rel="alternate" href="https://luke.geek.nz/page/5/" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://ZBH2T1WJQD-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="luke.geek.nz RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="luke.geek.nz Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="luke.geek.nz JSON Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0QDLBY7NNN"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-0QDLBY7NNN",{anonymize_ip:!0})</script><link rel="stylesheet" href="/assets/css/styles.94a74a36.css">
<script src="/assets/js/runtime~main.66a4f0a8.js" defer="defer"></script>
<script src="/assets/js/main.7741cd03.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"dark")}(),function(){try{const a=new URLSearchParams(window.location.search).entries();for(var[t,e]of a)if(t.startsWith("docusaurus-data-")){var n=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(n,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:#D3D3D3" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY">If you haven't already make sure you sign up for my Weekly Azure Newsletter, straight to your inbox! <a target="_blank" rel="noopener noreferrer" href="https://newsletter.azurefeeds.com/join">Subscribe now!</a></div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="luke.geek.nz" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.png" alt="luke.geek.nz" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">luke.geek.nz</b></a><a class="navbar__item navbar__link" href="/Tags/">Tags</a><a class="navbar__item navbar__link" href="/Archive/">Blog</a><a class="navbar__item navbar__link" href="/about/">About</a></div><div class="navbar__items navbar__items--right"><a href="https://www.youtube.com/channel/UCUG3TKDTAZz4UXshGrjBBoQ" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-icon" aria-label="YouTube">
              <svg width="24" height="24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path d="M23.498,6.186c-0.273-1.186-1.143-2.144-2.332-2.417C18.389,3.153,12,3.153,12,3.153s-6.389,0-9.166,0.616
                  c-1.19,0.273-2.06,1.23-2.332,2.417C0,8.07,0,12,0,12s0,3.93,0.502,5.814c0.272,1.187,1.142,2.062,2.332,2.335
                  C5.611,20.847,12,20.847,12,20.847s6.389,0,9.166-0.698c1.189-0.273,2.059-1.148,2.332-2.335C24,15.93,24,12,24,12
                  S24,8.07,23.498,6.186z M9.545,15.568V8.432l6.545,3.568L9.545,15.568z"/>
              </svg>
            </a><a href="https://aus.social/@lukemurray" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-icon" aria-label="Mastodon">
              <svg height="20" width="20" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" xml:space="preserve">
                <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                <g id="SVGRepo_iconCarrier">
                  <path d="M21.327 8.566c0-4.339-2.843-5.61-2.843-5.61-1.433-.658-3.894-.935-6.451-.956h-.063c-2.557.021-5.016.298-6.45.956 0 0-2.843 1.272-2.843 5.61 0 .993-.019 2.181.012 3.441.103 4.243.778 8.425 4.701 9.463 1.809.479 3.362.579 4.612.510 2.268-.126 3.541-.809 3.541-.809l-.075-1.646s-1.621.511-3.441.449c-1.804-.062-3.707-.194-3.999-2.409a4.523 4.523 0 0 1-.04-.621s1.77.433 4.014.536c1.372.063 2.658-.08 3.965-.236 2.506-.299 4.688-1.843 4.962-3.254.434-2.223.398-5.424.398-5.424zm-3.353 5.59h-2.081V9.057c0-1.075-.452-1.62-1.357-1.62-1 0-1.501.647-1.501 1.927v2.791h-2.069V9.364c0-1.28-.501-1.927-1.502-1.927-.905 0-1.357.546-1.357 1.62v5.099H6.026V8.903c0-1.074.273-1.927.823-2.558.566-.631 1.307-.955 2.228-.955 1.065 0 1.872.409 2.405 1.228l.518.869.519-.869c.533-.819 1.34-1.228 2.405-1.228.92 0 1.662.324 2.228.955.549.631.822 1.484.822 2.558v5.253z"></path>
                </g>
              </svg>
            </a><a href="https://bsky.app/profile/lukemurraynz.bsky.social" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-icon" aria-label="Bluesky">
              <svg class="octicon" xmlns="http://www.w3.org/2000/svg" role="img" viewBox="0 0 16 16" height="20" width="20" fill="currentColor">
                <title>Bluesky</title>
                <path d="M8 7.2c-.72-1.4-2.7-4.04-4.53-5.33C1.7.63 1.04.84.6 1.04.1 1.27 0 2.05 0 2.51c0 .46.25 3.77.42 4.32.54 1.82 2.47 2.45 4.25 2.25-2.6.38-4.92 1.33-1.88 4.71 3.33 3.46 4.57-.74 5.21-2.87.64 2.13 1.37 6.18 5.16 2.87 2.84-2.87.78-4.33-1.83-4.71 1.78.2 3.71-.43 4.25-2.25.17-.55.42-3.86.42-4.32 0-.46-.09-1.24-.6-1.47-.44-.2-1.11-.42-2.87.83A17.87 17.87 0 0 0 8 7.2Z"></path>
              </svg>
            </a><a href="https://twitter.com/lukemurraynz" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-icon" aria-label="X"><svg height="20" width="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 8.586l4.293-4.293a1 1 0 011.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 011.414-1.414L10 8.586z" clip-rule="evenodd"/>
          </svg></a><a href="https://www.linkedin.com/in/ljmurray/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-icon" aria-label="LinkedIn"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" height="20" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854V1.146zm4.943 12.248V6.169H2.542v7.225h2.401zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248-.822 0-1.359.54-1.359 1.248 0 .694.521 1.248 1.327 1.248h.016zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274 0-1.845.7-2.165 1.193v.025h-.016a5.54 5.54 0 0 1 .016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225h2.4z"></path></svg></a><a href="https://luke.geek.nz/rss" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-rss-link" aria-label="RSS"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure/change-timezone-azure-container-app/">Change the Timezone of your Azure Container App</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure/azure-container-apps-overview/">Azure Container Apps - Overview</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure/book-review-cloud-solution-architects-career-master-plan/">Book Review Cloud Solution Architects Career Master Plan</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure/microsoft-azure-sandbox-design-considerations/">Microsoft Azure - Sandbox Design Considerations</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure/tag-azure-resources-owner-azure-automation-runbook/">Tag Azure Resources with Owner using Azure Automation</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="https://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="Private Endpoint traffic can take a different route than your standard traffic and cause some confusion and dropped packets."><meta itemprop="keywords" content="azure,firewall,private endpoint"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/azure/private-endpoint-traffic-not-appearing-azure-firewall/">Private Endpoint traffic not appearing in Azure Firewall</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-10-03T00:00:00.000Z" itemprop="datePublished">October 3, 2023</time> · <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://luke.geek.nz/img/logo.png" alt="Luke Murray" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Luke Murray</span></a></div><small class="avatar__subtitle" itemprop="description">Author</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>You may have a situation where you have implemented <a href="https://learn.microsoft.com/azure/private-link/private-endpoint-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Private endpoints</a> and the traffic from on-premises to those Private Endpoints, either doesn&#x27;t work, even though on-premises firewalls say otherwise, or is working, but doesn&#x27;t appear in the Azure Firewall.</p>
<p>I had this recently with <a href="https://learn.microsoft.com/azure/azure-arc/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Arc</a>, where the endpoints failed to connect once a site-to-site VPN connection <em>(which was working)</em> was replaced with an expressroute connection, but going through the Azure Firewall logs, was unable to see any 443 traffic for Arc, hitting the Firewall even when the connection was working.</p>
<p><img loading="lazy" alt="Private Endpoint traffic not appearing in Azure Firewall" src="/assets/images/BlobHeading_PrivateEndpointtrafficnotappearing-46abd44f0fd04636f0a349e00b724711.gif" width="1200" height="628" class="img_ev3q"></p>
<blockquote>
<p>Traffic flow: Onpremises -- (ER Circuit) -- ER gateway -- Secured hub Azure Firewall -- (Vnet Connection) -- PE (Private Endpoint)</p>
</blockquote>
<p>The issue was related to how private endpoint traffic is routed differently.</p>
<p>If the traffic has reached the Expressroute gateway from on-premises, with routing intent, normal traffic will be forced to the AzFW first before reaching its destination, as you would think and expect.</p>
<blockquote>
<p>However, for the private endpoint scenario, once a Private Endpoint is deployed to any VNET, there will be an automatic system route with the PE IP and prefix /32 installed on all of the linked NICs.
The next hop for this route will be InterfaceEndpoint.
This route will allow the traffic to go directly to the PE, bypassing the routing intent and other user-defined routes that are larger than /32. The /32 route propagates to these areas: Any VPN or ExpressRoute connection to an on-premises system.</p>
</blockquote>
<p>See: <a href="https://learn.microsoft.com/en-us/azure/architecture/guide/networking/private-link-hub-spoke-network?WT.mc_id=AZ-MVP-5004796#considerations" target="_blank" rel="noopener noreferrer">Considerations for Hub and Spoke topology</a>.</p>
<p>In an Azure Virtual Wide Area Network (VWAN), you could see this route in the virtual hub <a href="https://learn.microsoft.com/azure/virtual-wan/effective-routes-virtual-hub?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">effective routes</a> and which gets propagated to the expressroute gateway.</p>
<p>My traffic from on-premises to the Azure Arc went directly to the private endpoints (bypassing the Azure Firewall). Still, the route back via the Azure Firewall was completely different, leading to asymmetric routing <em>(a packet traverses from a source to a destination in one path and takes a different path when it returns to the source)</em>.</p>
<p><strong>To resolve this</strong>, we need to enable network security policies for User-Defined Routes on the subnet of the private endpoint(s):</p>
<p><img loading="lazy" alt="Azure Portal - Private Endpoint - Routes" src="/assets/images/AzurePortal_RouteTables_PrivateEndpoint-036eb8b544141f79ad204b3acd2aeb93.png" width="1816" height="708" class="img_ev3q"></p>
<p>Once enabled, you should see the traffic connect and flow through your Azure Firewall almost immediately.</p>
<p>Reference:</p>
<ul>
<li><a href="https://learn.microsoft.com/azure/private-link/disable-private-endpoint-network-policy?tabs=network-policy-portal&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Manage network policies for private endpoints</a></li>
<li><a href="https://learn.microsoft.com/azure/firewall-manager/private-link-inspection-secure-virtual-hub?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Secure traffic destined to private endpoints in Azure Virtual WAN</a></li>
</ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/azure/">Azure</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="This article is part of Azure Back to School - 2023 event! Make sure to check out the fantastic content created by the community!"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/azure/Empowering-Resilience-with-Azure-backup-services/">Empowering Resilience with Azure backup services</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-09-23T00:00:00.000Z" itemprop="datePublished">September 23, 2023</time> · <!-- -->23 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://luke.geek.nz/img/logo.png" alt="Luke Murray" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Luke Murray</span></a></div><small class="avatar__subtitle" itemprop="description">Author</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>This article is part of <a href="https://azurebacktoschool.github.io/" target="_blank" rel="noopener noreferrer">Azure Back to School</a> - 2023 event! Make sure to check out the fantastic content created by the community!</p>
<p><img loading="lazy" alt="Empowering Resilience with Azure backup services" src="/assets/images/Header-Blog-AzureBackup_Services_Innovations-f2d9510f5e2dd62c9ae8c7b0cb844b2b.gif" width="1200" height="628" class="img_ev3q"></p>
<p>Along with the basics of the Azure Backup solutions, particularly on Virtual Machines running on Microsoft Azure, there have been a lot of changes in the last year, including Immutable vaults, enhanced policies, intelligence tiering, and cross-region restore.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a href="#introduction" class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction">​</a></h2>
<p>Let us start with the basics with a user story; what do we need to achieve:</p>
<blockquote>
<p>&quot;As a Cloud Infrastructure Administrator at Contoso, I want to implement an automated backup solution for virtual machines (Windows and Linux) hosted in Microsoft Azure,
So that I can ensure data reliability, disaster recovery, and compliance with minimal manual intervention.&quot;</p>
</blockquote>
<p>With some assumptions around further requirements, we can jump into solutions using native Microsoft Azure services to fulfil the Cloud Administrator&#x27;s need.
It is worth mentioning, especially around disaster recovery, that there is much more you can (and should do) do around <a href="https://learn.microsoft.com/azure/well-architected/mission-critical/mission-critical-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">mission-critical</a> Azure architecture. This article will focus primarily on the data loss portion of disaster recovery with Azure Backup services.</p>









































































<table><thead><tr><th><strong>Requirement</strong></th><th><strong>Azure Service(s) Used</strong></th></tr></thead><tbody><tr><td>Specific (S): Backup virtual machines in Azure</td><td><a href="https://learn.microsoft.com/azure/backup/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Backup</a>, <a href="https://learn.microsoft.com/azure/site-recovery/site-recovery-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Site Recovery (ASR)</a></td></tr><tr><td>Measurable (M):</td><td></td></tr><tr><td>- Achieve 99% backup success rate</td><td><a href="https://learn.microsoft.com/azure/backup/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Backup</a>, <a href="https://learn.microsoft.com/azure/azure-monitor/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Monitor</a></td></tr><tr><td>- Define and meet RTO <em>(recovery time objective)</em> for critical VMs</td><td><a href="https://learn.microsoft.com/azure/backup/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Backup</a>, <a href="https://learn.microsoft.com/azure/site-recovery/site-recovery-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Site Recovery (ASR)</a></td></tr><tr><td>- Monitor and optimise storage consumption</td><td><a href="https://learn.microsoft.com/azure/azure-monitor/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Monitor</a>, <a href="https://learn.microsoft.com/azure/cost-management-billing/costs/reporting-get-started?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Microsoft Cost Management</a></td></tr><tr><td>Achievable (A):</td><td></td></tr><tr><td>- Select and configure Azure-native backup solution</td><td><a href="https://learn.microsoft.com/azure/backup/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Backup</a></td></tr><tr><td>- Configure Azure permissions and access controls</td><td><a href="https://learn.microsoft.com/azure/role-based-access-control/rbac-and-directory-admin-roles?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Role-Based Access Control (RBAC)</a></td></tr><tr><td>- Define backup schedules and retention policies</td><td><a href="https://learn.microsoft.com/azure/backup/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Backup</a>, <a href="https://learn.microsoft.com/azure/governance/policy/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Policy</a></td></tr><tr><td>Relevant (R):</td><td></td></tr><tr><td>- Align with Azure best practices</td><td><a href="https://learn.microsoft.com/en-us/azure/well-architected/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Well-Architected Framework</a>, <a href="https://learn.microsoft.com/azure/advisor/advisor-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Advisor</a></td></tr><tr><td>- Comply with data protection regulations</td><td><a href="https://learn.microsoft.com/azure/compliance/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Compliance Center</a>, <a href="https://learn.microsoft.com/azure/governance/policy/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Policy</a></td></tr><tr><td>- Support disaster recovery and business continuity</td><td><a href="https://learn.microsoft.com/azure/site-recovery/site-recovery-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Site Recovery (ASR)</a></td></tr><tr><td>Time-bound (T):</td><td></td></tr><tr><td>- Implement within the next two Azure sprint cycles</td><td><a href="https://learn.microsoft.com/azure/devops/boards/get-started/what-is-azure-boards?view=azure-devops&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure DevOps - Boards</a></td></tr><tr><td>- Regular progress reviews during sprint planning</td><td><a href="https://learn.microsoft.com/azure/devops/boards/get-started/what-is-azure-boards?view=azure-devops&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure DevOps - Boards</a></td></tr></tbody></table>













































<table><thead><tr><th><strong>Definition of Done (DoD):</strong></th><th></th></tr></thead><tbody><tr><td>1. Select a cost-effective Azure-native backup solution</td><td><a href="https://learn.microsoft.com/azure/backup/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Backup</a></td></tr><tr><td>2. Configure Azure permissions and access controls</td><td><a href="https://learn.microsoft.com/azure/role-based-access-control/rbac-and-directory-admin-roles?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Role-Based Access Control (RBAC)</a></td></tr><tr><td>3. Define backup policies and RTOs</td><td><a href="https://learn.microsoft.com/azure/backup/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Backup</a>, <a href="https://learn.microsoft.com/azure/governance/policy/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Policy</a></td></tr><tr><td>4. Monitor and meet 99% backup success rate</td><td><a href="https://learn.microsoft.com/azure/azure-monitor/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Monitor</a></td></tr><tr><td>5. Optimize backup storage utilisation</td><td><a href="https://learn.microsoft.com/azure/cost-management-billing/costs/reporting-get-started?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Microsoft Cost Management</a></td></tr><tr><td>6. Create backup and recovery documentation</td><td><a href="https://learn.microsoft.com/azure/backup/backup-azure-restore-files-from-vm?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Microsoft Learn documentation</a></td></tr><tr><td>7. Train the team to manage and monitor the backup system</td><td><a href="https://learn.microsoft.com/training/modules/intro-to-azure-backup/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Training</a></td></tr><tr><td>8. Integrate with Azure monitoring and alerting</td><td><a href="https://learn.microsoft.com/azure/azure-monitor/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Monitor</a></td></tr><tr><td>9. Conduct disaster recovery tests</td><td><a href="https://learn.microsoft.com/azure/site-recovery/site-recovery-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Site Recovery (ASR)</a></td></tr></tbody></table>
<p><em>Note: <a href="https://learn.microsoft.com/azure/devops/boards/get-started/what-is-azure-boards?view=azure-devops&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure DevOps - Boards</a> are outside of the scope of this article; the main reflection here is to make sure that your decisions and designs are documented in line with business requirements.</em>
<em>There are also some further assumptions we will make, particularly around security and RTO requirements for the organisation of Contoso.</em></p>
<p>We know to fulfil the requirements, we need to implement the following:</p>
<ul>
<li><a href="https://learn.microsoft.com/azure/backup/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Backup</a></li>
<li><a href="https://learn.microsoft.com/azure/site-recovery/site-recovery-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Site Recovery (ASR)</a></li>
<li><a href="https://learn.microsoft.com/azure/azure-monitor/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Monitor</a></li>
<li><a href="https://learn.microsoft.com/azure/cost-management-billing/costs/reporting-get-started?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Microsoft Cost Management</a></li>
<li><a href="https://learn.microsoft.com/azure/role-based-access-control/rbac-and-directory-admin-roles?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Role-Based Access Control (RBAC)</a></li>
<li><a href="https://learn.microsoft.com/azure/governance/policy/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Policy</a></li>
</ul>
<p>So, let us take our notebooks and look at the Backup sections.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="backup-center">Backup Center<a href="#backup-center" class="hash-link" aria-label="Direct link to Backup Center" title="Direct link to Backup Center">​</a></h2>
<p>When needing a single control plane for your Backups across multiple tenancies <em>(using <a href="https://learn.microsoft.com/azure/lighthouse/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Lighthouse</a></em>), Subscriptions and regions, then Backup Center is the place to start with.</p>
<blockquote>
<p>&quot;Backup center provides a single unified management experience in Azure for enterprises to govern, monitor, operate, and analyze backups at scale. It also provides at-scale monitoring and management capabilities for Azure Site Recovery. So, it&#x27;s consistent with Azure&#x27;s native management experiences. Backup center is designed to function well across a large and distributed Azure environment. You can use Backup center to efficiently manage backups spanning multiple workload types, vaults, subscriptions, regions, and Azure Lighthouse tenants.&quot;</p>
</blockquote>
<p><img loading="lazy" alt="Backup center" src="/assets/images/AzureBackupCenter_Portal_Overview-4d2a2bcbdbca103d57558ce738180967.png" width="1589" height="874" class="img_ev3q"></p>
<p>As you can see, Backup center can be used to see manage:</p>
<ul>
<li>Backup instances</li>
<li>Backup policies</li>
<li>Vaults</li>
<li>Monitor and report on backup jobs</li>
<li>Compliance <em>(ie Azure Virtual Machines that are not configured for backup)</em></li>
</ul>
<p>You can find the <a href="https://portal.azure.com/#view/Microsoft_Azure_DataProtection/BackupCenterMenuBlade/~/gettingstarted" target="_blank" rel="noopener noreferrer">Backup Center</a> directly in the Azure Portal.</p>
<p><img loading="lazy" alt="Backup center" src="/assets/images/AzurePortal-SearchBackupCenter-1a62aa5a6eb2dbcca94a4e8b9040767e.png" width="738" height="524" class="img_ev3q"></p>
<p>We can create and manage these resources by ourselves, but throughout this article, we will refer back to the Backup Center, to take advantage of the single pane of glass and integrate these resources.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-vault">Create Vault<a href="#create-vault" class="hash-link" aria-label="Direct link to Create Vault" title="Direct link to Create Vault">​</a></h3>
<p>In Microsoft Azure, there are two types of Vaults that the Backup center works with. These vaults are:</p>
<ul>
<li><a href="https://learn.microsoft.com/azure/backup/backup-azure-recovery-services-vault-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Recovery Services vault</a></li>
<li><a href="https://learn.microsoft.com/azure/backup/backup-vault-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Backup vault</a></li>
</ul>
<p><img loading="lazy" alt="Backup center" src="/assets/images/AzurePortal_CreateVault_VaultTypes-25f7a11e956f7d8ae2072f6d923862c0.png" width="1142" height="486" class="img_ev3q"></p>
<p>Depending on your requirements depends on which Vault you will need to create <em>(for our purposes, we will need the Recovery Services vault)</em>; Backup Center makes it remarkably easy to configure a new vault and select the right vault type by using the wizard.</p>
<p><em>Please refer to: <a href="https://learn.microsoft.com/en-us/azure/backup/backup-support-matrix?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Support matrix for Azure Backup</a> for further information.</em></p>
<ol>
<li>Navigate to <strong><a href="https://portal.azure.com/#view/Microsoft_Azure_DataProtection/BackupCenterMenuBlade/~/gettingstarted" target="_blank" rel="noopener noreferrer">Backup Center</a></strong></li>
<li>Click on <strong>Vaults</strong></li>
<li>Click <strong>+ Vault</strong></li>
<li>Select <strong>Recovery Services vault</strong></li>
<li>Select <strong>Continue</strong></li>
<li>Specify a <strong>location</strong> and <strong>Resource Group</strong> to house your Recovery Services vault</li>
<li>Specify your <strong>vault name</strong> <em><a href="https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/resource-abbreviations?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">(abbreviation examples for Azure resources)</a></em></li>
<li>Click <strong>Next: Vault properties</strong></li>
</ol>
<blockquote>
<p>Immutability:
I talked a bit about immutability in another blog article: <a href="https://luke.geek.nz/azure/you-can-t-touch-this-how-to-make-your-azure-backup-immutable-and-secure/" target="_blank" rel="noopener noreferrer">You Can&#x27;t Touch This: How to Make Your Azure Backup Immutable and Secure</a>. Essentially an immutable vault, prevents unauthorised changes and restore point deletions, for this article, we will enable it to prevent unintended or malicious data loss (keep in mind with immutable vaults, reducing retention of recovery points is not allowed).</p>
</blockquote>
<ol>
<li>Check <strong>enabled immutability</strong>, and click <strong>Next: Networking</strong>.</li>
<li>We can join our Recovery Services vault to our <a href="https://learn.microsoft.com/azure/backup/private-endpoints?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">private network using private endpoints</a>, forcing Azure Backup and Site Recovery to traverse a private network, for the purposes of this article, we will skip it. <strong>Click Next: Tags</strong></li>
<li><strong>Enter in Tags</strong> <em>(tags useful for a Recovery Service vault, could be: Application, Support Team, Environment, Cost Center, Criticality)</em></li>
<li>Click <strong>Review + Create</strong></li>
</ol>
<p><img loading="lazy" alt="Create Azure Recovery Services Vault" src="/assets/images/Create_RSV_BackupCenter_AzurePortal-d198cfdd2dfbb36d0ce11db49921f333.gif" width="1893" height="907" class="img_ev3q"></p>
<p>If we navigate back to the <a href="https://portal.azure.com/#view/Microsoft_Azure_DataProtection/BackupCenterMenuBlade/~/gettingstarted" target="_blank" rel="noopener noreferrer">Backup Center</a> and then Vaults (under Manage), we will be able to see the newly created vault.</p>
<p>We now have our Backup solution provisioned for the Cloud Administrator to use, but we next need to define the policies for the backup.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-backup-policies">Create Backup Policies<a href="#create-backup-policies" class="hash-link" aria-label="Direct link to Create Backup Policies" title="Direct link to Create Backup Policies">​</a></h3>
<p>Now that we have our Recovery Services vault, we need to create backup policies; these backup policies will help define the frequency of backups, the retention (Daily, weekly, monthly, yearly) and <a href="https://learn.microsoft.com/azure/backup/use-archive-tier-support?pivots=client-portaltier&amp;WT.mc_id=AZ-MVP-5004796#enable-smart-tiering-to-vault-archive-using-a-backup-policy-preview" target="_blank" rel="noopener noreferrer">vault tiering</a>, which enables the Recovery Services Vault to move recovery vaults to an <a href="https://learn.microsoft.com/en-us/azure/backup/archive-tier-support?WT.mc_id=AZ-MVP-5004796#archive-recommendations-only-for-azure-virtual-machines" target="_blank" rel="noopener noreferrer">archive tier</a> <em>(slower to restore, but can be cheaper overall, for those long retention policies)</em>.</p>
<blockquote>
<p>Backup policies are very organisation-specific and can depend a lot on operational and industry requirements; some industries have a legal obligation to store their backups for a certain number of years, the <a href="https://learn.microsoft.com/en-us/azure/compliance/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure compliance center documentation</a> may help, around security and data requirements, make sure your backup policies are understood by the business you are working with.</p>
</blockquote>
<p>For Contoso, we have the following requirements:</p>













































<table><thead><tr><th>Resource</th><th>Daily</th><th>Weekly</th><th>Monthly</th><th>Yearly</th><th>Snapshot Retention (Hot)</th></tr></thead><tbody><tr><td><strong>Critical Application DB - Prod</strong></td><td>7 days - Every 4 Hours</td><td>4 weeks</td><td>6 months</td><td>7 years</td><td>5 days</td></tr><tr><td><strong>File Server- Prod</strong></td><td>7 days   - Every 4 Hours</td><td>6 weeks</td><td>6 months</td><td>7 years</td><td>5 days</td></tr><tr><td><strong>Web Application VM - Dev</strong></td><td>20 days</td><td>8 weeks</td><td>12 months</td><td>2 years</td><td>2 days</td></tr><tr><td><strong>Database Server - Dev</strong></td><td>30 days</td><td>8 weeks</td><td>12 months</td><td>2 years</td><td>2 days</td></tr></tbody></table>
<p>There are a few things to call out here:</p>
<ul>
<li>We can see that for Development, items need to be retained for 2 years</li>
<li>For Production, its 7 years</li>
<li>Snapshots need to be stored for 5 days and 2 days to allow fast restore</li>
<li>Production requires a backup to be taken every 4 hours to reduce RTO <em>(Recovery point objective)</em></li>
</ul>
<p><img loading="lazy" alt="Create Azure Recovery Services Vault" src="/assets/images/rpo-rto-infographic-eaf32ded76ae2a92856df60086ef4c3d.jpg" width="800" height="312" class="img_ev3q"></p>
<p>If we take a look at the Snapshot retention, we can leverage <a href="https://learn.microsoft.com/en-us/azure/backup/backup-instant-restore-capability?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Instant restore</a> snapshots, to restore the workloads, quickly from the previous 5 days, reducing our time RTO (recovery time objective), and overall impact of an outage or restore, by storing the snapshots locally (as close to the original disk) without putting it (waiting for it) into archive (slower disk), this will incurr more cost, but dramatically reduces restores time. I recommend always keeping a few Instant restore snapshots available for all production systems.</p>
<p><img loading="lazy" alt="Snapshot" src="/assets/images/instant-rp-flow-6fd5403e878ce8ea549e7aeaadecb9a8.png" width="1503" height="390" class="img_ev3q"></p>
<p>Let us create the policies <em>(we will only create one policy, but the same process can be used to create the others)</em>.</p>
<ol>
<li>Navigate to <strong><a href="https://portal.azure.com/#view/Microsoft_Azure_DataProtection/BackupCenterMenuBlade/~/gettingstarted" target="_blank" rel="noopener noreferrer">Backup Center</a></strong></li>
<li>Click on <strong>Backup policies</strong></li>
<li>Click <strong>+ Add</strong>
1 .Select <strong>Azure Virtual Machines</strong></li>
<li><strong>Select</strong> the <strong>Vault</strong> created earlier</li>
<li>Click <strong>Continue</strong></li>
<li>As this will be the policy for the Critical Application DB, we will specify: <strong>Enhanced</strong> <em>(due to the multiple backups, <a href="https://learn.microsoft.com/en-us/azure/storage/common/storage-redundancy?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Zone-redundant storage (ZRS)</a> snapshots)</em></li>
<li>Specify a <strong>Policy name</strong>, ie Tier-1-Prod-AppDB</li>
<li>Specify <strong>Frequency</strong> to: Hourly, Schedule to Every 4 Hours, and Duration: 24 Hours</li>
<li>Specify <strong>Retain instance recovery snapshots</strong> for &#x27;5&#x27; days</li>
<li>Update <strong>Daily Backup point</strong> to: 7 days</li>
<li><strong>Configure the Weekly backup point</strong> to occur every Sunday and retain for 4 weeks</li>
<li><strong>Configure the Monthly backup point</strong> to occur on the first Sunday of the month and retain for 6 months</li>
<li><strong>Configure the yearly backup point</strong> to occur on the first Sunday of the year and retain for 7 years</li>
<li>Select <strong>enable Tiering</strong>, and specify Recommended recovery points</li>
<li>You can also update the Resource Group name used to store the Snapshots.</li>
<li>Click <strong>Create</strong></li>
</ol>
<p><img loading="lazy" alt="Snapshot" src="/assets/images/Create_RSV_AzurePolicyEnhanced-cf9bf2264746adf2a84ee130fce7eb2e.gif" width="1893" height="907" class="img_ev3q"></p>
<p>Note: If you want, you can repeat the same process to create any others you need. Remember, with immutable vaults, you cannot reduce the retention (but you can add), so if starting for the first time, keep the retention low until you have a clear direction of what is required. A workload can use the same policy. A Standard <em>(not Enhanced)</em> policy may be all you need for Development workloads.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="add-virtual-machines">Add Virtual Machines<a href="#add-virtual-machines" class="hash-link" aria-label="Direct link to Add Virtual Machines" title="Direct link to Add Virtual Machines">​</a></h3>
<p>Now that we have our Recovery Services Vault and custom backup policies, it&#x27;s time to add our Virtual Machines to the backup! To do this, we can use the Backup center to view Virtual Machines that are not getting backed up, and then configure the backup.</p>
<ol>
<li>Navigate to <strong><a href="https://portal.azure.com/#view/Microsoft_Azure_DataProtection/BackupCenterMenuBlade/~/gettingstarted" target="_blank" rel="noopener noreferrer">Backup Center</a></strong></li>
<li>Click on <strong>Protectable data sources</strong></li>
<li>Click on the <strong>ellipsis</strong> of a  Virtual Machine you want to backup</li>
<li>Click on <strong>Backup</strong></li>
<li><strong>Select</strong> the appropriate <strong>Backup vault</strong> and <strong>policy</strong></li>
<li>Click <strong>Enable backup</strong></li>
</ol>
<blockquote>
<p>Although cross-region restore is now supported on a Recovery Services vault, the second region is read-only (RA-GRS), so make sure you have a backup recovery vault created in the region (and subscription) of the virtual machines you are trying to protect. Backup center, can see all Recovery services vaults across multiple regions and subscriptions that you have access to.</p>
</blockquote>
<p><img loading="lazy" alt="Add Virtual Machines" src="/assets/images/BackupItem_BackupCenter_RSV_AzurePolicyEnhanced-596ff07a42ef094acce54b682d8f2b7f.gif" width="1893" height="907" class="img_ev3q"></p>
<p>Once added, the Virtual Machine will now get backed up according to the specified policy.</p>
<blockquote>
<p>Its worth noting that you can backup a Virtual Machine if it is deallocated, but it will Crash-consistent <em>(Only the data that already exists on the disk at the time of backup is captured and backed up, and it triggers a disk check during recovery)</em> compared to Application consistent, which is more application and OS aware, so can prepare to the OS and applications for the backups to make sure that everything is written successfully to the disk ahead of the backup. You can read more about <a href="https://learn.microsoft.com/en-us/azure/backup/backup-azure-vms-introduction?WT.mc_id=AZ-MVP-5004796#snapshot-consistency" target="_blank" rel="noopener noreferrer">Snapshot consistency</a>.</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="monitor-backups">Monitor Backups<a href="#monitor-backups" class="hash-link" aria-label="Direct link to Monitor Backups" title="Direct link to Monitor Backups">​</a></h2>
<p>Now that we have our Recovery Services Vault, policies and protected items <em>(backed up Virtual Machines)</em>, we need to monitor to make sure that the backups are working. Backup center gives us a complete view of Failed, In Progress, and Completed jobs in the overview pane, which is excellent for a quick view of the status across subscriptions and regions.</p>
<p><img loading="lazy" alt="Azure BackupCenter" src="/assets/images/Azure_BackupCenter_Overview-d1d90cb6e818858550ab15ac1055d547.png" width="1236" height="815" class="img_ev3q"></p>
<p>But you may want something a bit more detailed; let us look into some of the options for monitoring your backups.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="alerts">Alerts<a href="#alerts" class="hash-link" aria-label="Direct link to Alerts" title="Direct link to Alerts">​</a></h3>
<p>As part of operational checks, you may want assurance or a ticket raised if there&#x27;s an issue with a backup; one of the ways to achieve this is to set up an email alert that will send an email if a backup fails.</p>
<p>By default, these types of alerts are enabled out-of-the-box on a recovery services vault; examples of alerts can be found here: <a href="https://learn.microsoft.com/azure/backup/backup-azure-monitoring-built-in-monitor?tabs=recovery-services-vaults&amp;WT.mc_id=AZ-MVP-5004796#azure-monitor-alerts-for-azure-backup" target="_blank" rel="noopener noreferrer">Azure Monitor alerts for Azure Backup</a>, these can be displayed in the Recovery Services Vault or Backup Center blade, immediately.</p>
<blockquote>
<p>If a destructive operation, such as stop protection with deleted data is performed, an alert is raised, and an email is sent to subscription owners, admins, and co-admins even if notifications aren&#x27;t configured for the Recovery Services vault.</p>
</blockquote>





























<table><thead><tr><th>Type</th><th>Description</th><th>Example alert scenarios</th><th>Benefits</th></tr></thead><tbody><tr><td>Built-in Azure Monitor alerts (AMP alerts)</td><td>These are alerts that will be available out-of-the-box for customers without needing additional configuration by the customer.</td><td>Security scenarios like deleting backup data, soft-delete disabled, vault deleted, etc.</td><td>Useful for critical scenarios where the customer needs to receive alerts without the possibility of alerts being subverted by a malicious admin. Alerts for destructive operations fall under this category</td></tr><tr><td>Metric alerts</td><td>Here, Azure Backup will surface backup health-related metrics for customers&#x27; Recovery Services vaults and Backup vaults. Customers can write alert rules on these metrics.</td><td>Backup health-related scenarios such as backup success alerts, restore success, schedule missed, RPO missed, etc.</td><td>Useful for scenarios where customers would like some control over the creation of alert rules but without the overhead of setting up LA or any other custom data store.</td></tr><tr><td>Custom Log Alerts</td><td>Customers configure their vaults to send data to the Log Analytics workspace and write alert rules on logs.</td><td>&#x27;N&#x27; consecutive failed backup jobs, Spike in storage consumed, etc.</td><td>Useful for scenarios where there is a relatively complex, customer-specific logic needed to generate an alert.</td></tr></tbody></table>
<p>Backup alerts are supported by Azure Monitor, so under <a href="https://learn.microsoft.com/azure/azure-monitor/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Monitor</a>, and Alerts pane you can see all your other alerts, including Azure Backup alerts from a single pane.</p>
<p><img loading="lazy" alt="Azure BackupCenter" src="/assets/images/AzureMonitor_BackupAlert_AzurePortal-d6f1419a3fbbae2c89f25dc019b71c5e.png" width="1920" height="1009" class="img_ev3q"></p>
<p>If you want to configure notifications via emails for other types of alerts, such as Backup failures, we can use <a href="https://learn.microsoft.com/azure/azure-monitor/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Monitor</a> Action Groups and Alert processing rules, to let us know, without having to login to the Azure Portal directly, so let us create an email alert.</p>
<p>To do this, we will create an Action Group and Alert Processing rule.</p>

















<table><thead><tr><th>Component</th><th>Description</th></tr></thead><tbody><tr><td>Action Group</td><td>An Action Group is a collection of actions or tasks that are executed automatically when an alert that matches specific criteria is triggered. Actions can include sending notifications, running scripts, triggering automation, or escalating the alert. Action Groups help streamline incident response and automate actions based on the nature and severity of an alert.</td></tr><tr><td>Alert Processing Rule</td><td>An Alert Processing Rule is a set of conditions and criteria used to filter, categorize, or route incoming alerts within a monitoring or alerting system. These rules enable organizations to define how alerts are processed, prioritize them, and determine the appropriate actions to take when specific conditions are met. Alert Processing Rules are crucial for managing and efficiently responding to alerts.</td></tr></tbody></table>
<ol>
<li>Navigate to <strong><a href="https://portal.azure.com/#view/Microsoft_Azure_DataProtection/BackupCenterMenuBlade/~/gettingstarted" target="_blank" rel="noopener noreferrer">Backup Center</a></strong></li>
<li>Click on <strong>Alerts</strong></li>
<li>Click on <strong>Alert Processing rule</strong></li>
<li>Click <strong>+ Select Scope</strong></li>
<li>Click <strong>All Resource Types</strong>, and Filter by: <strong>Recovery Services Vault</strong></li>
<li><strong>Select</strong> your <strong>Recovery Services vault</strong>, you would like to alert on</li>
<li>Click <strong>Apply</strong></li>
<li>Click on <strong>Filter, and change: Alert condition = Fired</strong>.</li>
<li>Click Next: <strong>Rule Settings</strong></li>
<li>Click <strong>Apply action group</strong></li>
<li>Click <strong>+ Create action group</strong></li>
<li><strong>Select</strong> the Subscription, <strong>Resource Group</strong> to store your action group (i.e. monitor resource group)</li>
<li>Give the <strong>Action Group</strong> a <strong>name</strong>, and give it a Display name</li>
<li>Specify <strong>Notification</strong> type <em>(ie Email/SMS message/push/voice)</em></li>
<li>For this article, we will add an Email <em>(but you can have it ring a number, push a notification to the <a href="https://azure.microsoft.com/en-us/get-started/azure-portal/mobile-app?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Mobile App</a>)</em></li>
<li>Enter in <strong>your details</strong>, then click <strong>Next: Actions</strong></li>
<li>In the Actions pane, is where you can trigger automation, such as Azure Logic Apps, Runbooks, ITSM connections, Webhooks etc., to help self-remediate the issues, or better notifications, such as a Logic App that posts in a Teams channel when an alert is fired, or a wehbook that triggers a webpage to update. In this example, we will leave it empty and rely on email notifications and click Next: Tags</li>
<li>Enter any Tags and click <strong>Review + create</strong></li>
<li>Make note of Suppress Notifications; this could be handy during scheduled maintenance windows where backups may fail due to approved work.</li>
<li>Once the Action Group has been created, click <strong>Next: Scheduling</strong></li>
<li>Select <strong>Always</strong></li>
<li>Click <strong>Next: Details</strong></li>
<li>Enter in a <strong>Resource Group</strong>, for the Alert processing rule to be placed</li>
<li>Enter in <strong>Rule name</strong>, <strong>description</strong> and click <strong>Review + Create</strong></li>
</ol>
<p><img loading="lazy" alt="Azure BackupCenter" src="/assets/images/BackupItem_BackupCenter_RSV_BackupAlertRuleCreation-cad908e18b35d4b3a12f5c9313330fa5.gif" width="1893" height="907" class="img_ev3q"></p>
<p>As you can see Azure Monitor integration into backups, gives you some great options to keep on top of your backups, and integrate with other systems, like your IT Service Management toolsets.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="azure-site-recovery">Azure Site Recovery<a href="#azure-site-recovery" class="hash-link" aria-label="Direct link to Azure Site Recovery" title="Direct link to Azure Site Recovery">​</a></h2>
<p><a href="https://learn.microsoft.com/azure/site-recovery/site-recovery-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Site Recovery (ASR)</a> can be used to migrate workloads, across <a href="https://learn.microsoft.com/azure/reliability/availability-zones-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Availability Zones and regions</a>, by replicating the disks of a Virtual Machine to another region (GRS) or zone (ZRS), in fact <a href="https://learn.microsoft.com/azure/resource-mover/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Resource Mover</a> uses Azure Site Recovery when moving virtual machines between regions. Azure Site Recovery can also help with migrating workloads outside of Azure, to Azure, for disaster recovery.</p>
<p>When looking at migrating workloads, to Azure from the VMWare stack, consider the <a href="https://learn.microsoft.com/azure/site-recovery/site-recovery-deployment-planner?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Site Recovery Deployment Planner for VMware</a> to Azure to assist.</p>
<p>For the purposes of this guide, we will achieve disaster recovery of our virtual machine, by replicating it to another region <em>(i.e. from Australia East to Central India)</em>.</p>
<blockquote>
<p>Azure Recovery Services contributes to your BCDR strategy:
Site Recovery service: Site Recovery helps ensure business continuity by keeping business apps and workloads running during outages. Site Recovery replicates workloads running on physical and virtual machines (VMs) from a primary site to a secondary location. When an outage occurs at your primary site, you fail over to a secondary location, and access apps from there. After the primary location is running again, you can fail back to it.
Backup service: The Azure Backup service keeps your data safe and recoverable.</p>
</blockquote>
<p><img loading="lazy" alt="Azure BackupCenter" src="/assets/images/CausesITDisasters-88a4da45105538385af17f8e3982ecb9.png" width="1098" height="684" class="img_ev3q"></p>
<blockquote>
<p>Just as important (if not more) than the technology to enable this, clear business requirements and preparation is paramount for a successful disaster recovery solution, I highly recommend the <a href="https://techcommunity.microsoft.com/t5/fasttrack-for-azure/introducing-the-azure-business-continuity-guide/ba-p/3905424?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Business Continuity Guide</a>. Supplied by the Microsoft Fastrack team, this guide includes resources to prepare for thorough disaster recovery plan.</p>
</blockquote>
<p>The key to successful disaster recovery is not only the workloads themselves but supporting services, such as DNS, Firewall rules, connectivity etc., that need to be considered, These are out of the scope of this article but the following Microsoft Azure architecture references are worth a read:</p>
<ul>
<li><a href="https://learn.microsoft.com/azure/architecture/solution-ideas/articles/disaster-recovery-enterprise-scale-dr?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Enterprise-scale disaster recovery</a></li>
<li><a href="https://learn.microsoft.com/azure/architecture/solution-ideas/articles/disaster-recovery-smb-azure-site-recovery?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">SMB disaster recovery with Azure Site Recovery</a></li>
<li><a href="https://learn.microsoft.com/azure/site-recovery/azure-to-azure-architecture?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure to Azure disaster recovery architecture</a></li>
<li><a href="https://learn.microsoft.com/azure/architecture/reference-architectures/n-tier/multi-region-sql-server?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Multi-region N-tier application</a></li>
<li><a href="https://learn.microsoft.com/azure/architecture/solution-ideas/articles/build-high-availability-into-your-bcdr-strategy?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Build high availability into your BCDR strategy</a></li>
<li><a href="https://learn.microsoft.com/azure/site-recovery/site-recovery-retain-ip-azure-vm-failover?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Retain IP addresses during failover</a></li>
<li><a href="https://techcommunity.microsoft.com/t5/azure-architecture-blog/empowering-disaster-recovery-for-azure-vms-with-azure-site/ba-p/3885378?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Empowering Disaster Recovery for Azure VMs with Azure Site Recovery and Terraform</a></li>
</ul>
<p>For Azure Site Recovery to work, it relies on a mobility service running within the Virtual Machine to replicate changes, the source virtual machine needs to be on to replicate the changes.</p>
<blockquote>
<p>When you enable replication for a VM to set up disaster recovery, the Site Recovery Mobility service extension installs on the VM and registers it with Azure Site Recovery. During replication, VM disk writes are sent to a cache storage account in the source region. Data is sent from there to the target region, and recovery points are generated from the data.</p>
</blockquote>
<p>Azure Site Recovery, does not currently support virtual machines protected with <a href="https://learn.microsoft.com/azure/virtual-machines/trusted-launch?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Trusted Launch</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="enable-azure-site-recovery">Enable Azure Site Recovery<a href="#enable-azure-site-recovery" class="hash-link" aria-label="Direct link to Enable Azure Site Recovery" title="Direct link to Enable Azure Site Recovery">​</a></h3>
<p>For now, we have &#x27;VM1&#x27; a Ubuntu workload, running in Australia East, with a Public IP, that we will failover to Central India. The source Virtual Machine can be backed up normally by a vault in the source region, and replicated to another vault in the destination region.</p>
<blockquote>
<p>Azure Site Recovery has a specific Operating System and Linux kernel <a href="https://learn.microsoft.com/azure/site-recovery/azure-to-azure-support-matrix?WT.mc_id=AZ-MVP-5004796#replicated-machine-operating-systems" target="_blank" rel="noopener noreferrer">support</a>. Make sure you confirm that your workloads are supported.</p>
</blockquote>
<ol>
<li>Navigate to <strong><a href="https://portal.azure.com/#view/Microsoft_Azure_DataProtection/BackupCenterMenuBlade/~/gettingstarted" target="_blank" rel="noopener noreferrer">Backup Center</a></strong></li>
<li>Click on <strong>Vaults</strong></li>
<li><strong>Create</strong> a new Recovery Services <strong>vault</strong> in your <strong>DR</strong> <em>(Disaster Recovery <strong>region</strong> - ie Central India)</em></li>
<li>Click on <strong>Site Recovery</strong></li>
<li>Under Azure Virtual Machines, click on: <strong>Enable replication</strong></li>
<li>Specify the <strong>source Virtual Machine</strong>, you wish to migrate</li>
<li>Click <strong>Next</strong></li>
<li>Select your <strong>source Virtual Machine</strong></li>
<li>Click <strong>Next</strong></li>
<li>Select the <strong>target location (i.e. Central India)</strong></li>
<li>Select the <strong>target Resource Group</strong></li>
<li>Select the <strong>Target Virtual Network</strong> <em>(create one if it doesn&#x27;t exist)</em></li>
<li>Select the <strong>target subnet</strong></li>
<li>Under the Storage, you can consider changing the replica disk to Standard, to reduce cost (this can be <a href="https://learn.microsoft.com/azure/virtual-machines/disks-convert-types?tabs=azure-portal&amp;WT.mc_id=AZ-MVP-5004796#change-the-type-of-an-individual-managed-disk" target="_blank" rel="noopener noreferrer">changed</a> later).</li>
<li>Select a cache storage account <em>(The cache storage account is a storage account used for transferring the replication data before its written to the destination disk)</em></li>
<li>You can then adjust the availability zone of the destination virtual machine</li>
<li>Click <strong>Next</strong></li>
<li>Here we can <strong>define a Replication Policy</strong> <em>(a replication policy in Azure Site Recovery is a set of rules and configurations that determine how data is replicated from the source environment to the target environment (Azure) in case of a disaster or planned failover, such as retention, ie you can restore a point within the retention period)</em> we will leave the default 24-hour retention policy.</li>
<li>We can specify a Replication Group, An example of a replication group is application servers that need to be consistent with each other, in terms of data <em>( replication policy in Azure Site Recovery is a set of rules and configurations that determine how data is replicated from the source environment to the target environment (Azure) in case of a disaster or planned failover.)</em>.</li>
<li>Specify an automation account to manage the mobility service, and we will leave the update extension to be ASR (Azure Site Recovery) managed.</li>
<li>Click <strong>Next</strong></li>
<li>Click <strong>Enable replication</strong></li>
<li>At the Recovery Services Vault, under Site Recovery Jobs you can monitor the registration, registration and initial replication can take 30-60 minutes to install the agent and start the replication.</li>
</ol>
<p><img loading="lazy" alt="Azure BackupCenter" src="/assets/images/BackupCenter_RSV_EnableAzureSiteRecovery-4fa0daaa292bf6f9113604942480f26a.gif" width="1893" height="907" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="failover-to-the-secondary-region-using-azure-site-recovery">Failover to the secondary region using Azure Site Recovery<a href="#failover-to-the-secondary-region-using-azure-site-recovery" class="hash-link" aria-label="Direct link to Failover to the secondary region using Azure Site Recovery" title="Direct link to Failover to the secondary region using Azure Site Recovery">​</a></h3>
<p>Once your virtual machine has been replicated in the secondary region. you can do a Failover, or Test failover. A Test failover is recommended, in your DR testing, and application testing.</p>
<p><img loading="lazy" alt="Azure BackupCenter" src="/assets/images/ASR_AUE_to_CentralIndia-90bc7c5b21d98f57d02164881d88ae43.png" width="1248" height="616" class="img_ev3q"></p>























































<table><thead><tr><th>Aspect</th><th>Failover</th><th>Test Failover</th></tr></thead><tbody><tr><td>Purpose</td><td>To switch to a secondary site during a disaster or planned maintenance event.</td><td>To validate your disaster recovery plan without impacting production.</td></tr><tr><td>Impact on Production</td><td>Disrupts production services as the primary site becomes unavailable during the failover process.</td><td>No impact on production services; the primary site remains operational.</td></tr><tr><td>Data Replication</td><td>Replicates data from primary to secondary site, making it the active site during the failover.</td><td>Uses the same replicated data but doesn&#x27;t make the secondary site the active site; it&#x27;s for testing purposes only.</td></tr><tr><td>Recovery Time</td><td>Longer recovery time, as it involves setting up and activating the secondary site.</td><td>Faster recovery time, as it doesn&#x27;t require making the secondary site the active site.</td></tr><tr><td>Data Consistency</td><td>Ensures data consistency and integrity during the failover process.</td><td>Ensures data consistency for testing but doesn&#x27;t make the secondary site the primary site.</td></tr><tr><td>Cost</td><td>May incur additional costs due to the resources activated at the secondary site.</td><td>Typically incurs minimal additional costs as it&#x27;s for testing purposes.</td></tr><tr><td>Use Cases</td><td>Actual disaster recovery scenarios or planned maintenance events.</td><td>Testing and validating disaster recovery procedures, training, and compliance.</td></tr><tr><td>Post-Operation</td><td>The secondary site becomes the new primary site until failback is initiated.</td><td>No change to the primary site; the secondary site remains inactive.</td></tr><tr><td>Rollback Option</td><td>Failback operation is required to return to the primary site once it&#x27;s available.</td><td>No need for a rollback; the primary site remains unaffected.</td></tr></tbody></table>
<ol>
<li>Navigate to your destination Recovery Services Vault</li>
<li>Click on REplicated Items</li>
<li>Select the Virtual Machine you wish to recover in your second region</li>
<li>Select Test Failover (or Failover, depending on your requirements)</li>
<li>Select your Recovery point and destination Virtual network</li>
<li>Select Failover</li>
<li>If it is a test failover, you can then Clean up your Test failover <em>(deleted replicated item)</em> after you have tested</li>
</ol>
<p><img loading="lazy" alt="Azure BackupCenter" src="/assets/images/BackupCenter_RSV_TestFailoverAzureSiteRecovery-de77d87bfe5d8f04707caba95ad6c4b2.gif" width="1893" height="907" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="azure-policies">Azure Policies<a href="#azure-policies" class="hash-link" aria-label="Direct link to Azure Policies" title="Direct link to Azure Policies">​</a></h2>
<p>Automatically, mapping of Virtual Machines, to backup policies can be done using <a href="https://learn.microsoft.com/azure/governance/policy/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Policy</a>.</p>
<p>Azure policies such as:</p>
<ul>
<li>Azure Backup should be enabled for Virtual Machines</li>
<li>Configure backup on virtual machines without a given tag to an existing recovery services vault in the same location</li>
<li>Disable Cross Subscription Restore for Backup Vaults</li>
<li>Soft delete should be enabled for Backup Vaults</li>
</ul>
<p>More, are built-in to the Azure policy engine and can be easily assigned, across subscriptions and management groups, found in the Backup Center.</p>
<ol>
<li>Navigate to <strong><a href="https://portal.azure.com/#view/Microsoft_Azure_DataProtection/BackupCenterMenuBlade/~/gettingstarted" target="_blank" rel="noopener noreferrer">Backup Center</a></strong></li>
<li>Click on <strong>Azure policies for backup</strong></li>
<li>Click on a policy and click <strong>Assign</strong></li>
</ol>
<blockquote>
<p>You can find a list of custom and built-in policies at the <a href="https://www.azadvertizer.net/azpolicyadvertizer_all.html" target="_blank" rel="noopener noreferrer">AzPolicyAdvertizerPro</a> website.</p>
</blockquote>
<p><img loading="lazy" alt="Azure AutoManage" src="/assets/images/azure-automanage-intelligently-onboard-services-5a54eeaf53941404cadf42cb7046b4e1.png" width="802" height="562" class="img_ev3q"></p>
<p><a href="https://learn.microsoft.com/azure/automanage/overview-about?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Automanage</a> can be used alongside Azure policy, to onboard Virtual Machines, into backup, patching etc automatically, with reduced manual intervention, and although not directly part of this article, what you have learned can be used to develop your automanage profiles.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/azure/">Azure</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="When considering build agents to use in Azure DevOps (or GitHub), there are 2 main options to consider:"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/azure/hosted-agents-container-apps-job/">Get Ahead with Self-Hosted Agents and Container Apps Jobs</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-09-13T00:00:00.000Z" itemprop="datePublished">September 13, 2023</time> · <!-- -->23 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://luke.geek.nz/img/logo.png" alt="Luke Murray" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Luke Murray</span></a></div><small class="avatar__subtitle" itemprop="description">Author</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>When considering <a href="https://learn.microsoft.com/azure/devops/pipelines/agents/agents?view=azure-devops&amp;tabs=yaml%2Cbrowser&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">build agents</a> to use in <a href="https://azure.microsoft.com/products/devops?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure DevOps</a> <em>(or <a href="https://docs.github.com/en/actions/using-github-hosted-runners/about-github-hosted-runners" target="_blank" rel="noopener noreferrer">GitHub</a>)</em>, there are 2 main options to consider:</p>

















<table><thead><tr><th>Agent type</th><th>Description</th></tr></thead><tbody><tr><td><a href="https://learn.microsoft.com/azure/devops/pipelines/agents/agents?view=azure-devops&amp;tabs=yaml%2Cbrowser&amp;WT.mc_id=AZ-MVP-5004796#microsoft-hosted-agents" target="_blank" rel="noopener noreferrer">Microsoft-hosted agents</a></td><td>Agents hosted and managed by Microsoft</td></tr><tr><td><a href="https://learn.microsoft.com/azure/devops/pipelines/agents/agents?view=azure-devops&amp;tabs=yaml%2Cbrowser&amp;WT.mc_id=AZ-MVP-5004796#install" target="_blank" rel="noopener noreferrer">Self-hosted agents</a></td><td>Agents that you configure and manage, hosted on your VMs</td></tr></tbody></table>
<p><a href="https://learn.microsoft.com/en-us/azure/devops/pipelines/agents/hosted?view=azure-devops&amp;tabs=yaml&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Microsoft-hosted agents</a>, can be used for most things, but there are times where you may need to talk to internal company resources, or security is a concern, which is when you would consider self-hosting the agent yourself.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/azure/">Azure</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Get Ahead with Self-Hosted Agents and Container Apps Jobs" href="/azure/hosted-agents-container-apps-job/"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="Deployment Stacks! What is it? insert confused look*"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/azure/Azure-Bicep-Deployment-with-Deployment-Stacks/">Azure Bicep Deployment with Deployment Stacks</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-08-28T00:00:00.000Z" itemprop="datePublished">August 28, 2023</time> · <!-- -->14 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://luke.geek.nz/img/logo.png" alt="Luke Murray" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Luke Murray</span></a></div><small class="avatar__subtitle" itemprop="description">Author</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><a href="https://learn.microsoft.com/azure/azure-resource-manager/bicep/deployment-stacks?tabs=azure-powershell&amp;WT.mc*id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Deployment Stacks</a>! What is it? <em>insert confused look</em></p>
<p>Maybe you have been browsing the Microsoft Azure Portal and noticed a new section in the management blade called: Deployment stacks and wondered what it was, and how you can use it.</p>
<p>Let us take a look!</p>
<blockquote>
<p>Before we get started its worth noting that as of the time of this article, this feature is under Public Preview. Features or ways of working with Deployment Stacks may change, when it becomes generally available. If you run into issues, make sure you have a look at the current <a href="https://learn.microsoft.com/en-us/azure/azure-resource-manager/bicep/deployment-stacks?tabs=azure-powershell&amp;WT.mc*id=AZ-MVP-5004796#known-issues" target="_blank" rel="noopener noreferrer">known issues</a>.</p>
</blockquote>
<p><img loading="lazy" alt="Automate your Azure Bicep deployment with ease using Deployment Stacks" src="/assets/images/Blog-Header-AzureDeploymentStacks-564504ae73ac88f9d1e0596f5c6ab693.gif" width="1200" height="628" class="img_ev3q"></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">​</a></h5>
<p><a href="https://learn.microsoft.com/azure/azure-resource-manager/bicep/deployment-stacks?tabs=azure-powershell&amp;WT.mc*id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Deployment Stacks</a> are a type of Azure resource that allows you to manage a group of Azure resources as an atomic unit.</p>
<p>When you submit a Bicep file or an ARM template to a deployment stack, it defines the resources that are managed by the stack.</p>
<p>You can create and update deployment stacks using Azure CLI, Azure PowerShell, or the Azure portal along with Bicep files. These Bicep files are transpiled into ARM JSON templates, which are then deployed as a deployment object by the stack.</p>
<p>Deployment stacks offer additional capabilities beyond regular deployment resources, such as simplified provisioning and management of resources, preventing undesired modifications to managed resources, efficient environment cleanup, and the ability to utilize standard templates like Bicep, ARM templates, or Template specs.</p>
<blockquote>
<p>When planning your deployment and determining which resource groups should be part of the same stack, it&#x27;s important to consider the management lifecycle of those resources, which includes creation, updating, and deletion. For instance, suppose you need to provision some test VMs for various application teams across different resource group scopes.</p>
</blockquote>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="comparisons">Comparisons<a href="#comparisons" class="hash-link" aria-label="Direct link to Comparisons" title="Direct link to Comparisons">​</a></h5>
<p>Before we dig into it further, it may help to give you a comparison between the different products and where Deployment Stacks, could be used, lets us take a look at a comparison, between similar products, that may come to mind, such as:</p>
<ul>
<li>Azure Blueprints</li>
<li>Bicep <em>(on its own)</em></li>
<li>Template Specs</li>
<li>Terraform</li>
</ul>





















































<table><thead><tr><th>Feature</th><th>Deployment Stacks</th><th>Azure Blueprints</th><th>Using Bicep</th><th>Template Specs</th><th>Terraform</th></tr></thead><tbody><tr><td>Management of Resources</td><td>Manages a group of Azure resources as an atomic unit.</td><td>Defines and deploys a repeatable set of Azure resources that adhere to organizational standards.</td><td>Defines and deploys Azure resources using a declarative language.</td><td>Defines and deploys reusable infrastructure code using template specs.</td><td>Defines and provisions infrastructure resources across various cloud providers using a declarative language.</td></tr><tr><td>Resource Definition</td><td>Bicep files or ARM JSON templates are used to define the resources managed by the stack.</td><td>Blueprint artifacts, including ARM templates, policy assignments, role assignments, and resource groups, are used to define the blueprint.</td><td>Bicep files are used to define the Azure resources.</td><td>Template specs are used to define reusable infrastructure code.</td><td>Terraform configuration files are used to define the infrastructure resources.</td></tr><tr><td>Access Control</td><td>Access to the deployment stack can be restricted using Azure role-based access control (Azure RBAC).</td><td>Access to blueprints is managed through Azure role-based access control (Azure RBAC).</td><td>Access to Azure resources is managed through Azure role-based access control (Azure RBAC).</td><td>Access to template specs is managed through Azure role-based access control (Azure RBAC).</td><td>Access to cloud resources is managed through provider-specific authentication mechanisms.</td></tr><tr><td>Benefits</td><td><em>Simplified provisioning and management of resources as a cohesive entity.</em>  Preventing undesired modifications to managed resources.*Efficient environment cleanup.*Utilizing standard templates such as Bicep, ARM templates, or Template specs for your deployment stacks.</td><td><em>Rapidly build and start up new environments with organizational compliance.</em>  Built-in components for speeding up development and delivery.</td><td>*Easier management and deployment of Azure resources.*Improved readability and understanding of resource configurations.</td><td>*  Publish libraries of reusable infrastructure code.</td><td>*  Infrastructure-as-Code approach for provisioning resources across multiple cloud providers.</td></tr><tr><td>Deprecation</td><td>N/A</td><td>Azure Blueprints (Preview) will be deprecated.</td><td>N/A</td><td>N/A</td><td>N/A</td></tr></tbody></table>
<p><em>It is always recommended to refer to the <a href="https://learn.microsoft.com/?WT.mc*id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">official documentation</a> for the most up-to-date and comprehensive information. The comparison table above, was created with the help of AI.</em></p>
<p>It is hard to do a complete comparison, as always &#x27;it depends&#x27; on your use cases and requirements, but hopefully this makes it clear where Deployment Stacks come into play (and it does not replace Bicep but works with it for better governance), with out-of-the-box benefits such as:</p>
<ul>
<li>Simplified provisioning and management of resources across different scopes as a cohesive entity.</li>
<li>Preventing undesired modifications to managed resources through deny settings.</li>
<li>Efficient environment cleanup by employing delete flags during deployment stack updates.</li>
<li>Utilizing standard templates such as Bicep, ARM templates, or Template specs for your deployment stacks.</li>
</ul>
<blockquote>
<p>The key here is that Azure Deployment Stacks, is a native way to treat your infrastructure components as an atmonic unit or stack, so you manage the lifecycle of the resources as a whole vs every resource separately.</p>
</blockquote>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="using-deployment-stacks">Using Deployment Stacks<a href="#using-deployment-stacks" class="hash-link" aria-label="Direct link to Using Deployment Stacks" title="Direct link to Using Deployment Stacks">​</a></h5>
<p>Deployment stacks requires <a href="https://learn.microsoft.com/powershell/azure/install-azure-powershell?WT.mc*id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure PowerShell</a> <em>(version 10.1.0 or later)</em> or <a href="https://learn.microsoft.com/cli/azure/install-azure-cli?WT.mc*id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure CLI</a> <em>(version 2.50.0 or later)</em>.</p>
<p>For the purposes of this article, I will be using PowerShell.</p>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id="powershell">PowerShell<a href="#powershell" class="hash-link" aria-label="Direct link to PowerShell" title="Direct link to PowerShell">​</a></h6>
<p>Once you have the latest Azure PowerShell modules, its time to take a look at the cmdlets, that are offered to us for Deployment Stacks.</p>
<p>Open your PowerShell terminal and type in:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Get-Command -Name *DeploymentStack*</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img loading="lazy" alt="Get-Command -Name DeploymentStack" src="/assets/images/DeploymentStacks-PowerShellCmdlets-026dd255d9fafc37ec418ee45204b5a6.gif" width="1025" height="309" class="img_ev3q">
As you can see, there are a range of cmdlets we have to work with.</p>
<p>For the purpose of this article, I will be using a Bicep file, I already have on hand (unmodified for Deployment Stacks). This bicep file will create:</p>
<ul>
<li>2 Virtual Networks</li>
<li>4 Subnets <em>(2 subnets in each Virtual Network)</em></li>
<li>4 NSGs <em>(and assign to each subnet, with Deny All rules)</em></li>
<li>Then finally, peer the virtual networks.</li>
</ul>
<p>This is the Bicep file:</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">main.bicep</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token decorator">@description</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Name of the virtual network.&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> vnetName </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;myVnet&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token decorator">@description</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Name of the first subnet.&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> subnet1Name </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;subnet1&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token decorator">@description</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Name of the second subnet.&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> subnet2Name </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;subnet2&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token decorator">@description</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Name of the first network security group.&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> nsg1Name </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;nsg1&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token decorator">@description</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Name of the second network security group.&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> nsg2Name </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;nsg2&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token decorator">@description</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Name of the second virtual network.&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> vnet2Name </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;myVnet2&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token decorator">@description</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Name of the third subnet.&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> subnet3Name </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;subnet3&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token decorator">@description</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Name of the fourth subnet.&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> subnet4Name </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;subnet4&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token decorator">@description</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Name of the third network security group.&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> nsg3Name </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;nsg3&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token decorator">@description</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Name of the fourth network security group.&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> nsg4Name </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;nsg4&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token decorator">@description</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Location for all resources.&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> location </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">resourceGroup</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">location</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> vnet </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Microsoft.Network/virtualNetworks@2023-04-01&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> vnetName</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">location</span><span class="token operator">:</span><span class="token plain"> location</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">addressSpace</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">addressPrefixes</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;10.0.0.0/16&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> subnet1 </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Microsoft.Network/virtualNetworks/subnets@2023-04-01&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">parent</span><span class="token operator">:</span><span class="token plain"> vnet</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> subnet1Name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">addressPrefix</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;10.0.1.0/24&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">networkSecurityGroup</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">id</span><span class="token operator">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">resourceId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Microsoft.Network/networkSecurityGroups&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> nsg1Name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> subnet2 </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Microsoft.Network/virtualNetworks/subnets@2023-04-01&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">parent</span><span class="token operator">:</span><span class="token plain"> vnet</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> subnet2Name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">addressPrefix</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;10.0.2.0/24&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">networkSecurityGroup</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">id</span><span class="token operator">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">resourceId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Microsoft.Network/networkSecurityGroups&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> nsg2Name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> nsg1 </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Microsoft.Network/networkSecurityGroups@2023-04-01&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> nsg1Name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">location</span><span class="token operator">:</span><span class="token plain"> location</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">flushConnection</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">securityRules</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Deny-All-Inbound&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">priority</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">4096</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">access</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Deny&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">direction</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Inbound&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">destinationPortRange</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;*&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">protocol</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Tcp&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">sourcePortRange</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;*&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">destinationAddressPrefix</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;*&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">sourceAddressPrefix</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;*&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> nsg2 </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Microsoft.Network/networkSecurityGroups@2023-04-01&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> nsg2Name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">location</span><span class="token operator">:</span><span class="token plain"> location</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">flushConnection</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">securityRules</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Deny-All-Inbound&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">priority</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">4096</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">access</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Deny&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">direction</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Inbound&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">destinationPortRange</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;*&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">protocol</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Tcp&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">sourcePortRange</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;*&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">destinationAddressPrefix</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;*&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">sourceAddressPrefix</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;*&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> vnet2 </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Microsoft.Network/virtualNetworks@2023-04-01&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> vnet2Name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">location</span><span class="token operator">:</span><span class="token plain"> location</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">addressSpace</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">addressPrefixes</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;10.1.0.0/16&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> subnet3 </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Microsoft.Network/virtualNetworks/subnets@2023-04-01&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">parent</span><span class="token operator">:</span><span class="token plain"> vnet2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> subnet3Name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">addressPrefix</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;10.1.1.0/24&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">networkSecurityGroup</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">id</span><span class="token operator">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">resourceId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Microsoft.Network/networkSecurityGroups&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> nsg3Name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> subnet4 </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Microsoft.Network/virtualNetworks/subnets@2023-04-01&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">parent</span><span class="token operator">:</span><span class="token plain"> vnet2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> subnet4Name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">addressPrefix</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;10.1.2.0/24&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">networkSecurityGroup</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">id</span><span class="token operator">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">resourceId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Microsoft.Network/networkSecurityGroups&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> nsg4Name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> nsg3 </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Microsoft.Network/networkSecurityGroups@2023-04-01&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> nsg3Name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">location</span><span class="token operator">:</span><span class="token plain"> location</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">flushConnection</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">securityRules</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Deny-All-Inbound&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">priority</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">4096</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">access</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Deny&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">direction</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Inbound&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">destinationPortRange</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;*&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">protocol</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Tcp&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">sourcePortRange</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;*&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">destinationAddressPrefix</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;*&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">sourceAddressPrefix</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;*&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> nsg4 </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Microsoft.Network/networkSecurityGroups@2023-04-01&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> nsg4Name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">location</span><span class="token operator">:</span><span class="token plain"> location</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">flushConnection</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">securityRules</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Deny-All-Inbound&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">priority</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">4096</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">access</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Deny&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">direction</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Inbound&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">destinationPortRange</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;*&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">protocol</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Tcp&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">sourcePortRange</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;*&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">destinationAddressPrefix</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;*&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">sourceAddressPrefix</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;*&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> vnetPeering </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Microsoft.Network/virtualNetworks/virtualNetworkPeerings@2023-04-01&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">parent</span><span class="token operator">:</span><span class="token plain"> vnet</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> vnet2Name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">remoteVirtualNetwork</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">id</span><span class="token operator">:</span><span class="token plain"> vnet2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">id</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">allowVirtualNetworkAccess</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">allowForwardedTraffic</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">allowGatewayTransit</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">useRemoteGateways</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">dependsOn</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    subnet1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    subnet3</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> vnetPeering2 </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Microsoft.Network/virtualNetworks/virtualNetworkPeerings@2023-04-01&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">parent</span><span class="token operator">:</span><span class="token plain"> vnet2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> vnetName</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">remoteVirtualNetwork</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">id</span><span class="token operator">:</span><span class="token plain"> vnet</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">id</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">allowVirtualNetworkAccess</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">allowForwardedTraffic</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">allowGatewayTransit</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">useRemoteGateways</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">dependsOn</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    subnet2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    subnet4</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    vnetPeering</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>I have already deployed a new Resource Group to deploy our virtual network into:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">New-AzResourceGroup -Name &#x27;rg-network&#x27; -Location &#x27;Australia East&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>So let us create our first Deployment Stack!</p>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id="new-azresourcegroupdeploymentstack">New-AzResourceGroupDeploymentStack<a href="#new-azresourcegroupdeploymentstack" class="hash-link" aria-label="Direct link to New-AzResourceGroupDeploymentStack" title="Direct link to New-AzResourceGroupDeploymentStack">​</a></h6>
<p>The &#x27;New-AzResourceGroupDeploymentStack&#x27; cmdlet is the first one we will look into.</p>
<p>Let us look at the most common syntax that you may use:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">New-AzResourceGroupDeploymentStack -Name &quot;&lt;deployment-stack-name&gt;&quot; -TemplateFile &quot;&lt;bicep-file-name&gt;&quot; -DeploymentResourceGroupName &quot;&lt;resource-group-name&gt;&quot; -DenySettingsMode &quot;none&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>









































<table><thead><tr><th>Parameter</th><th>Description</th></tr></thead><tbody><tr><td><code>-Name</code></td><td>Specifies the name of the deployment stack.</td></tr><tr><td><code>-Location</code></td><td>Specifies the Azure region where the deployment stack will be created. This is valid for Subscription based DeploymentStacks.</td></tr><tr><td><code>-TemplateFile</code></td><td>Specifies the Bicep file that defines the resources to be managed by the deployment stack.</td></tr><tr><td><code>-DeploymentResourceGroupName</code></td><td>Specifies the name of the resource group where the managed resources will be stored.</td></tr><tr><td><code>-DenySettingsMode</code></td><td>Specifies the operations that are prohibited on the managed resources to safeguard against unauthorized deletion or updates. Possible values include &quot;none&quot;, &quot;DenyDelete&quot;, &quot;DenyWriteAndDelete&quot;.</td></tr><tr><td><code>-DeleteResources</code></td><td>Deletes the managed resources associated with the deployment stack.</td></tr><tr><td><code>-DeleteAll</code></td><td>Deletes all deployment stacks and their associated resources.</td></tr><tr><td><code>-DeleteResourceGroups</code></td><td>Deletes the resource groups associated with the deployment stacks.</td></tr></tbody></table>
<p>These parameters allow you to customize the creation and management of deployment stacks.</p>
<p>The DenySettingsMode parameter is used in Azure Deployment Stacks to assign specific permissions to managed resources, preventing their deletion by unauthorized security principals, this is a key differentiator to some of the other solutions mentioned earlier, but it does mean you need to think about how your resources will be managed, let us take a look at the DenySettingsMode a bit deeper.</p>
<p>The DenySettingsMode parameter accepts different values to define the level of deny settings. Some of the possible values include:</p>
<ul>
<li>&quot;none&quot;: No deny settings are applied, allowing all operations on the managed resources.</li>
<li>&quot;DenyDelete&quot;: Denies the delete operation on the managed resources, preventing their deletion.</li>
<li>&quot;DenyWriteAndDelete&quot;: Denies all operations on the managed resources, preventing any modifications or deletions.</li>
</ul>
<p>By specifying the appropriate DenySettingsMode value, you can control the level of permissions and restrictions on the managed resources within the deployment stack.</p>
<p>For our testing, we will deploy our Azure Virtual Networks, NSGs to a new Deployment Stack, using the DenyDelete DenySettingMode.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$RGName = &#x27;rg-network&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$DenySettings = &#x27;DenyDelete&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$BicepFileName = &#x27;main.bicep&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$DeploymentStackName = &#x27;NetworkProd&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">New-AzResourceGroupDeploymentStack -Name $DeploymentStackName -TemplateFile $BicepFileName -ResourceGroupName $RGName -DenySettingsMode $DenySettings -DenySettingsApplyToChildScopes</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img loading="lazy" alt="New-AzResourceGroupDeploymentStack" src="/assets/images/DeploymentStacks-NewAzResourceGroupDeployment-9bddf7b908a3977665163564aa2050d7.gif" width="1072" height="386" class="img_ev3q"></p>
<p>As you can see, creating a new Azure Deployment Stack is easy, with no adjustments to the underlying Bicep configuration needed.</p>
<p><em>Note: If you get an error, that the cmdlet is missing -Name parameter, make sure that the -ResourceGroupName parameter has been added.</em></p>
<p>If we navigate to the Azure Portal, we can see the Deployment Stack natively, including the Stack properties, such as what are the actions if resources are removed, what the denyDelete mode is.</p>
<p><img loading="lazy" alt="New-AzResourceGroupDeploymentStack" src="/assets/images/DeploymentStacks-AzurePortalOverview-2549a0ef65077b64ea30eea043d768e7.gif" width="1697" height="874" class="img_ev3q"></p>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id="testing-deny-assignment">Testing Deny-Assignment<a href="#testing-deny-assignment" class="hash-link" aria-label="Direct link to Testing Deny-Assignment" title="Direct link to Testing Deny-Assignment">​</a></h6>
<p>As we deployed our virtual networks, using the denyDelete assignment, lets take a look and attempt to delete a Network Security Group, before we do that we need to dissociate it from the subnet.</p>
<p><em>Note: Its worth noting my permissions are: Owner.</em></p>
<p>When I attempted to delete a Network Security Group I get the error below:</p>
<blockquote>
<p>Failed to delete network security group &#x27;nsg1&#x27;. Error: The client &#x27;************&#x27; with object id &#x27;cb059544-e63c-4543-930f-4b6e6b7aece1&#x27; has permission to perform action &#x27;Microsoft.Network/networkSecurityGroups/delete&#x27; on scope &#x27;rg-network/providers/Microsoft.Network/networkSecurityGroups/nsg1&#x27;&gt;nsg1&#x27;; however, the access is denied because of the deny assignment with name &#x27;Deny assignment &#x27;55ebfe82-255d-584a-8579-0e0c9f0219ff&#x27; created by Deployment Stack &#x27;/subscriptions/f0ee3c31-ff51-4d47-beb2-b1204a511f63&#x27;.</p>
</blockquote>
<p><img loading="lazy" alt="Azure Deployment Stack - Delete Resource Test" src="/assets/images/DeploymentStacks-AzurePortal-DenyAssignmentTest-c5eb08ba80367c9b541c85fa0f77b600.gif" width="1697" height="874" class="img_ev3q"></p>
<p>To delete the resource, I would need to, do one of the following:</p>
<ul>
<li>Delete the Deployment Stack (and detach the resources and delete it manually)</li>
<li>Delete the Deployment Stack (and delete all the resources)</li>
<li>Remove from the bicep code and update deployment stack.</li>
</ul>
<p>Note: In our testing, we were able to disassociate the Network Security Group, from the Subnet, because when the deployment stack was deployed - it was with the: denyDelete assignment, not the:&#x27;DenyWriteAndDelete&#x27;.</p>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id="redeploy---deployment-stack-portal">Redeploy - Deployment Stack (Portal)<a href="#redeploy---deployment-stack-portal" class="hash-link" aria-label="Direct link to Redeploy - Deployment Stack (Portal)" title="Direct link to Redeploy - Deployment Stack (Portal)">​</a></h6>
<p>Using the Azure Portal, we can Edit and re-deploy our existing Deployment stack, if you have changes or resources that you may want to roll back:</p>
<p><img loading="lazy" alt="Azure Deployment Stack - Delete Resource Test" src="/assets/images/DeploymentStacks-AzurePortal-RedeployDeploymentStack-21280487c4e7d54cdd121c45554f2b17.gif" width="1697" height="874" class="img_ev3q"></p>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id="redeploy---deployment-stack-bicep">Redeploy - Deployment Stack (Bicep)<a href="#redeploy---deployment-stack-bicep" class="hash-link" aria-label="Direct link to Redeploy - Deployment Stack (Bicep)" title="Direct link to Redeploy - Deployment Stack (Bicep)">​</a></h6>
<p>What if we want to make further changes, such as removing resources from our Deployment Stack?</p>
<p>In this example, we will modify our bicep code to remove the second Virtual network, subnets and associated NSGs (Network Security Groups), and remove the resources from Azure completely <em>(we can unattach them, which will remove them from being managed by the deployment stack)</em>, but I want my Virtual Network resources to be managed completely by Bicep.</p>
<p>We could use the: Save-AzResourceGroupDeploymentStackTemplate, to save the Deployment Stack to an ARM template, if we wanted to deploy it later.</p>
<p><em>Note: In the bicep code example supplied earlier I removed everything after NSG2.</em></p>
<p>We will run the Set-AzResourceGroupDeploymentStack, pointing to the modified bicep code:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$RGName = &#x27;rg-network&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$DenySettings = &#x27;DenyWriteAndDelete&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$BicepFileName = &#x27;main.bicep&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$DeploymentStackName = &#x27;NetworkProd&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Set-AzResourceGroupDeploymentStack -Name $DeploymentStackName -ResourceGroupName $RGName -TemplateFile $BicepFileName -DenySettingsMode $DenySettings -DeleteResources -Verbose -DenySettingsApplyToChildScopes</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In this example, we tell Deployment Stacks to Delete Resources that are no longer part of the stack, and this time we will add the Verbose flag, so we can see what it is doing.</p>
<p><img loading="lazy" alt="Azure Deployment Stack - Delete Resource Test" src="/assets/images/DeploymentStacks-PowerShell-RedeployDeploymentStack-411460fee235b420a83aac2092f36ab0.gif" width="1068" height="292" class="img_ev3q"></p>
<p><em>Note: I cut the gif, thats why the timestamps don&#x27;t match, or you could be spending 10 minutes staring at the verbose output.</em></p>
<p>If we navigate to the Azure Portal, we can see the deleted resources listed in the Deployment stack history <em>(only displays the last Deployment stack changes vs keeping a history of everything)</em>, and the Resource un-managed state has changed to: delete.</p>
<p><img loading="lazy" alt="Azure Deployment Stack - Delete Resource Test" src="/assets/images/DeploymentStacks-PowerShell-RedeployDeploymentStackOverview-beaaa4632febe9a02e66ec9b09fefd17.gif" width="1714" height="894" class="img_ev3q"></p>
<p>Note: A manually created Virtual Network in the same Resource Group (but not part of the deployment stack) remained untouched.</p>
<p><em>I forgot to update, the DenySettings variable, so once I re-deployed with the &#x27;DenyWriteAndDelete&#x27; instead of: &#x27;DenyDelete&#x27;. I was unable to disassociate my Network Security Group.</em></p>
<p><img loading="lazy" alt="Azure Deployment Stack - Delete Resource Test" src="/assets/images/DeploymentStacks-Portal-NSG_Modification-86f57308017f532e5445c2f920e9865a.gif" width="1714" height="894" class="img_ev3q"></p>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id="permissions">Permissions<a href="#permissions" class="hash-link" aria-label="Direct link to Permissions" title="Direct link to Permissions">​</a></h6>
<p>I have &#x27;Owner&#x27; rights over my own demo subscriptions, so a bit more flexibility than I would have in a Production environment.</p>
<p>You can add <a href="https://learn.microsoft.com/azure/azure-resource-manager/bicep/deployment-stacks?tabs=azure-powershell&amp;WT.mc_id=AZ-MVP-5004796#protect-managed-resources-against-deletion" target="_blank" rel="noopener noreferrer">exclusions</a> to your Deployment Stack, allowing certain principals or actions to be completed.</p>
<p>You could also create custom role (Microsoft.Resources/deploymentStacks) to be able to Read, Update or delete deployment stacks, giving you the flexibility to allow people to modify their own stacks and redeploy, without accessing to other tooling required and self-service functionality, such as being able to give someone a deployment stack, that the users can then delete the resources and redeploy later straight from the Azure Portal when required for testing.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/azure/">Azure</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="Working with Azure Bicep using Visual Studio Code, is as native as an experience as you can get, made even better by the Bicep Visual Studio Code extension."><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/azure/Azure-Bicep-Deploy-Pane/">Azure Bicep - Deploy Pane</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-08-18T00:00:00.000Z" itemprop="datePublished">August 18, 2023</time> · <!-- -->2 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://luke.geek.nz/img/logo.png" alt="Luke Murray" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Luke Murray</span></a></div><small class="avatar__subtitle" itemprop="description">Author</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Working with <a href="https://learn.microsoft.com/en-us/azure/azure-resource-manager/bicep/overview?tabs=bicep&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Bicep</a> using Visual Studio Code, is as native as an experience as you can get, made even better by the <a href="https://marketplace.visualstudio.com/items?itemName=ms-azuretools.vscode-bicep" target="_blank" rel="noopener noreferrer">Bicep Visual Studio Code extension</a>.</p>
<p>The Bicep Visual Studio Code extension keeps evolving, with a recent (Experimental) feature being added called the <strong>Deploy Pane</strong>.</p>
<blockquote>
<p>The Deployment Pane is a UI panel in VSCode that allows you to connect to your Azure subscription and execute validate, deploy &amp; whatif operations and get instant feedback without leaving the editor.</p>
</blockquote>
<p><img loading="lazy" alt="Azure Bicep - Deploy Pane" src="/assets/images/VisualStudioCode_DeployPane-b366d4a8a89b7496c00e15ea6b328464.png" width="1491" height="760" class="img_ev3q"></p>
<p>The Deploy Pane, brings together some key actions:</p>
<ul>
<li>Deploy</li>
<li>Validate</li>
<li>What-If</li>
</ul>
<p>The Deploy step, will deploy the Bicep file using the Subscription Scope and ID specified in the pane.
The validate step, will validate that the Bicep syntax is correct for the Azure Resource Manager to process the template.
The What-If step, will let you know what it will deploy and what changes will be made, without having to deploy or touch any resources.</p>
<p>To enable the new Experimental Feature, make sure you are running the latest version of both Bicep, and the Bicep Visual Studio Code extension.</p>
<ol>
<li>Click on <strong>Settings</strong></li>
<li>Expand <strong>Extensions</strong></li>
<li>Navigate to: <strong>Bicep</strong></li>
<li>Check the box labelled: <strong>Experimental: Deploy Pane</strong></li>
</ol>
<p><img loading="lazy" alt="Azure Bicep - Deploy Pane" src="/assets/images/Bicep-DeploymentPreviewPane-9355040071cca56c4bd58e411f280351.gif" width="1908" height="944" class="img_ev3q"></p>
<p>Once enabled, you will see the new Deploy Pane, appear in the top right of your Visual Studio code interface, next to Bicep Visualizer, once you have a Bicep file loaded.</p>
<p><img loading="lazy" alt="Azure Bicep - Deploy Pane" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAANUAAAAlCAYAAADV0qyaAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAAB3RJTUUH5wgSBB4rcgE7DAAADBpJREFUeJztnHtYVGUexz9nLoBMsoIZ1Iq6E5Zja2hBIrum1YpmUxu1aje8NLUiFWqBpaWOT2k9iq3Srk4X0lUrxW3bbCIXutDuqmhjSaWYmbdh81bMegGEuZz9YxyYwzkgN0njfJ5nHs+c93Jenffr93femxATEyOioqLSbmh+6gaoqPzcUEWlotLO6H7qBqicm67hMChOww0mDcYrNER1hZgoDT26CQAc/5/IkQofFafgv8dFtpV5KSnzcarqJ254J0VQ36kuTC79Bdx9o47bkrT079O6gGLXAR9F27289ZGHH060cwNVGkUV1QXGAKOGCSO13DpYR6i+fer0eEU2bvOxcqObHXvVn/t8o4rqAiFEJzJ9jJ5Jt+rQaYXz9pzVhR4WrnVTXXPeHtHpUUV1ATAwTmDh5FCMVzQupl0HfGzZ6aFkp5uKU3Ckwscxlw+AyyI1xET537WSrtEz5BpdkyFj+XGRGbYatu1Wf/rzgSqqnxBRFBl1g5alj4UoupPzmI9V/6xlfbGbipM+xfIAgiAvG2EQSB2q56HbQukdIxeYxysy9aVaNm7zKpZXaT2qqBpgGm1hWKzSy0wFX67JZ3Nl+zynKUE5j/mYv/oMhZ95cHvkYmoJgiAwMlHHM+O7yMTl8Yq88KabFR94Wi6sfmYsw3rSpte+E7tZt7YYV1vquABRRSXBQq49FWMjqa4tC0ibv7nNTxFFkZsHaVn+uFRQHq/IXze6WbT2DJXVcjE1t+MHHCyYsBCBaWNCmXxHqEzEs16tZd0nLRBWPwu5z6dibIeBFNd2G5lz7T8rYanzVApUbs1h3LPFQXf8YovWhLS5blEUiYkSWJwhF9SjS6p5f0utrExwZz9XxxdFsS5PsLjO1Iq88MYZPv7cy+qnwwkPq6/nmTQ9m772Un5cbJawho9JwajfxzvmTPIayzN7HVmDjzYjTwp3YW80z8WIuqKiAwl08gUPhxBhqO+8NW5kghIEQfbRaDR1190GpDD23glMmHgf95qH0itSnif4E2BbmZu0+VVUnakXXHiYwJJH/Q6m5HIqLUN1qg4i0FlvS9IwLF4rSXtulbKgAteSP8MTsczJ4KZYqWvePm4C39iXsnj9TqoEoc6xgkUSuN5W5mZ2XjWLHwmvSxvUV8NdQzXkF3slbqfSclSn6kBEUWTczdIXkZJdXlZ+4J80UnIYqfsM5Ykl2YyKC+MHRz4vTk0jLe0xZq/8hCO+KAaMeZq5E66WlFFyLoD8T2opKHFL2nLvLTrVqdoB1akUCIlJJn1yv6A7sUS2ob5AR+3ZQ+A3v5a61DOv+RfoBTtS/cfAL4enMCr+Wq4M/4H9ofEMjdZywG5let7us3lOcPDjFcwocTL7zxlcd/uD3P/2TN48x7o/URSxrqgmJbF+svnaK7VcFavh23JRdas2oIpKQim7ys0Yeydj7t0wzUXpl9+1umZRFDEPkbrU53u8fHPIKxGURuMPHoSrzMx67H4Seoah0WjQaDQMEASEw0W88vo3sg4vVH3Ic+uH8daUeG4YK/DmSqkoAqFgsBMd/tFH8Q4Pv7u+vl1336jj+TdqVUG1AVVUEhzY0lOx9Utn+fNmYj1u3F30nN6aS/qzhbRmiiq4E5t6S6PtvxXXyAQlCAIYbubppx4ksbvI95tWs2LFu2yviMQ4KJG4sE3sbuxhHxzgWMZArrx7A+/dWcmhz97m5SXr+bJSkDlP4Pv6T2olouoVLc+j0jLUdyoZJiyPjCRW78Lxyizs37qJHJxG9ghDq2sMOETvaGkH3XnACyB73xmWOYkbLhU5VDCHRxe/y/YKABf7viikcEu9tE0PWMldmElKXdMKeX/9+xT8+yvKT4TSK2k885fPZYRBObwEOHhUOh8W20Mjc7SLCxPmjCyyMsyYFFINQ8aSlZ3F2CFKv6cJc4YV61Tlss1FdaoGmB6egvlXelxbV7OoqIzKPXbil6SSMD6blM1WCtuwoqJPgxUNB4/KO7kg3MiwayLQ/m8ra15r1JMwPbAI6z0mDEDmsksgYwGFlU4KV9nO5jCQnLmUrBGJWJ408+Hc9wH50qby41Lx9OwhFf7F5laxGZmkj44FhmPq4sSyuDQodSzWGeMx6YHkaEjNJj8oNf6JLNJvigYSiA1xYllUSmtQnSqYfhamjDaidzlY/eLZcO9gHos27MMdmUDa4ym01q+a+p9fKqw4Lu2mperg5zgayR8sKAC6J5O5bFaQYwFUsjnXhqNC4BLTEO5UfFbL26pyblRR1WHC8ogZo96FY9UiiSM5Vyw6GwZaWhQGNuycB45IQ60+MfLOLQinqXVDiKGbYp3RY+f7BeVyYP+iEnBS/N4+3N2TyVyWRbIkt4OjJ4EuXemOfDWGIAjEXibtAgHnuliF5VyWi62gmOICGzmLGzpNPtaFqyj+tJhVC60SlwIoXZyDrcCBo8hGTitdClRR1RE76WzYtyUPa1HDGM9J3hI7+9wGEiZlN3CEpgl+P2koqn69lKLvEr47JhAS91ssshFIOJq/hsKtm7FNs7K7FsCN6+WZWN9zsHldHtKViQlER4BwyoUz6G6wuPrESIf4ncfr23hxCqsM+7IccpbZKVNIrdyST86iHPK3KMXxZdiXWbEuVS7bXFRRAfS2kH2HEb1rM3nzi5XzBMLAiAQsM1oXBu5xeiXf7xzqH3WThmPlrPm7A5feiHnOLMzdG9ZSRt6zC7D/GHyvktKXrSwoCF6WaiB+8ngSu0Pldw4KG9QSeN7tyVJhHzjsRaVtdNqBCtMDVqZcHwWAPiqWWD04t7xDcRNlnPmFlI5IJ+F6C7l/Mvvfudx7sc/LbdYAxrub3GTdE1b3Pam/lt4xGpzHpPkqi+axoE8uC36fTPrr60gtP0qlZJ3tIQqn53A66E78JCuWa6PqvusjoomNNoDLwfIX7Irt6dFNICVR2gXe2+xWzKvSfDqpqCxMuSdBtsUjdvQULMsaX1WdPG0cCREABqL7BkobSZvmoLAZW0IOHvFRsstLUv/6kGvOhFAeWngGkIZlZa9m8uCedGaNv4m4nkaipVEa0SARVWRPE8a+Qf7prcS5dRW2F/MpVRC8KIo8eV+YZKX8zv1evtrnu6hG+y5EOqmo/ARv8fBvQ2g6f4gmBAje8tC8LSGB1QyCILD2o1qS+nepS7vlOh1/GKbj7X/Jwy7XpzayP7XJ7gcYHnRd/Oy4Jl02GFEUuXWw/7nBrP1Yuu1EFVfr6NSiOt8o7WvasMnN/SP0JPar/6efNymUg0dr2L7Hd17nhQLtSLhaS86UUEnazv1e3iiqD/2aaoPr5GkgEuPkdNIbyRMVE9K8PO4aTjX/r3BRoIqqgwi4lccrMjW3ig9f7Fq3UTA8TGDlU6FMfMEvrPPJ9VdpWPlUqGSTYo0bpr5UhccrnnMOC6B0aSa5l9jIvN1MfJM5I4lvKo97H+/MzJYNbV/sdGpRGQZnYbdnNTt/ra8WMJJqt5MadN/lk+/WVSLQWZ3HfMx8pZqlmfX7mcLDBFY/HYZtg5uXN7ipcZ87/GpuyCeKIjqtwMRROh4fGyI7T3Deiir2OH2SNjZss5RKCuenyUYUVfx02jMqlA54cTs/Ja+giRkKQzJjH7iWKMnNpg+ECYRcgfkqn89Xd/2QOZS5E7vIyuz7XsS6spZNX7f9pCNRFBls0vBMWojisWXzVlbzmr1Gcf8WqO9VraHTiqojCYhI6TM6Sc9fpocrHlG264CPNUUe/vEfD7WelnXuEJ1/MGLiKB0DjMrTkUqCamwbvkrzUUXVATTlVgDDB+pYOCWcy7srd/4aN+zY6x+OL93r44gLqs6IHKnwp8dE+cPHmEiIj9OQ1F/LwDhNo8dGV5z08aStmo3b/AMTSmdgBO6rtBxVVB1EY04VSIswCFgnhTNmeDsdoN4IBSVuZr5SXXc4p+pS7Y8qqg6ioVspiQtgyDU6/nhHKMMHtu+Z6sU7POTZz1C8w1N3rykxqaJqPaqoOpCmhBWcDtArWsv4kSGMTtLLVpI3F+cxH4WfeVhTVMPe8vrJZeXzMFRBtReqqDqYlggrQK9oLYP6ahncX0ffnloiwgW6hsPl3f2d//CPIqeq4GSVyP7DXhy7PZTs8nLoqHyVhiqo88//AfU4B6Dp6Uk/AAAAAElFTkSuQmCC" width="213" height="37" class="img_ev3q"></p>
<p>If you have any feedback regarding this extension, make sure to add your feedback to the <a href="https://github.com/Azure/bicep/issues" target="_blank" rel="noopener noreferrer">azure/bicep issues</a></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/azure/">Azure</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/page/4/"><div class="pagination-nav__label">Newer Entries</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/page/6/"><div class="pagination-nav__label">Older Entries</div></a></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 luke.geek.nz. Powered by coffee, clouds and hamsters on wheels!</div></div></div></footer></div>
</body>
</html>