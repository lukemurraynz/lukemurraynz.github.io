<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Lukes Tech Blog - Unleashing the power of the cloud and other technologies! | luke.geek.nz</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://luke.geek.nz/img/social-card.png"><meta data-rh="true" name="twitter:image" content="https://luke.geek.nz/img/social-card.png"><meta data-rh="true" property="og:url" content="https://luke.geek.nz/page/25/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" property="og:title" content="Lukes Tech Blog - Unleashing the power of the cloud and other technologies! | luke.geek.nz"><meta data-rh="true" name="description" content="Embark on a tech journey with Luke, a Microsoft Azure MVP, as he delves into the cutting-edge realm of Microsoft and Azure Cloud technologies. Explore, learn, and stay ahead in the dynamic world of cloud computing!"><meta data-rh="true" property="og:description" content="Embark on a tech journey with Luke, a Microsoft Azure MVP, as he delves into the cutting-edge realm of Microsoft and Azure Cloud technologies. Explore, learn, and stay ahead in the dynamic world of cloud computing!"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://luke.geek.nz/page/25/"><link data-rh="true" rel="alternate" href="https://luke.geek.nz/page/25/" hreflang="en"><link data-rh="true" rel="alternate" href="https://luke.geek.nz/page/25/" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://ZBH2T1WJQD-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"Blog","@id":"https://luke.geek.nz/page/25","mainEntityOfPage":"https://luke.geek.nz/page/25","headline":"Lukes Tech Blog - Unleashing the power of the cloud and other technologies!","description":"Embark on a tech journey with Luke, a Microsoft Azure MVP, as he delves into the cutting-edge realm of Microsoft and Azure Cloud technologies. Explore, learn, and stay ahead in the dynamic world of cloud computing!","blogPost":[{"@type":"BlogPosting","@id":"https://luke.geek.nz/azure/ims-payroll-not-opening-as-a-published-application-in-azure-virtual-desktop","mainEntityOfPage":"https://luke.geek.nz/azure/ims-payroll-not-opening-as-a-published-application-in-azure-virtual-desktop","url":"https://luke.geek.nz/azure/ims-payroll-not-opening-as-a-published-application-in-azure-virtual-desktop","headline":"IMS Payroll not opening as a published application in Azure Virtual Desktop","name":"IMS Payroll not opening as a published application in Azure Virtual Desktop","description":"Azure Virtual Desktop allows you to access an entire desktop or a published application with shortcuts and an appearance like it was running locally; depending on the requirements; I prefer published applications where possible to keep the user experience on the endpoint device and keep the cost down.","datePublished":"2022-08-23T00:00:00.000Z","author":{"@type":"Person","name":"Luke Murray","description":"Author","url":"https://luke.geek.nz","image":"https://luke.geek.nz/img/logo.png"},"keywords":[]},{"@type":"BlogPosting","@id":"https://luke.geek.nz/2022/08/18/microsoft-azure-cost-optimization-tasks","mainEntityOfPage":"https://luke.geek.nz/2022/08/18/microsoft-azure-cost-optimization-tasks","url":"https://luke.geek.nz/2022/08/18/microsoft-azure-cost-optimization-tasks","headline":"Microsoft Azure - Operational Cost Optimization Tasks","name":"Microsoft Azure - Operational Cost Optimization Tasks","description":"The Microsoft Azure platform is not a set-and-forget ecosystem like doing service on your car!","datePublished":"2022-08-18T00:00:00.000Z","author":{"@type":"Person","name":"Luke Murray","description":"Author","url":"https://luke.geek.nz","image":"https://luke.geek.nz/img/logo.png"},"keywords":[]},{"@type":"BlogPosting","@id":"https://luke.geek.nz/2022/08/17/connect-to-azure-sql-database-in-a-jupyter-notebook-using-python","mainEntityOfPage":"https://luke.geek.nz/2022/08/17/connect-to-azure-sql-database-in-a-jupyter-notebook-using-python","url":"https://luke.geek.nz/2022/08/17/connect-to-azure-sql-database-in-a-jupyter-notebook-using-python","headline":"Connect to Azure SQL Database in a Jupyter Notebook using Python","name":"Connect to Azure SQL Database in a Jupyter Notebook using Python","description":"Jupyter Notebooks, commonly used by Data Scientists and Students, allow you to run code, such as Python and PowerShell, inside a Notebook format and display the output inside the notebook; this is useful for teaching a subject or displaying up-to-date information.","datePublished":"2022-08-17T00:00:00.000Z","author":{"@type":"Person","name":"Luke Murray","description":"Author","url":"https://luke.geek.nz","image":"https://luke.geek.nz/img/logo.png"},"keywords":[]},{"@type":"BlogPosting","@id":"https://luke.geek.nz/2022/08/09/create-a-public-holidays-api-using-microsoft-azure","mainEntityOfPage":"https://luke.geek.nz/2022/08/09/create-a-public-holidays-api-using-microsoft-azure","url":"https://luke.geek.nz/2022/08/09/create-a-public-holidays-api-using-microsoft-azure","headline":"Create a Public Holidays API using Microsoft Azure","name":"Create a Public Holidays API using Microsoft Azure","description":"Using a previous blog post I did on using a third-party API (Application Programming Interface) to start a Virtual Machine when it wasn't a Public Holiday, I had a thought on what could be an option if I wanted an API only accessible on an internal network or if I wanted to include custom Holidays such as Star Wars day or company holidays? Could I create and query my API using Microsoft Azure services? You can!","datePublished":"2022-08-09T00:00:00.000Z","author":{"@type":"Person","name":"Luke Murray","description":"Author","url":"https://luke.geek.nz","image":"https://luke.geek.nz/img/logo.png"},"keywords":[]},{"@type":"BlogPosting","@id":"https://luke.geek.nz/azure/microsoft-azure-zonalallocationfailed","mainEntityOfPage":"https://luke.geek.nz/azure/microsoft-azure-zonalallocationfailed","url":"https://luke.geek.nz/azure/microsoft-azure-zonalallocationfailed","headline":"Microsoft Azure - ZonalAllocationFailed","name":"Microsoft Azure - ZonalAllocationFailed","description":"Error code: AllocationFailed or ZonalAllocationFailed","datePublished":"2022-07-27T00:00:00.000Z","author":{"@type":"Person","name":"Luke Murray","description":"Author","url":"https://luke.geek.nz","image":"https://luke.geek.nz/img/logo.png"},"keywords":[]}]}</script><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="luke.geek.nz RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="luke.geek.nz Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="luke.geek.nz JSON Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0QDLBY7NNN"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-0QDLBY7NNN",{anonymize_ip:!0})</script><link rel="stylesheet" href="/assets/css/styles.dd27eb3d.css">
<script src="/assets/js/runtime~main.975d7231.js" defer="defer"></script>
<script src="/assets/js/main.625df2af.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="dark";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="theme-announcement-bar announcementBar_mb4j" style="background-color:#D3D3D3" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY">If you haven't already, sign up for my Weekly Azure updates Newsletter, straight to your inbox! <a target="_blank" rel="noopener noreferrer" href="https://newsletter.azurefeeds.com/join">Subscribe now!</a></div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="luke.geek.nz" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.png" alt="luke.geek.nz" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">luke.geek.nz</b></a><a class="navbar__item navbar__link" href="/Tags/">Tags</a><a class="navbar__item navbar__link" href="/Archive/">Blog</a><a class="navbar__item navbar__link" href="/about/">About</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://www.youtube.com/channel/UCUG3TKDTAZz4UXshGrjBBoQ" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-icon" aria-label="YouTube">
              <svg width="24" height="24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path d="M23.498,6.186c-0.273-1.186-1.143-2.144-2.332-2.417C18.389,3.153,12,3.153,12,3.153s-6.389,0-9.166,0.616
                  c-1.19,0.273-2.06,1.23-2.332,2.417C0,8.07,0,12,0,12s0,3.93,0.502,5.814c0.272,1.187,1.142,2.062,2.332,2.335
                  C5.611,20.847,12,20.847,12,20.847s6.389,0,9.166-0.698c1.189-0.273,2.059-1.148,2.332-2.335C24,15.93,24,12,24,12
                  S24,8.07,23.498,6.186z M9.545,15.568V8.432l6.545,3.568L9.545,15.568z"/>
              </svg>
            </a><a href="https://aus.social/@lukemurray" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-icon" aria-label="Mastodon">
              <svg height="20" width="20" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" xml:space="preserve">
                <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                <g id="SVGRepo_iconCarrier">
                  <path d="M21.327 8.566c0-4.339-2.843-5.61-2.843-5.61-1.433-.658-3.894-.935-6.451-.956h-.063c-2.557.021-5.016.298-6.45.956 0 0-2.843 1.272-2.843 5.61 0 .993-.019 2.181.012 3.441.103 4.243.778 8.425 4.701 9.463 1.809.479 3.362.579 4.612.510 2.268-.126 3.541-.809 3.541-.809l-.075-1.646s-1.621.511-3.441.449c-1.804-.062-3.707-.194-3.999-2.409a4.523 4.523 0 0 1-.04-.621s1.77.433 4.014.536c1.372.063 2.658-.08 3.965-.236 2.506-.299 4.688-1.843 4.962-3.254.434-2.223.398-5.424.398-5.424zm-3.353 5.59h-2.081V9.057c0-1.075-.452-1.62-1.357-1.62-1 0-1.501.647-1.501 1.927v2.791h-2.069V9.364c0-1.28-.501-1.927-1.502-1.927-.905 0-1.357.546-1.357 1.62v5.099H6.026V8.903c0-1.074.273-1.927.823-2.558.566-.631 1.307-.955 2.228-.955 1.065 0 1.872.409 2.405 1.228l.518.869.519-.869c.533-.819 1.34-1.228 2.405-1.228.92 0 1.662.324 2.228.955.549.631.822 1.484.822 2.558v5.253z"></path>
                </g>
              </svg>
            </a><a href="https://bsky.app/profile/lukemurraynz.bsky.social" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-icon" aria-label="Bluesky">
              <svg class="octicon" xmlns="http://www.w3.org/2000/svg" role="img" viewBox="0 0 16 16" height="20" width="20" fill="currentColor">
                <title>Bluesky</title>
                <path d="M8 7.2c-.72-1.4-2.7-4.04-4.53-5.33C1.7.63 1.04.84.6 1.04.1 1.27 0 2.05 0 2.51c0 .46.25 3.77.42 4.32.54 1.82 2.47 2.45 4.25 2.25-2.6.38-4.92 1.33-1.88 4.71 3.33 3.46 4.57-.74 5.21-2.87.64 2.13 1.37 6.18 5.16 2.87 2.84-2.87.78-4.33-1.83-4.71 1.78.2 3.71-.43 4.25-2.25.17-.55.42-3.86.42-4.32 0-.46-.09-1.24-.6-1.47-.44-.2-1.11-.42-2.87.83A17.87 17.87 0 0 0 8 7.2Z"></path>
              </svg>
            </a><a href="https://twitter.com/lukemurraynz" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-icon" aria-label="X"><svg height="20" width="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 8.586l4.293-4.293a1 1 0 011.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 011.414-1.414L10 8.586z" clip-rule="evenodd"/>
          </svg></a><a href="https://www.linkedin.com/in/ljmurray/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-icon" aria-label="LinkedIn"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" height="20" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854V1.146zm4.943 12.248V6.169H2.542v7.225h2.401zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248-.822 0-1.359.54-1.359 1.248 0 .694.521 1.248 1.327 1.248h.016zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274 0-1.845.7-2.165 1.193v.025h-.016a5.54 5.54 0 0 1 .016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225h2.4z"></path></svg></a><a href="https://luke.geek.nz/rss" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-rss-link" aria-label="RSS"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><div role="group"><h3 class="yearGroupHeading_rMGB">2025</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure/microsoft-learn-contributor-chatmode/">Microsoft Learn Contributor Chatmode</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure/service-groups-terraform-azapi/">Deploying Azure Service Groups with Terraform AzAPI</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure/mcp-vscode-microsoft-learn/">Model Context Protocol (MCP) in VS Code with Microsoft Learn</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure/drasi-bastion-rbac-automation/">Automate Azure Bastion with Drasi Realtime RBAC Monitoring</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure/zone-redundancy-cli/">Validate Azure Zone Redundancy with az zones CLI</a></li></ul></div></nav></aside><main class="col col--7"><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/azure/ims-payroll-not-opening-as-a-published-application-in-azure-virtual-desktop/">IMS Payroll not opening as a published application in Azure Virtual Desktop</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-08-23T00:00:00.000Z">August 23, 2022</time> · <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://luke.geek.nz/img/logo.png" alt="Luke Murray"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">Luke Murray</span></a></div><small class="authorTitle_nd0D" title="Author">Author</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><p><a href="https://azure.microsoft.com/en-us/services/virtual-desktop/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title=" Azure Virtual Desktop">Azure Virtual Desktop</a> allows you to access an entire desktop or a published application with shortcuts and an appearance like it was running locally; depending on the requirements; I prefer published applications where possible to keep the user experience on the endpoint device and keep the cost down.</p>
<p>One of the applications I published for a customer is <a href="https://www.myob.com/nz/enterprise/ims-payroll" target="_blank" rel="noopener noreferrer" title=" MYOB IMS Payroll ">MYOB IMS Payroll</a>.</p>
<p>IMS Payroll worked well as a published application for months until one day; it didn&#x27;t seem to open for the user, whether as a published application or in the Full Desktop.</p>
<p>The symptoms were that once the user clicked on the icon, it would appear to open <em>(visible on the Taskbar)</em>, but there was no window, and when you hovered over the preview thumbnail, it was blank. The cursor also appeared to be active with a circle, indicating it was trying to open.</p>
<p>Even if you don&#x27;t have IMS Payroll, you may experience applications with a similar experience, and hopefully, this article will help point you in the right direction.</p>
<p><img decoding="async" loading="lazy" alt="Azure Virtual Desktop - Published Application" src="/assets/images/imspayroll_avdpublishedapp-63496f9c0d1e4f993fd23f1c36a76ad4.png" width="489" height="264" class="img_ev3q"></p>
<p>One noticeable difference we found in our testing - was that it opened for us and other users using different accounts.</p>
<p>After some discovery, we discovered that the user had gone to another branch office site and used a different monitor setup, and IMS Payroll was out of drawing range. Usually, windows would be able to snap this back into view; however, after comparing the registry keys for our user vs the user who had the issue, we discovered that IMS Payroll sets the location in the user registry.</p>
<ul>
<li>Registry Key location: <strong>\HKEY_CURRENT_USER\IMS Payroll Partner\Layout</strong></li>
</ul>
<p>In our case, the settings were as follows:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Windows Registry Editor Version 5.00</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[HKEY_CURRENT_USER\IMS Payroll Partner\Layout]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&quot;Left&quot;=&quot;684&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&quot;Top&quot;=&quot;310&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&quot;Height&quot;=&quot;713&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&quot;Width&quot;=&quot;1127&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&quot;StatusBar&quot;=&quot;1&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&quot;ActiveHelp&quot;=&quot;0&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&quot;EmployeePage&quot;=&quot;0&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&quot;PayrollPage&quot;=&quot;5&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&quot;CompanyPage&quot;=&quot;1&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&quot;SkipWelcome&quot;=&quot;1&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&quot;SkinName&quot;=&quot;lfUltraFlat&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&quot;LastPage&quot;=&quot;6&quot;</span><br></span></code></pre></div></div>
<p>For the users who couldn&#x27;t see IMS Payroll, their settings looked more like this:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Windows Registry Editor Version 5.00</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[HKEY_CURRENT_USER\IMS Payroll Partner\Layout]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&quot;Left&quot;=&quot;-1444&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&quot;Top&quot;=&quot;310&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&quot;Height&quot;=&quot;713&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&quot;Width&quot;=&quot;1127&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&quot;StatusBar&quot;=&quot;1&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&quot;ActiveHelp&quot;=&quot;0&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&quot;EmployeePage&quot;=&quot;0&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&quot;PayrollPage&quot;=&quot;5&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&quot;CompanyPage&quot;=&quot;1&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&quot;SkipWelcome&quot;=&quot;1&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&quot;SkinName&quot;=&quot;lfUltraFlat&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&quot;LastPage&quot;=&quot;6&quot;</span><br></span></code></pre></div></div>
<p>The difference was that the Left entry had moved the Window too far, left out of view, so it could not be seen by the user when opening as a published app or on a Desktop.</p>
<p>After the <strong>Left entry was changed from -1444 to 684</strong>. IMS became visible again as a published application and on the Full Desktop.</p>
<p>Due to the hard-coded user registry entries, this specific issue would have occurred regardless of Azure Virtual Desktop, running in a Terminal Services environment, or even locally, when working with different monitor setups.</p>
<p><em>Note: Some applications may have configuration files stored in the user&#x27;s AppData folders instead of the registry; if in doubt, raise a support ticket with the application vendor.</em></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/tags/azure/">Azure</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/2022/08/18/microsoft-azure-cost-optimization-tasks/">Microsoft Azure - Operational Cost Optimization Tasks</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-08-18T00:00:00.000Z">August 18, 2022</time>  · <!-- -->16 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://luke.geek.nz/img/logo.png" alt="Luke Murray"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">Luke Murray</span></a></div><small class="authorTitle_nd0D" title="Author">Author</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><p>The <a href="https://azure.microsoft.com/en-us/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Microsoft Azure">Microsoft Azure</a> platform is not a set-and-forget ecosystem like doing service on your car!</p>
<p>There are no one-size-fits when it comes to cost optimization, but some general tasks can be done or considered on a Monthly/Quarterly/Annual basis to keep on top of the resources you are running in Azure and to keep them lean.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">​</a></h4>
<p>Although Microsoft takes a lot of traditional infrastructure management and security concerns off your hand, you are still responsible for the spending and ensuring the value of the technologies and services you consume match your business goals and agility.</p>
<p>Today we are going to go back to basics and look at the <a href="https://learn.microsoft.com/en-us/azure/architecture/framework/?WT.mc_id=AZ-MVP-5004796#cost-optimization" target="_blank" rel="noopener noreferrer" title="Cost optimization">Cost Optimization</a> pillar of the Microsoft <a href="https://learn.microsoft.com/en-us/azure/architecture/framework/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Microsoft Azure Well-Architected Framework">Well-Architected Framework</a>.</p>
<blockquote>
<p>“The cost optimization pillar provides principles for balancing business goals with budget justification to create a cost-effective workload while avoiding capital-intensive solutions. Cost optimization is about looking at ways to reduce unnecessary expenses and improve operational efficiencies.”</p>
<p>“Use the pay-as-you-go strategy for your architecture, and invest in scaling out, rather than delivering a large investment-first version. Consider opportunity costs in your architecture and the balance between first-mover advantage versus fast follow.”</p>
</blockquote>
<p>The right governance and oversight can help prevent Cloud sprawl and wasted consumption costs.</p>
<p>To help get you started, I have put together a list of some optimization opportunities, that should be run regularly, items such as reviewing unassociated public IPs should be done Monthly <em>(along with Azure Advisor checks)</em>, and <a href="https://learn.microsoft.com/en-us/azure/cost-management-billing/reservations/save-compute-costs-reservations?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="What are Azure Reservations?">Azure Reservation reviews</a> at least quarterly.</p>
<blockquote>
<p><strong><em>This is not an exhaustive list</em></strong>, and the use of <a href="https://learn.microsoft.com/en-us/azure/governance/policy/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="What is Azure Policy?">Azure Policy</a> and <a href="https://learn.microsoft.com/en-us/azure/advisor/advisor-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Introduction to Azure Advisor">Azure Advisor</a> help supplement these tasks.</p>
<p>If you have other tasks that you run, feel free to share them with the community in the page comments below.</p>
</blockquote>
<p>The <a href="https://learn.microsoft.com/en-us/graph/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Overview of Microsoft Graph">Microsoft Graph</a> and <a href="https://luke.geek.nz/azure-resource-graph-explorer-and-the-powershell-azure-resource-graph" target="_blank" rel="noopener noreferrer" title="Azure Resource Graph Explorer and the PowerShell Azure Resource Graph ">KQL queries</a> can also be used in conjunction with PowerShell to pull recommendations straight out of Advisor, which can then be fed into reports, and the use of community tools such as the <a href="https://luke.geek.nz/azure/azure-optimization-engine" target="_blank" rel="noopener noreferrer" title="Azure Optimization Engine ">Azure Optimization Engine</a> cannot be undervalued.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="design">Design<a href="#design" class="hash-link" aria-label="Direct link to Design" title="Direct link to Design">​</a></h4>
<p><img decoding="async" loading="lazy" alt="Azure - Monitor &amp;amp; optimize" src="/assets/images/cost_pillar_overview-2a68c172e37114f4927ee69bdcb495db.png" title="Azure - Monitor &amp;amp; optimize" width="886" height="538" class="img_ev3q"></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="keep-within-the-cost-constraints">Keep within the cost constraints<a href="#keep-within-the-cost-constraints" class="hash-link" aria-label="Direct link to Keep within the cost constraints" title="Direct link to Keep within the cost constraints">​</a></h5>
<p>Every design choice has cost implications. Before choosing an architectural pattern, Azure service, or a price model for the service, consider the budget constraints set by the company. As part of the design, identify acceptable boundaries on scale, redundancy, and performance against cost. After estimating the initial cost, set budgets and alerts at different scopes to measure the cost.</p>
<p>One of the cost drivers can be unrestricted resources. These resources typically need to scale and consume more cost to meet demand.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="aim-for-scalable-costs">Aim for scalable costs<a href="#aim-for-scalable-costs" class="hash-link" aria-label="Direct link to Aim for scalable costs" title="Direct link to Aim for scalable costs">​</a></h5>
<p>A key benefit of the cloud is the ability to scale dynamically. The workload cost should scale linearly with demand.</p>
<p>You can save costs through automatic scaling. First, consider the usage metrics and performance to determine the number of instances. Then, choose smaller instances for a highly variable workload and scale out to get the required level of performance rather than up. This choice will enable you to make your cost calculations and estimates granular.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="pay-for-the-consumption">Pay for the consumption<a href="#pay-for-the-consumption" class="hash-link" aria-label="Direct link to Pay for the consumption" title="Direct link to Pay for the consumption">​</a></h5>
<p>Adopt a leasing model instead of owning infrastructure. Azure offers many SaaS and PaaS resources that simplify the overall architecture. The cost of hardware, software, development, operations, security, and data centre space is included in the pricing model. Also, choose pay-as-you-go over fixed pricing. That way, you&#x27;re charged for only what you use as a consumer.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="right-resources-the-right-size">Right resources, the right size<a href="#right-resources-the-right-size" class="hash-link" aria-label="Direct link to Right resources, the right size" title="Direct link to Right resources, the right size">​</a></h5>
<p>Choose the right resources aligned with business goals and can handle the workload&#x27;s performance.</p>
<p>An inappropriate or misconfigured service can impact the cost.</p>
<p>For example, building a multi-region service when the service levels don&#x27;t require high availability or geo-redundancy will increase cost without any reasonable business justification. Specific infrastructure resources are delivered as fix-sized building blocks. Ensure that these blocks are adequately sized to meet capacity demand and deliver expected outcomes.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="monitor-and-optimize">Monitor and optimize<a href="#monitor-and-optimize" class="hash-link" aria-label="Direct link to Monitor and optimize" title="Direct link to Monitor and optimize">​</a></h5>
<p>Treat cost monitoring and optimization as a process rather than a point-in-time activity. Conduct regular cost reviews and measure and forecast the capacity needs so that you can provision resources dynamically and scale with demand. Review the cost management recommendations and take action.</p>
<p>Today, we will focus on <strong>Monitor and optimize</strong>.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="review-underutilized-resources">Review Underutilized Resources<a href="#review-underutilized-resources" class="hash-link" aria-label="Direct link to Review Underutilized Resources" title="Direct link to Review Underutilized Resources">​</a></h4>
<p>Optimize and improve efficiency by identifying idle and underutilized resources across the Azure ecosystem.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="review-azure-app-service-plans">Review Azure App Service Plans<a href="#review-azure-app-service-plans" class="hash-link" aria-label="Direct link to Review Azure App Service Plans" title="Direct link to Review Azure App Service Plans">​</a></h5>
<p>Review <a href="https://portal.azure.com/#blade/HubsExtension/BrowseResource/resourceType/Microsoft.Web%2FserverFarms" target="_blank" rel="noopener noreferrer" title="Azure Portal - App Service plan">Azure App Service Plans</a> to determine if:</p>
<ol>
<li>The Azure App Service Plan is ‘Standard’ or ‘Premium’ pricing and has an associated application.</li>
<li>If the Azure App Service is getting utilized <em>(by looking at the Metrics/CPU)</em> and doesn’t need to be downscaled to a smaller plan.</li>
</ol>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="review-shutdown-workloads">Review shutdown workloads<a href="#review-shutdown-workloads" class="hash-link" aria-label="Direct link to Review shutdown workloads" title="Direct link to Review shutdown workloads">​</a></h5>
<p>Because you pay for Azure Resources as ‘Pay As You Go’, a quick win can be to review <a href="https://portal.azure.com/#blade/HubsExtension/BrowseResourceBlade/resourceType/Microsoft.Compute%2FVirtualMachines" target="_blank" rel="noopener noreferrer" title="Azure Portal - Virtual Machines">Virtual Machines</a> to determine if the workload needs to be 24/7!</p>
<p>For example, you have automation configured to automatically start up and shut down workloads based on the following schedule: 7 AM Start – 7 PM Stop <em>(&amp; off Weekends)</em>.</p>
<p>You can add servers to this automated schedule by adding the following Tag to the Virtual Machine or trigger automation when a workload is ‘Shutdown’ and not deallocated; see my article on &quot;<a href="https://luke.geek.nz/azure/turn-on-a-azure-virtual-machine-using-azure-automation/" target="_blank" rel="noopener noreferrer" title="Turn on a Azure Virtual Machine using Azure Automation ">Turn on an Azure Virtual Machine using Azure Automation</a>&quot; for a potential place to start.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="review-azure-advisor">Review Azure Advisor<a href="#review-azure-advisor" class="hash-link" aria-label="Direct link to Review Azure Advisor" title="Direct link to Review Azure Advisor">​</a></h5>
<p>The Azure Advisor is an inbuilt tool critical to optimizing the Azure Environment. The <a href="https://portal.azure.com/#blade/Microsoft_Azure_Expert/AdvisorMenuBlade/Cost" target="_blank" rel="noopener noreferrer" title="Azure Portal - Azure Advisor">Azure Advisor</a> needs to be reviewed for Cost recommendations.</p>
<ol>
<li>The Azure Advisor will recommend Reserved Instances.</li>
<li>The Azure Advisor will recommend if a Virtual Machine runs on a VM size GREATER than what it needs <em>(based on CPU utilization under 5% in the last 14 days)</em>. If the Azure Advisor reports an overprovisioned machine, you need to investigate its use and resize it to a more suitable size.</li>
</ol>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="review-azure-sql-databases">Review Azure SQL Databases<a href="#review-azure-sql-databases" class="hash-link" aria-label="Direct link to Review Azure SQL Databases" title="Direct link to Review Azure SQL Databases">​</a></h5>
<p>Review <a href="https://portal.azure.com/#blade/HubsExtension/BrowseResourceBlade/resourceType/Microsoft.Sql%2Fservers%2Fdatabases" target="_blank" rel="noopener noreferrer" title="Azure Portal - Azure SQL databases">Azure SQL Databases</a> to determine if:</p>
<ol>
<li>The SQL Database Pricing Tier is ‘Standard’ and uses the DTUs (usually found by looking at the Compute utilization on the databases); if not, downsize the DTU limit.</li>
<li>Check Geo-Replication to ensure that the SQL Database is not replicating across Regions if it doesn’t need to be.</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="review-azure-reserved-instances">Review Azure Reserved Instances<a href="#review-azure-reserved-instances" class="hash-link" aria-label="Direct link to Review Azure Reserved Instances" title="Direct link to Review Azure Reserved Instances">​</a></h4>
<p>Azure reserved instances significantly reduce costs—up to 72 per cent compared to pay-as-you-go prices—with one-year or three-year terms on Windows and Linux virtual machines (VMs). What&#x27;s more, you can now improve budgeting and forecasting with a single upfront payment (i.e. Pay for a VM Upfront for 1/3 Year or 5 Years), making it easy to calculate your investments. Or lower your upfront cash outflow with monthly payment options at no additional cost.</p>
<p><img decoding="async" loading="lazy" alt="Azure Reserved Instance" src="/assets/images/azure-ri-ff13bd54c31dbee751f74fbe6d8a92f3.png" title="Azure Reserved Instance" width="553" height="501" class="img_ev3q"></p>
<p>The Azure Advisor is an inbuilt tool critical to optimizing the Azure Environment. The Azure Advisor needs to be reviewed for Reserved Instance recommendations.</p>
<ol>
<li>When reviewing Reserved Instances, you need to take into consideration:</li>
<li>What workloads are they used for?</li>
<li>Is there a project that may replace or resize the workloads next year?</li>
<li>Who is paying for the workloads?</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="review-unused-files-and-vhds">Review unused files and VHDs<a href="#review-unused-files-and-vhds" class="hash-link" aria-label="Direct link to Review unused files and VHDs" title="Direct link to Review unused files and VHDs">​</a></h4>
<p>Save Azure costs by cleaning up unused VHDs in your Azure storage. Azure stores Azure Virtual Machine OS and data disks in Azure storage accounts.</p>
<p>When a VM is deleted from the Azure portal, the underlying OS and data disks may not get deleted. Such disks continue to consume Azure storage and account for the cost of storing them. These disks are called Orphaned Disks.</p>
<p>As mentioned above, some Virtual Machines with unmanaged disks will keep the VHDs around when deleted.</p>
<p>Using a PowerShell <a href="https://learn.microsoft.com/en-us/azure/virtual-machines/windows/find-unattached-disks?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Find and delete unattached Azure managed and unmanaged disks">script</a> <em>(provided by Microsoft),</em> you can report on any disks that are not in use by a VM and then delete them.</p>
<p><em>Note: Be VERY cautious doing this; solutions such as Citrix and Azure Image Builder use unmanaged disks to create new Session hosts, etc., so context is key.</em></p>
<p>With the Azure Storage accounts using Blob data – such as Diagnostic Accounts, it is a good idea to implement <a href="https://learn.microsoft.com/en-us/azure/storage/blobs/lifecycle-management-overview?tabs=azure-portal&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Azure Blob Storage Lifecycle">Azure Blob Storage Lifecycle</a> on the storage accounts, so we are only retaining recent and relevant data.</p>
<p><img decoding="async" loading="lazy" alt="Azure Blob Storage Lifecycle Management" src="/assets/images/azureblogstglifecyclemgmnt-71c283b9ac9b5a7105a08a426a9c5c5f.PNG" title="Azure Blob Storage Lifecycle Management" width="836" height="308" class="img_ev3q"></p>
<p>The lifecycle management policy lets you:</p>
<ol>
<li>Transition blobs to a cooler storage tier <em>(hot to cool, hot to archive, or cool to archive)</em> to optimize for performance and cost</li>
<li>Delete blobs at the end of their lifecycles</li>
<li>Define rules to be run once per day at the storage account level.</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="review-budgets">Review budgets<a href="#review-budgets" class="hash-link" aria-label="Direct link to Review budgets" title="Direct link to Review budgets">​</a></h4>
<p>Budgets in Cost Management help you plan for and drive organizational accountability. With budgets, you can account for the Azure services you consume or subscribe to during a specific period.</p>
<p>Budgets help you inform others about their spending to proactively manage costs and monitor how spending progresses over time.</p>
<p>When the budget thresholds you&#x27;ve created are exceeded, notifications are triggered. None of your resources is affected, and your consumption isn&#x27;t stopped; however, you can use Budget alerts as a trigger to run Azure Logic Apps or Functions to automate the shutdown and resize resources. You can use budgets to compare and track spending as you analyze costs.</p>
<p><img decoding="async" loading="lazy" alt="Azure Budget" src="/assets/images/azure_budget-9f4f49aa6ee0a6fb9e04e6c9a0b2f8b9.png" width="1390" height="773" class="img_ev3q"></p>
<p>Ensure Azure Budget notifications are configured to email Product Owners or other Stakeholders once a Resource Group or Subscription reaches a specific threshold.</p>
<p>This is set up in the Azure Portal, on the Resource Group under Budgets, and set to email the Application Owner.</p>
<p>Examples of budgets that could be configured:</p>
<p>Generally, I recommend that three budgets should be configured to give enough notice:</p>
<ul>
<li>50%</li>
<li>60%</li>
<li>70%</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="review-tags">Review Tags<a href="#review-tags" class="hash-link" aria-label="Direct link to Review Tags" title="Direct link to Review Tags">​</a></h4>
<p>You apply tags to your Azure resources, resource groups, and subscriptions to logically organize them into a taxonomy. Each tag consists of a name and a value pair. For example, you can apply the name &quot;Environment&quot; and the value &quot;Production&quot; to all the resources in production.</p>
<p>Tags can be used to determine things like:</p>
<ul>
<li>Who to bill?</li>
<li>Who supports it?</li>
</ul>
<p><img decoding="async" loading="lazy" alt="Azure Portal - Tags" src="/assets/images/operrationaltasksazuretags-a4781c0036a184bdc786c70af4c0a2f1.png" title="Azure Portal - Tags" width="1018" height="671" class="img_ev3q"></p>
<p>The right tags can mean that the right owners get charged internally and have more ownership of their resource costs. Examples below:</p>



































<table><thead><tr><th>Tag Name</th><th>Value</th><th>Comment</th></tr></thead><tbody><tr><td>Dept</td><td>Finance</td><td>Name of the department who owns the resources.</td></tr><tr><td>Environment</td><td>UAT</td><td>What environment the Resource is used for such as Production, UAT and Development</td></tr><tr><td>Application Owner</td><td>Luke Murray</td><td>The name of the Product Owner for the service sitting inside the Resource Group</td></tr><tr><td>Support Team</td><td>Platform Team</td><td>What team is responsible for the resources/site for support reasons</td></tr><tr><td>Billing Code</td><td>Operational</td><td>Purchase order or project billing code</td></tr></tbody></table>
<p>For further examples and a base tagging convention, check out a blog article I wrote on <a href="https://luke.geek.nz/azure/microsoft-azure-tagging-conventions/" target="_blank" rel="noopener noreferrer" title="Microsoft Azure Tagging Conventions ">Microsoft Azure Tagging conventions</a>.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="review-hub-hybrid-use-benefit">Review Hub (Hybrid Use Benefit)<a href="#review-hub-hybrid-use-benefit" class="hash-link" aria-label="Direct link to Review Hub (Hybrid Use Benefit)" title="Direct link to Review Hub (Hybrid Use Benefit)">​</a></h4>
<p>The <a href="https://azure.microsoft.com/en-us/pricing/hybrid-benefit/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Azure Hybrid Benefit">Azure Hybrid Benefit</a> is a pricing benefit for customers with Software Assurance licenses, which helps maximize the value of existing on-premises Windows Server and/or SQL Server license investments when migrating to Azure.</p>
<p>Eligible customers can save up to 40% on Azure Virtual Machines <em>(infrastructure as a service, or IaaS)</em>, and save up to 55% on Azure SQL Database <em>(platform as a service, or PaaS)</em> and SQL Server on Azure Virtual Machines <em>(IaaS)</em> with Azure Hybrid Benefit, which increases to up to 80% when combined with Azure Reserved Instances.</p>
<p><img decoding="async" loading="lazy" alt="Azure - Hybrid Use Benefit" src="/assets/images/operationaltasks_hub-2e8e011e86056038cf14b1c8a38b3c4b.png" title="Azure - Hybrid Use Benefit" width="1001" height="164" class="img_ev3q"></p>
<p>To verify if a server is using the Azure Hybrid Benefit, Log in to the Azure Portal and navigate to the Virtual Machine Blade. Make sure that the: OS Licensing Benefit column is selected.</p>
<p>If a Virtual Machine Already has HUB, it will have: The azure hybrid benefit listed in the column, and any non-supported workloads <em>(such as Linux)</em> will have ‘Not Supported’.</p>
<p>If any are eligible for HUB, click on the Virtual Machine…</p>
<ol>
<li>Click the <strong>Configuration blade</strong></li>
<li>Select <strong>Licensing, Already have a Windows server license?</strong></li>
<li><strong>Yes</strong> and <strong>Save</strong></li>
</ol>
<p><em>Note: This is a non-intrusive change that will take effect on the billing immediately and doesn’t cause any impact on the Virtual Machine.</em></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="review-backups">Review Backups<a href="#review-backups" class="hash-link" aria-label="Direct link to Review Backups" title="Direct link to Review Backups">​</a></h4>
<p><a href="https://learn.microsoft.com/en-us/azure/backup/backup-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Azure Backup">Azure Backup</a> is simple because it’s built into the platform. It has one-click backup support for SQL databases and virtual machines running in Azure.</p>
<p>Azure Backup is cost-effective and less complex than other cloud backup solutions while keeping your data safe from ransomware and human errors. Sometimes there will be workloads backed up to migrate, test, or clone, and you no longer need to retain the data.</p>
<blockquote>
<p>Note: This can be a tricky one as you will need to talk to product owners to confirm the workloads were just Dev/Test workloads, and not required, there may be legal implications for keeping workloads in the backup. But if someone stood up something to play with, particularly in a Sandbox or Development subscription there may not be a reason to keep it around.</p>
</blockquote>
<p>Log in to the Azure Portal and navigate the <a href="https://portal.azure.com/#blade/HubsExtension/BrowseResourceBlade/resourceType/Microsoft.RecoveryServices%2Fvaults" target="_blank" rel="noopener noreferrer" title="Azure Portal - Recovery Services">Recovery Services Vault</a> page. Navigate to each one and click on:</p>
<p>Backup:</p>
<ol>
<li>
<p>Under <strong>Usage</strong>, click on <strong>Backup Items</strong></p>
</li>
<li>
<p>Click on <strong>Azure Virtual Machines</strong></p>
</li>
<li>
<p><strong>Sort</strong> the <strong>Backup</strong> items by <strong>Latest Restore Point</strong> <em>(so the older restore points are at the top)</em></p>
<p>Using the Latest Restore Point as a guide, IF any servers can have their Backups deleted:</p>
</li>
<li>
<p>Click on the <strong>Name</strong> of the Backup Item</p>
</li>
<li>
<p>Click on <strong>Stop Backup</strong></p>
</li>
<li>
<p>Select <strong>Delete Backup Data</strong> <em>(this is non-reversible)</em></p>
</li>
<li>
<p>Type in the name of the <strong>Backup Item</strong> and select <strong>Stop Backup</strong></p>
</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="review-unused-public-ips">Review unused Public IPs<a href="#review-unused-public-ips" class="hash-link" aria-label="Direct link to Review unused Public IPs" title="Direct link to Review unused Public IPs">​</a></h4>
<p>Public IP addresses allow Internet resources to communicate inbound to Azure resources. Public IP addresses enable Azure resources to communicate to the Internet and public-facing Azure services.</p>
<p>This is also a great opportunity to inspect what Public IP addresses you have and make sure some resources have public IPs that does not need to be assigned! Tip setup an Azure Policy that prevents the creation of Public IPs.</p>
<p>The address is dedicated to the resource until it’s unassigned by you. A resource without a public IP assigned can communicate outbound. Azure dynamically assigns an available IP address that isn’t dedicated to the resource.</p>
<p><img decoding="async" loading="lazy" alt="Azure Portal - Public IP Address" src="/assets/images/operationaltasks_pip-9fa4bd529ba9db30b7ec775a91f661e4.png" title="Azure Portal - Public IP Address" width="1063" height="299" class="img_ev3q"></p>
<p>When resources get created, sometimes they will create a Public IP; these can be removed as part of the build but left in the Resource Groups.</p>
<p>We want to remove unattached Public IP to save money.</p>
<p><em>Note: In some cases, the Product Owner may need to be consulted before any changes are made, as some of the resources may be inflight projects or required.</em></p>
<ol>
<li>Log in to the <strong>Azure Portal</strong> and navigate to the <a href="https://portal.azure.com/#blade/HubsExtension/BrowseResourceBlade/resourceType/Microsoft.Network%2FPublicIpAddresses" target="_blank" rel="noopener noreferrer" title="Azure Portal - Public IP Address">Public IP Addresses</a> blade</li>
<li>Look in the ‘<strong>Associated to</strong>’ column, and if not required, click on the <strong>Public IP</strong></li>
<li>Click <strong>Delete</strong></li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="review-azure-storage-accounts">Review Azure Storage Accounts<a href="#review-azure-storage-accounts" class="hash-link" aria-label="Direct link to Review Azure Storage Accounts" title="Direct link to Review Azure Storage Accounts">​</a></h4>
<p>An Azure storage account contains all your Azure Storage data objects: blobs, files, queues, tables, and disks. Your Azure storage account&#x27;s data is durable, highly available, secure, and massively scalable.</p>
<p>General-purpose storage accounts may be configured for either of the following performance tiers:</p>
<ul>
<li>A standard performance tier for storing blobs, files, tables, queues, and Azure virtual machine disks.</li>
<li>A premium performance tier for storing unmanaged virtual machine disks. If a Storage account is Premium but only needs to be Standard <em>(or LRS instead of ZRS)</em>, this can save some money.</li>
</ul>
<p>Note: In some cases, the Product Owner may need to be consulted before any changes are made, as some of the resources may be inflight projects or required.</p>
<ol>
<li>Log in to the <strong>Azure Portal</strong> and navigate to the <a href="https://portal.azure.com/#blade/HubsExtension/BrowseResource/resourceType/Microsoft.Storage%2FStorageAccounts" target="_blank" rel="noopener noreferrer" title="Azure Portal - Storage account"><strong>Storage Account</strong></a> blade</li>
<li>Click on <strong>Manage View</strong>, <strong>Edit Columns</strong>, and add in: <strong>SKU</strong></li>
<li><strong>Review</strong> the <strong>Premium</strong> Storage <strong>Accounts</strong> and determine if any accounts need to be downsized to Standard</li>
<li>To <strong>change</strong>, click on the <strong>Storage Account</strong></li>
<li>Click on <strong>Configuration</strong> and change from <strong>Premium</strong> to <strong>Standard</strong></li>
</ol>
<p>You can also look at the Replication. Does that Storage Account need to be Geo-Redundant if the rest of the application that uses it isn’t? Can the storage account be changed to Standard during off-hours or non-peak?</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="--download-the-pdf-version-of-these-tasks">- Download the PDF version of these Tasks<a href="#--download-the-pdf-version-of-these-tasks" class="hash-link" aria-label="Direct link to - Download the PDF version of these Tasks" title="Direct link to - Download the PDF version of these Tasks">​</a></h4>
<p>Finally, if you prefer this in a more PDF/Visual format - you can download a PDF version of this directly from my Github &quot;<a href="https://github.com/lukemurraynz/presentations/blob/main/2022/Microsoft%20Azure%20-%20Cost%20Optimization_1.0.pdf" target="_blank" rel="noopener noreferrer" title="Azure Cost Optimization PDF">here</a>&quot;.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="--azure-operational-checklist-table">- Azure Operational Checklist table<a href="#--azure-operational-checklist-table" class="hash-link" aria-label="Direct link to - Azure Operational Checklist table" title="Direct link to - Azure Operational Checklist table">​</a></h4>
<p>This is a very quick example of what an Azure Operational Checklist could look like; if you record what tasks you do, you can look at further automation around implementation and reporting.</p>

























































































<table><thead><tr><th><strong>Azure Checklist</strong></th><th>****</th><th>****</th><th>****</th></tr></thead><tbody><tr><td><strong>Action</strong></td><td><strong>Status</strong></td><td><strong>Date</strong></td><td><strong>Note/Opportunity</strong></td></tr><tr><td><strong>Review Azure App Service Plans</strong></td><td></td><td></td><td></td></tr><tr><td><strong>Review shutdown workloads</strong></td><td></td><td></td><td></td></tr><tr><td><strong>Review Azure Advisor</strong></td><td></td><td></td><td></td></tr><tr><td><strong>Review Azure SQL Databases</strong></td><td></td><td></td><td></td></tr><tr><td><strong>Review Azure Reserved Instances</strong></td><td></td><td></td><td></td></tr><tr><td><strong>Review unused files and VHDs</strong></td><td></td><td></td><td></td></tr><tr><td><strong>Review budgets</strong></td><td></td><td></td><td></td></tr><tr><td><strong>Review Tags</strong></td><td></td><td></td><td></td></tr><tr><td><strong>Review Hub (Hybrid Use Benefit)</strong></td><td></td><td></td><td></td></tr><tr><td><strong>Review Backups</strong></td><td></td><td></td><td></td></tr><tr><td><strong>Review unused Public IPs</strong></td><td></td><td></td><td></td></tr><tr><td><strong>Review Azure Storage Accounts</strong></td><td></td><td></td><td></td></tr></tbody></table></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/tags/azure/">Azure</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/2022/08/17/connect-to-azure-sql-database-in-a-jupyter-notebook-using-python/">Connect to Azure SQL Database in a Jupyter Notebook using Python</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-08-17T00:00:00.000Z">August 17, 2022</time> · <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://luke.geek.nz/img/logo.png" alt="Luke Murray"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">Luke Murray</span></a></div><small class="authorTitle_nd0D" title="Author">Author</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><p><a href="https://jupyter.org/" target="_blank" rel="noopener noreferrer" title="Jupyter">Jupyter</a> Notebooks, commonly used by Data Scientists and Students, allow you to run code, such as Python and PowerShell, inside a Notebook format and display the output inside the notebook; this is useful for teaching a subject or displaying up-to-date information.</p>
<p>I am not a python or Jupyter expert, so this article will be brief on how I was able to connect to an Azure SQL Database using Microsoft Entra ID authentication and run a query.</p>
<p>To run a Jupyter Notebook, you can install <a href="https://www.anaconda.com/products/distribution" target="_blank" rel="noopener noreferrer" title="Anaconda">Anaconda</a> and then use that to download Juypter to run the notebooks from a locally <em>(or server)</em> hosted web-based interface.</p>
<p>However, today I will be using Visual Studio Code with the <a href="https://code.visualstudio.com/docs/datascience/jupyter-notebooks" target="_blank" rel="noopener noreferrer" title=" Jupyter Notebooks in VS Code ">Jupyter extension</a> on a windows endpoint.</p>
<p>Make sure you install:</p>
<ul>
<li><a href="https://www.python.org/downloads/" target="_blank" rel="noopener noreferrer" title="Python">Python</a></li>
<li><a href="https://pypi.org/project/pyodbc/" target="_blank" rel="noopener noreferrer" title="pyodbc ">pyodbc</a> library</li>
<li><a href="https://learn.microsoft.com/en-us/sql/connect/odbc/microsoft-odbc-driver-for-sql-server" target="_blank" rel="noopener noreferrer" title="Microsoft ODBC Driver for SQL Server">Microsoft ODBC Driver for SQL Server</a> <em>(has to be v17 or newer to support Microsoft Entra ID authentication)</em>.</li>
<li><a href="https://code.visualstudio.com/" target="_blank" rel="noopener noreferrer" title="Visual Studio Code">Visual Studio Code</a> + <a href="https://code.visualstudio.com/docs/datascience/jupyter-notebooks" target="_blank" rel="noopener noreferrer" title=" Jupyter Notebooks in VS Code">Jupyter extension</a></li>
</ul>
<p><em>Note: Jupyter notebook extensions end in &#x27;*.ipynb&#x27;.</em></p>
<p>Once all the prerequisites are installed, it&#x27;s time to create the Notebook.</p>
<ol>
<li>
<p>Open <strong>Visual Studio Code</strong></p>
</li>
<li>
<p>Click <strong>File</strong>, <strong>New File</strong></p>
</li>
<li>
<p>Select <strong>Jupyter Notebook</strong></p>
</li>
<li>
<p>Press <strong>+ Code</strong> <em>(to add a Code snippet)</em></p>
</li>
<li>
<p>First, we need to import the pyodbc library:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">#Libraries</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import pyodbc</span><br></span></code></pre></div></div>
</li>
</ol>
<p>Then we need to <strong>add the snippet to connect to the SQL database</strong> <em>(this can be in a separate Codeblock or the same code block, as long as the import is run before the SQL connection is made - <strong>make sure you update the server and database variables,</strong> to match your environment!)</em>:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">#Connection to SQL database</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">server = &#x27;tcp:SQLSERVER.database.windows.net&#x27; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">database = &#x27;DBNAME&#x27; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">username = &#x27;user@contoso.com&#x27; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">password = &#x27;password&#x27; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">connection = pyodbc.connect(&#x27;Driver={ODBC Driver 18 for SQL Server};Server=&#x27;+server+&#x27;,1433;Database=&#x27;+database+&#x27;;Uid=&#x27;+username+&#x27;;Pwd=&#x27;+password+&#x27;;Encrypt=yes;TrustServerCertificate=no;Connection Timeout=180;Authentication=ActiveDirectoryInteractive&#x27;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">cursor = connection.cursor()</span><br></span></code></pre></div></div>
<p>The &#x27;Authentication=ActiveDirectoryInteractive&#x27; parameter as part of the Connection string will prompt an interactive Microsoft Entra ID prompt to display and ask for credentials to be logged in; this includes MFA support. Using this method, the username and password variables are simply placeholders.</p>
<p>If you want to hardcode credentials into the Notebook <em>(not recommended)</em>, you can remove the &#x27;<em>Authentication=ActiveDirectoryInteractive</em>&#x27; section and enter the credentials into the username and password field.</p>
<p>Now that we have connected to the database, let us <strong>run a test query to obtain the SQL version</strong>:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">#Sample select query</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">cursor.execute(&quot;SELECT @@version;&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">row = cursor.fetchone()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">while row:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">print(row[0])</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">row = cursor.fetchone()</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="Jupyter python SQL connection" src="/assets/images/juptyer_notebook_query-2725747992751ea8ac1afcb105f1c3b1.png" width="1326" height="545" class="img_ev3q"></p>
<p>Congratulations, you have successfully connected to an Azure SQL database and ran a query against the database.</p>
<p>If the connection to SQL appears to be stalling, check to make sure the Azure authentication window, isn&#x27;t hidden behind another window.</p>
<p><em>A</em> <a href="https://gist.github.com/lukemurraynz/6636632309bc2bf2b1b37676ee0881ce" target="_blank" rel="noopener noreferrer" title="python.sqldb.text"><em>GIST</em></a> <em>has been created, with the code as well, in case issues are copied from the website.</em></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/tags/azure/">Azure</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/2022/08/09/create-a-public-holidays-api-using-microsoft-azure/">Create a Public Holidays API using Microsoft Azure</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-08-09T00:00:00.000Z">August 9, 2022</time> · <!-- -->16 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://luke.geek.nz/img/logo.png" alt="Luke Murray"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">Luke Murray</span></a></div><small class="authorTitle_nd0D" title="Author">Author</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><p>Using a previous <a href="https://luke.geek.nz/azure/turn-on-a-azure-virtual-machine-using-azure-automation/" target="_blank" rel="noopener noreferrer" title="Turn on a Azure Virtual Machine using Azure Automation">blog post</a> I did on using a third-party API <em>(Application Programming Interface)</em> to start a Virtual Machine when it wasn&#x27;t a Public Holiday, I had a thought on what could be an option if I wanted an API only accessible on an internal network or if I wanted to include custom Holidays such as Star Wars day or company holidays? Could I create and query my API using Microsoft Azure services? You can!</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">​</a></h3>
<blockquote>
<p>Today we will create a base Public Holidays API using several Microsoft Azure serverless services, such as Azure Function, Azure Storage Account and API Management.</p>
</blockquote>
<p><em>Note: As this is a demonstration, I will be using a</em> <a href="https://learn.microsoft.com/en-us/azure/azure-functions/functions-scale?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Azure Functions hosting options"><em>Consumption-based Azure Function</em></a> <em>and Azure storage account, and although it is a good place to start - depending on your requirements, you may be better off with Azure Function Premium Plan to avoid cold-start times, and if you need a high amount of requests and writes (GET and POSTs) and resiliency, then replace the Storage account table with a</em> <a href="https://learn.microsoft.com/en-us/azure/cosmos-db/introduction?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Azure Cosmos DB"><em>Cosmos DB</em></a><em>.</em></p>
<p>The solution will be made up of the following:</p>















































<table><thead><tr><th>Azure Service</th><th>Name</th><th>Plan</th><th>Note</th></tr></thead><tbody><tr><td>Application Insights</td><td>ai-nzPublicHolidays-prd-ae</td><td></td><td></td></tr><tr><td>Azure API Management</td><td>apims-publicholidays-prd-ae</td><td>Developer (No SLA)</td><td></td></tr><tr><td>Azure Function</td><td>func-nzpublicHolidays-prd-ae</td><td>Function App - Consumption</td><td></td></tr><tr><td>Azure Storage Account</td><td>funcnzpublicholidaystgac</td><td>StorageV2 (general purpose v2) - Locally-redundant storage (LRS)</td><td>Contains &#x27;PublicHolidays&#x27; table</td></tr><tr><td>Azure Storage Account</td><td>rgnzpublicholidayspb4ed</td><td>Storage (general purpose v1)  - Locally-redundant storage (LRS)</td><td>Contains Azure Functions App Files</td></tr><tr><td>Resource Group</td><td>rg-publicholidays-prd-ae</td><td></td><td>Resource Group - containing above resources.</td></tr></tbody></table>
<p><img decoding="async" loading="lazy" alt="Azure Resource Group - Diagram" src="/assets/images/api_resourcegroupazviz-6b750e49b76e6fbbc15caf8db97c3dac.png" title="Azure Resource Group - Diagram" width="2805" height="300" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="pre-requisites">Pre-requisites<a href="#pre-requisites" class="hash-link" aria-label="Direct link to Pre-requisites" title="Direct link to Pre-requisites">​</a></h4>
<ul>
<li>An Azure subscription <em>(with at least Contributor rights to a Resource Group)</em>.</li>
<li>Azure PowerShell modules <em>(</em><a href="https://learn.microsoft.com/en-us/powershell/module/az.accounts/?view=azps-8.2.0&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Az.Accounts"><em>Az.Accounts</em></a><em>,</em> <a href="https://learn.microsoft.com/en-us/powershell/module/az.storage/?view=azps-8.2.0&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Az.Storage"><em>Az.Storage</em></a> <em>&amp;</em> <a href="https://www.powershellgallery.com/packages/AzTable/" target="_blank" rel="noopener noreferrer" title="AzTable"><em>AzTables</em></a><em>)</em></li>
</ul>
<p><em>Note: AzTables is not part of the standard Az PowerShell module set and is a separate module you will need to install (Install-Module AzTables).</em></p>
<p>We will use a mix of the Azure Portal and PowerShell to deploy this solution from start to finish; you can find the source data and code directly in the GitHub repository here: <a href="https://github.com/lukemurraynz/PublicHoliday-API" target="_blank" rel="noopener noreferrer" title="PublicHoliday-API">lukemurraynz/PublicHoliday-API</a> for reference <em>(feel free to fork, raise pull requests etc.).</em> In this guide, I will try not to assume preexisting knowledge <em>(other than general Azure and PowerShell knowledge)</em>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="deployment">Deployment<a href="#deployment" class="hash-link" aria-label="Direct link to Deployment" title="Direct link to Deployment">​</a></h3>
<p>The deployment steps will be separated into different sections to help simplify implementation.</p>
<blockquote>
<p>First, make sure you adjust the names of your resources and locations to suit your naming conventions and regional locations <em>(such as Australia East or West Europe)</em>. Your deployments may fail if a name is already in use. See &quot;<a href="https://luke.geek.nz/azure/microsoft-azure-naming-conventions/" target="_blank" rel="noopener noreferrer" title="Microsoft Azure Naming Conventions ">Microsoft Azure Naming Conventions</a>&quot; for more about Naming conventions.</p>
</blockquote>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-resource-group">Create Resource Group<a href="#create-resource-group" class="hash-link" aria-label="Direct link to Create Resource Group" title="Direct link to Create Resource Group">​</a></h4>
<p>The Resource Group will contain all resources related to the API that we will deploy today.</p>
<p><em>However, I recommend you consider what resources might be shared outside of this API - such as API Management, and put them in a separate Shared or Common Resource Group, to keep the li.e.ecycle of your resources together (ie API resources all in one place, so if it gets decommissioned, it is as easy a deleting the Resource Group).</em></p>
<ol>
<li>Log in to the <a href="https://portal.azure.com/#home" target="_blank" rel="noopener noreferrer" title="Microsoft Azure Portal"><strong>Microsoft Azure Portal</strong></a></li>
<li>Click <strong>Click on the burger and click</strong> <a href="https://portal.azure.com/#view/HubsExtension/BrowseResourceGroups" target="_blank" rel="noopener noreferrer" title="Resource Groups"><strong>Resource groups</strong></a></li>
<li>Click <strong>+ Create</strong></li>
<li>Select your <strong>Subscription</strong></li>
<li>Type in a name for your <strong>Resource Group</strong> <em>(like &#x27;rg-publicholidays-prd-ae&#x27;)</em></li>
<li>Select your <strong>Region</strong> and click <strong>Next: Tags</strong></li>
<li>Enter in applicable <strong>tags</strong> <em>(i.e. Application: Public Holidays API)</em></li>
<li>Click <strong>Next: Review + create</strong></li>
<li>Click <strong>Create</strong></li>
</ol>
<p><img decoding="async" loading="lazy" alt="Create a resource group" src="/assets/images/azureportal_creatergapi-e4b9ec363fbcf561a94e95c818b36b5e.png" title="Create a resource group" width="736" height="374" class="img_ev3q"></p>
<p>If you prefer PowerShell, you can deploy a new Resource Group with the below:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">New-AzResourceGroup -Name &#x27;rg-publicholidays-prd-ae&#x27; -Location &#x27;Australia East&#x27; -Tag @{Application=&quot;Public Holidays API&quot;}</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-storage-account">Create Storage Account<a href="#create-storage-account" class="hash-link" aria-label="Direct link to Create Storage Account" title="Direct link to Create Storage Account">​</a></h4>
<p>Now that the Resource Group has been created, it&#x27;s time to import our Storage Account - which will hold our Table of data around Public Holidays.</p>
<ol>
<li>Log in to the <a href="https://portal.azure.com/#home" target="_blank" rel="noopener noreferrer" title="Microsoft Azure Portal"><strong>Microsoft Azure Portal</strong></a></li>
<li>Click <strong>Click on the burger and click</strong> <a href="https://portal.azure.com/#view/HubsExtension/BrowseResource/resourceType/Microsoft.Storage%2FStorageAccounts" target="_blank" rel="noopener noreferrer" title="Storage accounts"><strong>Storage Accounts</strong></a></li>
<li>Click <strong>+ Create</strong></li>
<li>Select the <strong>Subscription</strong> and <strong>Resource Group</strong> you created earlier</li>
<li>Enter in a <strong>Name</strong> for your <strong>Storage Account</strong> (<em>like &#x27;funcnzpublicholidaystgac&#x27;)</em></li>
<li>Select your <strong>Region</strong> <em>(i.e. Australia East)</em></li>
<li>For <strong>Performance</strong>, I am going to select: <strong>Standard</strong></li>
<li>For <strong>Redundancy</strong>, as this is a demo, I will select <strong>Locally-redundant storage (LRS). However, if</strong> you plan on running this in production, you may consider ZRS for zone redundancy.</li>
<li>If you plan on locking down the Storage Account to your Virtual Network or specific IP addresses, continue to the Networking Tab; we can accept the defaults and click: <strong>Review</strong>.</li>
<li>Click <strong>Create</strong></li>
</ol>
<p>If you prefer PowerShell, you can deploy a new Storage account with the below:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">New-AzStorageAccount -ResourceGroupName &#x27;rg-publicholidays-prd-ae&#x27; -Name &#x27;funcnzpublicholidaystgac&#x27; -Location &#x27;Australia East&#x27; -SkuName &#x27;Standard_LRS&#x27; -Kind StorageV2</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="import-public-holiday-data">Import Public Holiday data<a href="#import-public-holiday-data" class="hash-link" aria-label="Direct link to Import Public Holiday data" title="Direct link to Import Public Holiday data">​</a></h4>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="create-azure-storage-account-table">Create Azure Storage Account Table<a href="#create-azure-storage-account-table" class="hash-link" aria-label="Direct link to Create Azure Storage Account Table" title="Direct link to Create Azure Storage Account Table">​</a></h5>
<p>Now that we have the Storage account that will hold our Public Holiday time to import the data.</p>
<p>Most of this task will be done with PowerShell, but first, we need to create the Table that will hold our Public Holidays.</p>
<ol>
<li>Log in to the <a href="https://portal.azure.com/#home" target="_blank" rel="noopener noreferrer" title="Microsoft Azure Portal"><strong>Microsoft Azure Portal</strong></a></li>
<li>Click <strong>Click on the burger and click</strong> <a href="https://portal.azure.com/#view/HubsExtension/BrowseResource/resourceType/Microsoft.Storage%2FStorageAccounts" target="_blank" rel="noopener noreferrer" title="Storage accounts"><strong>Storage Accounts</strong></a></li>
<li><strong>Navigate</strong> to your created <strong>Storage</strong> account</li>
<li>In the Navigation blade, click <strong>Tables</strong></li>
<li>Click <strong>+ Table</strong></li>
<li>For a Table Name, I will go with <strong>PublicHolidays</strong></li>
<li>Click <strong>Ok</strong></li>
</ol>
<p><img decoding="async" loading="lazy" alt="Create Azure Storage Account Table" src="/assets/images/azureportal_createpublicholidaystable-17900c7b03aa308022d2d7418c793f5a.png" title="Create Azure Storage Account Table" width="753" height="521" class="img_ev3q"></p>
<p>You can use PowerShell to create the Table below:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$storageAccount = Get-AzStorageAccount -ResourceGroupName &#x27;rg-publicholidays-prd-ae&#x27; -Name &#x27;funcnzpublicholidaystgac&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$storageContext = $storageAccount.Context</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">New-AzStorageTable -Name &#x27;PublicHolidays&#x27; -Context $storageContext</span><br></span></code></pre></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="import-public-holiday-data-into-table">Import Public Holiday Data into Table<a href="#import-public-holiday-data-into-table" class="hash-link" aria-label="Direct link to Import Public Holiday Data into Table" title="Direct link to Import Public Holiday Data into Table">​</a></h5>
<p>Now that we have the Azure storage account and PublicHolidays table, it&#x27;s time to import the data.</p>
<p>If you want to do this manually, the Azure Table will have the following columns:</p>
<p>| Date | Country | Type | Name | Day | Year | Comments |</p>
<p>We could enter the data manually, but I will leverage the Nager API to download and parse a CSV file for a few countries. You can find the source data and code directly in the GitHub repository here: <a href="https://github.com/lukemurraynz/PublicHoliday-API" target="_blank" rel="noopener noreferrer" title="PublicHoliday-API">lukemurraynz/PublicHoliday-API</a> for reference.</p>
<p>To do this, we will need PowerShell, so assuming you have logged into PowerShell and set the context to your Azure subscription, let us continue.</p>
<p>I have created a CSV <em>(Comma-separated values)</em> file with a list of countries <em>(i.e. US, NZ, AU)</em> called &#x27;SourceTimeDate.CSV&#x27;, but you can adjust this to suit your requirements and place it in a folder on my C:\ drive called: Temp\API.</p>
<p>Open <strong>PowerShell</strong> and <strong>run</strong> the following:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$Folder = &#x27;C:\Temp\API\&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$Csv = Import-csv &quot;$Folder\DateTimeSource\SourceTimeDate.csv&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$CurrentYear = (Get-Date).Year</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   ForEach ($Country in $Csv)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$CountryCode = $Country.Country</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Invoke-WebRequest -Uri &quot;https://date.nager.at/PublicHoliday/Country/$CountryCode/$CurrentYear/CSV&quot; -OutFile &quot;$FolderAPI\DateTimeSource\Country$CountryCode$CurrentYear.csv&quot; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>These cmdlets will download a bunch of CSV files into the API folder, with the Public Holidays for each Country for this year, and then you can adjust the $CurrentYear variable for future years <em>(i.e. 2025)</em>.</p>
<p>Once you have all the CSV files for your Public Holidays and before we import the data into the Azure storage table, now is the time to create a new Custom Holidays CSV; you can easily use an existing one to create a new CSV containing your company&#x27;s public holidays or other days that may be missing from the standard list, make sure it matches the correct format and save it into the same folder.</p>
<p><img decoding="async" loading="lazy" alt="Custom Public Holidays API" src="/assets/images/customholidays_api-e3feccfea6b230e5b5caea2b070d43e5.png" title="Custom Public Holidays API" width="723" height="159" class="img_ev3q"></p>
<p>Now that you have all your CSV files containing the Public Holidays in your Country or countries, it&#x27;s time to import them into the Azure Table. First, we import the data using a PowerShell session logged into Azure.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Imports Public Holiday into Azure Storage table</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Requires AzTable Module (not part of the normal Az cmdlets)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Import-Module AzTable</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#Imports data from CSV files into $GLobalHolidays variable</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$Folder = &#x27;C:\Temp\API\&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$GlobalHolidays = Get-ChildItem &quot;$Folder\DateTimeSource\*.csv&quot; | Foreach-Object {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  $basename = $_.BaseName</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  import-csv $_ </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#Connect-AzAccount</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#Connects to Azure Storage Account</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$storageAccountName = &#x27;funcnzpublicholidaystgac&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$resourceGroupName = &#x27;rg-publicHolidays-prd-ae&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$tableName = &#x27;PublicHolidays&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$storageAccount = Get-AzStorageAccount -ResourceGroupName $resourceGroupName -Name $storageAccountName</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$storageContext = $storageAccount.Context</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$cloudTable = (Get-AzStorageTable -Name $tableName -Context $storageContext).CloudTable</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#Imports CSV data into Azure Table</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$counter = 0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">ForEach ($Holiday in $GlobalHolidays)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  $Date = [DateTime]($Holiday.Date)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  $Dayofweek = $Date.DayOfWeek | Out-String</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  $Year = $Date.Year</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  $HolidayDate = Get-Date $Date -format &quot;dd-MM-yyyy&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> Add-AzTableRow `</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  -table $cloudTable `</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  -partitionKey &#x27;1&#x27; `</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  -rowKey ((++$counter)) -property @{&quot;Date&quot;=$HolidayDate;&quot;Country&quot;=$Holiday.CountryCode;&quot;Type&quot;=$Holiday.Type;&quot;Name&quot;=$Holiday.LocalName;&quot;Day&quot;=$Dayofweek;&quot;Year&quot;=$Year;&quot;Comments&quot;=$Holiday.Counties}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#Validate the data in the Storage table</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Get-AzTableRow -table $cloudTable</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="Import CSV to Azure Storage Account" src="/assets/images/import-csvtoazuretables-8d10f55cd0b8a8e8297b959aa7ae3cd5.gif" title="Import CSV to Azure Storage Account" width="1203" height="361" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="Validate Azure Storage Account Table" src="/assets/images/import-csvtoazuretablesvalidate-0615d15e07b7cab4343607aa29e118e6.gif" title="Validate Azure Storage Account Table" width="1203" height="361" class="img_ev3q"></p>
<p>Now the Public Holidays are imported into the Azure storage account table with additional information, such as the Day it falls, and the Date format has been changed to suit the NZ format <em>(DD-MM-YYYY)</em>.</p>
<p>If we log in to the Azure Portal, navigate to the Storage account and under Storage Browser, we can now see our Table is full of Public Holidays.</p>
<p><img decoding="async" loading="lazy" src="/assets/images/azureportal_storagebrowser_api_table-4ed54d2629d3d74f3d5221901f6bd6d9.png" width="2109" height="965" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-api">Create API<a href="#create-api" class="hash-link" aria-label="Direct link to Create API" title="Direct link to Create API">​</a></h4>
<p>That we have our Table with Public Holiday data, it&#x27;s time to create our Azure Function to act as the API that will talk to the azure storage account!</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="create-azure-function">Create Azure Function<a href="#create-azure-function" class="hash-link" aria-label="Direct link to Create Azure Function" title="Direct link to Create Azure Function">​</a></h5>
<ol>
<li>Log in to the <a href="https://portal.azure.com/#home" target="_blank" rel="noopener noreferrer" title="Microsoft Azure Portal"><strong>Microsoft Azure Portal</strong></a></li>
<li>Click <strong>Click on the burger and click</strong> <a href="https://portal.azure.com/#view/HubsExtension/BrowseResourceGroups" target="_blank" rel="noopener noreferrer" title="Resource groups"><strong>Resource groups</strong></a></li>
<li>Navigate to your <strong>resource group</strong> and click <strong>+ Create</strong></li>
<li>Search for: <strong>Function</strong></li>
<li>Select <strong>Function App</strong>, and click <strong>Create</strong></li>
<li>Enter your <strong>Function App Name</strong> <em>(i.e. &#x27;func-nzpublicHolidays-prd-ae&#x27;)</em></li>
<li>For Runtime Stack, select <strong>PowerShell Core</strong></li>
<li>Select the latest version (at this time, it&#x27;s <strong>7.2</strong>)</li>
<li>Select your <strong>Region</strong></li>
<li>Select <strong>Windows</strong></li>
<li>Set your <strong>Plan</strong> <em>(in my example, its Consumption (Serverless))</em></li>
<li>Click <strong>Review + Create</strong></li>
<li>Click <strong>Create</strong></li>
</ol>
<p><img decoding="async" loading="lazy" alt="Azure Function - Create" src="/assets/images/azureportal_createazfunctionapiwin-ef7a4566a3c9cf027bafa17f95362cdb.png" title="Azure Function - Create" width="738" height="782" class="img_ev3q"></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="configure-environment-variables">Configure Environment Variables<a href="#configure-environment-variables" class="hash-link" aria-label="Direct link to Configure Environment Variables" title="Direct link to Configure Environment Variables">​</a></h5>
<p>Now that the Function App has been created before creating the GetPublicHoliday function, we need to add a few environment variables that the Function will use; these variables will contain the ResourceGroup and Storage account name.</p>
<ol>
<li><strong>Navigate</strong> to your <strong>Azure Function</strong></li>
<li>Click <strong>Configuration</strong></li>
<li>Click <strong>+ New application setting</strong></li>
<li>Under the name, add: <strong>PublicHolidayRESOURCEGROUPNAME</strong></li>
<li>For value, type in the name of your resource group.</li>
<li>Add a second application setting named: <strong>PublicHolidaySTORAGEACCNAME</strong></li>
<li>For value, type in the name of your storage account that contains the Public Holiday table.</li>
<li>Click <strong>Save</strong> <em>(to save the variables)</em>.</li>
</ol>
<p><img decoding="async" loading="lazy" alt="Azure Function - Variables" src="/assets/images/azureportal_funcapp_api_variables-1cd7cf230579d1c83511b45531fa3f14.png" title="Azure Function - Variables" width="1318" height="672" class="img_ev3q"></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="configure-managed-identity">Configure Managed Identity<a href="#configure-managed-identity" class="hash-link" aria-label="Direct link to Configure Managed Identity" title="Direct link to Configure Managed Identity">​</a></h5>
<p>Next, we need to give the Function App the ability to read the Azure storage account. To do this, we need to configure a System assigned managed identity.</p>
<ol>
<li><strong>Navigate</strong> to your <strong>Azure Function</strong></li>
<li>Click <strong>Identity</strong></li>
<li>Under the System assigned heading, toggle the status to <strong>On</strong></li>
<li>Click <strong>Save</strong></li>
<li>Select <strong>Yes</strong>, to enable the System assigned managed identity</li>
<li>Under Permissions, click <strong>Azure role assignments</strong></li>
<li>Click <strong>+ Add role assignment</strong></li>
<li>For Scope, select <strong>Storage</strong></li>
<li>Select your Subscription and storage account containing your Public Holiday data</li>
<li>For role, select <strong>Contributor</strong> <em>(Storage Table Data Reader is not enough).</em></li>
<li>Click <strong>Save</strong></li>
</ol>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="configure-requirements">Configure Requirements<a href="#configure-requirements" class="hash-link" aria-label="Direct link to Configure Requirements" title="Direct link to Configure Requirements">​</a></h5>
<p>The Azure function app will rely on a few PowerShell Modules; for the FunctionApp to load them, we need to add them to the requirements.psd1 file.</p>
<ol>
<li>
<p><strong>Navigate</strong> to your <strong>Azure Function</strong></p>
</li>
<li>
<p>Click <strong>App files</strong></p>
</li>
<li>
<p>Change the dropdown to <strong>requirements.psd1</strong></p>
</li>
<li>
<p>In the hash array, comment out the #Az module line <em>(as this will load the entire Az Module set, which will cause an increased delay in the startup as those extra modules aren&#x27;t needed)</em>, and add the following:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain"># This file enables modules to be automatically managed by the Functions service.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># See https://aka.ms/functionsmanageddependency for additional information.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # For latest supported version, go to &#x27;https://www.powershellgallery.com/packages/Az&#x27;. </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # To use the Az module in your function app, please uncomment the line below.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    #&#x27;Az&#x27; = &#x27;8.*&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &#x27;Az.Accounts&#x27;  = &#x27;2.*&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &#x27;Az.Storage&#x27;   = &#x27;4.*&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &#x27;Az.Resources&#x27; = &#x27;2.*&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &#x27;AzTable&#x27;      = &#x27;2.*&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre></div></div>
</li>
<li>
<p>Click <strong>Save</strong></p>
</li>
</ol>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="create-function-publicholidays">Create Function PublicHolidays<a href="#create-function-publicholidays" class="hash-link" aria-label="Direct link to Create Function PublicHolidays" title="Direct link to Create Function PublicHolidays">​</a></h5>
<p>Now that the Function App has been configured, it is time to create our Function.</p>
<ol>
<li><strong>Navigate</strong> to your <strong>Azure Function</strong></li>
<li>Click <strong>Functions</strong></li>
<li>Click <strong>+ Create</strong></li>
<li>Change Development environment to <strong>Develop in Portal</strong></li>
<li>Select Template, an <strong>HTTP trigger</strong></li>
<li>For the New Function name, I will go with <strong>GetPublicHoliday</strong></li>
<li>Change Authorization level to <strong>Anonymous</strong> <em>(if you aren&#x27;t going to implement API Management, select Function and look at whitelisting your IP only, we will be locking it down to API Management later)</em>.</li>
<li>Click <strong>Create</strong></li>
</ol>
<p><img decoding="async" loading="lazy" alt="Create Azure Function App" src="/assets/images/azureportal_createfunctionpublicholidays-2673e41f9b6d67f4d37da55b13f9de6c.png" title="Create Azure Function App" width="840" height="829" class="img_ev3q"></p>
<ol>
<li>
<p>Click <strong>Code + Test</strong></p>
</li>
<li>
<p>Copy the following Code into the run.ps1 file, this code is core to the Function that will read the HTTP request and bring back a PowerShell object with the Public Holiday information as part of a GET request:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">&lt;# The code above does the following, explained in English:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">1. Read the query parameters from the request.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">2. Read the body of the request.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">3. Write to the Azure Functions log stream.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">4. Interact with query parameters or the body of the request.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">5. Associate values to output bindings by calling &#x27;Push-OutputBinding&#x27;. </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">https://luke.geek.nz/ #&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">using namespace System.Net</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Input bindings are passed in via param block.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">param([Parameter(Mandatory = $true)]$Request, [Parameter(Mandatory = $true)]$TriggerMetadata)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Write to the Azure Functions log stream.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Write-Host &#x27;GetPublicHoliday function processed a request.&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Interact with query parameters or the body of the request.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$date = $Request.Query.Date</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$country = $Request.Query.CountryCode</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$resourceGroupName = $env:PublicHolidayRESOURCEGROUPNAME</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$storageAccountName = $env:PublicHolidaySTORAGEACCNAME</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$tableName = &#x27;PublicHolidays&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ClientIP = $Request.Headers.&quot;x-forwarded-for&quot;.Split(&quot;:&quot;)[0]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">try {   </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  $storageAccount = Get-AzStorageAccount -ResourceGroupName $resourceGroupName -Name $storageAccountName</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  $storageContext = $storageAccount.Context</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  $cloudTable = (Get-AzStorageTable -Name $tableName -Context $storageContext).CloudTable</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  Import-Module AzTable   </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  $Tables = Get-AzTableRow -table $cloudTable </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  ForEach ($table in $Tables)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    [string]$Filter1 = [Microsoft.Azure.Cosmos.Table.TableQuery]::GenerateFilterCondition(&quot;Country&quot;, [Microsoft.Azure.Cosmos.Table.QueryComparisons]::Equal, $country)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    [string]$Filter2 = [Microsoft.Azure.Cosmos.Table.TableQuery]::GenerateFilterCondition(&quot;Date&quot;, [Microsoft.Azure.Cosmos.Table.QueryComparisons]::Equal, $date)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    [string]$finalFilter = [Microsoft.Azure.Cosmos.Table.TableQuery]::CombineFilters($Filter1, &quot;and&quot;, $Filter2)     </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    $object = Get-AzTableRow -table $cloudTable -CustomFilter $finalFilter</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    $body = @()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    $System = New-Object -TypeName PSObject</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Add-Member -InputObject $System -MemberType NoteProperty -Name CountryCode -Value   $object.Country</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Add-Member -InputObject $System -MemberType NoteProperty -Name HolidayDate -Value   $object.Date</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Add-Member -InputObject $System -MemberType NoteProperty -Name HolidayYear -Value   $object.Year</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Add-Member -InputObject $System -MemberType NoteProperty -Name HolidayName -Value   $object.Name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Add-Member -InputObject $System -MemberType NoteProperty -Name HolidayType -Value   $object.Type</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Add-Member -InputObject $System -MemberType NoteProperty -Name Comments -Value      $object.Comments</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Add-Member -InputObject $System -MemberType NoteProperty -Name RequestedIP -Value   $ClientIP</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    $body += $System</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    $System = New-Object -TypeName PSObject</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    $status = [Net.HttpStatusCode]::OK</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">catch {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  $body = &quot;Failure connecting to table for state data, $_&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  $status = [Net.HttpStatusCode]::BadRequest</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#$body =  $TriggerMetadata</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Associate values to output bindings by calling Push-OutputBinding&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Push-OutputBinding -Name Response -Value ([HttpResponseContext]@{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    StatusCode = $status</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Body       = $body</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">)</span><br></span></code></pre></div></div>
</li>
<li>
<p>Click <strong>Save</strong></p>
</li>
</ol>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="test-function---publicholidays">Test Function - PublicHolidays<a href="#test-function---publicholidays" class="hash-link" aria-label="Direct link to Test Function - PublicHolidays" title="Direct link to Test Function - PublicHolidays">​</a></h5>
<p>Before proceeding with the next step, it&#x27;s time to test the function.</p>
<ol>
<li><strong>Navigate</strong> to your <strong>Azure Function</strong></li>
<li>Click <strong>Functions</strong></li>
<li>Click <strong>GetPublicHoliday</strong></li>
<li>Click <strong>Code + Test</strong></li>
<li>Click <strong>Test/Run</strong></li>
<li>Change HTTP method to <strong>Get</strong></li>
<li>Under Query, add Country value and Date value.</li>
</ol>
<p>Note: Make sure the date and country formats match what is in the Azure storage account.</p>
<p>You can also Invoke the function app directly with PowerShell, with the Date and Country as Parameters at the end:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Invoke-RestMethod -URI &quot;https://func-nzpublicholidays-prd-ae.azurewebsites.net/api/GetPublicHoliday?Date=25-12-2023&amp;CountryCode=NZ&quot;</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="Test Public Holiday API" src="/assets/images/testpublicholidayapi-3b124ddd861072dc80c53f1fee4ffb52.gif" title="Test Public Holiday API" width="1203" height="361" class="img_ev3q"></p>
<p>Congratulations! You have now created a Public Holiday API that you can call for automation! You can lock down the Function App to only certain IPs or proceed to configure Azure API Management.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="configure-azure-api-management">Configure Azure API Management<a href="#configure-azure-api-management" class="hash-link" aria-label="Direct link to Configure Azure API Management" title="Direct link to Configure Azure API Management">​</a></h5>
<p>Now that the Function App responds to requests, we can expose the HTTP endpoint through <a href="https://learn.microsoft.com/en-us/azure/azure-functions/functions-openapi-definition?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Expose serverless APIs from HTTP endpoints using Azure API Management">Azure API Management</a>. Azure API Management will give greater flexibility and security over API endpoints, particularly when dealing with more than one API. Azure API Management also offers inbuilt shared cache functionality and integration into <a href="https://azure.microsoft.com/en-us/services/cache/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title=" Azure Cache for Redis®2">Azure Cache for Redis</a>.</p>
<ol>
<li>Log in to the <a href="https://portal.azure.com/#home" target="_blank" rel="noopener noreferrer" title="Microsoft Azure Portal"><strong>Microsoft Azure Portal</strong></a></li>
<li><strong>Navigate</strong> to your <strong>Azure Function</strong></li>
<li>On the Navigation blade, select <strong>API Management</strong></li>
<li>Click <strong>Create New</strong></li>
<li>Select your subscription, <strong>Region</strong>, and organisation <strong>name</strong>.</li>
<li>Select a <a href="https://azure.microsoft.com/en-us/pricing/details/api-management/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title=" API Management pricing"><strong>Pricing Tier</strong></a></li>
<li>Click <strong>Review + Create</strong></li>
<li>Click <strong>Create</strong></li>
</ol>
<p><img decoding="async" loading="lazy" alt="Create Azure API Management" src="/assets/images/azureportal_createapimanagement-7cd983b8676b0d28c16984ab9db47cdc.png" width="802" height="790" class="img_ev3q"></p>
<ol>
<li>
<p>Wait for 10 minutes to half an hour for provisioning to take place, and Azure API Management will be in an activating state.</p>
</li>
<li>
<p>Once API Management has been provisioned, you can <strong>copy</strong> the <strong>Virtual IP (VIP)</strong> addresses of API Management and <strong>restrict</strong> your <strong>function</strong> app to <strong>only</strong> allow <strong>inbound</strong> access from that <strong>IP</strong>.</p>
</li>
<li>
<p>Once you have done that, add the GetPublicHoliday function app into Azure API Management, add the paths to add a version, and then, using the subscription key, you run the following command to pull data.</p>
<p>Invoke-RestMethod -uri &quot;<a href="https://apims-nzpublicholidays-prd-ae.azure-api.net/v1/GetPublicHoliday?Date=4/05/2022&amp;CountryCode=NZ&amp;Ocp-Apim-Subscription-Key=$KEY" target="_blank" rel="noopener noreferrer">https://apims-nzpublicholidays-prd-ae.azure-api.net/v1/GetPublicHoliday?Date=4/05/2022&amp;CountryCode=NZ&amp;Ocp-Apim-Subscription-Key=$KEY</a>&quot;</p>
</li>
</ol></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/tags/azure/">Azure</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/azure/microsoft-azure-zonalallocationfailed/">Microsoft Azure - ZonalAllocationFailed</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-07-27T00:00:00.000Z">July 27, 2022</time> · <!-- -->5 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://luke.geek.nz/img/logo.png" alt="Luke Murray"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">Luke Murray</span></a></div><small class="authorTitle_nd0D" title="Author">Author</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><blockquote>
<p><strong>Error code</strong>: AllocationFailed or ZonalAllocationFailed</p>
<p><strong>Error message</strong>: &quot;Allocation failed. We do not have sufficient capacity for the requested VM size in this region. Read more about improving likelihood of allocation success at <a href="https://aka.ms/allocation-guidance?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="https://aka.ms/allocation-guidance">https://aka.ms/allocation-guidance</a>&quot;</p>
</blockquote>
<p>When you create a virtual machine <em>(VM)</em>, start stopped <em>(deallocated)</em> VMs, or resize a VM, Microsoft Azure allocates compute resources to your subscription.</p>
<p><img decoding="async" loading="lazy" alt="ZonalAllocationFailed" src="/assets/images/zonalallocationfailed-d3444d5a5ebfba3d83efb1663e5ca216.png" title="ZonalAllocationFailed" width="831" height="122" class="img_ev3q"></p>
<p>Microsoft is continually investing in additional infrastructure and features to ensure that they always have all VM types available to support customer demand. However, you may occasionally experience resource allocation failures because of unprecedented growth in demand for Azure services in specific regions.</p>
<p>These tips, also apply to the &#x27;Following SKUs have failed for Capacity Restrictions&#x27; error.</p>
<p>This error could also be caused by a parameter issue with your Infrastructure as Code deployments, if you are to restrictive and it attempts to create a resource that isn&#x27;t supported - an example is a SKU that doesn&#x27;t support Accelerated Networking, or an attempt to deploy an Ultra SSD disk for a SKU that doesn&#x27;t deploy it.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="waiting-for-more-compute-to-be-added-to-the-azure-server-clusters-may-not-be-an-option-so-what-can-you-do"><strong>Waiting for more Compute to be added to the Azure server clusters may not be an option, so what can you do?</strong><a href="#waiting-for-more-compute-to-be-added-to-the-azure-server-clusters-may-not-be-an-option-so-what-can-you-do" class="hash-link" aria-label="Direct link to waiting-for-more-compute-to-be-added-to-the-azure-server-clusters-may-not-be-an-option-so-what-can-you-do" title="Direct link to waiting-for-more-compute-to-be-added-to-the-azure-server-clusters-may-not-be-an-option-so-what-can-you-do">​</a></h4>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="raise-a-support-case">Raise a Support Case<a href="#raise-a-support-case" class="hash-link" aria-label="Direct link to Raise a Support Case" title="Direct link to Raise a Support Case">​</a></h5>
<ul>
<li>Take a screenshot of the error</li>
<li>Copy the Activity/Deployment ID</li>
<li>Take note of the Region</li>
<li>Take note of the Availability Zone.</li>
</ul>
<p>Let <a href="https://azure.microsoft.com/en-us/support/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title=" Azure Support">Azure Support</a> know; that Microsoft may already be aware, but raising a support request helps identify potentially impacted customers. If you know of other SKUs you need to deploy, you can let them know.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="purchase-on-demand-capacity-reservation">Purchase On-demand Capacity Reservation<a href="#purchase-on-demand-capacity-reservation" class="hash-link" aria-label="Direct link to Purchase On-demand Capacity Reservation" title="Direct link to Purchase On-demand Capacity Reservation">​</a></h5>
<p><a href="https://learn.microsoft.com/en-us/azure/virtual-machines/capacity-reservation-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="On-demand Capacity Reservation">On-demand Capacity Reservation</a> enables you to reserve Compute capacity in an Azure region or an Availability Zone for any duration of time.</p>
<p>Unlike <a href="https://azure.microsoft.com/en-us/pricing/reserved-vm-instances/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Reserved Instances">Reserved Instances</a>, you do not have to sign up for a 1-year or a 3-year term commitment.</p>
<p>Once the Capacity Reservation is created, the capacity is available immediately and is exclusively reserved for your use until the reservation is deleted.</p>
<p>Capacity Reservations are priced at the same rate as the underlying VM size.</p>
<p>For example, if you create a reservation for the D2s_v3 VMs, you will start getting billed for the D2s_v3 VMs, even if the reservation is not being used.</p>
<p>So why would you purchase On-demand Capacity reservations?</p>
<ul>
<li>You are operating Azure workloads that scale out and run off a fresh image, like a Citrix farm and want to ensure the capacity is available for the minimum workloads you need.</li>
<li>You have a project coming up where you need the capacity to be available.</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="redeploy-to-another-availability-zone">Redeploy to another Availability Zone<a href="#redeploy-to-another-availability-zone" class="hash-link" aria-label="Direct link to Redeploy to another Availability Zone" title="Direct link to Redeploy to another Availability Zone">​</a></h5>
<p>The server cluster that ARM (Azure Resource Manager) attempted to deploy your workload may not have the necessary capacity, but another Availability Zone <em>(datacenter)</em> might.</p>
<p>Make sure your Virtual Machine is not in a Proximtry or Avalibility Group and do the following.</p>
<ol>
<li><strong>Take note of the Availability Zone that your deployment failed</strong> <em>(i.e. Availability Zone 1)</em></li>
<li><strong>Remove any resources</strong> that may have been created as part of the original failed deployment.</li>
<li><strong>Redeploy</strong> your workload and <strong>select</strong> another Availability <strong>Zone</strong>, such as <em>(2 - if your failed deployment was in Zone 1)</em></li>
</ol>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="change-the-virtual-machine-version">Change the Virtual Machine version<a href="#change-the-virtual-machine-version" class="hash-link" aria-label="Direct link to Change the Virtual Machine version" title="Direct link to Change the Virtual Machine version">​</a></h5>
<p>By version, I don&#x27;t mean <a href="https://learn.microsoft.com/en-us/azure/virtual-machines/generation-2?WT.mc_id=AZ-MVP-5004796#features-and-capabilities" target="_blank" rel="noopener noreferrer" title="Generation 1 vs. generation 2 features">Generation 1 and Generation 2</a> Virtual Machines; I mean the version of underlying Compute; when you look at a VM SKU size, you will see:</p>
<blockquote>
<p>Standard_DC24s_<strong>v3</strong></p>
<p>[Family] + <em>[Sub-family]</em>* + [# of vCPUs] + <em>[Constrained vCPUs]</em>* + [Additive Features] + <em>[Accelerator Type]</em>* + <strong>[Version]</strong></p>
</blockquote>
<p>You can read more about Virtual Machine Naming conversions &quot;<a href="https://learn.microsoft.com/en-us/azure/virtual-machines/vm-naming-conventions?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Azure virtual machine sizes naming conventions">here</a>&quot;.</p>
<p>The version of the VM series links to the underlying hardware associated with the Virtual Machine series; with most new hardware releases, the version changes; an example is: from v3 to v4.</p>
<blockquote>
<p>#Tip: Microsoft may run a promotion on the pricing for early adopters from time to time, to move to the new version; they can be seen from the Azure Portal with &quot;Promo&quot; in the name.</p>
</blockquote>
<ol>
<li>You can <strong>change the version of the SKU</strong> by looking in the Azure Portal, <strong>Sizing</strong>, and you should be <strong>select</strong> different <strong>versions</strong> of the same SKU; <em>if you are at v5, try resizing to v4 - or the other way around</em>.</li>
</ol>
<p>Remember that changing the VM SKU will force the Virtual Machine to deallocate <em>(stop)</em>, as it triggers ARM to stand up the Virtual Machine on different server clusters/hardware.</p>
<p><em>I have found that there are no noticeable decreases in performance for most workloads, but keep in mind you may be returning on older hardware - but it should get you going, and then you can update the SKU to the latest version later.</em></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="increase-regional-vcpu-quotas">Increase regional vCPU quotas<a href="#increase-regional-vcpu-quotas" class="hash-link" aria-label="Direct link to Increase regional vCPU quotas" title="Direct link to Increase regional vCPU quotas">​</a></h5>
<p>Azure Resource Manager enforces two types of vCPU quotas for virtual machines:</p>
<ul>
<li>
<p>standard vCPU quotas</p>
</li>
<li>
<p>spot vCPU quotas
Standard vCPU quotas apply to pay-as-you-go VMs and reserved VM instances. They are enforced at two tiers, for each subscription, in each region:</p>
</li>
<li>
<p>The first tier is the total regional vCPU quota.</p>
</li>
<li>
<p>The second tier is the VM-family vCPU quota such as D-series vCPUs.</p>
</li>
</ul>
<p>Check your subscription quotas and if necessary, raise a request to increase them by following the guide here: [Increase regional vCPU quotas]{<a href="https://learn.microsoft.com/azure/quotas/regional-quota-requests?WT.mc_id=AZ-MVP-5004796%7D" target="_blank" rel="noopener noreferrer">https://learn.microsoft.com/azure/quotas/regional-quota-requests?WT.mc_id=AZ-MVP-5004796}</a></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/tags/azure/">Azure</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/page/24/"><div class="pagination-nav__label">Newer entries</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/page/26/"><div class="pagination-nav__label">Older entries</div></a></nav></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 luke.geek.nz. Powered by coffee, clouds and hamsters on wheels!</div></div></div></footer></div>
</body>
</html>