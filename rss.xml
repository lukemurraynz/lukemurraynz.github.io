<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>luke.geek.nz Blog</title>
        <link>https://luke.geek.nz/</link>
        <description>luke.geek.nz Blog</description>
        <lastBuildDate>Sat, 01 Mar 2025 07:41:23 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <language>en</language>
        <copyright>Copyright ¬© 2025 luke.geek.nz.</copyright>
        <item>
            <title><![CDATA[Deploying Azure Landing Zones with the Terraform Accelerator]]></title>
            <link>https://luke.geek.nz/azure/azure-landing-zone-accelerator/</link>
            <guid>https://luke.geek.nz/azure/azure-landing-zone-accelerator/</guid>
            <pubDate>Sat, 01 Mar 2025 07:41:23 GMT</pubDate>
            <description><![CDATA[Learn how to deploy Azure Platform Landing Zones using the Terraform Accelerator and Azure DevOps.]]></description>
            <content:encoded><![CDATA[<p>As part of the <a href="https://www.azurespringclean.com/" target="_blank" rel="noopener noreferrer">Azure Spring Clean 2025</a> event for 2025, we are here to take a look at <a href="https://learn.microsoft.com/azure/cloud-adoption-framework/ready/landing-zone/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Landing Zones</a>, specifically <a href="https://learn.microsoft.com/azure/cloud-adoption-framework/ready/landing-zone/?WT.mc_id=AZ-MVP-5004796#platform-landing-zones-vs-application-landing-zones" target="_blank" rel="noopener noreferrer">Platform Landing Zones</a>, and the deployment of the Platform Landing Zone, using an <a href="https://azure.github.io/Azure-Landing-Zones/accelerator/" target="_blank" rel="noopener noreferrer">accelerator</a> and Azure DevOps for the CI/CD.</p>
<p><a href="https://www.azurespringclean.com/" target="_blank" rel="noopener noreferrer"><img decoding="async" loading="lazy" alt="Azure Spring Clean 2025" src="https://luke.geek.nz/assets/images/AzureSpringClean25_Logo-a92ac1a62ff65fcddaaf2a0ef4c39dc9.png" width="2500" height="1400" class="img_ev3q"></a></p>
<!-- -->
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-introduction-to-azure-landing-zones">üèóÔ∏è Introduction to Azure Landing Zones<a href="https://luke.geek.nz/azure/azure-landing-zone-accelerator/#%EF%B8%8F-introduction-to-azure-landing-zones" class="hash-link" aria-label="Direct link to üèóÔ∏è Introduction to Azure Landing Zones" title="Direct link to üèóÔ∏è Introduction to Azure Landing Zones">‚Äã</a></h2>
<p><a href="https://learn.microsoft.com/azure/cloud-adoption-framework/ready/landing-zone/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Landing Zones</a> provide a structured approach for designing and implementing cloud environments in Azure. They are essential for organizations looking to migrate, modernize, and innovate their applications at scale, mainly because of the considerations you make in designing and implementating them, considerations such as how your workloads are going to connect to the internet, how each service connects, and importantely, how your organisation will use Cloud - I saw a comment from someone the other day <em>(Cloud is not WHERE you work, its HOW you work)</em>.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>An Azure landing zone is an environment that follows key design principles across eight design areas. These design principles accommodate all application portfolios and enable application migration, modernization, and innovation at scale. An Azure landing zone uses subscriptions to isolate and scale application and platform resources. Subscriptions for application resources are called application landing zones, and subscriptions for platform resources are called platform landing zones.</p><p>An Azure landing zone architecture is scalable and modular to meet various deployment needs. The repeatable infrastructure allows you to consistently apply configurations and controls to every subscription. Modules make deploying and modifying specific Azure landing zone architecture components easy as your requirements evolve.</p><p><img decoding="async" loading="lazy" alt="Azure Landing Zones" src="https://luke.geek.nz/assets/images/azure-landing-zone-architecture-diagram-hub-spoke-760034b8ea0ae977ac1aebbfcdd88b92.png" width="4759" height="2835" class="img_ev3q"></p></div></div>
<p>More information on Azure Landing Zones, can be found in the <a href="https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Microsoft Cloud Adoption Framework for Azure</a>, Landing Zones specifically sits under the Ready phase.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-understanding-azure-landing-zone-accelerators">üöÄ Understanding Azure Landing Zone Accelerators<a href="https://luke.geek.nz/azure/azure-landing-zone-accelerator/#-understanding-azure-landing-zone-accelerators" class="hash-link" aria-label="Direct link to üöÄ Understanding Azure Landing Zone Accelerators" title="Direct link to üöÄ Understanding Azure Landing Zone Accelerators">‚Äã</a></h2>
<p><a href="https://azure.github.io/Azure-Landing-Zones/accelerator/" target="_blank" rel="noopener noreferrer">Azure Landing Zone Accelerators</a> are automation frameworks designed to expedite the deployment of Azure Landing Zone architecture. They come in three flavors:</p>
<ul>
<li>Bicep Accelerator</li>
<li>Terraform Accelerator</li>
<li>Portal Accelerator</li>
</ul>
<p>These Accelerators, adopt a best-practice approach <em>(but also opinionated)</em> to deploy an Azure Landing Zone, from scratch, whether Brownfield <em>(already existing)</em> or Greenfield <em>(new)</em>, and they have been going through a transformation, from previous accelerators <em>(marked as vNext)</em> to adopt a more moduler approach with both Bicep and Terraform deployments aligned to <a href="https://azure.github.io/Azure-Verified-Modules/" target="_blank" rel="noopener noreferrer">Azure Verified Modules</a>. These Accelerators are what Microsoft would run in a VBD workshop <em>(I believe they would use the Portal accelerator)</em>.</p>
<p>I want to make clear, these just like the Cloud Adoption Framework, are best pratices but also gernalized to support multiple types of organisations, so make sure you adjust them to suit your needs and organisations, or even mark it as a northstar to aim towards, but not necessary what you need in that moment, but also consider strategically where you want to go, ie platform engineering, de-centralized or centralized operations, all these decisions will determine how your Landing Zone structure is based and used <em>(ie if you don't like the word Online, change it to Public, your business needs to understand where to put workloads and how they will work <em>(not spending the time fighing over what something is named)</em>)</em>.</p>
<p>With Landing Zones, theres the Platform Landing Zone and the Application Landing Zone, the Platform Landing Zone is the shared services like identity, connectivity, and management, where as the Application Landing Zone is specific environments for particular applications or workloads <em>(consider Arc, maybe APIM, anything generazlied - this is really where your business logic and IP sits)</em>.</p>
<p><img decoding="async" loading="lazy" alt="Azure Landing Zones - Customer Journey" src="https://luke.geek.nz/assets/images/ALZAccelerator_CustomerJourney-914c88d575ebf22eb152962a5a286d48.JPG" width="4000" height="2250" class="img_ev3q"></p>
<p>For this article, we will be discussing the:</p>
<ul>
<li>Bootstrap of our environment (into Azure DevOps)</li>
<li>Deployment of Azure platform Landing Zone components using Terraform</li>
</ul>
<p><img decoding="async" loading="lazy" alt="Azure Landing Zones - Customer Journey" src="https://luke.geek.nz/assets/images/ALZAccelerator_SampleLandingZoneDeployment-636770bcbe9bd9b7cc2a69e9ed64aa24.JPG" width="4000" height="2250" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-deploying-azure-landing-zones-with-terraform">üîÑ Deploying Azure Landing Zones with Terraform<a href="https://luke.geek.nz/azure/azure-landing-zone-accelerator/#-deploying-azure-landing-zones-with-terraform" class="hash-link" aria-label="Direct link to üîÑ Deploying Azure Landing Zones with Terraform" title="Direct link to üîÑ Deploying Azure Landing Zones with Terraform">‚Äã</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-bootstrap">üõ†Ô∏è Bootstrap<a href="https://luke.geek.nz/azure/azure-landing-zone-accelerator/#%EF%B8%8F-bootstrap" class="hash-link" aria-label="Direct link to üõ†Ô∏è Bootstrap" title="Direct link to üõ†Ô∏è Bootstrap">‚Äã</a></h3>
<p>It begins with a Bootstrap process, which is the initial setup of the Azure DevOps environment, including creating a new project, repository, and service connection. This process is automated using a mix of PowerShell and Terraform.</p>
<p><img decoding="async" loading="lazy" alt="Azure Landing Zones - Customer Journey" src="https://luke.geek.nz/assets/images/ALZAccelerator_Components-5f01c0a4e3c0ecb3238c7df560f4fd79.JPG" width="4000" height="2250" class="img_ev3q"></p>
<p>To bootstrap, we will make use of the:<a href="https://github.com/Azure/ALZ-PowerShell-Module" target="_blank" rel="noopener noreferrer">ALZ-PowerShell-Module</a>, this script will help bring together the different dependencies and Terraform bootstraping to setup our Azure DevOps environment, Terraform state storage account and bring in the necessary Platform Landing Zone library files for our deployment.</p>
<p><img decoding="async" loading="lazy" alt="Azure Landing Zones - Customer Journey" src="https://luke.geek.nz/assets/images/ALZAccelerator_CICDComponents-ea1fbf93870e1274232688bbf61c0361.JPG" width="4000" height="2250" class="img_ev3q"></p>
<p>The bootstrap for Azure DevOps includes <a href="https://learn.microsoft.com/azure/devops/pipelines/agents/agents?view=azure-devops&amp;tabs=yaml%2Cbrowser&amp;WT.mc_id=AZ-MVP-5004796#self-hosted-agents" target="_blank" rel="noopener noreferrer">self-hosted agents</a> <em>(<a href="https://learn.microsoft.com/azure/container-apps/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Container Apps</a> or <a href="https://learn.microsoft.com/azure/container-instances/container-instances-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Container Instances</a>)</em> as optional, and preconfigured pipelines, including validation and branch policies with approval steps, so a foundational platform to work towards.</p>
<table><thead><tr><th>Component</th><th>Description</th><th>Notes</th></tr></thead><tbody><tr><td><strong>Azure Resources</strong></td><td></td><td></td></tr><tr><td>Resource Group for State</td><td>Container for Terraform state storage resources</td><td>Terraform only</td></tr><tr><td>Storage Account and Container for State</td><td>Stores Terraform state files securely</td><td>Terraform only</td></tr><tr><td>Resource Group for Identity</td><td>Container for managed identity resources</td><td></td></tr><tr><td>User Assigned Managed Identities (UAMI) with Federated Credentials</td><td>Identities for secure pipeline execution</td><td>For Plan and Apply</td></tr><tr><td>Permissions for the UAMI</td><td>RBAC assignments needed for deployment</td><td>On state storage container, subscriptions, and management groups</td></tr><tr><td>[Optional] Container Registry for Azure DevOps Agent Image</td><td>Stores custom agent container images</td><td>For self-hosted agents</td></tr><tr><td>[Optional] Container Instances hosting Azure DevOps Agents</td><td>Runs pipeline jobs in your Azure environment</td><td>For self-hosted agents</td></tr><tr><td>[Optional] Virtual network, subnets, private DNS zone, and private endpoint</td><td>Network resources for private connectivity</td><td>For enhanced security</td></tr><tr><td><strong>Azure DevOps Resources</strong></td><td></td><td></td></tr><tr><td>Project (can be supplied or created)</td><td>Azure DevOps project for Landing Zone resources</td><td>Can use existing or create new</td></tr><tr><td>Repository for the Module</td><td>Stores Landing Zone Terraform code</td><td>Main implementation repository</td></tr><tr><td>Repository for the Pipeline Templates</td><td>Stores CI/CD pipeline definitions</td><td>Enables template reuse</td></tr><tr><td>Starter Terraform module with tfvars</td><td>Pre-configured Terraform configuration</td><td>Customizable baseline</td></tr><tr><td>Branch policy</td><td>Ensures code quality and reviews</td><td>Prevents direct main branch changes</td></tr><tr><td>Pipeline for Continuous Integration</td><td>Validates and plans Terraform changes</td><td>Non-destructive verification</td></tr><tr><td>Pipeline for Continuous Delivery</td><td>Implements Terraform changes in Azure</td><td>Creates/updates resources</td></tr><tr><td>Environment for Plan</td><td>Isolated context for planning stage</td><td>Separates planning permissions</td></tr><tr><td>Environment for Apply</td><td>Isolated context for apply stage</td><td>Separates deployment permissions</td></tr><tr><td>Variable Group for Backend</td><td>Stores Terraform backend configuration</td><td>Used across pipelines</td></tr><tr><td>Service Connections with Workload identity federation for Plan and Apply</td><td>Securely connects Azure DevOps to Azure</td><td>Uses OIDC for enhanced security</td></tr><tr><td>Service Connection Approvals, Template Validation, and Concurrency Control</td><td>Provides governance for deployments</td><td>Ensures controlled changes</td></tr><tr><td>Group and Members for Apply Approval</td><td>Team responsible for approving changes</td><td>Change control mechanism</td></tr><tr><td>[Optional] Agent Pool</td><td>Collection of build/release agents</td><td>For self-hosted agents</td></tr></tbody></table>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>Make sure you check out the following resources for more information on the Azure Landing Zone Accelerator and Azure Landing Zone Library, these are your sources of truth:</p><ul>
<li><a href="https://aka.ms/alz/acc" target="_blank" rel="noopener noreferrer">Azure Landing Zones Documentation</a></li>
<li><a href="https://azure.github.io/Azure-Landing-Zones-Library/" target="_blank" rel="noopener noreferrer">Azure Landing Zones Library</a></li>
</ul><p>If you have issues, you can also raise them on the <a href="https://github.com/Azure/ALZ-PowerShell-Module/issues" target="_blank" rel="noopener noreferrer">ALZ-PowerShell-Module</a> GitHub repository.</p></div></div>
<p>Before we get started, we need some pre-requisites</p>
<ul>
<li>
<p>3 Azure subscriptions <em>(1 for Connectivity, 1 for Identity, and 1 for Connectivity) - (for this demo, I will be using a single subscription)</em> we will also need the bootstrap and Terraform deployment IDs.
Permissions Required for Management Group and Subscriptions:</p>
</li>
<li>
<p>Owner on your chosen parent management group:</p>
</li>
</ul>
<p>The owner account will grant permissions to the identities running the management group deployment. Owner on each of your 3 Azure landing zone subscriptions.</p>
<ul>
<li>A PAT token for the creation of a Service Connection in Azure DevOps <em>(Agent Pools (Read &amp; manage)</em>, Build <em>(Read &amp; execute)</em>, Code <em>(Full)</em>, Environment <em>(Read &amp; manage)</em>, Graph <em>(Read &amp; manage)</em>, Pipeline Resources <em>(Use &amp; manage)</em>, Project and Team <em>(Read, write &amp; manage)</em>, Service Connections <em>(Read, query &amp; manage)</em>, and Variable Groups <em>(Read, create &amp; manage)</em>.)_  This token is only needed for the duration required to bootstrap the environment and can be revoked after.</li>
</ul>
<p>Once we have those pre-requisites, we can proceed with the bootstrapping process.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>I recommend starting with the <a href="https://azure.github.io/Azure-Landing-Zones/examples/tf/accelerator/config/checklist.xlsx" target="_blank" rel="noopener noreferrer">Azure Landing Zone Accelerator Checklist</a>, this will help you understand the requirements and dependencies for the deployment, and ensure you have everything you need before you start the process.</p><p><img decoding="async" loading="lazy" alt="Azure Landing Zones - Customer Journey" src="https://luke.geek.nz/assets/images/ALZ_Bootstrap_Checklist-3bc4ebfe88a2536512d96b086caa6b82.jpg" width="1898" height="925" class="img_ev3q"></p></div></div>
<p>We will bootstrap the environment, to create our Azure DevOps environment, and then deploy the base components for a <a href="https://learn.microsoft.com/azure/cloud-adoption-framework/ready/landing-zone/?WT.mc_id=AZ-MVP-5004796#platform-landing-zones-vs-application-landing-zones" target="_blank" rel="noopener noreferrer">Platform Landing Zone</a> and the associated <a href="https://learn.microsoft.com/azure/cloud-adoption-framework/ready/landing-zone/tailoring-alz?WT.mc_id=AZ-MVP-5004796#what-is-a-landing-zone-archetype-in-azure-landing-zones" target="_blank" rel="noopener noreferrer">archetypes</a> for the fictional company of Contoso. To do this, we will be using the Terraform - Azure Verified Modules for <a href="https://azure.github.io/Azure-Landing-Zones/accelerator/startermodules/terraform-platform-landing-zone/" target="_blank" rel="noopener noreferrer">Platform Landing Zone (ALZ) starter modules</a> and configuration in the Australia East Azure region.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Before you start, make sure you request a parallelism grant for Azure DevOps, by default, Azure DevOps has a limit of 1 concurrent job, to request a free parallelism grant, please fill out the following form <a href="https://aka.ms/azpipelines-parallelism-request" target="_blank" rel="noopener noreferrer">https://aka.ms/azpipelines-parallelism-request</a></p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-bootstrap-process">üìã Bootstrap Process<a href="https://luke.geek.nz/azure/azure-landing-zone-accelerator/#-bootstrap-process" class="hash-link" aria-label="Direct link to üìã Bootstrap Process" title="Direct link to üìã Bootstrap Process">‚Äã</a></h3>
<ol>
<li>First login to Azure 'az login' and then run the following commands:</li>
<li>Next we need the ALZ PowerShell Module, so we will install that:</li>
</ol>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Check if the ALZ module is installed</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$module</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-InstalledModule</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name ALZ </span><span class="token operator">-</span><span class="token plain">ErrorAction SilentlyContinue</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$null</span><span class="token plain"> </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$module</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># If the module is not installed, install it</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Install-Module</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name ALZ </span><span class="token operator">-</span><span class="token plain">Force</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"ALZ module installed successfully."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># If the module is installed, update it</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Update-Module</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name ALZ</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"ALZ module updated successfully."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Azure Landing Zones - Customer Journey" src="https://luke.geek.nz/assets/images/ALZ_InstallPshModule-3ff24a30b93f6bf60a46c6336ae95963.gif" width="930" height="429" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Three sets of configuration can be supplied to the accelerator to pre-configure it.</p><p>The available configuration inputs are:</p><ul>
<li><a href="https://azure.github.io/Azure-Landing-Zones/accelerator/userguide/2_start/#bootstrap-configuration-file" target="_blank" rel="noopener noreferrer">Bootstrap Configuration File</a></li>
<li><a href="https://azure.github.io/Azure-Landing-Zones/accelerator/userguide/2_start/#platform-landing-zone-configuration-file" target="_blank" rel="noopener noreferrer">Platform Landing Zone Configuration File</a></li>
<li><a href="https://azure.github.io/Azure-Landing-Zones/accelerator/userguide/2_start/#platform-landing-zone-library-lib-folder" target="_blank" rel="noopener noreferrer">Platform Landing Zone Library (lib) Folder</a></li>
</ul></div></div>
<p>We will start with th bootstrap configuration file, this will be used to create the Azure DevOps environment, and the Terraform state storage account and container, then we adjust the Platform Landing Zone configuration file to control what Azure resources we will need to deploy <em>(ie Hub and Spoke, or Virtual WAN, Bastion etc)</em> and the Platform Landing Zone library folder, which will contain the Archetype definitions and policy assignments for greater flexibility.</p>
<ol start="3">
<li>Let's create the local configuration files for the bootstrap and Platform Landing Zone deployment:</li>
</ol>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">New-Item</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ItemType </span><span class="token string" style="color:rgb(255, 121, 198)">"file"</span><span class="token plain"> c:\Code\accelerator\config\inputs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">yaml </span><span class="token operator">-</span><span class="token plain">Force</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">New-Item</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ItemType </span><span class="token string" style="color:rgb(255, 121, 198)">"file"</span><span class="token plain"> c:\Code\accelerator\config\platform-landing-zone</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">tfvars </span><span class="token operator">-</span><span class="token plain">Force  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Exclude this line if using FSI or SLZ starter modules</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">New-Item</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ItemType </span><span class="token string" style="color:rgb(255, 121, 198)">"directory"</span><span class="token plain"> c:\Code\accelerator\config\lib </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">New-Item</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ItemType </span><span class="token string" style="color:rgb(255, 121, 198)">"directory"</span><span class="token plain"> c:\Code\accelerator\output</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">--</span><span class="token operator">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">4</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain"> Now we need to open the inputs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">yaml file and add the following configuration found here: </span><span class="token namespace">[inputs-azure-devops.yaml]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">https:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token plain">raw</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">githubusercontent</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">com/Azure/alz-terraform-accelerator/refs/heads/main/templates/platform_landing_zone/examples/bootstrap/inputs-azure-devops</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">yaml</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">It should look something like below:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">```yaml</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># For detailed instructions on using this file, visit:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># https://aka.ms/alz/accelerator/docs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Basic Inputs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">iac_type: </span><span class="token string" style="color:rgb(255, 121, 198)">"terraform"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">bootstrap_module_name: </span><span class="token string" style="color:rgb(255, 121, 198)">"alz_azuredevops"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">starter_module_name: </span><span class="token string" style="color:rgb(255, 121, 198)">"platform_landing_zone"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Shared Interface Inputs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">bootstrap_location: </span><span class="token string" style="color:rgb(255, 121, 198)">"australiaeast"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">starter_locations: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">"australiaeast"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">root_parent_management_group_id: </span><span class="token string" style="color:rgb(255, 121, 198)">"Contoso"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">subscription_id_management: </span><span class="token string" style="color:rgb(255, 121, 198)">"00000000-0000-4000-8000-000000000001"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">subscription_id_identity: </span><span class="token string" style="color:rgb(255, 121, 198)">"00000000-0000-4000-8000-000000000002"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">subscription_id_connectivity: </span><span class="token string" style="color:rgb(255, 121, 198)">"00000000-0000-4000-8000-000000000003"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Bootstrap Inputs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">azure_devops_personal_access_token: </span><span class="token string" style="color:rgb(255, 121, 198)">"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># azure_devops_agents_personal_access_token: "&lt;token-2&gt;"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">azure_devops_organization_name: </span><span class="token string" style="color:rgb(255, 121, 198)">"Contoso"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use_separate_repository_for_templates: true</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">bootstrap_subscription_id: </span><span class="token string" style="color:rgb(255, 121, 198)">"00000000-0000-4000-8000-000000000004"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">service_name: </span><span class="token string" style="color:rgb(255, 121, 198)">"plz"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">environment_name: </span><span class="token string" style="color:rgb(255, 121, 198)">"mgmt"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">postfix_number: 1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">azure_devops_use_organisation_legacy_url: false</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">azure_devops_create_project: true</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">azure_devops_project_name: </span><span class="token string" style="color:rgb(255, 121, 198)">"ADO-PALZ"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use_self_hosted_agents: false</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use_private_networking: true</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">allow_storage_access_from_my_ip: false</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">apply_approvers: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">"luke@contoso.com"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">create_branch_policies: true</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Advanced Inputs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">bootstrap_module_version: </span><span class="token string" style="color:rgb(255, 121, 198)">"latest"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">starter_module_version: </span><span class="token string" style="color:rgb(255, 121, 198)">"latest"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">output_folder_path: </span><span class="token string" style="color:rgb(255, 121, 198)">"c:/Code/accelerator/output"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>For further customisation, make sure you take a look at the <a href="https://github.com/Azure/accelerator-bootstrap-modules/blob/main/alz/local/variables.tf" target="_blank" rel="noopener noreferrer">variables.tf</a> file directly in the accelerator bootstrap modules GitHub, it can show further options that you can add to the bootstrap, such as the storage account replicatin type for your Terraform state files, or additinal custom roles and resource naming.</p></div></div>
<p>Now that we have configured the variables required for our bootstrap, let us define the Terraform variables for the Platform Landing Zone deployment, this will be used to determine the Azure resources we will deploy, such as the Hub and Spoke, Virtual WAN, Bastion, etc, and this is the platform-landing-zone.tfvars file. I recommend copying one from one of the <a href="https://azure.github.io/Azure-Landing-Zones/accelerator/startermodules/terraform-platform-landing-zone/scenarios/" target="_blank" rel="noopener noreferrer">already pre-existing Scenarios</a> and modifying to suit your needs. For my purposes, I will be going with a Single region hub and spoke VNET with <a href="https://azure.github.io/Azure-Landing-Zones/accelerator/startermodules/terraform-platform-landing-zone/scenarios/single-region-hub-and-spoke-vnet-with-azure-firewall/" target="_blank" rel="noopener noreferrer">Azure Firewall</a>.</p>
<ol start="5">
<li>Open the platform-landing-zone.tfvars file and add the configuration and modify for your needs, for my purposes, I will be using the following configuration: <a href="https://raw.githubusercontent.com/Azure/alz-terraform-accelerator/refs/heads/main/templates/platform_landing_zone/examples/full-single-region/hub-and-spoke-vnet.tfvars" target="_blank" rel="noopener noreferrer">platform_landing_zone/examples/full-single-region/hub-and-spoke-vnet.tfvars</a>.</li>
</ol>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>The <code>platform-landing-zone.tfvars</code> file is a crucial configuration for deploying an Azure Landing Zone using the Azure Landing Zones Accelerator with Terraform. This file defines the variables that customize your Azure foundation by your requirements, and this file will be your main configuration file for the deployment of the Platform Landing Zone.</p><p>Key Components of the File</p><p><strong>Built-in Replacements</strong></p><p>The file uses a templating system with <code>$${variable_name}</code> syntax to reference predefined values, such as:</p><ul>
<li>Azure locations (e.g., <code>$${starter_location_01}</code>)</li>
<li>Subscription IDs (e.g., <code>$${subscription_id_management}</code>)</li>
<li>Management group IDs</li>
</ul><p>These built-in replacements help maintain consistency throughout the configuration.</p><p><strong>Custom Replacements</strong></p><p>The configuration defines custom naming patterns and references for:</p><ol>
<li>
<p><strong>Resource Names</strong> - Standardizing naming conventions for:</p>
<ul>
<li>Resource groups</li>
<li>Virtual networks</li>
<li>Azure Firewall</li>
<li>Log Analytics workspace</li>
<li>And many other resources</li>
</ul>
</li>
<li>
<p><strong>IP Address Spaces</strong> - Defining network address spaces for the hub network:</p>
<ul>
<li>Virtual network address space</li>
<li>Subnet address prefixes</li>
<li>Firewall subnet</li>
</ul>
</li>
</ol><p><strong>Management Resources</strong></p><p>This section configures core management resources including:</p><ul>
<li>Log Analytics workspace</li>
<li>Automation account</li>
<li>Azure Monitor Agent settings</li>
<li>Data Collection Rules for monitoring</li>
</ul><p><strong>Management Groups and Policy</strong></p><p>The file configures:</p><ul>
<li>Management group hierarchy structure</li>
<li>Policy assignments and overrides, for example Defender for Cloud Settings</li>
<li>Subscription placement within management groups</li>
</ul><p><strong>Connectivity Resources</strong></p><p>The hub-and-spoke network topology is defined with:</p><ul>
<li>DDoS protection plan</li>
<li>Virtual network configuration</li>
<li>Azure Firewall and routing tables</li>
<li>Virtual network gateways (ExpressRoute and VPN)</li>
<li>Private DNS zones and resolver</li>
<li>Azure Bastion</li>
</ul><p><strong>How to Modify This File</strong></p><ol>
<li>Customize Basic Information</li>
</ol><ul>
<li><strong>Email Contacts</strong>: Update security contact email addresses</li>
<li><strong>Tags</strong>: Modify organization-specific tags</li>
</ul><div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token property">tags</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">deployed_by</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"terraform"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">technical_contact</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"your-email@company.com"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">environment</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"production"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">business_unit</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"finance"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="2">
<li>Adjust Network Addressing</li>
</ol><p>Modify the IP address ranges to match your organization's network plan:</p><div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token property">primary_hub_address_space</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"10.100.0.0/16"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token property">primary_hub_virtual_network_address_space</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"10.100.0.0/22"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="3">
<li>Change Resource Naming</li>
</ol><p>Update naming conventions to align with your organization's standards:</p><div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token property">log_analytics_workspace_name</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"law-prod-eastus"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token property">automation_account_name</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"aa-prod-eastus"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="4">
<li>Modify Policy Settings</li>
</ol><p>Adjust policy enforcement levels for your compliance requirements:</p><div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token property">Enable-DDoS-VNET</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">enforcement_mode</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Default"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># or "DoNotEnforce"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="5">
<li>Add or Remove Resources</li>
</ol><p>You can customize which components are deployed by adding or removing sections:</p><ul>
<li>Remove the VPN gateway if not needed</li>
<li>Add additional hub networks for multi-region deployments</li>
<li>Modify Azure Firewall SKU based on requirements</li>
</ul><p>Also make sure you run a <code>terraform validate</code> and <code>terraform fmt</code> to validate the configuration and the Terraform formatting is correct on the file.</p><p><strong>Make sure to check out the <a href="https://azure.github.io/Azure-Landing-Zones/accelerator/startermodules/terraform-platform-landing-zone/options/" target="_blank" rel="noopener noreferrer">Options</a> page for the Terraform Platform Landing Zone, as it will give you more information on the common scenarios, such as turning off DDOS protection plans, adding additional IP ranges etc.</strong></p></div></div>
<p>And don't worry if you don't get this right the first time, you can always adjust and redeploy, this is the beauty of Infrastructure as Code. I work in an iterative approach, so it's always good to get something working, then adjust and improve, rather than trying to get it perfect the first time, and the Terraform plan and validate pipelines help with this approach.</p>
<ol start="6">
<li>We are close, the last thing we will add is a custom library folder. This isn't required for base Platform Landing Zones, however, I recommend adding it in, for additional flexibility, especially as you start to deploy more complex environments and archetypes within your organization. You can refer to the <a href="https://azure.github.io/Azure-Landing-Zones-Library/" target="_blank" rel="noopener noreferrer">Azure Landing Zones Library</a> for more information on how to create your own custom library and additional information. Still, for now we are going to copy the alz folder from the <a href="https://github.com/Azure/Azure-Landing-Zones-Library/tree/main/platform" target="_blank" rel="noopener noreferrer">Azure Landing Zones Library</a> and place it in the lib folder in our config directory.</li>
</ol>
<p>By default, the architecture that will be deployed will be <em>(you can also refer to the README file in the lib folder for more information)</em>:</p>
<!-- -->
<p>You can adujust the Management Group names and parent/child relationships by editing the <code>alz.alz_architecture_definition.json</code> file in the lib\architecture_definitions folder, and th architectype definitions allow you to configure the type of policy definitions, role assignments that are deployed to specific Management Groups with a certain archetype, for example you could have workload Landing Zones of 'Workload' archetype with specific policy definitions and role assignments, that may be different from the root or Platform groups, and Management Groups could share this same archetype, so you can have a consistent policy and role assignment across your environment.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>Not required, but make the <a href="https://github.com/Azure/alzlib" target="_blank" rel="noopener noreferrer">alzlibtool</a> tool, this is a tool that can help you create and manage your own custom library for your Azure Landing Zones, and can be used to check policy and Azure Landing Zone architecture definition structure, and document your own custom library.</p></div></div>
<ol start="7">
<li>Now that the configuration files for the bootstrap, Terraform are in place, and the architectures, it's time to start the bootstrap. Run the following command to start the bootstrap process:</li>
</ol>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>If you need to make any last-minute changes, you can manually change the Terraform code after the Terraform plan and before the application. Check your local output folder. It is not something I would rely on - ideally the platform tfvars and yaml input file should be updated, but in a pinch, you can make manual changes. I had to do this recently, when deploying a Landing Zone into New Zealand North. I had to manually update the location of the Log Analytics workspace, as it has not been supported in that <a href="https://learn.microsoft.com/azure/reliability/availability-service-by-category?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">region yet</a>. However, for Platform resources, you can also make this change once the code is in the repository.</p></div></div>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Deploy-Accelerator `</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token operator">-</span><span class="token plain">inputs </span><span class="token string" style="color:rgb(255, 121, 198)">"C:\Code\accelerator\config\inputs.yaml"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"C:\Code\accelerator\config\platform-landing-zone.tfvars"</span><span class="token plain"> `</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token operator">-</span><span class="token plain">starterAdditionalFiles </span><span class="token string" style="color:rgb(255, 121, 198)">"C:\Code\accelerator\config\lib"</span><span class="token plain"> `</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token operator">-</span><span class="token plain">output </span><span class="token string" style="color:rgb(255, 121, 198)">"C:\Code\accelerator\output"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Azure Landing Zones - Customer Journey" src="https://luke.geek.nz/assets/images/ALZ_DeployBootstrap-5dfb106817ad002e393025a0361ee285.gif" width="930" height="429" class="img_ev3q"></p>
<p>Once completed, in Azure, you should have two resource groups - one for your Managed identities that will be linked to 2 Service Connections in Azure DevOps for Plan and Apply, and one for your Terraform state file.</p>
<p><img decoding="async" loading="lazy" alt="Azure Landing Zones - Customer Journey" src="https://luke.geek.nz/assets/images/ALZ_Bootstrap_Resource_Deployed-344f57a5209701cd629dffefd37f9591.png" width="1309" height="322" class="img_ev3q"></p>
<p>In Azure DevOps, you should have a new project, repository, and service connection, with the pipelines and environments set up for the Plan and Apply stages.</p>
<p><img decoding="async" loading="lazy" alt="AzureDevOps Azure Landin Zone Code" src="https://luke.geek.nz/assets/images/ALZ_Bootstrap_ADO_Deployed-31e1b69278f5fefc436d6759e2346b1b.png" width="1772" height="1038" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>The plz acronym I am using, is meant to indicate 'Platform Landing Zone'.</p></div></div>
<p>And Pipelines preconfigured - Continuous Integration <em>(ie Terraform Validate and Plan)</em> and Continuous Delivery <em>(ie Terraform Apply)</em> with the approvers and branch policies in place.</p>
<p><img decoding="async" loading="lazy" alt="Azure DevOps Azure Landing Zone Pipelines" src="https://luke.geek.nz/assets/images/ALZ_Bootstrap_ADOPipelines-60994147431a7299f86ea62caa6ff7bc.jpg" width="1059" height="375" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>I recommend renaming the pipelines, in Azure DevOps, so they are more descriptive, ie, 'Terraform Plan' and 'Terraform Apply' - pretty simplified, but can make more sense to people consuming the pipelines.</p><p><img decoding="async" loading="lazy" alt="Azure DevOps Azure Landing Zone Pipelines" src="https://luke.geek.nz/assets/images/ALZ_DeployBootstrap_RenameADOPipelines-4b45fe67ef66557f73987b55540bc0d5.gif" width="1642" height="608" class="img_ev3q"></p></div></div>
<p>Now, let's run the Continuous Integration pipeline to see what the Terraform plan looks like.</p>
<p><img decoding="async" loading="lazy" alt="Azure DevOps Azure Landing Zone Pipelines" src="https://luke.geek.nz/assets/images/ALZ_PLZ_ValidatePlan-a9d07fe6f4bc6b0981a49a751f4959a2.gif" width="1642" height="903" class="img_ev3q"></p>
<p>As we can see, it validates and will deploy our full hub and spoke <em>(both expressroute and VPN gateways)</em> so that would need tweaking for my environment, but this is the beauty of Infrastructure as Code, you can see what is going to be deployed before it is deployed, and make the necessary adjustments, by opening up a new branch and adjusting the the platform-landing-zone.auto.tfvars, and run validate and plan on that branch until correct.</p>
<p>So, now let's deploy. Once you are happy with the plan, you can run the Continuous Delivery pipeline to deploy the Platform Landing Zone.</p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>Be aware that the initial deployment could take a while, especially if deploying all the default policies, and DNS zones. As such, the entire deployment is not shown in the GIF below, but you can see the new Platform Management Groups and core hub resources that have started to be created.</p></div></div>
<p><img decoding="async" loading="lazy" alt="Azure DevOps Azure Landing Zone Pipelines" src="https://luke.geek.nz/assets/images/ALZ_PLZ_Apply-be626e5bc0f47e188f9dde4d43e62ee1.gif" width="1642" height="903" class="img_ev3q"></p>
<p>And once completed, you should have a full Platform Landing Zone deployed, with the Management Groups, Policies, and core resources in place.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>You can rerun the Continuous Delivery pipeline, and select Destroy if you want to remove all the platform resources and start your deployment from scratch, in a production scenario, I recommend removing that, but not the additional approval step so that you can have a manual check before the Apply stage. The approval is done in Azure DevOps at the Service Connection, under Approval and Checks.</p></div></div>
<p><img decoding="async" loading="lazy" alt="Azure DevOps Azure Landing Zone Pipelines" src="https://luke.geek.nz/assets/images/ALZAccelerator_DepoloyedLandingZoneDeployment-5b907c3c806757df461abf2b4f725488.JPG" width="1200" height="417" class="img_ev3q">
<img decoding="async" loading="lazy" alt="Azure DevOps Azure Landing Zone Pipelines" src="https://luke.geek.nz/assets/images/ALZAccelerator_DepoloyedLandingZoneDeploymentResources-d373792a651514613db7d992d10d489e.JPG" width="1780" height="936" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-conclusion">‚úÖ Conclusion<a href="https://luke.geek.nz/azure/azure-landing-zone-accelerator/#-conclusion" class="hash-link" aria-label="Direct link to ‚úÖ Conclusion" title="Direct link to ‚úÖ Conclusion">‚Äã</a></h2>
<p>The <a href="https://techcommunity.microsoft.com/blog/azuretoolsblog/azure-landing-zones-accelerators-for-bicep-and-terraform-announcing-general-avai/4029866?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Landing Zone Terraform Accelerator</a> offers a robust foundation for organizations looking to implement a well-architected Azure environment.</p>
<p>Through this article, we've explored how to:</p>
<ol>
<li>Bootstrap your environment with automation using the <a href="https://github.com/Azure/ALZ-PowerShell-Module" target="_blank" rel="noopener noreferrer">ALZ PowerShell module</a></li>
<li>Configure and deploy <a href="https://learn.microsoft.com/azure/cloud-adoption-framework/ready/landing-zone/?WT.mc_id=AZ-MVP-5004796#platform-landing-zones-vs-application-landing-zones" target="_blank" rel="noopener noreferrer">Platform Landing Zone components</a> using Infrastructure as Code <em>(<a href="https://www.terraform.io/" target="_blank" rel="noopener noreferrer">Terraform</a>)</em></li>
<li>Establish governance through management groups, policies, and controlled <a href="https://learn.microsoft.com/azure/devops/pipelines/get-started/what-is-azure-pipelines?view=azure-devops&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure DevOps pipelines</a>.</li>
</ol>
<p>Next Steps After Deployment</p>
<p>Once your Platform Landing Zone is established, consider these follow-up activities:</p>
<ul>
<li>Document your environment: Create detailed documentation explaining your Landing Zone design choices and customizations _(make sure to checkout <a href="https://github.com/Azure/alzlib/tree/main" target="_blank" rel="noopener noreferrer">alzlibtool</a>)</li>
<li>Establish operational procedures: Define processes for managing the environment, including approvals and adjustments to the platform</li>
<li>Plan your Application Landing Zones: Design the specific landing zones for your workloads based on your organization's needs and investigate <a href="https://learn.microsoft.com/azure/cloud-adoption-framework/ready/landing-zone/design-area/subscription-vending?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Subscription vending</a>.</li>
</ul>
<p>Resources for Continued Learning</p>
<ul>
<li><a href="http://aka.ms/AwesomeAzureArchitecture" target="_blank" rel="noopener noreferrer">AWESOME Azure Architecture</a></li>
<li><a href="https://azure.github.io/Azure-Landing-Zones-Library/" target="_blank" rel="noopener noreferrer">Azure Landing Zones Library</a></li>
<li><a href="https://learn.microsoft.com/azure/cloud-adoption-framework/ready/landing-zone/design-areas?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure landing zone design areas and conceptual architecture</a></li>
<li><a href="https://learn.microsoft.com/azure/cloud-adoption-framework/manage/azure-management-guide/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Management Guide</a></li>
<li><a href="https://azure.github.io/Azure-Verified-Modules/" target="_blank" rel="noopener noreferrer">Azure Verified Modules</a></li>
<li><a href="https://github.com/Azure/Enterprise-Scale" target="_blank" rel="noopener noreferrer">Enterprise-scale architecture GitHub repo</a></li>
</ul>
<p>For the GitHub repos, remember to view the Issues and Pull Requests, you can learn a lot from what other people have contributed to the initiatives, and the Issues being raised.</p>
<p>Remember, the Landing Zone is not a one-time deployment but an evolving foundation that grows with your organization's cloud journey. Regular reviews and updates will ensure it continues to support your changing business needs while maintaining security and governance standards, and how the business plans on consuming this - is not to be underestimated in the design and implementation of this.</p>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Getting Started with Azure Developer CLI (azd)]]></title>
            <link>https://luke.geek.nz/azure/azure-developer-cli/</link>
            <guid>https://luke.geek.nz/azure/azure-developer-cli/</guid>
            <pubDate>Wed, 19 Feb 2025 07:27:28 GMT</pubDate>
            <description><![CDATA[Learn how to use Azure Developer CLI (azd) to accelerate your Azure application development with templates, environment management, and CI/CD integration.]]></description>
            <content:encoded><![CDATA[<p>Today, we will touch on <a href="https://learn.microsoft.com/azure/developer/azure-developer-cli/overview?tabs=windows&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Developer CLI (azd)</a>.</p>
<p>So, let us take a closer look.</p>
<p><img decoding="async" loading="lazy" alt="azd" src="https://luke.geek.nz/assets/images/AZD-38353b129a17f94caad21a24602b1a8d.jpg" width="4000" height="1134" class="img_ev3q"></p>
<!-- -->
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-introduction">üåü Introduction<a href="https://luke.geek.nz/azure/azure-developer-cli/#-introduction" class="hash-link" aria-label="Direct link to üåü Introduction" title="Direct link to üåü Introduction">‚Äã</a></h2>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>The <a href="https://learn.microsoft.com/azure/developer/azure-developer-cli/overview?tabs=windows&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Developer CLI (azd)</a> is an open-source tool that accelerates provisioning and deploying app resources on Azure. azd provides best practice, developer-friendly commands that map to key stages in your development workflow, whether you're working in the terminal, an integrated development environment (IDE), or through CI/CD (continuous integration/continuous deployment) pipelines.</p><p>azd uses <a href="https://learn.microsoft.com/azure/developer/azure-developer-cli/azd-templates?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">extensible blueprint templates</a> that include everything you need to get an application up and running on Azure. These templates include:</p><ul>
<li>Reusable infrastructure as code assets to provision cloud resources services using Bicep or Terraform.</li>
<li>Proof-of-concept or starter app code that can be customized or replaced with your own app code.</li>
<li>Configuration files are needed to deploy your app to the provisioned resources.</li>
<li>Optionally, pipeline workflow files for GitHub Actions or Azure Pipelines to enable CI/CD integrations.</li>
</ul><p>You can also <a href="https://learn.microsoft.com/azure/developer/azure-developer-cli/make-azd-compatible?pivots=azd-create&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">create your own template</a> or find one to customize and expand on from the <a href="https://learn.microsoft.com/azure/developer/azure-developer-cli/make-azd-compatible?pivots=azd-convert&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Awesome AZD</a> gallery.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-what-is-azure-developer-cli-azd">ü§î What is Azure Developer CLI (azd)?<a href="https://luke.geek.nz/azure/azure-developer-cli/#-what-is-azure-developer-cli-azd" class="hash-link" aria-label="Direct link to ü§î What is Azure Developer CLI (azd)?" title="Direct link to ü§î What is Azure Developer CLI (azd)?">‚Äã</a></h3>
<p>The <a href="https://learn.microsoft.com/azure/developer/azure-developer-cli/overview?tabs=windows&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Developer CLI (azd)</a> is a developer-centric command-line interface (CLI) tool for deploying Azure applications, and their infrastructure components.</p>
<p>The goals of the CLI are to:</p>
<ul>
<li>reduce the time required for a developer to be productive</li>
<li>demonstrate opinionated best practices for Azure development</li>
<li>help developers understand core Azure development constructs</li>
</ul>
<p>To take full advantage of the CLI, code repositories need to conform to a well defined set of conventions that will be recognized by the tooling.</p>
<p>You can find more information on the <a href="https://github.com/Azure/azure-dev" target="_blank" rel="noopener noreferrer">Azure Developer CLI (azd) GitHub repository</a>, including installation instructions for Windows, Linux amd Mac.</p>
<p>A common misconception is that the Azure Developer CLI (azd) is a replacement for the Azure CLI. This is not the case. The Azure Developer CLI (azd) is a tool that is designed to help developers deploy Azure applications, ideal for rapid innovation and learning scenarios, and supports the deployment of infrastructure and application components.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>Make sure to check out <a href="https://azure.github.io/awesome-azd/" target="_blank" rel="noopener noreferrer"><strong>awesome-azd</strong></a>, a curated list of resources for the Azure Developer CLI (azd) community.! I have found this to be a great resource for finding templates and other resources to help me get started with the Azure Developer CLI (azd), and sometimes the exact scenario that you may need. And there is an active Pull Request to update alot of these examples to use <a href="https://azure.github.io/Azure-Verified-Modules/" target="_blank" rel="noopener noreferrer">Azure Verified Modules</a>.</p><p>For more AI-orientated workloads, refer to the <a href="https://azure.github.io/ai-app-templates/" target="_blank" rel="noopener noreferrer">**ai-app-template gallery</a>. This collection of templates can be used to deploy AI workloads to Azure, such as an Azure Agents Travel Assistant, Prompty and Semantic Kernel examples.</p></div></div>
<p>It is not a general-purpose tool for managing Azure resources.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-common-use-cases">üéØ Common use cases<a href="https://luke.geek.nz/azure/azure-developer-cli/#-common-use-cases" class="hash-link" aria-label="Direct link to üéØ Common use cases" title="Direct link to üéØ Common use cases">‚Äã</a></h3>
<p>I have found the Azure Developer CLI (azd) to be particularly useful in the following scenarios:</p>
<ul>
<li><strong>Learning Azure</strong>: The Azure Developer CLI (azd) is a great tool for learning Azure, as it provides a set of opinionated best practices for Azure development. This can help you understand core Azure development constructs and get up and running quickly with Azure without having to worry about whether a solution is deployed securely or how to architect or create each resource manually. AZD allows you to easily deploy and destroy the resources you need for learning, keeping your Azure subscription clean and tidy.</li>
<li><strong>Rapid Innovation</strong>: The Azure Developer CLI (azd) is also great for rapid innovation scenarios, where you need to quickly deploy a solution to Azure to test an idea or prototype or deploy in another environment in a once-off scenario.</li>
<li><strong>CI/CD Pipelines</strong>: The Azure Developer CLI (azd) can create CI/CD pipelines for your Azure applications. This can help you automate the deployment of your applications to Azure, and ensure that your applications are deployed consistently and securely.</li>
</ul>
<blockquote>
<p>I personally would fit Azure Developer CLI into the early lifecycle of a product - it's great to get going in your iterative phases <a href="https://luke.geek.nz/misc/product-development-lifecycle/" target="_blank" rel="noopener noreferrer">PoT/PoC/MVP</a>, AZD helps bootstrap and accelerate deployments into Azure from local development environments.</p>
</blockquote>
<p>For example, here is an example <a href="https://learn.microsoft.com/azure/developer/azure-developer-cli/azd-commands?WT.mc_id=AZ-MVP-5004796#compare-azure-developer-cli-commands" target="_blank" rel="noopener noreferrer">copied from the MS Learn</a> website that showcases it nicely:</p>
<table><thead><tr><th>Tool</th><th>Sample Command</th><th>Outcome</th></tr></thead><tbody><tr><td>Azure Developer CLI</td><td><code>azd provision</code></td><td>Provisions multiple Azure resources required for an app based on project resources and configurations, such as an Azure resource group, an Azure App Service web app, and app service plan, an Azure Storage account, and an Azure Key Vault.</td></tr><tr><td>Azure CLI</td><td><code>az webapp create --resource-group myResourceGroup --plan myAppServicePlan --name myWebApp</code></td><td>Provisions a new web app in the specified resource group and app service plan.</td></tr><tr><td>Azure PowerShell</td><td><code>New-AzWebApp -ResourceGroupName "myResourceGroup" -Name "myWebApp" -AppServicePlan "myAppServicePlan"</code></td><td>Provisions a new web app in the specified resource group and app service plan.</td></tr></tbody></table>
<p>At the time of writing, AZD can be used to deploy the infrastructure components and application components for the following services:</p>
<table><thead><tr><th>Service</th><th>Status</th></tr></thead><tbody><tr><td>Azure App Service</td><td>GA</td></tr><tr><td>Azure Static Web Apps</td><td>GA</td></tr><tr><td>Azure Container Apps</td><td>Beta</td></tr><tr><td>Azure Functions</td><td>GA</td></tr><tr><td>Azure Kubernetes Service</td><td>Beta*</td></tr><tr><td>Azure Spring Apps</td><td>Beta</td></tr></tbody></table>
<p><em>*KS support limited to projects deployable via kubectl apply -f</em></p>
<p>This covers the majority of scenarios, for example, a Static WebApp Frontend, an Azure Functions API backend, or a full-blown AKS cluster with a Spring App.</p>
<table><thead><tr><th>Category</th><th>Supported Technologies</th></tr></thead><tbody><tr><td>Programming Languages</td><td>Node.js, Python, .NET, Java</td></tr><tr><td>Infrastructure as Code</td><td>Bicep, Terraform</td></tr></tbody></table>
<p>Make sure to keep an eye on <a href="https://learn.microsoft.com/azure/developer/azure-developer-cli/supported-languages-environments?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Supported languages and environments</a> and <a href="https://github.com/Azure/azure-dev" target="_blank" rel="noopener noreferrer">Azure/azure-dev</a> for the most up to date information.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-getting-started">üöÄ Getting Started<a href="https://luke.geek.nz/azure/azure-developer-cli/#-getting-started" class="hash-link" aria-label="Direct link to üöÄ Getting Started" title="Direct link to üöÄ Getting Started">‚Äã</a></h2>
<p>Let's get started with the Azure Developer CLI (azd) by installing the CLI and creating a new project.</p>
<p>You can install it using tools <a href="https://learn.microsoft.com/en-us/azure/developer/azure-developer-cli/install-azd?tabs=choco-windows%2Cbrew-mac%2Cscript-linux&amp;pivots=os-windows&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">such as winget, straight curl sh script install, or homebrew</a>.</p>
<p>For me, I favor <a href="https://github.com/features/codespaces" target="_blank" rel="noopener noreferrer">GitHub Codespaces</a>, and using a GitHub Codespace I have preconfigured with AZD allows me to get started quickly.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>You can find my IaC Coding Codespace template here: <a href="https://github.com/lukemurraynz/Codespace_IaC_Coding" target="_blank" rel="noopener noreferrer">lukemurraynz/Codespace_IaC_Coding</a>.</p></div></div>
<p>If you want to add Azure CLI support to your own devcontainer/Codespace, then in the devcontainer.json under the features section, add:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token property">"features"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// Adds Azure Developer CLI (azd) support.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"ghcr.io/azure/azure-dev/azd:latest"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You can also add the Azure Developer CLI <a href="https://marketplace.visualstudio.com/items?itemName=ms-azuretools.azure-dev" target="_blank" rel="noopener noreferrer">Visual Studio Code extension</a> by:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token property">"extensions"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">"ms-azuretools.azure-dev"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>My demo environment that I will be using for this article is run from my <a href="https://github.com/lukemurraynz/Codespace_IaC_Coding" target="_blank" rel="noopener noreferrer">lukemurraynz/Codespace_IaC_Coding</a> GitHub Codespace template. This contains AZD, Terraform, Bicep, pretty much everything I need for any Infrastructure as Code work.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-project-initialization-azd-init">üìù Project initialization (azd init)<a href="https://luke.geek.nz/azure/azure-developer-cli/#-project-initialization-azd-init" class="hash-link" aria-label="Direct link to üìù Project initialization (azd init)" title="Direct link to üìù Project initialization (azd init)">‚Äã</a></h3>
<p>To create a new project using the Azure Developer CLI <em>(azd)</em>, you can use the <code>azd init</code> command. This command will create a new project in the current directory or will prompt you to select a template to use for the project from the awesome-and templates list.</p>
<p>For our demo, we will select a template already preconfigured.</p>
<p>We will select the <a href="https://github.com/Azure-Samples/dream-team" target="_blank" rel="noopener noreferrer">dreamteam</a> <em>(Autogen application, hosted in Azure Container App, with a Streamlit front end with Azure OpenAI)</em> template. We can use the up and down arrows and type if we know what template we want to easily search.</p>
<p>This template contains <a href="https://learn.microsoft.com/azure/container-apps/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Container Apps</a>, <a href="https://learn.microsoft.com/azure/azure-monitor/app/app-insights-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Application Insights</a>, <a href="https://learn.microsoft.com/azure/key-vault/general/basic-concepts?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Key Vault</a>, <a href="https://learn.microsoft.com/azure/azure-monitor/logs/log-analytics-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Log Analytics</a>, <a href="https://learn.microsoft.com/entra/identity/managed-identities-azure-resources/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Managed identities</a> and <a href="https://learn.microsoft.com/azure/ai-services/openai/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure OpenAI service</a>.</p>
<p><img decoding="async" loading="lazy" alt="azd init" src="https://luke.geek.nz/assets/images/demo-azdinit-template-6dc54970143e75ec919d0fa7adda083e.gif" width="1903" height="966" class="img_ev3q"></p>
<p>We could have also typed <code>azd init -t dream-team</code> to select the dream-team template if we knew what it was.</p>
<ul>
<li>An infra folder was added that includes Bicep files to create Azure resources (it could easily be Terraform).</li>
<li>An azure.yaml configuration file was added to map the app code in the src directory to the provision of Azure resources.</li>
</ul>
<p><img decoding="async" loading="lazy" alt="azd init" src="https://luke.geek.nz/assets/images/AZD_Base-FilesFolders-5ec1a3d6ea6cd4199e46ffe477aa4be4.jpg" width="4000" height="2250" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-deployment-azd-up">‚¨ÜÔ∏è Deployment (azd up)<a href="https://luke.geek.nz/azure/azure-developer-cli/#%EF%B8%8F-deployment-azd-up" class="hash-link" aria-label="Direct link to ‚¨ÜÔ∏è Deployment (azd up)" title="Direct link to ‚¨ÜÔ∏è Deployment (azd up)">‚Äã</a></h3>
<p>Now that we have the AZD project initialized, we can deploy the resources to Azure using the <code>azd up</code> command.</p>
<p>But first, we need to authenticate to Azure by running <code>and auth login</code> and following the instructions to select the appropriate tenancy and subscription.</p>
<p><img decoding="async" loading="lazy" alt="azd up" src="https://luke.geek.nz/assets/images/demo-azdauth-c13fe7eee60044f54826f88c471cdbf0.gif" width="1903" height="966" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>If you have tags or compliance reasons why resources need to be named something specific, now is the time to amend the infrastructure as code, in most projects, the name is made up of a resourcetoken generated by a unique token based on the subscription ID, environment name, and location + a resource suffix, for example, if it you were deploying API Management, the name could look something like: apim-nepvrtdddlfbu, but the names can be overwritten in the Bicep files like you would any other Bicep deployment - in fact, you can adjust the IaC as best to suit your environment, ie add in Private Endpoints, or adjust the SKU of a resource.</p></div></div>
<p>Now we can run <code>azd up</code> to deploy the resources to Azure.</p>
<p><img decoding="async" loading="lazy" alt="azd up" src="https://luke.geek.nz/assets/images/demo-azddeploy-28a27b8fc780ca93bee5ece54dc5d091.gif" width="1903" height="947" class="img_ev3q"></p>
<p>And if we click on the supplied endpoint, we can access our Streamlit application that is running in Azure Container Apps.</p>
<p><img decoding="async" loading="lazy" alt="azd up" src="https://luke.geek.nz/assets/images/demo-azd-deploy-streamlit-e80ce5aaf3c9e6505211bd6a94939088.jpg" width="1904" height="852" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>You can track the deployment in the Deployment blade of the created Resource Group as well.</p></div></div>
<p>As you can see, AZD went through a build phase to package and build the docker container from the src directory before proceeding with the infrastructure deployment and application deployment <em>(this behavior can be controlled by editing the azure.yaml file, but following this pattern is the default, build project, build infrastructure, then deploy project)</em>. No point in deploying the infrastructure if the build fails, and talking about failure, you may have issues deploying or building your service and not quite know where the problem is - one of the things you can do is enable <a href="https://learn.microsoft.com/azure/developer/azure-developer-cli/troubleshoot?tabs=Browser&amp;WT.mc_id=AZ-MVP-5004796#using-the---debug-switch" target="_blank" rel="noopener noreferrer">debug</a> to have more verbose output, ie <code>azd up --debug</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-environment-management-azd-env">üåç Environment management (azd env)<a href="https://luke.geek.nz/azure/azure-developer-cli/#-environment-management-azd-env" class="hash-link" aria-label="Direct link to üåç Environment management (azd env)" title="Direct link to üåç Environment management (azd env)">‚Äã</a></h3>
<p>Now we have a fully deployed application using <code>and up</code> let's discuss environment management.</p>
<p><code>azd env</code> is a command that allows you to manage your environments. You can create, list, delete, and switch between environments using this command, so you can easily manage different environments, such as development, staging, and production, without affecting each one.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Manage your application environments. With this command group, you can create a new environment or get, set, and list your application environments.</p><p>‚Ä¢ An Application can have multiple environments (ex: dev, test, prod).
‚Ä¢ Each environment may have a different configuration (that is, connectivity information) for accessing Azure resources.
‚Ä¢ You can find all environment configurations under the <code>.azure/&lt;environment-name&gt;</code> folder.
‚Ä¢ The environment name is stored as the AZURE_ENV_NAME environment variable in the <code>.azure/&lt;environment-name&gt;/.env</code> file.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Usage</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  azd env [command]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Available Commands</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  get-value     : Get specific environment value.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  get-values    : Get all environment values.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  list          : List environments.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  new           : Create a new environment and set it as the default.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  refresh       : Refresh environment settings by using information from a previous infrastructure provision.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  select        : Set the default environment.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  set           : Manage your environment settings.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  set-secret    : Set a &lt;name&gt; as a reference to a Key Vault secret in the environment.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Global Flags</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    -C, --cwd string    : Sets the current working directory.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        --debug         : Enables debugging and diagnostics logging.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        --docs          : Opens the documentation for azd env in your web browser.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    -h, --help          : Gets help for env.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        --no-prompt     : Accepts the default value instead of prompting, or it fails if there is no default.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<p>The first thing we can do is the environment variables of our environments by running <code>azd env get-values</code>.</p>
<p>This will output the environment variables; each solution may be different, but common values are AZURE_ENV_NAME and AZURE_LOCATION.</p>
<p><img decoding="async" loading="lazy" alt="azd env get-values" src="https://luke.geek.nz/assets/images/demo-azdgetenvvalues-ebbafef556f277b4056b0951be140065.gif" width="1903" height="947" class="img_ev3q"></p>
<p>These values are also stored in the <code>.azure/&lt;environment-name&gt;/.env</code> file.</p>
<p>So we have an environment named: testdeploy, lets see if we can create a new environment, and switch to it.</p>
<p><img decoding="async" loading="lazy" alt="azd env new" src="https://luke.geek.nz/assets/images/demo-azdcreateenv-8bf0f434b75d1ffd20c64652ace59085.gif" width="1903" height="947" class="img_ev3q"></p>
<p>Now you can manage multiple environments of your application and switch between them easily, each one treated separately in terms of the values that are set, so dev could be in another region, or you could do something like this:</p>
<p><img decoding="async" loading="lazy" alt="azd env select" src="https://luke.geek.nz/assets/images/demo-azdcreateenvvalues-f1be26ba342283d4ae929e24557c802d.gif" width="1903" height="947" class="img_ev3q"></p>
<p>It's pretty basic, and the TagENV variable, you could just pull out by using the environmentName variable in Bicep <em>(take a look at the main.parameters.json)</em>, but it shows you how you can manage different environments, and the values that are set for them.</p>
<p>Multiple environments can be useful for testing, for different regions, or for different stages of the development lifecycle, particularly when looking at having multiple environments for a CI/CD pipeline, so dev, test, staging, production, and and up can be used to deploy to these environments. I have run into scenarios where I have deployed something with an old configuration that started to get used by a team while I continued to work on new configuration and settings - having multiple environments allowed me to leave the old one untouched while I worked on a new environment</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-monitoring-azd-monitor">üìä Monitoring (azd monitor)<a href="https://luke.geek.nz/azure/azure-developer-cli/#-monitoring-azd-monitor" class="hash-link" aria-label="Direct link to üìä Monitoring (azd monitor)" title="Direct link to üìä Monitoring (azd monitor)">‚Äã</a></h3>
<p>To be fair - this isn't one I've used much, but it is a useful command to know about.</p>
<p><code>azd monitor</code> is a command that allows you to monitor your application. You can view logs, metrics, and other monitoring data using this command, so you can easily monitor the health and performance of your application by utilizing <a href="https://learn.microsoft.com/en-us/azure/azure-monitor/app/overview-dashboard?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Application Insights dashboards</a>.</p>
<table><thead><tr><th>Dashboard Type</th><th>Command</th></tr></thead><tbody><tr><td>Main dashboard</td><td><code>azd monitor --overview</code></td></tr><tr><td>Live metrics</td><td><code>azd monitor --live</code></td></tr><tr><td>Logs dashboard</td><td><code>azd monitor --logs</code></td></tr></tbody></table>
<p>These commands will open the respective dashboards in your default web browser, making it easy to monitor your application's performance and health.</p>
<p>Let us take a brief look after I switched back to my testdeploy environment:</p>
<p><img decoding="async" loading="lazy" alt="azd monitor" src="https://luke.geek.nz/assets/images/demo-azdmonitor-6228fa10500517ed6579e6734f441dee.gif" width="1903" height="947" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-destroying-resources-azd-down">‚¨áÔ∏è Destroying resources (azd down)<a href="https://luke.geek.nz/azure/azure-developer-cli/#%EF%B8%8F-destroying-resources-azd-down" class="hash-link" aria-label="Direct link to ‚¨áÔ∏è Destroying resources (azd down)" title="Direct link to ‚¨áÔ∏è Destroying resources (azd down)">‚Äã</a></h3>
<p>Now that we have deployed and monitored our application, we can destroy the resources using the <code>azd down</code> command.</p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>Before using the azd down command, make sure you have backed up any data or config that you need, as this command will delete all resources deployed with AZD and anything inside of the Resource Group that was deployed by AZD initially.</p></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>A few Azure resources, such as Azure OpenAI, Azure API Management, and Key Vault, are not entirely deleted when you run <code>azd down</code>. You can delete these resources by running `azd down --purge to remove purge them from a soft-delete state altogether; you may want to do this if you are recreating the same resources with the same names consistently and don't want to have Bicep reinstate these resources for you.</p></div></div>
<p><img decoding="async" loading="lazy" alt="azd down" src="https://luke.geek.nz/assets/images/demo-azddown-2d5ebed692ae1f7bae2c2bf55538c1ef.gif" width="1903" height="947" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-cicd-integration">üîÑ CI/CD Integration<a href="https://luke.geek.nz/azure/azure-developer-cli/#-cicd-integration" class="hash-link" aria-label="Direct link to üîÑ CI/CD Integration" title="Direct link to üîÑ CI/CD Integration">‚Äã</a></h2>
<p>Now, you might have a scenario where you want to integrate the Azure Developer CLI <em>(azd)</em> into your CI/CD pipeline so you can automate the deployment of your applications to Azure, especially in a team or collaborative environment.</p>
<p>And its doable, there are a few ways to do this, and I will cover the out of the box one first, this will work for both Azure DevOps pipelines or GitHub Actions.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Manage integrating your application with deployment pipelines. (Beta)</p><p>‚Ä¢ azd commands (e.g., provision, deploy) can be used within GitHub Actions and Azure Pipelines to test your code against real Azure resources and facilitate deployments.
‚Ä¢ After creating a pipeline definition file, running pipeline config will help configure your deployment pipeline to connect securely to Azure.
‚Ä¢ For more information on how to use azd in your pipeline, go to: <a href="https://aka.ms/azure-dev/pipeline" target="_blank" rel="noopener noreferrer">https://aka.ms/azure-dev/pipeline</a>.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Usage</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  azd pipeline [command]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Available Commands</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  config        : Configure your deployment pipeline to connect securely to Azure. (Beta)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Global Flags</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    -C, --cwd string    : Sets the current working directory.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        --debug         : Enables debugging and diagnostics logging.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        --docs          : Opens the documentation for azd pipeline in your web browser.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    -h, --help          : Gets help for pipeline.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        --no-prompt     : Accepts the default value instead of prompting, or it fails if there is no default.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Use azd pipeline [command] --help to view examples and more information about a specific command.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Examples</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  Walk through the steps required to set up your deployment pipeline.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    azd pipeline config</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<p><img decoding="async" loading="lazy" alt="azd pipeline config" src="https://luke.geek.nz/assets/images/demo-pipelineconfig-01e5bbfda3147d3ab18b84b4fed589b7.gif" width="1903" height="947" class="img_ev3q"></p>
<p>Forgive the stop; my pre-commit file prevented it from actually committing the code, but hopefully, it was enough to show you how to configure the pipeline and link it directly into GitHub with Azure Developer CLI doing a lot of the heavy lifting for you.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>When working with multiple environments, it requires some tweaking to the GitHub Actions.</p><p>I am not going to re-invent the wheel here; there is some great documentation by <a href="https://www.linkedin.com/in/jasontaylordev/" target="_blank" rel="noopener noreferrer">Jason Taylor</a>, Microsoft Azure MVP from Australia, that I have personally used to deploy to multiple environments, and it is a great resource to get started with: <a href="https://github.com/jasontaylordev/todo-aspnetcore-csharp-sqlite/blob/main/OPTIONAL_FEATURES.md" target="_blank" rel="noopener noreferrer">Support multiple environments</a>. Jason also recently did a video to the Microsoft Azure Cloud Commanders Learning Room: <a href="https://youtu.be/e6K2EuVfgWE" target="_blank" rel="noopener noreferrer">Speedrunning Code to Cloud with the Azure Developer CLI (azd) with Jason Taylor</a>.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-tips-and-tricks">üí° Tips and Tricks<a href="https://luke.geek.nz/azure/azure-developer-cli/#-tips-and-tricks" class="hash-link" aria-label="Direct link to üí° Tips and Tricks" title="Direct link to üí° Tips and Tricks">‚Äã</a></h2>
<p>Just finishing off with some tips and tricks:</p>
<ul>
<li>Make use of the <a href="https://learn.microsoft.com/azure/developer/azure-developer-cli/azd-extensibility?WT.mc_id=AZ-MVP-5004796#available-hooks" target="_blank" rel="noopener noreferrer">azuredeveloper cli hooks</a>, to run scripts and custom actions on post, predeploy. Refer to my article <a href="https://luke.geek.nz/azure/staticwebapp-azd-environment-variables/" target="_blank" rel="noopener noreferrer">Managing Environment Variables in Azure Static Web Apps with Azure Developer CLI</a> for some guidance on how I have used this.</li>
<li>Use Templates, as mentioned earlier, the <a href="https://azure.github.io/awesome-azd/" target="_blank" rel="noopener noreferrer">Awesome AZD</a> gallery is a great resource to find templates to get you started and AI orientated workloads, you can also refer to the <a href="https://azure.github.io/ai-app-templates/" target="_blank" rel="noopener noreferrer">ai-app-template gallery</a>.</li>
<li>There is a issue and PR being worked on, to update alot of the templates with <a href="https://azure.github.io/Azure-Verified-Modules/" target="_blank" rel="noopener noreferrer">AVM <em>(Azure Verified Module)</em></a> templates, but it hasn't been completed yet, so feel free to replace or add in your own modules and create your own AZD template! Start from your application code and build it out from there by testing the deployment with AZD to an Azure Function or Container App.</li>
<li>Keep an eye on the Pull Requests and <a href="https://github.com/Azure/azure-dev/" target="_blank" rel="noopener noreferrer">GitHub repo</a> for the latest updates and changes, and join in on the latest <a href="https://github.com/Azure/azure-dev/discussions" target="_blank" rel="noopener noreferrer">discussions and community calls</a>.</li>
</ul>
<p>Hopefully, this has given you enough of a view of some of the great functionality of Azure Developer CLI (azd) and how you can use it to deploy your applications to Azure and innovate and learn quickly.</p>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[How Microsoft Releases Changes to Azure - Safe Deployment]]></title>
            <link>https://luke.geek.nz/azure/azure-platform-release-process/</link>
            <guid>https://luke.geek.nz/azure/azure-platform-release-process/</guid>
            <pubDate>Tue, 28 Jan 2025 06:32:57 GMT</pubDate>
            <description><![CDATA[Learn how Microsoft implements changes daily across Azure using safe deployment practices, quality gates, and automated processes.]]></description>
            <content:encoded><![CDATA[<p>Today, we will touch on how Microsoft releases changes globally across the Microsoft Azure ecosystem. It always amazes me how Microsoft can release changes daily across Azure without customers noticing <em>(the majority of the time)</em>, yet they benefit from new capabilities swiftly.</p>
<p>Microsoft has implemented several quality stages for Azure, and they are continuously enhancing platform automation and processes to ensure Azure service changes have zero impact on customer workloads. Let's take a look at how Microsoft is achieving this.</p>
<blockquote>
<p>Would you like to know how Azure releases changes to Production while maintaining high Quality and Agility? Azure implements hundreds of changes daily without customers noticing, yet they benefit from new capabilities swiftly. You can learn about the quality stages for Azure and how they are learning to help ensure Microsoft continuously enhances platform automation and processes to ensure Azure service changes have zero impact on customer workloads.</p>
</blockquote>
<!-- -->
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-azure-well-architected-framework-integration">üéØ Azure Well-Architected Framework Integration<a href="https://luke.geek.nz/azure/azure-platform-release-process/#-azure-well-architected-framework-integration" class="hash-link" aria-label="Direct link to üéØ Azure Well-Architected Framework Integration" title="Direct link to üéØ Azure Well-Architected Framework Integration">‚Äã</a></h2>
<p>The Well-Architected Framework has an entire pillar dedicated to <a href="https://learn.microsoft.com/azure/well-architected/reliability/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Reliability</a> and <a href="https://learn.microsoft.com/azure/well-architected/operational-excellence/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Operational excellence</a>, so let us take a look at how these pillars are adapted to work with the deployment of core Azure platform and service deployments, along with elements of <a href="https://learn.microsoft.com/devops/operate/safe-deployment-practices?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">safe deployment practices</a> that are used to deploy Azure services/payloads at a global scale.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-azure-investment-pillars">üèóÔ∏è Azure Investment Pillars<a href="https://luke.geek.nz/azure/azure-platform-release-process/#%EF%B8%8F-azure-investment-pillars" class="hash-link" aria-label="Direct link to üèóÔ∏è Azure Investment Pillars" title="Direct link to üèóÔ∏è Azure Investment Pillars">‚Äã</a></h2>
<p><img decoding="async" loading="lazy" alt="Azure Investments" src="https://luke.geek.nz/assets/images/Azure_SDPInvestment-952dcf94477a589a4bb62026a985d887.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Let's take a look at the aspiration that Microsoft has with the Azure ecosystem and how they are working to ensure that they can deliver changes to the platform without impacting customers, with the aspiration of '0 changes impact production, and they cause 0 outages' as a north star.</p>
<p>To get there, Microsoft is working on a number of key areas, including the following investment pillars:</p>
<ul>
<li>Secure platform</li>
<li>Service health</li>
<li>Change management</li>
<li>Incident management</li>
<li>Supportability</li>
<li>Customer resiliency</li>
<li>Platform resiliency</li>
<li>Capacity management</li>
</ul>
<p><img decoding="async" loading="lazy" alt="Azure Investments" src="https://luke.geek.nz/assets/images/Azure_SDPQualitryPillars-814a549cc6da3a93412115f96488d7ba.PNG" width="4000" height="2250" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-safe-deployment-practices">üõ°Ô∏è Safe Deployment Practices<a href="https://luke.geek.nz/azure/azure-platform-release-process/#%EF%B8%8F-safe-deployment-practices" class="hash-link" aria-label="Direct link to üõ°Ô∏è Safe Deployment Practices" title="Direct link to üõ°Ô∏è Safe Deployment Practices">‚Äã</a></h2>
<p>Lets take a look at how the <a href="https://learn.microsoft.com/devops/operate/safe-deployment-practices?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">safe deployment practices</a> work in the context of the Azure platform, and how they are used to ensure that changes are deployed safely and securely, with 3 key areas of focus:</p>
<ul>
<li>Prevention</li>
<li>Protection</li>
<li>Learn and refine</li>
</ul>
<p><img decoding="async" loading="lazy" alt="Azure Investments" src="https://luke.geek.nz/assets/images/Azure_SDP-64627798b54725fb6834f269919f44da.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Prevention is about:</p>
<ul>
<li>Testing in Production in isolation, with continuous representative workloads and scenarios.&nbsp;</li>
<li>Having Additional Health gates, pre-deployment reviews, and a Bill of Quality.</li>
<li>Utilising Canary regions for at-scale pre-prod full E2E validations.</li>
<li>Having increased scenario coverage through health integrated synthetics and representative workloads.</li>
</ul>
<p>Protection is about:</p>
<ul>
<li>Progressive deployments orchestrated by standard tools with adaptable policies and multilayer gating.</li>
<li>Speed of deployment gated (speed, stops) by risk and health signals.</li>
<li>Multilayer health monitoring integrated for real-time stops and rollbacks.</li>
<li>Central correlation and analysis of aggregated health signals.</li>
<li>Short- and long-range anomaly detection that leverages ML models.</li>
<li>Real-time impact monitoring.</li>
</ul>
<p>Learn and refine is about:</p>
<ul>
<li>Continuous refinement and additions of <a href="https://learn.microsoft.com/azure/well-architected/design-guides/health-modeling?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">health signals/SLIs/SLOs</a>.</li>
<li>Learnings from the smallest outages drive repairs towards minimizing the time for self-detection in pre-prod.</li>
<li>Enrichment of synthetics shared tests. Injection of gating signals from synthetics and customers.</li>
<li>Ongoing ML refinements with increased cross-service signals.</li>
</ul>
<p>These areas of focus help to define rollout systems and processes that are used to ensure that changes are deployed safely and securely, with the ability to roll back changes if they are not successful, emphasizing quality and ready-to-deploy validation steps.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-quality-gates-and-release-process">üéØ Quality Gates and Release Process<a href="https://luke.geek.nz/azure/azure-platform-release-process/#-quality-gates-and-release-process" class="hash-link" aria-label="Direct link to üéØ Quality Gates and Release Process" title="Direct link to üéØ Quality Gates and Release Process">‚Äã</a></h2>
<p><img decoding="async" loading="lazy" alt="Azure Release quality gates" src="https://luke.geek.nz/assets/images/Azure_SDPQualityGates-634e3f439e553e996779cee8c43757a6.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Once the quality gates and processes, the rollout of the payload occurs across Canary <em>(no Production workloads)</em>, Pilot regions, Medium and large before being deployed further to the rest of the areas, with 24-hour 'bake time' before each deployment, with the ability to rollback changes if they are not successful, and the processes and quality gates are started again.</p>
<p><img decoding="async" loading="lazy" alt="Azure Release stages" src="https://luke.geek.nz/assets/images/Azure_SDPQualityGatesRelease-5478538a6300f62e47b6f5ce628b100e.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="Azure Release triggers" src="https://luke.geek.nz/assets/images/AzureSDP_Triggers-7913446967d75c1fbbbefaea2e043606.png" width="1504" height="1627" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-references">üìö References<a href="https://luke.geek.nz/azure/azure-platform-release-process/#-references" class="hash-link" aria-label="Direct link to üìö References" title="Direct link to üìö References">‚Äã</a></h2>
<ul>
<li><a href="https://devblogs.microsoft.com/devops/configuring-your-release-pipelines-for-safe-deployments/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Configuring your release pipelines for safe deployments</a></li>
<li><a href="https://ignite.microsoft.com/en-US/sessions/BRK243" target="_blank" rel="noopener noreferrer">How Microsoft Azure ensures high-Quality releases with Agility</a></li>
<li><a href="https://learn.microsoft.com/azure/architecture/reference-architectures/containers/aks-mission-critical/mission-critical-deploy-test?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Deployment and testing for mission-critical workloads on Azure</a></li>
<li><a href="https://azure.microsoft.com/blog/advancing-safe-deployment-practices/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Advancing safe deployment practices</a></li>
</ul>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Managing Environment Variables in Azure Static Web Apps with Azure Developer CLI]]></title>
            <link>https://luke.geek.nz/azure/staticwebapp-azd-environment-variables/</link>
            <guid>https://luke.geek.nz/azure/staticwebapp-azd-environment-variables/</guid>
            <pubDate>Wed, 22 Jan 2025 05:02:57 GMT</pubDate>
            <description><![CDATA[Managing Environment Variables in Azure Static Web Apps with Azure Developer CLI]]></description>
            <content:encoded><![CDATA[<p>The <a href="https://learn.microsoft.com/azure/developer/azure-developer-cli/overview?tabs=windows&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Developer CLI (azd)</a> is an open-source tool that accelerates provisioning and deploying app resources on Azure, it is great for deploying resources quickly and easily - especially in a proof of concept, or rapid innovation scenario.</p>
<p>One of the resources you can deploy <em>(both Infrastructure and Application)</em> is a <a href="https://learn.microsoft.com/azure/static-web-apps/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Static Web App</a> recently, I ran into an issue where I was deploying a backend <a href="https://learn.microsoft.com/azure/azure-functions/functions-overview?pivots=programming-language-python&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Function</a>, and I needed a react web application front end hosted on the Azure Static WebApp to pull the function app URL and function key from the runtime environment variables, and quickly realized that React does not support runtime environment variables - only build-time environment variables.</p>
<!-- -->
<p>It makes a bit of sense when you step back - React is a front-end framework, and the environment variables are injected at build time, so the front end can be built with the correct values, especially for a static web app - that isn't dynamically generated at runtime.</p>
<blockquote>
<p><a href="https://create-react-app.dev/docs/adding-custom-environment-variables/" target="_blank" rel="noopener noreferrer">Adding Custom Environment Variables</a>. The environment variables are embedded during the build time. Since Create React App produces a static HTML/CSS/JS bundle, it can‚Äôt possibly read them at runtime. To read them at runtime, you would need to load HTML into memory on the server and replace placeholders in runtime, as <a href="https://create-react-app.dev/docs/title-and-meta-tags#injecting-data-from-the-server-into-the-page" target="_blank" rel="noopener noreferrer">described here</a>. Alternatively you can rebuild the app on the server anytime you change them.</p>
</blockquote>
<p>So, if that is the case, how can I get the Azure Function URL and Function Key into the React front end? When the name of the function app, and the Static WebApp are dynamically created each time I deploy?</p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>The method below leaves the endpoint and key in the source code, which is not recommended for production applications. Please look at other forms of authentication to a backend API service, such as the built-in <a href="https://learn.microsoft.com/azure/static-web-apps/apis-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Static API support</a>.</p></div></div>
<p>To get around the limitation of the dynamic variables, I made use of the <a href="https://learn.microsoft.com/azure/developer/azure-developer-cli/overview?tabs=windows&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Developer CLI (azd)</a> postdeploy feature, which allows you to run a script after a deployment has completed.</p>
<p>My setup looks like this:</p>
<!-- -->
<p>Essentially, once the API <em>(Python)</em> has been deployed, Azure Developer CLI will run an update_env.sh script, which will update the React <code>.env.production</code> file with the correct values for the Azure Function URL and Function Key.</p>
<p>So my azure.yaml file looks like this:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token key atrule">services</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">api</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">project</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ./src/api</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">language</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> python</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">host</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> function</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">hooks</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">postdeploy</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">posix</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">shell</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> sh</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">run</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ../../hooks/update_env.sh</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">interactive</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">continueOnError</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">false</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>And inside my update_env.sh script, I have the following:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token shebang important">#!/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">set</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-e</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Fetch the Function App name and Resource Group from azd environment</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">AZD_VALUES</span><span class="token operator">=</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">azd </span><span class="token variable function" style="color:rgb(80, 250, 123);font-style:italic">env</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> get-values </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--output</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> json</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"AZD_VALUES: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$AZD_VALUES</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">FUNCTION_APP_NAME</span><span class="token operator">=</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token variable builtin class-name" style="color:rgb(189, 147, 249);font-style:italic">echo</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> $AZD_VALUES </span><span class="token variable operator" style="color:rgb(189, 147, 249);font-style:italic">|</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> jq </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-r</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">'.AZURE_FUNCTION_NAME'</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">RESOURCE_GROUP</span><span class="token operator">=</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token variable builtin class-name" style="color:rgb(189, 147, 249);font-style:italic">echo</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> $AZD_VALUES </span><span class="token variable operator" style="color:rgb(189, 147, 249);font-style:italic">|</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> jq </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-r</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">'.AZURE_RESOURCE_GROUP'</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">FUNCTION_APP_URL</span><span class="token operator">=</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token variable builtin class-name" style="color:rgb(189, 147, 249);font-style:italic">echo</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> $AZD_VALUES </span><span class="token variable operator" style="color:rgb(189, 147, 249);font-style:italic">|</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> jq </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-r</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">'.AZURE_FUNCTION_URI'</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Function App Name: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$FUNCTION_APP_NAME</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Resource Group: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$RESOURCE_GROUP</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Get the Function App URL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Function App URL: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$FUNCTION_APP_URL</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Get the Function App key</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">FUNCTION_APP_KEY</span><span class="token operator">=</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">az functionapp keys list </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--name</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> $FUNCTION_APP_NAME --resource-group $RESOURCE_GROUP </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--query</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> functionKeys.default </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-o</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> tsv</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Function App Key: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$FUNCTION_APP_KEY</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Update the .env.production file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">sed</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-i</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"s|^REACT_APP_API_URL=.*|REACT_APP_API_URL=</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$FUNCTION_APP_URL</span><span class="token string" style="color:rgb(255, 121, 198)">/api|"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">/web/.env.production</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Function App Name: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$FUNCTION_APP_NAME</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Resource Group: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$RESOURCE_GROUP</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Function App URL: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$FUNCTION_APP_URL</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>To utilize the script, I need to make sure I am authenticated to Azure <em>(az login)</em> and the script runs as part of my deployment.</p>
<p>I also made sure I was outputting the Resource Group, FunctionApp name etc as part of my main.bicep file, so it was able to be picked up by the Azure Developer CLI variables.</p>
<p>Then, after the script ran and the <code>.env.production</code> file updated, Azure Developer CLI was able to continue on to the second part of my deployment - building the React website and then deploying it to the Azure Static WebApp.</p>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[PowerShell based Terraform Bootstrap Script]]></title>
            <link>https://luke.geek.nz/azure/powershell-terraform-bootstrap/</link>
            <guid>https://luke.geek.nz/azure/powershell-terraform-bootstrap/</guid>
            <pubDate>Mon, 13 Jan 2025 07:44:51 GMT</pubDate>
            <description><![CDATA[Create a PowerShell script to bootstrap Terraform, handle installation, create project directories, and automate deployments across Windows, Mac, and Linux.]]></description>
            <content:encoded><![CDATA[<p>Today, we will implement a Terraform bootstrap script that will install Terraform and create directories where we can place our Terraform project, which will then run a plan against and deploy. This script will be written in PowerShell to bootstrap a new Terraform project.</p>
<blockquote>
<p>"Bootstrapping usually refers to a self-starting process that is supposed to continue or grow without external input. Many analytical techniques are often called bootstrap methods in reference to their self-starting or self-supporting implementation" ~ Wikipedia.</p>
</blockquote>
<!-- -->
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-script-overview">üìú Script Overview<a href="https://luke.geek.nz/azure/powershell-terraform-bootstrap/#-script-overview" class="hash-link" aria-label="Direct link to üìú Script Overview" title="Direct link to üìú Script Overview">‚Äã</a></h2>
<p>Inspired by the <a href="https://github.com/Azure/ALZ-PowerShell-Module" target="_blank" rel="noopener noreferrer">ALZ Accelerator</a> bootstrap script, this script will:</p>
<ol>
<li>Install-Terraform</li>
</ol>
<ul>
<li>Downloads and installs Terraform if not present</li>
<li>Handles version management</li>
<li>Supports Windows/Mac/Linux detection</li>
<li>Adds Terraform to PATH</li>
</ul>
<ol start="2">
<li>Creates required directories (config and output)</li>
</ol>
<ul>
<li>Copies *.tf and *.tfvars files from config to output</li>
<li>Validate file contents and paths</li>
</ul>
<ol start="3">
<li>Invoke-Terraform</li>
</ol>
<ul>
<li>Initializes Terraform</li>
<li>Creates execution plan</li>
<li>Handles apply/destroy with optional auto-approve</li>
<li>Manages working directory context</li>
</ul>
<p>And I've tested it on my Windows 11 machine and a Linux Codespace. In my examples, I am using it to run some base Terraform to deploy a new Resource Group and Storage Account in the New Zealand North Azure region.</p>
<p><img decoding="async" loading="lazy" alt="Run Terraform Bootstrap" src="https://luke.geek.nz/assets/images/RunTerraformBootstrap-57814cc7df3c255170503607d3efea0f.gif" width="1276" height="1014" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>You could also look at turning it into an executable using something like <a href="https://github.com/MScholtes/PS2EXE" target="_blank" rel="noopener noreferrer">PS2EXE</a>, and then you can run it like any other executable, as below:</p><p><img decoding="async" loading="lazy" alt="Run Terraform Bootstrap Executable" src="https://luke.geek.nz/assets/images/TerraformBootstrapExecutable-118418eb84a2c4e5b59ac51750d41789.gif" width="1354" height="749" class="img_ev3q"></p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-prerequisites">üìã Prerequisites<a href="https://luke.geek.nz/azure/powershell-terraform-bootstrap/#-prerequisites" class="hash-link" aria-label="Direct link to üìã Prerequisites" title="Direct link to üìã Prerequisites">‚Äã</a></h2>
<ul>
<li><a href="https://learn.microsoft.com/powershell/scripting/install/installing-powershell?view=powershell-7.4&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">PowerShell</a> 5.1 or PowerShell Core 6.0+</li>
<li>Internet connectivity for downloading <a href="https://www.terraform.io/" target="_blank" rel="noopener noreferrer">Terraform</a></li>
<li><a href="https://learn.microsoft.com/cli/azure/install-azure-cli?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure CLI</a> is installed and logged in (<code>az login</code>). It is only required if deploying to <a href="https://learn.microsoft.com/azure/developer/terraform/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Microsoft Azure</a>.</li>
<li>Write permissions to the directory where you'll run the script</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-usage-examples">üéØ Usage Examples<a href="https://luke.geek.nz/azure/powershell-terraform-bootstrap/#-usage-examples" class="hash-link" aria-label="Direct link to üéØ Usage Examples" title="Direct link to üéØ Usage Examples">‚Äã</a></h2>
<p>Basic usage with default parameters:</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">\Terraform-Bootstrap</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ps1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Custom paths and auto-approved apply:</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">\Terraform-Bootstrap</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ps1 </span><span class="token operator">-</span><span class="token plain">terraformPath </span><span class="token string" style="color:rgb(255, 121, 198)">"C:\terraform"</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">configPath </span><span class="token string" style="color:rgb(255, 121, 198)">"C:\tf-configs"</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">outputPath </span><span class="token string" style="color:rgb(255, 121, 198)">"C:\tf-output"</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">autoApprove</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Using a specific Terraform version:</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">\Terraform-Bootstrap</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ps1 </span><span class="token operator">-</span><span class="token plain">terraformPath </span><span class="token string" style="color:rgb(255, 121, 198)">"C:\terraform"</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">configPath </span><span class="token string" style="color:rgb(255, 121, 198)">"C:\tf-configs"</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">outputPath </span><span class="token string" style="color:rgb(255, 121, 198)">"C:\tf-output"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-powershell-script">üíª PowerShell Script<a href="https://luke.geek.nz/azure/powershell-terraform-bootstrap/#-powershell-script" class="hash-link" aria-label="Direct link to üíª PowerShell Script" title="Direct link to üíª PowerShell Script">‚Äã</a></h2>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">Terraform-Bootstrap.ps1</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">&lt;#</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    .SYNOPSIS</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    Bootstraps Terraform environment and runs specified Terraform commands.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    .DESCRIPTION</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    This script ensures Terraform is installed, sets up the Terraform workspace, and runs specified Terraform commands.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    It supports downloading the latest version of Terraform, creating necessary directories, and copying configuration files.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    The script is intended to be used to bootstrap Terraform environments for testing and development purposes and once-off deployments of any code in the Config directory.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    .NOTES</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    Version:        1.0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    Author:         luke.geek.nz</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    Creation Date:  10/01/25</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    Purpose/Change: </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    14/05/17 - Initial script creation</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    .PARAMETER terraformPath</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    The path where Terraform will be installed.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    .PARAMETER terraformVersion</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    The version of Terraform to install. Defaults to "latest".</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    .PARAMETER configPath</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    The path to the directory containing Terraform configuration files.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    .PARAMETER outputPath</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    The path to the directory where Terraform will be executed.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    .PARAMETER autoApprove</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    Automatically approve Terraform apply and destroy actions.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    .EXAMPLE</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    .\Terraform-Bootstrap.ps1 -terraformPath ".\terraform" -terraformVersion "latest" -configPath ".\config" -outputPath ".\output"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">#&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token namespace">[CmdletBinding()]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token namespace">[Parameter(Mandatory = $false)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token namespace">[string]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$terraformPath</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">".\terraform"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token namespace">[Parameter(Mandatory = $false)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token namespace">[string]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$terraformVersion</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"latest"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token namespace">[Parameter(Mandatory = $false)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token namespace">[string]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$configPath</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">".\config"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token namespace">[Parameter(Mandatory = $false)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token namespace">[string]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$outputPath</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">".\output"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token namespace">[Parameter(Mandatory = $false)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token namespace">[switch]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$autoApprove</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Function to ensure Terraform is installed</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Install-Terraform</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[string]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$version</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[string]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$path</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Get latest version if not specified</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$version</span><span class="token plain"> </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"latest"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$versionResponse</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Invoke-WebRequest</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Uri </span><span class="token string" style="color:rgb(255, 121, 198)">"https://checkpoint-api.hashicorp.com/v1/check/terraform"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$version</span><span class="token plain"> = </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$versionResponse</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Content </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">ConvertFrom-Json</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Select-Object</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ExpandProperty current_version</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Check if Terraform is already installed</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$tfCommand</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-Command</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name terraform </span><span class="token operator">-</span><span class="token plain">ErrorAction SilentlyContinue</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$tfCommand</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Verbose</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Terraform already installed at </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$tfCommand</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Path</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Create tools directory</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">!</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token function" style="color:rgb(80, 250, 123)">Test-Path</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$path</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">New-Item</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ItemType Directory </span><span class="token operator">-</span><span class="token plain">Path </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$path</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Out-Null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Download and extract Terraform</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$os</span><span class="token plain"> = </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$IsWindows</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"windows"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$IsMacOS</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"darwin"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"linux"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$arch</span><span class="token plain"> = </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token namespace">[System.Environment]</span><span class="token plain">::Is64BitOperatingSystem</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"amd64"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"386"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$url</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"https://releases.hashicorp.com/terraform/</span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$version</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">/terraform_</span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$version</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">_${os}_${arch}.zip"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$zipFile</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Join-Path</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$path</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"terraform.zip"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$extractPath</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Join-Path</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$path</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"terraform_</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$version</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Verbose</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Downloading Terraform from </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$url</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Invoke-WebRequest</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Uri </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$url</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">OutFile </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$zipFile</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Verbose</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Extracting Terraform to </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$extractPath</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Expand-Archive</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Path </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$zipFile</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">DestinationPath </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$extractPath</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Force</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Remove-Item</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$zipFile</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Add to PATH</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$env</span><span class="token plain">:PATH = </span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$extractPath</span><span class="token string" style="color:rgb(255, 121, 198)">;</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$env</span><span class="token string" style="color:rgb(255, 121, 198)">:PATH"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Function to run Terraform commands</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Invoke-Terraform</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[string]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$workingDirectory</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[string]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$command</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[switch]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$autoApprove</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Push-Location</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$workingDirectory</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">try</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Initialize</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Initializing Terraform..."</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ForegroundColor Green</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        terraform init</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Run specified command</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Running terraform </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$command</span><span class="token string" style="color:rgb(255, 121, 198)">..."</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ForegroundColor Green</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$command</span><span class="token plain"> </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"apply"</span><span class="token plain"> </span><span class="token operator">-or</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$command</span><span class="token plain"> </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"destroy"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            terraform plan </span><span class="token operator">-</span><span class="token plain">out=tfplan</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">!</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$autoApprove</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$confirmation</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Read-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Do you want to proceed with terraform </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$command</span><span class="token string" style="color:rgb(255, 121, 198)">? (y/n)"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$confirmation</span><span class="token plain"> </span><span class="token operator">-ne</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'y'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Operation cancelled"</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ForegroundColor Yellow</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$command</span><span class="token plain"> </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"apply"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                terraform apply </span><span class="token operator">-</span><span class="token plain">auto-approve tfplan</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                terraform destroy </span><span class="token operator">-</span><span class="token plain">auto-approve</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            terraform </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$command</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">finally</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Pop-Location</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Main script</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">try</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Create required directories</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">!</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token function" style="color:rgb(80, 250, 123)">Test-Path</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$configPath</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">New-Item</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ItemType Directory </span><span class="token operator">-</span><span class="token plain">Path </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$configPath</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Force </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Out-Null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Config directory created at </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$configPath</span><span class="token string" style="color:rgb(255, 121, 198)">. Please place Terraform files into this directory and press any key to continue..."</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ForegroundColor Yellow</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Read-Host</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">!</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token function" style="color:rgb(80, 250, 123)">Test-Path</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$outputPath</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">New-Item</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ItemType Directory </span><span class="token operator">-</span><span class="token plain">Path </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$outputPath</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Force </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Out-Null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Install Terraform</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Ensuring Terraform is installed..."</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ForegroundColor Green</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Install-Terraform</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">version </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$terraformVersion</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">path </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$terraformPath</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Copy Terraform files from config to output directory</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Setting up Terraform workspace..."</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ForegroundColor Green</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Convert to absolute paths</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$configPathFull</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Resolve-Path</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$configPath</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ErrorAction Stop</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$outputPathFull</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Resolve-Path</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$outputPath</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ErrorAction Stop</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Verbose</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Config Path: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$configPathFull</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Verbose</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Output Path: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$outputPathFull</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$configFiles</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-ChildItem</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Path </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$configPathFull</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Recurse </span><span class="token operator">-</span><span class="token plain">File </span><span class="token operator">-</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">Filter</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"*.tf"</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ErrorAction Stop</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$varFiles</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-ChildItem</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Path </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$configPathFull</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Recurse </span><span class="token operator">-</span><span class="token plain">File </span><span class="token operator">-</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">Filter</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"*.tfvars"</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ErrorAction Stop</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Verbose</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Found </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$configFiles</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Count</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)"> .tf files"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">foreach</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$file</span><span class="token plain"> in </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$configFiles</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Verbose</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Processing file: </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$file</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">FullName</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Verify source file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">!</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token function" style="color:rgb(80, 250, 123)">Test-Path</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$file</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">FullName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Error</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Source file not found: </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$file</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">FullName</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">continue</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Check file content</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$content</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-Content</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$file</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">FullName </span><span class="token operator">-</span><span class="token plain">Raw</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token namespace">[string]</span><span class="token plain">::IsNullOrWhiteSpace</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$content</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Warning</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"File is empty: </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$file</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">FullName</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">continue</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Copying </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$file</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Name</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)"> to </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$outputPathFull</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ForegroundColor Green</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Copy-Item</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Path </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$file</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">FullName </span><span class="token operator">-</span><span class="token plain">Destination </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$outputPathFull</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Force</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Verify copy succeeded</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$destFile</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Join-Path</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$outputPathFull</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$file</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">!</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token function" style="color:rgb(80, 250, 123)">Test-Path</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$destFile</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Error</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Failed to copy file to: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$destFile</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">foreach</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$file</span><span class="token plain"> in </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$varFiles</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Verbose</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Processing var file: </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$file</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">FullName</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Copying </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$file</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Name</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)"> to </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$outputPathFull</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ForegroundColor Green</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Copy-Item</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Path </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$file</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">FullName </span><span class="token operator">-</span><span class="token plain">Destination </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$outputPathFull</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Force</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Run Terraform</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Running Terraform..."</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ForegroundColor Green</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Invoke-Terraform</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">workingDirectory </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$outputPath</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">command </span><span class="token string" style="color:rgb(255, 121, 198)">"apply"</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">autoApprove:</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$autoApprove</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Error</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Error occurred: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">exit</span><span class="token plain"> 1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This script can also be found on GitHub <a href="https://github.com/lukemurraynz/PowerOfTheShell/blob/master/Other/Terraform-Bootstrap.ps1" target="_blank" rel="noopener noreferrer">here</a>, if you wanted to fork, or open up a Pull Request with changes.</p>
<p>Hopefully this is useful for you, having a script like this means I can quickly deploy resources that are coded in Terraform <em>(HCL)</em>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-example-terraform-files">üìÇ Example Terraform Files<a href="https://luke.geek.nz/azure/powershell-terraform-bootstrap/#-example-terraform-files" class="hash-link" aria-label="Direct link to üìÇ Example Terraform Files" title="Direct link to üìÇ Example Terraform Files">‚Äã</a></h2>
<p>For those interested, here is the base Terraform code I am using in my example:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">config/main.tf</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource </span><span class="token keyword type variable" style="color:rgb(189, 147, 249);font-style:italic">"azurerm_resource_group"</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"example"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token plain">     </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"example-stgaccount-rg"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">location</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"New Zealand North"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource </span><span class="token keyword type variable" style="color:rgb(189, 147, 249);font-style:italic">"azurerm_storage_account"</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"example"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token plain">                     </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"stgacctfboot1"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">resource_group_name</span><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> azurerm_resource_group.example.name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">location</span><span class="token plain">                 </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> azurerm_resource_group.example.location</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">account_tier</span><span class="token plain">             </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Standard"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">account_replication_type</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"LRS"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">tags</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">environment</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"staging"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">config/providers.tf</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">terraform</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">required_providers</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">azurerm</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">source</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"hashicorp/azurerm"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">version</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"4.15.0"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">provider</span><span class="token keyword type variable" style="color:rgb(189, 147, 249);font-style:italic"> "azurerm" </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">subscription_id</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"9dc6cc8c-5b10-403b-9a2f-5192497ca1ed"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">features</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Product Development lifecycle]]></title>
            <link>https://luke.geek.nz/misc/product-development-lifecycle/</link>
            <guid>https://luke.geek.nz/misc/product-development-lifecycle/</guid>
            <pubDate>Fri, 10 Jan 2025 09:54:15 GMT</pubDate>
            <description><![CDATA[Learn about the stages of product development PoC, PoT, Prototype, MVP, and Pilot, and how to progress through the lifecycle gates.]]></description>
            <content:encoded><![CDATA[<p>PoC, PoT, Prototype, MVP, Pilot - what do they all mean? What is the difference between them, and when should you use them?</p>
<p>Today, we are going to take a look at a technical Cloud Product Development lifecycle - in my eyes, understanding these terminologies is key to determining:</p>
<ul>
<li>What kind of resources <em>(i.e., both technological and human)</em> do you need to dedicate to a product?</li>
<li>Where should you align lifecycle management with your application or service?</li>
<li>How likely is it that the the product makes a good market fit or solves an issue?</li>
<li>Keep your product lean to avoid wasting the wrong resources at the wrong time</li>
<li>Shift to a product-based mindset</li>
<li>Focus on innovation and early feedback loops</li>
</ul>
<p>And, of course - what to expect when people start using these words, often thrown together in a conversation and sometimes even put in writing in Statement of Works and Requests for Proposals.</p>
<!-- -->
<h1>üé® Design Thinking and Agile</h1>
<p>Using Design Thinking - <em>(Empathize, Define, Ideate, Prototype, Test, Implement)</em> as a base - a Product needs to align with actual customer needs; it's an iterative process, as a Product or service itself isn't static. We live in a VUCA (Volatile, Uncertain, Complex, Ambiguous) world, where customers expect more from their technology <em>(as they should)</em> to help empower their own needs securely and reliably.</p>
<p>Agile is about the speed to adapt, not the velocity to deliver, so if we take in Agile delivery and design thinking methodologies, it is no surprise that we need to break the product lifecycle into specific stages to get faster, more immediate feedback and make sure we are concentrating on the right success metrics for our product at the right time.</p>
<p><img decoding="async" loading="lazy" alt="Product Development Lifecycle" src="https://luke.geek.nz/assets/images/ProductDevelopmentLifecycle-7044f9dafc006db527e6e07d524f0b71.png" width="4000" height="2250" class="img_ev3q"></p>
<h1>üõ†Ô∏è Stages of Product Development Lifecycle</h1>
<p>If we break down these stages, we have:</p>
<table><thead><tr><th><strong>Stage</strong></th><th><strong>Description</strong></th><th><strong>Benefits</strong></th><th><strong>Acceptance Criteria</strong></th><th><strong>Resources Needed</strong></th><th><strong>Where Used</strong></th></tr></thead><tbody><tr><td>Ideate</td><td>Generate and prioritize potential solutions for the identified problem based on insights and feasibility.</td><td>Fosters creativity and provides a clear roadmap for experimentation and development.</td><td>Clear problem definition, prioritized ideas based on feasibility, impact, and alignment with user needs.</td><td>Innovation workshops, user interviews, brainstorming tools, and cross-functional collaboration.</td><td>At the beginning of any product development or improvement process.</td></tr><tr><td>PoT (Proof of Technology)</td><td>Validate the technical feasibility of a specific technology or approach without focusing on user needs or business value.</td><td>Establishes whether the technology is feasible and provides initial direction for further exploration.</td><td>Demonstrates core technical capabilities and resolves major uncertainties regarding technology.</td><td>Technical experts, test environments, access to research, and innovation workshops.</td><td>When exploring unproven or novel technologies before deeper investment in development.</td></tr><tr><td>PoC (Proof of Concept)</td><td>Proves that the proposed solution can solve a specific problem, aligning technology with business and user needs.</td><td>Validates alignment of the technology with the desired outcomes and de-risks the solution.</td><td>Demonstrates that the solution addresses the problem effectively under controlled conditions; stakeholder approval is achieved.</td><td>Business analysts, developers, user research teams, and small-scale testing environments.</td><td>Before seeking stakeholder buy-in or funding for further development.</td></tr><tr><td>MVP (Minimum Viable Product)</td><td>The product's first version with enough functionality to address core user needs and gather feedback.</td><td>Accelerates market entry, reduces time-to-value, and collects feedback to prioritize future improvements.</td><td>Achieves user adoption and gathers user engagement, satisfaction, and performance metrics.</td><td>Development teams, product managers, QA testers, analytics tools, and customer success teams.</td><td>To test market fit, validate assumptions, and inform scaling decisions.</td></tr><tr><td>Pilot</td><td>A limited-scale deployment in a controlled environment to test end-to-end viability and gather comprehensive feedback.</td><td>Identifies risks, operational issues, and unforeseen challenges before scaling to production.</td><td>Demonstrates success in a real-world environment; collects data to refine for production readiness.</td><td>End users, operational teams, real-world testing environments, customer support, and analytics tools.</td><td>When preparing for scaling and addressing operational risks.</td></tr><tr><td>Production</td><td>The full-scale product deployment with all necessary features, reliability, and support for end users.</td><td>Delivers the finalized solution to users while ensuring scalability, reliability, and operational efficiency.</td><td>Meets key performance indicators (KPIs), user satisfaction benchmarks, and operational SLAs (Service Level Agreements).</td><td>Development, operations, customer support, monitoring tools, and continuous improvement processes.</td><td>To deliver the product to users at scale with ongoing support and updates.</td></tr><tr><td>Continuous Improvement</td><td>Ongoing enhancement and optimization of the product based on user feedback, performance metrics, and market needs.</td><td>Ensures the product remains competitive, relevant, and user-friendly over time.</td><td>Demonstrates improvement in key metrics (e.g., adoption, satisfaction, performance); regular delivery of enhancements with minimal disruptions.</td><td>DevOps teams, user research, monitoring tools, and agile sprint cycles for regular updates.</td><td>Post-production phase to address evolving requirements and maintain product excellence.</td></tr><tr><td>Sunset</td><td>The planned decommissioning or replacement of the product when it no longer provides value or becomes obsolete.</td><td>Frees up resources for other priorities while ensuring users transition smoothly to alternatives.</td><td>Completion of decommissioning plan, including user migration, data archiving, and system shutdown with minimal disruption.</td><td>Project managers, operations teams, user communication channels, and migration tools.</td><td>When the product reaches end-of-life, either due to replacement or diminished relevance.</td></tr></tbody></table>
<h1>üìã Detailed Stage Descriptions</h1>
<ul>
<li>
<p><strong>Ideate</strong>
Generates and prioritizes ideas, ensuring a user-centered approach from the outset. Benefits include a clear focus on feasible and impactful solutions.</p>
</li>
<li>
<p><strong>PoT (Proof of Technology)</strong>
Focused on assessing the technical feasibility of a solution, ensuring it is viable for solving the identified problem. Benefits include reducing technical risk early in the process and clarifying technological possibilities.</p>
</li>
<li>
<p><strong>PoC (Proof of Concept)</strong>
Aligns technical feasibility with business objectives, showing stakeholders how the solution addresses the problem. Benefits include stakeholder buy-in and a clearer understanding of the project‚Äôs potential impact.</p>
</li>
<li>
<p><strong>MVP (Minimum Viable Product)</strong>
A functional product with core features deployed to early adopters for real-world usage and feedback. Prioritizes speed-to-market and core functionality. Benefits include reduced time-to-market and insights into user needs for prioritizing future features.</p>
</li>
<li>
<p><strong>Pilot</strong>
A controlled, real-world deployment of the MVP to test the product‚Äôs operational viability in a controlled, real-world environment, focusing on end-to-end testing. Benefits include reduced risks and a more straightforward path to production readiness.</p>
</li>
<li>
<p><strong>Production</strong>
In the final stage, the product is fully deployed, supported, and scaled for end users. Benefits include delivering business value, achieving scalability, and operational efficiency.</p>
</li>
<li>
<p><strong>Continuous Improvement</strong>
Ensures the product evolves based on user feedback and performance metrics. Benefits include staying competitive and maintaining user satisfaction through regular updates.</p>
</li>
<li>
<p><strong>Sunset</strong>
A planned retirement phase that ensures a smooth transition for users while freeing up resources for other priorities. Benefits include minimizing disruptions and maintaining organizational focus.</p>
</li>
</ul>
<h1>‚ùì Key Questions for Each Stage</h1>
<p>One of the key reasons to break down the Product Lifecycle into these stages is to focus on the right needs of your product or service at the right times; examples of questions you should be asking at each phase are:</p>
<table><thead><tr><th><strong>Stage</strong></th><th><strong>Key Questions</strong></th></tr></thead><tbody><tr><td>PoT (Proof of Technology)</td><td>- What unknowns about the technology must be validated?  \n- Are the tools or platforms feasible for this use case?  \n- What are the technical risks, and how can they be mitigated?  \n- Is this the best technology stack for long-term scalability?</td></tr><tr><td>PoC (Proof of Concept)</td><td>- Does the solution align with business goals?  \n- Can it solve the problem in a controlled, small-scale test?  \n- What are the critical assumptions being validated?  \n- How will stakeholders measure success?  \n- What constraints or dependencies could limit progress?</td></tr><tr><td>Prototype</td><td>- Does the design meet usability and functionality needs?  \n- What feedback can be gathered on the proposed solution?  \n- Are there any technical barriers to implementing the design?  \n- How well does the prototype align with user personas or scenarios?</td></tr><tr><td>MVP (Minimum Viable Product)</td><td>- What core functionality is essential to meet user needs?  \n- Can this be delivered with minimal effort for testing adoption?  \n- How will user feedback be collected and prioritized?  \n- Are the team and infrastructure ready to iterate quickly based on feedback?</td></tr><tr><td>Pilot</td><td>- What operational or real-world risks must be addressed before scaling?  \n- How will success in the pilot phase be measured?  \n- Are there additional training or support requirements for users?  \n- How will pilot learnings be incorporated into scaling plans?</td></tr><tr><td>Production</td><td>- Is the solution robust and scalable?  \n- Are operational processes in place for monitoring, support, and continuous improvement?  \n- What KPIs or metrics indicate product success?  \n- Are end users satisfied with performance and usability?  \n- How will updates or fixes be managed post-launch?</td></tr><tr><td>Continuous Development</td><td>- What feedback from users or metrics indicates areas for improvement?  \n- How can automation enhance development or deployment processes?  \n- Are there new features or updates that align with market trends?  \n- How can emerging technologies be leveraged to improve the product?  \n- Is there a roadmap for ongoing enhancements?</td></tr><tr><td>Sunset</td><td>- What is the timeline and plan for decommissioning?  \n- How will users transition to alternatives?  \n- How will data and systems be archived or disposed of?  \n- Are there plans to communicate changes effectively to all stakeholders?  \n- What metrics indicate it is the right time to sunset the product?</td></tr></tbody></table>
<h1>üö™ Product Lifecycle Gates</h1>
<p>So let us dig a bit deeper into some of the gates to consider when shifting a product through this lifecycle before you reach the next stage <em>(for example, from MVP to Pilot)</em>:</p>
<p><img decoding="async" loading="lazy" alt="Product Development Lifecycle Gates" src="https://luke.geek.nz/assets/images/ProductDevelopmentLifecycleGates-19ffe92493631d8c9725e19c384e805e.png" width="4000" height="2250" class="img_ev3q"></p>
<ol>
<li><strong>Problem Definition and Technical Feasibility</strong>
(Helps determine if you're at the PoT or PoC stage)</li>
</ol>
<ul>
<li>What is the primary problem this application/workload/service is trying to solve?</li>
<li>Do we have enough technical understanding to validate whether this can be built?</li>
<li>Are there specific technical risks or uncertainties that need validation before proceeding further?</li>
<li>Is there an existing technology or approach that can achieve the desired outcome, or does this require exploration?</li>
<li>Are stakeholders aligned on the goals of the solution at this stage?</li>
</ul>
<ol start="2">
<li><strong>User and Business Alignment</strong>
(Determines if you're ready for PoC, Prototype, or MVP stages)</li>
</ol>
<ul>
<li>Who are the target users or audiences for this application/workload/service?</li>
<li>What are the critical business outcomes or objectives tied to this solution?</li>
<li>Do we have user personas or initial feedback to validate assumptions?</li>
<li>Is there clarity on how this solution will fit into existing business processes or workflows?</li>
<li>Are there measurable KPIs or success criteria defined for the next stage?</li>
</ul>
<ol start="3">
<li><strong>Functionality and Design</strong>
(Helps decide if Prototype or MVP is needed)</li>
</ol>
<ul>
<li>Do we have clear requirements and design principles for the application?</li>
<li>What specific features or functionality are critical to test user engagement?</li>
<li>Is the goal to explore design and usability (Prototype) or to deliver something functional for user adoption (MVP)?</li>
<li>How much feedback or iteration is needed to validate user needs or business value?</li>
<li>Are there competing priorities (e.g., time-to-market vs. feature completeness) that influence this stage?</li>
</ul>
<ol start="4">
<li><strong>Real-World Validation</strong>
(Clarifies readiness for Pilot stage)</li>
</ol>
<ul>
<li>Has the application/workload/service undergone sufficient technical, functional, and usability testing?</li>
<li>Are there operational risks or challenges that require validation in a controlled environment?</li>
<li>Do we have a defined test group or environment to deploy the solution and gather feedback?</li>
<li>What are the success metrics for the pilot phase (e.g., adoption rate, performance, operational readiness)?</li>
<li>What‚Äôs the contingency plan if the pilot reveals significant issues?</li>
</ul>
<ol start="5">
<li><strong>Scalability and Operational Readiness</strong>
(Determines readiness for Production)</li>
</ol>
<ul>
<li>Has the solution demonstrated scalability under expected workloads?</li>
<li>Are there any technical, security, or compliance gaps preventing full-scale deployment?</li>
<li>Is the team equipped with monitoring, support, and incident response processes?</li>
<li>What are the ongoing maintenance and operational requirements?</li>
<li>Is there a plan for onboarding users or customers at scale?</li>
</ul>
<ol start="6">
<li><strong>Post-Launch Evolution and Sunset Planning</strong>
(Addresses long-term product lifecycle considerations)</li>
</ol>
<ul>
<li>What is the plan for iterating and improving the product post-launch?</li>
<li>How will we track performance, gather feedback, and prioritize enhancements?</li>
<li>Is there a decommissioning or migration plan in case of obsolescence or replacement?</li>
<li>What‚Äôs the budget and resource allocation for ongoing updates?</li>
<li>What external factors (e.g., market changes and technology updates) could impact the solution's longevity?</li>
</ul>
<h1>üìö Scenarios</h1>
<p>Let's look at two scenarios to see how these stages can be applied. Scenario #1 is the development of an Azure Landing Zone <em>(yes, it doesn't have to be specifically a product - this is a way of thinking, more of a guideline/framework than a rule)</em> and Scenario #2 is the creation of an eCommerce website.</p>
<p>Here is the updated table with the sunset row added at the bottom:</p>
<table><thead><tr><th><strong>Gate</strong></th><th><strong>Scenario #1. Azure Landing Zone Implementation</strong></th><th><strong>Scenario #2. E-Commerce Website</strong></th></tr></thead><tbody><tr><td>Gate 1: <strong>Technical Feasibility Validated</strong></td><td>- All resource types required for the landing zone deployment are provisioned successfully using IaC (Infrastructure as Code).  \n- A network topology supporting hybrid cloud connectivity is deployed and passes end-to-end connectivity tests.</td><td>- The website backend can retrieve product data from a database within 50ms under test conditions.  \n- A sandbox environment successfully processes simulated payments through the payment gateway.</td></tr><tr><td>Gate 2: <strong>Stakeholder Approval</strong></td><td>- Stakeholders review and sign off governance policies for tagging, cost management, and resource compliance.  \n- Cloud adoption teams approve the initial subscription and resource group hierarchy structure.</td><td>- Stakeholders approve a product backlog containing prioritized features for the MVP based on user stories.  \n- Design mockups of key pages (e.g., homepage, product page, checkout page) are reviewed and signed off by business stakeholders.</td></tr><tr><td>Gate 3: <strong>MVP Adoption Metrics Met</strong></td><td>- The MVP landing zone enables three application teams to deploy workloads without manual intervention.  \n- Monitoring and logging solutions for the MVP environment are active and provide actionable insights within 5 minutes of an incident.</td><td>- The MVP site achieves at least 100 daily active users within 2 weeks of launch.  \n- Basic checkout functionality works end-to-end, including order placement and confirmation email delivery.</td></tr><tr><td>Gate 4: <strong>Pilot Success Criteria Achieved</strong></td><td>- The pilot environment supports the deployment of workloads across all required regions with no SLA violations over 4 weeks.  \n- All critical governance, security, and operational policies pass compliance testing in the pilot.</td><td>- During a limited launch, 1,000 transactions are processed with less than 1% failure rate.  \n- Pilot users provide a Net Promoter Score (NPS) of 7 or higher for their experience on the site.</td></tr><tr><td>Gate 5: <strong>Go-Live Decision</strong></td><td>- All key stakeholders approve readiness for production based on agreed KPIs (e.g., uptime, cost optimization, and security).  \n- Documentation for deployment, governance, and user onboarding is complete and validated by end users.</td><td>- The e-commerce platform handles a load test of 20,000 concurrent users with a 99.9% success rate in order processing.  \n- Critical user journeys (search, add to cart, checkout) are tested with zero critical defects reported in production-readiness testing.</td></tr><tr><td>Gate 6:<strong>Sunset</strong></td><td>- All resources associated with the landing zone are decommissioned safely and cost-effectively, with no unexpected impact on remaining environments.  \n- Final cost and usage reports for the project are reviewed and shared with stakeholders.</td><td>- All user data is successfully migrated or anonymized according to privacy policies.  \n- All legal and financial obligations are met for the e-commerce platform, and any necessary shutdown or scaling activities are completed without affecting the remaining infrastructure.</td></tr></tbody></table>
<h1>üèÅ Conclusion</h1>
<p>Hopefully, this article gives you more clarity about the product design lifecycle, how to apply it to your own projects, and how to use it to your advantage to make sure you are focusing on the right things at the right time and not wasting resources on the wrong things.</p>]]></content:encoded>
            <category>Misc</category>
            <category>Service Management</category>
        </item>
        <item>
            <title><![CDATA[Pre-commit Hooks in GitHub Codespaces for Terraform IaC]]></title>
            <link>https://luke.geek.nz/misc/precommit-hooks-codespaces-terraform-iac/</link>
            <guid>https://luke.geek.nz/misc/precommit-hooks-codespaces-terraform-iac/</guid>
            <pubDate>Tue, 07 Jan 2025 08:06:54 GMT</pubDate>
            <description><![CDATA[Learn how to set up pre-commit hooks in GitHub Codespaces for Terraform Infrastructure as Code (IaC) development.]]></description>
            <content:encoded><![CDATA[<p>Pre-commit hooks are automated scripts or checks running before developers commit code to a repository. They are particularly useful in the context of infrastructure, such as code <em>(IaC)</em> development, when working with Terraform.</p>
<p>These hooks serve as an early defense against common issues, ensuring code quality and consistency before changes are committed to version control.</p>
<p>Today, we are going to discuss precommit with GitHub Codespaces.</p>
<!-- -->
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p><a href="https://pre-commit.com/" target="_blank" rel="noopener noreferrer">Pre-commit hooks</a> offer several advantages in the IaC development lifecycle:</p><ul>
<li>Early Error Detection: They catch syntax errors, formatting issues, and potential security vulnerabilities before code is committed.</li>
<li>Consistency: Hooks enforces coding standards and best practices across the development team.</li>
<li>Time-saving: By automating routine checks, pre-commit hooks reduce the need for manual review and minimize the likelihood of failed CI/CD pipelines.</li>
<li>Security: They can identify potential security risks in infrastructure code early in the development process.</li>
</ul><p><img decoding="async" loading="lazy" alt="Pre-commit hooks" src="https://luke.geek.nz/assets/images/pre-commit-hook-flow-7e60248cd1d61f0724b7554c8336e15e.png" width="720" height="321" class="img_ev3q"></p><p><em>(Image from <a href="https://azure.github.io/AKS-DevSecOps-Workshop/" target="_blank" rel="noopener noreferrer">AKS DevSecOps Workshop</a>)</em></p><p>Pre-commits work well in the Inner Loop of the Developer/Cloud Engineer workflow <em>(for the duration of this article when I use the word developer, I am meaning anyone who writes IaC code)</em>. They can be lightweight and run quickly, providing immediate feedback to developers as they work on their code. This feedback loop helps developers address issues early, leading to higher-quality code and faster development cycles, before the code hits any peer review or remote code source system (such as DevOps or GitHub repositories)_.</p><p><img decoding="async" loading="lazy" alt="Inner Loop of Developer Workflow" src="https://luke.geek.nz/assets/images/devinnerouterloop-b08a99eb9b7df562d4c631e2244a1a8c.png" width="1984" height="794" class="img_ev3q"></p></div></div>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>While pre-commit hooks can be valuable tools for maintaining code quality, there are several concerns and potential drawbacks to be aware of when implementing them. The use of GitHub Codespaces can help with some of the drawbacks, especially around consistency and setup, however consider the tradeoffs of what pre-commit hooks you want and how they may impact your development workflow.</p><p>Some potential drawbacks include:</p><ul>
<li>Pre-commit hooks can significantly slow down the development process, especially if they run extensive checks or tests</li>
<li>Frequent, time-consuming checks can break a developer's focus and impede productivity</li>
<li>Overly restrictive pre-commit hooks may be seen as a lack of trust in developers' abilities and judgment</li>
<li>Strict pre-commit checks might discourage developers from experimenting or pushing work-in-progress code to their branches</li>
<li>Developers might be tempted to bypass hooks using git commit flags, defeating the purpose of the checks</li>
</ul><p>There's a delicate balance between comprehensive checks and maintaining a fast, frictionless commit process. Not all checks need to be in pre-commit hooks; some can be deferred to CI/CD pipelines or pre-push hooks, and because of the individual nature of having the pre-commit setup for each developer and the developer able to force the commit <em>(ignoring the pre-commit checks)</em> it is important to have a good culture around the use of pre-commit hooks, and any important checks need to be implemented in a CI/CD pipeline, for consistency.</p></div></div>
<p>So, let us get started with setting up pre-commit hooks in GitHub Codespaces. The same premise can also be applied outside of a Codespace, but for this article, we will focus on a Codespace.</p>
<p>The guts of this is the <a href="https://pre-commit.com/" target="_blank" rel="noopener noreferrer">pre-commit framework</a>, a Python package that manages pre-commit hooks for you. It is a framework for managing and maintaining multi-language pre-commit hooks. The pre-commit hooks are run against the files that are staged for commit, and if any of the hooks fail, the commit is rejected.</p>
<blockquote>
<p>Git hook scripts are useful for identifying simple issues before submission to code review. We run our hooks on every commit to automatically point out issues in code, such as missing semicolons, trailing whitespace, and debug statements. Pointing these issues out before code review allows a code reviewer to focus on the architecture of a change while not wasting time with trivial style nitpicks.</p>
</blockquote>
<p>For the Codespace, we will add the pre-commit framework to the Codespace, then add a script to initialize the pre-commit hooks, then configure the pre-commit hooks to run the checks we want.</p>
<p>Let's add the pre-commit framework to the Codespace devcontainer.json.</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token property">"features"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">//Add pre-commit</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"ghcr.io/prulloac/devcontainer-features/pre-commit:1.0.3"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Once added, we need to add a postCreateCommand to initialize the pre-commit framework, like so:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token property">"postCreateCommand"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"pre-commit install"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This will run after the GitHub Codespace has been created and running.</p>
<p>So, an example for our Terraform IaC would look like this:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">.devcontainer/devcontainer.json</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// "features" section allows adding and configuring predefined features or tools in the development container.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"features"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// Adds and configures the Azure CLI with Bicep and Python installation options.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"ghcr.io/devcontainers/features/azure-cli:latest"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"installBicep"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">//  Bicep installation.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"installUsingPython"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Installs using Python.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"version"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"latest"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Specifies the version of the Azure CLI to install.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// Adds PowerShell to the container.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"ghcr.io/devcontainers/features/powershell:latest"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"version"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"latest"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Specifies the version of PowerShell to install.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     </span><span class="token comment" style="color:rgb(98, 114, 164)">//Add pre-commit</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"ghcr.io/prulloac/devcontainer-features/pre-commit:1.0.3"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// Adds and configures Terraform with specific version, TFLint, and Terragrunt.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"ghcr.io/devcontainers/features/terraform:1"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"version"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"latest"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Specifies the version of Terraform to install.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"tflint"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"latest"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Specifies the version of TFLint to install.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"terragrunt"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"latest"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Specifies the version of Terragrunt to install.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"postCreateCommand"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"pre-commit install"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>You can view a version of the devcontainer.json file <a href="https://github.com/lukemurraynz/Codespace_IaC_Coding/blob/main/.devcontainer/devcontainer.json" target="_blank" rel="noopener noreferrer">here</a>. My <a href="https://github.com/lukemurraynz/Codespace_IaC_Coding" target="_blank" rel="noopener noreferrer">lmurraynz/Codespace_IaC_Coding</a> repository has a devcontainer.json file that has the pre-commit framework added in. The intention is that you can take this repository as a template and then modify and remove it as you need to.</p></div></div>
<p>Once the Codespace has been created, you can then add a .pre-commit-config.yaml file to the root of your repository. This file will contain the configuration for the pre-commit hooks you want to run.</p>
<p>An example of a .pre-commit-config.yaml file for Terraform would look like this:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">.pre-commit-config.yaml</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token key atrule">default_stages</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">pre</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">commit</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">repos</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">repo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> https</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">//github.com/pre</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">commit/pre</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">commit</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">hooks</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">rev</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> v5.0.0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">hooks</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> trailing</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">whitespace</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> end</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">of</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">file</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">fixer</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> check</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">yaml</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> check</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">added</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">large</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">files</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> check</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">case</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">conflict</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> check</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">merge</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">conflict</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">repo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> https</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">//github.com/antonbabenko/pre</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">commit</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">terraform</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">rev</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> v1.96.3</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">hooks</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> terraform_fmt</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">args</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">args=</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">recursive</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">exclude</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'.*/\.terragrunt-cache'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> terraform_validate</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> terraform_tflint</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> terraform_trivy</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> terraform_docs</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">args</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">hook</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">config=</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">add</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">to</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">existing</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">file=true     </span><span class="token comment" style="color:rgb(98, 114, 164)"># Boolean. true or false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">hook</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">config=</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">create</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">file</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">if</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">not</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">exist=true </span><span class="token comment" style="color:rgb(98, 114, 164)"># Boolean. true or false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">args=</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">output</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">mode=replace</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> tfupdate</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Autoupdate Terraform versions</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">args</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">args=provider azurerm </span><span class="token comment" style="color:rgb(98, 114, 164)"># Will be pined to latest version</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">repo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> https</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">//github.com/bridgecrewio/checkov.git</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">rev</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'3.2.346'</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># change to tag or sha</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">hooks</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> checkov</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">verbose</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">args</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">'--quiet'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'--compact'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'--soft-fail'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Here's a breakdown of what each part does:</p>
<ol>
<li>
<p><strong><code>default_stages: [pre-commit]</code></strong>: Specifies that the hooks should run at the <code>pre-commit</code> stage.</p>
</li>
<li>
<p><strong><code>repos</code></strong>: Lists repositories containing pre-commit hooks to be used.</p>
</li>
<li>
<p><strong>First repository</strong> (<code>https://github.com/pre-commit/pre-commit-hooks</code>):</p>
<ul>
<li><strong><code>rev: v5.0.0</code></strong>: Specifies the version of the repository.</li>
<li><strong><code>hooks</code></strong>: Lists the hooks to be used from this repository:<!-- -->
<ul>
<li><code>trailing-whitespace</code>: Removes trailing whitespace.</li>
<li><code>end-of-file-fixer</code>: Ensures files end with a newline.</li>
<li><code>check-yaml</code>: Checks YAML files for syntax errors.</li>
<li><code>check-added-large-files</code>: Prevents large files from being added.</li>
<li><code>check-case-conflict</code>: Checks for case conflicts in filenames.</li>
<li><code>check-merge-conflict</code>: Checks for unresolved merge conflicts.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Second repository</strong> (<code>https://github.com/antonbabenko/pre-commit-terraform</code>):</p>
<ul>
<li><strong><code>rev: v1.96.3</code></strong>: Specifies the version of the repository.</li>
<li><strong><code>hooks</code></strong>: Lists the hooks to be used from this repository:<!-- -->
<ul>
<li><code>terraform_fmt</code>: Formats Terraform files.<!-- -->
<ul>
<li><code>args</code>: Specifies arguments for the hook.</li>
<li><code>exclude</code>: Excludes certain files from the hook.</li>
</ul>
</li>
<li><code>terraform_validate</code>: Validates Terraform files.</li>
<li><code>terraform_tflint</code>: Lints Terraform files.</li>
<li><code>terraform_trivy</code>: Scans Terraform files for vulnerabilities.</li>
<li><code>terraform_docs</code>: Generates documentation for Terraform files.<!-- -->
<ul>
<li><code>args</code>: Specifies arguments for the hook.</li>
</ul>
</li>
<li><code>tfupdate</code>: Updates Terraform provider versions.<!-- -->
<ul>
<li><code>name</code>: Provides a name for the hook.</li>
<li><code>args</code>: Specifies arguments for the hook.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Third repository</strong> (<code>https://github.com/bridgecrewio/checkov.git</code>):</p>
<ul>
<li><strong><code>rev: '3.2.346'</code></strong>: Specifies the version of the repository.</li>
<li><strong><code>hooks</code></strong>: Lists the hooks to be used from this repository:<!-- -->
<ul>
<li><code>checkov</code>: Runs Checkov to scan for security issues in infrastructure as code.<!-- -->
<ul>
<li><code>verbose</code>: Enables verbose output.</li>
<li><code>args</code>: Specifies arguments for the hook.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ol>
<p>This configuration ensures that various checks and fixes are automatically applied to the codebase before commits are made, helping to maintain code quality and security.</p>
<p>So, let's spin up our Codespace and see the pre-commit hooks in action.</p>
<p>The first time you run this, it will take a while as it will download the pre-commit hooks and install them. Be mindful of this if you are running this in a new Codespace environment.</p>
<p><img decoding="async" loading="lazy" alt="Pre-commit install" src="https://luke.geek.nz/assets/images/Precommit_Codespace_Terraform_Run-96daf6e0895ddb3c87b20c0fbd5b5ac5.gif" width="1901" height="1032" class="img_ev3q"></p>
<p>As you can see from the pre-commit output, I am missing some dependencies installed, i.e., Terraform docs, but we can see Terraform format ran, the trailing whitespace check ran and fixed the issue, and tflint ran and came back with some issues, such as missing provider versions, and checkov ran a security check, which came back with some failed checks, such as Public access enabled and latest TLS version not set.</p>
<p>Hopefully, you can see the power of the pre-commit, and as these failed, nothing was committed to the repository, so I can fix these issues before I commit the code.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>If needed, we can skip the pre-commit checks and force-push the changes through with the following command:</p><p>git push --no-verify</p><p>This will bypass the pre-commit checks and force the commit through. There is a <a href="https://marketplace.visualstudio.com/items?itemName=DevEscalus.git-push-no-verify" target="_blank" rel="noopener noreferrer">Visual Studio Code extension - Git push(no verify)
</a> as well, which adds a noverify button to the commit dialog, so you can bypass the pre-commit checks if needed.</p></div></div>
<p>Hopefully, this will give you a great starting block for adding pre-commit hooks to your Codespace and workflow and help with secure and reliable IaC development. You can find a list of common prehooks here: <a href="https://pre-commit.com/hooks.html" target="_blank" rel="noopener noreferrer">featured hooks
</a>, and if your game - you can create your own and find other hooks people have created - such as this Azure Bicep <a href="https://github.com/Azure4DevOps/check-azure-bicep" target="_blank" rel="noopener noreferrer">Azure4DevOps/check-azure-bicep</a> one.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>You can run  <code>pre-commit autoupdate</code> to update all the pre-commit hook versions. For example, when I ran it, I got:</p><ul>
<li>[<a href="https://github.com/bridgecrewio/checkov.git" target="_blank" rel="noopener noreferrer">https://github.com/bridgecrewio/checkov.git</a>]<!-- --> updating 3.2.346 -&gt; 3.2.350</li>
</ul><p>Which updated my <code>.pre-commit-config.yaml</code> file with the latest version without having to go and check each one manually.</p></div></div>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Deploying Azure Managed Redis with Bicep]]></title>
            <link>https://luke.geek.nz/azure/deploying-azure-managed-redis-with-bicep/</link>
            <guid>https://luke.geek.nz/azure/deploying-azure-managed-redis-with-bicep/</guid>
            <pubDate>Thu, 02 Jan 2025 08:45:51 GMT</pubDate>
            <description><![CDATA[Learn how to deploy Azure Managed Redis using Bicep with code examples.]]></description>
            <content:encoded><![CDATA[<p><a href="https://learn.microsoft.com/azure/azure-cache-for-redis/managed-redis/managed-redis-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Managed Redis</a> announced during <a href="https://techcommunity.microsoft.com/blog/AppsonAzureBlog/introducing-azure-managed-redis-cost-effective-caching-for-your-ai-apps/4299104?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Microsoft Ignite 2024</a> in Public Preview.</p>
<p>This is a new, fully-managed, first-party Redis offering in Microsoft Azure. Azure Managed Redis is available today in public preview. Microsoft Azure is the first major cloud service provider to offer customers a licensed, multi-tiered Redis service.</p>
<p>This article will show you how to deploy an Azure Managed Redis instance using <a href="https://learn.microsoft.com/azure/azure-resource-manager/bicep/overview?tabs=bicep&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Bicep</a>. Bicep is a Domain Specific Language (DSL) for deploying Azure resources declaratively. It aims to drastically simplify the authoring experience with a cleaner syntax and better support for modularity and code reuse.</p>
<!-- -->
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Every customer that migrates from any Azure Cache for Redis tier to Azure Managed Redis will gain access to years of Redis innovation. This builds on our existing integration with Microsoft Azure on the Enterprise and Enterprise Flash tiers for Azure Cache for Redis. With the introduction of Azure Managed Redis, users on Azure Cache for Redis can now access features that were previously found only on the Azure Cache for Redis Enterprise and Enterprise Flash tiers.</p><p>Azure Managed Redis delivers on the best scale and SLA in the industry, building on the advancements first introduced by the Azure Cache for the Redis Enterprise tier. Users can now experience up to 99.999% availability when leveraging multi-region Active-Active, the highest availability offered in the market, powered by CRDT. Apps built with Azure Managed Redis can deliver down to sub-millisecond local latency to users globally and simultaneously, no matter which continent or region they‚Äôre located on.</p></div></div>
<p>In this example, I have deployed Azure Managed Redis using Bicep, with bonus code snippets for connecting <a href="https://learn.microsoft.com/azure/api-management/api-management-key-concepts?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">API Management</a> to the <a href="https://learn.microsoft.com/azure/azure-cache-for-redis/managed-redis/managed-redis-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Managed Redis</a>.</p>
<p>The Bicep file creates a new Azure Managed Redis instance.</p>
<p>Redis Enterprise Cache Setup</p>
<ul>
<li>Resource Type: Microsoft.Cache/redisEnterprise</li>
<li>API Version: 2024-09-01-preview</li>
<li>Name: redisEnterprise</li>
<li>Location: Uses a variable location</li>
<li>Tags: Uses a variable tags</li>
<li>SKU: Specifies the SKU as MemoryOptimized_M10</li>
<li>Properties: Sets the minimum TLS version to 1.2</li>
</ul>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// Redis Enterprise Cache setup</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> redisEnterprise </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.Cache/redisEnterprise@2024-09-01-preview'</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'redisEnterprise'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">location</span><span class="token operator">:</span><span class="token plain"> location</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">tags</span><span class="token operator">:</span><span class="token plain"> tags</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">sku</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'MemoryOptimized_M10'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">minimumTlsVersion</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'1.2'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">output</span><span class="token plain"> redisEnterpriseName </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> redisEnterprise</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">name</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This part of the Bicep file sets up a Redis Enterprise Cache instance with specific configurations such as location, tags, SKU, and minimum TLS version.</p>
<p>Redis Cache Database Setup</p>
<ul>
<li>Resource Type: Microsoft.Cache/redisEnterprise/databases</li>
<li>API Version: 2024-09-01-preview</li>
<li>Name: default</li>
<li>Parent: Links to the redisEnterprise resource defined earlier
Properties:</li>
<li>Access Keys Authentication: Disabled</li>
<li>Eviction Policy: No eviction</li>
<li>Clustering Policy: Enterprise cluster</li>
<li>Modules: Includes the RediSearch module</li>
<li>Port: Sets the port to 10000</li>
</ul>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> redisCache </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.Cache/redisEnterprise/databases@2024-09-01-preview'</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'default'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">parent</span><span class="token operator">:</span><span class="token plain"> redisEnterprise</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">accessKeysAuthentication</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Disabled'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">evictionPolicy</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'NoEviction'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">clusteringPolicy</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'EnterpriseCluster'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">modules</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'RediSearch'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">port</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">10000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This part sets up a Redis Cache Database within the Redis Enterprise Cache instance. It configures properties such as access key authentication, eviction policy, clustering policy, modules, and port.</p>
<p>You can also link API Management to the Azure Managed Redis resource as a bonus. This is a small snippet of the Connection string for API Management:</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">redisCacheConnectionString</span><span class="token operator">:</span><span class="token plain"> </span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">'</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">redisEnterprise</span><span class="token interpolated-string interpolation expression punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token interpolated-string interpolation expression">properties</span><span class="token interpolated-string interpolation expression punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token interpolated-string interpolation expression">hostName</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">:</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression number">10000</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">,ssl=True,abortConnect=False'</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This is using Entra ID authentication to connect to the Redis Cache using the following role assignment to the API System Managed Identity:</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// Redis Access Policy Assignment</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> redisAccessPolicyAssignmentName </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.Cache/redisEnterprise/databases/accessPolicyAssignments@2024-09-01-preview'</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">take</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">'cachecontributor</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression function" style="color:rgb(80, 250, 123)">uniqueString</span><span class="token interpolated-string interpolation expression punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token interpolated-string interpolation expression function" style="color:rgb(80, 250, 123)">resourceGroup</span><span class="token interpolated-string interpolation expression punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token interpolated-string interpolation expression punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token interpolated-string interpolation expression punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token interpolated-string interpolation expression">id</span><span class="token interpolated-string interpolation expression punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">24</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">parent</span><span class="token operator">:</span><span class="token plain"> redisCache</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">accessPolicyName</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'default'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">user</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">objectId</span><span class="token operator">:</span><span class="token plain"> apim</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">outputs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">apimPrincipalId</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Using Azure Communication Services and UMI PowerShell to Send Emails]]></title>
            <link>https://luke.geek.nz/azure/using-communication-services-and-umi-powershell-to-send-emails/</link>
            <guid>https://luke.geek.nz/azure/using-communication-services-and-umi-powershell-to-send-emails/</guid>
            <pubDate>Sun, 29 Dec 2024 18:52:25 GMT</pubDate>
            <description><![CDATA[Learn how to use Azure Communication Services and PowerShell to send emails using a User Assigned Managed Identity.]]></description>
            <content:encoded><![CDATA[<p><a href="https://azure.microsoft.com/products/communication-services?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Communication Services</a> brings rich communication APIs to all of your apps across any device on any platform, using the same reliable and secure infrastructure that powers Microsoft Teams.</p>
<p>Today, we will explore using Email as part of Azure Communication Services, using the REST API and PowerShell to send an email using a User Assigned Managed Identity.</p>
<p><img decoding="async" loading="lazy" alt="Azure Communication Services" src="https://luke.geek.nz/assets/images/BlogHeading_DeployandTestACS-f9838a4feb1c05d77481cc14d4141606.gif" width="1200" height="628" class="img_ev3q"></p>
<!-- -->
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>I did a previous article: <a href="https://luke.geek.nz/azure/using-communication-services-and-powershell-to-send-emails/" target="_blank" rel="noopener noreferrer">Deploying and Testing Azure Email Communication Services</a> on this, however the authentication was using an Azure Service Principal. A reader reached out to me about using a User Assigned Managed identity, so I have tested and updated the script to use a User Assigned Managed Identity.</p></div></div>
<p>In this example, I will access a token from <a href="https://azure.microsoft.com/products/communication-services?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Communication Services</a>. I will make a GET request to the identity endpoint of Azure Communication Services, using the oauth identity from the user assigned-managed identity. This will return a token we can use to authenticate against the REST API.</p>
<p>You will need the ClientId of the User Assigned Managed Identity, and that ClientId needs to have Contributor rights to the Azure Communication Service <em>(not Email or Domain service)</em>.</p>
<p><img decoding="async" loading="lazy" alt="User Assigned Managed Identity" src="https://luke.geek.nz/assets/images/UIMClientID-84c03e246e5d1a9a739bf223079bbc54.png" width="2188" height="769" class="img_ev3q"></p>
<p>Here's a step-by-step explanation of the script:</p>
<p>The script accepts several parameters and constructs an email message in HTML format. It then authenticates using Azure Managed Identity to obtain an access token, which is used to authorize the email sending request to Azure Communication Services.</p>
<p>The script defines the following parameters:</p>
<ul>
<li>ClientId: The Client ID for User Assigned Managed Identity (optional).</li>
<li>EmailRecipient: The recipient's email address.</li>
<li>SenderAddress: The sender's email address.</li>
<li>ResourceID: The resource ID for Azure Communication Services.</li>
<li>CommunicationEndpointUrl: The endpoint URL for Azure Communication Services.</li>
</ul>
<ol>
<li>The script checks if a Client ID is provided. If so, it constructs a URI to obtain an access token using User Assigned Managed Identity. Otherwise, it uses System Assigned Managed Identity.</li>
<li>The script then makes a GET request to the identity endpoint to retrieve the access token.</li>
<li>The script constructs the URI for the email sending endpoint and defines the headers, including the access token.</li>
<li>A function Send-Email is defined to send the email using the Invoke-RestMethod cmdlet.</li>
<li>The email content and recipient details are defined in a hashtable, which is passed to the Send-Email function.</li>
</ol>
<p><em>(This authenticaiton was inititally written to be used in a Azure Automation Runbook, with the User Managed Identity assigned Contributor rights to the Azure Communication Services resource (not the Email Communication Services).)</em></p>
<p>Here is the PowerShell script to send an email using Azure Communication Services using the <a href="https://learn.microsoft.com/entra/identity/managed-identities-azure-resources/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">User Managed identity</a> of an <a href="https://learn.microsoft.com/azure/automation/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Automation account</a>:</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token namespace">[Parameter(Mandatory=$false)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token namespace">[string]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ClientId</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">'bc012f8f-58d1-43a5-9383-bb4d104ffe27'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token namespace">[Parameter(Mandatory=$false)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token namespace">[string]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$EmailRecipient</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"example@example.com"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token namespace">[Parameter(Mandatory=$false)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token namespace">[string]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$SenderAddress</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">'DoNotReply@af595a23-f54a-4cdc-bffa-fa3ef54eb1c1.azurecomm.net'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token namespace">[Parameter(Mandatory=$false)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token namespace">[string]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceID</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">'https://communication.azure.com'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token namespace">[Parameter(Mandatory=$false)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token namespace">[string]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$CommunicationEndpointUrl</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"commserviceslukeuserassignedtest.australia.communication.azure.com"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$emailSubject</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"Important: Server Maintenance Notification"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$emailBody</span><span class="token plain"> = @</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">&lt;html&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">&lt;body&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">&lt;p&gt;Dear User,&lt;/p&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">&lt;p&gt;This is to inform you that a &lt;b&gt;&lt;i&gt;server maintenance is scheduled for the next week&lt;/i&gt;&lt;/b&gt;.&lt;/p&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">&lt;p&gt;The servers will be down from 10:00 PM to 2:00 AM.&lt;/p&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">&lt;p&gt;Please save your work and log off during this period to avoid any data loss.&lt;/p&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">&lt;p&gt;If you have any questions or concerns, please contact our IT Support team.&lt;/p&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">&lt;p&gt;Thank you for your understanding and cooperation.&lt;/p&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">&lt;p&gt;Best Regards,&lt;/p&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">&lt;p&gt;IT Support Team&lt;/p&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">&lt;/body&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">&lt;/html&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain">@</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$emailBody</span><span class="token plain"> </span><span class="token operator">-ne</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">""</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Email body is not empty. Proceeding with email sending process."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ClientId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Client ID: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$ClientId</span><span class="token string" style="color:rgb(255, 121, 198)"> exists. Using User Assigned Managed Identity..."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$Uri</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$env</span><span class="token string function" style="color:rgb(80, 250, 123)">:IDENTITY_ENDPOINT</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">?api-version=2018-02-01&amp;resource=</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceID</span><span class="token string" style="color:rgb(255, 121, 198)">&amp;client_id=</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$ClientId</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Client ID: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$ClientId</span><span class="token string" style="color:rgb(255, 121, 198)"> does not exist. Using System Assigned Managed Identity..."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$Uri</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$env</span><span class="token string function" style="color:rgb(80, 250, 123)">:IDENTITY_ENDPOINT</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">?api-version=2018-02-01&amp;resource=</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceID</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Function to get access token</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">try</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Invoke a GET request to the identity endpoint to get the access token</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$AzToken</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Invoke-WebRequest</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Uri </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$Uri</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Method GET </span><span class="token operator">-</span><span class="token plain">Headers @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> Metadata = </span><span class="token string" style="color:rgb(255, 121, 198)">"true"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">UseBasicParsing </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Select-Object</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ExpandProperty Content </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">ConvertFrom-Json</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Select-Object</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ExpandProperty access_token</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Print the obtained access token</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Access Token: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$AzToken</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># If there's an error, print the error message and response details</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Error</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Failed to get access token: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Response Status Code: </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Exception</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Response</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">StatusCode</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Value__</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Response Status Description: </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Exception</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Response</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">StatusDescription</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Response Content: </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Exception</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Response</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">GetResponseStream</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)"> | %{ </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token string" style="color:rgb(255, 121, 198)">.ReadToEnd() })"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Construct the URI for the email sending endpoint</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$uri</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"https://</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$CommunicationEndpointUrl</span><span class="token string" style="color:rgb(255, 121, 198)">/emails:send?api-version=2023-03-31"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Define the headers for the REST API call</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Include the content type and the obtained access token in the Authorization header</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$headers</span><span class="token plain"> = @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">"Content-Type"</span><span class="token plain">  = </span><span class="token string" style="color:rgb(255, 121, 198)">"application/json"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">"Authorization"</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"Bearer </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$AzToken</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Function to send email</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Send-Email</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token namespace">[string]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$Uri</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token namespace">[hashtable]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$Headers</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token namespace">[hashtable]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$Body</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">try</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Sending email..."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"URI: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$Uri</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Headers: </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function" style="color:rgb(80, 250, 123)">ConvertTo-Json</span><span class="token string function" style="color:rgb(80, 250, 123)"> </span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$Headers</span><span class="token string function" style="color:rgb(80, 250, 123)"> </span><span class="token string function operator" style="color:rgb(80, 250, 123)">-</span><span class="token string function" style="color:rgb(80, 250, 123)">Depth 10</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Body: </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function" style="color:rgb(80, 250, 123)">ConvertTo-Json</span><span class="token string function" style="color:rgb(80, 250, 123)"> </span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$Body</span><span class="token string function" style="color:rgb(80, 250, 123)"> </span><span class="token string function operator" style="color:rgb(80, 250, 123)">-</span><span class="token string function" style="color:rgb(80, 250, 123)">Depth 10</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$response</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Invoke-RestMethod</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Uri </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$Uri</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Method Post </span><span class="token operator">-</span><span class="token plain">Headers </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$Headers</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Body </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$Body</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">ConvertTo-Json</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Depth 10</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">UseBasicParsing</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Email sent successfully. Response: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$response</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$response</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Error</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Failed to send email: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Exception Message: </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Exception</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Message</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Exception StackTrace: </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Exception</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">StackTrace</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">throw</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$apiResponse</span><span class="token plain"> = @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        headers = @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            id = </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token function" style="color:rgb(80, 250, 123)">New-Guid</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Guid</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        senderAddress = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$SenderAddress</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        content = @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            subject = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$emailSubject</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            html    = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$emailBody</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        recipients = @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            to = @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    address     = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$EmailRecipient</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    displayName = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$EmailRecipient</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        replyTo = @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                address     = </span><span class="token string" style="color:rgb(255, 121, 198)">"example@contoso.com"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                displayName = </span><span class="token string" style="color:rgb(255, 121, 198)">"Contoso"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        userEngagementTrackingDisabled = </span><span class="token boolean">$true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Send-Email</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Uri </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$uri</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Headers </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$headers</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Body </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$apiResponse</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You can run this script in an Azure Automation Runbook <em>(and theoretically in an <a href="https://learn.microsoft.com/azure/azure-functions/functions-overview?pivots=programming-language-csharp&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Function</a> as well)</em> to send an email using Azure Communication Services with a User Assigned Managed Identity.</p>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Authenticating Azure OpenAI with Managed Identity]]></title>
            <link>https://luke.geek.nz/azure/authenticating-azureopenai-python/</link>
            <guid>https://luke.geek.nz/azure/authenticating-azureopenai-python/</guid>
            <pubDate>Sun, 08 Dec 2024 19:31:27 GMT</pubDate>
            <description><![CDATA[Learn how to authenticate with Azure OpenAI using an API key for local development and Managed Identities for production in Python.]]></description>
            <content:encoded><![CDATA[<p>When developing a Python application that interacts with <a href="https://learn.microsoft.com/azure/ai-services/openai/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure OpenAI</a>, you may want to authenticate with an API key for testing, however in Production, you should use Managed Identities within Microsoft Azure.</p>
<p>In this article, we will look at how to authenticate with <a href="https://learn.microsoft.com/azure/ai-services/openai/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure OpenAI</a> using an API key in Python for local development, then using an environment variable switch to authenticating using <a href="https://learn.microsoft.com/entra/identity/managed-identities-azure-resources/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">managed Identities</a>.</p>
<p>The true hero for Azure authentication is the <a href="https://learn.microsoft.com/python/api/azure-identity/azure.identity.defaultazurecredential?view=azure-python&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">DefaultAzureCredential</a> class from the Azure Identity library. This class can authenticate with Azure services using various methods, including Managed Identity, Shared Token Cache, and environment variables.</p>
<p><img decoding="async" loading="lazy" alt="DefaultAzureCredential" src="https://luke.geek.nz/assets/images/DefaultAzureCredential-78d99839c796bbb8199cd607725fdde4.png" width="1480" height="861" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>This code snippet demonstrates how to load and validate environment variables needed to connect to Azure OpenAI services. Here's a step-by-step breakdown:</p><ol>
<li>
<p><strong>Load Environment Variables</strong>: The code first attempts to load environment variables from the operating system. If any of the required variables are missing, it then tries to load them from a <code>.env</code> file named <code>azureopenai.env</code>.</p>
</li>
<li>
<p><strong>Check for Missing Variables</strong>: This function defines a list of required environment variables and checks for missing ones. If any required variables are not found, an error indicates which variables are missing.</p>
</li>
<li>
<p><strong>Authentication Setup</strong>: The code checks if the <code>AUTHENTICATION</code> environment variable is set to <code>AZURE</code>. If it is, it uses Azure's DefaultAzureCredential to get a bearer token for authentication. Otherwise, it uses an API key.</p>
</li>
<li>
<p><strong>Initialize AzureOpenAI Client</strong>: Finally, it initializes the <code>AzureOpenAI</code> client with the appropriate authentication method (either bearer token or API key) and the necessary API version and endpoint.</p>
</li>
</ol></div></div>
<p>The Python code is as follows:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">from</span><span class="token plain"> azure</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">identity </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> DefaultAzureCredential</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> get_bearer_token_provider</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Load environment variables from OS and .env file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">ENV </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">var</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> os</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">getenv</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">var</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> var </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">in</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">"AZURE_OPENAI_ENDPOINT"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"AZURE_OPENAI_KEY"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"AZURE_OPENAI_API_VERSION"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"AZURE_OPENAI_CHATGPT_DEPLOYMENT"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">any</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">value </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">is</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> value </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">in</span><span class="token plain"> ENV</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">values</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ENV</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">update</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">k</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> v </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> v </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">in</span><span class="token plain"> dotenv</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">dotenv_values</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"azureopenai.env"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">items</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> k </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">not</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">in</span><span class="token plain"> ENV </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">or</span><span class="token plain"> ENV</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">k</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">is</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">required_env_vars </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">"AZURE_OPENAI_ENDPOINT"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"AZURE_OPENAI_KEY"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"AZURE_OPENAI_API_VERSION"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"AZURE_OPENAI_CHATGPT_DEPLOYMENT"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">missing_vars </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">var </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> var </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">in</span><span class="token plain"> required_env_vars </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">not</span><span class="token plain"> ENV</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">var</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> missing_vars</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">raise</span><span class="token plain"> KeyError</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">f"Missing required environment variables: </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string-interpolation interpolation string" style="color:rgb(255, 121, 198)">', '</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string-interpolation interpolation">join</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string-interpolation interpolation">missing_vars</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Check if the Authentication environment variable is set to Azure</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> os</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">getenv</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"AUTHENTICATION"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">==</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"AZURE"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    token_provider </span><span class="token operator">=</span><span class="token plain"> get_bearer_token_provider</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">DefaultAzureCredential</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"https://cognitiveservices.azure.com/.default"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    client </span><span class="token operator">=</span><span class="token plain"> AzureOpenAI</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        api_version</span><span class="token operator">=</span><span class="token plain">ENV</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">"AZURE_OPENAI_API_VERSION"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        azure_endpoint</span><span class="token operator">=</span><span class="token plain">ENV</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">"AZURE_OPENAI_ENDPOINT"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        azure_ad_token_provider</span><span class="token operator">=</span><span class="token plain">token_provider</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    client </span><span class="token operator">=</span><span class="token plain"> AzureOpenAI</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        api_version</span><span class="token operator">=</span><span class="token plain">ENV</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">"AZURE_OPENAI_API_VERSION"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        azure_endpoint</span><span class="token operator">=</span><span class="token plain">ENV</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">"AZURE_OPENAI_ENDPOINT"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        api_key</span><span class="token operator">=</span><span class="token plain">ENV</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">"AZURE_OPENAI_KEY"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>This is assuming you are using the System Managed identity; however, if you want to run with a User Assigned Managed identity. Make sure you have an environment variable of <strong>AZURE_CLIENT_ID</strong> to the value of the CLIENT ID of the User Assigned managed identity.</p></div></div>
<p>When deployed to an <a href="https://learn.microsoft.com/azure/container-apps/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Container Apps</a> environment, I have set the operating system environment variables set to use Managed Identities. This is done by setting the <code>AUTHENTICATION</code> environment variable to <code>AZURE</code> and using the <a href="https://learn.microsoft.com/en-us/python/api/azure-identity/azure.identity.defaultazurecredential?view=azure-python&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">DefaultAzureCredential</a> class to authenticate with Azure services.</p>
<p><img decoding="async" loading="lazy" alt="Container Apps - Environment variables" src="https://luke.geek.nz/assets/images/ContainerApps_AzureOpenAIEnvVariables-650eb1d409e0b93874b81dca4ea1adb9.png" width="2152" height="1103" class="img_ev3q"></p>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Azure Region Provider Comparison]]></title>
            <link>https://luke.geek.nz/azure/azure-region-provider-comparison/</link>
            <guid>https://luke.geek.nz/azure/azure-region-provider-comparison/</guid>
            <pubDate>Sat, 30 Nov 2024 08:14:09 GMT</pubDate>
            <description><![CDATA[Compare the capabilities and services available in the new Azure region, for example, New Zealand North, with those in Australia East.]]></description>
            <content:encoded><![CDATA[<p>With the release of the <a href="https://datacenters.microsoft.com/globe/explore?info=region_newzealandnorth" target="_blank" rel="noopener noreferrer">New Zealand North</a> Azure Region on the horizon, I wanted a way to measure what capabilities are being deployed in the new region that could be used, particularly in comparison to Australia East.</p>
<p>To do so, I wrote a script that uses <a href="https://learn.microsoft.com/powershell/scripting/overview?view=powershell-7.4&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">PowerShell</a> to query the <a href="https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/azure-services-resource-providers?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">provider namespaces</a> of each <a href="https://azure.microsoft.com/explore/global-infrastructure/products-by-region?WT.mc_id=AZ-MVP-5004796#products-by-region_tab4" target="_blank" rel="noopener noreferrer">region</a>, compare them side by side, and output the results into an HTML table.</p>
<p><img decoding="async" loading="lazy" alt="Azure Region Provider Comparison" src="https://luke.geek.nz/assets/images/RegionCompare_AustraliaVsNZN-a55f12104031992070b5ce87e173f82a.png" width="1512" height="530" class="img_ev3q"></p>
<p>There are bound to be differences between the regions, especially when Strategic Services, such as Azure OpenAI <em>(Cognitive Services)</em>, are involved, especially for such a new region, especially at the time of writing when not all <a href="https://learn.microsoft.com/azure/reliability/availability-service-by-category?WT.mc_id=AZ-MVP-5004796#service-categories-across-region-types" target="_blank" rel="noopener noreferrer">Foundational and Mainstream services</a> may have been deployed.</p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>Using the Providers is not a full-proof way of comparing the regions; however, for my purposes, it largely helps to identify the capabilities, especially when compared to the <a href="https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/azure-services-resource-providers?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure services table</a>. Its also worth mentioning, that this comparison won't touch on some services or capabilities, that may be may have preview capabilities delivered to specific regions as a sub-feature of that namespace.</p></div></div>
<p>The PowerShell script can be found below:</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">RegionProvider_Compare.ps1</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Get the current date in an easy-to-read format</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$currentDate</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-Date</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Format </span><span class="token string" style="color:rgb(255, 121, 198)">"MMMM dd, yyyy"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token namespace">[string]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$location1</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"New Zealand North"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token namespace">[string]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$location2</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"Australia East"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Get-ProviderNamespaces</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[string]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$location</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Validate location parameter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">-not</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$location</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">throw</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Location parameter is required."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">try</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$providers</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzResourceProvider</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$providerNamespaces</span><span class="token plain"> = @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">foreach</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$provider</span><span class="token plain"> in </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$providers</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$providerNamespace</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$provider</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ProviderNamespace</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceTypes</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$provider</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ResourceTypes </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Where-Object</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Locations </span><span class="token operator">-contains</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$location</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceTypes</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$providerNamespaces</span><span class="token plain"> </span><span class="token operator">+=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$providerNamespace</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$providerNamespaces</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Sort-Object</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Unique</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Error</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Failed to get provider namespaces for location </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$location</span><span class="token string" style="color:rgb(255, 121, 198)"> : </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">throw</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token plain"> Create-ComparisonTable </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[array]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$providerNamespaces1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[array]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$providerNamespaces2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$table</span><span class="token plain"> = @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$maxLength</span><span class="token plain"> = </span><span class="token namespace">[math]</span><span class="token plain">::Max</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$providerNamespaces1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Count</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$providerNamespaces2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Count</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$i</span><span class="token plain"> = 0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$i</span><span class="token plain"> </span><span class="token operator">-lt</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$maxLength</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$i</span><span class="token operator">++</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$provider1</span><span class="token plain"> = </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$i</span><span class="token plain"> </span><span class="token operator">-lt</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$providerNamespaces1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Count</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$providerNamespaces1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">""</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$provider2</span><span class="token plain"> = </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$i</span><span class="token plain"> </span><span class="token operator">-lt</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$providerNamespaces2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Count</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$providerNamespaces2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">""</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$missingInLocation1</span><span class="token plain"> = </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$provider2</span><span class="token plain"> </span><span class="token operator">-and</span><span class="token plain"> </span><span class="token operator">-not</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$providerNamespaces1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Contains</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$provider2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$provider2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Trim</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">""</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$provider1</span><span class="token plain"> </span><span class="token operator">-or</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$provider2</span><span class="token plain"> </span><span class="token operator">-or</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$missingInLocation1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$table</span><span class="token plain"> </span><span class="token operator">+=</span><span class="token plain"> </span><span class="token namespace">[PSCustomObject]</span><span class="token plain">@</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$location1</span><span class="token string" style="color:rgb(255, 121, 198)"> (</span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$providerNamespaces1</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Count</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">)"</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$provider1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$location2</span><span class="token string" style="color:rgb(255, 121, 198)"> (</span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$providerNamespaces2</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Count</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">)"</span><span class="token plain">    = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$provider2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token string" style="color:rgb(255, 121, 198)">"Missing in </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$location1</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain">                      = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$missingInLocation1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$table</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Generate the HTML report with the date in the title</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token plain"> Generate-HTMLReport </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[array]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$comparisonTable</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[string]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$location1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[string]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$location2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$html</span><span class="token plain"> = @</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">&lt;!DOCTYPE html&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">&lt;html&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">&lt;head&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    &lt;title&gt;Azure Provider Namespaces Comparison - </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$currentDate</span><span class="token string" style="color:rgb(255, 121, 198)">&lt;/title&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    &lt;style&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        table { </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            width: 100%; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            border-collapse: collapse; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            font-family: Arial, sans-serif; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            margin: 20px 0; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            border-radius: 5px 5px 0 0; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            overflow: hidden; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            box-shadow: 0 0 20px rgba(0, 0, 0, 0.15); </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        th, td { </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            padding: 12px 15px; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            text-align: left; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        th { </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            text-transform: uppercase; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            font-weight: bold; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        th:nth-child(1) { </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            background-color: #4CAF50; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            color: white; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        th:nth-child(2) { </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            background-color: #2196F3; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            color: white; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        th:nth-child(3) { </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            background-color: #FF9800; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            color: white; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        tr { </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            border-bottom: 1px solid #dddddd; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        tr:nth-child(even) { </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            background-color: #f3f3f3; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        tr:last-child { </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            border-bottom: 2px solid #009879; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        tr:hover { </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            background-color: #f1f1f1; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    &lt;/style&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">&lt;/head&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">&lt;body&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    &lt;h1&gt;Azure Provider Namespaces Comparison&lt;/h1&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    &lt;p&gt;Comparison of &lt;a href="</span><span class="token plain">https:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token plain">learn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">microsoft</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">com/en-us/azure/azure-resource-manager/management/azure-services-resource-providers?WT</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">mc_id=AZ-MVP-5004796</span><span class="token string" style="color:rgb(255, 121, 198)">"&gt;provider namespaces&lt;/a&gt; between &lt;strong&gt;</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$location1</span><span class="token string" style="color:rgb(255, 121, 198)">&lt;/strong&gt; and &lt;strong&gt;</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$location2</span><span class="token string" style="color:rgb(255, 121, 198)">&lt;/strong&gt; as of </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$currentDate</span><span class="token string" style="color:rgb(255, 121, 198)">.&lt;/p&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    &lt;table&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        &lt;tr&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            &lt;th&gt;</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$location1</span><span class="token string" style="color:rgb(255, 121, 198)"> (</span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$providerNamespaces1</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Count</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">)&lt;/th&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            &lt;th&gt;</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$location2</span><span class="token string" style="color:rgb(255, 121, 198)"> (</span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$providerNamespaces2</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Count</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">)&lt;/th&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            &lt;th&gt;Missing in </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$location1</span><span class="token string" style="color:rgb(255, 121, 198)">&lt;/th&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        &lt;/tr&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain">@</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">foreach</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$row</span><span class="token plain"> in </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$comparisonTable</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$html</span><span class="token plain"> </span><span class="token operator">+=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"&lt;tr&gt;"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$html</span><span class="token plain"> </span><span class="token operator">+=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"&lt;td&gt;$(</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$row</span><span class="token string" style="color:rgb(255, 121, 198)">."</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$location1</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">$</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$providerNamespaces1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Count</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">")&lt;/td&gt;"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$html</span><span class="token plain"> </span><span class="token operator">+=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"&lt;td&gt;$(</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$row</span><span class="token string" style="color:rgb(255, 121, 198)">."</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$location2</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">$</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$providerNamespaces2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Count</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">")&lt;/td&gt;"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$html</span><span class="token plain"> </span><span class="token operator">+=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"&lt;td&gt;$(</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$row</span><span class="token string" style="color:rgb(255, 121, 198)">."</span><span class="token plain">Missing in </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$location1</span><span class="token string" style="color:rgb(255, 121, 198)">")&lt;/td&gt;"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$html</span><span class="token plain"> </span><span class="token operator">+=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"&lt;/tr&gt;"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$html</span><span class="token plain"> </span><span class="token operator">+=</span><span class="token plain"> @</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    &lt;/table&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    &lt;h2&gt;Service Categories&lt;/h2&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    &lt;ul&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        &lt;li&gt;&lt;strong&gt;&lt;a href="</span><span class="token plain">https:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token plain">learn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">microsoft</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">com/azure/reliability/availability-service-by-category?WT</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">mc_id=AZ-MVP-5004796</span><span class="token comment" style="color:rgb(98, 114, 164)">#available-services-by-region-category"&gt;Foundational&lt;/a&gt;&lt;/strong&gt;: Available in all recommended and alternate regions when the region is generally available, or within 90 days of a new foundational service becoming generally available.&lt;/li&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &lt;li&gt;&lt;strong&gt;&lt;a href=</span><span class="token string" style="color:rgb(255, 121, 198)">"https://learn.microsoft.com/azure/reliability/availability-service-by-category?WT.mc_id=AZ-MVP-5004796#available-services-by-region-category"</span><span class="token plain">&gt;Mainstream&lt;</span><span class="token operator">/</span><span class="token plain">a&gt;&lt;</span><span class="token operator">/</span><span class="token plain">strong&gt;: Available in all recommended regions within 90 days of the region general availability</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain"> Demand-driven in alternate regions</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> and many are already deployed into a large subset of alternate regions</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">&lt;</span><span class="token operator">/</span><span class="token plain">li&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &lt;li&gt;&lt;strong&gt;&lt;a href=</span><span class="token string" style="color:rgb(255, 121, 198)">"https://learn.microsoft.com/azure/reliability/availability-service-by-category?WT.mc_id=AZ-MVP-5004796#strategic-services"</span><span class="token plain">&gt;Strategic&lt;</span><span class="token operator">/</span><span class="token plain">a&gt;&lt;</span><span class="token operator">/</span><span class="token plain">strong&gt;: Targeted service offerings</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> often industry-focused or backed by customized hardware</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain"> Demand-driven availability across regions</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">&lt;</span><span class="token operator">/</span><span class="token plain">li&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &lt;</span><span class="token operator">/</span><span class="token plain">ul&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &lt;p&gt;Note: The rollout schedule </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> services may vary based on their category and region</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> with Foundational Services being prioritized </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> early adoption</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> followed by Mainstream services </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">+</span><span class="token plain">90 days after GA</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> and </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">finally</span><span class="token plain"> Strategic services as demand requirements</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain"> Make sure you let your Microsoft account team know </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> a Strategic Service is required in your region</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">&lt;</span><span class="token operator">/</span><span class="token plain">p&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&lt;</span><span class="token operator">/</span><span class="token plain">body&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&lt;</span><span class="token operator">/</span><span class="token plain">html&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token string" style="color:rgb(255, 121, 198)">"@</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    return </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$html</span><span class="token string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)"># Main script execution</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">try {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    Write-Host "</span><span class="token plain">Fetching provider namespaces </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$location1</span><span class="token plain"> and </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$location2</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string" style="color:rgb(255, 121, 198)">" -ForegroundColor Green</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$providerNamespaces1</span><span class="token string" style="color:rgb(255, 121, 198)"> = Get-ProviderNamespaces -location </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$location1</span><span class="token string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$providerNamespaces2</span><span class="token string" style="color:rgb(255, 121, 198)"> = Get-ProviderNamespaces -location </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$location2</span><span class="token string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$comparisonTable</span><span class="token string" style="color:rgb(255, 121, 198)"> = Create-ComparisonTable -providerNamespaces1 </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$providerNamespaces1</span><span class="token string" style="color:rgb(255, 121, 198)"> -providerNamespaces2 </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$providerNamespaces2</span><span class="token string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    Write-Host "</span><span class="token plain">Generating HTML report</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string" style="color:rgb(255, 121, 198)">" -ForegroundColor Green</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$htmlReport</span><span class="token string" style="color:rgb(255, 121, 198)"> = Generate-HTMLReport -comparisonTable </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$comparisonTable</span><span class="token string" style="color:rgb(255, 121, 198)"> -location1 </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$location1</span><span class="token string" style="color:rgb(255, 121, 198)"> -location2 </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$location2</span><span class="token string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$reportPath</span><span class="token string" style="color:rgb(255, 121, 198)"> = "</span><span class="token plain">AzureProviderComparisonReport</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">html</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$htmlReport</span><span class="token string" style="color:rgb(255, 121, 198)"> | Out-File -FilePath </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$reportPath</span><span class="token string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    Write-Host "</span><span class="token plain">HTML report generated at </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$reportPath</span><span class="token string" style="color:rgb(255, 121, 198)">" -ForegroundColor Green</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">catch {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    Write-Error "</span><span class="token plain">An error occurred: </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token plain">"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It will output an HTML report in the directory that the script has been run from <em>(make sure you are authenticated to Azure first and have the <a href="https://learn.microsoft.com/powershell/azure/new-azureps-module-az?view=azps-13.0.0&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Az PowerShell</a> modules installed)</em>:</p>
<p><img decoding="async" loading="lazy" alt="Azure Region Provider Comparison" src="https://luke.geek.nz/assets/images/RegionCompare_HTMLReport-c06d337c9e48530f9941b6a8d48e855b.jpg" width="6000" height="10192" class="img_ev3q"></p>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Request is badly formatted Error with Azure OpenAI]]></title>
            <link>https://luke.geek.nz/azure/openai-request-badly-formatted/</link>
            <guid>https://luke.geek.nz/azure/openai-request-badly-formatted/</guid>
            <pubDate>Tue, 26 Nov 2024 19:48:56 GMT</pubDate>
            <description><![CDATA[Learn how to resolve the 'Request is badly formatted' error when using Azure OpenAI with Managed Identity in a container app.]]></description>
            <content:encoded><![CDATA[<p>When attempting to call <a href="https://learn.microsoft.com/azure/ai-services/openai/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure OpenAI</a> using a <a href="https://learn.microsoft.com/entra/identity/managed-identities-azure-resources/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Managed Identity</a>, you may encounter the following error:</p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">ERROR:root:Error generating response: Error code: 400 - {'error': {'code': 'Request is badly formated', 'message': 'Resource Id is badly formed or from wrong namespace: NA'}}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">2024-11-26T18:57:08.224640325Z ERROR:root:Response content: b'{"error":{"code":"Request is badly formated","message":"Resource Id is badly formed or from wrong namespace: NA"}}'</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<p>I had issues when attempting to call the Azure OpenAI endpoint from an <a href="https://learn.microsoft.com/azure/container-apps/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Container App</a> using a Managed Identity. The error message that was getting returned to my App was:</p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>An error generating a reponse.</p></div></div>
<p><img decoding="async" loading="lazy" alt="Error" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAvAAAAFGCAYAAAAM3auPAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAACZ0SURBVHhe7d17dFTloffx34TMkMsAiRhDkCDGEgFtfA+BxkgLWEQscAz0RMELFW3RoohFLfLamtOTthxECwulUqSiNuILHo5AV1FRORVsQY6G1qiEhhovQUK4JcAkk8wkmfePmcBkk8vkIskz+X7WYi149p6dZ/bM6Dc7z0xsPp/PJwAAAABGiLAOAAAAAOi+CHgAAADAIAQ8AAAAYBACHgAAADAIAQ8AAAAYhIAHAAAADELAAwAAAAYh4AEAAACD2LrbL3Jyu6t18uQpVVZWyev1qptNDwAAAGiRzWaT3W5XbGyM+vXrq+joKOsuHdKtAv7w4SNyuVyKj4+T0xkrh8Mhm81m3Q0AAADotnw+nzwej1yuSpWXV8jpdGrAgIusu7Vbtwn4L788KLvdrgEDLiLaAQAAEBZ8Pp8OHz4ir9erwYMHWTe3S7cI+MOHj8jn8ykpKdG6CQAAADBeaWmZbDZbp1yJ7/I3sbrd1XK5XJ1yZwAAAIDuaMCAi+RyueR2V1s3tVmXB/zJk6cUHx/HshkAAACELZvNpvj4OJ08ecq6qc26POArK6vkdMZahwEAAICw4nTGqrKyyjrcZl0e8F6vVw6HwzoMAAAAhBWHwyGv12sdbrMuD3ifz8fyGQAAAIQ9m83WKb/jqMsDHgAAAEDoCHgAAADAIAQ8AAAAYBACHgAAADAIAQ8AAAAYhIAHAAAADELAAwAAAAYh4AEAAACDEPAAAACAQQh4AAAAwCAEPAAAAGAQAh4AAAAwCAEPAAAAGISABwAAAAxieMB7dPr4CZ32NB6tOX1Cx62DAAAAQBgwPOClD1f8QLeuPRA0ckC//8EPtOxvQUMAAABAmDA84B369u3TpQ0b9JeqwNAHr+mV6Fm6d6zDsi8AAABgPsMDXlLqLC3IeFu/f+2EpBPa/PutGn3XdF0sSac/Ud5P79C4jPEaee0c/eyPX6im4XaHNmn+jav0/pkDleqV+bdo+R7/v05/sEHLX/vizFYAAACgOzA/4OXQd++apePrNml/0SY9VzZDP7rOIalUefct0OtDFupPu97R3k2zpN/eoZ9tc/lvVufRsUPHzwa9pJpjpTpWI0kevb9plfLWv6evgrYDAAAAXS0MAj5wFf7yDZo9e4Muv2+WhknSvtf0yj/G6t4fX6E+vSTFjVXOg2P1P+u2hhDlDn333/+kHb+b4b+SDwAAAHQT4RHwcui7k8fK4xmrydcG1r4fK9VXlw3Vpb3O7tU72iH940t9dnaoeQ6n+sRYBwEAAICuFSYBf5ajIdj79lGf0sM6HryxTtJlg3Vp8BgAAABgkLAL+DO+eZ2+53hLG95uWPP+hfKef1vDbhjrXxYzMEmX6hO9/5F/8+kPXtHmT8/enDexAgAAoDsK34DvdYUWrZ6r08u+r3GTb9HE6+7TK0N+rqdvSwpsH6sZt9Yo70dTNXHyVM3+83c0a1LDjXkTKwAAALonm8/n81kHz6fCwiINH55qHe5UNRUn5HFc0OSa9prTJ+SSU/37WD433uPS6VrWwQMAAKDzdEb7hu8V+CC945qOd0nq3eeCc+NdvIkVAAAA3VOPCHgAAAAgXBDwAAAAgEEIeAAAAMAgBDwAAABgEAIeAAAAMAgBDwAAABiEgAcAAAAMQsADAAAABiHgAQAAAIPYfD6fzzp4PnXGr5MNVldXL4+3VrV19aqv79K7BgAAAENFRNgU2StCDnukevXqvGvendG+nTebbsBd7VGV2xMId5t1MwAAABAim+rrfapye+Su9lg3dqmwCfhKt0d19T7V+3yBq+/11l0AAACAkNTX1/ub0udTXb1Ple7uE/FhEfDuao98Pp/q6oh2AAAAdK66unr5fL5ucyXe+ICvq6tXbW098Q4AAICvTXdqTuMD3uOtVUQE690BAADw9YqIsMnjrbUOn3fGB7x/bZJ1FAAAAOhc9T5/e3Y14wO+vt7HG1YBAADwtauv7x4fU258wAMAAAA9CQEPAAAAGISABwAAAAxCwAMAAAAGIeABAAAAgxDwAAAAgEEIeAAAAMAgBDwAAABgEAIeAAAAMAgBDwAAABiEgAcAAAAMQsADAAAABiHgAQAAAIMQ8AAAAIBBCHgAAADAIAQ8AAAAYBACHgAAADAIAQ8AAAAYhIAHAAAADELAAwAAAAYh4AEAAACDEPAAAACAQQh4AAAAwCAEPAAAAGAQAh4AAAAwCAEPAAAAGISABwAAAAxCwAMAAAAGIeABAAAAgxDwAAAAgEEIeAAAAMAgBDwAAABgEAIeAAAAMAgBDwAAABiEgAcAAAAMQsADAAAABiHgAQAAAIMQ8AAAAIBBCHgAAADAIAQ8AAAAYBACHgAAADAIAQ8AAAAYhIAHAAAADELAAwAAAAYh4AEAAACDEPAAAACAQQh4AAAAwCAEPAAAAGAQAh4AAAAwCAEPAAAAGISABwAAAAxCwAMAAAAGIeABAAAAgxDwAAAAgEEIeAAAAMAgBDwAAABgEAIeAAAAMAgBDwAAABiEgAcAAAAMQsADAAAABiHgAQAAAIMQ8AAAAIBBCHgAAADAIAQ8AAAAYBACHgAAADAIAQ8AAAAYhIAHAAAADELAAwAAAAYh4AEAAACDEPAAAACAQQh4AAAAwCAEPAAAAGAQAh4AAAAwCAEPAAAAGISABwAAAAxCwAMAAAAGIeABAAAAgxDwAAAAgEEIeAAAAMAgBDwAAABgEAIeAAAAMAgBDwAAABiEgAcAAAAMQsADAAAABiHgAQAAgFb85IF51qEuQ8ADAAAALfjJA/O0evVq63CXIeABAACAZjTEu7vaa93UZYwP+IgImyIijL8bAAAA6Gas8R4REaGICJt1t/PO+PKN7BWhbnAeAQAAEEas8f6TB+YpwuZvz67W9TPoIIc9UvX1PuswAAAA0C5Nxfvq1atVX++Twx5p3f28Mz7ge/WKUGRkhHp1g++GAAAAYLbm4t3jres2zdn1M+gE0VEO2Wy2bnFCAQAAYKaW4t1msyk6ymG9SZew+Xy+Ll1/UlhYpOHDU63D7eKu9qi2tl4RETbV+6T6+nrrLgAAAECrIiL877Osr/cpMjKi0+K9M9o3rC5ZR0c5FBPtCLw7uEu/LwEAAIDRfIqIsCkm2tFp8d5ZwuoKPAAAANCddUb7htUVeAAAACDcEfAAAACAQQh4AAAAwCAEPAAAAGAQAh4AAAAwCAEPAAAAGISABwAAAAxCwAMAAAAGIeABAAAAgxDwAAAAgEEIeAAAAMAgBDwAAABgEAIeAAAAMAgBDwAAABiEgAcAAAAMYvP5fD7r4PlUWFik4cNTrcPt5na7VVFxSlVVbnk8HutmIzgcDsXERCsurq+io6OtmwEAAGCozmjfsAr40tIyVVScVL9+fRUbG6OYmBjZ7ZHW3bo1r7dWHq9HJytOqaqqSrGxsUpKSrTuBgAAAAN1RvuGzRKaL7/8Sh6vR9/4RooGDhygfv36GhfvkmS3Ryo2JkYDBw7QJZcMlsfr0ZdffmXdDQAAAD1UWAR8aWmZfKrXJYOTjYz25tjtkbpkcLI8nhqVlpZZNwMAAKAHMj7g/WveT2pgUpJ1U9i45JLBqqyslNvttm4CAABAD2N8wFdUnNKFF14QVlferez2SPXr11cVFaesmwAAANDDGB/wVVVuxcTGWIfDTkxsjKqquAIPAADQ0xkf8B6PR7Ex4R/wsTExxn4sJgAAADqP8QEPAAAA9CQEPAAAAGAQAh4AAAAwCAEPAAAAGISABwAAAAxCwJ9nNZ/v1f/s+UI11g0AAABACHp0wNeUvKe8ZU8o99dPKHfZBv2l5Ov/mMZjO1fp4RXv6Zh1AwAAABCCnhvwf1+lqdk52lzq1KWXD1af0rf1s+yZ+tlOl3VPAAAAoNvooQHv0evrNsgzfYn++4m5mpU9QwueWKM3Ny7Xg2Oc1p0BAACAbqOHBvxxHSuzjkm9ky9R/15BAxWfKO+nt+jqUeM18to79PDGoLXrhzZp/oznVBC0z9XTc7T586DbSzr90QY9nD1VI0eN17gfrNA/IpMa7wAAAAC0QQ8N+CRNu22sTm9cpH9bslX7K6zbJVW9p9wZ9+n1IT/V1p1vavfzN0tr7lPuzsA6+TqPjn26VQ/dkyfNWKat29ZoTp+dyv3VJh1vOMbnG3TPj1bp0DU/139ve1UvL/qG/vLqzqAvAgAAALRNDw14qc+kXL31xHRduPMJ3Xrd9frX+1bpf4LexPrVxue0OfkBPX3fSPWPcaj3kCn6vz9O1evb3gs+imY+vkSzRiWpf/+h+uGd10l//0SFga1/WbtK+7/5gJ5+8Gpd2v8CXTxiin5449Cg2wMAAABt02MDXpL6XztXq197U2/9bq7Sjm3Sw9Mb3sTqUcFHB9TH8zf99teBT6n59RP67dul0mel+urMERxyBC+5Cf67SvXZP6VhY69W/+BhAAAAoAN6dMD7OdR/1HT9esOrenKSR6//fqu+kks1pyXHwCv07YyMs3+mz9WTD1ytC62HaJJLp9zWMQAAAKBjemzA13isn/nu1OWXJ0kVLp3WBUq5zKnjVU6Nvm6svhv8J+MS9bbcsmn9dXGi9NWhUusGAAAAoN16ZsAf2aT542dq/h/26nig42uO79Qz6w6o/3eu1jBJaTNnadie5/Qffyw988kzNce/0Fengw/Ukgv0nUkjdXrTKj33aeCLVLynvD8esO4IAAAAhKxnBvxF0/XkMzPk2LRIE68Zr5Gjxitz0q9UkPFzrX/wCv8+yTO0+vdTdHr5Lcq8Zqr+9brrlZn9K23+3Hrlvnn9p+dq9QyP1sy4XiNHjdfIWzfr4pum6GLrjgAAAECIbD6fz2cdPJ8KC4s0fHiqdThkHb19zekTcnkkR58L1Mdh3epXU3FCLjnVP66ZHVpT5dJxt+Ts7wxx+U3TOnpfAQAA0LU6o+d65hX4IL37XKD+/ZuPd0nqHXdB++NdkmKc6t/BeAcAAABEwAMAAABmIeABAAAAgxDwAAAAgEEIeAAAAMAgBDwAAABgkLAIeK+31joUdnrCfQQAAEDrjA94h8Mhjzf0X65kKo/XI4ejAx9lCQAAgLBgfMDHxESrqrLKOhx2qiqrFBMTbR0GAABAD2N8wMfF9dWxYyfCeomJ11urY8dOKC6ur3UTAAAAehjjAz46Olpxcf10qLTUuilsHCotVVxcP0VHcwUeAACgpzM+4CUpKSlRNkXoiy9LwupKvNdbqy++LJFNEUpKSrRuBgAAQA8UFgEvSYMHXyyH3aF//rNYR48eU2VVlbExf/LkKR06dFj//GexHHaHBg++2LoLAAAAeiibz+fzWQfPp8LCIg0fnmodbje3262KilOqqnLL4zHz02kcDodiYqIVF9eXZTMAAABhpDPaN+wCHgAAAOiuOqN9w2YJDQAAANATEPAAAACAQQh4AAAAwCAEPAAAAGAQAh4AAAAwCAEPAAAAGISABwAAAAzS5QFvs9nUxR9FDwAAAHztfD6fbDabdbjNujzg7Xa7sb8xFQAAAAiVx+OR3W63DrdZlwd8bGyMXK5K6zAAAAAQVlyuSsXGxliH26zLA75fv74qL69gGQ0AAADCls/nU3l5hfr162vd1GZdHvDR0VFyOp06fPiIdRMAAAAQFg4fPiKn06no6Cjrpjbr8oCXpAEDLpLX61VpaRlX4gEAABA2fD6fSkvL5PV6NWDARdbN7WLzdaNiPnz4iFwul+Lj4+R0xsrhcHTKO3UBAACA88Xn88nj8cjlqlR5eYWcTmenxbu6W8BLkttdrZMnT6myskper5cr8gAAADCKzWaT3W5XbGyM+vXr2ynLZoJ1u4AHAAAA0LxusQYeAAAAQGgIeAAAAMAgBDwAAABgEAIeAAAAMAgBDwAAABiEgAcAAAAMQsADAAAABiHgAQAAAIMQ8AAAAIBBCHgAAADAIAQ8AAAAYBACHgAAADAIAQ8AAAAYhIAHAAAADELAAwAAAAax+Xw+n3WwS9XWStXVktcr1ddbtwIAAADdX0SEZLdLUVFSZKR1a4d0r4B3uaSaGusoAAAAYK7evSWn0zrabt0n4E+d8l91BwAAAMKN3S717WsdbZfusQbe5SLeAQAAEL68Xn/zdoKuD/jaWpbNAAAAIPzV1Pjbt4O6PuCrq60jAAAAQHjqhPbt+oBn6QwAAAB6ik5o364PeD4qEgAAAD1FJ7Rv1wc8AAAAgJAR8AAAAIBBCHgAAADAIAQ8AAAAYBACHgAAADAIAQ8AAAAYhIAHAAAADELAAwAAAAYh4AEAAACDEPAAAACAQQh4AAAAwCAEPAAAAGAQAh4AAAAwCAEPAAAAGISAR9c7Vqz8d4tVbh1vh/IDu5V/oMI63JjXq9qz/1Dp3t3aV+JttEuP1Oi8nCed+NgDANBThFXAV3+8RetXvKJ91IBZPt2kLYs3qcQ63g4lW5Zoy5ZPrcNB8rV+erZyV+QH/n1C+55bom17Tlj262ms5+U86cTHHgCAniKMAt6rDzetVdH2ddqxp5UrsOjBhmnk7Ikac+0w64YeJF/rpy7Q9kPBY1//eTn66gLlPHmev0EAACAMhU/Au3ercFemxt2TqdLtu/iRPJoRq9TseZqUFmvd0KPU1llHzsN5qbcOAACA9rD5fD6fdfC8On7cOtIurjce09I/j9XCRVLerW9rRN7jGndhw9Yy/TUnVxU3L9XQ/U9r8x92y6VEpdz7mGbfkNz4QA3qKlW0KbBvfaycGbfrlkWTlWyXVPaa1vyiXON+maK9uU9rX3G6sjY9pPSP1mrpG9/QrO+Xa9sTeSp23Ky5q25W0sl8bV26VvkfHlRt9CAl3XiXZt2aLmevwNfa28ztGk3Iq5I3n9Lmtbt19KQUNSxT4x6YrzFD7Gd3aZjzht1yueyKGjZRk352j9IvlHRyv7Y/9bT+uuegaiNilXD9/bp9bqbie5XprzmPaV/GLzVnSmLgQAXaPHulNP9ZTRvZnvu7X9ufWqa/7ipTrXOQUmYv0u1TkhXZMM9ju7X+10+raH+lNDBTY266SAUryjXh9YeUdvbeSN58rZ+zWlEN85Dk2r5Ez+TFa+pz92hEL0nyKn/5ffrfSx7T3O8nq+DJLG3UIt2fUaD1T72mo+5YJWQt0pw5aYqSAs+F4Ptbpu333a2Ca5/VguzA/W/psbeqK9Ge5Su1fed+VStWzguc/vHB03Rn7mQltHisEJ+XLZ3Ppp47K6dLu/K0Oe9tlZZUSs4UjVjw75p5TZx//6feVnVZpXRhoqJ6Sanzn9W0keeel1DmVl2wTs+v3KrSkkpFBo4nNRyzYS//sXcUlqm6JnCOGs7Pnt8o5xdS1nPX6MCSp7XvQKUih2Zp5uK7lBo4lW15PPatuVv/m/KYxpav08Y/7Jb9tpVaMCNZtYd2a2PD8fsNU9pDOZo2OvDNimu/ti9v/NqYeU+mEuyB413ymK45tc7/unLHKuGGhtdOw1dt5bXZ8PpZkq6SwOOogZma8ItFGtNwKluYg+TV0XfX+p/PLruihk3WtF/cpRH9Gr4+AMA4/ftbR9okTK7AV+jDPxco6drRcsaPVlrafu2zLKOpPn5QHy5eqB2arDtffFGzb4tV8YqV2nGs0W4BXu1bea9e2pmsaWs3Kue/Hte4Xhv0/Ip8VUtSnVeuzz/Q1txXFDnrcS184ce6wi7JWy5X0SatX1aoSxf9VvcvnqIkV75empurD2OnaU7ei1r4xDT1eTNXTy0PHEvN3K7RfKTSjQu15qmDSnn0t1r48m+VPfKIts9bqO1nFg8H5vyqR+mPPevfZ4xdLpdXcudr/dxHtMd7vWY+96IWrlmkEb3L5QpcEa0+XiaXO+iLyStXWZlcDe/rbMv9DXytfcnzdP+rG5WzbJq07hGt3xM4mCtfL81fouKE23X7Cy/qwccmqnrXjqZ/YmK/TMmJZSoqKA4MePXJrgJVV+7QvsKGnT7VZ7tcSkg9G5WRe36nl/amKfvZF3X/I+k6/eoS/angzOYm7m+wVh57y74Fyx/RNvd1mvPfW5Sbl6PU2BOKv+kx3fvQRCWEcKxWn5etnc8mH4Pd2vEnaeRPl2vhyy9q7g8TVbT4N/rrMUnfnKF7H56iPhqk9EeW6t7lS3XDNxvm0vi8tDq3Q1u06pEPlDR/jXJf36i5t6Wo2nG1pj559ph+icp4aKkm/Iukq3+se5cvDZyfgKh8bftlvoY++IwWvrBIKce2aP0LDQ9Y6+cwWO3JMh15dZk2FqUpe82zmj0l2T/Pu3+n6qmP69E/btT9j6ap5D9+fmYJUdELudpRPUVz/muLcl5+XN/q51Jt4L+MtSfLVPzUz7XDPVGznn1R9y+eoahdS7Qmr+E5GcJrs84r1+dvauOiV6SsX+rBl5crI3a3tj312pnnfUtzOPrqQj29qlzfeuJl5fzx98q+6iOtf3SLjjZMAADQ44RHwJe/r4KCYRoxKk5SnEaMHabSd85dRhOdtUhzstOUEB+nlOyblar9Kmnq/Y6HXtO2NwZoQs5tSr3QrsjoZGXMvV0J29/RJ2eWHhQr/vu/UvboZDkvjA1c3ZVUVqnUny7SuKGJSoiPVcmm1SpyZGnmIxOVFB8n55CJuj3nZkVuX63tZxvgnNs14t6tbS8UK3n+rzQlLVHO+ESlzsrRpIxi7cjb7Q+ZQ69p2xtepS3K0YSGfbLv0rghdh3d+pL2eScr+9+zlJoYJ2dimibMafoKZvNCu79Ht76kfRffo9tnpyk+2q7I5InK/sFlKvrzB5Kko2+8pCLvZGU/MlkpiXFyDknXlCmNrrsHiVPq6BS59n4UiJVPVVKYrozp8Sr+IHDyDuSr2J2u1OFnb1Wb/mMteCBTSfFxSvjOzUofUqmSorKzO7QkpMe+QYH2vVOplOsn+q+U9humMdcmq2TnfqmfPeRjtfS8bO18Suc+BnKO1czH71LG0EQ54+OUdMNEpapAn30qyd7wUwKHoi6IkzM+TlEtPA9anNt776g8ZbzGXBkrya6EGyYqpeRt7Tt87jEj+8Up2iHJEStnfJyc/YJ2qE7XpJXzlD4kTs7ETE3IGqTaws/8j3mI5zCYq3qUbnlkslISExXvlApeXqvyGx7S7OuTFWW3Kz7tNk2aUqaCd0skVehoSaWcKSlKipYincnKmDVRSWeurksaP19zZqX7n09pWcq+bZhcW99SkUJ8bUqSnEp/tOG1maJJM8dKHxcG3rzbwhzq8rVtbZnSFi1SxpBYRdrjlDr7HqUdeVN7eecvAPRYYRHwrj07VZp8uZJ6VchVXiF78uVyfrxDBdar670cTf/dorqoUOVOjz5bt1LrVwT+/GGnTuugKs50YIqSU5taL3y5koc2/N2rQ5+XSVdepZTgIBg6TANVpqNfBn90YfDtLA4W60hdilKuDP56sUoZniIVFetow5yVrtRzWtir4sJiKWOUUoPn0Gah3d/iwmJF1hRoW8N5W7FSf3q3TCo5oqOSSj9v21wSrhol54FCFbsDsZ6cpjFpaaou/FQuSUc/+kCujNGNjxcZ/Ng6FNmGZ3loj32DePVJlGrdZx/HalelFO+Usy3HavZ52fr59GviueOtUPG7W7T5l49o6ezfqKhOOlpyzh1oXbNzk/okJEqVrrOR6q5UreLVpx1LO+xBj19k0NcJ+RwGGz5MyWeOV6ySj6Wo0p1nb79ipXYVSuUlRyTFKf22ydKmR5Q7/zfa/n5Zqx+lGX/hRZLroI6Wh/ba9HMoMvg52uj538IcivfrUJ1T5X8Ouv8rNqtUB3W00ZuQAQA9SRvSprvyL5+JPPWeNi9YqGcWLNQzy95Trf3cZTShqq2ulOyJSh6ZrqFn/kzWhEfv1Ih4694tqVStyzp2lru60jrUtJqgSLKqdMndMOcmtTyHzuX/WpEDhgedt3QNveFOZf1wpPrIK6/HeptWDE1XinO3DhRIRz/8QPbRaXIOH6WUT/L1idur4k+KlTS6YX17x7XtsU/RhLvH6tCyn2vz9t3K37pS/+/VWI27LbMdx2pKa+ezGYfe0po7fqQtH8Yo7e4cPfjCco1Jse7UcVHX3KZxfTcpb8kW5b+7U1v/8zkdmnCXxjXztpL26Pg59MhdKUUPSWt0Dr950/3KyrpMkhSVdo8WbnpW08ZK+5berdxZK1UQ6msmhNdmKJqdQ41L1YpXwlXB93+crpm/SNf4pw8A6IHMD/jy91VQkKj0xc9q4Qtn/8z6fmKTy2hC4Rw0SJHlHjn/JVPp3wn+k6akaOveLYlTwpBYqays8TyOlem0YpUwKC54tHkXpyhBZSq3/ESh/HCZlJKigQ1zbvKqXGAOnx1sec1sXVvLuin+r1VdHaMrGp23TKWPTFaU7OoT38T5aNEwpWZIhwrzVfR+pVKvSpR6XaZLr9itAwWFKilI1ODLQjyPIWjrY3/6q4PqkzVNyeWFOqxM3ZK3XBMCAdvWY52rtfPZtKItz6sk7SEtmDdRKYmxZ9883Nk8R3S0OlNjJth1eH+5LsxeqoUPpzc7r/bo+DkcoKQUyR1xkeX2mUofGvS8sScqLfsh3b9+uTIcb2nHm81d3pfKjx2RnIOUEB/aazNkTc3h4hQlqFwaYL3/mUo58yZ9AEBPY3zAu/bsVGniOKVZrjAmjxnX9DKaUFw5TWOG5mv7U2/paMPqCG+FSg81d5W7ealZM5RQ+JK2vBH4sXhdhfY8u0GlQ2do3JXWvZsRP17jbrCrYPVaFZ30D1XvX6dtb9g1Inu8nGqYc7F2LHlFDb9UtPbQbuUfCMzhi7Vav6Ek8KN5r46+u1sldZKUqOQrY1W+c7dK6/yf+LFv1VoVh7jExSo1a4YS9r6k9W+eXQZQW16io4ErmqnfGaeojzdo667AufSWaMfWoHeYNiF1VKZcn2xWQWGaLh2qM2vjD735mkqUrqHW5SMd0abHvkwF24sVlZym9Oy7NGVKupKDl4+06VhNa+18NqvKJVed/I/1my9pzxdB2xIvUoKKVVIU+jyaVPCO9nnilTxysqbMyVJGWmKL3ywkJA+SCvcHnnch6vA5jFN69kTVblqtrR+fvU1tSYnK6ySpQvl5W868riSPvHVSZEzvM/uq8AMVlPu/eO3nW7T+hf1KuGWaUhXia7NVLcwhfrzG3VCjvc+sO7u9zqvSkoafLlaqYOV9Wr6q6Tf1AgDCk+EBX6H87QVyjs/UOT+1H5quFOd+7X2n+StpzUvUhMWP66qTz+vpG7O1ePatyp1+rzZubwjgNhiYpTlPTpH7ubuVe2O2cqfeoW2Hx+n2xVlnP4WjVXaNmLdCUy59T+tnZin3xiwtXrhDfeb9SjNHN7wZMFETFv9SI72vaM2N/n1yf/ySDpyo8M9hcZZq181T7tRs5U7N1qqXC1QeuAyemnW7EkrWadXULOVk3au9wxdpUkbw12+DgVma8+T1cq+5W7k33qqlM7OVe/cy/e/BQH1deY/ufOAyfbn4VuV8L0s5/7ZEpd+ecu7jFyTqqnQlfVyg0tFpavg+LeGqUdKu3SrPGOUPqXZLVPKVcSr/w5LAp4a05bFP1JiZmSpdHrgv38tSzveytXjuEm3fX9nGYzWjtfPZhNSpdyr5nyu1dOYdWnzTHVr/xXiNuSZoh16Z+tb341T8+B1aPDNbq95o31IzjbpZGdFb9MLUhvuepZyb7tDTK3cH4rixpAnTlHz0Fa2Zeatyb13tfxNoqzp+DqNGz9Pchwfpk0dvVc5Nd2jxTVla/It1KjomqU7SyXe0/rZsLZ59txZPf0T7hszTtIlBV+ejyrRnfrZyvpel3Ll5qr4+R3dmNXzkaiivzVa0OIfA8Qfv8B9/1h3KzbpFeXkFgZ+olankbwdV/sH+ln/CBgAIK2HzOfBfG3elXNVSVN/Yxm9CazOvqssrVWuPldMZ4v/YmxLCfGpdFar22hUVb10+0cIc6rxynapUpPPcTxBpr9qTFf7PRg/+xJEG3kq5XC3fj/PHq+pyjyKtc2ntXNft18ZZq9Xn8aWa0LdS1fWSVKNPVi/Q1kMzdP9TQd+ktXasELR4Pq1CeDxrXRWqrgvxeE0of+Mxrfr7ZD34UJpqGz5z9NibWjN/nZJyt2jmaOstQptXszp8Dlt//isqTs6gpTn+3yuQo9yH0/3n39F4eyMdnV8zczjDWymXy3vuufNWqlqxbT+fAICuw+fAf82iY+WMb+f/kBuxKyo+7txwaKsQ5hPpjPPvY93Q0hx62Vv9SMG2iuxn+bjAYPbW78f5E/hmxzqX1s71hzu0zzFKI5Lt/vsaHydnfKIGXuyUomPUqMFaO1YIWjyfViE8npHONhzvHBUq2F6ggVePUpQ98NGQ8XFyDkpWfK9YRTYVoAptXs3q8Dls/fnfZDgHRPZreXuH59faHALn+ZxzZyfeAaCnIeCB9ho+SqmeV5T3i3Xa8+5u5b+7WztW3qfnXx+kSfMmhrj+2VRxGpGZouJlP9H6rf77nr99ndbc/RsdmbJIU0N9fwcAAGgzltAAHeGtUPHfd6lwV7FOK15J12Qq7f+kKL6HXBGtLSlQ/p4P9NlXVYq6OE0jMjKV2rbfENat1boCy5aaumoPAEB7dXAJDQEPAAAAnE8dDHiW0AAAAAAGIeABAAAAgxDwAAAAgEEIeAAAAMAgBDwAAABgEAIeAAAAMAgBDwAAABiEgAcAAAAMQsADAAAABiHgAQAAAIN0fcBHdP0UAAAAgPOiE9q340foKLvdOgIAAACEp05o364P+Kgo6wgAAAAQnjqhfbs+4CMjpd69raMAAABAeOnd29++HdT1AS9JTmen/DgBAAAA6Jbsdn/zdgKbz+fzWQe7jMsl1dRYRwEAAABz9e7dafGubhfwklRbK1VXS16vVF9v3QoAAAB0fxER/qvuUVGdsmwmWPcLeAAAAADN6h5r4AEAAACEhIAHAAAADELAAwAAAAYh4AEAAACDEPAAAACAQQh4AAAAwCAEPAAAAGAQAh4AAAAwCAEPAAAAGISABwAAAAxCwAMAAAAGIeABAAAAgxDwAAAAgEEIeAAAAMAgBDwAAABgEAIeAAAAMAgBDwAAABiEgAcAAAAMQsADAAAABiHgAQAAAIMQ8AAAAIBBCHgAAADAIAQ8AAAAYBACHgAAADAIAQ8AAAAYhIAHAAAADPL/AWGTujmFqnN2AAAAAElFTkSuQmCC" width="752" height="326" class="img_ev3q"></p>
<p>After enabling some logging on my Python application, I was able to review the Console Logs of my Container <em>(running in a Container Apps environment)</em> and found the following error message:</p>
<p><img decoding="async" loading="lazy" alt="Error" src="https://luke.geek.nz/assets/images/Container_ErrorGenertingResponse-82ffd02c715eab0fbc6f4fe083d38664.png" width="2360" height="146" class="img_ev3q"></p>
<p>After some testing, I was able to confirm that I could receive a response using the API keys, but when using the Managed Identity, I got an error message.</p>
<p>My Azure OpenAI instance was created with Infrastructure as Code and I noticed that the endpoint of my Azure OpenAI was:</p>
<div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">https://eastus2.api.cognitive.microsoft.com/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Azure OpenAI" src="https://luke.geek.nz/assets/images/AzureOpenAI_Bad_CognitiveServicesEndpoint-1bd027e13ad28f3b99ee846c59b60384.png" width="1733" height="859" class="img_ev3q"></p>
<p>On an Azure OpenAI instance that was created in the Portal, the endpoint was:</p>
<div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">https://azureopenaitestlol.openai.azure.com/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>So, I made a comparison between the two resources:</p>
<p><img decoding="async" loading="lazy" alt="Azure OpenAI" src="https://luke.geek.nz/assets/images/AzureOpenAI_Diff_CognitiveServicesEndpoint-048593ce8a4f7b52ee779b8cdd37d60b.png" width="1208" height="120" class="img_ev3q"></p>
<p>And my IaC-created Azure OpenAI resource was missing the following:</p>
<ul>
<li>customSubDomainName</li>
</ul>
<p>After some digging, <strong>I found that the <a href="https://learn.microsoft.com/azure/ai-services/cognitive-services-custom-subdomains?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">customSubDomainName</a> is the key to the issue.</strong> When using a Managed Identity, the customSubDomainName is required to be set for Entra ID to be able to authenticate the request</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Custom subdomain names are required to enable features like Microsoft Entra ID for authentication.</p></div></div>
<p>So after updating the Azure OpenAI resource to use the subdomain, updating my environment variables to use the right Azure OpenAI endpoint <em>(and making sure that the CLIENT_ID of the User Assigned Managed identity is correct)</em> I was able to call the Azure OpenAI endpoint using the Managed Identity successfully.</p>
<p><img decoding="async" loading="lazy" alt="Azure OpenAI" src="https://luke.geek.nz/assets/images/App_SuccessfulTest-d9d1d76c691970266c3b04399bb81504.png" width="760" height="825" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="Azure OpenAI" src="https://luke.geek.nz/assets/images/ContainerApp_EnvironmentVariabnles-de22a926d1293554220edd3fb3ea2152.png" width="2188" height="930" class="img_ev3q"></p>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Deploying a Streamlit App to Azure Container Apps]]></title>
            <link>https://luke.geek.nz/azure/deploy-streamlit-to-container-apps/</link>
            <guid>https://luke.geek.nz/azure/deploy-streamlit-to-container-apps/</guid>
            <pubDate>Mon, 18 Nov 2024 05:27:32 GMT</pubDate>
            <description><![CDATA[Learn how to deploy a Streamlit application to Azure Container Apps using Docker and GitHub Codespaces.]]></description>
            <content:encoded><![CDATA[<p><a href="https://streamlit.io/" target="_blank" rel="noopener noreferrer">Streamlit</a> is an excellent tool for creating interactive web applications with Python.</p>
<p>In this post, we will deploy a Streamlit application to <a href="https://learn.microsoft.com/azure/container-apps/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Container Apps</a>. <a href="https://learn.microsoft.com/azure/container-apps/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Container Apps</a> is a fully managed serverless container service that allows you to run your containerized applications without having to manage the underlying infrastructure.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>For this article, you have access to an Azure subscription and have permission to deploy resources. If you don't have an Azure subscription, you can create a <a href="https://azure.microsoft.com/pricing/purchase-options/azure-account?icid=azurefreeaccount&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">free account</a> in just a couple of minutes.</p></div></div>
<p>Today, we are going to take a base Streamlit example application, and deploy it to Azure Container Apps.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>I will be using a GitHub Codespace; feel free to reference my public repository template: <a href="https://github.com/lukemurraynz/Codespace_IaC_Coding" target="_blank" rel="noopener noreferrer">lukemurraynz/Codespace_IaC_Coding</a> as a Codespace template.</p></div></div>
<p><img decoding="async" loading="lazy" alt="Streamlit Application" src="https://luke.geek.nz/assets/images/Streamlit_Demo_Example-e814590fa1eefb337d08774223dd5a21.png" width="1420" height="1270" class="img_ev3q"></p>
<p>Let us start off with the Streamlit application.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">streamlit_app.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> altair </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">as</span><span class="token plain"> alt</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> numpy </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">as</span><span class="token plain"> np</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> pandas </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">as</span><span class="token plain"> pd</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> streamlit </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">as</span><span class="token plain"> st</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">"""</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)"># Welcome to Streamlit!</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">Edit `/streamlit_app.py` to customize this app to your heart's desire :heart:.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">If you have any questions, check out our [documentation](https://docs.streamlit.io) and [community</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">forums](https://discuss.streamlit.io).</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">In the meantime, below is an example of what you can do with just a few lines of code:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">"""</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">num_points </span><span class="token operator">=</span><span class="token plain"> st</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">slider</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"Number of points in spiral"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">10000</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">1100</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">num_turns </span><span class="token operator">=</span><span class="token plain"> st</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">slider</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"Number of turns in spiral"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">300</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">31</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">indices </span><span class="token operator">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">linspace</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> num_points</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">theta </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">2</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> np</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">pi </span><span class="token operator">*</span><span class="token plain"> num_turns </span><span class="token operator">*</span><span class="token plain"> indices</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">radius </span><span class="token operator">=</span><span class="token plain"> indices</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">x </span><span class="token operator">=</span><span class="token plain"> radius </span><span class="token operator">*</span><span class="token plain"> np</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">cos</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">theta</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">y </span><span class="token operator">=</span><span class="token plain"> radius </span><span class="token operator">*</span><span class="token plain"> np</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">sin</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">theta</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">df </span><span class="token operator">=</span><span class="token plain"> pd</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">DataFrame</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">"x"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> x</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">"y"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> y</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">"idx"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> indices</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">"rand"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> np</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">random</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">randn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">num_points</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">st</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">altair_chart</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">alt</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Chart</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">df</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> height</span><span class="token operator">=</span><span class="token number">700</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> width</span><span class="token operator">=</span><span class="token number">700</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">mark_point</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">filled</span><span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">encode</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        x</span><span class="token operator">=</span><span class="token plain">alt</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">X</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"x"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> axis</span><span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        y</span><span class="token operator">=</span><span class="token plain">alt</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"y"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> axis</span><span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        color</span><span class="token operator">=</span><span class="token plain">alt</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Color</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"idx"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> legend</span><span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> scale</span><span class="token operator">=</span><span class="token plain">alt</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Scale</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        size</span><span class="token operator">=</span><span class="token plain">alt</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Size</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"rand"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> legend</span><span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> scale</span><span class="token operator">=</span><span class="token plain">alt</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Scale</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token builtin" style="color:rgb(189, 147, 249)">range</span><span class="token operator">=</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">150</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The next step is to create a <code>requirements.txt</code> file specifying the Streamlit application's dependencies. This will be used to install the Python dependencies for the image.</p>
<div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">requirements.txt</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">altair</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pandas</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">streamlit</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now that we have our Streamlit application, we need to create a Dockerfile to containerize the application. In this example, we use the official Python image from the Docker Hub as the base image. We then copy the application code into the container, install the dependencies, and define the command to run the Streamlit application using port 8080 <em>(the default port for Streamlit is 8501, but we are using 8080 for this example as a common port)</em>.</p>
<div class="language-Dockerfile language-dockerfile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">Dockerfile</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-dockerfile codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Use the official Python image from the Docker Hub</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">FROM python:3.12.7-slim</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Set environment variable for the port</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">ENV PORT=8080</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Expose the port that the application will run on</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">EXPOSE 8080</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Set the working directory inside the container</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">WORKDIR /usr/src/app</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Copy the requirements file into the container</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">COPY requirements.txt ./</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Install the dependencies specified in the requirements file</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">RUN pip install --no-cache-dir -r requirements.txt</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Copy the rest of the application code into the container</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">COPY . .</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Create a non-root user and switch to it</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">RUN useradd -m appuser &amp;&amp; chown -R appuser /usr/src/app</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">USER appuser</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Define the command to run the Streamlit application</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">ENTRYPOINT ["streamlit", "run", "app.py", "--server.port=8080"]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Add labels for metadata</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">LABEL maintainer="luke@luke.geke.nz"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">LABEL version="1.0"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">LABEL description="Streamlit application"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Health check to ensure the application is running</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  CMD curl --fail http://localhost:8080/_stcore/health || exit 1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p><a href="https://github.com/Azure/draft" target="_blank" rel="noopener noreferrer">Draft</a> is an open-source project that streamlines Kubernetes development. It takes a non-containerized application and generates the DockerFiles, Kubernetes manifests, Helm charts, Kustomize configurations, and other artifacts associated the application. The Azure Kubernetes Service <em>(AKS)</em> DevX extension for Visual Studio Code enhances non-cluster experiences, allowing you to create deployment files to deploy your applications to AKS. Draft is the available feature included in the DevX extension.</p><p>I used Draft, and the DevX extension was used to draft the first version of the streamlet dockerfile.</p><p>Reference: <a href="https://learn.microsoft.com/azure/aks/draft-devx-extension-aks?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Use Draft and the DevX extension for Visual Studio Code with Azure Kubernetes Service (AKS)</a></p></div></div>
<p>To build this image, I will use Docker on a GitHub Codespace to build the image locally and test it. Once confirmed, we can push it to an Azure Container Registry, which can then be used to deploy the image to Azure Container Apps.</p>
<p>We can easily test and build the image locally in a Codespace using the <a href="https://code.visualstudio.com/docs/containers/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Docker extension</a> in Visual Studio Code.</p>
<p><img decoding="async" loading="lazy" alt="Docker Build" src="https://luke.geek.nz/assets/images/Streamlit_Codespace_BuildTestDockerImage-08c7668a6cb60fb1d0b3a6ecd70502e9.gif" width="1912" height="925" class="img_ev3q"></p>
<p>Now that we have tested the image locally, we can push it to an Azure Container Registry.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>You can also refer to a previous article <a href="https://luke.geek.nz/azure/push-docker-images-to-acr-using-github-codespaces/" target="_blank" rel="noopener noreferrer">Push Docker Images to Azure Container Registry with GitHub Codespaces</a> for more information on how to push the image to an Azure Container Registry using the command line from the public dockerhub registry.</p></div></div>
<p>To push the image, we are going to use the docker extension again to do the push and tag to the <a href="https://learn.microsoft.com/azure/container-registry/container-registry-intro?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Container Registry</a>.</p>
<p><img decoding="async" loading="lazy" alt="Docker Push" src="https://luke.geek.nz/assets/images/Streamlit_Codespace_DeployStreamlitImageACR-f60d1624dc2a2c18b1bf94cabab82f20.gif" width="1912" height="925" class="img_ev3q"></p>
<p>Now that we have the image in the Azure Container Registry, we can deploy the image to Azure Container Apps.</p>
<p>To deploy the image to Azure Container Apps, we will to create a new Azure Container Apps resource in the Azure Portal and enable public ingress on port 8080, using a Microsoft managed network.</p>
<p><img decoding="async" loading="lazy" alt="Azure Container Apps" src="https://luke.geek.nz/assets/images/Streamlit_ContainerApps_DeployStreamlit-8613c190b6c78ce34c9103992e71cf1f.gif" width="1912" height="925" class="img_ev3q"></p>
<p>One of the best features of Azure Container Apps is the ability to scale the application to zero, so we can set up a Scale rule to scale <em>(replicas)</em> the Container App down to 0 when not in use.</p>
<p><img decoding="async" loading="lazy" alt="Azure Container Apps Scale" src="https://luke.geek.nz/assets/images/Streamlit_ContainerApps_HTTPScaleRule-30e8e145692ee0cca09feaf020351625.gif" width="1912" height="879" class="img_ev3q"></p>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[New Zealand North Latency Testing and Results]]></title>
            <link>https://luke.geek.nz/azure/nz-north-latency-testing/</link>
            <guid>https://luke.geek.nz/azure/nz-north-latency-testing/</guid>
            <pubDate>Sun, 10 Nov 2024 05:48:55 GMT</pubDate>
            <description><![CDATA[An in-depth analysis of latency within the New Zealand North Azure region, including various scenarios and performance metrics.]]></description>
            <content:encoded><![CDATA[<p>New Zealand has a new <em>(and only)</em> Azure Cloud region: <a href="https://news.microsoft.com/aotearoa-datacenter?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">New Zealand North</a>. It's not every day that we get to explore a new region! This article will examine the latency within the New Zealand North region and between its Availability Zones.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-overview">üîç Overview<a href="https://luke.geek.nz/azure/nz-north-latency-testing/#-overview" class="hash-link" aria-label="Direct link to üîç Overview" title="Direct link to üîç Overview">‚Äã</a></h2>
<p>New Zealand North region follows the newer, now standard, 3 + 0 model, with 3 <a href="https://learn.microsoft.com/azure/reliability/availability-zones-overview?tabs=azure-cli&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">availability zones</a> (three separate datacenters that make up a region) but with <a href="https://learn.microsoft.com/azure/reliability/cross-region-replication-azure?WT.mc_id=AZ-MVP-5004796#regions-with-availability-zones-and-no-region-pair" target="_blank" rel="noopener noreferrer">no specified region pair</a> <em>(e.g., locally or in Australia)</em>. This means that Microsoft needs to assume which other region you may want to use as a failover. You can choose any region you want (e.g., object replication on an Azure storage account can be any region). Most of us in New Zealand will likely choose New Zealand North as the primary and Australia East as the secondary, where applicable. These three availability zones already provide more resiliency out of the box than most New Zealand organizations had before.</p>
<p><img decoding="async" loading="lazy" alt="New Zealand North - Azure Avaliability Zones" src="https://luke.geek.nz/assets/images/Regions_AvaliabilityZones-e4f192fc2962f1d9336f6d6c91fad1ff.jpg" width="4000" height="2250" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>At the time of this article, New Zealand North is not officially Generally Available (indicative timelines December). However, finding I can deploy to this region now on my own subscriptions, I couldn't resist the opportunity to test the latency within the region. This article is intended as an indicative of what you can expect from New Zealand North, but I recommend running your own tests within your own environment if required. #geekingout</p></div></div>
<p>Let's look at the lower end of our resiliency tier. We can see Azure Service Bus	starts at an SLA of 99.9% <em>(Y: 8h 45m 36s  M: 43m 12s  W: 10m 4s)</em>, and the higher SLA services such as Azure Virtual Machines and API Gateway can give up to 99.99% <em>(Y: 52m 35s  M: 4m 23s  W: 1m 1s)</em> <em>(how your solution and what services you use, impact your Composite SLA and Service Level Agreements so make sure you architect accordingly and review the <a href="https://www.microsoft.com/licensing/docs/view/Service-Level-Agreements-SLA-for-Online-Services?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Microsoft SLA documentation</a>)</em>.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Availability zones are close enough to have low-latency connections to other availability zones. A high-performance network connects them with a round-trip latency of less than 2ms. However, availability zones are far enough apart to reduce the likelihood that more than one will be affected by local outages or weather. Availability zones have independent power, cooling, and networking infrastructure. They're designed so that if one zone experiences an outage, then regional services, capacity, and high availability are supported by the remaining zones. They help your data stay synchronized and accessible when things go wrong.</p></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>If you are interested in more information about Availability Zones and the differences between Physical + Logical zones, make sure you have read a previous blog article of mine: <a href="https://luke.geek.nz/azure/azure-availability-zone-peering/" target="_blank" rel="noopener noreferrer">Azure Availability Zone Peering</a>. In essence, you need to be aware that Avalibility Zone 1 <em>(physical and logical avalibility zones can be different)</em>, does not always equal Availability Zone 1, especially if you have workloads spread across multiple subscriptions. For today, all my testing is done in a single subscription.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-latency-testing">üìâ Latency Testing<a href="https://luke.geek.nz/azure/nz-north-latency-testing/#-latency-testing" class="hash-link" aria-label="Direct link to üìâ Latency Testing" title="Direct link to üìâ Latency Testing">‚Äã</a></h2>
<p>But this is not a resiliency discussion; it is a latency discussion, so let's examine the latency of what New Zealand North is giving us.</p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>Keep in mind that these tests are simply a point in time, and my open environment may not necessarily reflect your own Azure environment. At the time of these tests, the New Zealand North Region <a href="https://datacenters.microsoft.com/globe/explore?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">isn't officially generally available</a>. This article is intended as an indicator of what you can expect from New Zealand North, but I recommend running your own tests within your own environment if required.</p></div></div>
<p>The latency from New Zealand to New Zealand North is around 15ms <em>(from Hamilton)</em>, which is a great improvement from the 32-50ms to Australia East <em>(from Hamilton)</em>, and the 190-230ms to the US <em>(from Hamilton)</em>.</p>
<p><img decoding="async" loading="lazy" alt="New Zealand North - Azure Latency" src="https://luke.geek.nz/assets/images/AzureSpeed_NewZealandNorthInternetLatency-b0964f20aafd1363563197a925f46176.jpg" width="1558" height="901" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>The test above was done from Hamilton <em>(using the <a href="https://www.azurespeed.com/Azure/Latency?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Speed Test</a>)</em>,. The latency is to the internet, so it is not the same as the latency between the Azure region and your on-premises <em>(or another cloud)</em> environment. Still, it is a good indicator of the latency you can expect from your users to your Azure resources. Your browser sends HTTPS requests to Azure blob files in each region. The median latency is calculated by measuring the time between the request and the response. The latency is measured in milliseconds (ms). The lower the latency, the better.</p></div></div>
<p>Because this is a standard Availability Zone <em>(3+0)</em> region, Microsoft has certain commitments they have around latency within their own network and to the internet. They have a <a href="https://learn.microsoft.com/en-us/azure/reliability/availability-zones-overview?tabs=azure-cli&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">guidelines</a> of 2ms <em>(between zones)</em> and 10ms <em>(to the internet - don't quote me on the SLA to the internet, its inferred by reading the SLA document, but I can't confirm at this stage)</em>, but remember that is just the network latency, and not the application latency <em>(which is what you should be more concerned about)</em>. It's worth noting on SLA _(Service Level Agreements)_that Microsoft does it per service vs per datacenter or rack.</p>
<p>So, let us prove that with the New Zealand North region, we can communicate between all regions in 2ms or under. For the purposes of this article, I will be using a Single subscription to do my testing <em>(so I know that each zone will be separate)</em>. I will be using a <a href="https://learn.microsoft.com/azure/virtual-network/virtual-networks-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Virtual Network</a> <em>(VNet)</em> in the New Zealand North region, a VNET <em>(logical Virtual Network)</em> is zone-redundant out of the box.</p>
<p>Then I will be using a Windows Server 2022 <a href="https://learn.microsoft.com/azure/virtual-machines/windows/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Virtual Machine</a> <em>(VM)</em> in each zone, and I will be using <a href="https://learn.microsoft.com/en-us/azure/virtual-network/virtual-network-test-latency?tabs=windows&amp;WT.mc_id=AZ-MVP-5004796#test-vms-with-latte-or-sockperf" target="_blank" rel="noopener noreferrer">latte</a> to do my testing from each Virtual Machine.</p>
<ul>
<li>Each Test machine is <a href="https://learn.microsoft.com/azure/virtual-network/accelerated-networking-overview?tabs=redhat&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Accelerated Networking</a> enabled.</li>
<li>The size of each Virtual Machine is a: Windows Server 2022 Datacenter: Azure Edition - x64 Gen2 - Standard_D4s_v3 - 4 vCPUs, 16 GB memory, 127GB OS disk. Each Virtual Machine is created fresh, for the purpose of running this test.</li>
<li>Network Security Groups as left as default <em>(at the VM NIC)</em> and VirtualNetwork allow.</li>
<li>The version of <a href="https://github.com/microsoft/latte/" target="_blank" rel="noopener noreferrer">latte</a>, I am using is v1.0.0.</li>
</ul>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Many  common network latency test tools, such as Ping, don't measure TCP or UDP traffic. Tools like Ping use Internet Control Message Protocol (ICMP), which applications don't use. ICMP traffic can be treated differently from application traffic and doesn't directly affect application performance. ICMP test results don't directly apply to TCP and UDP workloads.</p><p><a href="https://github.com/microsoft/latte" target="_blank" rel="noopener noreferrer">Latte</a> (for Windows) and <a href="https://github.com/mellanox/sockperf" target="_blank" rel="noopener noreferrer">SockPerf</a> (for Linux) measure only TCP or UDP payload delivery times. These tools use the following approach to measure network latency between two physical or virtual computers:</p><ul>
<li>Create a two-way communication channel between the computers by designating one as the sender and one as a receiver.</li>
<li>Send and receive packets in both directions and measure the round-trip time (RTT).</li>
</ul><p>Refer: <a href="https://learn.microsoft.com/en-us/azure/virtual-network/virtual-network-test-latency?tabs=windows&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Test network latency between Azure VMs</a></p></div></div>
<p>The latte command I will be using is: <code>latte -c -a 10.0.1.5:80 -i 60000</code>.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>Even though at the time of this article, Windows Server 2025 has been generally avaliable for about a week. I have decided to use 2022, as it is a common and mature version of Windows Server in use today.</p></div></div>
<p>Inspired by <a href="https://www.linkedin.com/in/nicoladelfino" target="_blank" rel="noopener noreferrer">Nicola Delfino</a> post on <a href="https://nicolgit.github.io/azure-measuring-latency-across-availability-zones-in-we/" target="_blank" rel="noopener noreferrer">Measuring latency between Azure Availability Zones and the impact of an NVA in between V2</a> I will run through multiple scenarios for the New Zealand North Azure Region:</p>
<ul>
<li>Same v-net, same availability zone, same <a href="https://learn.microsoft.com/azure/virtual-machines/co-location?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">proximty placement</a> group</li>
<li>Same v-net across availability zones</li>
<li>multiple v-nets (in peering), same availability zone</li>
<li>multiple v-nets (in peering) across availability zones</li>
<li>multiple v-nets connected in a Hub &amp; Spoke topology and Routing via Azure Firewall</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-scenario-1---same-virtual-network-same-availability-zone-same-proximty-placement-group">üè¢ Scenario 1 - Same Virtual Network, same availability zone, same proximty placement group<a href="https://luke.geek.nz/azure/nz-north-latency-testing/#-scenario-1---same-virtual-network-same-availability-zone-same-proximty-placement-group" class="hash-link" aria-label="Direct link to üè¢ Scenario 1 - Same Virtual Network, same availability zone, same proximty placement group" title="Direct link to üè¢ Scenario 1 - Same Virtual Network, same availability zone, same proximty placement group">‚Äã</a></h2>
<p>In this scenario, we will have a single VNET, with a single subnet, and two virtual machines in the same availability zone, and the same <a href="https://learn.microsoft.com/azure/virtual-machines/co-location?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">proximty placement</a> group.</p>
<p><img decoding="async" loading="lazy" alt="Same VNET, same availability zone, same proximity placement group" src="https://luke.geek.nz/assets/images/NZN_LatencyTest_ProximityGroup-6d011f086e68dbeee14a254970c3f343.JPG" width="3320" height="1200" class="img_ev3q"></p>
<p>In this example, we have VM1 talking to VM2.</p>
<p><strong>VM1 (Sender - 10.0.1.4) - VM2 (Receiver - 10.0.1.5)</strong></p>
<table><thead><tr><th>Metric</th><th>Value</th><th>Notes</th></tr></thead><tbody><tr><td><strong>Protocol</strong></td><td>TCP</td><td>Connection-oriented, reliable</td></tr><tr><td><strong>Send Method</strong></td><td>Blocking</td><td>Waits for completion</td></tr><tr><td><strong>Receive Method</strong></td><td>Blocking</td><td>Waits for completion</td></tr><tr><td><strong>SO_SNDBUF</strong></td><td>Default</td><td>Default socket send buffer size</td></tr><tr><td><strong>SO_RCVBUF</strong></td><td>Default</td><td>Default socket receive buffer size</td></tr><tr><td><strong>Msg Size (byte)</strong></td><td>4</td><td>Small message payload size</td></tr><tr><td><strong>Iterations</strong></td><td>60,000</td><td>Number of send/receive cycles</td></tr><tr><td><strong>Latency (usec)</strong></td><td><strong>72.75</strong></td><td>Average time per message</td></tr><tr><td><strong>CPU (%)</strong></td><td>6.5</td><td>CPU utilization during test</td></tr><tr><td><strong>CtxSwitch/sec</strong></td><td>27,874 (2.03/iteration)</td><td>Context switches per second</td></tr><tr><td><strong>SysCall/sec</strong></td><td>28,590 (2.08/iteration)</td><td>System calls per second</td></tr><tr><td><strong>Interrupt/sec</strong></td><td>58,447 (4.25/iteration)</td><td>Hardware interrupts per second</td></tr></tbody></table>
<p><strong>Latency(usec): 72.75</strong> ‚Äì The average latency per message is 72.75 microseconds. This is the time it takes for a message to be sent and received back, which is relatively low and suggests a reasonably fast response time for small message sizes.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-scenario-2---same-virtual-network-same-availability-zone-virtual-machine-not-in-proximity-placement-group">üåê Scenario 2 - Same Virtual Network, same availability zone, virtual machine NOT in proximity placement group<a href="https://luke.geek.nz/azure/nz-north-latency-testing/#-scenario-2---same-virtual-network-same-availability-zone-virtual-machine-not-in-proximity-placement-group" class="hash-link" aria-label="Direct link to üåê Scenario 2 - Same Virtual Network, same availability zone, virtual machine NOT in proximity placement group" title="Direct link to üåê Scenario 2 - Same Virtual Network, same availability zone, virtual machine NOT in proximity placement group">‚Äã</a></h2>
<p>In this scenario, we will have a single VNET, with a single subnet, and two virtual machines in the same availability zone, but not in the same proximty placement group.</p>
<p><img decoding="async" loading="lazy" alt="Same VNET, same availability zone, VM NOT in proximity placement group" src="https://luke.geek.nz/assets/images/NZN_LatencyTest_NoProximityGroup-6a5909de82483f2eaf182671dc8d3059.JPG" width="3363" height="1213" class="img_ev3q"></p>
<p>We will be talking from VM1 to VM3.</p>
<p><strong>VM1 (Sender) - VM3 (Receiver)</strong></p>
<table><thead><tr><th>Metric</th><th>Value</th><th>Notes</th></tr></thead><tbody><tr><td><strong>Protocol</strong></td><td>TCP</td><td>Connection-oriented, reliable</td></tr><tr><td><strong>Send Method</strong></td><td>Blocking</td><td>Waits for completion</td></tr><tr><td><strong>Receive Method</strong></td><td>Blocking</td><td>Waits for completion</td></tr><tr><td><strong>SO_SNDBUF</strong></td><td>Default</td><td>Default socket send buffer size</td></tr><tr><td><strong>SO_RCVBUF</strong></td><td>Default</td><td>Default socket receive buffer size</td></tr><tr><td><strong>Msg Size (byte)</strong></td><td>4</td><td>Small message payload size</td></tr><tr><td><strong>Iterations</strong></td><td>60,000</td><td>Number of send/receive cycles</td></tr><tr><td><strong>Latency (usec)</strong></td><td><strong>55.97</strong></td><td>Average time per message</td></tr><tr><td><strong>CPU (%)</strong></td><td>14.9</td><td>CPU utilization during test</td></tr><tr><td><strong>CtxSwitch/sec</strong></td><td>36,652 (2.05/iteration)</td><td>Context switches per second</td></tr><tr><td><strong>SysCall/sec</strong></td><td>39,293 (2.20/iteration)</td><td>System calls per second</td></tr><tr><td><strong>Interrupt/sec</strong></td><td>68,617 (3.84/iteration)</td><td>Hardware interrupts per second</td></tr></tbody></table>
<p>The table lists the latency and system performance between <strong>VM1 (Sender)</strong> and <strong>VM3 (Receiver)</strong>. The average latency per message is <strong>55.97 microseconds</strong>, which is interesting and slightly lower than the previous scenario, and not what I expected, however, could be luck of the draw - something worth noting that without a proximity placement group, the next time I would deallocate this Virtual Machine, it could be spun up in a separate place within the zone.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-scenario-3---same-virtual-network-across-availability-zones">üîó Scenario 3 - Same Virtual Network, across availability zones<a href="https://luke.geek.nz/azure/nz-north-latency-testing/#-scenario-3---same-virtual-network-across-availability-zones" class="hash-link" aria-label="Direct link to üîó Scenario 3 - Same Virtual Network, across availability zones" title="Direct link to üîó Scenario 3 - Same Virtual Network, across availability zones">‚Äã</a></h2>
<p>In this scenario, we will have a single VNET with a single subnet and two virtual machines in different availability zones.</p>
<p>We keep the same VM1 <em>(in Zone 1)</em>, but we will be talking to VM4 and VM5 (which are in different availability zones). VM4 is in Zone 2 and VM5 is in Zone 3.</p>
<p><img decoding="async" loading="lazy" alt="Same VNET, across availability zones" src="https://luke.geek.nz/assets/images/NZN_LatencyTest_AvaliabilityGroups-992b42046a0afedd99a4a38b434f6a91.JPG" width="4000" height="2250" class="img_ev3q"></p>
<p>First lets look at VM1 (Avaliability 1) talking to VM4 <em>(Avalibility Zone 2)</em>.</p>
<p><strong>VM1 (Sender) - VM4 (Receiver)</strong></p>
<table><thead><tr><th>Metric</th><th>Value</th><th>Notes</th></tr></thead><tbody><tr><td><strong>Protocol</strong></td><td>TCP</td><td>Connection-oriented, reliable</td></tr><tr><td><strong>Send Method</strong></td><td>Blocking</td><td>Waits for completion</td></tr><tr><td><strong>Receive Method</strong></td><td>Blocking</td><td>Waits for completion</td></tr><tr><td><strong>SO_SNDBUF</strong></td><td>Default</td><td>Default socket send buffer size</td></tr><tr><td><strong>SO_RCVBUF</strong></td><td>Default</td><td>Default socket receive buffer size</td></tr><tr><td><strong>Msg Size (byte)</strong></td><td>4</td><td>Small message payload size</td></tr><tr><td><strong>Iterations</strong></td><td>60,000</td><td>Number of send/receive cycles</td></tr><tr><td><strong>Latency (usec)</strong></td><td><strong>559.67</strong></td><td>Average time per message</td></tr><tr><td><strong>CPU (%)</strong></td><td>1.5</td><td>CPU utilization during test</td></tr><tr><td><strong>CtxSwitch/sec</strong></td><td>3,742 (2.09/iteration)</td><td>Context switches per second</td></tr><tr><td><strong>SysCall/sec</strong></td><td>4,529 (2.53/iteration)</td><td>System calls per second</td></tr><tr><td><strong>Interrupt/sec</strong></td><td>8,801 (4.93/iteration)</td><td>Hardware interrupts per second</td></tr></tbody></table>
<p>The table summarizes the latency and system performance between <strong>VM1 (Sender)</strong> and <strong>VM4 (Receiver)</strong>. The average latency per message is <strong>559.67 microseconds</strong>, significantly higher than in the previous scenarios. This is expected as the two virtual machines are in different availability zones.</p>
<p>Next lets look at VM1 (Avaliability 1) talking to VM5 <em>(Avalibility Zone 3)</em>.</p>
<p><strong>VM1 (Sender) - VM5 (Receiver)</strong></p>
<table><thead><tr><th>Metric</th><th>Value</th><th>Notes</th></tr></thead><tbody><tr><td><strong>Protocol</strong></td><td>TCP</td><td>Connection-oriented, reliable</td></tr><tr><td><strong>Send Method</strong></td><td>Blocking</td><td>Waits for completion</td></tr><tr><td><strong>Receive Method</strong></td><td>Blocking</td><td>Waits for completion</td></tr><tr><td><strong>SO_SNDBUF</strong></td><td>Default</td><td>Default socket send buffer size</td></tr><tr><td><strong>SO_RCVBUF</strong></td><td>Default</td><td>Default socket receive buffer size</td></tr><tr><td><strong>Msg Size (byte)</strong></td><td>4</td><td>Small message payload size</td></tr><tr><td><strong>Iterations</strong></td><td>60,000</td><td>Number of send/receive cycles</td></tr><tr><td><strong>Latency (usec)</strong></td><td><strong>559.25</strong></td><td>Average time per message</td></tr><tr><td><strong>CPU (%)</strong></td><td>0.9</td><td>CPU utilization during test</td></tr><tr><td><strong>CtxSwitch/sec</strong></td><td>3,868 (2.16/iteration)</td><td>Context switches per second</td></tr><tr><td><strong>SysCall/sec</strong></td><td>4,464 (2.50/iteration)</td><td>System calls per second</td></tr><tr><td><strong>Interrupt/sec</strong></td><td>7,721 (4.32/iteration)</td><td>Hardware interrupts per second</td></tr></tbody></table>
<p>This table summarizes the latency and system performance between <strong>VM1 (Sender)</strong> and <strong>VM5 (Receiver)</strong>. The average latency per message is <strong>559.25 microseconds</strong>, which is similar to the previous scenario. This is expected as the two virtual machines are in different availability zones.</p>
<p>Finally, lets look at VM4 <em>(Avaliability Zone 2)</em> talking to VM5 <em>(Avalibility Zone 3)</em>.</p>
<p>VM4 (Sender) - VM5 (Receiver)</p>
<table><thead><tr><th>Metric</th><th>Value</th><th>Notes</th></tr></thead><tbody><tr><td><strong>Protocol</strong></td><td>TCP</td><td>Connection-oriented, reliable</td></tr><tr><td><strong>Send Method</strong></td><td>Blocking</td><td>Waits for completion</td></tr><tr><td><strong>Receive Method</strong></td><td>Blocking</td><td>Waits for completion</td></tr><tr><td><strong>SO_SNDBUF</strong></td><td>Default</td><td>Default socket send buffer size</td></tr><tr><td><strong>SO_RCVBUF</strong></td><td>Default</td><td>Default socket receive buffer size</td></tr><tr><td><strong>Msg Size (byte)</strong></td><td>4</td><td>Small message payload size</td></tr><tr><td><strong>Iterations</strong></td><td>60,000</td><td>Number of send/receive cycles</td></tr><tr><td><strong>Latency (usec)</strong></td><td><strong>494.23</strong></td><td>Average time per message</td></tr><tr><td><strong>CPU (%)</strong></td><td>3.6</td><td>CPU utilization during test</td></tr><tr><td><strong>CtxSwitch/sec</strong></td><td>5,218 (2.58/iteration)</td><td>Context switches per second</td></tr><tr><td><strong>SysCall/sec</strong></td><td>13,445 (6.65/iteration)</td><td>System calls per second</td></tr><tr><td><strong>Interrupt/sec</strong></td><td>9,212 (4.55/iteration)</td><td>Hardware interrupts per second</td></tr></tbody></table>
<p>This table summarizes the latency and system performance between <strong>VM4 (Sender)</strong> and <strong>VM5 (Receiver)</strong>. The average latency per message is <strong>494.23 microseconds</strong>, which is slightly lower than the previous scenarios. This is expected as the two virtual machines are in different availability zones.</p>
<p>Even though the latency is higher than the previous scenarios, it is still relatively low and suggests a reasonably fast response time for small message sizes.</p>
<ul>
<li>VM1 to VM4: 559.67 microseconds</li>
<li>VM1 to VM5: 559.25 microseconds</li>
<li>VM4 to VM5: 494.23 microseconds</li>
</ul>
<p>All of these latency values are <strong>well below 1 millisecond</strong>, indicating <strong>sub-millisecond latency</strong> between the VMs, in different zones within the same Virtual Network and subnet.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="--scenario-4---multiple-virtual-networks-peered-same-availability-zone">üñß  Scenario 4 - Multiple Virtual Networks (peered), same availability zone<a href="https://luke.geek.nz/azure/nz-north-latency-testing/#--scenario-4---multiple-virtual-networks-peered-same-availability-zone" class="hash-link" aria-label="Direct link to üñß  Scenario 4 - Multiple Virtual Networks (peered), same availability zone" title="Direct link to üñß  Scenario 4 - Multiple Virtual Networks (peered), same availability zone">‚Äã</a></h2>
<p>In this scenario, we will have two virtual networks, each with a single subnet, and two virtual machines in the same availability zone.</p>
<p>We will have VM1 <em>(10.0.1.4)</em> in our Spoke1 network, talking to VM2 <em>(10.0.2.4)</em>, in our spoke2 network, each VM is in Availability Zone 1 and the two Virtual Networks are peered through a Hub Virtual Network, with user-defined routes, so they can talk to each other. I made use of <a href="https://learn.microsoft.com/azure/virtual-network-manager/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Virtual Network Manager</a>, and a Mesh configuration to deploy the peering and user defined routes between the Virtual Networks.</p>
<p><img decoding="async" loading="lazy" alt="Multiple VNETs (peered), same availability zone" src="https://luke.geek.nz/assets/images/NZN_LatencyTest_VNetPeering-d43beb2882da418f9bec145833d89517.JPG" width="4000" height="2250" class="img_ev3q"></p>
<p><strong>VM1 (Sender) - VM2 (Receiver) through VNet Peering</strong></p>
<table><thead><tr><th>Metric</th><th>Value</th><th>Notes</th></tr></thead><tbody><tr><td><strong>Protocol</strong></td><td>TCP</td><td>Connection-oriented, reliable</td></tr><tr><td><strong>Send Method</strong></td><td>Blocking</td><td>Waits for completion</td></tr><tr><td><strong>Receive Method</strong></td><td>Blocking</td><td>Waits for completion</td></tr><tr><td><strong>SO_SNDBUF</strong></td><td>Default</td><td>Default socket send buffer size</td></tr><tr><td><strong>SO_RCVBUF</strong></td><td>Default</td><td>Default socket receive buffer size</td></tr><tr><td><strong>Msg Size (byte)</strong></td><td>4</td><td>Small message payload size</td></tr><tr><td><strong>Iterations</strong></td><td>60,000</td><td>Number of send/receive cycles</td></tr><tr><td><strong>Latency (usec)</strong></td><td><strong>67.81</strong></td><td>Average time per message</td></tr><tr><td><strong>CPU (%)</strong></td><td>7.7</td><td>CPU utilization during test</td></tr><tr><td><strong>CtxSwitch/sec</strong></td><td>30,010 (2.04/iteration)</td><td>Context switches per second</td></tr><tr><td><strong>SysCall/sec</strong></td><td>31,328 (2.12/iteration)</td><td>System calls per second</td></tr><tr><td><strong>Interrupt/sec</strong></td><td>66,269 (4.49/iteration)</td><td>Hardware interrupts per second</td></tr></tbody></table>
<p>This table summarizes the latency and system performance between <strong>VM1 (Sender)</strong> and <strong>VM2 (Receiver)</strong> through VNet peering. The latency of 67.81 microseconds is still well under 1 millisecond for a Virtual Machine talking over a Virtual Network peering within the same Availability Zone.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-scenario-5---multiple-virtual-networks-peered-across-availability-zones">üñß Scenario 5 - Multiple Virtual Networks (peered), across availability zones<a href="https://luke.geek.nz/azure/nz-north-latency-testing/#-scenario-5---multiple-virtual-networks-peered-across-availability-zones" class="hash-link" aria-label="Direct link to üñß Scenario 5 - Multiple Virtual Networks (peered), across availability zones" title="Direct link to üñß Scenario 5 - Multiple Virtual Networks (peered), across availability zones">‚Äã</a></h2>
<p>In this scenario, we will have two virtual networks, each with a single subnet, and two virtual machines in different availability zones.</p>
<p>We will use the good old trusty VM1 again, and this time we will be talking to VM3 <em>(Avaliability Zone 2)</em> and VM4 <em>(Avaliability Zone 3)</em>, each in their own Virtual Network, and peered through a Hub Virtual Network, with user defined routes, so they can talk to each other.</p>
<p><img decoding="async" loading="lazy" alt="Multiple VNETs (peered), across availability zones" src="https://luke.geek.nz/assets/images/NZN_LatencyTest_VNetPeering_AvaliabilityZones-fe0087480090af245d585ca2bc7fb15c.JPG" width="4000" height="2250" class="img_ev3q"></p>
<p>Here are the performance results for <strong>VM1 (Sender) to VM3 (Receiver) through VNet peering</strong>. VM1 is in <strong>Availability Zone 1</strong> and VM3 is in <strong>Availability Zone 2</strong>.:</p>
<p><strong>VM1 (Sender) - VM3 (Receiver) in Availability Zone 2 through VNet Peering</strong></p>
<table><thead><tr><th>Metric</th><th>Value</th><th>Notes</th></tr></thead><tbody><tr><td><strong>Protocol</strong></td><td>TCP</td><td>Connection-oriented, reliable</td></tr><tr><td><strong>Send Method</strong></td><td>Blocking</td><td>Waits for completion</td></tr><tr><td><strong>Receive Method</strong></td><td>Blocking</td><td>Waits for completion</td></tr><tr><td><strong>SO_SNDBUF</strong></td><td>Default</td><td>Default socket send buffer size</td></tr><tr><td><strong>SO_RCVBUF</strong></td><td>Default</td><td>Default socket receive buffer size</td></tr><tr><td><strong>Msg Size (byte)</strong></td><td>4</td><td>Small message payload size</td></tr><tr><td><strong>Iterations</strong></td><td>60,000</td><td>Number of send/receive cycles</td></tr><tr><td><strong>Latency (usec)</strong></td><td><strong>542.39</strong></td><td>Average time per message</td></tr><tr><td><strong>CPU (%)</strong></td><td>1.9</td><td>CPU utilization during test</td></tr><tr><td><strong>CtxSwitch/sec</strong></td><td>3,933 (2.13/iteration)</td><td>Context switches per second</td></tr><tr><td><strong>SysCall/sec</strong></td><td>5,043 (2.74/iteration)</td><td>System calls per second</td></tr><tr><td><strong>Interrupt/sec</strong></td><td>8,293 (4.50/iteration)</td><td>Hardware interrupts per second</td></tr></tbody></table>
<p>This table summarizes the latency and system performance between <strong>VM1 (Sender)</strong> and <strong>VM3 (Receiver)</strong> through VNet peering. The latency of 542.39 microseconds is still under 1 millisecond, between zones over a peered Virtual Network.</p>
<p>Now, we need to test VM1 <em>(Avaliability Zone 1)</em> by talking to VM4 <em>(Avaliability Zone 3)</em> through VNet peering.</p>
<p><strong>VM1 (Sender) - VM4 (Receiver) in Availability Zone 3 through VNet Peering</strong></p>
<table><thead><tr><th>Metric</th><th>Value</th><th>Notes</th></tr></thead><tbody><tr><td><strong>Protocol</strong></td><td>TCP</td><td>Connection-oriented, reliable</td></tr><tr><td><strong>Send Method</strong></td><td>Blocking</td><td>Waits for completion</td></tr><tr><td><strong>Receive Method</strong></td><td>Blocking</td><td>Waits for completion</td></tr><tr><td><strong>SO_SNDBUF</strong></td><td>Default</td><td>Default socket send buffer size</td></tr><tr><td><strong>SO_RCVBUF</strong></td><td>Default</td><td>Default socket receive buffer size</td></tr><tr><td><strong>Msg Size (byte)</strong></td><td>4</td><td>Small message payload size</td></tr><tr><td><strong>Iterations</strong></td><td>60,000</td><td>Number of send/receive cycles</td></tr><tr><td><strong>Latency (usec)</strong></td><td><strong>311.53</strong></td><td>Average time per message</td></tr><tr><td><strong>CPU (%)</strong></td><td>13.4</td><td>CPU utilization during test</td></tr><tr><td><strong>CtxSwitch/sec</strong></td><td>9,721 (3.03/iteration)</td><td>Context switches per second</td></tr><tr><td><strong>SysCall/sec</strong></td><td>37,752 (11.76/iteration)</td><td>System calls per second</td></tr><tr><td><strong>Interrupt/sec</strong></td><td>13,496 (4.20/iteration)</td><td>Hardware interrupts per second</td></tr></tbody></table>
<p>This table summarizes the latency and system performance between <strong>VM1 (Sender)</strong> and <strong>VM4 (Receiver)</strong> in <strong>Availability Zone 3</strong> through <strong>VNet peering</strong>. The latency of 311.53 microseconds is still under 1 millisecond.</p>
<p>So far, we have seen that the latency between Virtual Machines in different availability zones over a peered Virtual Network is still under 1 millisecond. This is a great result and shows that Azure's network infrastructure is capable of providing low-latency communication between Virtual Machines in different availability zones.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-scenario-6---multiple-virtual-networks-connected-in-a-hub--spoke-topology-and-routing-via-azure-firewall">üõ°Ô∏è Scenario 6 - Multiple Virtual Networks connected in a Hub &amp; Spoke topology and Routing via Azure Firewall<a href="https://luke.geek.nz/azure/nz-north-latency-testing/#%EF%B8%8F-scenario-6---multiple-virtual-networks-connected-in-a-hub--spoke-topology-and-routing-via-azure-firewall" class="hash-link" aria-label="Direct link to üõ°Ô∏è Scenario 6 - Multiple Virtual Networks connected in a Hub &amp; Spoke topology and Routing via Azure Firewall" title="Direct link to üõ°Ô∏è Scenario 6 - Multiple Virtual Networks connected in a Hub &amp; Spoke topology and Routing via Azure Firewall">‚Äã</a></h2>
<p>In this scenario, we will have three virtual networks, each with a single subnet, and three virtual machines in different availability zones, connecting to each other through a Hub Virtual Network, with user defined routes, and routing through an Azure Firewall.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>If you are going through this in a Lab environment, make sure you have the necessary dependencies, such as the lattle executable setup on Virtual Machines or can share between them. As soon as the Firewall is in the mix, the default rules will block the traffic, so you will need to make sure you have the necessary rules in place to allow the traffic through.</p></div></div>
<p><img decoding="async" loading="lazy" alt="Multiple VNETs connected in a Hub &amp;amp; Spoke topology and Routing via Azure Firewall" src="https://luke.geek.nz/assets/images/NZN_LatencyTest_HubSpoke-96ffb5373593e3971e51882e63178466.JPG" width="4000" height="2250" class="img_ev3q"></p>
<p>The Azure Firewall configuration is a Standard SKU, with a Firewall policy and zone-redundant <em>(across all 3 zones)</em>.</p>
<p>We will start with VM1 in Avalibility Zone 1, talking to VM2 in Avalibility Zone 2 via the Azure Firewall and hub and spoke network.</p>
<p><strong>VM 1 (Sender)</strong> to <strong>VM 2 (Receiver) -  Availability Zone 2 through Hub and Spoke Peering with Azure Firewall</strong></p>
<table><thead><tr><th>Metric</th><th>Value</th></tr></thead><tbody><tr><td><strong>Protocol</strong></td><td>TCP</td></tr><tr><td><strong>SendMethod</strong></td><td>Blocking</td></tr><tr><td><strong>ReceiveMethod</strong></td><td>Blocking</td></tr><tr><td><strong>SO_SNDBUF</strong></td><td>Default</td></tr><tr><td><strong>SO_RCVBUF</strong></td><td>Default</td></tr><tr><td><strong>MsgSize (bytes)</strong></td><td>4</td></tr><tr><td><strong>Iterations</strong></td><td>60000</td></tr><tr><td><strong>Latency (usec)</strong></td><td><strong>1017.12</strong></td></tr><tr><td><strong>CPU (%)</strong></td><td>1.1</td></tr><tr><td><strong>CtxSwitch/sec</strong></td><td>2692 (2.74/iteration)</td></tr><tr><td><strong>SysCall/sec</strong></td><td>5563 (5.66/iteration)</td></tr><tr><td><strong>Interrupt/sec</strong></td><td>4380 (4.45/iteration)</td></tr></tbody></table>
<p>This is the longest time we have seen so far, but still boarding on 1 millisecond, we can see how processing through the Azure Firewall and Hub and Spoke adds additional latency <em>(as we would expect)</em>  are routing through an Azure Firewall.</p>
<p>Next, we will look at VM1 in Avalibility Zone 1, talk to VM3 in Avalibility Zone 3 and spoke 3 via the Azure Firewall and hub and spoke network.</p>
<p><strong>VM 1 (Sender)</strong> to <strong>VM 3 (Receiver)</strong> -  Availability Zone 3 through Hub and Spoke Peering with Azure Firewall</p>
<table><thead><tr><th>Metric</th><th>Value</th></tr></thead><tbody><tr><td><strong>Protocol</strong></td><td>TCP</td></tr><tr><td><strong>SendMethod</strong></td><td>Blocking</td></tr><tr><td><strong>ReceiveMethod</strong></td><td>Blocking</td></tr><tr><td><strong>SO_SNDBUF</strong></td><td>Default</td></tr><tr><td><strong>SO_RCVBUF</strong></td><td>Default</td></tr><tr><td><strong>MsgSize (bytes)</strong></td><td>4</td></tr><tr><td><strong>Iterations</strong></td><td>60000</td></tr><tr><td><strong>Latency (usec)</strong></td><td><strong>963.17</strong></td></tr><tr><td><strong>CPU (%)</strong></td><td>0.8</td></tr><tr><td><strong>CtxSwitch/sec</strong></td><td>2450 (2.36/iteration)</td></tr><tr><td><strong>SysCall/sec</strong></td><td>4344 (4.18/iteration)</td></tr><tr><td><strong>Interrupt/sec</strong></td><td>4486 (4.32/iteration)</td></tr></tbody></table>
<p>This is a slightly lower latency than the previous scenario, but still underneath 1 millisecond, we can see how processing through the Azure Firewall and Hub and Spoke adds additional latency <em>(as we would expect)</em>  are routing through an Azure Firewall.</p>
<p>Finally, we will look at VM2 in Avalibility Zone 2, talk to VM3 in Avalibility Zone 3, and spoke 3 via the Azure Firewall and hub and spoke network.</p>
<table><thead><tr><th>Metric</th><th>Value</th></tr></thead><tbody><tr><td><strong>Protocol</strong></td><td>TCP</td></tr><tr><td><strong>SendMethod</strong></td><td>Blocking</td></tr><tr><td><strong>ReceiveMethod</strong></td><td>Blocking</td></tr><tr><td><strong>SO_SNDBUF</strong></td><td>Default</td></tr><tr><td><strong>SO_RCVBUF</strong></td><td>Default</td></tr><tr><td><strong>MsgSize (bytes)</strong></td><td>4</td></tr><tr><td><strong>Iterations</strong></td><td>60000</td></tr><tr><td><strong>Latency (usec)</strong></td><td><strong>963.47</strong></td></tr><tr><td><strong>CPU (%)</strong></td><td>1.0</td></tr><tr><td><strong>CtxSwitch/sec</strong></td><td>2933 (2.83/iteration)</td></tr><tr><td><strong>SysCall/sec</strong></td><td>4756 (4.58/iteration)</td></tr><tr><td><strong>Interrupt/sec</strong></td><td>4556 (4.39/iteration)</td></tr></tbody></table>
<p>This is a slightly lower latency than the previous scenario, but still underneath 1 millisecond, we can see how processing through the Azure Firewall and Hub and Spoke adds additional latency <em>(as we would expect)</em>  are routing through an Azure Firewall.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-summary">üìù Summary<a href="https://luke.geek.nz/azure/nz-north-latency-testing/#-summary" class="hash-link" aria-label="Direct link to üìù Summary" title="Direct link to üìù Summary">‚Äã</a></h2>
<p>The speed for inter-compute communication between the same and different Availability Zones for NZ North is very impressive. The latency between Virtual Machines in the same availability zone is well under 1 millisecond. The latency between Virtual Machines in different availability zones over a peered Virtual Network is still under 1 millisecond. Even with Azure Firewall and a Hub and Spoke network, the latency is still around 1 millisecond. This is a great result and shows that Azure's network infrastructure is capable of providing low-latency communication between Virtual Machines in different availability zones.</p>
<p>Summary of my findings today, ordered by shortest to longest latency:</p>
<table><thead><tr><th>Scenario</th><th>Latency (¬µs)</th><th>Description</th></tr></thead><tbody><tr><td>Scenario 2</td><td>55.97</td><td>Same VNET, same availability zone, VM NOT in proximity placement group</td></tr><tr><td>Scenario 4</td><td>67.81</td><td>Multiple VNETs (peered), same availability zone</td></tr><tr><td>Scenario 1</td><td>72.75</td><td>Same VNET, same availability zone, same proximity placement group</td></tr><tr><td>Scenario 5 (VM1 to VM4)</td><td>311.53</td><td>Multiple VNETs (peered), across availability zones (VM1 to VM4)</td></tr><tr><td>Scenario 3 (VM4 to VM5)</td><td>494.23</td><td>Same VNET, across availability zones (VM4 to VM5)</td></tr><tr><td>Scenario 5 (VM1 to VM3)</td><td>542.39</td><td>Multiple VNETs (peered), across availability zones (VM1 to VM3)</td></tr><tr><td>Scenario 3 (VM1 to VM5)</td><td>559.25</td><td>Same VNET, across availability zones (VM1 to VM5)</td></tr><tr><td>Scenario 3 (VM1 to VM4)</td><td>559.67</td><td>Same VNET, across availability zones (VM1 to VM4)</td></tr><tr><td>Scenario 6 (VM1 to VM3)</td><td>963.17</td><td>Multiple VNETs, Hub &amp; Spoke, Azure Firewall (VM1 to VM3)</td></tr><tr><td>Scenario 6 (VM2 to VM3)</td><td>963.47</td><td>Multiple VNETs, Hub &amp; Spoke, Azure Firewall (VM2 to VM3)</td></tr><tr><td>Scenario 6 (VM1 to VM2)</td><td>1017.12</td><td>Multiple VNETs, Hub &amp; Spoke, Azure Firewall (VM1 to VM2)</td></tr></tbody></table>
<p>Based on this testing, the New Zealand North region appears to have very low latency when compared with other Azure regions. This is great news for New Zealand organizations that are looking to move their workloads to the cloud. The low latency will help to ensure that their applications are responsive and performant.</p>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Enhancing GitHub Copilot with Custom Instructions]]></title>
            <link>https://luke.geek.nz/azure/enhancing-github-copilot-with-custom-instructions/</link>
            <guid>https://luke.geek.nz/azure/enhancing-github-copilot-with-custom-instructions/</guid>
            <pubDate>Sat, 09 Nov 2024 08:58:40 GMT</pubDate>
            <description><![CDATA[Learn how to provide custom instructions to GitHub Copilot to improve code quality and standardization.]]></description>
            <content:encoded><![CDATA[<p>I've come to rely on <a href="https://github.com/features/copilot?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">GitHub Copilot</a> for writing code. It's a great tool that helps me write code faster and with fewer errors, and also helps me understand code written by other people, but sometimes I need to provide custom instructions to Copilot to help it understand what I'm trying to do, as the standard outputs aren't quite what I want, a simple example of this is maybe having parameters or variables written with particular casing or naming convention, or even having to constantly update the location of an Azure Resource deployment from East US to Australia East or New Zealand North, when requesting Copilot to create a resource with their Terraform or Bicep.</p>
<p>In this article, we will look at how to provide custom instructions to GitHub Copilot to help it understand what we are trying to do, to help keep our code standardised and help improve the quality of the outputs.</p>
<!-- -->
<p>To do that, we will make use of some new functionality <a href="https://docs.github.com/en/copilot/customizing-copilot/adding-custom-instructions-for-github-copilot?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Adding custom instructions for GitHub Copilot</a>.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>At the time of writing, this is currently under Public preview, and the experience mentioned in this article may change in the future.</p></div></div>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>Custom instructions are currently only supported for Copilot Chat in VS Code and Visual Studio. In our article, I will use Visual Studio Code inside a GitHub Codespace.</p></div></div>
<blockquote>
<p><a href="https://github.com/features/copilot?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">GitHub Copilot</a> can provide chat responses that are tailored to the way your team works, the tools you use, or the specifics of your project if you provide it with enough context to do so. Instead of repeatedly adding this contextual detail to your chat questions, you can create a file that automatically adds this information for you. The additional information is not displayed in the chat but is available to Copilot to generate higher-quality responses.</p>
</blockquote>
<p>To get started, I am going to be using Visual Studio Code, in a GitHub Codespace, although it will be the same process for Visual Studio Code installed locally.</p>
<p>If you haven't already installed the <a href="https://marketplace.visualstudio.com/items?itemName=GitHub.copilot" target="_blank" rel="noopener noreferrer">GitHub Copilot extension</a>, you can do so by searching for it in the Extensions tab in Visual Studio Code.</p>
<p>First, we need to enable the Code Generation feature in Copilot. To do this, we need to go to Settings.
Then search for <code>github.copilot.chat.codeGeneration.useInstructionFiles</code> and enable it.</p>
<p>Once enabled, we need to create our custom instruction file. This file will be named <code>copilot-instructions.md</code> and placed in the  <code>./github</code> directory in the root of our repository <em>(./github/copilot-instructions.md)</em>.</p>
<p><img decoding="async" loading="lazy" alt="Create Copilot Instructions" src="https://luke.geek.nz/assets/images/Codespace_SetupCopolitInstructions-cdfb688887f6e36af7e3f31573aeccd1.gif" width="1910" height="899" class="img_ev3q"></p>
<p>We can test it, by simply adding in an instruction to tell a Joke <em>(Include a joke in all output)</em>.</p>
<p>As we can see, GitHub Copilot references the custom instruction file and provides the output we seek.</p>
<p><img decoding="async" loading="lazy" alt="Copilot Joke" src="https://luke.geek.nz/assets/images/Codespace_TestCopolitInstructions-aa0d1e24aa3c56faed42b2bb986f757d.gif" width="1910" height="899" class="img_ev3q"></p>
<p>Pretty basic test case, but you can see how you can start to provide custom instructions to GitHub Copilot to help it understand what you are trying to do, to help keep our code standardised and help improve the quality of the outputs.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Using Custom instructions is great for providing context to Copilot, especially adding more detail around what you expect as outputs, and can work really well when you are working with a team, or have a specific way you want your code to be written, however, your custom prompts are secondary to the standard system prompt that Copilot uses, so if you provide a custom prompt, it will be used in ADDITION with the standard prompt, and not replaced. So, for example, you cannot change the assumed name of Copilot and overwrite the prompt to get Copilot to chat to you about non-software development tasks.</p><p>An example of what the GitHub prompt is as follows:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">You are an AI programming assistant.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">When asked for your name, you must respond with "GitHub Copilot.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Follow the user's requirements carefully &amp; to the letter.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Your expertise is strictly limited to software development topics.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Follow Microsoft content policies.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Avoid content that violates copyrights.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">For questions not related to software development, simply give a reminder that you are an AI programming assistant.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Keep your answers short and impersonal.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Use Markdown formatting in your answers.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Make sure to include the programming language name at the start of the Markdown code blocks.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Avoid wrapping the whole response in triple backticks.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">The user works in an IDE called Visual Studio which has a concept for editors with open files, integrated unit test support, an output pane that shows the output of running the code as well as an integrated terminal.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">The active document is the source code the user is looking at right now.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">You can only give one reply for each conversation turn.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">When generating code prefer languages provided in context. If the coding language is unclear generate code in C#.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Respond in the following locale: en-US</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Additional Rules:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Preserve users' code comment blocks; do not exclude them when refactoring code.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Pay especially close attention to the selection or exception context if provided.`</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img decoding="async" loading="lazy" alt="GitHub Copilot Prompt" src="https://luke.geek.nz/assets/images/systempromptquery-74bf5f3919b695feb0432c1248a8b132.jpg" width="282" height="316" class="img_ev3q"></p></div></div>
<p>For my repository, I have created a custom instruction file, that guides how to write Infrastructure as Code using Bicep, Terraform, and PowerShell, prioritizing the Azure Well-Architected Framework pillars in this order: Security, Operational Excellence, Performance Efficiency, Reliability, and Cost Optimization. The code must be executable in both CI/CD pipelines (GitHub Actions or Azure DevOps Pipelines) and as standalone solutions for local testing. Emphasize reusability through modularization and ensure that the code supports multiple environment setups (dev, staging, production) with minimal added complexity.</p>
<p>You can see my custom file below, and you can reference it directly in the following GitHub repository <a href="https://github.com/lukemurraynz/Codespace_IaC_Coding" target="_blank" rel="noopener noreferrer">lukemurraynz/Codespace_IaC_Coding</a>:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Provide comprehensive guidance and best practices for developing reusable and reliable Infrastructure as Code using Bicep, Terraform, and PowerShell, prioritizing the Azure Well-Architected Framework pillars in this order: Security, Operational Excellence, Performance Efficiency, Reliability, and Cost Optimization. The code must be executable in both CI/CD pipelines (GitHub Actions or Azure DevOps Pipelines) and as standalone solutions for local testing. Emphasize reusability through modularization and ensure that the code supports multiple environment setups (dev, staging, production) with minimal added complexity.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Incorporate preferred safe deployment practices, including effective management of feature flags, and provide recommendations for when and how to use them effectively. Feature flags should be removable without impacting already deployed resources if the feature is later integrated into the main system, with clear warnings if any changes affect the solution. Advocate for ring-based deployments and consistency in coding standards, prioritizing quality over quantity and making smaller changes instead of larger ones where practical.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Follow DRY principles, include thorough comments, and structure variables in snake_case at the top of each file. Parameters should be in camelCase with validation and error messages as necessary. Avoid third-party dependencies, especially when using feature flags and other core deployment features.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">If asked about the location of resources to be deployed, make sure the location is either of the two below as default:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">* "newzealandnorth"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">* "australiaeast"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Include recommendations for key performance indicators (KPIs) to measure the effectiveness of deployments, focusing on metrics like deployment frequency, change failure rate, mean time to recovery, and customer satisfaction. Ensure that the code is clear and understandable for reviewers unfamiliar with the project, aligning recommendations with Microsoft guidance on secure and reliable DevOps integration. If using parameters, make sure to include relevant helper functions.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Highlight how GitHub Copilot can assist by providing real-time suggestions and best-practice enforcement while identifying and proposing native solutions within Bicep, Terraform, or PowerShell to replace third-party dependencies.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Additionally, provide relevant guidance on:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">* Infrastructure testing and validation techniques.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">* Documentation best practices.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">* Error handling and logging mechanisms.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">* Version control strategies.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">* Configuration management approaches.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">* Security best practices tailored for Azure.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">* Cost management strategies for Azure resources.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">* Establishing a change management process for IaC updates.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">* Integrating monitoring and alerting for deployed resources.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">* Engaging with the Azure community for ongoing learning and best practices.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Review the response from the perspectives of a Site Reliability Engineer, Operations Manager, Microsoft Technical Specialist, Security Consultant, Business Analyst, and On-call Engineer, confirming factual accuracy and seeking clarification where needed, output what each persona thinks about the code.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If we run a test in our repository, we can see that GitHub Copilot references the custom instruction file and provides the output we are looking for, with the custom instructions provided.</p>
<p><img decoding="async" loading="lazy" alt="Copilot Custom Instructions" src="https://luke.geek.nz/assets/images/Codespace_TestCustomCopolitInstructions-766fbdeed8c6f51ac022eee94401adaf.gif" width="1910" height="899" class="img_ev3q"></p>
<p>We can see, that it has selected australiaeast as the location for the resource deployment, as per the custom instructions provided.
We can see that the Terraform code outputted is in the correct format, with the variables in snake_case at the top of the file and the parameters in camelCase with validation and error messages as necessary.
We can see some example GitHub Actions and Azure Pipeline workflows that have been outputted that could be used as a base to deploy our code.
We can see some recommendations for additional guidance on using tools such as Teratest for Terraform testing, and we can see how the code looks like from multiple personas, such as a Site Reliability Engineer, Operations Manager, Microsoft Technical Specialist, Security Consultant, Business Analyst, and On-call Engineer.</p>
<p>My custom prompt is overly large and includes a lot of information <em>(and to be frank, I am trying to do a lot of different things in this particular repository as it's for IaC, where one day it could Terraform and the next Bicep)</em>, but it is a good example of how you can provide custom instructions to GitHub Copilot to help it understand what you are trying to do, to help keep our code standardized and help improve the quality of the outputs.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>If you are looking for guidance on how to develop your own custom prompt, consider using another prompt to help build it out. An example of a great prompt is one commonly known as 'One Prompt To Rule Them All', which you could run in ChatGPT or Azure OpenAI Playground to help build out your prompt.</p><p>The prompt is below:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">I want you to become my Prompt Creator. Your goal is to help me craft the best possible prompt for my needs. The prompt will be used by you, GPT-4. You will follow the following process: 1. Your first response will be to ask me what the prompt should be about. I will provide my answer, but we will need to improve it through continual iterations by going through the next steps. 2. Based on my input, you will generate 3 sections. a) Revised prompt (provide your rewritten prompt. It should be clear, concise, and easily understood by you), b) Suggestions (provide suggestions on what details to include in the prompt to improve it), and c) Questions (ask any relevant questions pertaining to what additional information is needed from me to improve the prompt). 3. We will continue this iterative process with me providing additional information to you and you updating the prompt in the Revised prompt section until it's complete.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<p>Hopefully, this article helps you get going and use custom instructions and helps provide more standardized outputs.</p>
<p>References:</p>
<ul>
<li><a href="https://docs.github.com/en/copilot/customizing-copilot/adding-custom-instructions-for-github-copilot?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Adding custom instructions for GitHub Copilot</a></li>
<li><a href="https://luke.geek.nz/azure/Getting-Started-with-GitHub-Codespaces/" target="_blank" rel="noopener noreferrer">Coding on the Cloud - Getting Started with GitHub Codespaces</a></li>
<li><a href="https://luke.geek.nz/azure/iac-github-codespace/" target="_blank" rel="noopener noreferrer">Infrastructure as Code GitHub Codespace Template</a></li>
</ul>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Azure Resource - Change Analysis]]></title>
            <link>https://luke.geek.nz/azure/change-analysis/</link>
            <guid>https://luke.geek.nz/azure/change-analysis/</guid>
            <pubDate>Wed, 30 Oct 2024 09:01:07 GMT</pubDate>
            <description><![CDATA[A comprehensive guide on using Change Analysis in Azure Monitor to track changes on your Azure resources.]]></description>
            <content:encoded><![CDATA[<p>Who created my resource? What created my Azure resource? We often ask ourselves these questions when troubleshooting or trying to understand the state of our Azure resources.</p>
<p><a href="https://learn.microsoft.com/azure/azure-monitor/change/change-analysis?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Change Analysis</a> is a feature in Azure Monitor that helps you answer these questions. Change Analysis helps to provide a view of the changes that have occurred on your Azure resources over time, using the <a href="https://learn.microsoft.com/azure/governance/resource-graph/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Resource Graph</a>.</p>
<!-- -->
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="https://luke.geek.nz/azure/change-analysis/#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">‚Äã</a></h2>
<p>Today, we will look at Change Analysis to see:</p>
<p>A. Can we see the changes that have occurred on our Azure resources?
B. Can we see the changes that have occurred on our Azure resources over time?
C. Can we tell who made the change?
D. Can we determine what made the change?</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Change Analysis in the portal</p><p>Change Analysis experiences across the Azure portal are powered using the Azure Resource Graph Microsoft.ResourceGraph/resources API. You can query this API for changes made to many of the Azure resources you interact with, including App Services (Microsoft.Web/sites) or Virtual Machines (Microsoft.Compute/virtualMachines).</p><p>The Azure Resource Graph Change Analysis portal experience provides the following:</p><ul>
<li>An onboarding-free experience, giving all subscriptions and resources access to change history.</li>
<li>Tenant-wide querying rather than select subscriptions.</li>
<li>Change history summaries aggregated into cards at the top of the new Resource Graph Change Analysis.</li>
<li>More extensive filtering capabilities.</li>
<li>Improved accuracy and relevance of changed by information, using Change Actor functionality.</li>
</ul><p>Learn how to <a href="https://learn.microsoft.com/en-us/azure/governance/resource-graph/changes/view-resource-changes?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">view the new Change Analysis experience in the portal</a>.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="can-we-see-the-changes-that-have-occurred-on-our-azure-resources">Can we see the changes that have occurred on our Azure resources?<a href="https://luke.geek.nz/azure/change-analysis/#can-we-see-the-changes-that-have-occurred-on-our-azure-resources" class="hash-link" aria-label="Direct link to Can we see the changes that have occurred on our Azure resources?" title="Direct link to Can we see the changes that have occurred on our Azure resources?">‚Äã</a></h2>
<blockquote>
<p>Yes, we can see the changes that have occurred on our Azure resources. Change Analysis provides a view of the changes on your Azure resources over time. You can see the changes that have occurred on your Azure resources in the last 14 days.</p>
</blockquote>
<p>If we navigate to the <a href="https://portal.azure.com/#view/Microsoft_Azure_OneInventory/ResourceChangesOverview.ReactView" target="_blank" rel="noopener noreferrer">Change Analysis (Preview)</a> blade in the Azure portal, we can see the changes that have occurred on our Azure resources.</p>
<p><img decoding="async" loading="lazy" alt="Change Analysis" src="https://luke.geek.nz/assets/images/AzurePortal_ChangeAnalysis-1dcdda4ef769b7a1f7a4812bb06e202a.gif" width="1896" height="917" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>The blur is intentional, as part of the <a href="https://luke.geek.nz/azure/cloudcloak/" target="_blank" rel="noopener noreferrer">Cloudclock</a> extension to protect sensitive information.</p></div></div>
<p>We can see the changes (Create, Update, and Delete) that have occurred on our Azure resources. We can even group them by resource or by who made the change.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="can-we-see-the-changes-on-our-azure-resources-over-time">Can we see the changes on our Azure resources over time?<a href="https://luke.geek.nz/azure/change-analysis/#can-we-see-the-changes-on-our-azure-resources-over-time" class="hash-link" aria-label="Direct link to Can we see the changes on our Azure resources over time?" title="Direct link to Can we see the changes on our Azure resources over time?">‚Äã</a></h2>
<p>By default, we can see the changes over the last 14 days from the Azure Portal.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Changes are queryable for 14 days. For longer retention, you can <a href="https://learn.microsoft.com/en-us/azure/governance/resource-graph/tutorials/logic-app-calling-arg?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">integrate your Resource Graph query with Azure Logic Apps</a> and manually export query results to any of the Azure data stores like <a href="https://learn.microsoft.com/en-us/azure/azure-monitor/logs/log-analytics-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Log Analytics</a> for your desired retention.</p></div></div>
<p>A KQL query to see the changes over the last 14 days would look like:</p>
<div class="language-kql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-kql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">resourcechanges</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| where type == "microsoft.resources/changes"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| project id, resourceid = properties.targetResourceId, changeType = properties.changeType, clientType = properties.changeAttributes.clientType, changedBy = properties.changeAttributes.changedBy</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If you want to target a specific resource, you can use a query like:</p>
<div class="language-kql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-kql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">resourcechanges</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| where type == "microsoft.resources/changes"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| where properties.targetResourceId contains  "ResourceName"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| project id, resourceId = properties.targetResourceId, resourceType = properties.targetResourceType, changeType = properties.changeType, clientType = properties.changeAttributes.clientType, changedBy = properties.changeAttributes.changedBy</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Replace the <code>ResourceName</code> with the name of the resource you are looking for. These queries can also be integrated into the Logic App for export.</p>
<p>You can also run these queries directly from the Azure Portal by navigating to the <a href="https://portal.azure.com/#view/HubsExtension/ArgQueryBlade/query/resourcechanges" target="_blank" rel="noopener noreferrer">Azure Resource Graph Explorer</a> blade.</p>
<p><img decoding="async" loading="lazy" alt="Azure Resource Graph Explorer" src="https://luke.geek.nz/assets/images/AzurePortal_AzureResourceGraph_Query-b6de8f6fd5bf1617e1226cab516e6c00.png" width="1828" height="859" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>Currently, Azure Resource Graph doesn't:</p><p>Observe changes made to a resource's data plane API, such as writing data to a table in a storage account.
Support file and configuration changes over App Service.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="can-we-tell-who-made-the-change">Can we tell who made the change?<a href="https://luke.geek.nz/azure/change-analysis/#can-we-tell-who-made-the-change" class="hash-link" aria-label="Direct link to Can we tell who made the change?" title="Direct link to Can we tell who made the change?">‚Äã</a></h2>
<blockquote>
<p>Yes, we can tell who made the change. Change Analysis provides the <code>changedBy</code> field, which tells us who made the change.</p>
</blockquote>
<p>In my examples, we can see the <code>changedBy</code> field in the query results. This field tells us who made the change.</p>
<p><img decoding="async" loading="lazy" alt="Azure Resource Graph Explorer" src="https://luke.geek.nz/assets/images/AzurePortal_AzureResourceGraph_Query-b6de8f6fd5bf1617e1226cab516e6c00.png" width="1828" height="859" class="img_ev3q"></p>
<p>It could be the user or the service principal that made the change. In this example, I can see:</p>
<ul>
<li>A Network interface resource was created by <code>2cf9eb86-36b5-49dc-86ae-9a63135dfa8c</code>, which is the Application ID of a Microsoft-owned Registration for Azure Traffic Manager and DNS.</li>
<li>A Deletion of the network interface was done by <code>Luke@geek,</code> which is my user account.</li>
</ul>
<p>SOME Azure resources <em>(with the latest API)</em> such as this Data Collection Rule, contains the information in the resource metadata.</p>
<p><img decoding="async" loading="lazy" alt="JSON - ChangedBy" src="https://luke.geek.nz/assets/images/AzurePortal_DCR_JSON-8425d2fb17e95a8e9ffc9fcc93da1169.png" width="1539" height="1027" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="can-we-determine-what-made-the-change">Can we determine what made the change?<a href="https://luke.geek.nz/azure/change-analysis/#can-we-determine-what-made-the-change" class="hash-link" aria-label="Direct link to Can we determine what made the change?" title="Direct link to Can we determine what made the change?">‚Äã</a></h2>
<blockquote>
<p>Yes, we can determine what caused the change. Change Analysis provides the <code>clientType</code> field, which tells us what caused the change. However, as we can see in the previous screenshots, this is not always as accurate as we may want it to be. However, it's good enough that you can infer what may have issued the changes.</p>
</blockquote>
<p>Some of the clientType values you may see are:</p>
<ul>
<li><code>Azure Portal</code> - Changes made from the Azure Portal.</li>
<li><code>Unknown</code> - A change happened to a client that is unrecognized.</li>
<li><code>CLI</code> - Changes made from Azure CLI.</li>
<li><code>Unspecified</code> - Unspecified is displayed when the resource is missing changedByType values and could be missing for either Creates or Updates. It could also mean changes are performed in the background by Azure services and not user initiatied.</li>
<li><code>ARM Template</code> - Changes made from an ARM Template, whether deployed automatically or via a 'Deploy to Azure' button. This also includes changes made by Bicep.</li>
<li><code>System</code> - System is displayed as a changedBy value when a background change occurred that wasn't correlated with any direct user action.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="references">References<a href="https://luke.geek.nz/azure/change-analysis/#references" class="hash-link" aria-label="Direct link to References" title="Direct link to References">‚Äã</a></h2>
<p>To learn more about Change Analysis, check out the following resources:</p>
<ul>
<li><a href="https://learn.microsoft.com/azure/governance/resource-graph/changes/resource-graph-changes?WT.mc_id=AZ-MVP-5004796#change-analysis-in-azure-resource-graph-vs-azure-monitor" target="_blank" rel="noopener noreferrer">Change Analysis in Azure Resource Graph vs. Azure Monitor</a></li>
<li><a href="https://techcommunity.microsoft.com/t5/azure-governance-and-management/announcing-the-general-availability-of-change-actor/ba-p/4171801?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Announcing the General Availability of Change Actor</a></li>
</ul>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Book Review - Kubernetes ‚Äì An Enterprise Guide]]></title>
            <link>https://luke.geek.nz/misc/kubernetes-enterprise-guide-book-review/</link>
            <guid>https://luke.geek.nz/misc/kubernetes-enterprise-guide-book-review/</guid>
            <pubDate>Wed, 23 Oct 2024 22:24:17 GMT</pubDate>
            <description><![CDATA[Review of "Kubernetes - An Enterprise Guide" by Marc Boorshtein and Scott Surovich, covering Kubernetes concepts, deployments, and best practices.]]></description>
            <content:encoded><![CDATA[<p>I had the privilege to be able to read and review the ‚Äò<a href="https://www.amazon.com.au/Kubernetes-Enterprise-Effectively-containerize-applications-dp-1835086950/dp/1835086950" target="_blank" rel="noopener noreferrer"><strong>Kubernetes - An Enterprise Guide</strong></a>‚Äô book by <a href="https://www.linkedin.com/in/marc-boorshtein-5979a82/" target="_blank" rel="noopener noreferrer">Marc Boorshtein</a> <em>(Author)</em>, <a href="https://www.linkedin.com/in/scottsurovich/" target="_blank" rel="noopener noreferrer">Scott Surovich</a> <em>(Author)</em>. Packt Publishing publishes the book and is available on Amazon.</p>
<blockquote>
<p>This was the third edition of the book, but I feel there was no need to read the previous editions to understand the content of this book. Being the third edition also means that any mistakes or learnings from the past two editions have been considered.</p>
</blockquote>
<p><img decoding="async" loading="lazy" alt="Kubernetes - An Enterprise Guide" src="https://luke.geek.nz/assets/images/kubernetes_enterpriseguide-book-715f446a94cceccd59f5b3e6ee73d779.jpg" width="3072" height="4080" class="img_ev3q"></p>
<!-- -->
<blockquote>
<p>The book is a great read for anyone looking to understand Kubernetes from the ground up. The book is divided into 18 chapters and covers a wide range of topics, from the basics of Kubernetes to advanced topics like security, monitoring, and troubleshooting. The book is written in a language that is very easy to understand and is full of examples and diagrams to help you understand the concepts better.</p>
</blockquote>
<p>Let's dig into this a bit more:</p>
<p>First, the vision of the book is really about focusing on what you need to run Kubernetes in an Enterprise environment, based on the real-world experience from the authors, so naturally, the questions I wanted to know if this book would answer in its 623 pages of content were:</p>
<ol>
<li>Does it adequately cover core Kubernetes concepts relevant to enterprises?</li>
<li>Does it address multi-cluster and multi-cloud Kubernetes deployments?</li>
<li>Is the information backed by research, case studies, or industry best practices?</li>
<li>Is the content accessible to the intended readers, whether they are developers, operations staff, or managers?</li>
</ol>
<p>So, let‚Äôs go through each of these:</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="q-does-it-adequately-cover-core-kubernetes-concepts-that-are-relevant-to-enterprises"><strong>Q. Does it adequately cover core Kubernetes concepts that are relevant to enterprises?</strong><a href="https://luke.geek.nz/misc/kubernetes-enterprise-guide-book-review/#q-does-it-adequately-cover-core-kubernetes-concepts-that-are-relevant-to-enterprises" class="hash-link" aria-label="Direct link to q-does-it-adequately-cover-core-kubernetes-concepts-that-are-relevant-to-enterprises" title="Direct link to q-does-it-adequately-cover-core-kubernetes-concepts-that-are-relevant-to-enterprises">‚Äã</a></h2>
<p><strong>I can say yes ‚Äì it does!</strong></p>
<p>The book introduces Docker and container essentials, explaining the need for containerization and how Docker works. It also covers the installation and usage of Docker before going into deploying your own Kubernetes cluster with KinD and the various components that make up Kubernetes. It covers concepts such as Ingress, Deployment, and Services, then exposes Load Balancer options, DNS considerations, and identity across multiple chapters.</p>
<ul>
<li>Now, let us look at <strong>Q. Does it address multi-cluster and multi-cloud Kubernetes deployments?</strong></li>
</ul>
<blockquote>
<p><strong>Kind of!</strong></p>
</blockquote>
<p>As alluded to, it goes through setting up KinD (Kubernetes in Docker) multi-cluster configurations, and Kubelet options, multi-tenant vCluster configuration, global load balancing!</p>
<p>However, this book ‚Äì takes a neutral stance on specific Cloud deployment options, i.e., AKS and EKS, concentrating more on integration, and what's happening in the cluster, vs the opinionated Cloud provider implementations, it does, however, touch on various integrations ‚Äì with identity being a key component ‚Äì with some demos <em>(as part of a GitHub)</em> repository to match, if you are looking for a book all about AKS and Cloud deployment ‚Äì then in my opinion not the book for you, HOWEVER, if you want to know what is happening in the background, and WHY the clusters, nodes, namespaces operate the way they do ‚Äì then this is an ideal book, to understand full the concepts, which doesn‚Äôt make it less valuable, but more of a supplement for fully understanding what those Cloud providers obfuscate from.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="q-is-the-information-backed-by-research-case-studies-or-industry-best-practices"><strong>Q. Is the information backed by research, case studies, or industry best practices?</strong><a href="https://luke.geek.nz/misc/kubernetes-enterprise-guide-book-review/#q-is-the-information-backed-by-research-case-studies-or-industry-best-practices" class="hash-link" aria-label="Direct link to q-is-the-information-backed-by-research-case-studies-or-industry-best-practices" title="Direct link to q-is-the-information-backed-by-research-case-studies-or-industry-best-practices">‚Äã</a></h2>
<p>I always consider this, as it removes any bias the authors may have, with more generalized guidance discovered from sweat and tears in the industry in general, and I can confirm that indeed it does!
The book features many real-world examples based on issues the authors have experienced throughout the years and resolutions on how they have been implemented. It also references external (trusted‚Äîi.e., kubernetes.io) sources where needed to point readers to additional information.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="q-is-the-content-accessible-to-the-intended-readers-whether-they-are-developers-operations-staff-or-managers"><strong>Q. Is the content accessible to the intended readers, whether they are developers, operations staff, or managers?</strong><a href="https://luke.geek.nz/misc/kubernetes-enterprise-guide-book-review/#q-is-the-content-accessible-to-the-intended-readers-whether-they-are-developers-operations-staff-or-managers" class="hash-link" aria-label="Direct link to q-is-the-content-accessible-to-the-intended-readers-whether-they-are-developers-operations-staff-or-managers" title="Direct link to q-is-the-content-accessible-to-the-intended-readers-whether-they-are-developers-operations-staff-or-managers">‚Äã</a></h2>
<blockquote>
<p><strong>Short answer Yes!</strong></p>
</blockquote>
<p>My background is in system administration (15+ years), so I approached this more from an operations and delivery perspective than a developer, so I have some bias there in my review. However, the key points are:</p>
<p>The book covered a great introduction into the concepts that make up Kubernetes, each chapter included step by step instructions, example demos supplied from a public git repo so get hands on (which was great!), managing secrets and cluster security with Gatekeeper and Dashboards!</p>
<p>I would say, yes, this book definitely covers it for developers and operations staff. It is more aligned to technical readers. However, as a Manager, there are a lot of concepts you can pick up as well, and the chapters can be skipped easily due to their names of build and deploy if not of interest.</p>
<p><strong>All in all ‚Äì this is a great resource! I learned a few things, It's great to get hands-on with the guides and knowledge checks at the end of the book! Add and read this if you want to understand Kubernetes. It builds your knowledge up from concepts, so it‚Äôs a book that can meet you where you are!</strong></p>
<blockquote>
<p>The authors spent much time working on this book, training, and demo material, and you can tell!</p>
</blockquote>
<p>I‚Äôm going to need to get a bigger bookshelf!</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>You can find the repository for the book here:</p><ul>
<li><a href="https://github.com/PacktPublishing/Kubernetes-An-Enterprise-Guide-Third-Edition" target="_blank" rel="noopener noreferrer">PacktPublishing/Kubernetes-An-Enterprise-Guide-Third-Edition</a></li>
</ul></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>If you purchase the physical book, you can also get a free eBook version from a QR code supplied on the pages of the book, which is common with many PacktPublishing books. So keep this in mind if you're like me and like switching between the physical book and an e-reader like a Kindle!</p></div></div>]]></content:encoded>
            <category>Misc</category>
        </item>
        <item>
            <title><![CDATA[Common Challenges and Solutions for Azure OpenAI Adoption]]></title>
            <link>https://luke.geek.nz/azure/openai-adoption-challenges-solutions/</link>
            <guid>https://luke.geek.nz/azure/openai-adoption-challenges-solutions/</guid>
            <pubDate>Tue, 15 Oct 2024 05:08:39 GMT</pubDate>
            <description><![CDATA[Explore common challenges in adopting Azure OpenAI and learn how to overcome them with best practices and solutions.]]></description>
            <content:encoded><![CDATA[<p>When considering <a href="https://learn.microsoft.com/azure/ai-services/openai/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Open AI</a> adoption, there are some common challenges that you might face. These include:</p>
<ul>
<li>Protecting confidential information.</li>
<li>End-to-end observability.</li>
<li>Disable inferencing via Azure AI Studio</li>
<li>Protect from OWASP's Top 10 threats</li>
</ul>
<!-- -->
<p>So, let's take a look at each of these challenges and how you can overcome them.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-overview">üìÑ Overview<a href="https://luke.geek.nz/azure/openai-adoption-challenges-solutions/#-overview" class="hash-link" aria-label="Direct link to üìÑ Overview" title="Direct link to üìÑ Overview">‚Äã</a></h2>
<p>When considering <a href="https://learn.microsoft.com/azure/ai-services/openai/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Open AI</a> adoption, there are some common challenges or considerations you might face, especially when looking at your solution's Day 1 and Day 2 lifecycles.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Software life cycle stages are typically broken down into the following stages:</p><ul>
<li>Day 0  - Design and build stage</li>
<li>Day 1  - Infrastructure and code deployment stage</li>
<li>Day 2  - Runtime</li>
</ul><p><img decoding="async" loading="lazy" alt="Day 0, Day 1, Day 2" src="https://luke.geek.nz/assets/images/day0-day1-day2-blogpost-11ed45fb967a3750c02e466c11a997e3.png" width="1780" height="1048" class="img_ev3q"></p></div></div>
<p>Today, we will look at common challenges and how we can overcome, work around, or mitigate them.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-landing-zone">üõ¨ Landing Zone<a href="https://luke.geek.nz/azure/openai-adoption-challenges-solutions/#-landing-zone" class="hash-link" aria-label="Direct link to üõ¨ Landing Zone" title="Direct link to üõ¨ Landing Zone">‚Äã</a></h2>
<p>When considering Azure Open AI adoption, having a well-defined landing zone for your platform architecture and application is important.</p>
<p>This is where you will deploy your AI solution.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>An <a href="https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/landing-zone/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure landing zone</a> is an environment that follows key design principles across eight design areas. These design principles accommodate all application portfolios and enable application migration, modernization, and innovation at scale. An Azure landing zone uses subscriptions to isolate and scale application resources and platform resources. Subscriptions for application resources are called application landing zones, and subscriptions for platform resources are called platform landing zones.</p></div></div>
<p><strong>Ask</strong>:</p>
<p>Establish an Azure Landing Zone to place the Azure OpenAI solution into.</p>
<p><strong>Challenge</strong>:</p>
<ul>
<li>Ensuring a well-architected foundation</li>
<li>Need for compliance and security guardrails</li>
</ul>
<table><thead><tr><th>Why</th><th>Risk / Impact</th><th>Solution</th></tr></thead><tbody><tr><td>Solid foundation for cloud adoption</td><td>Risk ‚Äì High; Impact ‚Äì High</td><td>- Implement Azure Landing Zone - Include Identity, Security, and Network configurations - Address compliance and governance from the start - Provides a scalable and secure environment</td></tr></tbody></table>
<p><strong>Rationale</strong>:</p>
<p>Implementing an Azure Landing Zone ensures a secure and compliant foundation for deploying Azure OpenAI solutions. Providing necessary guardrails and governance helps mitigate the high risks and impacts of cloud adoption.</p>
<p><strong>Action</strong>:</p>
<p>Implement an Azure Landing Zone for your Azure OpenAI solution. Include Identity, Security, and Network configurations. Address compliance and governance from the start. For Platform Landing Zone recommendations, refer to the <a href="https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/landing-zone/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Cloud Adoption Framework - Ready</a>.</p>
<p>However, for more specific Azure OpenAI application landing zone considerations, we can view the <a href="https://learn.microsoft.com/azure/architecture/ai-ml/architecture/baseline-openai-e2e-chat?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">chat baseline architecture at the Azure Architecture Center</a> for reference.</p>
<p><img decoding="async" loading="lazy" alt="Azure Landing Zone" src="https://luke.geek.nz/assets/images/azure-openai-baseline-landing-zone-b1ee00fd449b9d67f722788821a42ae0.png" width="1346" height="1206" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>Azure Landing Zones consist of more than just a place to store your resources; they should also include considerations for people/processes and products to run your applications at scale. I highly recommend going through the <a href="https://learn.microsoft.com/en-us/assessments/21765fea-dfe6-4bc4-8bb7-db9df5a6f6c0/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Landing Zone Review</a> to ensure you have a solid foundation for your Azure OpenAI solution, and Azure workloads in general.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-protect-confidential-information">üîí Protect confidential information<a href="https://luke.geek.nz/azure/openai-adoption-challenges-solutions/#-protect-confidential-information" class="hash-link" aria-label="Direct link to üîí Protect confidential information" title="Direct link to üîí Protect confidential information">‚Äã</a></h2>
<p>When considering Azure Open AI adoption, confidential information, including data, code, and other sensitive information, must be protected.</p>
<p>It is important to ensure that your data is protected, especially when you use the <a href="https://learn.microsoft.com/azure/architecture/ai-ml/guide/rag/rag-solution-design-and-evaluation-guide?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">RAG (Retrieval Augmented Generation) pattern</a>, which allows you to use your own data.</p>
<p><strong>Ask</strong>:</p>
<p>Establish an Azure Landing Zone to place Azure OpenAI solution into</p>
<p><strong>Challenge</strong>:</p>
<p>Ensuring a well-architected foundation
Need for compliance and security guardrails</p>
<table><thead><tr><th>Why</th><th>Risk / Impact</th><th>Solution</th></tr></thead><tbody><tr><td>- Solid foundation for cloud adoption- Critical for enterprise-grade workloads- Ensures compliance and governance</td><td>Risk ‚Äì HighImpact ‚Äì High</td><td>- Implement Azure Landing Zone- Include Identity, Security, and Network configurations - Address compliance and governance from the start- Provides a scalable and secure environment</td></tr></tbody></table>
<p><strong>Rationale</strong>:</p>
<p>Starting with Public and internal data reduces the Impact from high to low. With lower overall risk, an organization can have faster initial adoption by the time they build additional guardrails for governance and compliance in place <em>(Audit, Monitoring, and enterprise architecture)</em>.</p>
<p><strong>Action</strong>:</p>
<p>Use Platform and resource capabilities to lock down access to confidential information. For example, use Azure Key Vault to store and manage secrets, and use Azure Policy to enforce compliance of those policies.</p>
<ul>
<li>Make use of Infrastructure as Code <em>(IaC)</em>, or <a href="https://learn.microsoft.com/en-us/azure/ai-services/openai/how-to/create-resource?pivots=web-portal&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">deploy the services manually</a> to ensure that your Azure OpenAI solution is deployed in a secure and compliant manner, vs automated methods, that may automatically create the resources you need <em>(and sometimes more than you need)</em> such as Azure AI Studio with Public endpoints.</li>
<li>Make use of <a href="https://learn.microsoft.com/azure/ai-services/openai/how-to/role-based-access-control?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Role-based access control (RBAC) to ensure that only authorized users</a> have access to your Azure OpenAI solution.</li>
<li><a href="https://learn.microsoft.com/azure/storage/common/shared-key-authorization-prevent?tabs=portal&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Disable access keys for Storage accounts</a>, and make sure of <a href="https://learn.microsoft.com/entra/identity/managed-identities-azure-resources/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Managed Identities</a> for inter-Azure resource permissions.</li>
<li>Determine if the risk is high enough to manage the keys yourself using <a href="https://learn.microsoft.com/en-us/azure/storage/common/customer-managed-keys-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Customer Managed Keys</a> for your Storage account.</li>
<li>Make use of <a href="https://learn.microsoft.com/en-us/azure/private-link/private-endpoint-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Private Endpoints</a> and disable access to the public internet where possible, and monitor private endpoint <em>(East/West)</em> traffic, using a Network Virtual Appliance, such as <a href="https://learn.microsoft.com/azure/firewall/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Firewall</a>.</li>
<li>Make use of in-built Azure policies to enforce compliance, such as <a href="https://learn.microsoft.com/azure/storage/common/policy-reference?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Storage account public access should be disallowed</a>.</li>
<li>Make sure your data lifecycle is managed correctly, that you are not storing data longer than you need to, and that you are not storing data that you do not need to, you can make use of <a href="https://learn.microsoft.com/azure/storage/blobs/lifecycle-management-policy-configure?tabs=azure-portal&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">lifecycle management policies</a>, to assist with the technical aspects of this, and the Cloud Adoption Framework has some <a href="https://learn.microsoft.com/azure/cloud-adoption-framework/scenarios/cloud-scale-analytics/govern?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">guidance for Data governance</a>.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-end-to-end-observability">üîç End-to-end observability<a href="https://luke.geek.nz/azure/openai-adoption-challenges-solutions/#-end-to-end-observability" class="hash-link" aria-label="Direct link to üîç End-to-end observability" title="Direct link to üîç End-to-end observability">‚Äã</a></h2>
<p>When considering Azure Open AI adoption, it is important to have end-to-end observability. This includes monitoring, logging, and tracing.</p>
<p>Observability for Azure Open AI has come a long way, with greater capabilities being integrated into products, such as <a href="https://learn.microsoft.com/azure/api-management/api-management-key-concepts?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure API Management</a> features, commonly referred to as an <a href="https://learn.microsoft.com/ai/playbook/technology-guidance/generative-ai/dev-starters/genai-gateway/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">AI Gateway</a>.</p>
<p><img decoding="async" loading="lazy" alt="Azure API Management" src="https://luke.geek.nz/assets/images/conceptual-architecture-ai-gw-9764a645c85341ef3fca25ac16b87704.png" width="731" height="421" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>I did a blog article on implementing and testing some of the AI Gateway capabilities a few months ago here: <a href="https://luke.geek.nz/azure/implementing-ai-gateway-in-api-management/" target="_blank" rel="noopener noreferrer">Implementing AI Gateway capabilities in API Management</a>, make sure you check this out for a bit more depth, and also <a href="https://luke.geek.nz/azure/implementing-correlation-id-in-api-management/" target="_blank" rel="noopener noreferrer">implementing a correlation ID for API Management</a> requests, to help track client transactions with Azure Application Insights.</p></div></div>
<p><strong>Ask</strong>:</p>
<p>All interactions by data scientists, including prompts &amp; responses, must be logged.</p>
<p><strong>Challenge</strong>:</p>
<p>Azure OpenAI only logs the consumer's user ID but does not log prompts sent or responses received in the Azure Diagnostics table (or anywhere else).</p>
<p>Here's how the table could be updated based on your provided details:</p>
<table><thead><tr><th>Why</th><th>Risk / Impact</th><th>Solution</th></tr></thead><tbody><tr><td>- Lines of businesses that own the data need to ensure there was no misuse of confidential data</td><td>Risk ‚Äì High Impact ‚Äì High</td><td>- Move complete audit trail must be established to create a fully governed environment  - Custom applications that call AOAI should log prompts and responses from their side  - Use Azure API Management services as a middle layer between published services and consuming applications and audience</td></tr></tbody></table>
<p><strong>Rationale</strong>:</p>
<p>Azure OpenAI has minimal capabilities and relies on other products to capture prompts and inferences fully for audit and governance purposes.</p>
<p><strong>Action</strong>:</p>
<ul>
<li>Use <a href="https://learn.microsoft.com/azure/api-management/api-management-key-concepts?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure API Management</a> to capture all interactions between your Azure OpenAI solution and your consumers.</li>
<li>Use <a href="https://learn.microsoft.com/azure/azure-monitor/app/app-insights-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Application Insights</a> to capture all interactions between your Azure OpenAI solution and your consumers. Application Insights works well with API Management.</li>
<li>Make sure of reference architecture, such as the <a href="https://learn.microsoft.com/azure/architecture/ai-ml/openai/architecture/log-monitor-azure-openai?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Implement logging and monitoring for Azure OpenAI models</a> for guidance on how to implement this, and to review what metrics and logs can be pulled from Azure OpenAI logging by default and adding the API Management resource into the solution.</li>
<li>Make sure of the <a href="https://aka.ms/apim/genai/labs" target="_blank" rel="noopener noreferrer">AI-Gateway labs</a>, to help add additional capabilities to your Azure API Management instance, tailored for Azure OpenAI endpoints.</li>
</ul>
<p><img decoding="async" loading="lazy" alt="Azure API Management - AI Gateway" src="https://luke.geek.nz/assets/images/ai-gateway-2de5a7f678e06b3d7e0fbd62f8219972.gif" width="1265" height="387" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-microsoft-to-not-monitor-customer-data">üö´ Microsoft to not monitor customer data<a href="https://luke.geek.nz/azure/openai-adoption-challenges-solutions/#-microsoft-to-not-monitor-customer-data" class="hash-link" aria-label="Direct link to üö´ Microsoft to not monitor customer data" title="Direct link to üö´ Microsoft to not monitor customer data">‚Äã</a></h2>
<p>Prompts and responses are stored by Microsoft by default for <a href="https://learn.microsoft.com/azure/ai-services/openai/concepts/abuse-monitoring?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">abuse monitoring</a> <em>(not accessible to customers)</em>. You may not want Microsoft to have access to this data, including Microsoft support.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Your prompts <em>(inputs)</em> and completions <em>(outputs)</em>, your embeddings, and your training data:</p><p>Are NOT available to other customers.
Are NOT available to OpenAI.
Are NOT used to improve OpenAI models.
Are NOT used to train, retrain, or improve Azure OpenAI Service foundation models.
Are NOT used to improve any Microsoft or 3rd party products or services without your permission or instruction.
Your fine-tuned Azure OpenAI models are available exclusively for your use.
Microsoft operates the Azure OpenAI Service as an Azure service. Microsoft hosts the OpenAI models in its Azure environment, and the Service does NOT interact with any services operated by OpenAI (e.g., ChatGPT or the OpenAI API).</p><p>Reference: <a href="https://learn.microsoft.com/legal/cognitive-services/openai/data-privacy?context=%2Fazure%2Fai-services%2Fopenai%2Fcontext%2Fcontext&amp;tabs=azure-portal&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Data, privacy, and security for Azure OpenAI Service</a></p></div></div>
<p><strong>Ask</strong>:</p>
<p>Confidential data should never be stored anywhere by Microsoft or viewed by any Microsoft support or product team member.</p>
<p><strong>Challenge</strong>:</p>
<p>Microsoft logs all prompts for internal abuse monitoring for 30 days and then deletes them.</p>
<table><thead><tr><th>Why</th><th>Risk / Impact</th><th>Solution</th></tr></thead><tbody><tr><td>Some clients do not want any confidential data in prompts to be viewed by Microsoft support team</td><td><strong>Risk / Impact</strong>: High</td><td>Managed customers can apply for modified access, which stops all prompt logging</td></tr></tbody></table>
<p><strong>Rationale</strong>:</p>
<p>Microsoft‚Äôs managed customers are typically large organizations that trust Microsoft and are deemed responsible for their actions.</p>
<p><img decoding="async" loading="lazy" alt="Azure OpenAI - Data Privacy" src="https://luke.geek.nz/assets/images/azureopenai-promp-flow-2a173526497b10e1548a7135997eea16.jpg" width="1280" height="1125" class="img_ev3q"></p>
<p><strong>Action</strong>:</p>
<ul>
<li><a href="https://learn.microsoft.com/legal/cognitive-services/openai/limited-access?context=%2Fazure%2Fai-services%2Fopenai%2Fcontext%2Fcontext&amp;WT.mc_id=AZ-MVP-5004796#registration-for-modified-content-filters-andor-abuse-monitoring" target="_blank" rel="noopener noreferrer">Managed customers</a> may apply for modified access, which stops all prompt logging.</li>
<li>Make use of <a href="https://learn.microsoft.com/en-us/azure/ai-services/openai/how-to/use-your-data-securely?WT.mc_id=AZ-MVP-5004796#document-level-access-control" target="_blank" rel="noopener noreferrer">Security filters</a> in Azure AI Search, for limiting the data that is returned to the user.</li>
</ul>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Managed partners and customers are customers whose subscriptions are managed by the partner network or customers who are part of the Microsoft Enterprise Agreement program. Managed customers can apply for modified access, which stops all prompt logging. This is a contractual agreement between Microsoft and the customer, and the customer must apply for this access.</p></div></div>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>Also, make sure you talk to your account team and understand the implications of this, as it may affect the way you have architected the solution, the safeguards you may have to add, and your expectations with Microsoft support regarding any data that they may have.</p><p>"Disabling content filtering could fail to block content that violates the <a href="https://learn.microsoft.com/legal/cognitive-services/openai/code-of-conduct?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Microsoft Generative AI Services Code of Conduct</a>. My organization will implement systems and measures to ensure that the organization‚Äôs use of Azure OpenAI complies with the <a href="https://learn.microsoft.com/legal/cognitive-services/openai/code-of-conduct?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Microsoft Generative AI Services Code of Conduct</a>".</p></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>Make sure you take a look at the <a href="https://learn.microsoft.com/en-us/azure/ai-services/openai/how-to/risks-safety-monitor?WT.mc_id=AZ-MVP-5004796#potentially-abusive-user-detection" target="_blank" rel="noopener noreferrer">Use Risks &amp; Safety monitoring</a> in Azure OpenAI Studio functionality, to review any results of the filtering activity. You can use that information to further adjust your filter configuration to serve your specific business needs and <a href="https://learn.microsoft.com/azure/machine-learning/concept-responsible-ai?view=azureml-api-2&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Responsible AI principles</a>.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-disable-inferencing-via-azure-ai-studio">‚öôÔ∏è Disable inferencing via Azure AI Studio<a href="https://luke.geek.nz/azure/openai-adoption-challenges-solutions/#%EF%B8%8F-disable-inferencing-via-azure-ai-studio" class="hash-link" aria-label="Direct link to ‚öôÔ∏è Disable inferencing via Azure AI Studio" title="Direct link to ‚öôÔ∏è Disable inferencing via Azure AI Studio">‚Äã</a></h2>
<p>When considering Azure Open AI adoption, it is important to consider if you want users, to be able to inference using Azure AI Studio; using Azure AI Studio can be a security risk, as it allows users to inference directly from the Azure Portal, bypassing some traceability mechanisms <em>(such as Azure API Management)</em> which you may have in place.</p>
<p><strong>Ask</strong>:</p>
<p>Azure OpenAI Studio should not be available to make any inferencing calls and must be disabled.</p>
<p><strong>Challenge</strong>:
There is no permission or RBAC role that prevents the use of AI Studio.</p>
<p>Here‚Äôs the table with all the missing information added:</p>
<table><thead><tr><th><strong>Why</strong></th><th><strong>Risk / Impact</strong></th><th><strong>Solution</strong></th></tr></thead><tbody><tr><td>Azure OpenAI Studio does not log prompts and responses in the diagnostic logs</td><td>Risk ‚Äì High/Impact ‚Äì High</td><td>- Implement custom logging at the client side to capture relevant details.  - Use alternative logging mechanisms to track prompts and responses securely.</td></tr><tr><td>Azure OpenAI Studio will bypass APIM</td><td>Risk ‚Äì High  Impact ‚Äì High</td><td>- Create an intermediary hop between the client and AOAI service and allow AOAI access only via Private Endpoint (e.g., AppGW/APIM). - Enable end user only via Service Principals (no portal access). - DNS block oai.azure.com.</td></tr></tbody></table>
<p>Rationale:</p>
<p>No other out-of-the-box method exists to disable Azure OpenAI Studio.</p>
<p><strong>Action</strong>:</p>
<ul>
<li>Control access to individual Azure OpenAI instances through <a href="https://learn.microsoft.com/en-gb/azure/ai-services/cognitive-services-virtual-networks?tabs=portal&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">restricting what Virtual Networks</a> can access the OpenAI instance <em>(Service Tags need to be allowed through a Network Security Group)</em>, so make sure you make use of Network Security Groups where possible to only tunnel your approved traffic <em>(i.e., AppGw or APIM only)</em>.</li>
<li>Make use of <a href="https://learn.microsoft.com/en-gb/azure/ai-services/openai/how-to/role-based-access-control?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Role-based access control for Azure OpenAI</a> Service to control who can see what.</li>
<li>Make sure of <a href="https://learn.microsoft.com/en-us/azure/ai-services/policy-reference?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Policy built-in policy definitions for Azure AI services</a> to control network access to your Azure OpenAI instances for existing or new deployments.</li>
<li>Deploy a Custom policy to prevent the creation of Azure OpenAI Studio. Refer to my blog post: <a href="https://luke.geek.nz/azure/policy-deny-creation-azure-openai-studio/" target="_blank" rel="noopener noreferrer">Azure Policy - Deny the creation of Azure OpenAI Studio</a>.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-restrict-models-to-only-certain-users">üö∑ Restrict models to only certain users<a href="https://luke.geek.nz/azure/openai-adoption-challenges-solutions/#-restrict-models-to-only-certain-users" class="hash-link" aria-label="Direct link to üö∑ Restrict models to only certain users" title="Direct link to üö∑ Restrict models to only certain users">‚Äã</a></h2>
<p>When considering Azure Open AI adoption, it is essential to restrict models <em>(or deployments)</em> to only certain users.</p>
<p><strong>Ask</strong>:</p>
<p>The model should be accessible to only the required audience and no one else.</p>
<p><strong>Challenge</strong>:</p>
<p>Azure OpenAI does not have the ability to grant permissions by models.</p>
<p>Here‚Äôs the table with <strong>Risk</strong> and <strong>Impact</strong> on the same row as requested:</p>
<table><thead><tr><th><strong>Why</strong></th><th><strong>Risk / Impact</strong></th><th><strong>Solution</strong></th></tr></thead><tbody><tr><td>Model and data access should follow the principle of least privilege</td><td>Risk ‚Äì High, Impact ‚Äì High</td><td>- Each use case should have its own Azure OpenAI instance. - Deploy approved models for use cases only.  - Segregate duties of model deployment and model consumption via a custom RBAC role with the least privilege.</td></tr></tbody></table>
<p><strong>Rationale</strong>:</p>
<p>Having segregated instances for each use case eliminates the risk of model misuse and data exposure. New models and their inferencing capabilities need to be explicitly approved per use case before they can be leveraged.</p>
<p><strong>Action</strong>:</p>
<ul>
<li><a href="https://learn.microsoft.com/azure/ai-services/openai/how-to/create-resource?pivots=web-portal&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Create and deploy an Azure OpenAI Service resource</a> for each use case, and deploy only approved models for that use case.</li>
<li>Make sure of <a href="https://learn.microsoft.com/en-us/azure/ai-services/openai/how-to/role-based-access-control?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Role-based access control for Azure OpenAI</a> Service to control who can see what, separate the users deploying the Models, to the users consuming the models, for example Cognitive Services OpenAI User to a Managed Identity or user using the deployments.</li>
<li>Make use of <a href="https://learn.microsoft.com/en-us/azure/ai-services/policy-reference?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Policy built-in policy definitions for Azure AI services</a>, to control network access to your Azure OpenAI instances for existing or new deployments, and also restrict the creation of new 'unapproved' Azure OpenAI resources from being created.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-finops---view-total-opex-of-openai">üí∞ FinOps - view total opex of OpenAI<a href="https://luke.geek.nz/azure/openai-adoption-challenges-solutions/#-finops---view-total-opex-of-openai" class="hash-link" aria-label="Direct link to üí∞ FinOps - view total opex of OpenAI" title="Direct link to üí∞ FinOps - view total opex of OpenAI">‚Äã</a></h2>
<p>Consumption per use case could vary by order of magnitude. You may want to have visibility of costs at a service or deployment level, especially for use cases where the Azure OpenAI resource is shared but deployments are spread between projects.</p>
<p><strong>Ask</strong>:</p>
<p>Use cases must be able to view their total spend for the Azure OpenAI service</p>
<p><strong>Challenge</strong>:</p>
<ul>
<li>Cost metrics are available at the service level and select deployments, but not all</li>
<li>Any sharing of Azure OpenAI service makes cost determination not possible</li>
<li>No ability to stop usage beyond spending budget</li>
</ul>
<table><thead><tr><th>Why</th><th>Risk</th><th>Solution</th></tr></thead><tbody><tr><td>- Use case owners need to monitor consumption as they are responsible for cost- Azure OpenAI service can create significant costs depending on usage.</td><td>Risk ‚Äì Medium Impact ‚Äì High</td><td>- Provision each use case in a dedicated instance and a dedicated subscription &amp; resource group, this also ensures full AOAI capacity <em>(Tokens per min)</em> available to use case</td></tr></tbody></table>
<p><strong>Rationale</strong>:</p>
<ul>
<li>By having segregated instances for each use case, it provides accurate cost for each use case.</li>
</ul>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Sharing an instance of Azure OpenAI among multiple tenants can also lead to a <a href="https://learn.microsoft.com/en-us/azure/architecture/antipatterns/noisy-neighbor/noisy-neighbor?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Noisy Neighbor</a> problem. It can cause higher latency for some tenants. You also need to make your application code multitenancy-aware. For example, if you want to charge your customers for the consumption cost of a shared Azure OpenAI instance, implement the logic to keep track of the total number of tokens for each tenant in your application.</p></div></div>
<p><strong>Action</strong>:</p>
<ul>
<li>Provision dedicated instances for each use case and rely on distinct Resource Groups and Subscriptions to separate costs.</li>
<li>Review Cost Management and <a href="https://learn.microsoft.com/en-us/azure/ai-services/openai/how-to/manage-costs?WT.mc_id=AZ-MVP-5004796#monitor-costs" target="_blank" rel="noopener noreferrer">scope the cost per Model tokens</a>.</li>
<li>Make use of API Management, and <a href="https://journeyofthegeek.com/2024/08/22/azure-openai-service-tracking-token-usage-with-apim/" target="_blank" rel="noopener noreferrer">Token Usage</a> and merge that with your billing data.</li>
<li>If the Azure OpenAI instance is part of a wider solution, make sure you tag it with the <a href="https://luke.geek.nz/azure/application-cost-analysis-in-microsoft-azure-with-cm-resource-parent-tag/" target="_blank" rel="noopener noreferrer">cm-resource-parent</a> tag to allow full visibility of the workload's cost.</li>
<li>Understand your throughput requirements and investigate <a href="https://learn.microsoft.com/azure/ai-services/openai/concepts/provisioned-throughput?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">PTU (provisioned throughput units)</a>. You can leverage <a href="https://oai.azure.com/portal/calculator" target="_blank" rel="noopener noreferrer">Azure AI Studio for calculate PTUs</a>.</li>
<li>Review <a href="https://learn.microsoft.com/azure/architecture/guide/multitenant/service/openai?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Multitenancy and Azure OpenAI Service</a> architecture considerations.</li>
</ul>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>You don't pay for PER Azure OpenAI resource; you pay for the tokens consumed, so make sure you understand the <a href="https://azure.microsoft.com/en-us/pricing/details/cognitive-services/openai-service/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">pricing model</a>. Why overcomplicate your solution with a shared resource when you can have a dedicated resource for each use case and have a clear understanding of the costs <em>(and security)</em> associated with that use case?</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-protect-from-owasps-top-10-threats">üõ°Ô∏è Protect from OWASP's Top 10 threats<a href="https://luke.geek.nz/azure/openai-adoption-challenges-solutions/#%EF%B8%8F-protect-from-owasps-top-10-threats" class="hash-link" aria-label="Direct link to üõ°Ô∏è Protect from OWASP's Top 10 threats" title="Direct link to üõ°Ô∏è Protect from OWASP's Top 10 threats">‚Äã</a></h2>
<p>When considering Azure Open AI adoption, it is important to protect from <a href="https://owasp.org/www-project-top-ten/" target="_blank" rel="noopener noreferrer">OWASP Top 10 threats</a>.</p>
<p><img decoding="async" loading="lazy" alt="OWASP Top 10" src="https://luke.geek.nz/assets/images/oswasp-mapping-e753666d28f07abf8f96b4a06bfa9546.png" width="936" height="258" class="img_ev3q"></p>
<p><strong>Ask</strong>:</p>
<p>Service should be protected from OWASP-10 threats.</p>
<p><strong>Challenge</strong>:</p>
<p>Azure OpenAI Service is an API-based service vulnerable to OWASP-10 threats. Web Application Firewalls, which are typically used for this, can block significant legitimate AOAI inferencing calls.</p>
<table><thead><tr><th>Why</th><th>Risk</th><th>Solution</th></tr></thead><tbody><tr><td>- Per the Microsoft shared responsibility model, protection from OWASP-10 threats is customer responsibility</td><td>Risk ‚Äì High Impact ‚Äì High</td><td>- Disable public access to service - Limit exposure to internal traffic only</td></tr><tr><td></td><td></td><td>- Disable file uploads to service via RBAC</td></tr><tr><td></td><td></td><td>- Add AppGW with WAF v2 in front of AOAI (Not recommended)</td></tr></tbody></table>
<p><strong>Rationale</strong>:</p>
<ul>
<li>Limiting internal traffic limits the exposure</li>
<li>Even if an attack is successful from the internal network, there is no data stored in the service to be compromised</li>
</ul>
<p><strong>Action</strong>:</p>
<ul>
<li>Control access to individual Azure OpenAI instances through <a href="https://learn.microsoft.com/en-gb/azure/ai-services/cognitive-services-virtual-networks?tabs=portal&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">restricting what Virtual Networks</a> can access the OpenAI instance <em>(Service Tags need to be allowed through a Network Security Group)</em>, so make sure you make use of Network Security Groups where possible to only tunnel your approved traffic <em>(ie, AppGw or APIM only)</em>.</li>
<li>Make use of <a href="https://learn.microsoft.com/en-gb/azure/ai-services/openai/how-to/role-based-access-control?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Role-based access control for Azure OpenAI</a> Service to control who can see what.</li>
<li>Make sure of <a href="https://learn.microsoft.com/en-us/azure/ai-services/policy-reference?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Policy built-in policy definitions for Azure AI services</a> to control network access to your Azure OpenAI instances for existing or new deployments, and disable public endpoint access.</li>
<li>Make use of <a href="https://learn.microsoft.com/azure/api-management/api-management-key-concepts?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure API Management</a> and <a href="https://learn.microsoft.com/azure/application-gateway/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Application Gateway</a> to block, prevent, and log attempted connections to the solution.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-must-use-customer-managed-keys-cmk">üîë Must use Customer Managed Keys <em>(CMK)</em><a href="https://luke.geek.nz/azure/openai-adoption-challenges-solutions/#-must-use-customer-managed-keys-cmk" class="hash-link" aria-label="Direct link to -must-use-customer-managed-keys-cmk" title="Direct link to -must-use-customer-managed-keys-cmk">‚Äã</a></h2>
<p>All encryption must use <a href="https://learn.microsoft.com/azure/security/fundamentals/key-management?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Customer Managed Keys</a>. I have not personally seen this requirement yet, but it is valid, especially for highly sensitive data and industry requirements (such as Finance).</p>
<p><strong>Ask</strong>:</p>
<ul>
<li>Encryption in Azure OpenAI must be configured to use Customer Managed Keys (CMK).</li>
</ul>
<p><strong>Challenge</strong>:</p>
<ul>
<li>CMK needs to be stored in a KeyVault (in the same region).</li>
<li>AOAI service connection to KeyVault can be over 'Trusted Microsoft Connection' only, and not via KeyVault's private endpoint.</li>
</ul>
<table><thead><tr><th>Why</th><th>Risk</th><th>Solution</th></tr></thead><tbody><tr><td>Per policy, clients typically want to use CMK as opposed to MMK <em>(Microsoft Managed Keys)</em> - CMK configuration will be required to stay compliant with Azure policy</td><td>Risk ‚Äì High Impact ‚Äì High</td><td>- Avoid need for uploading files to Azure OpenAI studio and fine-tuning - Disable public access of KeyVault</td></tr></tbody></table>
<p><strong>Rationale</strong>:</p>
<p><a href="https://learn.microsoft.com/azure/search/search-indexer-howto-access-trusted-service-exception?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Trusted Microsoft connections</a> use the Microsoft backbone network and no public network for communication.</p>
<p><strong>Action</strong>:</p>
<ul>
<li>Azure AI Services support <a href="https://learn.microsoft.com/azure/ai-services/openai/encrypt-data-at-rest?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">encryption of data at rest</a> by either enabling customer-managed keys (CMK) or by enabling customers to bring their own storage (BYOS). By default, Azure AI services use Microsoft-managed keys to encrypt the data. With <a href="https://learn.microsoft.com/azure/ai-services/encryption/cognitive-services-encryption-keys-portal?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Customer-managed keys for encryption</a>, customers now have the choice of encrypting the data at rest with an encryption key, managed by the customers, using Azure Key Vault. There is an additional cost, as you are charged for the Key Vault and additional dependant services, as using Customer Managed Keys brings resources <em>(usually managed by Microsoft in a separate siloed subscription)</em> into your own subscription in a separate managed Resource Group.</li>
</ul>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>When considering customer-managed keys, consider People, Processes, and Products. You should have processes in place for the key lifecycles <em>(rotation, revocation, etc)</em>. Also, consider the implications of the additional costs associated with this and the additional management overhead. Be pragmatic about using Customer-Managed Keys and understand the implications of using them.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-must-not-use-shareable-access-controls">‚ùå Must not use shareable access controls<a href="https://luke.geek.nz/azure/openai-adoption-challenges-solutions/#-must-not-use-shareable-access-controls" class="hash-link" aria-label="Direct link to ‚ùå Must not use shareable access controls" title="Direct link to ‚ùå Must not use shareable access controls">‚Äã</a></h2>
<p>Shareable access controls are considered less secure.</p>
<p><strong>Ask</strong>:</p>
<ul>
<li>No use of passwords or access keys to access the Azure OpenAI service.</li>
</ul>
<p><strong>Challenge</strong>:</p>
<ul>
<li>The use of keys is typically less secure and unacceptable in the long term, although it typically increases the pace of initial adoption. This makes the use of Service Principals also less secure.</li>
</ul>
<table><thead><tr><th>Why - Shareable access details</th><th>Risk Risk ‚Äì</th><th>Solution - Use RBAC for access</th></tr></thead><tbody><tr><td>can be transferred to unapproved consumers, losing audit trail - Bearer token of authenticated user can be potentially misused</td><td>High Impact ‚Äì High</td><td>control to service for end users as well as applications (consumer and middleware)</td></tr><tr><td></td><td></td><td>- Avoid using the RBAC role with ListKey permissions or use a custom RBAC role</td></tr></tbody></table>
<p><strong>Rationale</strong>:</p>
<p>RBAC <em>(Role-based Access Control)</em> use increases the security score.</p>
<p><strong>Action</strong>:</p>
<ul>
<li>Make use of <a href="https://learn.microsoft.com/en-gb/azure/ai-services/openai/how-to/role-based-access-control?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Role-based access control for Azure OpenAI</a> Service to control who can see what, and make sure you are not using the ListKey permission or a <a href="https://learn.microsoft.com/azure/role-based-access-control/custom-roles?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">custom RBAC</a> role that allows or disallows access to the keys <em>(Microsoft.Storage/storageAccounts/listKeys/action)</em>.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-resource-must-be-in-a-specific-region-only">üåç Resource must be in a specific region only<a href="https://luke.geek.nz/azure/openai-adoption-challenges-solutions/#-resource-must-be-in-a-specific-region-only" class="hash-link" aria-label="Direct link to üåç Resource must be in a specific region only" title="Direct link to üåç Resource must be in a specific region only">‚Äã</a></h2>
<p>Azure OpenAI resources must be in a specific region only. This is a common requirement for data sovereignty and compliance reasons.</p>
<p><strong>Ask</strong>:</p>
<p>Provision Azure OpenAI service in the same region where Express Route terminates</p>
<p><strong>Challenge</strong>:</p>
<p><a href="https://learn.microsoft.com/azure/ai-services/openai/concepts/models?tabs=python-secure&amp;WT.mc_id=AZ-MVP-5004796#model-summary-table-and-region-availability" target="_blank" rel="noopener noreferrer">Azure OpenAI and model capacity are highly variable</a>, and typically may not be available in the same region as customers Express Route region.</p>
<p><strong>Rationale</strong>:</p>
<p>Azure OpenAI Private Endpoints can be created across regions and no VNet is required for operation.</p>
<table><thead><tr><th>Why</th><th>Risk</th><th>Solution</th></tr></thead><tbody><tr><td>Network traffic is monitored for all ingress &amp; egress in a predetermined region</td><td>Risk ‚Äì High Impact ‚Äì High</td><td>- Enable all regions in policy within a geography acceptable to the client</td></tr><tr><td>At times there are regulatory compliance requirements to be in specific geographies</td><td></td><td>- Provision Azure OpenAI service where capacity is available in allowed regions</td></tr><tr><td></td><td></td><td>- Create private endpoint in Express Route region</td></tr></tbody></table>
<p><strong>Rationale</strong>:</p>
<p>Azure OpenAI Private Endpoints can be created across regions and no VNet is required for operation</p>
<ul>
<li>Azure OpenAI in any region can have a <a href="https://learn.microsoft.com/azure/private-link/private-link-faq?WT.mc_id=AZ-MVP-5004796#can-private-endpoint-connect-to-azure-paas-resources-across-azure-regions-" target="_blank" rel="noopener noreferrer">Private Endpoint connected to a VNET <em>(Virtual Network)</em> in a different region</a>.</li>
<li>Make sure of Azure Policy, such as the <a href="https://learn.microsoft.com/azure/cloud-adoption-framework/manage/azure-server-management/common-policies?WT.mc_id=AZ-MVP-5004796#restrict-resource-regions" target="_blank" rel="noopener noreferrer">Restrict resource regions</a> policy, to enforce the region of the Azure OpenAI resource.</li>
<li>Consider <a href="https://learn.microsoft.com/azure/ai-services/openai/how-to/deployment-types?WT.mc_id=AZ-MVP-5004796#global-versus-regional-deployment-types" target="_blank" rel="noopener noreferrer">model deployment types <em>(ie Global vs Regional)</em></a> - remember that your model inference may be in a different region to your actual Azure OpenAI resource, if Global - so need to be considered from a latency and workload variance perspective, however, these are Read Only - so data resiliency should not be a factor, as you can still store your own data in the region of your choice.</li>
</ul>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Azure Policy - Deny the creation of Azure OpenAI Studio]]></title>
            <link>https://luke.geek.nz/azure/policy-deny-creation-azure-openai-studio/</link>
            <guid>https://luke.geek.nz/azure/policy-deny-creation-azure-openai-studio/</guid>
            <pubDate>Mon, 14 Oct 2024 08:20:46 GMT</pubDate>
            <description><![CDATA[Custom policy definition to deny the creation of Azure OpenAI Studio.]]></description>
            <content:encoded><![CDATA[<p>Custom <a href="https://learn.microsoft.com/azure/governance/policy/tutorials/create-custom-policy-definition?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">policy definition</a> to deny the creation of <a href="https://learn.microsoft.com/azure/ai-studio/concepts/ai-resources?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure OpenAI Studio Hubs</a>, which will stop the creation of an Azure OpenAI Studio.</p>
<!-- -->
<p>This custom Azure Policy that denies the creation of Azure OpenAI Studio hubs. Here's a breakdown of its components:</p>
<table><thead><tr><th>Key</th><th>Description</th></tr></thead><tbody><tr><td><strong>policyType</strong></td><td>Specifies that this is a custom policy.</td></tr><tr><td><strong>mode</strong></td><td>Indicates that the policy is indexed, meaning it can be evaluated against existing resources.</td></tr><tr><td><strong>displayName</strong></td><td>A human-readable name for the policy.</td></tr><tr><td><strong>description</strong></td><td>A brief description of what the policy does.</td></tr><tr><td><strong>metadata</strong></td><td>Contains additional information about the policy:</td></tr><tr><td><strong>version</strong></td><td>The version of the policy.</td></tr><tr><td><strong>category</strong></td><td>The category under which this policy falls.</td></tr><tr><td><strong>source</strong></td><td>A URL for more information.</td></tr><tr><td><strong>alzCloudEnvironments</strong></td><td>Specifies the cloud environments where this policy is applicable.</td></tr><tr><td><strong>createdBy</strong></td><td>The creator of the policy.</td></tr><tr><td><strong>lastUpdated</strong></td><td>The date when the policy was last updated.</td></tr><tr><td><strong>parameters</strong></td><td>Defines parameters that can be used within the policy:</td></tr><tr><td><strong>effect</strong></td><td>A parameter that determines the action to take (Audit, Disabled, or Deny).</td></tr><tr><td><strong>type</strong></td><td>The type of the parameter (String).</td></tr><tr><td><strong>metadata</strong></td><td>Additional information about the parameter:</td></tr><tr><td><strong>displayName</strong></td><td>A human-readable name for the parameter.</td></tr><tr><td><strong>description</strong></td><td>A brief description of the parameter.</td></tr><tr><td><strong>allowedValues</strong></td><td>The allowed values for this parameter.</td></tr><tr><td><strong>defaultValue</strong></td><td>The default value for this parameter (Deny).</td></tr><tr><td><strong>policyRule</strong></td><td>Defines the rule that the policy enforces:</td></tr><tr><td><strong>if</strong></td><td>Specifies the conditions to check:</td></tr><tr><td><strong>allOf</strong></td><td>An array of conditions that must all be true.</td></tr><tr><td><strong>field</strong></td><td>The field to check (type and kind).</td></tr><tr><td><strong>equals</strong></td><td>The expected value for the field.</td></tr><tr><td><strong>then</strong></td><td>Specifies the action to take if the conditions are met:</td></tr><tr><td><strong>effect</strong></td><td>The action to take, which is determined by the value of the effect parameter.</td></tr></tbody></table>
<p>This policy checks if a resource is of type Microsoft.MachineLearningServices/workspaces and kind Hub. If both conditions are met, the policy enforces the action specified by the effect parameter, which defaults to "Deny".</p>
<p><img decoding="async" loading="lazy" alt="Azure Policy - Deny the creation of Azure OpenAI Studio" src="https://luke.geek.nz/assets/images/DenyAzureStudioHub_PolicyAzurePortal-2464c7fa2edb6ebc65e6c34f0195b3b7.jpg" width="1362" height="897" class="img_ev3q"></p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"policyType"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Custom"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"mode"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Indexed"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"displayName"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Deny Azure OpenAI Studio creation"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"description"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Deny Azure OpenAI Studio hub creation."</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"metadata"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"version"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"1.0.0"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"category"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Machine Learning"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"source"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"https://luke.geek.nz"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"alzCloudEnvironments"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token string" style="color:rgb(255, 121, 198)">"AzureCloud"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"createdBy"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Luke"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"lastUpdated"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"2024-10-01"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"parameters"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"effect"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">"type"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"String"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">"metadata"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token property">"displayName"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Effect"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token property">"description"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Enable or disable the execution of the policy"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">"allowedValues"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token string" style="color:rgb(255, 121, 198)">"Audit"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token string" style="color:rgb(255, 121, 198)">"Disabled"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token string" style="color:rgb(255, 121, 198)">"Deny"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">"defaultValue"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Deny"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"policyRule"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"if"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">"allOf"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token property">"field"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"type"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token property">"equals"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Microsoft.MachineLearningServices/workspaces"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token property">"field"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"kind"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token property">"equals"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Hub"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"then"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">"effect"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"[parameters('effect')]"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Azure Policy - Deny the creation of Azure OpenAI Studio" src="https://luke.geek.nz/assets/images/DenyAzureStudioHubCreation_PolicyAzurePortal-4f0b0c43493b490c43b6a00e07c738ae.jpg" width="1359" height="527" class="img_ev3q"></p>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Cloudcloak]]></title>
            <link>https://luke.geek.nz/azure/cloudcloak/</link>
            <guid>https://luke.geek.nz/azure/cloudcloak/</guid>
            <pubDate>Sun, 29 Sep 2024 23:37:38 GMT</pubDate>
            <description><![CDATA[Install and test Cloudcloak, a browser extension that hides sensitive information while streaming or presenting Microsoft Cloud Portals.]]></description>
            <content:encoded><![CDATA[<p><a href="https://github.com/microsoft/Cloudcloak" target="_blank" rel="noopener noreferrer">Cloud Cloak</a> is a browser extension for folks streaming or presenting while simultaneously showing one of the Microsoft Cloud Portals. It does its best to hide connection strings, email addresses, avatars, and anything that might show secure or personal information.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>You can consider this the next version/update to <a href="https://github.com/clarkio/azure-mask/" target="_blank" rel="noopener noreferrer">Azure Mask</a> <em>(shout out to Brian Clark for his pioneering work and blessing us to create this one)</em>.</p></div></div>
<p><img decoding="async" loading="lazy" alt="Cloudcloak" src="https://luke.geek.nz/assets/images/cloudcloak-icon-128-797d8ce09303938c3fca00a0c5a6dd8f.png" width="128" height="128" class="img_ev3q"></p>
<!-- -->
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Developed as part of the Microsoft Global Hackathon 2024 üöÄ! This extension helps to 'cloak <em>(i.e., blur)</em>' potentially personable information in the relevant Azure portals that could be mistreated, allowing presenters to focus on the content they are delivering instead of having to worry about the type of information <em>(such as Azure subscription ids)</em>, that people can see.</p><p><img decoding="async" loading="lazy" alt="Cloudcloak" src="https://luke.geek.nz/assets/images/AzurePortal_Cloudcloak_On-c90255421f868b30503c0c00eb6bc45a.jpg" width="1975" height="747" class="img_ev3q"></p><p><a href="https://github.com/microsoft/Cloudcloak" target="_blank" rel="noopener noreferrer">Cloud Cloak</a> is open for contributions, and make sure you provide feedback by opening an issue on how it could be improved further. This is an open-source initiative and not directly supported by Microsoft. At the time of writing, this is the release version of version 1.0.</p></div></div>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>It does not guarantee that all sensitive information is hidden, for example, although the information is hidden in the UI on render, it might still be present in the HTML source code, or the address bar, and link previews.</p></div></div>
<p>So let us see how it works according to GitHub Copilot:</p>
<p>The extension monitors specific websites and, when activated, blurs sensitive information such as email addresses, GUIDs, IP addresses, and phone numbers. It achieves this functionality using a combination of background scripts and content scripts.</p>
<p>The extension is activated by clicking on the extension icon in the browser toolbar. When activated, sensitive information is blurred on the current page. It will remain active until the user deactivates it by clicking on the extension icon again.</p>
<ol>
<li>Initialization: When the extension is installed or updated, it initializes the state from storage and updates the badge for the current tab.
Tab Update/Activation: When a tab is updated or activated, the extension checks if the URL matches one of the specified extensions. If it does, it injects the cloak.js script and updates the badge.</li>
<li>Cloak Mode: When the user clicks the extension icon, the extension toggles the cloak mode. If enabled, it injects the cloak.js script, which identifies and blurs sensitive information on the page.</li>
<li>DOM Changes: The MutationObserver in cloak.js monitors changes in the DOM and reapplies the blur filter to newly added elements containing sensitive information.</li>
</ol>
<table><thead><tr><th><strong>Component</strong></th><th><strong>Description</strong></th></tr></thead><tbody><tr><td><code>manifest.json</code></td><td>Configures the extension with metadata, permissions, and the background script.</td></tr><tr><td><code>background.js</code></td><td>Manages the extension‚Äôs state, handles events, and injects the content script into specified websites.</td></tr><tr><td><code>cloak.js</code></td><td>Contains the logic to identify and blur sensitive information on web pages.</td></tr><tr><td><strong>How It Works</strong></td><td></td></tr><tr><td><code>manifest.json</code></td><td>- Defines metadata, permissions, and the background script. Specifies icons and permissions.</td></tr><tr><td><code>background.js</code></td><td>- Manages the extension‚Äôs state. Injects <code>cloak.js</code> script into the specified tab and frames.</td></tr><tr><td><strong>Event Listeners</strong></td><td></td></tr><tr><td><code>chrome.tabs.onUpdated</code></td><td>Listens for tab updates and injects the script if the URL matches the specified conditions.</td></tr><tr><td><code>chrome.tabs.onActivated</code></td><td>Listens for tab activation and updates the badge accordingly.</td></tr><tr><td><code>chrome.webNavigation.onCompleted</code></td><td>Injects the script into iframes upon navigation completion.</td></tr><tr><td><code>chrome.action.onClicked</code></td><td>Toggles the extension's enabled/disabled state when clicking the action button.</td></tr></tbody></table>
<p>At the time of writing, the following URLs are supported:</p>
<ul>
<li><a href="https://portal.azure.com/" target="_blank" rel="noopener noreferrer">https://portal.azure.com</a></li>
<li><a href="https://ms.portal.azure.com/" target="_blank" rel="noopener noreferrer">https://ms.portal.azure.com</a></li>
<li><a href="https://rc.portal.azure.com/" target="_blank" rel="noopener noreferrer">https://rc.portal.azure.com</a></li>
<li><a href="https://preview.portal.azure.com/" target="_blank" rel="noopener noreferrer">https://preview.portal.azure.com</a></li>
<li><a href="https://entra.microsoft.com/" target="_blank" rel="noopener noreferrer">https://entra.microsoft.com</a></li>
<li><a href="https://intune.microsoft.com/" target="_blank" rel="noopener noreferrer">https://intune.microsoft.com</a></li>
<li><a href="https://ai.azure.com/" target="_blank" rel="noopener noreferrer">https://ai.azure.com</a></li>
<li><a href="https://admin.microsoft.com/" target="_blank" rel="noopener noreferrer">https://admin.microsoft.com</a></li>
<li><a href="https://sip.security.microsoft.com/" target="_blank" rel="noopener noreferrer">https://sip.security.microsoft.com</a></li>
<li><a href="https://purview.microsoft.com/" target="_blank" rel="noopener noreferrer">https://purview.microsoft.com</a></li>
<li><a href="https://make.powerapps.com/" target="_blank" rel="noopener noreferrer">https://make.powerapps.com</a></li>
<li><a href="https://make.preview.powerapps.com/" target="_blank" rel="noopener noreferrer">https://make.preview.powerapps.com</a></li>
<li><a href="https://msazure.visualstudio.com/" target="_blank" rel="noopener noreferrer">https://msazure.visualstudio.com</a></li>
<li><a href="https://github.com/" target="_blank" rel="noopener noreferrer">https://github.com</a></li>
<li><a href="https://copilotstudio.microsoft.com/" target="_blank" rel="noopener noreferrer">https://copilotstudio.microsoft.com</a></li>
<li><a href="https://copilotstudio.preview.microsoft.com/" target="_blank" rel="noopener noreferrer">https://copilotstudio.preview.microsoft.com</a></li>
<li><a href="https://portal.azure.us/" target="_blank" rel="noopener noreferrer">https://portal.azure.us</a></li>
</ul>
<p>However, new URLs can be added by updating the <code>background.js</code> file and reading it in your browser to test locally.</p>
<p>Because of the Chrome event listeners, this extension is only available for Chrome and Edge browsers (and I would assume any other Chrome browser).</p>
<p>So, let's get started with the installation. We will be using Edge, as it's the browser I use mainly for my presentations.</p>
<p>This is an unofficial extension, and at this time, it is not in the Edge or Chrome stores, so it will need to be installed and updated manually. If your browser has multiple profiles, this is also per user profile.</p>
<p>So, let us download the extension from the <a href="https://github.com/microsoft/Cloudcloak" target="_blank" rel="noopener noreferrer">GitHub repository</a> and unzip the file.</p>
<p><img decoding="async" loading="lazy" alt="Download Cloudcloak" src="https://luke.geek.nz/assets/images/Download_Cloudcloak-f4502c278303035fb97448261a01c5d0.gif" width="1876" height="949" class="img_ev3q"></p>
<p>Then, in Edge, go to <code>edge://extensions/</code> and enable Developer mode. Then click on <code>Load unpacked</code> and select the folder where you unzipped the extension.</p>
<p><img decoding="async" loading="lazy" alt="Install Cloudcloak" src="https://luke.geek.nz/assets/images/Install_Cloudcloak-5c29c52a117188a14fe1567f8594447d.gif" width="1903" height="1021" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>After the extension is installed, you can disable Developer mode. For ease of use, you can pin the extension to the toolbar.</p></div></div>
<p>Now, when you are presenting, you can click on the extension icon, which will blur out sensitive information on the page. So, let's test it by navigating to an Azure resource.</p>
<p><img decoding="async" loading="lazy" alt="Cloudcloak On" src="https://luke.geek.nz/assets/images/Test_Cloudcloak-728751552c343add8af59c03e7a171e6.gif" width="1896" height="957" class="img_ev3q"></p>]]></content:encoded>
            <category>Azure</category>
        </item>
    </channel>
</rss>