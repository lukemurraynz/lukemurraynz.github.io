<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>luke.geek.nz Blog</title>
        <link>https://luke.geek.nz/</link>
        <description>luke.geek.nz Blog</description>
        <lastBuildDate>Tue, 15 Oct 2024 05:08:39 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <language>en</language>
        <copyright>Copyright © 2024 luke.geek.nz.</copyright>
        <item>
            <title><![CDATA[Common Challenges and Solutions for Azure OpenAI Adoption]]></title>
            <link>https://luke.geek.nz/azure/openai-adoption-challenges-solutions/</link>
            <guid>https://luke.geek.nz/azure/openai-adoption-challenges-solutions/</guid>
            <pubDate>Tue, 15 Oct 2024 05:08:39 GMT</pubDate>
            <description><![CDATA[Explore common challenges in adopting Azure OpenAI and learn how to overcome them with best practices and solutions.]]></description>
            <content:encoded><![CDATA[<p>When considering <a href="https://learn.microsoft.com/azure/ai-services/openai/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Open AI</a> adoption, there are some common challenges that you might face. These include:</p>
<ul>
<li>Protecting confidential information.</li>
<li>End-to-end observability.</li>
<li>Disable inferencing via Azure AI Studio</li>
<li>Protect from OWASP's Top 10 threats</li>
</ul>
<!-- -->
<p>So, let's take a look at each of these challenges and how you can overcome them.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-overview">📄 Overview<a href="https://luke.geek.nz/azure/openai-adoption-challenges-solutions/#-overview" class="hash-link" aria-label="Direct link to 📄 Overview" title="Direct link to 📄 Overview">​</a></h2>
<p>When considering <a href="https://learn.microsoft.com/azure/ai-services/openai/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Open AI</a> adoption, there are some common challenges or considerations you might face, especially when looking at your solution's Day 1 and Day 2 lifecycles.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Software life cycle stages are typically broken down into the following stages:</p><ul>
<li>Day 0  - Design and build stage</li>
<li>Day 1  - Infrastructure and code deployment stage</li>
<li>Day 2  - Runtime</li>
</ul><p><img decoding="async" loading="lazy" alt="Day 0, Day 1, Day 2" src="https://luke.geek.nz/assets/images/day0-day1-day2-blogpost-11ed45fb967a3750c02e466c11a997e3.png" width="1780" height="1048" class="img_ev3q"></p></div></div>
<p>Today, we will look at common challenges and how we can overcome, work around, or mitigate them.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-landing-zone">🛬 Landing Zone<a href="https://luke.geek.nz/azure/openai-adoption-challenges-solutions/#-landing-zone" class="hash-link" aria-label="Direct link to 🛬 Landing Zone" title="Direct link to 🛬 Landing Zone">​</a></h2>
<p>When considering Azure Open AI adoption, having a well-defined landing zone for your platform architecture and application is important.</p>
<p>This is where you will deploy your AI solution.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>An <a href="https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/landing-zone/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure landing zone</a> is an environment that follows key design principles across eight design areas. These design principles accommodate all application portfolios and enable application migration, modernization, and innovation at scale. An Azure landing zone uses subscriptions to isolate and scale application resources and platform resources. Subscriptions for application resources are called application landing zones, and subscriptions for platform resources are called platform landing zones.</p></div></div>
<p><strong>Ask</strong>:</p>
<p>Establish an Azure Landing Zone to place the Azure OpenAI solution into.</p>
<p><strong>Challenge</strong>:</p>
<ul>
<li>Ensuring a well-architected foundation</li>
<li>Need for compliance and security guardrails</li>
</ul>
<table><thead><tr><th>Why</th><th>Risk / Impact</th><th>Solution</th></tr></thead><tbody><tr><td>Solid foundation for cloud adoption</td><td>Risk – High; Impact – High</td><td>- Implement Azure Landing Zone - Include Identity, Security, and Network configurations - Address compliance and governance from the start - Provides a scalable and secure environment</td></tr></tbody></table>
<p><strong>Rationale</strong>:</p>
<p>Implementing an Azure Landing Zone ensures a secure and compliant foundation for deploying Azure OpenAI solutions. Providing necessary guardrails and governance helps mitigate the high risks and impacts of cloud adoption.</p>
<p><strong>Action</strong>:</p>
<p>Implement an Azure Landing Zone for your Azure OpenAI solution. Include Identity, Security, and Network configurations. Address compliance and governance from the start. For Platform Landing Zone recommendations, refer to the <a href="https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/landing-zone/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Cloud Adoption Framework - Ready</a>.</p>
<p>However, for more specific Azure OpenAI application landing zone considerations, we can view the <a href="https://learn.microsoft.com/azure/architecture/ai-ml/architecture/baseline-openai-e2e-chat?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">chat baseline architecture at the Azure Architecture Center</a> for reference.</p>
<p><img decoding="async" loading="lazy" alt="Azure Landing Zone" src="https://luke.geek.nz/assets/images/azure-openai-baseline-landing-zone-b1ee00fd449b9d67f722788821a42ae0.png" width="1346" height="1206" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>Azure Landing Zones consist of more than just a place to store your resources; they should also include considerations for people/processes and products to run your applications at scale. I highly recommend going through the <a href="https://learn.microsoft.com/en-us/assessments/21765fea-dfe6-4bc4-8bb7-db9df5a6f6c0/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Landing Zone Review</a> to ensure you have a solid foundation for your Azure OpenAI solution, and Azure workloads in general.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-protect-confidential-information">🔒 Protect confidential information<a href="https://luke.geek.nz/azure/openai-adoption-challenges-solutions/#-protect-confidential-information" class="hash-link" aria-label="Direct link to 🔒 Protect confidential information" title="Direct link to 🔒 Protect confidential information">​</a></h2>
<p>When considering Azure Open AI adoption, confidential information, including data, code, and other sensitive information, must be protected.</p>
<p>It is important to ensure that your data is protected, especially when you use the <a href="https://learn.microsoft.com/azure/architecture/ai-ml/guide/rag/rag-solution-design-and-evaluation-guide?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">RAG (Retrieval Augmented Generation) pattern</a>, which allows you to use your own data.</p>
<p><strong>Ask</strong>:</p>
<p>Establish an Azure Landing Zone to place Azure OpenAI solution into</p>
<p><strong>Challenge</strong>:</p>
<p>Ensuring a well-architected foundation
Need for compliance and security guardrails</p>
<table><thead><tr><th>Why</th><th>Risk / Impact</th><th>Solution</th></tr></thead><tbody><tr><td>- Solid foundation for cloud adoption- Critical for enterprise-grade workloads- Ensures compliance and governance</td><td>Risk – HighImpact – High</td><td>- Implement Azure Landing Zone- Include Identity, Security, and Network configurations - Address compliance and governance from the start- Provides a scalable and secure environment</td></tr></tbody></table>
<p><strong>Rationale</strong>:</p>
<p>Starting with Public and internal data reduces the Impact from high to low. With lower overall risk, an organization can have faster initial adoption by the time they build additional guardrails for governance and compliance in place <em>(Audit, Monitoring, and enterprise architecture)</em>.</p>
<p><strong>Action</strong>:</p>
<p>Use Platform and resource capabilities to lock down access to confidential information. For example, use Azure Key Vault to store and manage secrets, and use Azure Policy to enforce compliance of those policies.</p>
<ul>
<li>Make use of Infrastructure as Code <em>(IaC)</em>, or <a href="https://learn.microsoft.com/en-us/azure/ai-services/openai/how-to/create-resource?pivots=web-portal&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">deploy the services manually</a> to ensure that your Azure OpenAI solution is deployed in a secure and compliant manner, vs automated methods, that may automatically create the resources you need <em>(and sometimes more than you need)</em> such as Azure AI Studio with Public endpoints.</li>
<li>Make use of <a href="https://learn.microsoft.com/azure/ai-services/openai/how-to/role-based-access-control?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Role-based access control (RBAC) to ensure that only authorized users</a> have access to your Azure OpenAI solution.</li>
<li><a href="https://learn.microsoft.com/azure/storage/common/shared-key-authorization-prevent?tabs=portal&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Disable access keys for Storage accounts</a>, and make sure of <a href="https://learn.microsoft.com/entra/identity/managed-identities-azure-resources/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Managed Identities</a> for inter-Azure resource permissions.</li>
<li>Determine if the risk is high enough to manage the keys yourself using <a href="https://learn.microsoft.com/en-us/azure/storage/common/customer-managed-keys-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Customer Managed Keys</a> for your Storage account.</li>
<li>Make use of <a href="https://learn.microsoft.com/en-us/azure/private-link/private-endpoint-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Private Endpoints</a> and disable access to the public internet where possible, and monitor private endpoint <em>(East/West)</em> traffic, using a Network Virtual Appliance, such as <a href="https://learn.microsoft.com/azure/firewall/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Firewall</a>.</li>
<li>Make use of in-built Azure policies to enforce compliance, such as <a href="https://learn.microsoft.com/azure/storage/common/policy-reference?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Storage account public access should be disallowed</a>.</li>
<li>Make sure your data lifecycle is managed correctly, that you are not storing data longer than you need to, and that you are not storing data that you do not need to, you can make use of <a href="https://learn.microsoft.com/azure/storage/blobs/lifecycle-management-policy-configure?tabs=azure-portal&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">lifecycle management policies</a>, to assist with the technical aspects of this, and the Cloud Adoption Framework has some <a href="https://learn.microsoft.com/azure/cloud-adoption-framework/scenarios/cloud-scale-analytics/govern?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">guidance for Data governance</a>.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-end-to-end-observability">🔍 End-to-end observability<a href="https://luke.geek.nz/azure/openai-adoption-challenges-solutions/#-end-to-end-observability" class="hash-link" aria-label="Direct link to 🔍 End-to-end observability" title="Direct link to 🔍 End-to-end observability">​</a></h2>
<p>When considering Azure Open AI adoption, it is important to have end-to-end observability. This includes monitoring, logging, and tracing.</p>
<p>Observability for Azure Open AI has come a long way, with greater capabilities being integrated into products, such as <a href="https://learn.microsoft.com/azure/api-management/api-management-key-concepts?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure API Management</a> features, commonly referred to as an <a href="https://learn.microsoft.com/ai/playbook/technology-guidance/generative-ai/dev-starters/genai-gateway/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">AI Gateway</a>.</p>
<p><img decoding="async" loading="lazy" alt="Azure API Management" src="https://luke.geek.nz/assets/images/conceptual-architecture-ai-gw-9764a645c85341ef3fca25ac16b87704.png" width="731" height="421" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>I did a blog article on implementing and testing some of the AI Gateway capabilities a few months ago here: <a href="https://luke.geek.nz/azure/implementing-ai-gateway-in-api-management/" target="_blank" rel="noopener noreferrer">Implementing AI Gateway capabilities in API Management</a>, make sure you check this out for a bit more depth, and also <a href="https://luke.geek.nz/azure/implementing-correlation-id-in-api-management/" target="_blank" rel="noopener noreferrer">implementing a correlation ID for API Management</a> requests, to help track client transactions with Azure Application Insights.</p></div></div>
<p><strong>Ask</strong>:</p>
<p>All interactions by data scientists, including prompts &amp; responses, must be logged.</p>
<p><strong>Challenge</strong>:</p>
<p>Azure OpenAI only logs the consumer's user ID but does not log prompts sent or responses received in the Azure Diagnostics table (or anywhere else).</p>
<p>Here's how the table could be updated based on your provided details:</p>
<table><thead><tr><th>Why</th><th>Risk / Impact</th><th>Solution</th></tr></thead><tbody><tr><td>- Lines of businesses that own the data need to ensure there was no misuse of confidential data</td><td>Risk – High Impact – High</td><td>- Move complete audit trail must be established to create a fully governed environment  - Custom applications that call AOAI should log prompts and responses from their side  - Use Azure API Management services as a middle layer between published services and consuming applications and audience</td></tr></tbody></table>
<p><strong>Rationale</strong>:</p>
<p>Azure OpenAI has minimal capabilities and relies on other products to capture prompts and inferences fully for audit and governance purposes.</p>
<p><strong>Action</strong>:</p>
<ul>
<li>Use <a href="https://learn.microsoft.com/azure/api-management/api-management-key-concepts?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure API Management</a> to capture all interactions between your Azure OpenAI solution and your consumers.</li>
<li>Use <a href="https://learn.microsoft.com/azure/azure-monitor/app/app-insights-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Application Insights</a> to capture all interactions between your Azure OpenAI solution and your consumers. Application Insights works well with API Management.</li>
<li>Make sure of reference architecture, such as the <a href="https://learn.microsoft.com/azure/architecture/ai-ml/openai/architecture/log-monitor-azure-openai?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Implement logging and monitoring for Azure OpenAI models</a> for guidance on how to implement this, and to review what metrics and logs can be pulled from Azure OpenAI logging by default and adding the API Management resource into the solution.</li>
<li>Make sure of the <a href="https://aka.ms/apim/genai/labs" target="_blank" rel="noopener noreferrer">AI-Gateway labs</a>, to help add additional capabilities to your Azure API Management instance, tailored for Azure OpenAI endpoints.</li>
</ul>
<p><img decoding="async" loading="lazy" alt="Azure API Management - AI Gateway" src="https://luke.geek.nz/assets/images/ai-gateway-2de5a7f678e06b3d7e0fbd62f8219972.gif" width="1265" height="387" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-microsoft-to-not-monitor-customer-data">🚫 Microsoft to not monitor customer data<a href="https://luke.geek.nz/azure/openai-adoption-challenges-solutions/#-microsoft-to-not-monitor-customer-data" class="hash-link" aria-label="Direct link to 🚫 Microsoft to not monitor customer data" title="Direct link to 🚫 Microsoft to not monitor customer data">​</a></h2>
<p>Prompts and responses are stored by Microsoft by default for <a href="https://learn.microsoft.com/azure/ai-services/openai/concepts/abuse-monitoring?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">abuse monitoring</a> <em>(not accessible to customers)</em>. You may not want Microsoft to have access to this data, including Microsoft support.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Your prompts <em>(inputs)</em> and completions <em>(outputs)</em>, your embeddings, and your training data:</p><p>Are NOT available to other customers.
Are NOT available to OpenAI.
Are NOT used to improve OpenAI models.
Are NOT used to train, retrain, or improve Azure OpenAI Service foundation models.
Are NOT used to improve any Microsoft or 3rd party products or services without your permission or instruction.
Your fine-tuned Azure OpenAI models are available exclusively for your use.
Microsoft operates the Azure OpenAI Service as an Azure service. Microsoft hosts the OpenAI models in its Azure environment, and the Service does NOT interact with any services operated by OpenAI (e.g., ChatGPT or the OpenAI API).</p><p>Reference: <a href="https://learn.microsoft.com/legal/cognitive-services/openai/data-privacy?context=%2Fazure%2Fai-services%2Fopenai%2Fcontext%2Fcontext&amp;tabs=azure-portal&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Data, privacy, and security for Azure OpenAI Service</a></p></div></div>
<p><strong>Ask</strong>:</p>
<p>Confidential data should never be stored anywhere by Microsoft or viewed by any Microsoft support or product team member.</p>
<p><strong>Challenge</strong>:</p>
<p>Microsoft logs all prompts for internal abuse monitoring for 30 days and then deletes them.</p>
<p>Got it! Here's the updated table incorporating your adjustments:</p>
<table><thead><tr><th>Why</th><th>Risk / Impact</th><th>Solution</th></tr></thead><tbody><tr><td>Some clients do not want any confidential data in prompts to be viewed by Microsoft support team</td><td><strong>Risk / Impact</strong>: High</td><td>Managed customers can apply for modified access, which stops all prompt logging</td></tr></tbody></table>
<p><strong>Rationale</strong>:</p>
<p>Microsoft’s managed customers are typically large organizations that trust Microsoft and are deemed responsible for their actions.</p>
<p><img decoding="async" loading="lazy" alt="Azure OpenAI - Data Privacy" src="https://luke.geek.nz/assets/images/azureopenai-promp-flow-2a173526497b10e1548a7135997eea16.jpg" width="1280" height="1125" class="img_ev3q"></p>
<p><strong>Action</strong>:</p>
<ul>
<li><a href="https://learn.microsoft.com/legal/cognitive-services/openai/limited-access?context=%2Fazure%2Fai-services%2Fopenai%2Fcontext%2Fcontext&amp;WT.mc_id=AZ-MVP-5004796#registration-for-modified-content-filters-andor-abuse-monitoring" target="_blank" rel="noopener noreferrer">Managed customers</a> may apply for modified access, which stops all prompt logging.</li>
<li>Make use of <a href="https://learn.microsoft.com/en-us/azure/ai-services/openai/how-to/use-your-data-securely?WT.mc_id=AZ-MVP-5004796#document-level-access-control" target="_blank" rel="noopener noreferrer">Security filters</a> in Azure AI Search, for limiting the data that is returned to the user.</li>
</ul>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Managed partners and customers are customers whose subscriptions are managed by the partner network or customers who are part of the Microsoft Enterprise Agreement program. Managed customers can apply for modified access, which stops all prompt logging. This is a contractual agreement between Microsoft and the customer, and the customer must apply for this access.</p></div></div>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>Also, make sure you talk to your account team and understand the implications of this, as it may affect the way you have architected the solution, the safeguards you may have to add, and your expectations with Microsoft support regarding any data that they may have.</p><p>"Disabling content filtering could fail to block content that violates the <a href="https://learn.microsoft.com/legal/cognitive-services/openai/code-of-conduct?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Microsoft Generative AI Services Code of Conduct</a>. My organization will implement systems and measures to ensure that the organization’s use of Azure OpenAI complies with the <a href="https://learn.microsoft.com/legal/cognitive-services/openai/code-of-conduct?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Microsoft Generative AI Services Code of Conduct</a>".</p></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>Make sure you take a look at the <a href="https://learn.microsoft.com/en-us/azure/ai-services/openai/how-to/risks-safety-monitor?WT.mc_id=AZ-MVP-5004796#potentially-abusive-user-detection" target="_blank" rel="noopener noreferrer">Use Risks &amp; Safety monitoring</a> in Azure OpenAI Studio functionality, to review any results of the filtering activity. You can use that information to further adjust your filter configuration to serve your specific business needs and <a href="https://learn.microsoft.com/azure/machine-learning/concept-responsible-ai?view=azureml-api-2&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Responsible AI principles</a>.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="️-disable-inferencing-via-azure-ai-studio">⚙️ Disable inferencing via Azure AI Studio<a href="https://luke.geek.nz/azure/openai-adoption-challenges-solutions/#%EF%B8%8F-disable-inferencing-via-azure-ai-studio" class="hash-link" aria-label="Direct link to ⚙️ Disable inferencing via Azure AI Studio" title="Direct link to ⚙️ Disable inferencing via Azure AI Studio">​</a></h2>
<p>When considering Azure Open AI adoption, it is important to consider if you want users, to be able to inference using Azure AI Studio; using Azure AI Studio can be a security risk, as it allows users to inference directly from the Azure Portal, bypassing some traceability mechanisms <em>(such as Azure API Management)</em> which you may have in place.</p>
<p><strong>Ask</strong>:</p>
<p>Azure OpenAI Studio should not be available to make any inferencing calls and must be disabled.</p>
<p><strong>Challenge</strong>:
There is no permission or RBAC role that prevents the use of AI Studio.</p>
<p>Here’s the table with all the missing information added:</p>
<table><thead><tr><th><strong>Why</strong></th><th><strong>Risk / Impact</strong></th><th><strong>Solution</strong></th></tr></thead><tbody><tr><td>Azure OpenAI Studio does not log prompts and responses in the diagnostic logs</td><td>Risk – High/Impact – High</td><td>- Implement custom logging at the client side to capture relevant details.  - Use alternative logging mechanisms to track prompts and responses securely.</td></tr><tr><td>Azure OpenAI Studio will bypass APIM</td><td>Risk – High  Impact – High</td><td>- Create an intermediary hop between the client and AOAI service and allow AOAI access only via Private Endpoint (e.g., AppGW/APIM). - Enable end user only via Service Principals (no portal access). - DNS block oai.azure.com.</td></tr></tbody></table>
<p>Rationale:</p>
<p>No other out-of-the-box method exists to disable Azure OpenAI Studio.</p>
<p><strong>Action</strong>:</p>
<ul>
<li>Control access to individual Azure OpenAI instances through <a href="https://learn.microsoft.com/en-gb/azure/ai-services/cognitive-services-virtual-networks?tabs=portal&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">restricting what Virtual Networks</a> can access the OpenAI instance <em>(Service Tags need to be allowed through a Network Security Group)</em>, so make sure you make use of Network Security Groups where possible to only tunnel your approved traffic <em>(i.e., AppGw or APIM only)</em>.</li>
<li>Make use of <a href="https://learn.microsoft.com/en-gb/azure/ai-services/openai/how-to/role-based-access-control?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Role-based access control for Azure OpenAI</a> Service to control who can see what.</li>
<li>Make sure of <a href="https://learn.microsoft.com/en-us/azure/ai-services/policy-reference?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Policy built-in policy definitions for Azure AI services</a> to control network access to your Azure OpenAI instances for existing or new deployments.</li>
<li>Deploy a Custom policy to prevent the creation of Azure OpenAI Studio. Refer to my blog post: <a href="https://luke.geek.nz/azure/policy-deny-creation-azure-openai-studio/" target="_blank" rel="noopener noreferrer">Azure Policy - Deny the creation of Azure OpenAI Studio</a>.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-restrict-models-to-only-certain-users">🚷 Restrict models to only certain users<a href="https://luke.geek.nz/azure/openai-adoption-challenges-solutions/#-restrict-models-to-only-certain-users" class="hash-link" aria-label="Direct link to 🚷 Restrict models to only certain users" title="Direct link to 🚷 Restrict models to only certain users">​</a></h2>
<p>When considering Azure Open AI adoption, it is essential to restrict models <em>(or deployments)</em> to only certain users.</p>
<p><strong>Ask</strong>:</p>
<p>The model should be accessible to only the required audience and no one else.</p>
<p><strong>Challenge</strong>:</p>
<p>Azure OpenAI does not have the ability to grant permissions by models.</p>
<p>Here’s the table with <strong>Risk</strong> and <strong>Impact</strong> on the same row as requested:</p>
<table><thead><tr><th><strong>Why</strong></th><th><strong>Risk / Impact</strong></th><th><strong>Solution</strong></th></tr></thead><tbody><tr><td>Model and data access should follow the principle of least privilege</td><td>Risk – High, Impact – High</td><td>- Each use case should have its own Azure OpenAI instance. - Deploy approved models for use cases only.  - Segregate duties of model deployment and model consumption via a custom RBAC role with the least privilege.</td></tr></tbody></table>
<p><strong>Rationale</strong>:</p>
<p>Having segregated instances for each use case eliminates the risk of model misuse and data exposure. New models and their inferencing capabilities need to be explicitly approved per use case before they can be leveraged.</p>
<p><strong>Action</strong>:</p>
<ul>
<li><a href="https://learn.microsoft.com/azure/ai-services/openai/how-to/create-resource?pivots=web-portal&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Create and deploy an Azure OpenAI Service resource</a> for each use case, and deploy only approved models for that use case.</li>
<li>Make sure of <a href="https://learn.microsoft.com/en-us/azure/ai-services/openai/how-to/role-based-access-control?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Role-based access control for Azure OpenAI</a> Service to control who can see what, separate the users deploying the Models, to the users consuming the models, for example Cognitive Services OpenAI User to a Managed Identity or user using the deployments.</li>
<li>Make use of <a href="https://learn.microsoft.com/en-us/azure/ai-services/policy-reference?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Policy built-in policy definitions for Azure AI services</a>, to control network access to your Azure OpenAI instances for existing or new deployments, and also restrict the creation of new 'unapproved' Azure OpenAI resources from being created.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-finops---view-total-opex-of-openai">💰 FinOps - view total opex of OpenAI<a href="https://luke.geek.nz/azure/openai-adoption-challenges-solutions/#-finops---view-total-opex-of-openai" class="hash-link" aria-label="Direct link to 💰 FinOps - view total opex of OpenAI" title="Direct link to 💰 FinOps - view total opex of OpenAI">​</a></h2>
<p>Consumption per use case could vary by order of magnitude. You may want to have visibility of costs at a service or deployment level, especially for use cases where the Azure OpenAI resource is shared but deployments are spread between projects.</p>
<p><strong>Ask</strong>:</p>
<p>Use cases must be able to view their total spend for the Azure OpenAI service</p>
<p><strong>Challenge</strong>:</p>
<ul>
<li>Cost metrics are available at the service level and select deployments, but not all</li>
<li>Any sharing of Azure OpenAI service makes cost determination not possible</li>
<li>No ability to stop usage beyond spending budget</li>
</ul>
<table><thead><tr><th>Why</th><th>Risk</th><th>Solution</th></tr></thead><tbody><tr><td>- Use case owners need to monitor consumption as they are responsible for cost- Azure OpenAI service can create significant costs depending on usage.</td><td>Risk – Medium Impact – High</td><td>- Provision each use case in a dedicated instance and a dedicated subscription &amp; resource group, this also ensures full AOAI capacity <em>(Tokens per min)</em> available to use case</td></tr></tbody></table>
<p><strong>Rationale</strong>:</p>
<ul>
<li>By having segregated instances for each use case, it provides accurate cost for each use case.</li>
</ul>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Sharing an instance of Azure OpenAI among multiple tenants can also lead to a <a href="https://learn.microsoft.com/en-us/azure/architecture/antipatterns/noisy-neighbor/noisy-neighbor?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Noisy Neighbor</a> problem. It can cause higher latency for some tenants. You also need to make your application code multitenancy-aware. For example, if you want to charge your customers for the consumption cost of a shared Azure OpenAI instance, implement the logic to keep track of the total number of tokens for each tenant in your application.</p></div></div>
<p><strong>Action</strong>:</p>
<ul>
<li>Provision dedicated instances for each use case and rely on distinct Resource Groups and Subscriptions to separate costs.</li>
<li>Review Cost Management and <a href="https://learn.microsoft.com/en-us/azure/ai-services/openai/how-to/manage-costs?WT.mc_id=AZ-MVP-5004796#monitor-costs" target="_blank" rel="noopener noreferrer">scope the cost per Model tokens</a>.</li>
<li>Make use of API Management, and <a href="https://journeyofthegeek.com/2024/08/22/azure-openai-service-tracking-token-usage-with-apim/" target="_blank" rel="noopener noreferrer">Token Usage</a> and merge that with your billing data.</li>
<li>If the Azure OpenAI instance is part of a wider solution, make sure you tag it with the <a href="https://luke.geek.nz/azure/application-cost-analysis-in-microsoft-azure-with-cm-resource-parent-tag/" target="_blank" rel="noopener noreferrer">cm-resource-parent</a> tag to allow full visibility of the workload's cost.</li>
<li>Understand your throughput requirements and investigate PTU <em>(provisioned throughput units)[<a href="https://learn.microsoft.com/azure/ai-services/openai/concepts/provisioned-throughput?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">https://learn.microsoft.com/azure/ai-services/openai/concepts/provisioned-throughput?WT.mc_id=AZ-MVP-5004796</a>]</em>. You can leverage <a href="https://oai.azure.com/portal/calculator" target="_blank" rel="noopener noreferrer">Azure AI Studio for calculate PTUs</a>.</li>
<li>Review <a href="https://learn.microsoft.com/azure/architecture/guide/multitenant/service/openai?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Multitenancy and Azure OpenAI Service</a> architecture considerations.</li>
</ul>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>You don't pay for PER Azure OpenAI resource; you pay for the tokens consumed, so make sure you understand the <a href="https://azure.microsoft.com/en-us/pricing/details/cognitive-services/openai-service/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">pricing model</a>. Why overcomplicate your solution with a shared resource when you can have a dedicated resource for each use case and have a clear understanding of the costs <em>(and security)</em> associated with that use case?</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="️-protect-from-owasps-top-10-threats">🛡️ Protect from OWASP's Top 10 threats<a href="https://luke.geek.nz/azure/openai-adoption-challenges-solutions/#%EF%B8%8F-protect-from-owasps-top-10-threats" class="hash-link" aria-label="Direct link to 🛡️ Protect from OWASP's Top 10 threats" title="Direct link to 🛡️ Protect from OWASP's Top 10 threats">​</a></h2>
<p>When considering Azure Open AI adoption, it is important to protect from <a href="https://owasp.org/www-project-top-ten/" target="_blank" rel="noopener noreferrer">OWASP Top 10 threats</a>.</p>
<p><img decoding="async" loading="lazy" alt="OWASP Top 10" src="https://luke.geek.nz/assets/images/oswasp-mapping-e753666d28f07abf8f96b4a06bfa9546.png" width="936" height="258" class="img_ev3q"></p>
<p><strong>Ask</strong>:</p>
<p>Service should be protected from OWASP-10 threats.</p>
<p><strong>Challenge</strong>:</p>
<p>Azure OpenAI Service is an API-based service vulnerable to OWASP-10 threats. Web Application Firewalls, which are typically used for this, can block significant legitimate AOAI inferencing calls.</p>
<table><thead><tr><th>Why</th><th>Risk</th><th>Solution</th></tr></thead><tbody><tr><td>- Per the Microsoft shared responsibility model, protection from OWASP-10 threats is customer responsibility</td><td>Risk – High Impact – High</td><td>- Disable public access to service - Limit exposure to internal traffic only</td></tr><tr><td></td><td></td><td>- Disable file uploads to service via RBAC</td></tr><tr><td></td><td></td><td>- Add AppGW with WAF v2 in front of AOAI (Not recommended)</td></tr></tbody></table>
<p><strong>Rationale</strong>:</p>
<ul>
<li>Limiting internal traffic limits the exposure</li>
<li>Even if an attack is successful from the internal network, there is no data stored in the service to be compromised</li>
</ul>
<p><strong>Action</strong>:</p>
<ul>
<li>Control access to individual Azure OpenAI instances through <a href="https://learn.microsoft.com/en-gb/azure/ai-services/cognitive-services-virtual-networks?tabs=portal&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">restricting what Virtual Networks</a> can access the OpenAI instance <em>(Service Tags need to be allowed through a Network Security Group)</em>, so make sure you make use of Network Security Groups where possible to only tunnel your approved traffic <em>(ie, AppGw or APIM only)</em>.</li>
<li>Make use of <a href="https://learn.microsoft.com/en-gb/azure/ai-services/openai/how-to/role-based-access-control?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Role-based access control for Azure OpenAI</a> Service to control who can see what.</li>
<li>Make sure of <a href="https://learn.microsoft.com/en-us/azure/ai-services/policy-reference?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Policy built-in policy definitions for Azure AI services</a> to control network access to your Azure OpenAI instances for existing or new deployments, and disable public endpoint access.</li>
<li>Make use of <a href="https://learn.microsoft.com/azure/api-management/api-management-key-concepts?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure API Management</a> and <a href="https://learn.microsoft.com/azure/application-gateway/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Application Gateway</a> to block, prevent, and log attempted connections to the solution.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-must-use-customer-managed-keys-cmk">🔑 Must use Customer Managed Keys <em>(CMK)</em><a href="https://luke.geek.nz/azure/openai-adoption-challenges-solutions/#-must-use-customer-managed-keys-cmk" class="hash-link" aria-label="Direct link to -must-use-customer-managed-keys-cmk" title="Direct link to -must-use-customer-managed-keys-cmk">​</a></h2>
<p>All encryption must use <a href="https://learn.microsoft.com/azure/security/fundamentals/key-management?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Customer Managed Keys</a>. I have not personally seen this requirement yet, but it is valid, especially for highly sensitive data and industry requirements (such as Finance).</p>
<p><strong>Ask</strong>:</p>
<ul>
<li>Encryption in Azure OpenAI must be configured to use Customer Managed Keys (CMK).</li>
</ul>
<p><strong>Challenge</strong>:</p>
<ul>
<li>CMK needs to be stored in a KeyVault (in the same region).</li>
<li>AOAI service connection to KeyVault can be over 'Trusted Microsoft Connection' only, and not via KeyVault's private endpoint.</li>
</ul>
<table><thead><tr><th>Why</th><th>Risk</th><th>Solution</th></tr></thead><tbody><tr><td>Per policy, clients typically want to use CMK as opposed to MMK <em>(Microsoft Managed Keys)</em> - CMK configuration will be required to stay compliant with Azure policy</td><td>Risk – High Impact – High</td><td>- Avoid need for uploading files to Azure OpenAI studio and fine-tuning - Disable public access of KeyVault</td></tr></tbody></table>
<p><strong>Rationale</strong>:</p>
<p><a href="https://learn.microsoft.com/azure/search/search-indexer-howto-access-trusted-service-exception?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Trusted Microsoft connections</a> use the Microsoft backbone network and no public network for communication.</p>
<p><strong>Action</strong>:</p>
<ul>
<li>Azure AI Services support <a href="https://learn.microsoft.com/azure/ai-services/openai/encrypt-data-at-rest?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">encryption of data at rest</a> by either enabling customer-managed keys (CMK) or by enabling customers to bring their own storage (BYOS). By default, Azure AI services use Microsoft-managed keys to encrypt the data. With <a href="https://learn.microsoft.com/azure/ai-services/encryption/cognitive-services-encryption-keys-portal?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Customer-managed keys for encryption</a>, customers now have the choice of encrypting the data at rest with an encryption key, managed by the customers, using Azure Key Vault. There is an additional cost, as you are charged for the Key Vault and additional dependant services, as using Customer Managed Keys brings resources <em>(usually managed by Microsoft in a separate siloed subscription)</em> into your own subscription in a separate managed Resource Group.</li>
</ul>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>When considering customer-managed keys, consider People, Processes, and Products. You should have processes in place for the key lifecycles <em>(rotation, revocation, etc)</em>. Also, consider the implications of the additional costs associated with this and the additional management overhead. Be pragmatic about using Customer-Managed Keys and understand the implications of using them.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-must-not-use-shareable-access-controls">❌ Must not use shareable access controls<a href="https://luke.geek.nz/azure/openai-adoption-challenges-solutions/#-must-not-use-shareable-access-controls" class="hash-link" aria-label="Direct link to ❌ Must not use shareable access controls" title="Direct link to ❌ Must not use shareable access controls">​</a></h2>
<p>Shareable access controls are considered less secure.</p>
<p><strong>Ask</strong>:</p>
<ul>
<li>No use of passwords or access keys to access the Azure OpenAI service.</li>
</ul>
<p><strong>Challenge</strong>:</p>
<ul>
<li>The use of keys is typically less secure and unacceptable in the long term, although it typically increases the pace of initial adoption. This makes the use of Service Principals also less secure.</li>
</ul>
<table><thead><tr><th>Why - Shareable access details</th><th>Risk Risk –</th><th>Solution - Use RBAC for access</th></tr></thead><tbody><tr><td>can be transferred to unapproved consumers, losing audit trail - Bearer token of authenticated user can be potentially misused</td><td>High Impact – High</td><td>control to service for end users as well as applications (consumer and middleware)</td></tr><tr><td></td><td></td><td>- Avoid using the RBAC role with ListKey permissions or use a custom RBAC role</td></tr></tbody></table>
<p><strong>Rationale</strong>:</p>
<p>RBAC <em>(Role-based Access Control)</em> use increases the security score.</p>
<p><strong>Action</strong>:</p>
<ul>
<li>Make use of <a href="https://learn.microsoft.com/en-gb/azure/ai-services/openai/how-to/role-based-access-control?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Role-based access control for Azure OpenAI</a> Service to control who can see what, and make sure you are not using the ListKey permission or a <a href="https://learn.microsoft.com/azure/role-based-access-control/custom-roles?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">custom RBAC</a> role that allows or disallows access to the keys <em>(Microsoft.Storage/storageAccounts/listKeys/action)</em>.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-resource-must-be-in-a-specific-region-only">🌍 Resource must be in a specific region only<a href="https://luke.geek.nz/azure/openai-adoption-challenges-solutions/#-resource-must-be-in-a-specific-region-only" class="hash-link" aria-label="Direct link to 🌍 Resource must be in a specific region only" title="Direct link to 🌍 Resource must be in a specific region only">​</a></h2>
<p>Azure OpenAI resources must be in a specific region only. This is a common requirement for data sovereignty and compliance reasons.</p>
<p><strong>Ask</strong>:</p>
<p>Provision Azure OpenAI service in the same region where Express Route terminates</p>
<p><strong>Challenge</strong>:</p>
<p><a href="https://learn.microsoft.com/azure/ai-services/openai/concepts/models?tabs=python-secure&amp;WT.mc_id=AZ-MVP-5004796#model-summary-table-and-region-availability" target="_blank" rel="noopener noreferrer">Azure OpenAI and model capacity are highly variable</a>, and typically may not be available in the same region as customers Express Route region.</p>
<p><strong>Rationale</strong>:</p>
<p>Azure OpenAI Private Endpoints can be created across regions and no VNet is required for operation.</p>
<table><thead><tr><th>Why</th><th>Risk</th><th>Solution</th></tr></thead><tbody><tr><td>Network traffic is monitored for all ingress &amp; egress in a predetermined region</td><td>Risk – High Impact – High</td><td>- Enable all regions in policy within a geography acceptable to the client</td></tr><tr><td>At times there are regulatory compliance requirements to be in specific geographies</td><td></td><td>- Provision Azure OpenAI service where capacity is available in allowed regions</td></tr><tr><td></td><td></td><td>- Create private endpoint in Express Route region</td></tr></tbody></table>
<p><strong>Rationale</strong>:</p>
<p>Azure OpenAI Private Endpoints can be created across regions and no VNet is required for operation</p>
<ul>
<li>Azure OpenAI in any region can have a <a href="https://learn.microsoft.com/azure/private-link/private-link-faq?WT.mc_id=AZ-MVP-5004796#can-private-endpoint-connect-to-azure-paas-resources-across-azure-regions-" target="_blank" rel="noopener noreferrer">Private Endpoint connected to a VNET <em>(Virtual Network)</em> in a different region</a>.</li>
<li>Make sure of Azure Policy, such as the <a href="https://learn.microsoft.com/azure/cloud-adoption-framework/manage/azure-server-management/common-policies?WT.mc_id=AZ-MVP-5004796#restrict-resource-regions" target="_blank" rel="noopener noreferrer">Restrict resource regions</a> policy, to enforce the region of the Azure OpenAI resource.</li>
<li>Consider <a href="https://learn.microsoft.com/azure/ai-services/openai/how-to/deployment-types?WT.mc_id=AZ-MVP-5004796#global-versus-regional-deployment-types" target="_blank" rel="noopener noreferrer">model deployment types <em>(ie Global vs Regional)</em></a> - remember that your model inference may be in a different region to your actual Azure OpenAI resource, if Global - so need to be considered from a latency and workload variance perspective, however, these are Read Only - so data resiliency should not be a factor, as you can still store your own data in the region of your choice.</li>
</ul>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Azure Policy - Deny the creation of Azure OpenAI Studio]]></title>
            <link>https://luke.geek.nz/azure/policy-deny-creation-azure-openai-studio/</link>
            <guid>https://luke.geek.nz/azure/policy-deny-creation-azure-openai-studio/</guid>
            <pubDate>Mon, 14 Oct 2024 08:20:46 GMT</pubDate>
            <description><![CDATA[Custom policy definition to deny the creation of Azure OpenAI Studio.]]></description>
            <content:encoded><![CDATA[<p>Custom <a href="https://learn.microsoft.com/azure/governance/policy/tutorials/create-custom-policy-definition?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">policy definition</a> to deny the creation of <a href="https://learn.microsoft.com/azure/ai-studio/concepts/ai-resources?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure OpenAI Studio Hubs</a>, which will stop the creation of an Azure OpenAI Studio.</p>
<!-- -->
<p>This custom Azure Policy that denies the creation of Azure OpenAI Studio hubs. Here's a breakdown of its components:</p>
<table><thead><tr><th>Key</th><th>Description</th></tr></thead><tbody><tr><td><strong>policyType</strong></td><td>Specifies that this is a custom policy.</td></tr><tr><td><strong>mode</strong></td><td>Indicates that the policy is indexed, meaning it can be evaluated against existing resources.</td></tr><tr><td><strong>displayName</strong></td><td>A human-readable name for the policy.</td></tr><tr><td><strong>description</strong></td><td>A brief description of what the policy does.</td></tr><tr><td><strong>metadata</strong></td><td>Contains additional information about the policy:</td></tr><tr><td><strong>version</strong></td><td>The version of the policy.</td></tr><tr><td><strong>category</strong></td><td>The category under which this policy falls.</td></tr><tr><td><strong>source</strong></td><td>A URL for more information.</td></tr><tr><td><strong>alzCloudEnvironments</strong></td><td>Specifies the cloud environments where this policy is applicable.</td></tr><tr><td><strong>createdBy</strong></td><td>The creator of the policy.</td></tr><tr><td><strong>lastUpdated</strong></td><td>The date when the policy was last updated.</td></tr><tr><td><strong>parameters</strong></td><td>Defines parameters that can be used within the policy:</td></tr><tr><td><strong>effect</strong></td><td>A parameter that determines the action to take (Audit, Disabled, or Deny).</td></tr><tr><td><strong>type</strong></td><td>The type of the parameter (String).</td></tr><tr><td><strong>metadata</strong></td><td>Additional information about the parameter:</td></tr><tr><td><strong>displayName</strong></td><td>A human-readable name for the parameter.</td></tr><tr><td><strong>description</strong></td><td>A brief description of the parameter.</td></tr><tr><td><strong>allowedValues</strong></td><td>The allowed values for this parameter.</td></tr><tr><td><strong>defaultValue</strong></td><td>The default value for this parameter (Deny).</td></tr><tr><td><strong>policyRule</strong></td><td>Defines the rule that the policy enforces:</td></tr><tr><td><strong>if</strong></td><td>Specifies the conditions to check:</td></tr><tr><td><strong>allOf</strong></td><td>An array of conditions that must all be true.</td></tr><tr><td><strong>field</strong></td><td>The field to check (type and kind).</td></tr><tr><td><strong>equals</strong></td><td>The expected value for the field.</td></tr><tr><td><strong>then</strong></td><td>Specifies the action to take if the conditions are met:</td></tr><tr><td><strong>effect</strong></td><td>The action to take, which is determined by the value of the effect parameter.</td></tr></tbody></table>
<p>This policy checks if a resource is of type Microsoft.MachineLearningServices/workspaces and kind Hub. If both conditions are met, the policy enforces the action specified by the effect parameter, which defaults to "Deny".</p>
<p><img decoding="async" loading="lazy" alt="Azure Policy - Deny the creation of Azure OpenAI Studio" src="https://luke.geek.nz/assets/images/DenyAzureStudioHub_PolicyAzurePortal-2464c7fa2edb6ebc65e6c34f0195b3b7.jpg" width="1362" height="897" class="img_ev3q"></p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"policyType"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Custom"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"mode"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Indexed"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"displayName"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Deny Azure OpenAI Studio creation"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"description"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Deny Azure OpenAI Studio hub creation."</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"metadata"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"version"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"1.0.0"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"category"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Machine Learning"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"source"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"https://luke.geek.nz"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"alzCloudEnvironments"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token string" style="color:rgb(255, 121, 198)">"AzureCloud"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"createdBy"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Luke"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"lastUpdated"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"2024-10-01"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"parameters"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"effect"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">"type"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"String"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">"metadata"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token property">"displayName"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Effect"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token property">"description"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Enable or disable the execution of the policy"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">"allowedValues"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token string" style="color:rgb(255, 121, 198)">"Audit"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token string" style="color:rgb(255, 121, 198)">"Disabled"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token string" style="color:rgb(255, 121, 198)">"Deny"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">"defaultValue"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Deny"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"policyRule"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"if"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">"allOf"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token property">"field"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"type"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token property">"equals"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Microsoft.MachineLearningServices/workspaces"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token property">"field"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"kind"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token property">"equals"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Hub"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"then"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">"effect"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"[parameters('effect')]"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Azure Policy - Deny the creation of Azure OpenAI Studio" src="https://luke.geek.nz/assets/images/DenyAzureStudioHubCreation_PolicyAzurePortal-4f0b0c43493b490c43b6a00e07c738ae.jpg" width="1359" height="527" class="img_ev3q"></p>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Cloudcloak]]></title>
            <link>https://luke.geek.nz/azure/cloudcloak/</link>
            <guid>https://luke.geek.nz/azure/cloudcloak/</guid>
            <pubDate>Sun, 29 Sep 2024 23:37:38 GMT</pubDate>
            <description><![CDATA[Install and test Cloudcloak, a browser extension that hides sensitive information while streaming or presenting Microsoft Cloud Portals.]]></description>
            <content:encoded><![CDATA[<p><a href="https://github.com/microsoft/Cloudcloak" target="_blank" rel="noopener noreferrer">Cloud Cloak</a> is a browser extension for folks streaming or presenting while simultaneously showing one of the Microsoft Cloud Portals. It does its best to hide connection strings, email addresses, avatars, and anything that might show secure or personal information.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>You can consider this the next version/update to <a href="https://github.com/clarkio/azure-mask/" target="_blank" rel="noopener noreferrer">Azure Mask</a> <em>(shout out to Brian Clark for his pioneering work and blessing us to create this one)</em>.</p></div></div>
<p><img decoding="async" loading="lazy" alt="Cloudcloak" src="https://luke.geek.nz/assets/images/cloudcloak-icon-128-797d8ce09303938c3fca00a0c5a6dd8f.png" width="128" height="128" class="img_ev3q"></p>
<!-- -->
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Developed as part of the Microsoft Global Hackathon 2024 🚀! This extension helps to 'cloak <em>(i.e., blur)</em>' potentially personable information in the relevant Azure portals that could be mistreated, allowing presenters to focus on the content they are delivering instead of having to worry about the type of information <em>(such as Azure subscription ids)</em>, that people can see.</p><p><img decoding="async" loading="lazy" alt="Cloudcloak" src="https://luke.geek.nz/assets/images/AzurePortal_Cloudcloak_On-c90255421f868b30503c0c00eb6bc45a.jpg" width="1975" height="747" class="img_ev3q"></p><p><a href="https://github.com/microsoft/Cloudcloak" target="_blank" rel="noopener noreferrer">Cloud Cloak</a> is open for contributions, and make sure you provide feedback by opening an issue on how it could be improved further. This is an open-source initiative and not directly supported by Microsoft. At the time of writing, this is the release version of version 1.0.</p></div></div>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>It does not guarantee that all sensitive information is hidden, for example, although the information is hidden in the UI on render, it might still be present in the HTML source code, or the address bar, and link previews.</p></div></div>
<p>So let us see how it works according to GitHub Copilot:</p>
<p>The extension monitors specific websites and, when activated, blurs sensitive information such as email addresses, GUIDs, IP addresses, and phone numbers. It achieves this functionality using a combination of background scripts and content scripts.</p>
<p>The extension is activated by clicking on the extension icon in the browser toolbar. When activated, sensitive information is blurred on the current page. It will remain active until the user deactivates it by clicking on the extension icon again.</p>
<ol>
<li>Initialization: When the extension is installed or updated, it initializes the state from storage and updates the badge for the current tab.
Tab Update/Activation: When a tab is updated or activated, the extension checks if the URL matches one of the specified extensions. If it does, it injects the cloak.js script and updates the badge.</li>
<li>Cloak Mode: When the user clicks the extension icon, the extension toggles the cloak mode. If enabled, it injects the cloak.js script, which identifies and blurs sensitive information on the page.</li>
<li>DOM Changes: The MutationObserver in cloak.js monitors changes in the DOM and reapplies the blur filter to newly added elements containing sensitive information.</li>
</ol>
<table><thead><tr><th><strong>Component</strong></th><th><strong>Description</strong></th></tr></thead><tbody><tr><td><code>manifest.json</code></td><td>Configures the extension with metadata, permissions, and the background script.</td></tr><tr><td><code>background.js</code></td><td>Manages the extension’s state, handles events, and injects the content script into specified websites.</td></tr><tr><td><code>cloak.js</code></td><td>Contains the logic to identify and blur sensitive information on web pages.</td></tr><tr><td><strong>How It Works</strong></td><td></td></tr><tr><td><code>manifest.json</code></td><td>- Defines metadata, permissions, and the background script. Specifies icons and permissions.</td></tr><tr><td><code>background.js</code></td><td>- Manages the extension’s state. Injects <code>cloak.js</code> script into the specified tab and frames.</td></tr><tr><td><strong>Event Listeners</strong></td><td></td></tr><tr><td><code>chrome.tabs.onUpdated</code></td><td>Listens for tab updates and injects the script if the URL matches the specified conditions.</td></tr><tr><td><code>chrome.tabs.onActivated</code></td><td>Listens for tab activation and updates the badge accordingly.</td></tr><tr><td><code>chrome.webNavigation.onCompleted</code></td><td>Injects the script into iframes upon navigation completion.</td></tr><tr><td><code>chrome.action.onClicked</code></td><td>Toggles the extension's enabled/disabled state when clicking the action button.</td></tr></tbody></table>
<p>At the time of writing, the following URLs are supported:</p>
<ul>
<li><a href="https://portal.azure.com/" target="_blank" rel="noopener noreferrer">https://portal.azure.com</a></li>
<li><a href="https://ms.portal.azure.com/" target="_blank" rel="noopener noreferrer">https://ms.portal.azure.com</a></li>
<li><a href="https://rc.portal.azure.com/" target="_blank" rel="noopener noreferrer">https://rc.portal.azure.com</a></li>
<li><a href="https://preview.portal.azure.com/" target="_blank" rel="noopener noreferrer">https://preview.portal.azure.com</a></li>
<li><a href="https://entra.microsoft.com/" target="_blank" rel="noopener noreferrer">https://entra.microsoft.com</a></li>
<li><a href="https://intune.microsoft.com/" target="_blank" rel="noopener noreferrer">https://intune.microsoft.com</a></li>
<li><a href="https://ai.azure.com/" target="_blank" rel="noopener noreferrer">https://ai.azure.com</a></li>
<li><a href="https://admin.microsoft.com/" target="_blank" rel="noopener noreferrer">https://admin.microsoft.com</a></li>
<li><a href="https://sip.security.microsoft.com/" target="_blank" rel="noopener noreferrer">https://sip.security.microsoft.com</a></li>
<li><a href="https://purview.microsoft.com/" target="_blank" rel="noopener noreferrer">https://purview.microsoft.com</a></li>
<li><a href="https://make.powerapps.com/" target="_blank" rel="noopener noreferrer">https://make.powerapps.com</a></li>
<li><a href="https://make.preview.powerapps.com/" target="_blank" rel="noopener noreferrer">https://make.preview.powerapps.com</a></li>
<li><a href="https://msazure.visualstudio.com/" target="_blank" rel="noopener noreferrer">https://msazure.visualstudio.com</a></li>
<li><a href="https://github.com/" target="_blank" rel="noopener noreferrer">https://github.com</a></li>
<li><a href="https://copilotstudio.microsoft.com/" target="_blank" rel="noopener noreferrer">https://copilotstudio.microsoft.com</a></li>
<li><a href="https://copilotstudio.preview.microsoft.com/" target="_blank" rel="noopener noreferrer">https://copilotstudio.preview.microsoft.com</a></li>
<li><a href="https://portal.azure.us/" target="_blank" rel="noopener noreferrer">https://portal.azure.us</a></li>
</ul>
<p>However, new URLs can be added by updating the <code>background.js</code> file and reading it in your browser to test locally.</p>
<p>Because of the Chrome event listeners, this extension is only available for Chrome and Edge browsers (and I would assume any other Chrome browser).</p>
<p>So, let's get started with the installation. We will be using Edge, as it's the browser I use mainly for my presentations.</p>
<p>This is an unofficial extension, and at this time, it is not in the Edge or Chrome stores, so it will need to be installed and updated manually. If your browser has multiple profiles, this is also per user profile.</p>
<p>So, let us download the extension from the <a href="https://github.com/microsoft/Cloudcloak" target="_blank" rel="noopener noreferrer">GitHub repository</a> and unzip the file.</p>
<p><img decoding="async" loading="lazy" alt="Download Cloudcloak" src="https://luke.geek.nz/assets/images/Download_Cloudcloak-f4502c278303035fb97448261a01c5d0.gif" width="1876" height="949" class="img_ev3q"></p>
<p>Then, in Edge, go to <code>edge://extensions/</code> and enable Developer mode. Then click on <code>Load unpacked</code> and select the folder where you unzipped the extension.</p>
<p><img decoding="async" loading="lazy" alt="Install Cloudcloak" src="https://luke.geek.nz/assets/images/Install_Cloudcloak-5c29c52a117188a14fe1567f8594447d.gif" width="1903" height="1021" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>After the extension is installed, you can disable Developer mode. For ease of use, you can pin the extension to the toolbar.</p></div></div>
<p>Now, when you are presenting, you can click on the extension icon, which will blur out sensitive information on the page. So, let's test it by navigating to an Azure resource.</p>
<p><img decoding="async" loading="lazy" alt="Cloudcloak On" src="https://luke.geek.nz/assets/images/Test_Cloudcloak-728751552c343add8af59c03e7a171e6.gif" width="1896" height="957" class="img_ev3q"></p>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[System Managed Identity in Storage Queue PowerShell Azure Functions]]></title>
            <link>https://luke.geek.nz/azure/storage-queue-triggers-system-managed-identity-powershell/</link>
            <guid>https://luke.geek.nz/azure/storage-queue-triggers-system-managed-identity-powershell/</guid>
            <pubDate>Mon, 02 Sep 2024 03:14:00 GMT</pubDate>
            <description><![CDATA[Learn how to create and configure a storage queue trigger using PowerShell in Azure Functions to automate your workflows.]]></description>
            <content:encoded><![CDATA[<p><a href="https://learn.microsoft.com/azure/azure-functions/functions-overview?pivots=programming-language-powershell&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Functions</a> is a serverless compute service that enables you to run event-driven code without having to manage infrastructure. You can use Azure Functions to run small pieces of code in response to events, such as HTTP requests, messages in a queue, or changes in data in a storage account. In this article, I will show you how to use Azure Functions with a storage queue trigger using the System Managed Identity of the Function Application <em>(instead of a Connection String)</em>.</p>
<!-- -->
<p>When you create an Azure Function, you can use a storage queue trigger to execute the function when a message is added to a storage queue. This is useful when you want to process messages in a queue asynchronously. In this article, I will show you how to use an Azure Function with a storage queue by using the System Managed Identity of the Function Application to authenticate with the storage account.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p><a href="https://learn.microsoft.com/azure/azure-functions/functions-bindings-storage-queue-trigger?tabs=python-v2%2Cisolated-process%2Cnodejs-v4%2Cextensionv5&amp;pivots=programming-language-powershell&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Queue storage trigger for Azure Functions</a>. The queue storage trigger runs a function as messages are added to Azure Queue storage.</p><p>The Azure Functions runtime supports triggers and bindings for Azure Queue storage. The Azure Queue storage trigger lets you respond to new messages in a queue. When a message is added to the queue, the runtime invokes your function.</p></div></div>
<p>The first thing you will need to do is enable the System Managed Identity of the Azure Function.</p>
<p><img decoding="async" loading="lazy" alt="Enable System Managed Identity" src="https://luke.geek.nz/assets/images/AzurePortal_AzureFunction_SystemManagedIdentity-6a63314cdd46f2733b0b0f8a69dc2cbc.jpg" width="1739" height="867" class="img_ev3q"></p>
<p>Once that has been completed, we can assign the required roles to the Storage account that contains the queue.</p>
<p>What level of permissions you need to assign to the Function App's System Managed Identity depends on what you want to do with the queue. In this example, I will be using the <code>Storage Queue Data Contributor</code> role.</p>
<table><thead><tr><th>Binding type</th><th>Example built-in roles</th></tr></thead><tbody><tr><td>Trigger</td><td><a href="https://learn.microsoft.com/azure/role-based-access-control/built-in-roles/storage?WT.mc_id=AZ-MVP-5004796#storage-queue-data-reader" target="_blank" rel="noopener noreferrer">Storage Queue Data Reader</a>, <a href="https://learn.microsoft.com/azure/role-based-access-control/built-in-roles/storage?WT.mc_id=AZ-MVP-5004796#storage-queue-data-message-processor" target="_blank" rel="noopener noreferrer">Storage Queue Data Message Processor</a></td></tr><tr><td>Output binding</td><td><a href="https://learn.microsoft.com/azure/role-based-access-control/built-in-roles/storage?WT.mc_id=AZ-MVP-5004796#storage-queue-data-contributor" target="_blank" rel="noopener noreferrer">Storage Queue Data Contributor</a>, <a href="https://learn.microsoft.com/azure/role-based-access-control/built-in-roles/storage?WT.mc_id=AZ-MVP-5004796#storage-queue-data-message-sender" target="_blank" rel="noopener noreferrer">Storage Queue Data Message Sender</a></td></tr></tbody></table>
<p>Because we are going to assign the permissions to a Storage account, we can do this directly through the Azure Portal at the Function App System Managed identity location.</p>
<p><img decoding="async" loading="lazy" alt="Assign Role to Storage Account" src="https://luke.geek.nz/assets/images/AzurePortal_AzureFunction_SystemManagedIdentityAssignRole-feb74c8f71f57ab22488ef90b8d5799b.gif" width="1753" height="947" class="img_ev3q"></p>
<p>Once permissions have been granted in our Azure Function App, we will need to create some Connection variables, which our Function App will use.</p>
<p>In the Function App, under Settings, go to Environment variables.</p>
<p>We will need to determine a Connection name, which will be used by our Azure Function. In this example, I will be using <code>StgQueueAccount</code>. This will be used as a prefix for additional variables, for example:</p>
<ul>
<li><code>StgQueueAccount__queueServiceUri</code></li>
</ul>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Note that the variable has x2 underscores <code>__</code> between the Connection name and the variable name.</p></div></div>
<p>This variable will be used to store the <a href="https://learn.microsoft.com/azure/azure-functions/functions-bindings-storage-queue-trigger?tabs=python-v2%2Cin-process%2Cnodejs-v4%2Cextensionv5&amp;pivots=programming-language-powershell&amp;WT.mc_id=AZ-MVP-5004796#identity-based-connections" target="_blank" rel="noopener noreferrer">URI of the Storage Account Queue</a>.</p>
<p>For the valuiie of the StgQueueAccount__queueServiceUri, you can get this from the Azure Portal, by going to the Storage Account, and then to the Queue Service, to find the endpoint uri.</p>
<p><img decoding="async" loading="lazy" alt="Queue Service URI" src="https://luke.geek.nz/assets/images/AzurePortal_AzureFunction_StorageAccountQueueenebdpoint-6b33ebf7ccb56d12490c735b84f10fd0.jpg" width="1564" height="525" class="img_ev3q"></p>
<p>Once we have retrieved it, we can navigate back to the Environment variables and add in the Key-Value pair.</p>
<p><img decoding="async" loading="lazy" alt="Environment Variables" src="https://luke.geek.nz/assets/images/AzurePortal_AzureFunction_EnvironmentVariables_queueuri-318c6e94becefce1c858583cb30376b0.jpg" width="1533" height="779" class="img_ev3q"></p>
<p>Make sure to click Apply and Apply.</p>
<p>Once completed, the default profile.ps1 file will run to authenticate using the Managed Identity of the Function App.</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">profile.ps1</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$env</span><span class="token plain">:MSI_SECRET</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Disable-AzContextAutosave</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Scope </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">Process</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Out-Null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Connect-AzAccount</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Identity</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Your actual function will need to have the binding updated with the name of the Connection prefix determined earlier and include the queue name, for example:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">function.json</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"bindings"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"name"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"QueueItem"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"type"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"queueTrigger"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"direction"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"in"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"queueName"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"rg-queue-create"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"connection"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"StgQueueAccount"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You should now be able to read the messages from the queue and process them as required using the System Managed Identity of the Azure Function account.</p>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Azure Communication Services and PowerShell for Email]]></title>
            <link>https://luke.geek.nz/azure/using-communication-services-and-powershell-to-send-emails/</link>
            <guid>https://luke.geek.nz/azure/using-communication-services-and-powershell-to-send-emails/</guid>
            <pubDate>Sat, 24 Aug 2024 10:21:21 GMT</pubDate>
            <description><![CDATA[A step-by-step guide on how to use Azure Communication Services and PowerShell to send emails.]]></description>
            <content:encoded><![CDATA[<p><a href="https://azure.microsoft.com/products/communication-services?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Communication Services</a> brings rich communication APIs to all of your apps across any device on any platform, using the same reliable and secure infrastructure that powers Microsoft Teams.</p>
<p>Today, we will explore using Email as part of Azure Communication Services, using the REST API and PowerShell to send an email.</p>
<p><img decoding="async" loading="lazy" alt="Azure Communication Services" src="https://luke.geek.nz/assets/images/BlogHeading_DeployandTestACS-f9838a4feb1c05d77481cc14d4141606.gif" width="1200" height="628" class="img_ev3q"></p>
<!-- -->
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>I did a previous article: <a href="https://luke.geek.nz/azure/azure-email-communication-services/" target="_blank" rel="noopener noreferrer">Deploying and Testing Azure Email Communication Services</a> on this, however the authentication was using an Azure Service Principal. This time we will use oauth using a System Assigned Managed Identity.</p></div></div>
<p>In this example, I will access a token from <a href="https://azure.microsoft.com/products/communication-services?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Communication Services</a>. I will make a GET request to the identity endpoint of Azure Communication Services, using the oauth identity from the system-managed identity. This will return a token we can use to authenticate against the REST API.</p>
<p>Here's a step-by-step explanation of the script:</p>
<p>The script first defines the subject and body of the email. The body is an HTML string that contains the email content.
It checks if the email body is not empty.
If the email body is not empty, it proceeds to get an access token from Azure Communication Services. This is done by making a GET request to the identity endpoint of Azure Communication Services. The access token is then printed to the console.
If there's an error when getting the access token, the script catches the exception and prints the error message and response details on the console.
The script then constructs the URI for the email-sending endpoint and defines the headers for the REST API call. The headers include the content type and the obtained access token in the Authorization header.
The script defines the body for the REST API call. This includes the sender address, the email content (subject and body), the recipients, the reply-to address, and a flag to disable user engagement tracking.
The script then converts the PowerShell object to JSON and attempts to send the email by making a POST request to the email-sending endpoint. The request details and response are logged to the console.
If the email is sent incorrectly, the script catches the exception and logs the error message and stack trace to the console.</p>
<p>Further information on the authentication process itself:</p>
<ol>
<li>The script first defines the resource ID for Azure Communication Services and the communication endpoint URL.</li>
<li>It then constructs the URI for the identity endpoint. This URI includes the environment variable IDENTITY_ENDPOINT (automatically set by Azure when using Managed Identity) and the resource ID.</li>
<li>The script then attempts to get an access token from the identity endpoint. It does this by sending a GET request to the identity endpoint with a header that includes Metadata: true. This tells the identity endpoint that the request is coming from within Azure.</li>
<li>the response will include an access token if the request is successful. This token is then extracted from the response.</li>
</ol>
<p>This access token can then be used to authenticate requests to Azure Communication Services. The token tells Azure Communication Services that the request comes from an authenticated source (in this case, the Managed Identity) and should be allowed.</p>
<p><em>(This authenticaiton was inititally written to be used in a Azure Automation Runbook, with the System Managed Identity assigned Contributor rights to the Azure Communication Services resource (not the Email Communication Services).)</em></p>
<p>Here is the PowerShell script to send an email using Azure Communication Services using the <a href="https://learn.microsoft.com/entra/identity/managed-identities-azure-resources/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">System Managed identity</a> of an <a href="https://learn.microsoft.com/azure/automation/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Automation account</a>:</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$emailSubject</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"Important: Server Maintenance Notification"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$EmailRecipient</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"ituser@contoso.com"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$emailBody</span><span class="token plain"> = @</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">&lt;html&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">&lt;body&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">&lt;p&gt;Dear User,&lt;/p&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">&lt;p&gt;This is to inform you that a &lt;b&gt;&lt;i&gt;server maintenance is scheduled for the next week&lt;/i&gt;&lt;/b&gt;.&lt;/p&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">&lt;p&gt;The servers will be down from 10:00 PM to 2:00 AM.&lt;/p&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">&lt;p&gt;Please save your work and log off during this period to avoid any data loss.&lt;/p&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">&lt;p&gt;If you have any questions or concerns, please contact our IT Support team.&lt;/p&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">&lt;p&gt;Thank you for your understanding and cooperation.&lt;/p&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">&lt;p&gt;Best Regards,&lt;/p&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">&lt;p&gt;IT Support Team&lt;/p&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">&lt;/body&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">&lt;/html&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain">@</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$emailBody</span><span class="token plain"> </span><span class="token operator">-ne</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">""</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$emailBody</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Define the resource ID for Azure Communication Services</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceID</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">'https://communication.azure.com'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Define the communication endpoint URL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$communicationendpointurl</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"azcomm-contoso.australia.communication.azure.com"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Update with your communication endpoint URL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Construct the URI for the identity endpoint</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$Uri</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$env</span><span class="token string function" style="color:rgb(80, 250, 123)">:IDENTITY_ENDPOINT</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">?api-version=2018-02-01&amp;resource=</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceID</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Debug output</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Print the constructed URI and headers</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"URI: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$Uri</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Headers: @{ Metadata = 'true' }"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Try to get the access token</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">try</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Invoke a GET request to the identity endpoint to get the access token</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$AzToken</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Invoke-WebRequest</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Uri </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$Uri</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Method GET </span><span class="token operator">-</span><span class="token plain">Headers @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> Metadata = </span><span class="token string" style="color:rgb(255, 121, 198)">"true"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">UseBasicParsing </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Select-Object</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ExpandProperty Content </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">ConvertFrom-Json</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Select-Object</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ExpandProperty access_token</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Print the obtained access token</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Access Token: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$AzToken</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># If there's an error, print the error message and response details</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Error</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Failed to get access token: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Response Status Code: </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Exception</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Response</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">StatusCode</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Value__</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Response Status Description: </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Exception</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Response</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">StatusDescription</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Response Content: </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Exception</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Response</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">GetResponseStream</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)"> | %{ </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token string" style="color:rgb(255, 121, 198)">.ReadToEnd() })"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Construct the URI for the email sending endpoint</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$uri</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"https://</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$communicationendpointurl</span><span class="token string" style="color:rgb(255, 121, 198)">/emails:send?api-version=2023-03-31"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Define the headers for the REST API call</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Include the content type and the obtained access token in the Authorization header</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$headers</span><span class="token plain"> = @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">"Content-Type"</span><span class="token plain">  = </span><span class="token string" style="color:rgb(255, 121, 198)">"application/json"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">"Authorization"</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"Bearer </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$AzToken</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Define the body for the REST API call</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$apiResponse</span><span class="token plain"> = @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        headers                        = @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            id = </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token function" style="color:rgb(80, 250, 123)">New-Guid</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Guid</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        senderAddress                  = </span><span class="token string" style="color:rgb(255, 121, 198)">'DoNotReply@7647475b-a51b-4901-8674-917e6abea743.azurecomm.net'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        content                        = @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            subject = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$emailSubject</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            html    = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$emailBody</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        recipients                     = @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            to = @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    address     = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$EmailRecipient</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    displayName = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$EmailRecipient</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        replyTo                        = @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                address     = </span><span class="token string" style="color:rgb(255, 121, 198)">"example@contoso.com"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                displayName = </span><span class="token string" style="color:rgb(255, 121, 198)">"Contoso"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        userEngagementTrackingDisabled = </span><span class="token boolean">$true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Convert the PowerShell object to JSON</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$body</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$apiResponse</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">ConvertTo-Json</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Depth 10</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Send the email</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">try</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Log the request details</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Sending email..."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"URI: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$uri</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Headers: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$headers</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Body: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$body</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Make the request</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$response</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Invoke-RestMethod</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Uri </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$uri</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Method Post </span><span class="token operator">-</span><span class="token plain">Headers </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$headers</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Body </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$body</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">UseBasicParsing</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Log the response</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Response: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$response</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Return the response</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$response</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Log the error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Error</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Failed to send email: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Exception Message: </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Exception</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Message</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Exception StackTrace: </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Exception</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">StackTrace</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You can run this script in an Azure Automation Runbook <em>(and theoretically in an <a href="https://learn.microsoft.com/azure/azure-functions/functions-overview?pivots=programming-language-csharp&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Function</a> as well)</em> to send an email using Azure Communication Services and the System Managed Identity—and there is no need to maintain or store client secrets!</p>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Implementing Correlation ID for API Management requests]]></title>
            <link>https://luke.geek.nz/azure/implementing-correlation-id-in-api-management/</link>
            <guid>https://luke.geek.nz/azure/implementing-correlation-id-in-api-management/</guid>
            <pubDate>Fri, 16 Aug 2024 10:21:21 GMT</pubDate>
            <description><![CDATA[This article provides a comprehensive guide on implementing correlation IDs in API management systems, enhancing traceability and debugging capabilities.]]></description>
            <content:encoded><![CDATA[<p>When working with <a href="https://learn.microsoft.com/azure/api-management/api-management-key-concepts?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure API Management</a>, you may want to enable traceability and correlation of requests across different services. This is where the Correlation ID comes in.</p>
<p>Similar to <a href="https://www.w3.org/TR/trace-context/#traceparent-header-field-values" target="_blank" rel="noopener noreferrer">traceparent</a>, the Correlation ID is a unique identifier passed along with the request and response headers. It allows you to track a request's flow as it moves through different services and systems.</p>
<p>In this article, we will explore how to generate a new correlation ID through API Management Inbound policies and pass it back to the Client through an outbound policy, which then is used to help troubleshoot specific calls with <a href="https://learn.microsoft.com/azure/azure-monitor/app/app-insights-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Application Insights</a>.</p>
<!-- -->
<p>So, if you want an experience like the following to help pass the Correlation ID back to the client, then look up the transaction in Application Insights, then let us take a look:</p>
<p><img decoding="async" loading="lazy" alt="Correlation ID" src="https://luke.geek.nz/assets/images/apim_appin_requesttrace-7f84df8f428f2b3c298d8550ae1af671.gif" width="1614" height="1197" class="img_ev3q"></p>
<p>To start with, make sure that the API <em>(Global or specific API)</em> has the following settings enabled:</p>
<p><img decoding="async" loading="lazy" alt="Correlation protocol" src="https://luke.geek.nz/assets/images/apim-appin-trace_verbosity-cf0f09eef2ceb0682a50c1564b2044b7.jpg" width="1992" height="1123" class="img_ev3q"></p>
<p>Now, we need to set an Inbound Policy to create the Correlation ID (if it's not already passed in the request) as a variable and assign that variable to an inbound header.</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">inbound</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">set-variable</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">name</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">correlation-id</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">value</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">@(context.Request.Headers.GetValueOrDefault('x-correlation-id', Guid.NewGuid().ToString()))</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">set-header</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">name</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">x-correlation-id</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">exists-action</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">override</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">value</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">@((string)context.Variables["correlation-id"])</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">value</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">set-header</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">inbound</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<table><thead><tr><th><strong>Line</strong></th><th><strong>Explanation</strong></th></tr></thead><tbody><tr><td><code>&lt;set-variable name="correlation-id" value="@(context.Request.Headers.GetValueOrDefault("x-correlation-id", Guid.NewGuid().ToString()))" /&gt;</code></td><td>This line is setting a variable named "correlation-id". It's getting the value from the request headers. If a header with the name "x-correlation-id" exists, it uses that value. If not, it generates a new unique ID using <code>Guid.NewGuid().ToString()</code>.</td></tr><tr><td><code>&lt;set-header name="x-correlation-id" exists-action="override"&gt;</code></td><td>This line is setting a header named "x-correlation-id". If a header with this name already exists, it will be overridden.</td></tr><tr><td><code>&lt;value&gt;@((string)context.Variables["correlation-id"])&lt;/value&gt;</code></td><td>This line sets the value of the "x-correlation-id" header to the value of the "correlation-id" variable.</td></tr><tr><td><code>&lt;/set-header&gt;</code></td><td>This line is closing the <code>&lt;set-header&gt;</code> tag.</td></tr></tbody></table>
<p>Once that added, we need to add another inbound policy:</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">inbound</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">trace</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">source</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">Global APIM Policy</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">severity</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">information</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">message</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">@(String.Format("API: {0}, Operation: {1}", context.Api.Name, context.Operation.Name))</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">message</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">metadata</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">name</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">correlation-id</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">value</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">@((string)context.Variables[</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">correlation-id"])"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">trace</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">inbound</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<table><thead><tr><th><strong>Element</strong></th><th><strong>Description</strong></th></tr></thead><tbody><tr><td><code>&lt;trace source="Global APIM Policy" severity="information"&gt;</code></td><td>This is the start of a trace element. The&nbsp;source&nbsp;attribute is set to "Global APIM Policy" and the&nbsp;severity&nbsp;attribute is set to "information".</td></tr><tr><td><code>&lt;message&gt;@(String.Format("API: {0}, Operation: {1}", context.Api.Name, context.Operation.Name))&lt;/message&gt;</code></td><td>This is a message element. It uses&nbsp;String.Format&nbsp;to create a string that includes the name of the API and the operation from the context.</td></tr><tr><td><code>&lt;metadata name="correlation-id" value='@((string)context.Variables["correlation-id"])' /&gt;</code></td><td>This is a metadata element. It has a&nbsp;name&nbsp;attribute set to "correlation-id" and a&nbsp;value&nbsp;attribute that retrieves the "correlation-id" from the context variables and casts it to a string.</td></tr><tr><td><code>&lt;/trace&gt;</code></td><td>This is the end of the trace element.</td></tr></tbody></table>
<p><img decoding="async" loading="lazy" alt="Inbound Policy" src="https://luke.geek.nz/assets/images/apim-appin-trace_inboundpolicy-29950dbb1ce2ffd7c7a0598c0636f3fa.jpg" width="2095" height="1134" class="img_ev3q"></p>
<p>This will help you track the Correlation ID in the logs and troubleshoot any issues that may arise.</p>
<p>Once that has been added, it's time to return it to the client. This can be done with the following Outbound policy:</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">outbound</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">set-header</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">name</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">x-correlation-id</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">exists-action</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">override</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">value</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">@((string)context.Variables["correlation-id"])</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">value</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">set-header</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">outbound</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<table><thead><tr><th><strong>Element</strong></th><th><strong>Description</strong></th></tr></thead><tbody><tr><td><code>&lt;outbound&gt;</code></td><td>This tag defines the outbound section of the policy. The operations inside this tag are applied to the response before it's sent back to the client.</td></tr><tr><td><code>&lt;set-header name="x-correlation-id" exists-action="override"&gt;</code></td><td>This tag sets an HTTP header in the outbound response. The&nbsp;<code>name</code>&nbsp;attribute specifies the name of the header, in this case&nbsp;<code>x-correlation-id</code>. The&nbsp;<code>exists-action</code>&nbsp;attribute specifies what to do if the header already exists, in this case it's set to&nbsp;<code>override</code>, meaning the existing header will be replaced.</td></tr><tr><td><code>&lt;value&gt;@((string)context.Variables["correlation-id"])&lt;/value&gt;</code></td><td>This tag sets the value of the header. It's using a variable from the context named&nbsp;<code>correlation-id</code>. The&nbsp;<code>@</code>&nbsp;symbol is used to denote an expression in Azure API Management policies.</td></tr></tbody></table>
<p><img decoding="async" loading="lazy" alt="Outbound Policy" src="https://luke.geek.nz/assets/images/apim-appin-trace_outboundpolicy-87a73d904abbaa9e23010ecdf2426867.jpg" width="2113" height="1135" class="img_ev3q"></p>
<p>Reference:</p>
<ul>
<li><a href="https://yourazurecoach.com/2021/01/22/optimizing-api-traceability-in-azure-api-management/" target="_blank" rel="noopener noreferrer">Optimizing traceability in Azure API Management</a></li>
</ul>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Implementing AI Gateway capabilities in API Management]]></title>
            <link>https://luke.geek.nz/azure/implementing-ai-gateway-in-api-management/</link>
            <guid>https://luke.geek.nz/azure/implementing-ai-gateway-in-api-management/</guid>
            <pubDate>Wed, 14 Aug 2024 06:40:06 GMT</pubDate>
            <description><![CDATA[Comprehensive guide on implementing an AI Gateway in API Management, covering key concepts, benefits, and implementation details.]]></description>
            <content:encoded><![CDATA[<p>Today, we are going to delve into some of the Generative <a href="https://learn.microsoft.com/ai/playbook/technology-guidance/generative-ai/dev-starters/genai-gateway/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">AI Gateway capabilities</a> <em>(commonly referred to as AI Gateway)</em> that are available in the <a href="https://learn.microsoft.com/azure/api-management/api-management-key-concepts?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">API Management</a> service.</p>
<p>These capabilities are designed to help secure and monitor your OpenAI endpoints in your applications as you head toward production.</p>
<!-- -->
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-overview">🌐 Overview<a href="https://luke.geek.nz/azure/implementing-ai-gateway-in-api-management/#-overview" class="hash-link" aria-label="Direct link to 🌐 Overview" title="Direct link to 🌐 Overview">​</a></h2>
<p>Common scenarios that the AI Gateway capabilities can help with include:</p>
<ul>
<li>How can we track token usage across multiple applications? How can we do cross charges for multiple applications/teams that use Azure OpenAI models?</li>
<li>How can we make sure that a single app does not consume the whole TPM quota, leaving other apps with no option to use Azure OpenAI models?</li>
<li>How can we make sure that the API key is securely distributed across multiple applications?</li>
<li>How can we distribute load across multiple Azure OpenAI endpoints? How can we make sure that PTUs are used first before falling back to Pay-as-you-go instances?</li>
</ul>
<p>In this post, we will explore how to use the AI Gateway capabilities in API Management to address these scenarios.</p>
<p><img decoding="async" loading="lazy" alt="APIM + Azure OpenAI" src="https://luke.geek.nz/assets/images/AI_Gateway_APIMOpenAI-80ae2388688f19a95cc432db3e783854.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="AI Gateway" src="https://luke.geek.nz/assets/images/ai-gateway-d9353e29e0749e3ad7ac37733aff7831.gif" width="1265" height="387" class="img_ev3q"></p>
<p>The first step is to <a href="https://learn.microsoft.com/azure/api-management/azure-openai-api-from-specification?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">import the Azure OpenAI</a> service and definition into API Management. This will allow you to create a new API in API Management that can act as a gateway to the Azure OpenAI service.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>You can import an Azure OpenAI API directly from the Azure OpenAI Service to API Management. When you import the API, API Management automatically configures:</p><ul>
<li>Operations for each of the Azure OpenAI REST API endpoints.</li>
<li>A system-assigned identity with the necessary permissions to access the Azure OpenAI resource.</li>
<li>A backend resource and set-backend-service policy that directs API requests to the Azure OpenAI Service endpoint.</li>
<li>An authentication-managed-identity policy that can authenticate to the Azure OpenAI resource using the instance's system-assigned identity.</li>
<li><em>(optionally)</em> Policies help you monitor and manage token consumption using the Azure OpenAI API.</li>
</ul><p>The general availability of this functionality went into May 2024. <a href="https://azure.microsoft.com/en-us/updates/ga-import-azure-openai-enpoints-as-an-apis-in-azure-api-management/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">GA Import Azure OpenAI endpoints as an API in Azure API Management</a>.</p></div></div>
<p>So, let us take a look at how to import the Azure OpenAI service and definition into API Management.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-request-forwarding">📬 Request Forwarding<a href="https://luke.geek.nz/azure/implementing-ai-gateway-in-api-management/#-request-forwarding" class="hash-link" aria-label="Direct link to 📬 Request Forwarding" title="Direct link to 📬 Request Forwarding">​</a></h2>
<p>Let us take a look at forwarding the request.</p>
<p><img decoding="async" loading="lazy" alt="Request Forwarding" src="https://luke.geek.nz/assets/images/AI_Gateway_APIMRequestForwarding-367920bce5a96a3bc6faafe060dab2e3.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>For this article, I have the following resources pre-deployed already:</p>
<table><thead><tr><th><strong>Name</strong></th><th><strong>Type</strong></th><th><strong>Region</strong></th></tr></thead><tbody><tr><td>openai-ca-res-eastus</td><td>Azure OpenAI</td><td>East US</td></tr><tr><td>openai-ca-res-uksouth</td><td>Azure OpenAI</td><td>UK South</td></tr><tr><td>apim-lmv01-dev-eastus-aka</td><td>API Management service</td><td>East US</td></tr></tbody></table>
<p>We will start by adding openai-ca-res-eastus to the Azure API Management service first before looking at adding the other resources.</p>
<blockquote>
<p>This will automatically, enable the System Managed Identity of API Management, to access the Azure OpenAI service with the role of <a href="https://learn.microsoft.com/azure/ai-services/openai/how-to/role-based-access-control?WT.mc_id=AZ-MVP-5004796#cognitive-services-openai-user" target="_blank" rel="noopener noreferrer">Cognitive Services OpenAI User</a>, and create a new Backend instance, and operations.</p>
</blockquote>
<p><img decoding="async" loading="lazy" alt="Add Azure OpenAI to API Management" src="https://luke.geek.nz/assets/images/apim_add_azureopenaibackend-bef0dddd0efac4ec71aabab47f30cd83.gif" width="1896" height="963" class="img_ev3q"></p>
<p>We can see the police changes applied, pointing to the backend and system-managed identity.</p>
<p><img decoding="async" loading="lazy" alt="Azure OpenAI API Management Policies" src="https://luke.geek.nz/assets/images/apim_api_openaipolicybase-a73f2a7fae5ab39b84c8c0bf3336d43d.png" width="2685" height="821" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>There is Azure Portal integration to enable a few API policies that are out of the box to help you manage the token consumption of the Azure OpenAI API.</p><p>These are:</p><p>Manage token consumption <em>(Use the Azure OpenAI token limit policy to protect the API from overuse and to control Azure OpenAI cost. If selected, API Management will add the policy with the configured TPM value. You can add, edit, or remove this policy after the API is created.)</em>
Track token usage <em>(Use the Azure OpenAI emit token policy to log the consumed total, completion, and prompt tokens. If selected, API Management will add the policy with the specified configuration. You can add, edit, or remove this policy after the API is created)</em></p></div></div>
<p>Now that we have a frontend for our Azure OpenAI service, it's time to test the Azure OpenAI endpoint through Azure API Management.</p>
<p>To do this, we will need a:</p>
<ul>
<li>deployment-id _(this is the name of the Model deployment, in Azure OpenAI)</li>
<li>api-version <em>(this is the version of the Azure OpenAI API, that we want to use)</em></li>
</ul>
<p>We can get this information from the Azure AI Studio, in the Azure Portal, in the Deployment blade.</p>
<p><img decoding="async" loading="lazy" alt="Azure OpenAI Deployment ID and API Version" src="https://luke.geek.nz/assets/images/AzureAIStudio-gpt4odeploymenturl-8e01e250dd05e2d036ffd133e8742176.png" width="1911" height="631" class="img_ev3q"></p>
<p>Now, we can test the Azure OpenAI endpoint, through Azure API Management. In Azure API Management, navigate to the openai API that you created, and select the Creates a completion for the chat message operation and the Test tab.</p>
<p>Add in your deployment ID and API version, and in the request body, enter a sample prompt like the one below:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"messages"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token property">"role"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"system"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token property">"content"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"You are a knowledgeable assistant in an ice cream parlor."</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token property">"role"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"user"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token property">"content"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"What are the ingredients typically used to make a classic vanilla ice cream?"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"max_tokens"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Azure OpenAI Test" src="https://luke.geek.nz/assets/images/apim_test_azureopenaibackend-df1f2fafd998f9f09f6a837854f26665.gif" width="1896" height="963" class="img_ev3q"></p>
<p>This confirms that we can now communicate with the Azure OpenAI service, through Azure API Management.</p>
<p>So let us test Request forwarding, from a client application, such as Postman.</p>
<p>We will need to get the subscription key from the Azure API Management instance and add this to the request header as 'API-key' after first associating the open API with a Product and the subscription key is generated.</p>
<p><img decoding="async" loading="lazy" alt="Azure OpenAI Postman Request Forwarding" src="https://luke.geek.nz/assets/images/apim_test_postmanrequestforwarding-7e4ea8153e19804af9f2e5c19dc519d3.gif" width="1896" height="963" class="img_ev3q"></p>
<p>Here is a sample PowerShell script for invoking the Azure OpenAI endpoint, through Azure API Management, as well.</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$headers</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">New-Object</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"System.Collections.Generic.Dictionary[[String],[String]]"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$headers</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Add</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"api-key"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"YOURSUBSCRIPTIONKEY"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$headers</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Add</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"Content-Type"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"application/json"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$body</span><span class="token plain"> = @</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    `"messages`": [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            `"role`": `"system`",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            `"content`": `"You are a knowledgeable assistant in an ice cream parlor.`"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        },</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            `"role`": `"user`",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            `"content`": `"What are the ingredients typically used to make a classic vanilla ice cream?`"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    ],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    `"max_tokens`": 100</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain">@</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$response</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Invoke-RestMethod</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'https://apim-lmv01-dev-eastus-aka.azure-api.net/openai/deployments/gpt-4o/chat/completions?api-version=2024-02-15-preview'</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Method </span><span class="token string" style="color:rgb(255, 121, 198)">'POST'</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Headers </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$headers</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Body </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$body</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$response</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">ConvertTo-Json</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We have successfully implemented Request forwarding, through API Management to the Azure OpenAI endpoint.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-backend-circuit-breaking">🔌 Backend circuit breaking<a href="https://luke.geek.nz/azure/implementing-ai-gateway-in-api-management/#-backend-circuit-breaking" class="hash-link" aria-label="Direct link to 🔌 Backend circuit breaking" title="Direct link to 🔌 Backend circuit breaking">​</a></h2>
<p>Now, let us take a look at Backend circuit breaking. The <a href="https://learn.microsoft.com/azure/architecture/patterns/circuit-breaker?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Circuit Breaker</a> pattern, follows the same principles as the electrical circuit breaker. It is used to detect failures and encapsulate the logic of preventing a failure from constantly recurring, during maintenance, temporary overloads, or unexpected spikes in traffic. When the circuit breaker trips, it can return an error immediately, without trying to execute the operation.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>The Circuit Breaker pattern is mentioned in my <a href="https://luke.geek.nz/azure/cloud-design-patterns/" target="_blank" rel="noopener noreferrer">Cloud Design Patterns</a> blog post.</p></div></div>
<p>A circuit breaker acts as a proxy for operations that might fail. The proxy should monitor the number of recent failures that have occurred, and use this information to decide whether to allow the operation to proceed, or simply return an exception immediately, when the circuit is Closed the requests are allowed to pass through, when the circuit is Open, the requests are blocked.</p>
<p><img decoding="async" loading="lazy" alt="Backend Circuit Breaking" src="https://luke.geek.nz/assets/images/AI_Gateway_APIMCircuitBreaker-9ff007d6e10e3e0dbc9d0e6bfb72fa62.png" width="1402" height="766" class="img_ev3q"></p>
<p>To implement a circuit breaker in API Management, we will need to add a policy to the Azure OpenAI API that monitors the number of recent failures and uses this information to decide whether to allow the operation to proceed or simply return an exception immediately.</p>
<p>Unlike Request forwarding, configuring the Circuit Breaker cannot currently be done in the Azure Portal and will require configuration through Infrastructure as Code (i.e., Bicep)_ or the API Management REST API.</p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>Before you configure a circuitbreaker policy, make sure you have a backup of your Backend configuration and test this in a non-production environment.</p></div></div>
<p>Today, we will configure it using Bicep, by referencing the backend of an already existing API Management resource, and adding in the circuitBreaker rule.</p>
<p><img decoding="async" loading="lazy" alt="Backend Circuit Breaking Bicep" src="https://luke.geek.nz/assets/images/AI_Gateway_APIMCircuitBreakerBicepDeploy-004cb18c8010a4b41fa1edf77a2bb50f.png" width="2595" height="823" class="img_ev3q"></p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> backend </span><span class="token datatype class-name">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> existingUrl </span><span class="token datatype class-name">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Use the parameters to update properties</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> updatedBackend </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.ApiManagement/service/backends@2023-09-01-preview'</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> backend</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">url</span><span class="token operator">:</span><span class="token plain"> existingUrl  </span><span class="token comment" style="color:rgb(98, 114, 164)">// Use the parameter to keep the existing URL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">protocol</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'http'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">circuitBreaker</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">rules</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">failureCondition</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">count</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">3</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Number of failures before tripping the circuit breaker</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">errorReasons</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token string" style="color:rgb(255, 121, 198)">'Server errors'</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Reasons for the failure</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">interval</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'PT1H'</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Time interval to count the failures</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">statusCodeRanges</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token property">min</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">500</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Minimum status code to consider as a failure</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token property">max</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">599</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Maximum status code to consider as a failure</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'myBreakerRule'</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Name of the circuit breaker rule</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">tripDuration</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'PT1H'</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Duration for which the circuit breaker remains tripped</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">acceptRetryAfter</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Whether to accept retry after the trip duration</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In the Circuit Breaker rule above, the following behavior will occur:</p>
<table><thead><tr><th><strong>Parameter</strong></th><th><strong>Description</strong></th></tr></thead><tbody><tr><td><strong>Number of Failures</strong></td><td>The circuit breaker will trip if there are 3 or more failures within the specified time interval.</td></tr><tr><td><strong>Error Reasons</strong></td><td>Failures considered are those matching the reason 'Server errors'. The application or service should categorize errors with this reason.</td></tr><tr><td><strong>Status Code Ranges</strong></td><td>Failures are identified based on HTTP status codes ranging from 500 to 599, covering server-side errors such as internal server errors (500), service unavailable (503), and similar issues.</td></tr><tr><td><strong>Time Interval</strong></td><td>Failures are counted within a time interval of 1 hour ('PT1H'). If there are 3 or more failures with status codes in the 500–599 range within any 1-hour window, the circuit breaker will trip.</td></tr><tr><td><strong>Trip Duration</strong></td><td>Once tripped, the circuit breaker remains in the tripped state for 1 hour ('PT1H'). During this period, requests will not pass through until the breaker is reset.</td></tr><tr><td><strong>Retry Behavior</strong></td><td>After the trip duration of 1 hour, the circuit breaker is designed to allow retries (acceptRetryAfter: true). Requests will be accepted again after the trip duration, and the service will attempt to recover.</td></tr><tr><td><strong>Scenarios Where the Circuit Breaker Will Trip</strong></td><td>If, within any 1-hour period, there are 3 or more server-side errors (HTTP status codes 500–599) with the reason 'Server errors', the circuit breaker will trip. Once tripped, the circuit breaker will block requests for 1 hour. After the 1-hour block period, the circuit breaker will reset and start accepting requests again.</td></tr></tbody></table>
<p>There is nothing in the Azure Portal for API management, but if we take a look at the backend provider resource, we can confirm that the configuration for the backend has been set.</p>
<p><img decoding="async" loading="lazy" alt="Backend Circuit Breaking Bicep" src="https://luke.geek.nz/assets/images/AI_Gateway_APIMCircuitBreakerPostBicepDeploy-190c9f1188abcb165e1ba9054103a4f8.png" width="1539" height="509" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="️-backend-load-balancing">⚖️ Backend Load Balancing<a href="https://luke.geek.nz/azure/implementing-ai-gateway-in-api-management/#%EF%B8%8F-backend-load-balancing" class="hash-link" aria-label="Direct link to ⚖️ Backend Load Balancing" title="Direct link to ⚖️ Backend Load Balancing">​</a></h2>
<p>Let us now take a look at Backend Load Balancing with <a href="https://learn.microsoft.com/azure/api-management/backends?tabs=bicep&amp;WT.mc_id=AZ-MVP-5004796#load-balanced-pool" target="_blank" rel="noopener noreferrer">Load-Balanced Pools</a>. Load balancing is the process of distributing network traffic across multiple endpoints. This ensures that no single server bears too much demand. By spreading the work evenly, load balancing improves application responsiveness.</p>
<p><img decoding="async" loading="lazy" alt="Backend Load Balancing" src="https://luke.geek.nz/assets/images/AI_Gateway_APIMBackendLoadBalancing-9b8309c78822bc9e5aacb67487938eae.PNG" width="1396" height="764" class="img_ev3q"></p>
<p>Backend pooling your Azure OpenAI endpoints, allows you to:</p>
<ul>
<li>Spread the load to multiple backends, which may have individual backend circuit breakers.</li>
<li>Shift the load from one set of backends to another for upgrade <em>(blue-green deployment)</em>.</li>
</ul>
<p>Note Backend pools don't need any policy configuration. The rules are just properties of the backend.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>API Management supports the following load balancing options for backend pools:</p><ul>
<li>Round-robin: By default, requests are distributed evenly across the backends in the pool.</li>
<li>Weighted: Weights are assigned to the backends in the pool, and requests are distributed across the backends based on the relative weight assigned to each backend. Use this option for scenarios such as conducting a blue-green deployment.</li>
<li>Priority-based: Backends are organized in priority groups, and requests are sent to the backends in order of the priority groups. Within a priority group, requests are distributed either evenly across the backends, or (if assigned) according to the relative weight assigned to each backend.</li>
</ul><p><em>(Backends in lower priority groups will only be used when all backends in higher priority groups are unavailable because circuit breaker rules are tripped.)</em></p></div></div>
<p>If we go back to my environment, we are currently operating with the following resources:</p>
<table><thead><tr><th><strong>Name</strong></th><th><strong>Type</strong></th><th><strong>Region</strong></th></tr></thead><tbody><tr><td>openai-ca-res-eastus</td><td>Azure OpenAI</td><td>East US</td></tr><tr><td>openai-ca-res-uksouth</td><td>Azure OpenAI</td><td>UK South</td></tr><tr><td>apim-lmv01-dev-eastus-aka</td><td>API Management service</td><td>East US</td></tr></tbody></table>
<p>So so far, the Azure OpenAI backend of eastus is being used, but we can add the uksouth backend to the backend pool, and configure it to be used in a round-robin fashion.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>One of the reasons you may want to do this is not only to ensure reliability, using a priority group - that your Azure OpenAI service is highly available and can be accessed from multiple regions, but you may also want to ensure that you are not hitting the <a href="https://learn.microsoft.com/azure/ai-services/openai/quotas-limits?WT.mc_id=AZ-MVP-5004796#regional-quota-limits" target="_blank" rel="noopener noreferrer">TPM <em>(Tokens Per Minute)</em> regional limits</a> of the Azure OpenAI service, and that you are distributing the load across multiple regions.</p><p>A common scenario here would be to have a primary region, that has a <a href="https://learn.microsoft.com/azure/ai-services/openai/concepts/provisioned-throughput?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">PTU <em>(Proviosned Throughout)</em></a> assigned, and failover to a pay as you go region.</p></div></div>
<p>Similar to the Circuit Breaker rule capability, we need to configure Backend Pools using the Azure RestAPI or an Infrastructure as Code method, such as Bicep.</p>
<p>In my example, I will be adding the openai-ca-res-uksouth to the backend pool of the Azure OpenAI API and configuring it to use EastUS first and failover to UKSouth if east us stops responding.</p>
<p>To do this, we need to add a new backend and then reference that in a new pool configuration.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>When we initially added our first Azure OpenAI resource, a lot of the configuration was done for us, including adding the <a href="https://learn.microsoft.com/azure/ai-services/openai/how-to/role-based-access-control?WT.mc_id=AZ-MVP-5004796#cognitive-services-openai-user" target="_blank" rel="noopener noreferrer">Cognitive Services OpenAI User</a> role to the System Managed Identity of the API Management instance to authenticate with the Azure OpenAI resource, so make sure you grant Azure API Management the necessary permissions to access any other Azure OpenAI resource.</p><p><img decoding="async" loading="lazy" alt="Azure OpenAI API Management Policies" src="https://luke.geek.nz/assets/images/apim_add_cognitiveaiuserrbacuksouth-9fc00c5bb551804001531619f03c852e.gif" width="1896" height="824" class="img_ev3q"></p></div></div>
<p>Navigate to your secondary Azure OpenAI instance, and navigate to Keys and Endpoints, we need to grab the endpoint URL ie <em>(<a href="https://openai-ca-res-uksouth.openai.azure.com/" target="_blank" rel="noopener noreferrer">https://openai-ca-res-uksouth.openai.azure.com/</a>)</em>, to add as another Backend and append with /openai.</p>
<p><img decoding="async" loading="lazy" alt="Azure OpenAI UKSouth Endpoint" src="https://luke.geek.nz/assets/images/apim_add_cognitiveaiserviceuksouth-da040a214e8a8ad004a7bfd6f067a0cd.gif" width="1896" height="824" class="img_ev3q"></p>
<p>Now that its added as a backend, we can add it to the backend pool, and configure it.</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> backendnane </span><span class="token datatype class-name">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> subscriptionID </span><span class="token datatype class-name">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> resourceGroupName </span><span class="token datatype class-name">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> APIManagementName </span><span class="token datatype class-name">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> backend1 </span><span class="token datatype class-name">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> backend2 </span><span class="token datatype class-name">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Use the parameters to update properties</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> updatedBackend </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.ApiManagement/service/backends@2023-09-01-preview'</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">'</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">APIManagementName</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">/</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">backendnane</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">description</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Load balancer for multiple backends'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Pool'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">pool</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">services</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)">// Define the backend pool configuration for an API Management service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token comment" style="color:rgb(98, 114, 164)">// Define the first backend with a specific ID, priority, and weight</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">id</span><span class="token operator">:</span><span class="token plain"> </span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">'/subscriptions/</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">subscriptionID</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">/resourceGroups/</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">resourceGroupName</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">/providers/Microsoft.ApiManagement/service/</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">APIManagementName</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">/backends/</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">backend1</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">priority</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Higher priority backend</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">weight</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain">   </span><span class="token comment" style="color:rgb(98, 114, 164)">// Weight of the backend</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token comment" style="color:rgb(98, 114, 164)">// Define the second backend with a specific ID, priority, and weight</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">id</span><span class="token operator">:</span><span class="token plain"> </span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">'/subscriptions/</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">subscriptionID</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">/resourceGroups/</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">resourceGroupName</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">/providers/Microsoft.ApiManagement/service/</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">APIManagementName</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">/backends/</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">backend2</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">priority</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Higher priority backend</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">weight</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">2</span><span class="token plain">   </span><span class="token comment" style="color:rgb(98, 114, 164)">// Weight of the backend</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Backend Pool Bicep" src="https://luke.geek.nz/assets/images/AI_Gateway_APIMBackendPoolBicepDeploy-289231677f28105dc86256ef5761cfda.png" width="1476" height="713" class="img_ev3q"></p>
<p>Once the deploy is done, we can see the backend pool configuration in the Azure Portal.</p>
<p><img decoding="async" loading="lazy" alt="Backend Pool Bicep" src="https://luke.geek.nz/assets/images/AI_Gateway_APIMBackendPool-6986a7ac57ecfcc77e0e21d5a6209b60.png" width="1808" height="682" class="img_ev3q"></p>
<p>Now we need to update the Azure API Managememt OpenAI API, to use the backend pool, instead of the single backend.</p>
<p>Navigate to APIs, and your OpenAI API, select All Operations and then select the edit button.</p>
<p>Change the backend it to the name of your Backend Pool.</p>
<p><img decoding="async" loading="lazy" alt="Backend Pool Bicep" src="https://luke.geek.nz/assets/images/AI_Gateway_APIMBackendPoolAPIPolicyConfig-2ff002f67a62ca29b6851a20c3f1e569.png" width="1837" height="659" class="img_ev3q"></p>
<p>Now if we test the Azure OpenAI endpoint, through Azure API Management, we can see that the requests are being distributed across the two backends in the backend pool.</p>
<p>If we enable, Tracing we can see the handoff, and our API callers are oblivious to the fact that their API call is getting redirected.</p>
<p><img decoding="async" loading="lazy" alt="Backend Pool Bicep" src="https://luke.geek.nz/assets/images/apim_test_loadbalancedpools-754ac7221f305622d6840c97763440ef.gif" width="1896" height="824" class="img_ev3q"></p>
<p>You can use the Circuitbreaker and Backend Pooling in conjunction with each other, to ensure that your Azure OpenAI service is highly available, and can be accessed from multiple regions.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>The Circuitbreaker policies are on the Backends, not the Pools.</p></div></div>
<p>For example, I changed the circuitBreaker rule, status code range to: 401 <em>(Permission Denied)</em> and removed the Cogniative User role from the System Managed Identity of the API Management instance, to simulate a backend failure, and moved the UkSouth endpoint to priority group 2.</p>
<p><img decoding="async" loading="lazy" alt="Backend Pool Bicep" src="https://luke.geek.nz/assets/images/AI_Gateway_APIMBackendPoolPermissionDenied-b445246a6e53b17e7a817f37c014481e.png" width="1004" height="522" class="img_ev3q"></p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">         statusCodeRanges</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">               </span><span class="token comment" style="color:rgb(98, 114, 164)">// Define the range of HTTP status codes that will be considered as failures for the circuit breaker</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token property">min</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">401</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Minimum status code to consider as a failure (e.g., Unauthorized)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token property">max</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">401</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Maximum status code to consider as a failure (e.g., Unauthorized)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>And it worked as expected, the circuit breaker tripped, and the requests were redirected to the UKSouth backend.</p>
<p><img decoding="async" loading="lazy" alt="Backend Pool Bicep" src="https://luke.geek.nz/assets/images/apim_test_loadbalancedcircuitbreakerpools-cc8d8e9284555389d1e559a788bc6bd1.gif" width="1483" height="811" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-response-streaming">📡 Response Streaming<a href="https://luke.geek.nz/azure/implementing-ai-gateway-in-api-management/#-response-streaming" class="hash-link" aria-label="Direct link to 📡 Response Streaming" title="Direct link to 📡 Response Streaming">​</a></h2>
<p>Let us take a look at Response Streaming. Response streaming is a technique used to send a response to a client in chunks, rather than all at once. This can be useful when the response is large, or when the response is being generated in real-time.</p>
<p><img decoding="async" loading="lazy" alt="Response Streaming" src="https://luke.geek.nz/assets/images/AI_Gateway_APIMResponseStreaming-01d33957f271809e6df6789b672156a3.PNG" width="4000" height="2250" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>Follow the <a href="https://learn.microsoft.com/en-us/azure/api-management/how-to-server-sent-events?WT.mc_id=AZ-MVP-5004796#guidelines-for-sse" target="_blank" rel="noopener noreferrer">guidelines</a> when using API Management to reach a backend API that implements SSE (Server side streaming).</p></div></div>
<p>If I go back to our Creates a completion for the chat message, operation, and edit the policy and add the following to the inbound and outbound Azure policies.</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">inbound</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)">&lt;!-- Base inbound processing --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">base</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)">&lt;!-- Conditional logic to check if the request body contains a non-null "stream" property --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">choose</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">when</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">condition</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">@(context.Request.Body.As&lt;JObject&gt;(true)[</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">stream"]</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">!</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)"> null</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">&amp;&amp;</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">context.Request.Body.As&lt;JObject</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">(true)["stream"].Type != JTokenType.Null)"&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token comment" style="color:rgb(98, 114, 164)">&lt;!-- Set a variable "isStream" with the value of the "stream" property from the request body --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">set-variable</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">name</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">isStream</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">value</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">@{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token tag attr-value" style="color:rgb(255, 121, 198)">                    var content = (context.Request.Body?.As&lt;JObject&gt;(true));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token tag attr-value" style="color:rgb(255, 121, 198)">                    string streamValue = content[</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">stream"].ToString();</span><span class="token tag" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token tag" style="color:rgb(255, 121, 198)">                    </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">return</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">streamValue;</span><span class="token tag" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token tag" style="color:rgb(255, 121, 198)">                </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">}"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">when</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">choose</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">inbound</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">&lt;!-- Control if and how the requests are forwarded to services --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">backend</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)">&lt;!-- Base backend processing --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">base</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">backend</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">&lt;!-- Customize the responses --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">outbound</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)">&lt;!-- Base outbound processing --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">base</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)">&lt;!-- Set a custom header "x-ms-stream" based on the value of the "isStream" variable --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">set-header</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">name</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">x-ms-stream</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">exists-action</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">override</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">value</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">@{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    return context.Variables.GetValueOrDefault</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">string</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">("isStream","false").Equals("true", StringComparison.OrdinalIgnoreCase).ToString();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                }</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">value</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">set-header</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">outbound</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This sets the x-ms-stream header to true, if the request body contains a non-null "stream" property, allowing streaming, so let us test this in Postman</p>
<p>By using the following prompt:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"messages"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">"role"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"system"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">"content"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"You are a knowledgeable assistant in an ice cream parlor."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">"role"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"user"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">"content"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"What are the ingredients typically used to make a classic vanilla ice cream?"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"max_tokens"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">100</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"stream"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Response Streaming" src="https://luke.geek.nz/assets/images/apim_test_responsestreamingpostman-30c067a88313695c3ea3d6fb1b5f9c4e.gif" width="1483" height="922" class="img_ev3q"></p>
<p>Note: Full JSON streaming support <a href="https://github.com/postmanlabs/postman-app-support/issues/12713" target="_blank" rel="noopener noreferrer">is not avaliable</a> at this time of this article in postman, so again - you need a client to support this.</p>
<p>We can, however see the response does include the response being streamed and broken up into chunks:</p>
<p><img decoding="async" loading="lazy" alt="Response Streaming" src="https://luke.geek.nz/assets/images/AI_Gateway_APIMResponseStreamingPostmanOutput-c3cc800d5ded2012e1aaaa49afcd6449.PNG" width="542" height="357" class="img_ev3q"></p>
<p>To remove the streaming component, we can either remove the stream from the body or change the stream from true to false.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-token-rate-limiting">⏳ Token rate limiting<a href="https://luke.geek.nz/azure/implementing-ai-gateway-in-api-management/#-token-rate-limiting" class="hash-link" aria-label="Direct link to ⏳ Token rate limiting" title="Direct link to ⏳ Token rate limiting">​</a></h2>
<p>Let us take a look at Token rate limiting. Token rate limiting is a technique used to limit the number of requests that can be made to an API within a certain time period. This can help prevent abuse of the API, and ensure that all users have fair access to the API.</p>
<p><img decoding="async" loading="lazy" alt="Token Rate Limiting" src="https://luke.geek.nz/assets/images/AI_Gateway_APIMTokenRateLimiting-9abe8628c0c20291dee7af1511cac346.PNG" width="1280" height="682" class="img_ev3q"></p>
<p>To implement token rate limiting in API Management, we need to add a policy to the Azure OpenAI API, that will limit the number of requests that can be made to the API within a certain time period, the tokens per minute.</p>
<p>This is an Inbound policy, and will limit the tokens per minute, with a 429 <em>(Too Many Requests)</em> response, that can be called from a single IP address <em>(each unqiue IP address will have its own counter)</em>.</p>
<p><img decoding="async" loading="lazy" alt="Token Rate Limiting" src="https://luke.geek.nz/assets/images/apim_set_RateLimitPolicy-e931dbbcf9a4be862ab32818a0310f84.gif" width="1895" height="960" class="img_ev3q"></p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">azure-openai-token-limit</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">counter-key</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">@(context.Request.IpAddress)</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">tokens-per-minute</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">500</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">estimate-prompt-tokens</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">false</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">remaining-tokens-variable-name</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">remainingTokens</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">/&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<table><thead><tr><th><strong>Property</strong></th><th><strong>Description</strong></th></tr></thead><tbody><tr><td><code>&lt;azure-openai-token-limit&gt;</code></td><td>This is a custom tag or directive used to define the rate-limiting policy for Azure OpenAI tokens.</td></tr><tr><td><code>counter-key="@(context.Request.IpAddress)"</code></td><td>This specifies that the rate-limiting should be based on the client's IP address. Each unique IP address will have its own counter.</td></tr><tr><td><code>tokens-per-minute="500"</code></td><td>This sets the limit to 500 tokens per minute for each IP address. Once an IP address consumes 500 tokens within a minute, further requests will be restricted until the next minute.</td></tr><tr><td><code>estimate-prompt-tokens="false"</code></td><td>This indicates whether to estimate the number of tokens in the prompt. Setting it to false means the actual token count will be used rather than an estimate.</td></tr><tr><td><code>remaining-tokens-variable-name="remainingTokens"</code></td><td>This specifies the variable name (<code>remainingTokens</code>) that will store the number of tokens remaining for the current minute.</td></tr></tbody></table>
<p>So lets test it, in my test, I am using a PowerShell script to call the Azure OpenAI endpoint, through Azure API Management, and I am calling it 20 times, in a loop, to test the rate limiting.</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Define the headers</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$headers</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">New-Object</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"System.Collections.Generic.Dictionary[[String],[String]]"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$headers</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Add</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"api-key"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"YOURSUBSCRIPTIONKEY"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$headers</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Add</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"Content-Type"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"application/json"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Define the body</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$body</span><span class="token plain"> = @</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    `"messages`": [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            `"role`": `"system`",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            `"content`": `"You are a knowledgeable assistant in an ice cream parlor.`"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        },</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            `"role`": `"user`",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            `"content`": `"What are the ingredients typically used to make a classic vanilla ice cream?`"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    ],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    `"max_tokens`": 100</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain">@</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Loop to run the script 20 times</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$i</span><span class="token plain"> = 1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$i</span><span class="token plain"> </span><span class="token operator">-le</span><span class="token plain"> 20</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$i</span><span class="token operator">++</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">try</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Send the request and capture the response</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$response</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Invoke-RestMethod</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'https://apim-lmv01-dev-eastus-aka.azure-api.net/openai/deployments/gpt-4o/chat/completions?api-version=2024-02-15-preview'</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Method </span><span class="token string" style="color:rgb(255, 121, 198)">'POST'</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Headers </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$headers</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Body </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$body</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Output the response as JSON</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$responseJson</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$response</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">ConvertTo-Json</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Depth 10</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$responseJson</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Handle any errors that occur during the request</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Error</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Exception</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Message</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Token Rate Limit test" src="https://luke.geek.nz/assets/images/apim_test_RateLimitPolicy-5f10867ab873c57a2602495a9fee6e9f.gif" width="1547" height="884" class="img_ev3q"></p>
<p>As we can see, it instantly gets declined after the 500th token; however, traffic from other IP addresses can still access the API.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="️-semantic-caching">🗂️ Semantic Caching<a href="https://luke.geek.nz/azure/implementing-ai-gateway-in-api-management/#%EF%B8%8F-semantic-caching" class="hash-link" aria-label="Direct link to 🗂️ Semantic Caching" title="Direct link to 🗂️ Semantic Caching">​</a></h2>
<p>Let us take a look at <a href="https://learn.microsoft.com/en-us/azure/api-management/azure-openai-enable-semantic-caching?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Semantic Caching</a>. Semantic caching is a technique used to cache responses from an API based on the content of the request. This can help improve performance by reducing the number of requests that need to be made to the API.</p>
<blockquote>
<p>With semantic caching, you can return cached responses for identical prompts and also for prompts that are similar in meaning, even if the text isn't the same.</p>
</blockquote>
<p>To use Semantic Caching, we need an Embedding model to generate embeddings for the prompts and a Cache policy to cache the responses based on the embeddings.</p>
<p>In my example, I will deploy an Embedding model <em>(text-embedding-ada-002)</em> to the East US Azure OpenAI resource.</p>
<p><img decoding="async" loading="lazy" alt="Semantic Caching - text-embedding-ada-002 deployment" src="https://luke.geek.nz/assets/images/AI_Gateway_APIMSemanticCaching_EmbeddingDeployment-bc8c70a25d269d8de2b7ea10232b0fd1.PNG" width="1633" height="981" class="img_ev3q"></p>
<p>Now, we need to add a Backend for the embedding endpoint, similar to how we originally added the US East backend. If you are using load balancing, you can add this to a new backend pool as well, as long as the model is deployed across all endpoints.</p>
<p>However, instead of a /chat endpoint, we will use the /embed endpoint, and the deployment will be the name of the embedding model deployment, as an example <em>(<a href="https://openai-ca-res-eastus.openai.azure.com/openai/deployments/text-embedding-ada-002/embeddings" target="_blank" rel="noopener noreferrer">https://openai-ca-res-eastus.openai.azure.com/openai/deployments/text-embedding-ada-002/embeddings</a>)</em>.</p>
<p>Once we have our URL we can add a new Backend.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>This could be deployed to another Azure OpenAI instance, but make sure you enable the Cognitive Services OpenAI User role on the System Managed Identity of the API Management instance to authenticate with the Azure OpenAI resource.</p></div></div>
<p><img decoding="async" loading="lazy" alt="Semantic Caching - Embedding Backend" src="https://luke.geek.nz/assets/images/apim_set_SemanticCachingModelBackend-d84de613221c75aec46d7ab782fecddb.gif" width="1906" height="884" class="img_ev3q"></p>
<p>Now, it is time to configure our <a href="https://learn.microsoft.com/azure/api-management/azure-openai-semantic-cache-lookup-policy?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">semantic caching policy</a>.</p>
<blockquote>
<p>We will need a <strong><a href="https://learn.microsoft.com/azure/api-management/api-management-howto-cache-external?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Redis Enterprise Cache deployed</a></strong>, and configured as an External cache to API Management, with <strong><a href="https://learn.microsoft.com/azure/azure-cache-for-redis/cache-redis-modules?WT.mc_id=AZ-MVP-5004796#redisearch" target="_blank" rel="noopener noreferrer">RediSearch module</a> enabled</strong> and then we can add the semantic caching policy to the Azure OpenAI API. Without the Redis cache, the semantic caching policy will not work, and the azure-openai-semantic-cache-lookup policy will be skipped.</p>
</blockquote>
<p>Navigate to our OpenAI API, select the Creates a completion for the chat message operation, and add the following policy to the inbound section.</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">azure-openai-semantic-cache-lookup</span><span class="token tag" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token tag" style="color:rgb(255, 121, 198)">    </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">score-threshold</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">0.5</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)">  </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">&lt;!--</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">Adjusted</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">threshold</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">for</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">better</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">precision</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">--</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    embeddings-backend-id="azureaiembeddingbackend"  </span><span class="token comment" style="color:rgb(98, 114, 164)">&lt;!-- Updated backend ID --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    embeddings-backend-auth="system-assigned"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ignore-system-messages="false"  </span><span class="token comment" style="color:rgb(98, 114, 164)">&lt;!-- Include system messages if they add value --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    max-message-count="15"&gt; </span><span class="token comment" style="color:rgb(98, 114, 164)">&lt;!-- Increased message count for more context --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">vary-by</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">@(context.Subscription.Id)</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">vary-by</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">azure-openai-semantic-cache-lookup</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<table><thead><tr><th><strong>Element</strong></th><th><strong>Description</strong></th></tr></thead><tbody><tr><td><code>&lt;azure-openai-semantic-cache-lookup&gt;</code></td><td>A custom tag used to define the semantic cache lookup policy for Azure OpenAI.</td></tr><tr><td><code>score-threshold="0.8"</code></td><td>Sets the threshold for similarity scores. Only results with a score of 0.5 or higher are considered.</td></tr><tr><td><code>embeddings-backend-id="embeddings-deployment"</code></td><td>Specifies the ID of the embeddings backend deployment used for the cache lookup.</td></tr><tr><td><code>embeddings-backend-auth="system-assigned"</code></td><td>Indicates that the system-assigned managed identity is used for authentication with the embeddings backend.</td></tr><tr><td><code>ignore-system-messages="true"</code></td><td>Specifies that system messages should be ignored during the cache lookup.</td></tr><tr><td><code>max-message-count="10"</code></td><td>Sets the maximum number of messages to be considered in the cache lookup.</td></tr><tr><td><code>&lt;vary-by&gt;@(context.Subscription.Id)&lt;/vary-by&gt;</code></td><td>Specifies that the cache should vary by subscription ID, meaning each subscription will have its own cache.</td></tr></tbody></table>
<p>In the Outbound processing section for the API, add the azure-openai-semantic-cache-store policy.</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">azure-openai-semantic-cache-store</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">duration</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">60</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">/&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<table><thead><tr><th><strong>Attribute</strong></th><th><strong>Description</strong></th></tr></thead><tbody><tr><td><code>&lt;azure-openai-semantic-cache-store&gt;</code></td><td>This is a custom tag or directive used to define the semantic cache store policy for Azure OpenAI.</td></tr><tr><td><code>duration="60"</code></td><td>This specifies the duration for which the cached data should be stored in minutes. In this case, the cache will be stored for 60 minutes.</td></tr></tbody></table>
<p><img decoding="async" loading="lazy" alt="Semantic Caching - Embedding Backend" src="https://luke.geek.nz/assets/images/apim_Add_SemanticCachingAPIPolicies-ffe7cbcdb9019d67cef34df899be4ce6.gif" width="1906" height="895" class="img_ev3q"></p>
<p>Once added, we can test it.</p>
<p>We can do this, using the <a href="https://learn.microsoft.com/azure/api-management/api-management-howto-api-inspector?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Trace</a> feature in Azure API Management, and we can see the cache hit, and the response being returned from the cache.</p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>If you get HTTP/1.1 415 model_error, make sure you are using a <a href="https://learn.microsoft.com/azure/ai-services/openai/concepts/models?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">model that supports embeddings</a>, and that the model is deployed.
Also if you are testing, make sure that the content-type is application/json.</p></div></div>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>I was not able to test this end-to-end in my environment due to needing a payment instance for Redis, not covered under my Visual Studio Enterprise subscription.</p></div></div>
<p>If this is all configured you should see something like the below in a Trace:</p>
<p><img decoding="async" loading="lazy" alt="Semantic Caching - Semantic Cache lookup" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA4YAAAExCAMAAAAX/UzbAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAACoUExURf///2hoaIqKivDw8FBQUK2trQAAAOLi4jU1NSMjI8bGxjQ0NFxcXKKiokRERH9/f5aWlut9buJELvjPyvW7s+A1Hf3z8uhoV/jy8qxeVp9GPfLm5MiUj5c3LeXMyo8nHLd0bdm2svCbj/vn5ORSPp5FO+RRPOZdSvGmnM6gm+vZ19Srp8KKhPrb1/bFvt/BvqVSSaVRSbFpYb1/efX19e7u7tTU1Lm5ufqyFEIAAAAJcEhZcwAADsIAAA7CARUoSoAAACXKSURBVHhe7Z2JettIkq2tfemp6vKuhZJI2zXd7vJMearn3vv+b3bjnFgyAZASZcuGZJ//c5dAIDIzMjIOMgES6GdCCCGEEEIIIYQQQgghhBDisbOzGxtfz97+QWwJMSe7h1tm9dHxPdJ/Zyc2tmD38PDk1Dd3Du+Wxe7xUWw9AAfZshATTk8OD/f34sMGTk+YjweHAMaWzpXPd3FQuTyRISpcJ6I1Mtwsts1H4OW4b6d/216GLpyj47GXCFl0JXS9s6alCQ8qavFDcWDZuLd/Rwbt/kesqI6O+XfnPgnVZDhmBxl8sEYNDyVDa3lvf9h8yfBu9var5qlDpyfmdwVuqxn5XnO8+JnY20dqhLo2YZc1u55vbni/fNooQ2byWh5QhuNW7iHDfhU5aYSBi6hsKUNNh2IDnqR23re0spUV0wprOcuxo+Nf9n01dvrrUWSvy7CbYcJ2d2fnEP9g4cu03f1fuMGFIW2wAnVFYFGHQzUHYwer5ALwwP78PZrmcg+lKtFRDW1xBDtxZNc8p3bh4MHxgdVnhVyG8Dxt4yP9DpHBQRTG4dMTq6Jo/o21bECjfg4DYxnu7f92fGj/rBRXsNHv7U8B4qciMmPHZGh5ykxG8mLDJHHg+be7kxkX06Yd8iROW7vqOzjcsXlvb8cyH2tWCOPZDhK5zYZR+iCuqyp3j3b2rAGzPT3xXd409cO9ViyNOUWhARyheOA7mmgypMbhg/2P9ZZtJ4XseaoRVXTCM7JJnBtSbw6kZT4dHZvSeOqCzKMisrd/cmoXn1ZD9Jn020I0Ohki6SwPPVe4EWnNW+1UVEskS03L27K1JDa1peDwt6X1WIZ1yTWcQmDrjcAwmnb3YBjGXtgO+fyEuk0CPNZkCEFggzOx7Wy2ExnWNAf74XcK3aWhbYdnBVR9dGxVtu50OsRO85gybLXQQyEmeBraXOfZZOLBud/oZMiEzbuGlaieh2HbZMjUx18k/QYZRjKm6GzLaylhtqaxoqPMSoYobMddRfBq5z98jTyWoc3R0XKzncowP8LX5ilJb0CzS8zY+5Ol2H7QZGi7cz1M54SY4mltYgwZ5mxoVFq3y7tBIpmK6mPJkLmOxNxChq4Lo2ynMqzsH8nwwI+gbszkaGcsQ3M8Wm62nZ58ozVgW6Mv6+l90DqR2FF3plrJidXoZGjkjNgaE2KAf2GBiz9LFWZSfhuRaR2y4dyF5A54OyNtBzLkWq3JsKVnlN6NOxa4gDIHXC6nJ2abV42lqLYYTIXuooz5wiO0syNHx/YBPbCpJ2QId1MgzbaTgm90d5t2/vZrbjp1moAvbP7Abw4Bdh/ijHo7V42hDPNvr2sheuIr9L19++t5xyUibtG4FiJxLSnz63tfKlJLYVsyRDUnv1k+NxlyNoVcYMr1GephU9hlO7BuO/4NtnFbsWTobqEplkYhv7MZR6AA5Dh/X4DCv9jlHd1EOynDsvXabKs2vGK6ObxNavDMVD6BkGH5n10rX5ImQ5Z2+dUyQIgNRM79CHSz2H2YLhm/sKJN1FlBiA389DLMxWXPgwrngUUtfkR+chna2nHdilFPWAghhBBCCCGEEEIIIYQQQgghhPheHORPJoUQM9E9NSGEmIfT0fM9QojvjmQoxOxIhkLMjp4JF2Jmtv7/lRBCfDs0GwoxO7o2FGJ2JEMhZkcyFGJ2JEMhZmfdK8mEEN+X0xP9tFsIIYQQQgghhBBCCCGEEEIIIYQQQog7eP7i5avXr+LDF/PyxfM3b9++iU89Z+cXl4ur6/i0BYvzs9i6lcXFZWx9MxY3i9h6WB6i3lu7v7xZxRbpbK+v7ojuFmFdTUZzdXPTWjw739A7WC1jmyyGbt7K8j4p9OzyYn3N0+5HqBY3Nxsb+FZpMODdg8jw/YdNMny2DBliFLrR2si3kOGmYbmdh41/8+F7yTAFsY0M19huYirDQYA3yfD6ajwGq8iG5VgD11cuWBPHzY07dK8z+f1laId+v0uGWybml/H9ZLilbh6PDB+Wh/Vhm+7fQ1rfQYbTcY2KLEGGKru+WliFpsOuyL2G+0tivVmGyTeV4asP71/+58v48MW8efvu2fPn8WGIeU8FSoaS4RCviLPk2Xm3XF3CEgd/IhkG7//xzxcv7J8J8t3r16/fYR82Pry3jee2ganu/YfXr2Hx7JXtoFHZFnv7G/7f6UuGZ+e21LChurzgf1Z2ZGWrEAQOq5GbQW+xh6NlKxdfHGClYiaLi49xBDuGIw9bqy7rZa1e6PxfFyjkJ1+chhOmBF2kNUr7H/PwD3MYWeL19Jc3aZs+LJbLG/xDKfdu6kO7kMI+OpJUddhgGFAvGlwubRfdnXQ/WNAvaMAscAAeGFaobLELZmZlIWIDzhrbDJW3yPgirOjA1Ud2yUPkMcy8h+1gMKKP0QDrG8GgLzpvqGMrsNoq8dGA1dB1CW5GhB027nWy+6vzTzf4Z1FsLoUMYYNd9tHqsUI5XKzVNs/O0Qgn66LGjS31Td+X9x8+/NfbF/9tk9o7U977D6Ytmyf92LtYbb55bjue296XL165Sdk27pQhT3y+7mBoTIY+/pe217owiP0qx3RhR3gtkdfqHLilVYWCrKrA2RRVVb1sBSwQYjtcTRclw26vbzIhUB0KDc7azTZ9sMuI1c3SqjlbWquQ+dSH2qq+JWXBOKAXK7NAqCwJrE60Pel+smLYvIpIqZyXelv+sRNhhL+Y2GaoWnxzYLxL9oEx83NZuA7brIn4iNLnTZqy/Zban1gNQV2rm48M551Zfbk8sxZRRXYJPlckQe8Qu29DZBeJfzJINQn6Ro2bKWvhHazKogPthJ1Ua9dX3YB8ESYmW1jav/cfcKEI5dUlo10++gaAOClQW4M22y3gLRrrgvfN+sSgMebZMQapH65p1nNcAVObtWBHX8gDanW1gFUkcw/sPXGDsu3Oc16q3GS9fUNlWz6YU1YHmzTwd+pDbg37BqppxiEThFnEZLcGJt33T4a1YSUuP6NQFC1pdbasmk0P5DK1zVBV3+r6LbvkHfDj3X8H9UITsad3tmdx/odJje06WH5Edhjb3E61qqtL7Lu7E/j85bgMr67NyoMUoeo22Dc/+fV9qw6wN8uuj2aAWg329qvoZMgFJ6SFpSeVaEtPKhFLUCxTczbsbO+GuVh/LewTGU6Hqw0p531MSxmtzBeuAwYrLDe15cdUAjXYtqPVDXrbXHjmKISb2BhpJ2zLB6vf6kA1PJHb36kPuTVsn2TTvgCykl6x2eUAT7rvnww7svifxfVndDCssoXednsZYsOovtluX68Nh8vl4l1iu4N6W3MDZ3tWXnc7ahObVZbhGkV8AmPVyXAUa4CroKj+ThnmuNX5rlWWLloLVcqpcbvd1S0YzYbJYEZ8BS1iJnz5wsRnS9Gh7R0wPvXX+jSRoXejH64a0rKtAGS+DCMOymQqgcwtRMwzNmm2RpzevFQnQxuhSaBhWz5Y/VYH/mV1Ux9ya5CuBZvO4WxyuVuGl5//XK7++oN7wipb6G2bLobtT2wzVM1tgBkxu+RF/Hj330G90Rz29M72MOGHhWDJmBku842kv9Ul9n3otJEzIv2xDpiVB6kC6hs1XLfI0D77hXjPYNy+nJIhL/6KEhrupkKGdg35vt0THdg6d14b0mH0EpGz1O5kiJj2F+vW9ViScDDwHQ9+DcA9lS/9jRZSi5AmAQ6SkbmFqP8+GF44xIse4vHM3DJDbG7II9imD1a/tYd/1vTlhe2d+pD1Vt+GoLr8Qo1F+LVVynDa/eTs/NO/n/37E9vI3IpSvS17VjnbMbatUA3ii5rbcGHDy3mXUC8v0gr2xKvaED5vwE1iAOrGARgN79k5Gm2gIL4NrC6hILNqSN9964D1w4OUoepkyHFbI0P2Gyx+z0IdPm6DkH4BTYa8L5p3QXkblDtMjm/e2uL0n//AXRnswVo0bRt33ynlrIKeYfX4x3knQ6wwloNLNuuZr4SwWPhktrSBUitffFnS9x+LELTQ6mVTWcgZq9cauFjZBMklbVVrs1/J0Kvti5Vt+mD1W3v2D7ZXH626qQ9Zb+tb0qrjdbRt4e8S1yEpQ2/JPrTuJ7h5gzxwNxkQRNrsypbV2p51MhzbtlBlfPnXRqB1CYMCF6pLqGQ1uG5Ck17TwNkBVtxN8jyIQKAS1ItA9fA+dINuf+xkiMJXfzJTAuYbKs7uWwdchhWqwQbHrWRYffNN7I3FUtHGjVtd09+UN28xG+Li8AnD8+K9oBQ43GI+eO9kXnJ6nBmX4QP89mZG2sl+ayjDR5AFPzf3+3Hpt+DRnIl5i6b/FuOpga/hYnN7uLj5bksOsY52+T4XlgVaDwkhhBBCCCGEEEIIIYQQQgghhBA/JpcXG39z+1VsV++Wv8+rH9x/FV/7MyT+9n7AxjedNb4uvvd5ieD9iJ92j16m+IVsftnct0qvYvzI++pmMf7t9VMgnwvCr8OH3i/jAQD+/hyH8HMuGjfbeBQ0N/gTcz/WP/S8mbtkGL/Ln1WG9WxAyrA9nLCFDO+Ow+hZhwH5zNMIPuVgnq39adfmZxl6Nsjwy363vFmGm9MLz2d4W+FDmeBRCNQHC3YUzzawq7UBRz0G0+cdnqgM6bM/5NW7j58yY7hpkIcZ1bKtFBvkmmtmu5x/UjJMbtPNhLsbvVWGnmtjbg3xvWQ45qEfHwgfp+nFJ4ihv9XNJz5VlM+gss814HWmqWe9YmMZT/2NU+Npy5Cd6wfdn4NcInrWTwwaI4JglW0N+GDkPXJ3px+QDG+vboMMfQi6Z1N7HqMMJ+nlI2q7L88vvR989Oz6czzVn4+d1nO5/tBmbawuVutlaB241/h8B/KhyzVvuxtBz23R2cbA+4/H/XF9gqdkESdboC7Ktro76Pd6yXA4YNdeOMglBlrEYhduWpO2qytNA5hcXnyKQmmb+KqNyoc1CsfbBH2G7s+M1rzZ2F5/u1H/5O/wJY04kDErH7A29xq5w2yw5bXDyLa6vo24/Pzx6sr+WbsYApqgUL1MB02iabQwicMUZnScF+NKgRXZSLE6dAVHYLamOviAPfaXofDCCxYxUF+4WTFr9cG2C52nmScOCg0OBUwQK+dWgOlVj9tjP2V4+fnakynfUUL9GnU28w1LMk/QJwDHiu8YYD5ZhzBwa2WCk6C/lS5hd/3ax+LvA2Jbn86XZXt58dFGxCxqA/hkOKaToQ0GAw+HUBcdQilrJ99Kl9RsiEIW97JNqt7uHYo2uNjNmuokapiQ/Gl61jI4768QIUYn3rjXYtbNLrHliUL86WHvSbzTY+0cZZeV/zq/+tMK1ksPq9qsroKyJg5j0IMYoSpEV4yomEdwwplWh45Gq57MrUcZlXQT5122ZiFym8kQGFGqD/aASpn47KbLi4/0yiPm2WoBdO/wyVTtNeaZoDasj09FhhwmRoBnf+u4R6ulVWP4VjqCk975X2ZrsyFuTthQmaSt0rLlLQu0Uhss1tXR4FGMNo/DEYaR3sEf7kF2uo9J+FqFyrbAeNaI8AhnOTNkbvGVDJghLATuIarA/6YvSKx6aRIx6+MVWy1pYyXladS9bG6CHbFSWZB/fUrOT4bXZV1ZE4cJpjz2ugrxjEHCS+5A3ZPquB2teujatX1vB5MatxjeqH7kXXzccEMJx8fpheVHnhw8fpxKeZlow3X1KaJTVVa4eGZBlOj548cDjb7nuQvKMmrAGnbSs+6Ogmvw2pBHlhYdq88qLVs3L3kzZ+O/E6YypCE2EH5j7TwSKVWFyrbAoRBDHKmEtBYGYxUytHatKo9OEjK0XZAsItTO93fLkI1YFeXmBDvCyKH/aAAVWF+YWlkdW8auNXGYYK3RmypET0h4yR3o8qQ6+hutRoByxV3ep5udDKPT0yFopdrydMg0va6vEF9Pls7Bel9enSSzX9W+bXD7qcnQkjdSam2GOMzdiYTQVe+uRYO14FPaegO2uzbQaKXDgKkMWS+9y4hvI8O0beAijmMcJk2G9mnwKruQIQ6vfUEiG0AnYJIxKx/alneX9DLcajasOBCe4vNTCWkbGWJ+QbEqVBvpJXeg7kl19DBadd9BXkvTuFNfbaTPFY5G1+f1M+IkvRiqcLpzMHtRrdVGNWEbfsZdfxn6+OAgIwCVUv1diSFYuXhoeDXgxHLGQuOH8YVFfbBDiOtwI5YZazA/WDPNEFNsxMUUChpr0i+qq0Jl27j8/Mnzx47wG6iS4fhVduE8Ghm/IJHtZKh4Rdxk2LqUGdhaiFy3z96dcHOCHbGE4j8rUV+zxSnOq6sEXhMHBmpA3LCvQu3tfOEvj3h3RkXhQ45yk6H3jv7FH7jJDWohf0mwZgj6Pq/tPgsxOtUwkjM8bQ5mfrZFcq1FK3Vzo/McdGn72MD6Af1pKcU1zFp3cYbhgYpTrJmQAr7UwAYHqWzRwGCjvzE5BIUX+f0Hx8pq8VfZ8eS2Ll8MOBx3cbLQ+CwY3/7CBb5DsYlk7A0qi2EdnZD48jwYw028ca+LWfjAlr04jS69EDYsZOz+FjJkIX/pIQrTNKrz+qzprWTob7tuhdw/Grm/PIJqp9WhQbzIkH7Dc+yIqKIaqy7dbDLkLnR/MgTsCaKHIfB8mIBCPFJyifwKH3h/a5RdqBc9owkO1QZ4OjL82Vl/ZiZtDUfajCeEeEhigbWObq4jkqEQ3wJb5GxS4fQFiZKhEEIIIYQQQgghhBBCCCGEEEIIIcQPy97+4f5ebAshZuLoeDe2hBBzsbsTG0KIuZAMhZgdyVCI2Tk4PootIcRcHB3rZqkQ86LZUIjZ0bWhELMjGQoxO5KhELMjGQoxN/oxmxAzs7d/qMlQCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghZuR/hRAzIxkKMTuSoRCzIxkKMTuSoRCzIxkKMTuSoRCzIxkKMTuSoRCzIxkKMTuSoRCzIxkKMTuSoRCzIxkKMTuSoRCzIxkKMTuSoRCzIxkKMTuSoRCzIxkKMTuSoRCzIxkKMTuSoRCzIxkKMTvP/o8QYmY0GwoxO5KhELMjGQoxO5KhELMjGQoxO5KhELMjGQoxO5KhELMjGQoxO5KhELMjGQoxO5KhELMjGQoxO5KhELMjGQoxO5KhELMjGQoxO5KhELMjGQoxO5KhELMjGQoxO5KhELMjGQoxO5KhELPzTAghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEKI+djZjY2v5+jX09gS4ofj6HijVA4ODw8PYnvI0fH6/SN2j49i6wF40MqEeFTcIsPNcttOhgcnnMCOjg8P9/e4J9hNfe8cHroNtu6S2c6wEiF+HL6dDPf2d/Dn6HjHNnsJ7Zr0DqDDHVMePtDmTk5PttG+EE+QbyfDmAy5mOwl5C3a3MadFOvOFirUdCiePrbqO0SyY0EYsxSXhkfHf9/3PdgxWhim3LLwnpkemoiw37Z3XWO7+3t7+7tmM1p6+kdIjLbJ6d9MngfW1AELW6mJqo9+/e3kxP6ZIfwNr2gvxJNlbz9T2eRwesL/UIwQ3wGVwUlqdB8k9IFpyNeWVgalbb+XbzI0mY4mVp/iTKBW5O++QCVQ087xbyenLLf/9+Oj07/9dhInB+fo+Pj/7p/8PyvaS4/6FeLJEgtEB8qoFR61A7lx8qLuMPe5vcvQV5QmCK/FDDFxUqBNhhRlPx3GpSHmyeOj+EAOjg9MyVbX7v4vVotVcXpCnTcR27aVg5+8hgx0cSieNjWpcCmKFWJejjUZ4sDoG4qQIWch043XYrqxlaxPpiMZdlNXtbCD1qj84PQEZlA1V7FW2hvoRNxk2H9rotlQPG1ShpQL03sqw34qCwYyjIs5GNp+rmxvmw3zE016Bfm0Z+3HLRqucbFnrQyNnBGzE0I8TY6OPccpl13MTwdx06Rk6Loa4vrg1w2w4/cKEA/2swIsU3GThfWOFo2xEK6LSjRML/iFBQ7yC4sQ8qD0UIbuRTtzCPFE4T1OS2Os8Xb4G7PTEy73Soa+o59wcI3IQnmD1Oxsw0xpv4tDuD/6C2RoB1x2RWiPhXwrZGh/w9ZKe4NoqqkQToUMuVQeqlEIsZaU3ICYDh8KfW0oxK2sleHols1X8qCVCfEDsl6GesJCCCGEEEIIIYQQQgghhBBCCCGEEEI8Mg5GzxIKIb43ej5BiNk5/VW/jBZiZiRDIWZHMhRidobviRFCfHf4+hkhxLxoNhRidnRtKMTsSIZCzI5kKMTsSIZCzA5fCyyEmJXTE/20WwghhBBCCCGEEEIIIYQQQgghhBBCiDt4/uLlq9ev4sMX8/LF8zdv376JTz1n5xeXi6vr+LSW1ebDi5ubDQevf7+1zi05O7+5OT+LD1POzhexRS4vLi5j8w66Lk0LrW5WsXUHZ+fL2Bqw2taLr2Nxw86vbm7c38lYLL7Uj1FYH4jwdyvCtrq0Oc9uY/t8uJN3DyLD9x82yfDZMmWIlF/b11tkuFluDyNDY+EyXJsaDynDy4sU36S/yPR1gnsUMuw8H8X8gWWIKNx8Rde+QIZdl7bPp+b9U5Th9ZXl1NmnNVPPk5Hh9qzp0mYZLvF5tWaGnFeGxfeSIcLAWHxHvkqGD8irD+9f/ufL+PDFvHn77tnz5/FhiKU582a5cfH3k8vw+mqNAslPKMPLi2+Q47fwWGQYvP/HP1+8sH8myHevX79+h33Y+PDeNp7bBqa69x9ev4bFs1e2g0ZlW+ztn5zG5oCWhc+WtvhgT66vuExdXX20DRzGjpFaIzxY0bJQlOH+y4ubFVMVkbm8+MNs+ry1Jm3Njz1Vr33GuoeDHR5RhlYTQF4NbPt1Tl1Hri5W4W8B277p6lIWQq0Gy4+zmTsBjDy1EaKlFV7aBg9jB1qko336W2V2DG7CB7oLWyvU3MRyD2UW53/EdUHEodUbXH9m1Th1tgMbZTiorotUF1/6i0Mbw1qEDFddl+Adw4rSbCn9HdSLPelvSwOmTBertX2rLo361tqOv1lvy5TKh4xDpeKX8/7Dh/96++K/bVJ7Z8p7/8G0ZfOkH3sXq803z23Hc9v78sUrNynbxiYZtm4uGDT+xz1eoVNIRs4Lo1nTy7GH11cLN8Ei1/azfCdD+ziYWWzPknuq3pxHJjJs4StbnOvHMXVb9zeqIiszg3dFdcmIP5XM4xFfYrDB5fLMWjRr3NbCDhto9Cscgmd0fDAbWhoumMFwiIejPfMh9jK/7drAFGCH+jhUvcnlZ7pGl8rh2hg5vkAnM1RsOqn4VgBvDatTblaXYH95Yb5kppS/VUOLamzaoHcD3o/S2r5Vl0Z9yyEoH1q9nfce6gzrg8jwnS0s7d/7D7hQhPLqktEuH30DQJwUqK1Bm+3dDLvpQxT5x/gjMxihUTz8I03Qa0SFXbWx4r5Ohuh/5bTBEcShqjfvUVaaGJG1Gb605dFxTN22/B0wsO1NooEa+XEPe5fd2nuLKqMDXsIMWddIht4Vrx7H8740a7HdHmccZ1KygYhD1ZvQ3AKGrniN/cbIcVaXocpukk6GsffWsDq8RUOz6JKfH6y3lSnlb9XLMXbcjeEZoPfYdk77Vga9pZFDUD60lOm89z5nWGu4vpxOhlxwQlpYelKJtvSkErEExTI1Z8PO9k68P76FeHdntMpZzP+x+Cg8PJ551l8OJ/p7/fsnniKr7yHDcTKAVm8sR1pMK33Sm7Rlu+OYum2vMcdXKp1tbxIN1Mjn6ihpLrNt+5R1V988ZJaj7P6g6Yyru8BVki372Dz+Yz31TqDLJcOMQ9WbmO31//x1eY46y+Fpzjouwys7A7CW6oY35sVy5XZrWJ3M/OpSDP3Vddk3f2tFiMbdf3ezNY240sVgbd+qS6O+ZYzLh75L5b0P7beRYX/bdDAjvoIWMRO+fGHis6Xo0PZ26COo/pTDlbPdabmIODAq1tWQIScIntPHMuyq8D3GoF6UajHNUJY3aTuOOHHb8jeZxr83iQZq5MfQFpRKsu4mw8wR1tU33cmwrx4zIuu13e4YjjcZGojDKPeM5WLxx18rLt+qxtoYmbsMczbs6eNrHbAWbw2rU3EYyRCzYdgPHBjPiN5eaxrK7yO1tm9V46hvGePyodXbee+x/BYy5MVfUULD3VTI0K4h37d7ogNbZ9O1oQ07nPx0xv4soaAF/oMjmbO5VurxODDSGB6aoN/Yzwq4KLeZiPXWUALuAYN6EUoEjIt9I9MyJqW0hQnr7XHb8jdh/AdfW/Um0QCNSPY7ODunsavk+sqsLy+6IhjXyjjUy+vOInOWV1UFokMfOCXUBkyyvx6H+FAs/lperv59jqoqVac566A6ujhoGmBvxtdbXBPWcXRr7LJL9I6DmBEb+ps9CY27myWXkbPGur6V1ci8DUH4UPV6KB33oMKaqfjlNBnyvmjeBeVtUO4wOb55a4vTf/4Dd2WwB2vRtG1slKFF1xdLuFX2iUsDLI2QV9jLnOXlQXWSIwUYAPubZWDKsC3tEI4sbMFPi0E+lAyr3rpLB1/+MB98lcPxR/neB3xe8UIiKNteYw7KLHvbMukawKYP21CG6AYXVvTgI0zYb94pxbbV64GwYtaD8z/7RW3J0Nd9Zsu/tpMdYYKi26i28qXiUPUmuBnCFPRVJDQWG20sEjbAz9l0kfFtgzINq1XYF5nK0JukDUrjcPpb9TK+6Fu62eTCTt7at+rStG++i+H3A50MOU7d0FZYcQCp+H148xazIS4OHxNNdIJUWv+cePcpkR8Tl+ED/PbmQZEMR0iGmMswU/6g8BZN/y3GY0AyHPGTy9CXnlyUCyGEEEIIIYQQQgghhBBCCCHEYwTfanY/tLubB/te/M539szxy6ONr/XBzxgjTvwh+jZsF6pt3l2E1u/11TN/f/r98J/U8ofot3FZv+/eyAOlF5+9fTrcI9Xj18tbxWnwS+cNbEy/fDjkUckQh7aW4eZQrXnwZQsZ5q+btwhrePk4ZWiGd3V2q/Sqhyk2U8/LPwXu8zjUQ8twI3PK8BZKhndzLxluQabdI5fhQ/BQMnxSSIbbIxluRjK8B/WIW8CHvrhrubRjCCVMrq6fXX7+eHVl/9qvgf1xLVtSXF58OvcLlXjQqgNGtqds69Jz+vayvNaavEGNz455NRcf49k8VDgYnfK3fODjXnyG35pEJ9uTYdkAa0Y14ziUCcrwQPO32UaCmy/0qZmM47AhVAhr9a1o15wIVe8VmzbTKHR1PQ2ruWQ7u+AxCqjGZBhxSNsO7EEhtA1fFuf/umCntghrFh6FNfzE55GtR2tC+oBO4a9Xg0cH70wv1so+tTGevHTv8cIrjPasMMiT89K6hxMoTRZ41cbFv86v/hycuusUbwHAU7Y8bw1mrHZOzC20hjrrtWAdntZeXT7ZSdIpf8WVBRcFh2fJ9Ld8CI1gYHwvpwO8TagayGq9tT4OZoIXvLAGP9GWv51tNhFPZtcL2aZxmITqbGmf+VB6OdGIeidn+HozWzs2Dqs1EGNWRG0WB3Q9nB+Y1FUTn7nwV7TZFuzuDivNBq8m495wjM+9R9NRw/oHO5oPZsZ3PvH10UbFbBrWll4Rj36MRy/de8QwSJ5DSckQPbTOsQe202Jg/x3mTOWW7cTwMBY5TqS9XSJsvTFrl4MxsM2PVV0jm+UYWCt+NFORpL/lQ76SiyODIz78LB0N1MNmkzjQxHdHM+VvZ1tO+keaoJ/lQ2McKsKdw5CSMMg3qA1xd/y/VW+Flb0eVhm1MQ44UrZFCsNDBXs2jbrvDqsL2myHaRCOsZlqmh/DnxHpA3Hb6OKwXpbG7EcPK714LGuxDxWHbrgeLT6Z9wHwCBgZhIyjBcMO5VEnQt3ixOoqNKBWWJkvvkYqGfbVeYhbdY1stsmQtYSLJP1tPsCIY4EeWEn3wDZaA1jCoNwkDu6Y1+kjXP52tuXkWIY0GcZhFCq3wc5hSEnWazadTwbb7pyahtUdHxC1lRbKtohKwhVUUXPO3WGtvlffmDJR50iGqNelMiZ9YP1cV7Iod0S968Kan1OGrCXHGKxJ8UdH9rQjs2Ikw+1nwwl+ygrbOi9FWvcxjY9VXSObZXZQhoNyoPKl9wHnxMiXeEO/l+4a4Iw4iYOPou/2GsvfzrbcGMtwGodxqMq2+tbRdW8wI2b3sRlNjMPqjg+I2poM07aISsIV2LMlcHdYo+/bzYZQUt+jRvMhbTPQw3oneHrFMa/FPlQcJkP7CGmTepFZkfGniZ9e7FAedeICo+LEJf0ET4OwrXUg8zAbCdyyqusIw8pDrpUGZFVDH2wQOK5onesU3+gbQHWTONCELrpB529nW3WMZLgmDuNQwTa+kRwFweg6P9AMuh/fxEXaZb0VVjYwxAXjfzB+ZVvkW8ZGr2gDd4eV1aHZQd/y7XBDGXYdGzN42Ry/OM0vFKve29Irxmo4xmBNitt8u9GNecCkPryPNJYhTSyk1q+JDHly6+JvAXDjgusIL+K2Vj924RaNgTEqfPkQ66rRgGGlYvWWDN2496X8TR/413ayQQ4SlztWbTXAHXR3HIc64is45pVBf9M2/fUemTMlw2kcJqFCoauPfINa9K3Ien2jDwMt+Wa2kuE4rGxgBLzpX5KZtg3uQedQG2qeyPCWsHKL3Yq+oRa+HY6RskKtad8zddFIH2DiL7FjU/1ZcxJWuBu1IVgc2/ybjeRwNcym7/xPTZy+vj3Mgfsyzebv5u8T4YvC6nO3Qvl4kAyfNl8hw+kVhZgLyfBp80Vh9VXkYIUohBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGePdvbP9zfi20hxEwcHe/GlhBiLnZ3YkMIMReSoRCzIxkKMTsHx0exJYSYi6Nj3SwVYl40GwoxO7o2FGJ2JEMhZkcyFGJ2JEMh5kY/ZhNiZvb2DzUZCiGEEEIIIYQQQgghhBBiLp49+/+wYbfLKMbzawAAAABJRU5ErkJggg==" width="902" height="305" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-logging">📜 Logging<a href="https://luke.geek.nz/azure/implementing-ai-gateway-in-api-management/#-logging" class="hash-link" aria-label="Direct link to 📜 Logging" title="Direct link to 📜 Logging">​</a></h2>
<p>Now let us take a look at Logging. Logging is the process of recording events that occur during the execution of a process. Logs can be used to monitor and troubleshoot requests, as well as to analyze and report on application performance.</p>
<p><img decoding="async" loading="lazy" alt="APIM Built in Logging" src="https://luke.geek.nz/assets/images/AI_Gateway_APIMBuiltinLogging-3eb67482fcc9ca685d10242055dc315d.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>To do this, we need to enable <a href="https://learn.microsoft.com/azure/azure-monitor/app/app-insights-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Application Insights</a>, which will create a <a href="https://learn.microsoft.com/azure/templates/microsoft.apimanagement/service/loggers?pivots=deployment-language-bicep&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Logger entity</a> to Application Insights from API Management.</p>
<p><img decoding="async" loading="lazy" alt="APIM Built in Logging" src="https://luke.geek.nz/assets/images/AI_Gateway_APIMLogging_AppInsights-287e0ea93ebe8c5df5e6cb53bdaac841.PNG" width="1361" height="487" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>If you're not using Azure API Management, I recommend you check out the workbook by Dolev Shor (Microsoft Fastrack Engineer). You can read more about it here: <a href="https://techcommunity.microsoft.com/t5/fasttrack-for-azure/azure-openai-insights-monitoring-ai-with-confidence/ba-p/4026850?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure OpenAI Insights: Monitoring AI with Confidence</a>.</p></div></div>
<p>So, let's take a look at some of the logs generated by the Azure OpenAI API through Azure API Management and visible through the Application Insights and Log Analytics workspace.</p>
<p><img decoding="async" loading="lazy" alt="APIM Built in Logging" src="https://luke.geek.nz/assets/images/AI_Gateway_APIMBuiltinLoggingAppInsights-178892bf52e262e9009cb8600c5e0bba.PNG" width="1669" height="889" class="img_ev3q"></p>
<p>The first thing you could do is configure an availability test for your API Management endpoint.</p>
<p>The API Management Gateway health probe URL is: /status-0123456789abcdef</p>
<p>So our availability test URL would be: '<a href="https://apim-lmv01-dev-eastus-aka.azure-api.net/status-0123456789abcdef" target="_blank" rel="noopener noreferrer">https://apim-lmv01-dev-eastus-aka.azure-api.net/status-0123456789abcdef</a>'</p>
<p><img decoding="async" loading="lazy" alt="API Management avaliability test" src="https://luke.geek.nz/assets/images/AI_Gateway_APIMLogging_AppInsightsAvaliabilityTest-cdb16c486eeb95f7d06665fc5c9c5ba7.PNG" width="1679" height="680" class="img_ev3q"></p>
<p>Next, we need to make sure that we are logging the information from the API requests, such as client IP, request URL, response code, and response time, to do that, we need to <a href="https://learn.microsoft.com/en-us/azure/api-management/api-management-howto-app-insights?tabs=rest&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">enable the Application Insights logging on our openai</a> API in API Management.</p>
<p><img decoding="async" loading="lazy" alt="APIM Built in Logging" src="https://luke.geek.nz/assets/images/AI_Gateway_APIMBuiltinLoggingAppInsightsEnable-fcff727a466f91ea50c8b4719b747fff.PNG" width="1413" height="790" class="img_ev3q"></p>
<p>Let's take a look at a custom <a href="https://learn.microsoft.com/azure/azure-monitor/visualize/workbooks-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Monitor workbook</a> that helps visualize and bring out a lot of the data you need to make informed decisions without having to delve into KQL <em>(Kusto Query Language)</em> queries in Log Analytics.</p>
<p>In Application Insights, navigate to Workbooks, click + New, click on the Code and paste the workbook data from: <a href="https://github.com/Azure-Samples/AI-Gateway/blob/main/labs/built-in-logging/openai-usage-analysis-workbook.json" target="_blank" rel="noopener noreferrer">AI-Gateway/main/labs/built-in-logging/openai-usage-analysis-workbook.json</a>.</p>
<p>You can see the APIs getting called, the subscription key being used, the response time, and the response code.</p>
<p><img decoding="async" loading="lazy" alt="APIM Built in Logging" src="https://luke.geek.nz/assets/images/apim_test_OpenAIWorkbook-2c7ebb1f779b8e751890e56c81927e6e.gif" width="1895" height="960" class="img_ev3q"></p>
<p>If you are using a Token Limit policy, you can trace the OpenAITokenLimitExeeded exceptions. This can help you determine if you need to block any particular IP addresses either using an ip-filter policy or Application Gateway if that is in front of your API Management or if you need to increase the TPM limit.</p>
<p><img decoding="async" loading="lazy" alt="App Insights - Token Limit" src="https://luke.geek.nz/assets/images/AI_Gateway_APIMBuiltinLoggingAppInsights_TokenLimit-f8be079f178c67e719247ebb6082bd22.PNG" width="1847" height="905" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-conclusion">🔚 Conclusion<a href="https://luke.geek.nz/azure/implementing-ai-gateway-in-api-management/#-conclusion" class="hash-link" aria-label="Direct link to 🔚 Conclusion" title="Direct link to 🔚 Conclusion">​</a></h2>
<p>In this article, we have taken a look at how we can use Azure OpenAI as a backend to Azure API Management, how to test the Azure OpenAI endpoint, through Azure API Management, and how to implement Request forwarding, Backend circuit breaking, Backend Load Balancing, Response Streaming, Token rate limiting, Semantic Caching, and Logging.</p>
<p>All code can be found here: <a href="https://github.com/lukemurraynz/AI_Gateway_Tests" target="_blank" rel="noopener noreferrer">lukemurraynz/AI_Gateway_Tests</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-reference">📚 Reference<a href="https://luke.geek.nz/azure/implementing-ai-gateway-in-api-management/#-reference" class="hash-link" aria-label="Direct link to 📚 Reference" title="Direct link to 📚 Reference">​</a></h2>
<ul>
<li>🔗<a href="https://learn.microsoft.com/azure/api-management/api-management-key-concepts?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">What is Azure API Management</a></li>
<li>🔗<a href="https://learn.microsoft.com/azure/ai-services/openai?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure OpenAI</a></li>
<li>🔗<a href="https://techcommunity.microsoft.com/t5/azure-integration-services-blog/introducing-genai-gateway-capabilities-in-azure-api-management/ba-p/4146525?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Introducing GenAI Gateway Capabilities in Azure API Management</a></li>
<li>🔗<a href="https://luke.geek.nz/azure/cloud-design-patterns/" target="_blank" rel="noopener noreferrer">Cloud Design Patterns</a></li>
<li>🔗<a href="https://luke.geek.nz/azure/api-management-overview/" target="_blank" rel="noopener noreferrer">Features and Benefits of Azure API Management</a></li>
<li>🔗<a href="https://aka.ms/apim/genai/labs" target="_blank" rel="noopener noreferrer">Azure-Samples/AI-Gateway</a></li>
</ul>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Securing Container Supply Chains with CSSC Framework]]></title>
            <link>https://luke.geek.nz/azure/secure-container-supply-chain/</link>
            <guid>https://luke.geek.nz/azure/secure-container-supply-chain/</guid>
            <pubDate>Thu, 08 Aug 2024 08:50:10 GMT</pubDate>
            <description><![CDATA[Explore Microsoft's Containers Secure Supply Chain (CSSC) Framework, a robust ecosystem of tools and processes for securing container supply chains.]]></description>
            <content:encoded><![CDATA[<p>Today, we are going to take a look inside the <a href="https://learn.microsoft.com/azure/security/container-secure-supply-chain/articles/container-secure-supply-chain-implementation/containers-secure-supply-chain-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Containers Secure Supply Chain Framework</a>, a framework from Microsoft that utilizes an agile ecosystem of tools and processes built to integrate and execute security controls throughout the lifecycle of containers.</p>
<!-- -->
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">📋Overview<a href="https://luke.geek.nz/azure/secure-container-supply-chain/#overview" class="hash-link" aria-label="Direct link to 📋Overview" title="Direct link to 📋Overview">​</a></h2>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p><img decoding="async" loading="lazy" alt="Container Supply Chain (CSSC) Framework" src="https://luke.geek.nz/assets/images/ContainerSupplyFramework_Overview-4b5856ae5fca80ac8d85b78045c76274.PNG" width="4000" height="2250" class="img_ev3q"></p><blockquote>
<p>Microsoft's <a href="https://learn.microsoft.com/azure/security/container-secure-supply-chain/articles/container-secure-supply-chain-implementation/containers-secure-supply-chain-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Containers Secure Supply Chain Framework</a> framework is a seamless, agile ecosystem of tools and processes built to integrate and execute security controls throughout the lifecycle of containers. The container secure supply chain strategy considers all the security needs of container applications. The goal is to prevent the use of vulnerable container images and create container infrastructure with a standard security portfolio.</p>
</blockquote><p>The CSSC framework is built using the following steps:</p><ul>
<li>Identify the supply chain stages for containerized applications</li>
<li>Outline the risks and the required security controls in each stage</li>
<li>Describe the security objectives and goals in each stage</li>
<li>Identify security tools, processes, and best practices in each stage</li>
<li>Maintain security posture with metadata, logging, and reporting in each stage</li>
</ul></div></div>
<p>In essence, the Containers Secure Supply Chain (CSSC) framework ensures the security and integrity of containerized applications throughout their lifecycle. It aims to prevent vulnerable container images and create a secure container infrastructure by integrating security controls at every stage of the supply chain.</p>
<p>The CSSC framework protects against several risks, including:</p>
<ul>
<li>Vulnerable container images: Ensuring that only secure and compliant images are used.</li>
<li>Malware and unauthorized changes: Verifying the authenticity and integrity of container images.</li>
<li>Supply chain attacks: Mitigating risks from external sources and third-party vendors.</li>
<li>Runtime threats: Reducing the attack surface of running containers.</li>
</ul>
<p>By addressing these risks, the CSSC framework helps maintain a secure and reliable environment for containerized applications.</p>
<p>During each stage, make sure you have gates in place to ensure that the image is secure, meets the minimum quality standard, and gets peer approval before moving to the next stage. This could be done by using Azure Policy, Azure Security Center, or CI/CD with tools such as Azure DevOps or GitHub.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="stages-of-the-container-supply-chain">🔄Stages of the Container Supply Chain<a href="https://luke.geek.nz/azure/secure-container-supply-chain/#stages-of-the-container-supply-chain" class="hash-link" aria-label="Direct link to 🔄Stages of the Container Supply Chain" title="Direct link to 🔄Stages of the Container Supply Chain">​</a></h2>
<p>We will dig into each stage, with a focus on some of the tools, mainly <a href="https://learn.microsoft.com/azure/container-registry/container-registry-intro?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Container Registry (ACR)</a>, that can be used to implement the security controls in each stage.</p>
<p>We will consider using separate Container Registers, one for each stage, to ensure that the security controls are implemented at each stage.</p>
<p><img decoding="async" loading="lazy" alt="Azure Container registries" src="https://luke.geek.nz/assets/images/ContainerSupplyFramework_ACRRegistries-4f7f1c98a843ffe672a0673d0ee49183.PNG" width="4000" height="2250" class="img_ev3q"></p>
<ul>
<li>One for Quarantine</li>
<li>One for Catalog</li>
<li>One for deployment</li>
</ul>
<p><img decoding="async" loading="lazy" alt="Container Supply Chain (CSSC) Framework" src="https://luke.geek.nz/assets/images/ContainerSupplyFramework_PortalACRRegistries-56a878b75c3f94e96d085572334dcbc5.PNG" width="306" height="131" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>Make use of <a href="https://learn.microsoft.com/en-us/azure/container-registry/container-registry-webhook?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Container Registry webhooks</a> to trigger awareness and automation when images are pushed to the registries. This could trigger a pipeline to scan the images and move them to the next stage if they meet the minimum quality standard.</p></div></div>
<p>So, let us dig into each stage.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="stage-1-acquire">🛒Stage 1: Acquire<a href="https://luke.geek.nz/azure/secure-container-supply-chain/#stage-1-acquire" class="hash-link" aria-label="Direct link to 🛒Stage 1: Acquire" title="Direct link to 🛒Stage 1: Acquire">​</a></h3>
<p>The <a href="https://learn.microsoft.com/azure/security/container-secure-supply-chain/articles/container-secure-supply-chain-implementation/acquire-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Acquire</a> stage is the first step in the container supply chain. It involves obtaining container images from sources that you may deem trusted or un-trusted and ensuring their integrity and authenticity.</p>
<p><img decoding="async" loading="lazy" alt="Acquire" src="https://luke.geek.nz/assets/images/ContainerSupplyFramework_Acquire-061991d6f6507311d35619bc18802716.PNG" width="4000" height="2250" class="img_ev3q"></p>
<ul>
<li>The Acquire stage aims to validate and ensure compliance of external container images with enterprise policies before internal use. This includes vulnerability and malware scanning.</li>
<li>It involves centralizing the acquisition and management of external artifacts, importing images into an internal registry, and enriching images with metadata like SBOMs and provenance.</li>
<li>Key tools include Azure Container Registry (ACR) for storing and distributing images, ORAS for interacting with OCI registries, ACR Tasks for automating tasks, and Microsoft Defender for Cloud security.</li>
<li>Microsoft recommends building software from source when possible and, if not, following the CSSC framework’s practices for acquiring external container images.</li>
</ul>
<p>In the Aquire stage, you should establish a minimum quality standard for images sourced externally. This includes scanning for vulnerabilities and malware, verifying the authenticity and integrity of images, and enriching images with metadata like Software Bill of Materials (SBOMs) and provenance information.</p>
<p>Tools that can be useful during this stage are:</p>
<ul>
<li><a href="https://learn.microsoft.com/azure/defender-for-cloud/defender-for-containers-introduction?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Microsoft Defender for Cloud (for Containers)</a></li>
<li><a href="https://trivy.dev/" target="_blank" rel="noopener noreferrer">Trivy</a></li>
<li><a href="https://project-copacetic.github.io/copacetic/website/" target="_blank" rel="noopener noreferrer">Copacetic</a></li>
<li><a href="https://learn.microsoft.com/azure/container-registry/container-registry-intro?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Container Registry (ACR)</a></li>
</ul>
<blockquote>
<p>The process of quarantining is a security measure that consists of a series of checkpoints that are employed before an artifact is consumed. Those security checkpoints make sure that an artifact transitions from an untrusted status to a trusted status.</p>
</blockquote>
<p>Let's take a look at the <a href="https://learn.microsoft.com/azure/architecture/patterns/quarantine?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Quarantine</a> function of Azure Container Registry. This function could automate the process of scanning and quarantining images that do not meet the minimum quality standard.</p>
<p>In my demo, I will be using the <a href="https://hub.docker.com/_/debian" target="_blank" rel="noopener noreferrer">debian</a> base image from the dockerhub and pushed into my Azure Container Registry.</p>
<p><img decoding="async" loading="lazy" alt="Container Image - Debian" src="https://luke.geek.nz/assets/images/ContainerSupplyFramework_Quarantine_debianimage-3df69e9f341828f61313ba5cfb79eafc.PNG" width="1915" height="628" class="img_ev3q"></p>
<p>Let's enable Quarantine functionality on the Azure Container Registry. <strong>At the time of this article, this is a preview feature.</strong></p>
<blockquote>
<p>When a registries policy is set to <a href="https://learn.microsoft.com/rest/api/containerregistry/registries/update?view=rest-containerregistry-2023-01-01-preview&amp;tabs=HTTP&amp;WT.mc_id=AZ-MVP-5004796#quarantinepolicy" target="_blank" rel="noopener noreferrer">Quarantine</a> Enabled, all images pushed to that registry are put in quarantine by default. Only after the image has been verified and the quarantine flag removed may a subsequent pull be completed. Once Quarantine is enabled on a registry, a newly pushed image will enter a quarantine state automatically, and only a user with quarantine reader permissions can see the image.</p>
</blockquote>
<p>Using Azure CLI, we can enable Quarantine on the Azure Container Registry. Quarantine functionality is only allowed on Premium SKU registries.</p>
<p><img decoding="async" loading="lazy" alt="Enable Container Registry quarantinePolicy" src="https://luke.geek.nz/assets/images/ACR_EnableqQuarantine-3b07443b9cd59778978ceed957bc4a47.gif" width="934" height="515" class="img_ev3q"></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token builtin class-name" style="color:rgb(189, 147, 249)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">ACR_NAME</span><span class="token operator">=</span><span class="token plain">acrqr</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">id</span><span class="token operator">=</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">az acr show </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--name</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> $ACR_NAME </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--query</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable function" style="color:rgb(80, 250, 123);font-style:italic">id</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-o</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> tsv</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">az resource update </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--ids</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$id</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--set</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">properties.policies.quarantinePolicy.status</span><span class="token operator">=</span><span class="token plain">enabled</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Once the image is quarantined, you need a user with the AcrQuarantineReader role. The presumption here is the Vulnerability Scanning solution is configured to use this account.</p>
<p>We can run the following Azure CLI to check the image status in the Quarantine.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token builtin class-name" style="color:rgb(189, 147, 249)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">ACR_NAME</span><span class="token operator">=</span><span class="token plain">acrqr</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">IMAGE_NAME</span><span class="token operator">=</span><span class="token plain">debian</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">az acr manifest list </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-r</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ACR_NAME</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-n</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$IMAGE_NAME</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>!<img decoding="async" loading="lazy" alt="Check Quarantine status" src="https://luke.geek.nz/assets/images/ACR_CheckQuarantine-a08812704c6360b0ac25785c4518e204.gif" width="934" height="515" class="img_ev3q"></p>
<ol>
<li>Now using <a href="https://learn.microsoft.com/azure/defender-for-cloud/defender-for-containers-introduction?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Defender for Containers</a>, we can scan our images in the Container Registry for vulnerabilities.</li>
<li>You can also use <a href="https://trivy.dev/" target="_blank" rel="noopener noreferrer">Trivy</a> to scan the images for vulnerabilities and reveal more about the SBOM (Software Bill of Materials) used in the image.</li>
<li>Add any additional metadata to the image, such as the <a href="https://learn.microsoft.com/azure/security/container-secure-supply-chain/articles/attach-sbom?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">SBOM</a>, and <a href="https://docs.docker.com/build/attestations/slsa-provenance/" target="_blank" rel="noopener noreferrer">provenance</a> information.</li>
</ol>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>Check out <a href="https://luke.geek.nz/azure/automate-container-patching-with-trivy-copacetic-azure-devops/" target="_blank" rel="noopener noreferrer">Container Patching with Azure DevOps, Trivy and Copacetic</a> blog article for more information on how to automate the scanning of images with Copacetic in the Azure Container Registry, from an Azure DevOps pipeline.</p></div></div>
<p>Once you have determined that your Container Image's state is good, you can remove the Quarantine flag from it by running the following Azure CLI command.</p>
<p>In order to call the API, you currently need permissions for both Contributor and AcrQuarantineWriter (or AcrPush role) on the registry.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token builtin class-name" style="color:rgb(189, 147, 249)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">ACR_NAME</span><span class="token operator">=</span><span class="token plain">acrqr</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">IMAGE_NAME</span><span class="token operator">=</span><span class="token plain">debian</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">az acr repository show-manifests </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--name</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ACR_NAME</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--repository</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$IMAGE_NAME</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--detail</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Find the digest of the image you want to remove the quarantine flag from, and run the following Azure CLI command.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token builtin class-name" style="color:rgb(189, 147, 249)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">ACR_NAME</span><span class="token operator">=</span><span class="token plain">acrqr</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">IMAGE_NAME</span><span class="token operator">=</span><span class="token plain">debian</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">MANIFEST_DIGEST</span><span class="token operator">=</span><span class="token plain">sha256:b1ae8b5bfaa9afa86b50c2a151a442d832c4449cf3731bddf8a728e5628ebb59</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">REPOSITORY</span><span class="token operator">=</span><span class="token plain">debian</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">REGISTRY</span><span class="token operator">=</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ACR_NAME</span><span class="token plain">.azurecr.io</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Get the Entra ID access token</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">EID_ACCESS_TOKEN</span><span class="token operator">=</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">az account get-access-token </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--query</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> accessToken </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-o</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> tsv</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Exchange the AAD access token for an ACR refresh token</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">ACR_REFRESH_TOKEN</span><span class="token operator">=</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token variable function" style="color:rgb(80, 250, 123);font-style:italic">curl</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-s</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-X</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> POST </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-H</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">"Content-Type: application/x-www-form-urlencoded"</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable punctuation" style="color:rgb(248, 248, 242);font-style:italic">\</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">  </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-d</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">"grant_type=access_token&amp;service=</span><span class="token variable string variable" style="color:rgb(189, 147, 249);font-style:italic">$REGISTRY</span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">&amp;access_token=</span><span class="token variable string variable" style="color:rgb(189, 147, 249);font-style:italic">$EID_ACCESS_TOKEN</span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">"</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable punctuation" style="color:rgb(248, 248, 242);font-style:italic">\</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">  https://$REGISTRY/oauth2/exchange </span><span class="token variable punctuation" style="color:rgb(248, 248, 242);font-style:italic">\</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">  </span><span class="token variable operator" style="color:rgb(189, 147, 249);font-style:italic">|</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> jq </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-r</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">'.refresh_token'</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Create the repo-level scope</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">SCOPE</span><span class="token operator">=</span><span class="token string" style="color:rgb(255, 121, 198)">"repository:</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$REPOSITORY</span><span class="token string" style="color:rgb(255, 121, 198)">:pull,metadata_write"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Get the ACR access token using the refresh token</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">ACR_ACCESS_TOKEN</span><span class="token operator">=</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token variable function" style="color:rgb(80, 250, 123);font-style:italic">curl</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-s</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-X</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> POST </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-H</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">"Content-Type: application/x-www-form-urlencoded"</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable punctuation" style="color:rgb(248, 248, 242);font-style:italic">\</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">  </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-d</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">"grant_type=refresh_token&amp;service=</span><span class="token variable string variable" style="color:rgb(189, 147, 249);font-style:italic">$REGISTRY</span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">&amp;scope=</span><span class="token variable string variable" style="color:rgb(189, 147, 249);font-style:italic">$SCOPE</span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">&amp;refresh_token=</span><span class="token variable string variable" style="color:rgb(189, 147, 249);font-style:italic">$ACR_REFRESH_TOKEN</span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">"</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable punctuation" style="color:rgb(248, 248, 242);font-style:italic">\</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">  https://$REGISTRY/oauth2/token </span><span class="token variable punctuation" style="color:rgb(248, 248, 242);font-style:italic">\</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">  </span><span class="token variable operator" style="color:rgb(189, 147, 249);font-style:italic">|</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> jq </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-r</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">'.access_token'</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Check if the access token is null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$ACR_ACCESS_TOKEN</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"> </span><span class="token operator">==</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"null"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Failed to retrieve access token. Please check your credentials and scope."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">exit</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Use the ACR access token in the curl command</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-v</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-X</span><span class="token plain"> PATCH </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-H</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Authorization: Bearer </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$ACR_ACCESS_TOKEN</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-H</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Content-Type: application/json"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-d</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        "quarantineState": "Passed", </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        "quarantineDetails": "{\"state\":\"scan passed\"}"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">      }'</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string" style="color:rgb(255, 121, 198)">"https://</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$ACR_NAME</span><span class="token string" style="color:rgb(255, 121, 198)">.azurecr.io/acr/v1/</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$IMAGE_NAME</span><span class="token string" style="color:rgb(255, 121, 198)">/_manifests/</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$MANIFEST_DIGEST</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Remove Quarantine" src="https://luke.geek.nz/assets/images/ACR_RemoveQuarantine-0a75dfc6cb9ce4f99d260a60ee196a8e.gif" width="934" height="375" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="stage-2-catalog">📦Stage 2: Catalog<a href="https://luke.geek.nz/azure/secure-container-supply-chain/#stage-2-catalog" class="hash-link" aria-label="Direct link to 📦Stage 2: Catalog" title="Direct link to 📦Stage 2: Catalog">​</a></h3>
<p>The <a href="https://learn.microsoft.com/azure/security/container-secure-supply-chain/articles/container-secure-supply-chain-implementation/catalog-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Catalog</a> stage is the second step in the container supply chain. It involves storing and managing container images in a central repository, where they can be easily accessed and deployed.</p>
<p><img decoding="async" loading="lazy" alt="Catalog" src="https://luke.geek.nz/assets/images/ContainerSupplyFramework_Catalog-2a459a46cb7b5afff337d136f4c3d1ad.PNG" width="4000" height="2250" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Microsoft recommends that internal teams use container images from an internal catalog whenever possible.</p><p>If enterprises are not able to do so, we recommend the following practices for cataloging container images.</p><ul>
<li>Catalog golden images to enable internal teams to easily discover and consume approved images that enterprise applications and services require.</li>
<li>Continuously scan container images for vulnerabilities and malware, generate reports, and sign reports to ensure authenticity and integrity.</li>
<li>Monitor the lifecycle of catalog images and retire images that are out of support.</li>
</ul></div></div>
<p>After the images have been acquired, vetted by the previous step, and meet organizational requirements, it's time to move the photos into a Catalog Container Registry, where they can be stored in a central repository and easily accessed.</p>
<p>Unlike the Acquire Container Registry, this Registry will not be quarantined. However, it will need to be continuously scanned for vulnerabilities and malware as part of operations using tools like Defender for Cloud and Trivy.</p>
<ol>
<li>Now using <a href="https://learn.microsoft.com/azure/defender-for-cloud/defender-for-containers-introduction?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Defender for Containers</a>, we can scan our images in the Container Registry for vulnerabilities. As this is a Catalog registry, we need to make sure that we monitor and remediate any vulnerabilities that are found.</li>
<li>You can also make use of <a href="https://trivy.dev/" target="_blank" rel="noopener noreferrer">Trivy</a>, to scan the images for vulnerabilities.</li>
</ol>
<p>It can also be valid to move images from the Catalog back to the Quarantine registry if the Catalog registry is not monitored or the image has been found to have high-priority vulnerabilities that fall beneath an organization threshold.</p>
<p>You can use the following Azure CLI command to move an image between the Quarantine and Catalog registries.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Variables</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">SOURCE_REGISTRY</span><span class="token operator">=</span><span class="token string" style="color:rgb(255, 121, 198)">"acrqr"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">TARGET_REGISTRY</span><span class="token operator">=</span><span class="token string" style="color:rgb(255, 121, 198)">"acrcatalog"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">IMAGE_NAME</span><span class="token operator">=</span><span class="token string" style="color:rgb(255, 121, 198)">"debian:v1"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Import image from source registry to target registry</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">az acr </span><span class="token function" style="color:rgb(80, 250, 123)">import</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--name</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$TARGET_REGISTRY</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--source</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$SOURCE_REGISTRY</span><span class="token plain">.azurecr.io/</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$IMAGE_NAME</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--image</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$IMAGE_NAME</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Move Image between Registries" src="https://luke.geek.nz/assets/images/ACR_MoveQuarantinetoCatalog-f262519143351521aa7b163af208987e.gif" width="934" height="375" class="img_ev3q"></p>
<p>We can see the image now in our Catalog registry. The image is left in the Quarantine registry, as it has not been removed. If needed, you can now remove this.</p>
<p><img decoding="async" loading="lazy" alt="Azure Container Registry - Catalog" src="https://luke.geek.nz/assets/images/ContainerSupplyFramework_Catalog_debianimage-202c7557b0a984c5b522133b00dd6eb1.PNG" width="1642" height="631" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="️stage-3-build">🛠️Stage 3: Build<a href="https://luke.geek.nz/azure/secure-container-supply-chain/#%EF%B8%8Fstage-3-build" class="hash-link" aria-label="Direct link to 🛠️Stage 3: Build" title="Direct link to 🛠️Stage 3: Build">​</a></h3>
<p>The <a href="https://learn.microsoft.com/azure/security/container-secure-supply-chain/articles/container-secure-supply-chain-implementation/build-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Build</a> step is the third step in the container supply chain. It involves building container images from source code and ensuring that they meet security and compliance requirements, whereas previous steps were more aligned with container images that were sourced externally. However, the following practices can be applied to both.</p>
<p><img decoding="async" loading="lazy" alt="Build" src="https://luke.geek.nz/assets/images/ContainerSupplyFramework_Build-9d3e6b2ada13b3dce97ceb562cbcada5.PNG" width="4000" height="2250" class="img_ev3q"></p>
<blockquote>
<p>It is crucial to ensure that base images are always pulled from the internal catalog and verified before use. After building the images, some enterprises publish them without vulnerability and malware scanning and fail to generate attestations like SBOM, which cannot be verified in subsequent supply chain stages. It is essential to ensure that the produced container images are trusted and compliant with the enterprise policies.</p>
</blockquote>
<p>The build phase is all about building application images consistently and securely.</p>
<ul>
<li>Use trusted images only</li>
<li>Verify lifecycle and provenance metadata</li>
<li>Scan after build</li>
<li>Fix known vulnerabilities during and post-build</li>
<li>Sign images and artifacts</li>
</ul>
<p>Tools that can be used during the Build stage are:</p>
<ul>
<li><a href="https://github.com/" target="_blank" rel="noopener noreferrer">GitHub</a></li>
<li><a href="https://azure.microsoft.com/products/devops?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure DevOps</a></li>
<li><a href="https://learn.microsoft.com/azure/defender-for-cloud/defender-for-containers-introduction?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Defender for Cloud</a></li>
<li><a href="https://docs.github.com/en/code-security/getting-started/dependabot-quickstart-guide" target="_blank" rel="noopener noreferrer">Dependabot</a></li>
<li><a href="https://project-copacetic.github.io/copacetic/website/" target="_blank" rel="noopener noreferrer">Copacetic</a></li>
</ul>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p><a href="https://learn.microsoft.com/azure/container-registry/container-registry-tasks-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Container Registry (ACR) Tasks</a> can help fill in the gaps in the Build stage. ACR Tasks can automate the building of container images from source code, scanning for vulnerabilities, and signing images, as part of your build workflow.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="stage-4-deploy">🚢Stage 4: Deploy<a href="https://luke.geek.nz/azure/secure-container-supply-chain/#stage-4-deploy" class="hash-link" aria-label="Direct link to 🚢Stage 4: Deploy" title="Direct link to 🚢Stage 4: Deploy">​</a></h3>
<p>The Deploy stage is the fourth step in the container supply chain. It involves deploying container images to production environments where end-users can access them.</p>
<p><img decoding="async" loading="lazy" alt="Build" src="https://luke.geek.nz/assets/images/ContainerSupplyFramework_Deploy-84fea8f21107edd18dd2f9add99cb341.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>This stage is usually where you move the images downstream from the Catalog registry to the application Deployment registries, where they are deployed to production environments.</p>
<p>Use a secure and scalable private registry for application deployments. Ensure that the registry is protected with role-based access control (RBAC), that images are signed, and that the correct metadata is attached.</p>
<ul>
<li>Continuously scan for vulnerabilities and malware</li>
<li>Keep artifact metadata up-to-date</li>
<li>Enforce deployment policies</li>
</ul>
<p>Just because the images have been moved to the Deployment registry does not mean that they are safe to deploy. You should still be scanning them for vulnerabilities and malware and ensuring that they are signed and have the correct metadata attached.</p>
<p>The same tools we have used in the previous stages can be used in this stage.</p>
<ul>
<li><a href="https://learn.microsoft.com/azure/defender-for-cloud/defender-for-containers-introduction?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Defender for Cloud</a></li>
<li><a href="https://project-copacetic.github.io/copacetic/website/" target="_blank" rel="noopener noreferrer">Copacetic</a></li>
<li><a href="https://trivy.dev/" target="_blank" rel="noopener noreferrer">Trivy</a></li>
<li><a href="https://helm.sh/" target="_blank" rel="noopener noreferrer">HELM</a></li>
</ul>
<p>This is the stage where Copacetic can assist with patching deployed containers and ensuring that the images are up-to-date and secure at the OS layers. The images are fully patched and tested back at the Build and Catalog stages.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="stage-5-runtime">🚀Stage 5: Runtime<a href="https://luke.geek.nz/azure/secure-container-supply-chain/#stage-5-runtime" class="hash-link" aria-label="Direct link to 🚀Stage 5: Runtime" title="Direct link to 🚀Stage 5: Runtime">​</a></h3>
<p>The Runtime stage is the fifth and final step in the container supply chain. It involves monitoring and securing running containers in production environments so that end-users can access them.</p>
<p><img decoding="async" loading="lazy" alt="Run" src="https://luke.geek.nz/assets/images/ContainerSupplyFramework_Run-2d1a6e0e361dec3fb677df39022ac514.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>This is one of the most important stages, as this is where the images are running in production and are exposed to the Internet. You should monitor the images for vulnerabilities and malware and ensure that they are signed and have the correct metadata attached.</p>
<ul>
<li>Monitor for Abnormal behavior</li>
<li>Continuously scan for vulnerabilities and malware</li>
<li>Keep runtime node ContainerSupplyFramework_Quarantine_debianimage</li>
</ul>
<p>Tools that can be used in this stage are:</p>
<ul>
<li><a href="https://learn.microsoft.com/azure/governance/policy/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Policy</a></li>
<li><a href="https://learn.microsoft.com/azure/aks/what-is-aks?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Kubernetes (AKS)</a></li>
<li><a href="https://learn.microsoft.com/azure/defender-for-cloud/defender-for-cloud-introduction?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Defender for Cloud</a></li>
<li><a href="https://open-policy-agent.github.io/gatekeeper/website/" target="_blank" rel="noopener noreferrer">Gatekeeper</a></li>
<li><a href="https://learn.microsoft.com/azure/aks/image-integrity?tabs=azure-cli&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Ratify</a></li>
</ul>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p><a href="https://portal.azure.com/#view/Microsoft_Azure_Security_CloudNativeCompute/AggregatedRecommendationBlade/assessmentKey/e9acaf48-d2cf-45a3-a6e7-3caa2ef769e0/showSecurityCenterCommandBar~/false" target="_blank" rel="noopener noreferrer">Containers running in Azure should have vulnerability findings resolved</a> Defender recommendations are worth a look to see a list of vulnerabilities, once Defender for Cloud is turned, for Azure Kubernetes Clusters.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-conclusion">🏁 Conclusion<a href="https://luke.geek.nz/azure/secure-container-supply-chain/#-conclusion" class="hash-link" aria-label="Direct link to 🏁 Conclusion" title="Direct link to 🏁 Conclusion">​</a></h3>
<p>Hopefully, this article has given you an insight into the <a href="https://learn.microsoft.com/azure/security/container-secure-supply-chain/articles/container-secure-supply-chain-implementation/containers-secure-supply-chain-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Containers Secure Supply Chain Framework</a>, and how you can implement the security controls at each stage, using Azure Container Registry, and other tools.</p>
<p><img decoding="async" loading="lazy" alt="Impact of Technology" src="https://luke.geek.nz/assets/images/ImpactofTechnology_SatyaNadella-b9091c962836d451b3892c08353da771.PNG" width="4000" height="2250" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-reference">📖 Reference<a href="https://luke.geek.nz/azure/secure-container-supply-chain/#-reference" class="hash-link" aria-label="Direct link to 📖 Reference" title="Direct link to 📖 Reference">​</a></h2>
<ul>
<li>🔗<a href="https://learn.microsoft.com/azure/security/container-secure-supply-chain/articles/container-secure-supply-chain-implementation/containers-secure-supply-chain-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Containers Secure Supply Chain Framework</a></li>
<li>🔗<a href="https://github.com/duffney/secure-supply-chain-on-aks" target="_blank" rel="noopener noreferrer">duffney/secure-supply-chain-on-aks</a></li>
<li>🔗<a href="https://learn.microsoft.com/azure/architecture/patterns/quarantine?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Quarantine pattern</a></li>
<li>🔗<a href="https://www.youtube.com/watch?v=7RvFj_RWE7c" target="_blank" rel="noopener noreferrer">Secure Container Supply Chain with Notation, ORAS, and Ratify</a></li>
<li>🔗<a href="https://notaryproject.dev/" target="_blank" rel="noopener noreferrer">Notary</a></li>
<li>🔗<a href="https://learn.microsoft.com/azure/aks/use-azure-policy?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Secure your Azure Kubernetes Service (AKS) clusters with Azure Policy</a></li>
</ul>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Features and Benefits of Azure API Management]]></title>
            <link>https://luke.geek.nz/azure/api-management-overview/</link>
            <guid>https://luke.geek.nz/azure/api-management-overview/</guid>
            <pubDate>Wed, 07 Aug 2024 09:25:09 GMT</pubDate>
            <description><![CDATA[Discover the key features and benefits of Azure API Management, including security, scalability, and monitoring capabilities.]]></description>
            <content:encoded><![CDATA[<p>Today, we are going to look at <a href="https://learn.microsoft.com/azure/api-management/api-management-key-concepts?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure API Management</a>. Azure API Management is a service that creates consistent and modern API gateways for existing back-end services. It also publishes APIs to external, partner, and internal developers. Azure API Management is a fully managed service that enables customers to publish, secure, transform, maintain, and monitor APIs.</p>
<!-- -->
<blockquote>
<p><a href="https://learn.microsoft.com/azure/api-management/api-management-key-concepts?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure API Management</a> is a hybrid, multi-cloud management platform for APIs across all environments. As a platform-as-a-service, API Management supports the complete API lifecycle.</p>
</blockquote>
<p>We'll examine the API life cycle phases in-depth and explore how Azure API Management can help you efficiently manage your APIs from start to finish.</p>
<p><img decoding="async" loading="lazy" alt="Azure API Management - Overview" src="https://luke.geek.nz/assets/images/apim_overview-9c57c798c4389c1dc408e504110da877.PNG" width="4000" height="2250" class="img_ev3q"></p>
<ul>
<li><strong>Design</strong>
The first phase of the API life cycle is Design. In this phase, we define the API's purpose, endpoints, and the data it will handle. This involves creating a blueprint for the API, including its structure and functionality. Azure API Management provides tools and templates to help you design efficient, scalable, and easy-to-use APIs.</li>
<li><strong>Develop</strong>
Once the design is in place, we move on to the development phase. This is where the actual coding happens. Developers write the code that implements the API's functionality based on the design specifications. Azure API Management supports various development environments and integrates seamlessly with tools like Visual Studio, making the development process smoother and more efficient.</li>
<li><strong>Secure</strong>
Security is a critical aspect of API management. We ensure our APIs are protected from unauthorized access and potential threats in the Secure phase. Azure API Management offers robust security features such as authentication, authorization, and encryption. These features help safeguard your APIs and the data they handle, ensuring that only authorized users can access them.</li>
<li><strong>Publish</strong>
After securing the API, it's time to make it available to users. The Publish phase involves exposing the API to developers and end-users. Azure API Management provides a developer portal where you can publish your APIs, offer documentation, and manage subscriptions. This makes it easy for developers to discover and start using your APIs.</li>
<li><strong>Scale</strong>
As your API gains popularity, you must ensure it can handle increased traffic. The Scale phase focuses on optimizing the API's performance and scalability. Azure API Management allows you to scale your APIs effortlessly, ensuring they can handle large volumes of requests without compromising performance.</li>
<li><strong>Monitor</strong>
Monitoring is essential to ensuring your APIs function correctly and efficiently. Azure API Management provides detailed analytics and logging capabilities in the Monitor phase. You can track usage patterns, monitor performance metrics, and identify potential issues before they impact your users.</li>
<li><strong>Analyze</strong>
In the Analyze phase, we use the data collected during monitoring to gain insights into how our APIs are used. Azure API Management offers powerful analytics tools that help you understand user behavior, identify trends, and make data-driven decisions to improve your APIs continuously.</li>
</ul>
<p>In the modern digital era, transformation is more than just a buzzword—it's necessary. APIs are at the heart of this transformation, enabling connected experiences and seamless integration of services and data.</p>
<p><img decoding="async" loading="lazy" alt="Azure API Management - Digital Transformation" src="https://luke.geek.nz/assets/images/apim_overview_digitaltransformation-a579568972f49eb29cfd94428caa6c86.gif" width="2238" height="1200" class="img_ev3q"></p>
<p>APIs are crucial in connecting various devices and platforms. Whether it's a smart home system, wearable technology, automotive applications, or industrial equipment, APIs facilitate the communication and interoperability between these diverse endpoints.</p>
<p>Please be sure to think about your daily interactions with technology. From unlocking your smartphone, using applications on your tablet, streaming content on your smart TV, and engaging in augmented reality experiences, APIs are working behind the scenes to ensure a smooth and connected experience. They enable devices and applications to talk to each other, share data, and create a cohesive user experience.</p>
<p>APIs connect various services, databases, servers, and cloud infrastructures. They allow these systems to interact, share data, and coordinate complex functions.</p>
<p>APIs also enable businesses to be agile and adaptive. By exposing functionalities through APIs, companies can quickly integrate new services, scale their operations, and meet evolving customer demands. They empower developers to build robust applications, enhance user experiences, and drive digital growth.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-api-governance">📜 API governance<a href="https://luke.geek.nz/azure/api-management-overview/#-api-governance" class="hash-link" aria-label="Direct link to 📜 API governance" title="Direct link to 📜 API governance">​</a></h2>
<p>Three crucial aspects of API governance and usage play a significant role in achieving success:</p>
<ul>
<li><strong>Façade Abstraction</strong>
This concept involves creating an interface that simplifies and standardizes how APIs interact with backend systems.
Aggregate or Slice: APIs can aggregate data from multiple sources or slice it into meaningful pieces for specific use cases. This flexibility allows businesses to present data in the most relevant and valuable way to their users.
Normalize or Modernize: Façade Abstraction also helps normalize or modernize legacy systems, making them compatible with modern applications. This allows you to extend the life of older systems and integrate them with new technologies without extensive rework.
Decouple Lifecycle Mock: Decoupling the API lifecycle from the backend systems ensures that changes in backend services do not disrupt the API functionality. Mocking services during the development and testing phases further ensures smooth transitions and updates.</li>
<li><strong>Front Door Control</strong>
This aspect is about managing and controlling how APIs are accessed and utilized.
Route and Accelerate: You can optimize your applications' performance and responsiveness by routing API requests efficiently. Acceleration techniques like caching and load balancing can significantly improve user experience.
Secure and Protect: Security is paramount in API management. Front Door Control involves implementing robust security measures to protect APIs from threats and unauthorized access. These measures include authentication, authorization, and data encryption.
Transform and Observe: Transforming API requests and responses to meet specific requirements and observing API usage patterns helps maintain control and ensure optimal performance. Monitoring tools provide insights into how APIs are being used and can alert you to potential issues before they become critical.</li>
<li><strong>Frictionless Consumption</strong>
This principle is about making it easy for developers and users to discover, access, and use your APIs.
Onboarding: A smooth onboarding process is crucial for attracting and retaining users. Clear documentation, tutorials, and support help users quickly understand and start using your APIs.
Discover and Learn: APIs should be easily discoverable. A well-organized developer portal where users can learn about the available APIs, their functionalities, and use cases can achieve this.
Try and Obtain Access: Allowing users to try APIs in a sandbox environment and easily obtain access through streamlined registration encourages experimentation and adoption.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-stakeholders">🤝 Stakeholders<a href="https://luke.geek.nz/azure/api-management-overview/#-stakeholders" class="hash-link" aria-label="Direct link to 🤝 Stakeholders" title="Direct link to 🤝 Stakeholders">​</a></h2>
<p>Azure API Management has the following stakeholders:
&nbsp;</p>
<ul>
<li><strong>App Developers</strong>
These are the individuals or teams responsible for creating applications that consume APIs. They use the platform to discover, learn, try, onboard, and get help with APIs.
Employees, Partners.</li>
<li><strong>Customers</strong>
These stakeholders leverage the APIs to enhance workflows, integrate systems, and improve customer experiences.</li>
<li><strong>Apps on Devices</strong>
These represent the end-user applications that interact with the APIs. They could be mobile apps, web applications, IoT devices, or other software that consumes APIs.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="️-planes">✈️ Planes<a href="https://luke.geek.nz/azure/api-management-overview/#%EF%B8%8F-planes" class="hash-link" aria-label="Direct link to ✈️ Planes" title="Direct link to ✈️ Planes">​</a></h2>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Azure API Management consists of three main planes:
&nbsp;</p><ul>
<li><strong>User Plane</strong>
Developer Portal: This portal serves as the primary interface for app developers. It provides resources for developers to discover, learn, try, and onboard with APIs. The portal ensures developers have the support they need to integrate APIs efficiently into their applications.</li>
<li><strong>Data Plane</strong>
Gateway: The Gateway is a secure bridge between the API consumers and the backend services. It enforces security policies, manages traffic, and ensures reliable API performance. The gateway handles rate limiting, authentication, and request routing tasks.</li>
<li><strong>Management Plane</strong>
API Management Plane: This is where API providers manage the lifecycle of their APIs. The management plane includes tools for abstracting, securing, evolving, observing, and monetizing APIs. This layer ensures that APIs are managed effectively, from creation and deployment to monitoring and analytics.</li>
</ul></div></div>
<p>Azure API Management integrates with various Azure services and microservices, providing a cohesive environment for managing and deploying APIs. This integration allows organizations to leverage the full power of Azure's cloud capabilities, ensuring that their APIs are scalable, secure, and performant.</p>
<ul>
<li><strong>Benefits</strong></li>
</ul>
<p>Some of the benefits of Azure API Management include:</p>
<ul>
<li>Discoverability: Developers can easily find and access APIs.</li>
<li>Security: Robust security measures protect data and ensure compliance.</li>
<li>Scalability: APIs can scale to meet growing demand.</li>
<li>Efficiency: Streamlined management processes enhance productivity.</li>
<li>Monetization: Organizations can generate revenue from their APIs.</li>
</ul>
<p>In conclusion, Azure API Management is a robust platform that enables organizations to create, manage, and scale APIs efficiently. By following the API life cycle phases and leveraging Azure API Management's features, businesses can deliver seamless digital experiences, drive innovation, and stay ahead in today's competitive landscape.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-azure-api-management-plans">📊 Azure API Management plans<a href="https://luke.geek.nz/azure/api-management-overview/#-azure-api-management-plans" class="hash-link" aria-label="Direct link to 📊 Azure API Management plans" title="Direct link to 📊 Azure API Management plans">​</a></h2>
<p><img decoding="async" loading="lazy" alt="API Management - Pricing Tiers" src="https://luke.geek.nz/assets/images/apim_overview_pricingtiers-bcfa201ca0c9fd9294564e842a8384f7.gif" width="2238" height="1200" class="img_ev3q"></p>
<p>Azure API Management offers various service tiers that provide specific capabilities and benefits. Let's explore these tiers in more detail.</p>
<ul>
<li><strong>Consumption Tier</strong>
&nbsp;
Key Features include:</li>
</ul>
<ul>
<li>No Infrastructure to Provision or Manage: The consumption tier eliminates the need to manage infrastructure. This serverless approach lets you focus solely on your APIs without worrying about the underlying hardware or software.</li>
<li>Built-in Auto-scaling Down to Zero: It automatically scales to handle varying loads and can scale down to zero during inactivity, ensuring cost-efficiency.</li>
<li>Consumption-based Micro Billing: Billing is based on actual usage, making it a cost-effective solution for unpredictable or fluctuating traffic applications.</li>
<li>Variable, Usage-based Monthly Cost: You pay only for what you use, allowing for a flexible and budget-friendly approach.</li>
<li>No Reserved Capacity: This tier does not require any reserved capacity, making it ideal for projects with uncertain demands.</li>
<li>Shared Management Plane: The management plane is shared, simplifying administration and reducing costs.</li>
<li>On-demand Activation: APIs can be activated on demand, providing flexibility and agility.</li>
<li>Curated Set of Features and Usage Limits: This tier offers a curated set of features and usage limits, ensuring a streamlined and efficient API management experience.</li>
</ul>
<ul>
<li><strong>Developer, Basic, Standard, and Premium Tiers</strong>
&nbsp;
Key Features include:</li>
</ul>
<ul>
<li>No Infrastructure to Provision or Manage: Similar to the consumption tier, these tiers also eliminate the need to manage infrastructure, allowing you to focus on development and deployment.</li>
<li>Manual Scaling or External Auto-scaling: These tiers support manual scaling or external auto-scaling, providing more control over resource allocation.</li>
<li>Billing Based on Reserved Capacity: Billing is based on reserved capacity, offering predictable and consistent costs.</li>
<li>Constant, Predictable Monthly Cost: Unlike the consumption tier, these tiers provide a constant, predictable monthly cost, making budget planning easier.</li>
<li>Reserved Capacity: These tiers offer reserved capacity, ensuring that your APIs can handle consistent and high-demand workloads.</li>
<li>Dedicated Management, User, and Data Planes: With dedicated planes, you get enhanced security, performance, and isolation, which is crucial for mission-critical applications.</li>
<li>Always On APIs are always available, ensuring high availability and reliability for your applications.</li>
<li>Full Set of Features: These tiers offer complete features without governance limits, providing comprehensive capabilities for complex and large-scale API management needs.</li>
</ul>
<p><img decoding="async" loading="lazy" alt="APIM Pricing Tiers" src="https://luke.geek.nz/assets/images/apim_pricing_tiers-795f483a8b914bce8072e7d9bfd089fa.png" width="4000" height="2250" class="img_ev3q"></p>
<p>Let's delve into the key features of each tier.</p>
<table><thead><tr><th>Feature</th><th>Basic</th><th>Basic v2</th><th>Standard</th><th>Standard v2</th><th>Premium</th></tr></thead><tbody><tr><td>Microsoft Entra Integration</td><td>No</td><td>Yes</td><td>Yes</td><td>Yes</td><td>Yes</td></tr><tr><td>Virtual Network (VNet) Support</td><td>No</td><td>No</td><td>No</td><td>Yes</td><td>Yes</td></tr><tr><td>Private Endpoint Support</td><td>Yes</td><td>No</td><td>Yes</td><td>No</td><td>Yes</td></tr><tr><td>Multi-region Deployment</td><td>No</td><td>No</td><td>No</td><td>No</td><td>Yes</td></tr><tr><td>Availability Zones</td><td>No</td><td>No</td><td>No</td><td>No</td><td>Yes</td></tr><tr><td>Autoscaling</td><td>Yes</td><td>No</td><td>Yes</td><td>No</td><td>Yes</td></tr><tr><td>Self-hosted Gateway</td><td>No</td><td>No</td><td>No</td><td>No</td><td>Yes</td></tr><tr><td>Backup and Restore</td><td>Yes</td><td>No</td><td>Yes</td><td>No</td><td>Yes</td></tr><tr><td>Management over Git</td><td>Yes</td><td>No</td><td>Yes</td><td>No</td><td>Yes</td></tr><tr><td>Static IP</td><td>Yes</td><td>No</td><td>Yes</td><td>No</td><td>Yes</td></tr></tbody></table>
<blockquote>
<p>"Accelerate your API strategy with Azure API Management, the comprehensive lifecycle solution trusted by thousands of enterprises worldwide. From abstraction and security to observability and discoverability, the APIM platform empowers you to manage APIs effortlessly across clouds and on-premises environments. Built for reliability, security, scalability, and performance, it's designed to support DevOps and developers, seamlessly integrating with Azure services. Benefit from global availability, robust support, and competitive, accessible pricing—Azure API Management simplifies API management so you can focus on innovation."</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-api-lifecycle">🔄 API Lifecycle<a href="https://luke.geek.nz/azure/api-management-overview/#-api-lifecycle" class="hash-link" aria-label="Direct link to 🔄 API Lifecycle" title="Direct link to 🔄 API Lifecycle">​</a></h2>
<p><img decoding="async" loading="lazy" alt="API Lifecycle" src="https://luke.geek.nz/assets/images/apim_api_lifecycle-82f1ac68f6035c8177bb18ad49f66b02.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>The API lifecycle consists of several phases, each essential for creating, managing, and optimizing APIs. This lifecycle emphasizes the continuous and iterative nature of API development and management.</p>
<ul>
<li><strong>Design</strong></li>
</ul>
<p>The lifecycle begins with the Design phase. In this phase, APIs are conceptualized and defined.</p>
<p>Key features include:</p>
<ul>
<li>Start fast with proxy mode: Quickly create an API proxy to start testing.</li>
<li>Design and mock: Define and simulate APIs to validate their design.</li>
<li>Import from a definition: Use existing API definitions to create new APIs.</li>
<li>Import from Azure resources: Generate APIs based on Azure services.</li>
<li>Capture schema from test calls: Automatically generate API schemas from sample requests and responses.</li>
</ul>
<ul>
<li><strong>Develop</strong></li>
</ul>
<p>The next phase is Develop, where the API is built and refined. This stage includes:</p>
<ul>
<li>50+ policies: Apply various policies to control API behavior.</li>
<li>SOAP-to-REST: Convert SOAP services to RESTful APIs.</li>
<li>Visual Studio Code integration: Use VS Code for development and debugging.</li>
<li>Live policy debugging: Debug policies in real-time.</li>
<li>API scaffolding: Automatically generate code and configurations for APIs.</li>
</ul>
<ul>
<li><strong>Secure</strong></li>
</ul>
<p>In the Secure phase, the API's security is ensured. This involves:</p>
<ul>
<li>Data | Management | User planes: Secure different aspects of data and management.</li>
<li>Keys, OAuth, certificates, custom: Implement authentication and authorization mechanisms.</li>
<li>1st and 3rd party identity providers: Integrate with various identity providers.</li>
<li>Request/response validation: Validate API requests and responses for security.</li>
<li>IP-based access control: Restrict access based on IP addresses.</li>
<li>Private networking: Secure APIs within private networks.</li>
<li>Compliance: Ensure APIs comply with industry standards and regulations.</li>
</ul>
<ul>
<li><strong>Publish</strong></li>
</ul>
<p>After securing the API, it is time to Publish it. This stage involves:</p>
<ul>
<li>Revisions and versions: Manage different versions and revisions of the API.</li>
<li>API products, user groups, subscriptions: Organize APIs into products and manage user access.</li>
<li>Customizable developer portal: Provide a portal for developers to access and use APIs.</li>
<li>Integrated API playground: Allow developers to test APIs within the portal.</li>
<li>Export to the Power Platform: Integrate APIs with Microsoft Power Platform.</li>
<li>Self-service onboarding: Enable users to onboard themselves.</li>
<li>DevOps: Integrate with DevOps pipelines for continuous integration and deployment.</li>
</ul>
<ul>
<li><strong>Scale</strong></li>
</ul>
<p>Once published, the API needs to be scaled to handle increased demand. The Scale phase includes:</p>
<ul>
<li>Worldwide availability: Deploy APIs globally to ensure availability.</li>
<li>Multi-region deployments: Distribute APIs across multiple regions for redundancy and performance.</li>
<li>Availability zones: Utilize availability zones to increase reliability.</li>
<li>Caching: Implement caching to improve performance.</li>
<li>Auto-scaling: Automatically adjust resources based on demand.</li>
<li>Hybrid and multi-cloud: Deploy APIs in hybrid and multi-cloud environments.</li>
<li>Azure Arc enabled: Manage and govern APIs across different environments using Azure Arc.</li>
</ul>
<ul>
<li><strong>Monitor</strong></li>
</ul>
<p>The API must be monitored after scaling to ensure it operates correctly. The Monitor phase involves:</p>
<ul>
<li>Azure Monitor: Use Azure Monitor to track and analyze API performance.</li>
<li>Application Insights: Gain insights into application performance and user behavior.</li>
<li>Logs | Metrics | Traces | Alerts: Collect and analyze logs, metrics, and traces and set up alerts.</li>
<li>Configurable verbosity: Adjust the level of detail in logs and metrics.</li>
<li>E2E request tracing: Trace requests end-to-end to diagnose issues.</li>
<li>Local telemetry for self-hosted gateway: Collect telemetry data from self-hosted API gateways.</li>
</ul>
<ul>
<li><strong>Analyze</strong></li>
</ul>
<p>Finally, in the Analyze phase, the collected data is used to gain insights and improve the API. This stage includes:</p>
<ul>
<li>Built-in reports: Use built-in reports for quick insights.</li>
<li>Custom reports with Log Analytics: Create custom reports using Log Analytics.</li>
<li>Reports in Power BI: Visualize data and generate reports using Power BI.</li>
<li>Custom telemetry pipelines: Set up custom telemetry pipelines for advanced analysis.</li>
</ul>
<p>This lifecycle ensures that APIs are well-designed, developed, secured, published, scaled, monitored, and analyzed, providing a comprehensive approach to API management.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-design">🎨 Design<a href="https://luke.geek.nz/azure/api-management-overview/#-design" class="hash-link" aria-label="Direct link to 🎨 Design" title="Direct link to 🎨 Design">​</a></h3>
<p><img decoding="async" loading="lazy" alt="API Lifecycle - Design" src="https://luke.geek.nz/assets/images/apim_apilifecyle_design-54ff90660862827afb8ef8a7337fc86d.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Code-and design-first approaches to building APIs</p>
<p>API Management supports both approaches to building APIs:</p>
<ul>
<li>
<p><strong>Code-first approach</strong>
Implement the API and generate the API specification as an afterthought (i.e., with Swashbuckle). Benefits:
More convenient for API developers: The only option for existing APIs</p>
</li>
<li>
<p><strong>Design-first approach</strong>
Create an API specification, review it with stakeholders, and implement the API Kickstart development by scaffolding the code from the API specification.</p>
</li>
</ul>
<p>Benefits:</p>
<p>Better API consumer experience thanks to the deliberate API design Reduced risk thanks to the API review processes</p>
<p><img decoding="async" loading="lazy" alt="API Lifecycle - Develop" src="https://luke.geek.nz/assets/images/apim_apilifecyle_design_codefirst-aac369e9d29dc29ac251aabef2348ce8.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>You can create APIs</p>
<ul>
<li>Support for SOAP, REST, WebSocket and GraphQLAPIs</li>
<li>Import an API from OpenAPI(1, 2, or 3), WADL, or WSDL files</li>
<li>Import an API from App Service, Logic App, Function App, or Container App</li>
<li>Create a blank API</li>
</ul>
<p><img decoding="async" loading="lazy" alt="API Management - Create an API" src="https://luke.geek.nz/assets/images/apim_apilifecyle_design_createAPI-977bd9f958be9031251fc22ff3b217ee.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>So, let us create a new API by importing the <a href="https://swapi.dev/" target="_blank" rel="noopener noreferrer">Star Wars API</a>.</p>
<ol>
<li>Open your Azure API Management instance</li>
<li>Navigate to APIs</li>
<li>Click on + Add API</li>
<li>Click on HTTP (manually define an HTTP API)</li>
<li>Select Full</li>
<li>Fill in the details:<!-- -->
<ul>
<li>Display name: Star Wars</li>
<li>Name: star-wars</li>
<li>Description: Star Wars API</li>
<li>Web service URL: <a href="https://swapi.dev/api" target="_blank" rel="noopener noreferrer">https://swapi.dev/api</a></li>
<li>API URL suffix: starwars</li>
</ul>
</li>
<li>Click Create
Now that we have imported our initial API endpoint, we can start defining the operations we want to expose.</li>
<li>Click on + Add operation</li>
<li>Fill in the details:<!-- -->
<ul>
<li>Display name: Get People</li>
<li>Name: get-people</li>
<li>URL template: /people</li>
<li>HTTP verb: GET
Now, let's add another operation to get information about Starships in the Star Wars universe. Fill in the details:</li>
<li>Display name: Get Starships</li>
<li>Name: get-starships</li>
<li>URL template: /starships</li>
<li>HTTP verb: GET</li>
</ul>
</li>
</ol>
<p>Now let us test it.</p>
<ol>
<li>Click on Get Starships API operation</li>
<li>Click on test</li>
<li>Click + Add parameter</li>
<li>Type in Search in the name and the value as 'Star Destroyer'</li>
<li>Click Send</li>
</ol>
<p><img decoding="async" loading="lazy" alt="API Management - Add Star Wars API" src="https://luke.geek.nz/assets/images/apim-add-starwars-api-8768b3f40bbb8bf0827b19e951ed6320.gif" width="1901" height="885" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>You can use a wildcard in the URL path if you are not sure of an accurate specification while you work on the API design.</p><p><img decoding="async" loading="lazy" alt="API Management - wildcard" src="https://luke.geek.nz/assets/images/apim_apilifecyle_design_wildcardproxy-c75b189db9307fd2a601fbce2ffd3e06.PNG" width="4000" height="2250" class="img_ev3q"></p></div></div>
<p>Now that we have imported and tested an existing API, let's consider designing a new one.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Design a API" src="https://luke.geek.nz/assets/images/apim_apilifecyle_design_designaapi-a8683536c660e8a0c0c94ca27a4a3df5.png" width="4000" height="2250" class="img_ev3q"></p>
<p>Azure offers powerful resources to streamline and enhance our workflow.</p>
<p>Defining the API:</p>
<p>First, let's talk about defining our API. Azure provides two main approaches:</p>
<p>Form-Based Editors:</p>
<p>These editors are highly intuitive, offering a user-friendly interface to input all necessary details about your API.
Perfect for those who prefer a guided, step-by-step setup.</p>
<p>Text-Based Editors:</p>
<p>For those more comfortable with coding, Azure allows us to edit the API definition directly in JSON format.
This method offers greater flexibility and control over the API specifications.</p>
<p>Visual Studio Code Extension:</p>
<p>In addition to the Azure portal, you can also leverage the Visual Studio Code extension. This extension integrates seamlessly with Azure, allowing you to manage and define your APIs directly within your development environment. It's an excellent tool for developers who prefer to work locally.</p>
<p>Testing the API:</p>
<p>Once the API is defined, the next crucial step is testing. Azure simplifies this process in several ways:</p>
<p>Azure Portal Testing:
You can test your API directly within the Azure portal. This feature lets you ensure everything functions correctly without switching between multiple tools.
Schema Generation:
Azure can generate schemas from your API responses. These schemas provide a clear structure of your API's data, ensuring that both developers and consumers understand the expected input and output formats.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Mock API" src="https://luke.geek.nz/assets/images/apim_apilifecyle_design_mockapi-b84e58f8c6ec4e7661ed0a65692f0946.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Adopting a design-first approach can significantly enhance efficiency and collaboration. One technique we can utilize is mocking the API. Let's explore how this approach can benefit our development workflow.</p>
<p>Design-First Approach - Mock the API:</p>
<ol>
<li>Unblock Front-End Teams:</li>
</ol>
<p>Mocking API responses is a game-changer for front-end developers.
Providing predefined responses enables front-end teams to continue their development work without waiting for the back-end to be fully implemented.
This leads to parallel development, reducing bottlenecks and speeding up the overall project timeline.</p>
<ol start="2">
<li>Use an Example Defined in the API Definition:</li>
</ol>
<p>The process starts with defining an example response within the API definition.
This predefined response acts as a placeholder, simulating the actual API behavior.
It ensures that front-end teams have consistent and reliable data to work with during the early stages of development.
3. Configure with a Single-Line Policy:</p>
<p>One of Azure API Management's standout features is the ability to configure mocking with a simple, single-line policy.</p>
<p>As shown in the example on the image, the policy can be written as:</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">inbound</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">base</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">mock-response</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">status-code</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">200</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">content-type</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">application/json</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">inbound</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="APIM - Mock Design" src="https://luke.geek.nz/assets/images/apim_apilifecyle_design_apimock-9020b782711066d24856bf651e1cb633.gif" width="1901" height="885" class="img_ev3q"></p>
<p>This configuration tells the API to return a mock response with a status code of 200 and a content type of application/json.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Websocket" src="https://luke.geek.nz/assets/images/apim_apilifecyle_design_websocket-7eeea69c929249bae19d4bab29f78273.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p><a href="https://learn.microsoft.com/azure/api-management/websocket-api?tabs=portal&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">WebSocket API</a> support enables real-time communication, making our APIs more dynamic and responsive.</p>
<p><a href="https://learn.microsoft.com/azure/api-management/websocket-api?tabs=portal&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">WebSocket API</a> support in Azure API Management opens up a whole new realm of possibilities for real-time applications. Let's delve into what this entails and how it can benefit our API infrastructure.</p>
<p>Passthrough Support for WebSocket APIs:</p>
<ol>
<li>Establishing Connections:</li>
</ol>
<p>Client applications can establish WebSocket connections directly with API Management (APIM).
This setup allows for continuous, two-way communication between clients and backend services.
Once the connection is established, APIM seamlessly proxies WebSocket messages to the backend services, ensuring smooth and reliable communication.</p>
<ol start="2">
<li>Features of WebSocket API Support:</li>
</ol>
<p>CRUD Operations:</p>
<p>With WebSocket API support, we can perform Create, Read, Update, and Delete (CRUD) operations on WebSocket APIs.
This flexibility ensures that our APIs can handle various real-time data interactions effectively.</p>
<p>Apply Policies:</p>
<p>We can apply policies to handshake requests, which is crucial for managing security, authentication, and other operational requirements.
These policies ensure that only authorized and legitimate requests can establish WebSocket connections.
Browse and Test:</p>
<p>WebSocket APIs can be easily browsed and tested within the Azure and Developer portals.
This capability allows developers to interact with and validate the WebSocket APIs during the design and development phases.</p>
<p>Monitoring and Logging:</p>
<p>Azure Monitor provides metrics and logs specifically for WebSocket APIs.
These monitoring tools enable us to track performance, detect issues, and gain insights into the usage patterns of our WebSocket connections.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="️-develop">🛠️ Develop<a href="https://luke.geek.nz/azure/api-management-overview/#%EF%B8%8F-develop" class="hash-link" aria-label="Direct link to 🛠️ Develop" title="Direct link to 🛠️ Develop">​</a></h3>
<p><img decoding="async" loading="lazy" alt="API Lifecycle - Develop" src="https://luke.geek.nz/assets/images/apim_apilifecyle_develop-40d0a11c0c3d20462c3787e679224373.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Azure API Management offers a range of features to streamline the development process and enhance the functionality of our APIs.</p>
<p><img decoding="async" loading="lazy" alt="APIM - API Challenges" src="https://luke.geek.nz/assets/images/apim_apilifecyle_develop_apichallenges-54766c74b68d018aaf589566b240e6c0.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>APIs are the backbone of modern digital ecosystems, enabling connected experiences across various devices and services. However, managing these APIs efficiently comes with its own set of challenges. API management provides a structured approach to streamlining the API lifecycle.</p>
<ol>
<li>Consume:</li>
</ol>
<p><em>(Developer Portal)</em></p>
<p>The first pillar of API management is the Developer Portal.
This portal is a crucial interface where developers can discover, understand, and consume APIs.
It provides comprehensive documentation, code samples, and testing tools, making it easier for developers to integrate APIs into their applications.
The Developer Portal offers a centralized hub for API information, enhancing developer productivity and reducing the time to market for new applications.</p>
<ol start="2">
<li>Mediate:</li>
</ol>
<p><em>(Gateway)</em></p>
<p>The gateway is at the heart of API management. It mediates the communication between client applications and backend services.
The Gateway ensures secure, reliable, and efficient API traffic management.
It provides various capabilities, such as load balancing, rate limiting, and security enforcement.
By mediating API requests, the Gateway helps scale applications, protect against malicious attacks, and ensure consistent performance.</p>
<ol start="3">
<li>Publish:</li>
</ol>
<p><em>(Azure Portal)</em></p>
<p>The third pillar is the Azure Portal, where APIs are published and managed.
This portal allows API providers to define and publish their APIs, making them available to developers.</p>
<p>It offers tools for monitoring API usage, setting up policies, and managing API versions.
API providers can ensure their APIs are robust, secure, and up-to-date through the Azure Portal.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Product" src="https://luke.geek.nz/assets/images/apim_apilifecyle_develop_apichallengesproduct-0c1b5041e09b1ec6aeb15e30b50fadc1.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>APIs are essential for modern digital ecosystems, but managing them efficiently can be complex. API management provides a unified approach to streamlining product interaction and backend services.</p>
<p>Products:</p>
<ul>
<li>Diverse Product Integration:</li>
</ul>
<p>We have multiple products (Products 1 to 5) at the top. Each product has unique functionalities and API requirements.
These products represent different applications and services that need to communicate with various backend systems.</p>
<p>API Management Layer:</p>
<ul>
<li>Centralized Management:</li>
</ul>
<p>The middle section represents the API Management layer, a crucial component in this architecture.
API Management acts as a mediator, facilitating seamless communication between the products and the backend services.
It standardizes API interactions, ensuring consistency, security, and reliability.</p>
<ul>
<li>Backend Systems:</li>
</ul>
<p>Backend on Azure and On-premises:
At the bottom, we see the backend systems, categorized into Azure-based and on-premises backends.
Azure backends include services such as Azure Functions, Virtual Machines, and Logic Apps.
On-premises backends consist of traditional servers and databases.
API Management ensures that products seamlessly interact with cloud-based and on-premises backend systems.
Critical Benefits of API Management:</p>
<ul>
<li>Unified API Gateway:</li>
</ul>
<p>Provides a single entry point for all API requests, simplifying the management of APIs across multiple products and services.
Enhanced Security:</p>
<p>Authentication, authorization, and rate-limiting policies ensure secure communication between products and backend systems.</p>
<ul>
<li>Scalability:</li>
</ul>
<p>Handles large volumes of API traffic, enabling applications to scale efficiently.</p>
<ul>
<li>Monitoring and Analytics:</li>
</ul>
<p>Offers insights into API usage, performance metrics, and error tracking, helping in proactive management and optimization.
Developer Empowerment:</p>
<p>Facilitates a developer-friendly environment with comprehensive documentation, testing tools, and self-service capabilities.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Cross Domain policies" src="https://luke.geek.nz/assets/images/apim_apilifecyle_design_crossdomainpolicy-dee621e36fc6a851c601b6f649becdea.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Policy Scopes</p>
<p><img decoding="async" loading="lazy" alt="APIM - Policy Scopes" src="https://luke.geek.nz/assets/images/apim_apilifecyle_design_policyscopes-798c598ad09cebfb296141546877fe55.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Let's examine the policy scopes. Understanding the scope is crucial to applying the right policy in the right place. Policies are inherited from the parent scope to the child scope.</p>
<p>So let us go through them.</p>
<ul>
<li>Global <em>(Red Border)</em></li>
</ul>
<p>Description: Global policies apply to all requests and responses passing through the API Management instance. They are the outermost scope, impacting every operation, API, and product.
Usage: Commonly used for policies like CORS <em>(Cross-Origin Resource Sharing)</em> and logging, which should be consistent across the entire API Management instance.</p>
<ul>
<li>Workspace <em>(Yellow Border)</em></li>
</ul>
<p>Description: This scope is associated with a workspace, which groups related APIs and other components within API Management.
Usage: Policies defined at this level are used when consistent policy enforcement is needed across multiple APIs belonging to the same workspace.</p>
<ul>
<li>Product <em>(Green Border)</em></li>
</ul>
<p>Description: Product-level policies apply to all APIs included within a specific product. Products are a way to bundle APIs together for subscription and access management.
Usage: Common for setting rate limits and quotas that apply to all APIs in the product, helping to manage usage and prevent abuse.</p>
<ul>
<li>API <em>(Blue Border)</em></li>
</ul>
<p>Description: API-level policies apply to all operations within a specific API. This scope allows for API-wide behavior customization.
Usage: Often used for API-specific security measures like JWT (JSON Web Token) validation or other API-wide configurations.</p>
<ul>
<li>Operation <em>(Purple Border)</em></li>
</ul>
<p>Description: Operation-level policies are the most granular and apply to a specific operation within an API <em>(e.g., a single endpoint or method)</em>.
Usage: Useful for operation-specific requirements like caching, URL rewriting, or request/response transformation.</p>
<ul>
<li>Inbound and Outbound policies</li>
</ul>
<p>Inbound policies are applied as the request comes in from the caller, and outbound policies are applied as the response is sent back to the caller after being processed by the backend.</p>
<p>Each of these scopes allows for different levels of customization and control over how requests and responses are handled within Azure API Management.</p>
<p>If we take a look at the <a href="https://learn.microsoft.com/azure/api-management/api-management-howto-properties?tabs=azure-portal&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">policy named values</a> and <a href="https://learn.microsoft.com/azure/api-management/api-management-policy-expressions?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">expressions</a>.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Policy Values" src="https://luke.geek.nz/assets/images/apim_apilifecyle_design_policysvalues-a699bb0fcc072978e1873e5c20effd9d.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>We can see that Named Values are a powerful feature in Azure API Management that allows us to define reusable variables and secrets that can be used across policies.</p>
<blockquote>
<p>Policies are a collection of statements that are executed sequentially on the request or response of an API. Policy statements can be constructed using literal text values, policy expressions, and named values.</p>
</blockquote>
<p>Named values are a global collection of name/value pairs in each API Management instance. There is no imposed limit on the number of items in the collection. Named values can be used to manage constant string values and secrets across all API configurations and policies.</p>
<p>Lets take a look at some out of the box policies</p>
<p><img decoding="async" loading="lazy" alt="APIM - Out of the box policies" src="https://luke.geek.nz/assets/images/apim_apilifecyle_design_outoftheboxpolicies-5282f68c21386cddf8904f61e5df4f1e.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Azure API Management includes, "Out of the box policies" provides the majority of use cases that that can be implemented to manage access, transform data, advance functionalities, integrate with Dapr, authenticate users, cache data, manage cross-domain calls, and validate information.</p>
<p>Let us delve into each category to understand the capabilities these policies offer.</p>
<ul>
<li><strong>Access Restriction</strong></li>
</ul>
<p>Access restriction policies are crucial for controlling who can access your services and how often. These policies include:</p>
<p>Check HTTP header: Validates headers in HTTP requests.
Limit call rate by subscription/key: Controls the rate of API calls based on the subscription or key.
Restrict caller IPs: Allows access only from specified IP addresses.
Set usage quota by subscription/key: Limits the usage based on subscription or key.
Validate client certificate: Ensures the authenticity of the client via certificates.
Validate JWT (JSON Web Token): Verifies the token to ensure secure access.</p>
<ul>
<li><strong>Transformation</strong></li>
</ul>
<p>Transformation policies handle the modification and conversion of data formats and content. These policies include:</p>
<p>Convert JSON to XML / XML to JSON: Transforms data between JSON and XML formats.
Find and replace string in body: Replaces specific strings in the request or response body.
Mask URLs in content: Hides sensitive URLs within the content.
Set backend service/body/HTTP header/query string parameter: Customizes backend service configurations and request parameters.
Rewrite URL: Modifies the URL of incoming requests.
Transform XML using XSLT: Applies XSLT to transform XML data.</p>
<ul>
<li><strong>Advanced</strong></li>
</ul>
<p>Advanced policies provide extended functionalities for handling requests and responses. These include:</p>
<p>Send one-way request / request: Facilitates sending HTTP requests.
Set HTTP proxy / request method / status code / variable: Configures proxy, method, status code, and variables.
Control flow / Emit metric: Manages the flow of requests and emits metrics.
Log to Event Hub / Trace: Logs events and traces for monitoring.
Mock response / Forward request: Creates mock responses or forwards requests.
Limit concurrency / Return response / Retry / Wait: Manages concurrency, responses, and retry mechanisms.</p>
<ul>
<li><strong>Dapr Integration</strong></li>
</ul>
<p>Dapr (Distributed Application Runtime) integration policies enable communication with Dapr services:</p>
<p>Send request to a service / message to a pub/subtopic: Facilitates interaction with Dapr services and pub/subtopics.
Trigger output binding: Initiates output bindings in Dapr.</p>
<ul>
<li><strong>Authentication</strong></li>
</ul>
<p>Authentication policies ensure that only authorized users can access your services:</p>
<p>Authenticate with basic / client certificate / managed identity: Supports various authentication methods to verify user identity.</p>
<ul>
<li><strong>Caching</strong></li>
</ul>
<p>Caching policies improve performance by storing and retrieving data from the cache:</p>
<p>Store to cache / Get value from cache / Store value from cache / Remove value from cache: Manages caching operations to optimize data retrieval.</p>
<ul>
<li><strong>Cross Domain</strong>
Cross-domain policies handle calls across different domains:</li>
</ul>
<p>CORS / JSON: Manages cross-origin resource sharing and JSON data handling.</p>
<ul>
<li><strong>Validation Policies</strong></li>
</ul>
<p>Validation policies ensure the integrity and correctness of data:</p>
<p>Validate content/parameters/headers/status code / GraphQL request: Check the validity of content, parameters, headers, status codes, and GraphQL requests.</p>
<p>An example of policies that are useful is <strong>Request Forwarding</strong>:</p>
<p><img decoding="async" loading="lazy" alt="APIM - Policy Example" src="https://luke.geek.nz/assets/images/apim_apilifecyle_design_outoftheboxpolicies_RequestForwarding-16185468fc02efa145d2c8fe3fdb3017.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>This policy is usually inherited from the global scope via the </p><base> tag. If no specific policy is set, it defaults to the base configuration.
Timeout Settings: The forwarding timeout can be configured between 30 seconds to 10 minutes, with the default being 5 minutes.
Redirect Handling: It can be configured to follow redirects or, by default, return them to the caller.<p></p>
<ul>
<li>You can configure Retry (<retry></retry>)</li>
</ul>
<p>Triggering Conditions: Retry is triggered when a specified expression evaluates to true.
Backoff Intervals: Offers options for fixed, linear, or exponential backoff intervals.
Fast First Retry: An optional feature for a quick retry attempt.
Request Copy: Does not retain a copy of the request automatically, ensuring efficient resource utilization.</p>
<ul>
<li>Limit Concurrency (<limit-concurrency></limit-concurrency>)</li>
</ul>
<p>Concurrency Cap: Caps the number of concurrent requests forwarded to the backend to prevent overloading.
Policy Integration: Can be used in conjunction with other policies to limit the number of requests entering enclosed policies.
Set Backend Service (<set-backend-service></set-backend-service>)</p>
<p>Runtime Changes: Allows changing the backend service during runtime, providing flexibility in managing backend services.
Conditional Policies: Can be configured with conditional policies for blue/green deployment, ensuring smooth transitions and updates.</p>
<p>and Authentication (<authentication></authentication>)</p>
<p><img decoding="async" loading="lazy" alt="APIM - Authentication policy" src="https://luke.geek.nz/assets/images/apim_apilifecyle_design_outoftheboxpolicies_Authentication-c478c63564154abbcde4d4cae67ce3a3.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Such as:</p>
<ul>
<li>validate-jwt</li>
</ul>
<p>Purpose: Validates JSON Web Tokens (JWTs).
Supported Standards:</p>
<ul>
<li>
<p>JWS (JSON Web Signature)</p>
</li>
<li>
<p>JWE (JSON Web Encryption)</p>
</li>
<li>
<p>RSA256 and HS256 algorithms</p>
</li>
<li>
<p>OpenID Configuration: Supports OpenID Configuration endpoints for validation.</p>
</li>
<li>
<p>Claims Validation: Can check specific claims within the JWT.</p>
</li>
<li>
<p>Scope: Can be configured at any policy scope, offering flexibility in where it is applied.</p>
</li>
<li>
<p>validate-client-certificate</p>
</li>
</ul>
<p>Purpose: Enforces that a certificate presented by a client matches the specified validation rules and claims.
Key Attributes:</p>
<ul>
<li>validate-revocation="true": Ensures the certificate has not been revoked.</li>
<li>validate-trust="true": Checks that the certificate is trusted.</li>
<li>validate-not-before="true": Ensures the certificate is not used before a certain date.</li>
<li>validate-not-after="true": Ensures the certificate is not used after a certain date.</li>
<li>ignore-error="false": Indicates whether errors should be ignored.</li>
</ul>
<p>Identities Section:</p>
<p>Contains one or more identity elements.</p>
<ul>
<li>Each identity element includes a thumbprint attribute, identifying the specific certificate by its thumbprint.</li>
</ul>
<p>Let us take a look at the <a href="https://marketplace.visualstudio.com/items?itemName=ms-azuretools.vscode-apimanagement" target="_blank" rel="noopener noreferrer">Azure API Management Visual Studio Code extension</a>.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Visual Studio Code" src="https://luke.geek.nz/assets/images/apim_apilifecyle_design_vscodeextension-6c9faef973d2df0e2a4218ac00c0c4ba.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>The Azure API Management Visual Studio Code extension provides a seamless experience for managing APIs directly from your development environment.</p>
<p><img decoding="async" loading="lazy" alt="VSCode Visual Studio Extension" src="https://luke.geek.nz/assets/images/VSCode_APIMExtension-158b8751c63a5dfe40d6dfbdbe4428df.gif" width="1876" height="992" class="img_ev3q"></p>
<p>The extension allows us to test and edit APIs directly from Visual Studio Code and push those changes straight to Azure API Management, streamlining the development process and enhancing productivity.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Visual Studio Code - Test APIs" src="https://luke.geek.nz/assets/images/apim_apilifecyle_design_vscodeextensiontest-8bb4910ae743ac6f40b54e8b0d903db5.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Let us take a look at some of the Deployment Options for Azure API Management.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Deployment Options" src="https://luke.geek.nz/assets/images/apim_apilifecyle_design_deploymentoptions-a51ad19bab22e3d6c31a9312e9b1b814.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Azure API Management is an ARM (Azure Resource Manager) resource and can be deployed using <a href="https://learn.microsoft.com/azure/azure-resource-manager/templates/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">ARM templates</a>, <a href="https://learn.microsoft.com/azure/azure-resource-manager/bicep/overview?tabs=bicep&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Bicep</a>, or <a href="https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs" target="_blank" rel="noopener noreferrer">Terraform</a>.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>It is worth noting that Azure API Management has a <a href="https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/scenarios/app-platform/api-management/landing-zone-accelerator?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Landing Zone Accelerator</a>, which is a set of pre-built configurations and best practices for deploying Azure API Management in a secure and compliant manner.</p><p><img decoding="async" loading="lazy" alt="APIM - Landing Zone Accelerator" src="https://luke.geek.nz/assets/images/apim_reference-implementation-59035bb0917552fdf01ea63f2b3529b9.png" width="1233" height="675" class="img_ev3q"></p></div></div>
<p><a href="https://azure.github.io/apiops/" target="_blank" rel="noopener noreferrer">APIOps</a> is a set of practices and tools that help organizations manage the full lifecycle of APIs, from design to deprecation. It combines the principles of DevOps with API management to streamline API development and deployment.</p>
<p><img decoding="async" loading="lazy" alt="APIOps" src="https://luke.geek.nz/assets/images/apim_apilifecyle_publish_APIOps-35ac2c2bbfd02a0746c79ba1ce9bcfab.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="APIOps" src="https://luke.geek.nz/assets/images/ApiOps-ba714e5dbf5a703e46c7826affab267c.gif" width="1280" height="720" class="img_ev3q"></p>
<p>APIOps can be used to automate API management tasks, improve collaboration between development and operations teams, and ensure consistency and quality across APIs, and API Management environments, such as Development, Testing and Production.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-secure">🔒 Secure<a href="https://luke.geek.nz/azure/api-management-overview/#-secure" class="hash-link" aria-label="Direct link to 🔒 Secure" title="Direct link to 🔒 Secure">​</a></h3>
<p><img decoding="async" loading="lazy" alt="API Lifecycle - Secure" src="https://luke.geek.nz/assets/images/apim_apilifecyle_secure-cebce17d19a653c3e13d5626181e07fb.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Security is a critical aspect of API management, ensuring that APIs are protected from unauthorized access, data breaches, and other security threats. Azure API Management offers a range of security features to safeguard APIs and ensure compliance with industry standards.</p>
<p>The <a href="https://owasp.org/" target="_blank" rel="noopener noreferrer">Open Web Application Security Project (OWASP)</a> has identified the top 10 critical API security risks for 2023</p>
<p><img decoding="async" loading="lazy" alt="APIM - Security" src="https://luke.geek.nz/assets/images/apim_apilifecyle_secure_OWASP-852e95d7cdf827aa49b1b515ba81ab78.PNG" width="4000" height="2250" class="img_ev3q"></p>
<table><thead><tr><th><strong>#</strong></th><th><strong>Threat</strong></th><th><strong>Description</strong></th><th><strong>Mitigation</strong></th></tr></thead><tbody><tr><td>1</td><td>Broken Object Level Authorization</td><td>Unauthorized access to objects.</td><td>Implement key/token/certificate-based authentication and request transformation. Policy-based Access Control: Use policies to enforce authorization rules. OAuth2/JWT: Integrate with Entra ID for token validation.</td></tr><tr><td>2</td><td>Broken Authentication</td><td>Weak authentication mechanisms.</td><td>Use strong key/token-based authentication methods and transform requests appropriately. Authentication Policies: Enforce authentication using OAuth2, OpenID Connect, certificates, and API keys.</td></tr><tr><td>3</td><td>Broken Object Property Level Authorization</td><td>Unauthorized access to object properties.</td><td>Filter or mask sensitive data and ensure both request and response validations. Data Masking: Use policies to mask sensitive data. Validation: Validate input to ensure only authorized properties are accessed.</td></tr><tr><td>4</td><td>Unrestricted Resource Consumption</td><td>Overuse of resources leads to service denial.</td><td>Apply throttling and quota limits and manage backend concurrency effectively. Rate Limiting and Quotas: Use policies to set rate limits and quotas. Caching: Reduce load by caching responses.</td></tr><tr><td>5</td><td>Broken Function Level Authorization</td><td>Unauthorized access to functions.</td><td>Enforce key/token-based and custom authorizations. Role-Based Access Control (RBAC): Use Azure RBAC to control access to different API operations. Request Validation: Validate incoming requests to ensure they don't contain malicious URLs. Network Security: Use VNETs and NSGs to control outbound traffic.</td></tr><tr><td>Configuration Management: Use Azure Policy and deployment stacks to enforce security configurations. Automated Deployments: Use CI/CD pipelines to ensure consistent and secure deployments.</td><td></td><td></td><td></td></tr><tr><td>6</td><td>Unrestricted Access to Sensitive Business Flows</td><td>Uncontrolled access to critical business operations.</td><td>Validate all requests and responses meticulously. Custom Policies: Implement custom policies to validate requests and responses, ensuring sensitive operations are protected.</td></tr><tr><td>7</td><td>Server-Side Request Forgery (SSRF)</td><td>Attackers tricking the server into making requests to unintended locations.</td><td>Validate remote resources and user-supplied URIs and ensure response validation.</td></tr><tr><td>8</td><td>Security Misconfiguration</td><td>Incorrectly configured API settings.</td><td>Maintain an up-to-date API catalog and manage the API lifecycle rigorously.</td></tr><tr><td>9</td><td>Improper Inventory Management</td><td>Exposing more endpoints than necessary.</td><td>Regularly update and document your API endpoints to manage exposure effectively. API Versioning: Implement API versioning to manage the exposure of endpoints. Documentation: Keep API documentation updated and use tools like Swagger or OpenAPI.</td></tr><tr><td>10</td><td>Insufficient Logging and Monitoring</td><td>Lack of proper logging and monitoring mechanisms.</td><td>Ensure comprehensive and updated documentation and maintain robust logging and monitoring practices. Azure Monitor and Application Insights: Integrate with these services for comprehensive logging and monitoring. Alerts: Set up alerts for unusual activities.</td></tr><tr><td></td><td></td><td></td><td></td></tr></tbody></table>
<p>Azure API Management provides a range of security features to protect APIs from these threats.</p>
<p>Let us take a look at securing the different planes of Azure API Management.</p>
<p><img decoding="async" loading="lazy" alt="APIM - APIM Planes" src="https://luke.geek.nz/assets/images/apim_apilifecyle_secure_planes-0ea6cbc8bcb55e476bb51c8bc191abeb.PNG" width="4000" height="2250" class="img_ev3q"></p>
<table><thead><tr><th>Plane Name</th><th>Used For</th></tr></thead><tbody><tr><td>User Plane</td><td>Securing user interactions and data at the entry point.</td></tr><tr><td>Management Plane</td><td>Managing and securing interactions between API providers and the management system.</td></tr><tr><td>Data Plane</td><td>Securing the flow and integrity of data between the gateway and backend services.</td></tr></tbody></table>
<p><img decoding="async" loading="lazy" alt="APIM - Data Plane" src="https://luke.geek.nz/assets/images/apim_apilifecyle_secure_dataplanes-eb2b2e6da5490011cb00516c8d2bf4fd.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>In today's interconnected digital landscape, securing backend APIs is paramount. One key strategy for achieving this is through robust data plane security. This layered defense mechanism protects sensitive data and applications from unauthorized access and malicious attacks. Let's delve deeper into how data plane security works and the roles of its components.</p>
<p><strong>Firewall: Blocking Suspicious Requests</strong></p>
<p>The first line of defense in data plane security is the firewall. It acts as a gatekeeper, scrutinizing incoming requests to block any that appear suspicious. The firewall employs several rule sets and mechanisms to identify and mitigate potential threats:</p>
<ul>
<li>OWASP Core Rule Sets: These are standardized rules for detecting common web application security risks.</li>
<li>Bot Protection Rule Set: This helps in identifying and blocking automated bot traffic that could pose security risks.</li>
<li>Custom Rules: Organizations can define their own rules tailored to their specific security requirements.</li>
</ul>
<p><strong>Gateway: Authenticating and Authorizing Requests</strong></p>
<p>Once a request passes through the firewall, it reaches the gateway. The gateway is responsible for performing in-depth request authentication and authorization to ensure only valid requests proceed. Key functions of the gateway include:</p>
<ul>
<li>Authentication Mechanisms: OAuth 2, client certificates, and custom authentication methods.</li>
<li>Authorization Mechanisms: Including IP filtering and custom authorization rules.</li>
<li>Request/Response Validation: Ensuring that both incoming requests and outgoing responses meet predefined security criteria.</li>
<li>Throttling: Managing the rate of incoming requests to prevent denial-of-service (DoS) attacks.</li>
</ul>
<p><strong>Backend APIs: Fine-Grained Authorization</strong></p>
<p>The final layer involves the backend APIs themselves, which must accept requests only from trusted sources. This layer applies fine-grained authorization to enforce strict access controls. Key security measures include:</p>
<ul>
<li>HTTP Basic (Shared Secret): Simple but effective method for authenticating requests.</li>
<li>Mutual Certificates: Ensuring both client and server authenticate each other.</li>
<li>OAuth 2: Secure token-based authentication.</li>
<li>Managed Identity and IP Filtering: This involves restricting access based on IP addresses and managing identities to enforce security policies.</li>
<li>Private Networking: Isolating the APIs within a secure network environment.</li>
</ul>
<p><img decoding="async" loading="lazy" alt="APIM - Data Plane - Facade" src="https://luke.geek.nz/assets/images/apim_apilifecyle_secure_dataplanesfacafe-ec2c06831c35062b6f9f186e25827f6d.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="APIM - Data Plane - Keys" src="https://luke.geek.nz/assets/images/apim_apilifecyle_secure_dataplaneskeys-9777cedbe4e30ba09947149fa6408fe9.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="APIM - Data Plane - JWT" src="https://luke.geek.nz/assets/images/apim_apilifecyle_secure_dataplanejwt-555c0ba40ac5b90feb6fcd40120a2c23.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="APIM - Data Plane - Client certificates" src="https://luke.geek.nz/assets/images/apim_apilifecyle_secure_dataplaneclientcerts-4c8eaaeaa5fcd111bf7aa6322f9d5cfc.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="APIM - Data Plane - Throttling" src="https://luke.geek.nz/assets/images/apim_apilifecyle_secure_dataplanethrottling-050c154f6878ef96a54df966082ac87a.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="APIM - Data Plane - Sanitization" src="https://luke.geek.nz/assets/images/apim_apilifecyle_secure_dataplaneresponsesanitization-18068eacf98a67abccb32d21af05ef76.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="APIM - Data Plane - DDoS" src="https://luke.geek.nz/assets/images/apim_apilifecyle_secure_dataplanereddos-9b7e6f30c693a2fde8bf2a31c97ef510.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Let's take a look at the security considerations when networking.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Private Networking Security" src="https://luke.geek.nz/assets/images/apim_apilifecyle_secure_privatenetworking-9b7722a9ff678a4447ef50b7898dfa96.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Azure API Management has two networking options:</p>
<ul>
<li>Internal</li>
<li>External</li>
</ul>
<p>The <a href="https://learn.microsoft.com/azure/api-management/api-management-using-with-internal-vnet?tabs=stv2&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">internal</a> option is more secure, as it is not exposed to the public internet. It is ideal for scenarios where you want to restrict access to your APIs to only internal clients or services.
The <a href="https://learn.microsoft.com/azure/api-management/api-management-using-with-vnet?tabs=stv2&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">external</a> option is exposed to the public internet, making it accessible to a broader audience. This option suits scenarios where you want to provide public access to your APIs.</p>
<p><img decoding="async" loading="lazy" alt="APIM - External" src="https://luke.geek.nz/assets/images/apim_apilifecyle_secure_external-eea39bf0a2989265bea5284a96292daf.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="APIM - External" src="https://luke.geek.nz/assets/images/apim_apilifecyle_secure_internal-46a2eebec44ffb8c40d479d82334b34b.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>You can also use the best of both worlds by allowing Azure API Management in Internal mode to publish APIs to the Internet or external customers and using Azure Front Door or Azure Application Gateway to expose the APIs to the Internet.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Internal with WAF" src="https://luke.geek.nz/assets/images/apim_apilifecyle_secure_internalwaf-f13da5e00ddbbdc68805301204d404b4.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Deciding between using Azure API Management (APIM) in Internal or External mode depends on your specific requirements for security, accessibility, and network configuration. Here are some key considerations:</p>
<ul>
<li>Internal Mode</li>
</ul>
<p>Accessibility: The APIM endpoints are accessible only from within the Virtual Network (VNet) via an internal load balancer.
Security: This mode is more secure as it restricts access to the APIM endpoints to only those resources within the VNet.
Use Case: This is ideal for scenarios where you need to protect sensitive APIs and ensure that they are only accessible from within your organization’s network.</p>
<ul>
<li>External Mode</li>
</ul>
<p>Accessibility: The APIM endpoints are accessible from the public internet via an external load balancer.
Security: While still secure, this mode allows for broader access, including from the internet.
Use Case: Suitable for scenarios where you must expose APIs to external clients or partners.</p>
<p>Deciding between Internal and External modes depends on your specific requirements and use case. Consider your APIs' security, accessibility, and network configuration needs to determine the best mode for your scenario.</p>
<p>For example:</p>
<p>Security Requirements: Internal mode is preferable if your APIs handle sensitive data.
Accessibility Needs: If you need to provide access to external clients, external mode is the way to go.
Network Configuration: Consider your existing network setup and how APIM will integrate.</p>
<p><img decoding="async" loading="lazy" alt="APIM Compliance" src="https://luke.geek.nz/assets/images/apim_apilifecyle_secure_compliance-61bc71cb1f56cbd5a74479627c54648a.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Azure API Management meets Compliance requirements, such as:</p>
<ul>
<li>GDPR</li>
<li>HIPAA</li>
<li>ISO 27001 PCI</li>
</ul>
<p>More information on the compliance can be found here: <a href="https://learn.microsoft.com/azure/compliance/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure compliance documentation</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-publish">🚀 Publish<a href="https://luke.geek.nz/azure/api-management-overview/#-publish" class="hash-link" aria-label="Direct link to 🚀 Publish" title="Direct link to 🚀 Publish">​</a></h3>
<p><img decoding="async" loading="lazy" alt="API Lifecycle - Publish" src="https://luke.geek.nz/assets/images/apim_apilifecyle_publish-205798b51e663ddfade8f5f686f1c5d4.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Once an API is designed, developed, and secured, it is ready to be published. Azure API Management offers a range of features to help you publish and manage your APIs effectively.</p>
<p>One of those features is the Developer Portal.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Developer Portal" src="https://luke.geek.nz/assets/images/apim_apilifecyle_publish_DeveloperPortal-f85d911221a99a624cba998b951d2ebb.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>The Developer Portal in API Management <em>(APIM)</em> is a discovery and self-onboarding point for application developers. Here are the primary functions and features it offers:</p>
<ul>
<li>Discover APIs:
Developers can explore and find available APIs to integrate into their applications.</li>
<li>Learn How to Use Them:
The portal provides comprehensive documentation and tutorials to help developers understand how to use the APIs effectively.</li>
<li>Test Them Out with Interactive Console:
Developers can interactively test the APIs within the portal using a built-in console. This allows them to see how the APIs work and validate their functionality before integrating them into their applications.</li>
<li>Create and Manage Accounts:
Developers can create accounts on the portal, manage their profiles, and keep track of their API usage and subscriptions.</li>
<li>Request and Manage API Access:
The portal enables developers to request access to specific APIs and manage their access permissions, ensuring they have the appropriate level of access for their needs.</li>
<li>Analyze API Usage:
Developers can analyze their API usage data to monitor performance, identify trends, and optimize their application's interaction with the APIs.</li>
</ul>
<p>The Developer Portal is customizable, allowing organizations to tailor it to their needs and branding. It is a central hub for developers to discover, learn, and interact with APIs, streamlining the API consumption process and fostering collaboration between API providers and consumers.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Developer Portal" src="https://luke.geek.nz/assets/images/apim_apilifecyle_publish_DeveloperPortalcustomization-72463c4ebb9c44c60b2311c58b4e2799.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>You can also self-host the Developer Portal, whether in an App Service, a Virtual Machine, or a Kubernetes Cluster.</p>
<p>You can find the files here: <a href="https://github.com/Azure/api-management-developer-portal" target="_blank" rel="noopener noreferrer">Azure/api-management-developer-portal</a>.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Developer Portal" src="https://luke.geek.nz/assets/images/apim_apilifecyle_publish_DeveloperPortalselfhostedn-069f2ed78160a74b6322dd38a80f8e69.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="APIM - Developer Portal" src="https://luke.geek.nz/assets/images/apim_apilifecyle_publish_DeveloperPortaSwagger-decbc50ea2f117494ba14cc171919160.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Let us take a look at Revisions and Versions.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Revisions and Versions" src="https://luke.geek.nz/assets/images/apim_apilifecyle_publig_RevisionsVersions-99ac42aa3108180b3837524d8c3afda4.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Azure API Management provides the ability to manage <a href="https://learn.microsoft.com/azure/api-management/api-management-revisions?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">revisions</a> and <a href="https://learn.microsoft.com/azure/api-management/api-management-versions?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">versions</a> of APIs, allowing you to make changes and updates without affecting existing consumers.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Revisions and Versions" src="https://luke.geek.nz/assets/images/apim_apilifecyle_publig_RevisionsVersionscompare-8f91e2e2549e8680e224f91d4a824482.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="APIM - Revisions" src="https://luke.geek.nz/assets/images/apim_apilifecyle_publig_Revisions-891796e529b758dec142662a6fcee7fa.PNG" width="4000" height="2250" class="img_ev3q"></p>
<table><thead><tr><th>Scenario</th><th>Description</th><th>Benefits</th></tr></thead><tbody><tr><td>Non-Breaking Changes to Your API</td><td>Modifications that do not disrupt existing end-user functionality.</td><td>- Track and document changes systematically.</td></tr><tr><td></td><td></td><td>- Ensure a smooth transition for developers using the API.</td></tr><tr><td>Potential Roll-Back of Changes</td><td>Reverting to a previous stable state if new changes cause problems.</td><td>- Quickly revert to a stable state.</td></tr><tr><td></td><td></td><td>- Minimize downtime and maintain service reliability.</td></tr><tr><td>Communicating Changes to Your Developer Community</td><td>Keep your developer community informed about your changes.</td><td>- Provide detailed logs and documentation of changes.</td></tr><tr><td></td><td></td><td>- Help developers understand how updates might affect their applications and how to adapt to them.</td></tr></tbody></table>
<p><img decoding="async" loading="lazy" alt="APIM - Versions" src="https://luke.geek.nz/assets/images/apim_apilifecyle_publig_versions-99eadd57f18b471dbcc7a1dce2014886.PNG" width="4000" height="2250" class="img_ev3q"></p>
<table><thead><tr><th>Scenario</th><th>Description</th><th>Benefits</th></tr></thead><tbody><tr><td>Show relationship between APIs</td><td>Demonstrating how different versions of APIs are related</td><td>Helps developers understand the evolution and compatibility of APIs</td></tr><tr><td>Provide a predictable way to switch APIs</td><td>Giving developers a clear method to switch between different API versions</td><td>Reduces confusion and ensures smoother transitions between versions</td></tr><tr><td>Add breaking changes</td><td>Introducing changes that are not backward compatible</td><td>Allows for significant improvements and updates without disrupting users</td></tr><tr><td>Try out changes and solicit feedback</td><td>Testing new features or changes and gathering community feedback</td><td>Encourages community engagement and helps refine the API before release</td></tr></tbody></table>
<p>Let's look at the following flowchart to decide between revisions and versions.</p>
<!-- -->
<p><img decoding="async" loading="lazy" alt="APIM - Revisions and Versions" src="https://luke.geek.nz/assets/images/apim_apilifecyle_publig_RevisionsVersexample-0e5b4528d60d7818b41646da3edfc676.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Now that we have reviewed the Revisions and versions, let's examine <a href="https://learn.microsoft.com/azure/api-management/api-management-howto-add-products?tabs=azure-portal&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Products</a>.</p>
<blockquote>
<p>In Azure API Management, a product contains one or more APIs, a usage quota, and the terms of use. After a product is published, developers can subscribe to the product and begin to use the product's APIs.</p>
</blockquote>
<p>APIs <em>(Application Programming Interfaces)</em> enable seamless interaction between software applications. However, managing multiple APIs can be challenging. Bundling APIs with products has emerged as an effective strategy to streamline this process.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Products" src="https://luke.geek.nz/assets/images/apim_apilifecyle_publish_BundleAPIs-85ccffcc743bbdacf5b4ed9eb87dbf95.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>API bundling involves grouping multiple APIs into a single package or product. This approach simplifies developers' and organizations' management, subscription, and usage of APIs.</p>
<ul>
<li>
<p>Developer Portal
Browse Products: Developers can explore various API products available in the portal.
Subscribe to Products: Once a suitable product is identified, developers can subscribe to it.
Manage Subscriptions and Keys: The portal allows developers to manage their subscriptions and obtain the necessary API keys.</p>
</li>
<li>
<p>Management Plane
Manage Products and API Associations: Administrators can define and manage the associations between products and their respective APIs.
Define Product-Scoped Policies: Specific policies can be set for each product, ensuring controlled and secure access.
Approve and Manage Subscriptions: Administrators can approve subscription requests and manage existing subscriptions.
Collect and Analyze Usage Data: Usage data is collected and analyzed to monitor and optimize API performance.
Monetize Access: Administrators can monetize API access by setting pricing plans and usage limits.</p>
</li>
<li>
<p>Gateway
Authenticate API Requests: The gateway authenticates incoming API requests using the provided keys.
Execute Product-Scoped Policies: It ensures that the defined policies for each product are enforced during API execution.</p>
</li>
</ul>
<p><img decoding="async" loading="lazy" alt="APIM - Products" src="https://luke.geek.nz/assets/images/apim_apilifecyle_publish_APISubscriptions-1114aabf06a703c07c8428202397544b.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Understanding the relationships between users, groups, products, APIs, and subscriptions is crucial for efficient and effective management.</p>
<table><thead><tr><th>Entity</th><th>Relationships</th></tr></thead><tbody><tr><td><strong>User</strong></td><td>- Can have many Subscriptions</td></tr><tr><td></td><td>- Can belong to many Groups</td></tr><tr><td><strong>Group</strong></td><td>- Can contain many Users</td></tr><tr><td></td><td>- Can have many Subscriptions</td></tr><tr><td></td><td>- Built-in: Guest, Developer, Admin</td></tr><tr><td></td><td>- Custom: native or Entra ID</td></tr><tr><td><strong>Subscription</strong></td><td>- Each Subscription is related to one User or Group</td></tr><tr><td></td><td>- Can provide access to one Product</td></tr><tr><td><strong>Product</strong></td><td>- Can be part of many Subscriptions</td></tr><tr><td></td><td>- Can contain many APIs</td></tr><tr><td><strong>API</strong></td><td>- Each API is part of one Product</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-scale">📏 Scale<a href="https://luke.geek.nz/azure/api-management-overview/#-scale" class="hash-link" aria-label="Direct link to 📏 Scale" title="Direct link to 📏 Scale">​</a></h3>
<p><img decoding="async" loading="lazy" alt="API Lifecycle - Scale" src="https://luke.geek.nz/assets/images/apim_apilifecyle_scale-bf01c71d9390e9a22b78f911a885e31a.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Azure and the Azure API Management service have a significant <a href="https://azure.microsoft.com/en-au/explore/global-infrastructure/products-by-region?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">global footprint</a>, with 44+ public regions worldwide, 6 regions for US government use, and 4 regions in China, showcasing its extensive infrastructure and specialized services.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Scale" src="https://luke.geek.nz/assets/images/apim_apilifecyle_scale_GlobalPresence-adb8dcab06686cc7e9769fe85fb80887.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="APIM - Multi-region" src="https://luke.geek.nz/assets/images/apim_apilifecyle_scale_Multiregion-0e2e7c23dce94b1c00a01ce868718b69.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Azure API Management's multi-region deployment offers a robust solution for improving API reliability and reducing latency. Let's dive into the key features and benefits of this setup.
Improved Availability and Reduced Latency</p>
<p>One of the standout features of Azure API Management's multi-region deployment is the significantly improved availability of the data plane. You can expect minimal downtime with a Service Level Agreement (SLA) of 99.99% compared to the standard 99.95%. This increased reliability ensures that your APIs remain accessible to users worldwide, enhancing the overall user experience.</p>
<ul>
<li>Scalability Across Multiple Regions</li>
</ul>
<p>A single Premium instance of Azure API Management can be scaled across multiple regions. This flexibility allows you to deploy additional units into the primary or secondary regions based on your needs. However, regions and units come at an additional cost. This scalability ensures that your API infrastructure can grow alongside your business demands.</p>
<ul>
<li>Primary and Secondary Regions</li>
</ul>
<p>In a multi-region deployment, the primary region hosts all components, including the gateway, developer portal, management API, and developer portal API. If the primary region becomes unavailable, these components are inaccessible, highlighting the importance of a robust primary region setup.</p>
<p>On the other hand, secondary regions host only the gateway. These secondary gateways can operate on the last received configuration while the primary area is unavailable. They periodically try to reconnect and catch up, ensuring that API requests continue to be processed even during primary region outages.</p>
<ul>
<li>Global API Availability</li>
</ul>
<p>One of the most significant advantages of multi-region deployment is that all APIs are available in every region. Azure Traffic Manager plays a crucial role in routing requests to the closest available region in this setup. Using Traffic Manager’s performance routing with a 5-minute Time-to-Live (TTL), API requests are efficiently managed, reducing latency and improving response times for users worldwide.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Multi-Region Example" src="https://luke.geek.nz/assets/images/apim_apilifecyle_scale_MultiregionEExample-676cd55575626c8fc3d3a5ad58e06340.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Lets take a look at the nuances on the anatomy of an Azure API Management instance.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Anatomy" src="https://luke.geek.nz/assets/images/apim_apilifecyle_scale_AnatomyAPIM-c63666f907fc47e4c67abd2488e01422.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>An Azure API Management instance with 1 unit, represented by two machines (Machine #1 and Machine #2). Each machine has a set of components that work together to manage and secure APIs.</p>
<table><thead><tr><th>Machine</th><th>Component</th><th>Description</th></tr></thead><tbody><tr><td>Machine #1</td><td>Control-Plane</td><td>The administrative interface for configuring and managing APIs and policies.</td></tr><tr><td></td><td>Gateway</td><td>Handles API requests and applies rate limiting and authentication policies.</td></tr><tr><td></td><td>Developer Portal</td><td>Customizable portal for developers to discover, learn, and use APIs.</td></tr><tr><td>Machine #2</td><td>Control-Plane</td><td>Redundant administrative interface for high availability.</td></tr><tr><td></td><td>Gateway</td><td>Redundant API Gateway for load balancing and fault tolerance.</td></tr><tr><td></td><td>Developer Portal</td><td>Another instance of the Developer Portal to ensure high availability.</td></tr></tbody></table>
<p>This is a typical setup of an Azure API Management instance. It emphasizes redundancy and high availability by distributing core components (Control-Plane, Gateway, and Developer Portal) across multiple machines. This setup ensures the API management service remains operational even if one machine fails.</p>
<p>However, to ensure high availability and disaster recovery, one may want to expand the Azure API Management instance to another region.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Scale" src="https://luke.geek.nz/assets/images/apim_apilifecyle_scale_AnatomyAPIMSecondRegion-f223eb30d4dba49d7cb4bbf5d2d90e21.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>When you scale an Azure API Management instance to another region, you are essentially creating a secondary region deployment. This setup provides high availability and disaster recovery capabilities, ensuring your APIs remain accessible even during a regional outage by expanding the Gateway service. All Control planet traffic and the developer portal are still managed by the primary region, however your APIs will still function.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Availability Zones" src="https://luke.geek.nz/assets/images/apim_apilifecyle_scale_AvaliabilityZone-d4ef68e4c9fcf5423cf2c986990752fa.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>By deploying your APIM instance across two or more Availability Zones within a single region, you can achieve a Service Level Agreement (SLA) of 99.99%.
In a multi-region deployment, using Availability Zones can enhance the resiliency of the primary region. Even if one zone experiences an outage, the services can operate seamlessly from another zone within the same region.</p>
<p>Every unit deployed across the Availability Zones includes all necessary API Management components, ensuring comprehensive coverage and functionality.</p>
<p>Using Availability Zones in Azure API Management provides enhanced availability, reliability, and resiliency for your API services, especially in a multi-region deployment. This setup ensures that your APIs remain accessible and operational even in the face of regional outages or disruptions.</p>
<p>Now, let us take a look at self-hosting your own Gateway.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Self-hosted Gateway" src="https://luke.geek.nz/assets/images/apim_apilifecyle_scale_SelfHostedAPIGateway-9a3b77f802ab4dcc77bc9434140378be.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>The self-hosted API gateway is functionally equivalent to the managed gateway. This feature provides flexibility, allowing the gateway to be deployed on-premises or in the cloud, depending on the organization's needs. The self-hosted gateway requires only outgoing connectivity to Azure <em>(API Management Gateway)</em> on port 443.</p>
<p>The self-hosted gateway connects to a "parent" API Management service in Azure. It pulls down configuration settings and pushes up telemetry data to Azure. This integration with Azure allows for centralized management and monitoring, simplifying the oversight and control of the API gateway.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Self-hosted Gateway SKU" src="https://luke.geek.nz/assets/images/apim_apilifecyle_scale_SelfHostedAPIGatewaySKU-6afdcfffadc0a6ac9e966f5bd4f8ad91.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Now, let us take a look at <a href="https://dapr.io/" target="_blank" rel="noopener noreferrer">Dapr</a> and Azure API Management.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><blockquote>
<p><a href="https://docs.dapr.io/developing-applications/integrations/azure/azure-api-management/" target="_blank" rel="noopener noreferrer">Azure API Management is a way to create consistent and modern API gateways for back-end services, including those built with Dapr</a>. You can enable Dapr support in self-hosted API Management gateways to allow them to:</p>
</blockquote><p>Forward requests to Dapr services
Send messages to Dapr Pub/Sub topics
Trigger Dapr output bindings</p></div></div>
<p><img decoding="async" loading="lazy" alt="APIM - Dapr" src="https://luke.geek.nz/assets/images/apim_apilifecyle_scale_Dapr-467d22df34b4afeac447ee9776d4b46a.PNG" width="4000" height="2250" class="img_ev3q"></p>
<ul>
<li>Dapr can work with self-hosted Azure API Management gateways and invoke services running in different pods. This allows for seamless communication between microservices within the Kubernetes cluster.</li>
<li>Dapr supports publish/subscribe messaging, enabling applications to send messages to topics and other applications to subscribe to these topics</li>
<li>Dapr can trigger outbound bindings, which allows it to interact with external systems and services. This feature is useful for integrating with external databases, message queues, and other services.</li>
</ul>
<p>By integrating Dapr with self-hosted gateways, the architecture's complexity is reduced, and common tasks like service discovery, state management, and pub/sub are simplified.</p>
<p>Azure API Management offers an isolated SKU, a dedicated instance of Azure API Management that runs on a single-tenant virtual network. This SKU is ideal for organizations that require enhanced security, compliance, and isolation for their APIs.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Isolated SKU" src="https://luke.geek.nz/assets/images/apim_apilifecyle_scale_IsolatedTenant-940e7b0deec0a711648bd64c9671d4b9.PNG" width="4000" height="2250" class="img_ev3q"></p>
<blockquote>
<p>The purpose of the Isolated tier is to enable the use of all the features of the API Management Premium tier in highly regulated industries where compute environment isolation is a requirement.</p>
</blockquote>
<p>Now, let us discuss <a href="https://learn.microsoft.com/azure/api-management/api-management-howto-disaster-recovery-backup-restore?tabs=powershell&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Backup and Restore</a>.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Backup and Restore" src="https://luke.geek.nz/assets/images/apim_apilifecyle_scale_IBackupRestore-7f0df87da055d9655a002fbf9cc68cca.PNG" width="4000" height="2250" class="img_ev3q"></p>
<table><thead><tr><th><strong>Process</strong></th><th><strong>Details</strong></th></tr></thead><tbody><tr><td><strong>Backup</strong></td><td></td></tr><tr><td>Duration</td><td>Usually takes around 10 minutes.</td></tr><tr><td>Scope</td><td>Captures everything but reports and custom domain settings in a blob.</td></tr><tr><td>Service Configuration</td><td>Operations such as scaling and upgrades are blocked while the backup is in progress.</td></tr><tr><td>Changes</td><td>Any changes applied after the backup starts are not included in the backup.</td></tr><tr><td><strong>Restore</strong></td><td></td></tr><tr><td>Duration</td><td>It Could take 30 minutes or more, depending on the size.</td></tr><tr><td>Availability</td><td>The instance is not available while the restore is in progress.</td></tr><tr><td>Custom Domain</td><td>Custom domain configurations need to be re-applied manually after the restore.</td></tr><tr><td><strong>Standby Failover Instance</strong></td><td></td></tr><tr><td>Setup</td><td>Create a backup instance in a different region in advance.</td></tr><tr><td>Configuration</td><td>Configure the custom domain identically to the active instance.</td></tr><tr><td>Sync</td><td>Periodically sync the configuration with the active instance to achieve the desired RPO (Recovery Point Objective).</td></tr><tr><td>Failover</td><td>To failover, update the CNAME to reference the backup instance.</td></tr><tr><td>Scalability</td><td>Scale up the backup instance if and as required.</td></tr><tr><td><strong>Summary</strong></td><td></td></tr><tr><td>Backup</td><td>This process is relatively quick but does block certain operations and does not capture changes made after the backup begins.</td></tr><tr><td>Restore</td><td>This can be time-consuming and renders the instance unavailable during the process. Manual intervention is required for custom domain settings.</td></tr><tr><td>Standby Failover</td><td>Setting up a standby instance in advance can significantly reduce downtime and improve recovery times. This involves periodic synchronization and possibly updating DNS records during a failover.</td></tr></tbody></table>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>Backup and restore need to be configured. It is not enabled by default.
Backup is not possible in Consumption.
Backup and restore could take between 30 minutes to 1 hour.
Taking a backup or restore puts the API Management Management plane in a read-only state while the backup or restore is in progress.
The backups expire after 30 days.</p></div></div>
<p>Backup and restore is where you can consider Infrastructure as Code and APIOps functionality and testing.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-monitor-and-analyze">📊 Monitor and Analyze<a href="https://luke.geek.nz/azure/api-management-overview/#-monitor-and-analyze" class="hash-link" aria-label="Direct link to 📊 Monitor and Analyze" title="Direct link to 📊 Monitor and Analyze">​</a></h3>
<p><img decoding="async" loading="lazy" alt="API Lifecycle - Monitor and Analyze" src="https://luke.geek.nz/assets/images/apim_apilifecyle_MonitorAnalyze-40d533759aa62b720005173e34760838.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Now we need to monitor and analyze the APIs and API Management to ensure that they are performing as expected and to identify any issues that may arise. Azure API Management provides a range of monitoring and analytics features to help you track API usage, performance, and health.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Monitor and Analyze" src="https://luke.geek.nz/assets/images/apim_apilifecyle_MonitorAnalyzeFeatures-e514006bc3cbb46153a3f7db814a79f8.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="APIM - Monitor and Analyze" src="https://luke.geek.nz/assets/images/apim_apilifecyle_MonitorAnalyzeAPIInspector-ef5274c2c3d3385874f38ac723150c7b.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>The "<a href="https://learn.microsoft.com/azure/api-management/observability?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">API Inspector</a>" feature monitors and analyzes API requests. It provides detailed information about each request, including the URL, headers, and response status code. This feature helps troubleshoot issues and optimize API performance.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Monitor and Analyze" src="https://luke.geek.nz/assets/images/apim_apilifecyle_MonitorAnalyzeAzureMonitorMetrics-861c586e59018acf39add8f53fc70ee9.PNG" width="4000" height="2250" class="img_ev3q"></p>
<table><thead><tr><th style="text-align:left">Tool</th><th style="text-align:left">Useful for</th><th style="text-align:left">Data lag</th><th style="text-align:left">Retention</th><th style="text-align:left">Sampling</th><th style="text-align:left">Data kind</th><th style="text-align:left">Supported Deployment Model(s)</th></tr></thead><tbody><tr><td style="text-align:left"><strong><a href="https://learn.microsoft.com/azure/api-management/api-management-howto-api-inspector?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">API Inspector</a></strong></td><td style="text-align:left">Testing and debugging</td><td style="text-align:left">Instant</td><td style="text-align:left">Last 100 traces</td><td style="text-align:left">Turned on per request</td><td style="text-align:left">Request traces</td><td style="text-align:left">Managed, Self-hosted, Azure Arc</td></tr><tr><td style="text-align:left"><strong><a href="https://learn.microsoft.com/azure/api-management/howto-use-analytics?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Built-in Analytics</a></strong></td><td style="text-align:left">Reporting and monitoring</td><td style="text-align:left">Minutes</td><td style="text-align:left">Lifetime</td><td style="text-align:left">100%</td><td style="text-align:left">Reports and logs</td><td style="text-align:left">Managed</td></tr><tr><td style="text-align:left"><strong><a href="https://learn.microsoft.com/azure/api-management/api-management-howto-use-azure-monitor?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Monitor Metrics</a></strong></td><td style="text-align:left">Reporting and monitoring</td><td style="text-align:left">Minutes</td><td style="text-align:left">90 days (upgrade to extend)</td><td style="text-align:left">100%</td><td style="text-align:left">Metrics</td><td style="text-align:left">Managed, Self-hosted<sup>2</sup>, Azure Arc</td></tr><tr><td style="text-align:left"><strong><a href="https://learn.microsoft.com/azure/api-management/api-management-howto-use-azure-monitor?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Monitor Logs</a></strong></td><td style="text-align:left">Reporting, monitoring, and debugging</td><td style="text-align:left">Minutes</td><td style="text-align:left">31 days/5GB (upgrade to extend)</td><td style="text-align:left">100% (adjustable)</td><td style="text-align:left">Logs</td><td style="text-align:left">Managed<sup>1</sup>, Self-hosted<sup>3</sup>, Azure Arc<sup>3</sup></td></tr><tr><td style="text-align:left"><strong><a href="https://learn.microsoft.com/azure/api-management/api-management-howto-app-insights?tabs=rest&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Application Insights</a></strong></td><td style="text-align:left">Reporting, monitoring, and debugging</td><td style="text-align:left">Seconds</td><td style="text-align:left">90 days/5GB (upgrade to extend)</td><td style="text-align:left">Custom</td><td style="text-align:left">Logs, metrics</td><td style="text-align:left">Managed<sup>1</sup>, Self-hosted<sup>1</sup>, Azure Arc<sup>1</sup></td></tr><tr><td style="text-align:left"><strong><a href="https://learn.microsoft.com/azure/api-management/api-management-howto-log-event-hubs?tabs=PowerShell&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Logging through Azure Event Hubs</a></strong></td><td style="text-align:left">Custom scenarios</td><td style="text-align:left">Seconds</td><td style="text-align:left">User managed</td><td style="text-align:left">Custom</td><td style="text-align:left">Custom</td><td style="text-align:left">Managed<sup>1</sup>, Self-hosted<sup>1</sup>, Azure Arc<sup>1</sup></td></tr><tr><td style="text-align:left"><strong><a href="https://learn.microsoft.com/azure/api-management/how-to-deploy-self-hosted-gateway-kubernetes-opentelemetry?WT.mc_id=AZ-MVP-5004796#introduction-to-opentelemetry" target="_blank" rel="noopener noreferrer">OpenTelemetry</a></strong></td><td style="text-align:left">Monitoring</td><td style="text-align:left">Minutes</td><td style="text-align:left">User managed</td><td style="text-align:left">100%</td><td style="text-align:left">Metrics</td><td style="text-align:left">Self-hosted<sup>2</sup></td></tr></tbody></table>
<p><em>1. Optional, depending on the configuration of the feature in Azure API Management</em></p>
<p><em>2. Optional, depending on the configuration of the gateway</em></p>
<p><em>3. The self-hosted gateway currently does not send diagnostic logs to Azure Monitor. However, it is possible to configure and persist logs locally where the self-hosted gateway is deployed.</em></p>
<p><img decoding="async" loading="lazy" alt="APIM - Monitor Logs" src="https://luke.geek.nz/assets/images/apim_apilifecyle_MonitorAnalyzeAzureMonitorLogs-095fdefa2225f1737d1ec99c501e51f2.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="APIM - Monitor Logs" src="https://luke.geek.nz/assets/images/apim_apilifecyle_MonitorAnalyzeAppInsights-ca96afa427b477146562d62a7271786b.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="APIM - Monitor Reports" src="https://luke.geek.nz/assets/images/apim_apilifecyle_MonitorAnalyzeReports-7ab257fd873d58e35398a4a8335d49f0.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>More information on API Management can be found here: <a href="https://aka.ms/apimlove" target="_blank" rel="noopener noreferrer">https://aka.ms/apimlove</a>.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Monitor and Analyze" src="https://luke.geek.nz/assets/images/apim_love-1c20502ac2a7b72384eca9a9ea26106d.png" width="4000" height="2250" class="img_ev3q"></p>
<p>An excellent resource for Architecting Azure API Management, considerations can be found here: <a href="https://github.com/stephaneey/azure-and-k8s-architecture/blob/main/maps/apim.md" target="_blank" rel="noopener noreferrer">stephaneey/azure-and-k8s-architecture</a> from MVP <a href="https://www.linkedin.com/in/stephane-eyskens" target="_blank" rel="noopener noreferrer">Stephane Eyskens</a>.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Monitor and Analyze" src="https://luke.geek.nz/assets/images/apim_architecturemap-218572e8e16e98d868f3f4d40275429f.PNG" width="4000" height="2250" class="img_ev3q"></p>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Azure Hackathon Vending with Terraform]]></title>
            <link>https://luke.geek.nz/azure/hackathon-vending-project/</link>
            <guid>https://luke.geek.nz/azure/hackathon-vending-project/</guid>
            <pubDate>Mon, 29 Jul 2024 06:27:25 GMT</pubDate>
            <description><![CDATA[Learn how to build and deploy a Hackathon environment with Azure, GitHub Actions, Entra ID, and Terraform.]]></description>
            <content:encoded><![CDATA[<p>When working with Microsoft Azure, you may want an environment for learning, testing, or Hackathons. This post will cover some technical implementation considerations for creating a sandbox environment in Azure that could be used for your Hackathons using Terraform, Entra ID Access packages, and GitHub Actions.</p>
<!-- -->
<p><img decoding="async" loading="lazy" alt="Microsoft Azure - Hackathon" src="https://luke.geek.nz/assets/images/hackathon_overview-68a98616da8e81ab9fe921e6f2fc0e3a.png" width="4000" height="2250" class="img_ev3q"></p>
<p>So let us look at a scenario:</p>
<blockquote>
<p>"As a hackathon organizer, I want to build an Azure environment that supports various AI-driven solutions to automate and enhance operational processes, including customer feedback analysis, testing plan creation, and standard procedure refinement."</p>
</blockquote>
<p><img decoding="async" loading="lazy" alt="Hackathon - Requirements" src="https://luke.geek.nz/assets/images/hackathon_requirements-1d6c7bbc58eddc063d7e0b34b9c5720c.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>We have a few Technical Requirements:</p>
<ul>
<li>It needs to support multiple <em>(external)</em> users and teams from different organizations using Work and Personal accounts who work together.</li>
<li>Needs to support the creation of multiple Azure resources</li>
</ul>
<p>And our limitations are:</p>
<ul>
<li>One Azure subscription</li>
</ul>
<p>Let us look at how we can leverage Microsoft Azure technologies to implement this.</p>
<p><img decoding="async" loading="lazy" alt="Hackathon - Azure environment" src="https://luke.geek.nz/assets/images/hackathon_environmenttech-564e79187f0a99533670876d61a40f67.PNG" width="4000" height="2250" class="img_ev3q"></p>
<ul>
<li><a href="https://learn.microsoft.com/azure/cost-management-billing/manage/create-subscription?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Subscription</a></li>
<li><a href="https://learn.microsoft.com/azure/azure-resource-manager/management/overview?WT.mc_id=AZ-MVP-5004796#resource-groups" target="_blank" rel="noopener noreferrer">Azure Resource Groups</a> <em>(within Azure subscription)</em></li>
<li><a href="https://learn.microsoft.com/entra/fundamentals/whatis?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Entra ID</a></li>
<li><a href="https://learn.microsoft.com/entra/id-governance/entitlement-management-access-package-create?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Entra ID Identity Governance - Access Packages</a>. This requires a Entra ID P2 license.</li>
</ul>
<p>For this article, there are some assumptions I will be making, such as:</p>
<ul>
<li>A Resource Group per Team is sufficient for the Hackathon.</li>
</ul>
<p><img decoding="async" loading="lazy" alt="Hackathon - Environment concepts" src="https://luke.geek.nz/assets/images/hackathon_environmentconcepts-6e9d88470c62e51b3b951e5713fe6bfd.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>We will approach this as a <a href="https://luke.geek.nz/azure/microsoft-azure-sandbox-design-considerations/" target="_blank" rel="noopener noreferrer">Lightly Managed Sandbox</a>.</p>
<p><img decoding="async" loading="lazy" alt="Hackathon - Sandbox Types" src="https://luke.geek.nz/assets/images/hackathon_sandboxtypes-b9154dc64e946394357ff70eca29f46d.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>And give External Identities access to an Azure subscription through Access Packages and a Group with a Contributor role assigned to the individual Resource Groups.</p>
<p><img decoding="async" loading="lazy" alt="Hackathon - Identity &amp;amp; Access" src="https://luke.geek.nz/assets/images/hackathon_identityaccess-7705a603b81cf5c9fb64db289058179d.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>To do this, we will leverage Access packages to invite external users into the Hackathon tenancy and assign them to a group with the Contributor role assigned to the Resource Group.</p>
<p><img decoding="async" loading="lazy" alt="Hackthon - Access packages" src="https://luke.geek.nz/assets/images/hackathon_identityaccesspackages-111a83f65e10bb6219d52889d8f38830.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>By creating a Policy allowing external organizations to make requests, the Hackathon Organiser can invite external users to the Azure subscription and access internal <em>(Hackathon)</em> resources.</p>
<p><img decoding="async" loading="lazy" alt="Hackathon - Identity Access packages" src="https://luke.geek.nz/assets/images/hackathon_identityaccesspackagespolicy-d698483f2d38445027259d76a20a6689.PNG" width="4000" height="2250" class="img_ev3q">
<img decoding="async" loading="lazy" alt="Hackathon - Identity Access packages" src="https://luke.geek.nz/assets/images/hackathon_identityaccesspackagespolicy1-8839a3331df4715d577fad134e127c94.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="Hackathon - Identity Access packages" src="https://luke.geek.nz/assets/images/hackathonaccesspackage_signup-19dd9142ba0850219162553278c63dd3.gif" width="1901" height="965" class="img_ev3q"></p>
<blockquote>
<p>You may also need to consider <a href="https://learn.microsoft.com/entra/external-id/cross-tenant-access-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Inbound Cross-tenant Access</a> setting Trust configuration.</p>
</blockquote>
<p><img decoding="async" loading="lazy" alt="Hackathon - Cross tenant Access Settings" src="https://luke.geek.nz/assets/images/hackathon_identityaccesstrustsettings-9866c39d287f36c72ed8e9732f3184e6.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>So, let's look at some of the main Terraform code snippets that could be used to create the Azure resources for the Hackathon.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>The identity being used to create these Terraform resources will need the following:</p><ul>
<li><a href="https://learn.microsoft.com/azure/role-based-access-control/role-assignments-portal-subscription-admin?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Owner</a> of the Azure Subscription to create the Resource Groups and role assignments.</li>
<li><a href="https://learn.microsoft.com/entra/identity/role-based-access-control/permissions-reference?WT.mc_id=AZ-MVP-5004796#identity-governance-administrator" target="_blank" rel="noopener noreferrer">Identity Governance Administrator</a>, to create the Access Packages and Catalog.</li>
<li><a href="https://learn.microsoft.com/entra/identity/role-based-access-control/permissions-reference?WT.mc_id=AZ-MVP-5004796#groups-administrator" target="_blank" rel="noopener noreferrer">Groups Administrator</a> role to create and delete the Groups in the Entra ID tenant.</li>
</ul></div></div>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">locals</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Read the content of the CSV file named "az_hackathon.csv" and store it in the local variable "csv_content."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">csv_content</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> file(</span><span class="token string" style="color:rgb(255, 121, 198)">"az_hackathon.csv"</span><span class="token plain">)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Decode the CSV content into a list of maps, each representing a row in the CSV file.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">csv_data</span><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> csvdecode(local.csv_content)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This reads a CSV file containing the details of the Azure Resource Groups that need to be created for the Hackathon. I have used this base CSV file.</p>
<div class="language-csv codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csv codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Team,Location,Environment,Application,Notes</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Team1,AustraliaEast,hackathon,AI,"AI Hackathon for luke.geek.nz."</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Team2,canadaeast,hackathon,AI,"AI Hackathon for luke.geek.nz."</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Team3,francecentral,hackathon,AI,"AI Hackathon for luke.geek.nz."</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Team4,swedencentral,hackathon,AI,"AI Hackathon for luke.geek.nz."</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Team5,uksouth,hackathon,AI,"AI Hackathon for luke.geek.nz."</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Using this and the <a href="https://registry.terraform.io/providers/hashicorp/azurerm/latest" target="_blank" rel="noopener noreferrer">AzureRM</a> Terraform provider, we can create the Resource Groups and assign the Access Packages to them.</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Define an Azure Resource Group resource named "rg".</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource </span><span class="token keyword type variable" style="color:rgb(189, 147, 249);font-style:italic">"azurerm_resource_group"</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"rg"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Create one resource group for each entry in the csv_data list.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">count</span><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> length(local.csv_data)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Set the name of the resource group using the Team, Environment, and Application attributes from the csv_data list.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token plain">     </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> lower(format(</span><span class="token string" style="color:rgb(255, 121, 198)">"%s-%s-%s-rg"</span><span class="token plain">, local.csv_data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">count.index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">.Team, local.csv_data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">count.index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">.Environment, local.csv_data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">count.index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">.Application))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Set the location of the resource group using the Location attribute from the csv_data list.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">location</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> local.csv_data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">count.index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">.Location</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Set tags for the resource group using attributes from the csv_data list.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">tags</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">Environment</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> lower(local.csv_data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">count.index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">.Environment)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">Team</span><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> lower(local.csv_data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">count.index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">.Team)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">Application</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> lower(local.csv_data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">count.index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">.Application)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">Notes</span><span class="token plain">       </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> lower(local.csv_data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">count.index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">.Notes)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You will create a Resource Group, such as below, for each team based on the CSV file:</p>
<p><img decoding="async" loading="lazy" alt="Hackathon - Resource Group 1" src="https://luke.geek.nz/assets/images/hackathon_team1_resourcegroupbeforeOpenAI-ce22af101cb5df3abb2eb58fd6747a4c.png" width="1762" height="471" class="img_ev3q"></p>
<p>Now we can create the Groups and assign the permissions:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Define an Azure AD Group resource named "ad_group".</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource </span><span class="token keyword type variable" style="color:rgb(189, 147, 249);font-style:italic">"azuread_group"</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"ad_group"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Create one Azure AD group for each entry in the csv_data list.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">count</span><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> length(local.csv_data)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Set the display name of the Azure AD group using the Team, Environment, and Application attributes from the csv_data list.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">display_name</span><span class="token plain">     </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> lower(format(</span><span class="token string" style="color:rgb(255, 121, 198)">"%s-%s-%s-group"</span><span class="token plain">, local.csv_data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">count.index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">.Team, local.csv_data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">count.index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">.Environment, local.csv_data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">count.index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">.Application))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Set the description of the Azure AD group using the Team, Environment, and Application attributes from the csv_data list.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">description</span><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> format(</span><span class="token string" style="color:rgb(255, 121, 198)">"Group for %s environment of %s application managed by %s team."</span><span class="token plain">, title(local.csv_data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">count.index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">.Environment), title(local.csv_data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">count.index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">.Application), title(local.csv_data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">count.index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">.Team))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Disable mail for the Azure AD group.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">mail_enabled</span><span class="token plain">     </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Enable security for the Azure AD group.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">security_enabled</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Define an Azure Role Assignment resource named "role_assignment".</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource </span><span class="token keyword type variable" style="color:rgb(189, 147, 249);font-style:italic">"azurerm_role_assignment"</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"role_assignment"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Create one role assignment for each entry in the csv_data list.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">count</span><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> length(local.csv_data)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Set the scope of the role assignment to the ID of the corresponding resource group.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">scope</span><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> azurerm_resource_group.rg</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">count.index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">.id</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Assign the "Owner" role to the principal.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">role_definition_name</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Owner"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Set the principal ID to the object ID of the corresponding Azure AD group.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">principal_id</span><span class="token plain">         </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> azuread_group.ad_group</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">count.index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">.object_id</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Hackathon - Resource Group Access Control (IAM)" src="https://luke.geek.nz/assets/images/hackathon_team1_resourcegroupiam-6593adbc494da6046c4f07ec33ba0a69.png" width="1606" height="744" class="img_ev3q">'</p>
<p>So now, we have created the Resource Groups and Entra ID groups and assigned Owner permissions to the Resource Groups for each Team in the CSV file; it is time to deploy a base resource - such as Azure OpenAI, which those hackathon teams can use, to get going! <a href="https://learn.microsoft.com/azure/ai-services/openai/concepts/models?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure OpenAI models are deployed to various regions</a> and have token limits constrained to the region, so we need to consider how heavily these endpoints will be hit - which is why you may have noticed in the CSV, that the location of each Resource Group is different, so we want to use that to make sure that our Azure OpenAI resources are deployed in the same region as the Resource Group, to help balance.</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># This resource block defines an Azure Cognitive Account resource named "openai"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource </span><span class="token keyword type variable" style="color:rgb(189, 147, 249);font-style:italic">"azurerm_cognitive_account"</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"openai"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The for_each argument is used to iterate over a map created from local.csv_data.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Each entry in the map is identified by an index (idx) and its corresponding value (val).</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">for_each</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> for idx, val in local.csv_data : </span><span class="token property">idx</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain">&gt; val </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The name of the cognitive account is dynamically set using the "Team" attribute from each value in the map.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"openai-ca-</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">$</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string interpolation function" style="color:rgb(80, 250, 123)">lower</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string interpolation" style="color:rgb(255, 121, 198)">each</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation" style="color:rgb(255, 121, 198)">value</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation" style="color:rgb(255, 121, 198)">Team</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string" style="color:rgb(255, 121, 198)">-</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">$</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string interpolation function" style="color:rgb(80, 250, 123)">lower</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string interpolation" style="color:rgb(255, 121, 198)">each</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation" style="color:rgb(255, 121, 198)">value</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation" style="color:rgb(255, 121, 198)">Location</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The location of the cognitive account is set using the "Location" attribute from each value in the map.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">location</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> each.value.Location</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The resource group name is dynamically set using the key from the map.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">resource_group_name</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> azurerm_resource_group.rg</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">each.key</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">.name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The kind of cognitive account is set to "OpenAI."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">kind</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"OpenAI"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The SKU (pricing tier) of the cognitive account is set to "S0".</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">sku_name</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"S0"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>So we end up with something like this:</p>
<p><img decoding="async" loading="lazy" alt="Hackathon - Azure OpenAI" src="https://luke.geek.nz/assets/images/hackathon_resources_AzureOpenAI-4d1f6aa92f81b86364326fd118f9ce39.png" width="1382" height="617" class="img_ev3q"></p>
<p>We may also need to consider the Azure <a href="https://learn.microsoft.com/azure/azure-resource-manager/management/resource-providers-and-types?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Resource Providers</a>, as the Hackathon teams, won't have permissions to register these.</p>
<p>So we can create a map of the Resource Providers, and then iterate over them, to register them.</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">variable</span><span class="token keyword type variable" style="color:rgb(189, 147, 249);font-style:italic"> "resource_providers" </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">description</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Map of Azure resource providers to register"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">default</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"Microsoft.Maps"</span><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"Microsoft.OperationalInsights"</span><span class="token plain">     </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"Microsoft.EventGrid"</span><span class="token plain">               </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"Microsoft.EventHub"</span><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"Microsoft.GuestConfiguration"</span><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"Microsoft.HDInsight"</span><span class="token plain">               </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"Microsoft.KeyVault"</span><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"Microsoft.ContainerService"</span><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"Microsoft.DBforMySQL"</span><span class="token plain">              </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"Microsoft.DBforMariaDB"</span><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"Microsoft.DBforMySQL"</span><span class="token plain">              </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"Microsoft.DBforPostgreSQL"</span><span class="token plain">         </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"Microsoft.DataFactory"</span><span class="token plain">             </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"Microsoft.HealthBot"</span><span class="token plain">               </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"Microsoft.HealthModel"</span><span class="token plain">             </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"Microsoft.HealthcareApis"</span><span class="token plain">          </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"Microsoft.MachineLearning"</span><span class="token plain">         </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"Microsoft.Orbital"</span><span class="token plain">                 </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"Microsoft.Sql"</span><span class="token plain">                     </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// Add the rest of your providers here</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource </span><span class="token keyword type variable" style="color:rgb(189, 147, 249);font-style:italic">"azurerm_resource_provider_registration"</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"resourceproviders"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">for_each</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> var.resource_providers</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token plain">     </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> each.key</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now, we need to create our Entra ID Catalog and Access Packages and assign the Resource Groups to the Access package.</p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>The <a href="https://learn.microsoft.com/entra/id-governance/entitlement-management-access-package-create?WT.mc_id=AZ-MVP-5004796#create-request-policies" target="_blank" rel="noopener noreferrer">request policies</a> themselves, I had issues deploying via Terraform, I suspect due to missing Graph permissions 'EntitlementManagement.ReadWrite.All' on the identity, but had some issues adding this, so did them manually, however, I have successfully deployed the policies in another environment successfully using the: <a href="https://registry.terraform.io/providers/hashicorp/azuread/latest/docs/resources/access_package_assignment_policy" target="_blank" rel="noopener noreferrer">azuread_access_package_assignment_policy</a> terraform resource.</p><p>Make sure you add:
requests_accepted = true
To the requestors block, enable the policy, or the policy will be deployed as Disabled.</p></div></div>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource </span><span class="token keyword type variable" style="color:rgb(189, 147, 249);font-style:italic">"azuread_access_package_catalog"</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Sandbox"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token property">description</span><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Hackathon Sandboxes"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token property">display_name</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Sandbox"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token property">published</span><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Define an Azure AD Access Package resource named "access_package"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource </span><span class="token keyword type variable" style="color:rgb(189, 147, 249);font-style:italic">"azuread_access_package"</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"access_package"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># The count parameter determines how many instances of this resource to create based on the length of the csv_data list.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token property">count</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> length(local.csv_data)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># The display_name parameter sets the display name of the access package for each instance,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># using the Team, Environment, and Application attributes from the csv_data list.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token property">display_name</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> format(</span><span class="token string" style="color:rgb(255, 121, 198)">"%s-%s-%s-access-package"</span><span class="token plain">, local.csv_data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">count.index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">.Team, local.csv_data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">count.index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">.Environment, local.csv_data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">count.index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">.Application)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># The catalog_id parameter sets the ID of the access package catalog for each instance,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># using the Sandbox catalog ID.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token property">catalog_id</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> azuread_access_package_catalog.Sandbox.id</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># The description parameter sets the description of the access package for each instance,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># using the Team, Environment, and Notes attributes from the csv_data list.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token property">description</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Access package for </span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">$</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string interpolation keyword" style="color:rgb(189, 147, 249);font-style:italic">local</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation type variable" style="color:rgb(189, 147, 249);font-style:italic">csv_data</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string interpolation keyword" style="color:rgb(189, 147, 249);font-style:italic">count</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation type variable" style="color:rgb(189, 147, 249);font-style:italic">index</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation" style="color:rgb(255, 121, 198)">Team</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string" style="color:rgb(255, 121, 198)">-</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">$</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string interpolation keyword" style="color:rgb(189, 147, 249);font-style:italic">local</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation type variable" style="color:rgb(189, 147, 249);font-style:italic">csv_data</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string interpolation keyword" style="color:rgb(189, 147, 249);font-style:italic">count</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation type variable" style="color:rgb(189, 147, 249);font-style:italic">index</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation" style="color:rgb(255, 121, 198)">Environment</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string" style="color:rgb(255, 121, 198)">-</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">$</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string interpolation keyword" style="color:rgb(189, 147, 249);font-style:italic">local</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation type variable" style="color:rgb(189, 147, 249);font-style:italic">csv_data</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string interpolation keyword" style="color:rgb(189, 147, 249);font-style:italic">count</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation type variable" style="color:rgb(189, 147, 249);font-style:italic">index</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation" style="color:rgb(255, 121, 198)">Notes</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Assign all groups we have created to our catalog</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource </span><span class="token keyword type variable" style="color:rgb(189, 147, 249);font-style:italic">"azuread_access_package_resource_catalog_association"</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"CloudSandbox_Groups"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># The count parameter determines how many instances of this resource to create based on the length of the csv_data list.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token property">count</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> length(local.csv_data)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># The catalog_id parameter sets the ID of the access package catalog for each instance using the Sandbox catalog ID.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token property">catalog_id</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> azuread_access_package_catalog.Sandbox.id</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># The resource_origin_id parameter sets the ID of the Azure AD group for each instance using the index from the csv_data list.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token property">resource_origin_id</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> azuread_group.ad_group</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">count.index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">.id</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># The resource_origin_system parameter specifies the origin system of the resource, which is "AadGroup" in this case.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token property">resource_origin_system</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"AadGroup"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource </span><span class="token keyword type variable" style="color:rgb(189, 147, 249);font-style:italic">"azuread_access_package_resource_package_association"</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"group_association"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># The count parameter determines how many instances of this resource to create based on the length of the csv_data list.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token property">count</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> length(local.csv_data)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># The access_package_id parameter sets the ID of the access package for each instance using the index from the csv_data list.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token property">access_package_id</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> azuread_access_package.access_package</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">count.index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">.id</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># The catalog_resource_association_id parameter sets the ID of the catalog resource association for each instance using the index from the csv_data list.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token property">catalog_resource_association_id</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> azuread_access_package_resource_catalog_association.CloudSandbox_Groups</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">count.index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">.id</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Hackathon - Entra ID Access Packages" src="https://luke.geek.nz/assets/images/hackathon_identityaccesspackagesazportal-68a7720d71b613d8f88329c815488890.png" width="1855" height="740" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="Hackathon - GitHub Actions" src="https://luke.geek.nz/assets/images/hackathon_githubactions-af337675c2e1c65569af8430ff90e44b.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Now we have our base Terraform, it is time to deploy this, and we can use GitHub Actions to do this by creating a GitHub Actions workflow file, such as below:</p>
<!-- -->
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Terraform Plan/Apply'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">on</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">push</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">branches</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">pull_request</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">branches</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">#Special permissions required for OIDC authentication</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">permissions</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">id-token</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> write</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">contents</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> read</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">pull-requests</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> write</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">jobs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">terraform-plan</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Terraform Plan'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">runs-on</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">environment</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> production</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)">#this is needed since we are running terraform with read-only permissions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">ARM_SKIP_PROVIDER_REGISTRATION</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">outputs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">tfplanExitCode</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> steps.tf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">plan.outputs.exitcode </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Checkout the repository to the GitHub Actions runner</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Checkout</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> actions/checkout@v4</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Install the latest version of the Terraform CLI</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Setup Terraform</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> hashicorp/setup</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">terraform@v3</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">terraform_wrapper</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Initialize a new or existing Terraform working directory by creating initial files, loading any remote state, downloading modules, etc.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Terraform Init</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">run</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> terraform init</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)">#These environment variables are used by the terraform azure provider to setup OIDD authenticate. </span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">ARM_CLIENT_ID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"${{ secrets.AZURE_CLIENT_ID }}"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">ARM_SUBSCRIPTION_ID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"${{ secrets.AZURE_SUBSCRIPTION_ID }}"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">ARM_TENANT_ID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"${{ secrets.AZURE_TENANT_ID }}"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">working-directory</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ./iac</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Checks that all Terraform configuration files adhere to a canonical format</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Will fail the build if not</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Terraform Format</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">run</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> terraform fmt </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">check</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">working-directory</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ./iac</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Generates an execution plan for Terraform</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># An exit code of 0 indicated no changes, 1 a terraform failure, 2 there are pending changes.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Terraform Plan</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> tf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">plan</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">ARM_CLIENT_ID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"${{ secrets.AZURE_CLIENT_ID }}"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">ARM_SUBSCRIPTION_ID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"${{ secrets.AZURE_SUBSCRIPTION_ID }}"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">ARM_TENANT_ID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"${{ secrets.AZURE_TENANT_ID }}"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">working-directory</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ./iac</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">run</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token scalar string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        export exitcode=0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        terraform plan -detailed-exitcode -no-color -out tfplan || export exitcode=$?</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        echo "exitcode=$exitcode" </span><span class="token punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"> $GITHUB_OUTPUT</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"> $exitcode </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">eq 1 </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">; then</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          echo Terraform Plan Failed</span><span class="token tag" style="color:rgb(255, 121, 198)">!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          exit 1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        else </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          exit 0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        fi</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Upload Terraform Plan</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">if</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> success() </span><span class="token important">&amp;&amp;</span><span class="token plain"> steps.plan.outputs.exitcode </span><span class="token tag" style="color:rgb(255, 121, 198)">!=</span><span class="token plain"> '1'</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> actions/upload</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">artifact@v4</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> tfplan</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">path</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ./iac/tfplan </span><span class="token comment" style="color:rgb(98, 114, 164)"># Ensure this path is correct</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Create string output of Terraform Plan</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Create String Output</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> tf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">plan</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">string</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">run</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token scalar string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        cd ./iac</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        TERRAFORM_PLAN=$(terraform show -no-color tfplan)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        delimiter="$(openssl rand -hex 8)"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        echo "summary&lt;&lt;${delimiter}" &gt;&gt; $GITHUB_OUTPUT</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        echo "## Terraform Plan Output" &gt;&gt; $GITHUB_OUTPUT</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        echo "&lt;details&gt;&lt;summary&gt;Click to expand&lt;/summary&gt;" &gt;&gt; $GITHUB_OUTPUT</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        echo "" &gt;&gt; $GITHUB_OUTPUT</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        echo '```terraform' &gt;&gt; $GITHUB_OUTPUT</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        echo "$TERRAFORM_PLAN" &gt;&gt; $GITHUB_OUTPUT</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        echo '```' &gt;&gt; $GITHUB_OUTPUT</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        echo "&lt;/details&gt;" &gt;&gt; $GITHUB_OUTPUT</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        echo "${delimiter}" &gt;&gt; $GITHUB_OUTPUT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Publish Terraform Plan as task summary</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Publish Terraform Plan to Task Summary</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">SUMMARY</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> steps.tf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">plan</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">string.outputs.summary </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">run</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token scalar string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        echo "$SUMMARY" &gt;&gt; $GITHUB_STEP_SUMMARY</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># If this is a PR post the changes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Push Terraform Output to PR</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">if</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> github.ref </span><span class="token tag" style="color:rgb(255, 121, 198)">!=</span><span class="token plain"> 'refs/heads/main'</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> actions/github</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">script@v7</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">SUMMARY</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"${{ steps.tf-plan-string.outputs.summary }}"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">github-token</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> secrets.GITHUB_TOKEN </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">script</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token scalar string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            const body = `${process.env.SUMMARY}`;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            github.rest.issues.createComment({</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                issue_number: context.issue.number,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                owner: context.repo.owner,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                repo: context.repo.repo,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                body: body</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            })</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                </span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">terraform-apply</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Terraform Apply'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">if</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> github.ref == 'refs/heads/main' </span><span class="token important">&amp;&amp;</span><span class="token plain"> needs.terraform</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">plan.outputs.tfplanExitCode == 2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">runs-on</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">environment</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> production</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">needs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">terraform</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">plan</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Checkout the repository to the GitHub Actions runner</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Checkout</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> actions/checkout@v4</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Install the latest version of Terraform CLI and configure the Terraform CLI configuration file with a Terraform Cloud user API token</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Setup Terraform</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> hashicorp/setup</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">terraform@v3</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Initialize a new or existing Terraform working directory by creating initial files, loading any remote state, downloading modules, etc.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Terraform Init</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">run</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> terraform init</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">ARM_CLIENT_ID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"${{ secrets.AZURE_CLIENT_ID }}"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">ARM_SUBSCRIPTION_ID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"${{ secrets.AZURE_SUBSCRIPTION_ID }}"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">ARM_TENANT_ID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"${{ secrets.AZURE_TENANT_ID }}"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">working-directory</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ./iac</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Download saved plan from artifacts  </span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Download Terraform Plan</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> actions/download</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">artifact@v4</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> tfplan</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">path</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ./iac  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Specify the directory where the tfplan should be saved</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Terraform Apply</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">run</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> terraform apply </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">auto</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">approve tfplan</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">working-directory</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ./iac</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">ARM_CLIENT_ID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"${{ secrets.AZURE_CLIENT_ID }}"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">ARM_SUBSCRIPTION_ID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"${{ secrets.AZURE_SUBSCRIPTION_ID }}"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">ARM_TENANT_ID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"${{ secrets.AZURE_TENANT_ID }}"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This GitHub Actions workflow will connect to Azure, using OIDC from a User Managed Identity, deploy the Terraform plan, and apply the changes to the Azure subscription.</p>
<p>The Terraform backend settings look like this, with the state file stored in an Azure Storage account called tfstatehackathon in a container called tfstate in the rg-terraform-hackathon-prod Resource Group. These resources were manually deployed:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">backend</span><span class="token keyword type variable" style="color:rgb(189, 147, 249);font-style:italic"> "azurerm" </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">resource_group_name</span><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"rg-terraform-hackathon-prod"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">storage_account_name</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"tfstatehackathon"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">container_name</span><span class="token plain">       </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"tfstate"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">key</span><span class="token plain">                  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"terraform.tfstate"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">use_oidc</span><span class="token plain">             </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">provider</span><span class="token keyword type variable" style="color:rgb(189, 147, 249);font-style:italic"> "azuread" </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">use_oidc</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Configure the Azure Provider with the features block</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">provider</span><span class="token keyword type variable" style="color:rgb(189, 147, 249);font-style:italic"> "azurerm" </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">skip_provider_registration</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">use_oidc</span><span class="token plain">                   </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">features</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">key_vault</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">purge_soft_delete_on_destroy</span><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">recover_soft_deleted_key_vaults</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In the GitHub repository, we have an Environment named production, and inside this is our:</p>
<table><thead><tr><th>Variable</th><th>Description</th></tr></thead><tbody><tr><td>AZURE_CLIENT_ID</td><td>The client ID of the Entra ID User assigned managed identity used for authentication</td></tr><tr><td>AZURE_SUBSCRIPTION_ID</td><td>The ID of the Azure subscription</td></tr><tr><td>AZURE_TENANT_ID</td><td>The ID of the Entra ID tenant</td></tr></tbody></table>
<p><img decoding="async" loading="lazy" alt="Hackathon - GitHub Actions" src="https://luke.geek.nz/assets/images/hackathon_GitHub_ProductionEnvironment-a65b65a571eb7da24df9314cc6819fbd.png" width="1282" height="857" class="img_ev3q"></p>
<p>The full code for this can be found in the <a href="https://github.com/lukemurraynz/HackathonRGAzureEnvironment" target="_blank" rel="noopener noreferrer">lukemurraynz/HackathonRGAzureEnvironment</a>. If you have any suggestions or improvements, feel free to open a PR <em>(Pull Request)</em>.</p>
<p>Finally, once the Hackathon is over, you can use Terraform to revert the configuration and clean up the Azure subscription; once the users are removed from the Hackathon Access packages, their Guest accounts can be Disabled; you can also configure the policy to remove them from your tenancy automatically.</p>
<p>Your Hackathon students should now be able to log in to the <a href="https://learn.microsoft.com/entra/id-governance/entitlement-management-request-access?WT.mc_id=AZ-MVP-5004796#sign-in-to-the-my-access-portal" target="_blank" rel="noopener noreferrer">My Access Portal</a>, request access, to a Team, and once approved <em>(based on the policy you specified in the Access package)</em> will be able to navigate to the Azure Portal for your tenancy '<a href="https://portal.azure.com/YOURTENANTNAMEORID" target="_blank" rel="noopener noreferrer">https://portal.azure.com/YOURTENANTNAMEORID</a>' and be able to create resources in the Azure Resource Group, and as Teams expand, you simply have to edit the CSV file and push the change.</p>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Container Patching with Azure DevOps, Trivy and Copacetic]]></title>
            <link>https://luke.geek.nz/azure/automate-container-patching-with-trivy-copacetic-azure-devops/</link>
            <guid>https://luke.geek.nz/azure/automate-container-patching-with-trivy-copacetic-azure-devops/</guid>
            <pubDate>Mon, 22 Jul 2024 09:28:31 GMT</pubDate>
            <description><![CDATA[Learn how to automate Docker container patching with Trivy, Copacetic, and Azure DevOps. This guide covers vulnerability scanning, image patching, and pushing to Azure Container Registry.]]></description>
            <content:encoded><![CDATA[<p><a href="https://project-copacetic.github.io/copacetic/website/" target="_blank" rel="noopener noreferrer">Copacetic</a> (or Copa for short) is a CLI tool written in Go and based on buildkit that can be used to directly patch container images given the vulnerability scanning results from popular tools like <a href="https://github.com/aquasecurity/trivy" target="_blank" rel="noopener noreferrer">Trivy</a>.</p>
<p><a href="https://aquasecurity.github.io/trivy/" target="_blank" rel="noopener noreferrer">Trivy</a> is a security scanner that can scan container images for vulnerabilities. It is a simple and comprehensive scanner that can be used to scan images for vulnerabilities in the OS packages, application dependencies, and language-specific packages, supplemented by vulnerability databases supplemented with Copa, which can be used to patch the vulnerabilities found by Trivy; this tool can be used to quickly patch container images without going upstream for a full rebuild, which may require more time, and the involvement of multiple teams <em>(ie Developers, Q&amp;A, Operations, Support)</em> to patch, test and deploy.</p>
<p>In this article, we will use <a href="https://azure.microsoft.com/products/devops?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure DevOps</a> to run a pipeline that will use <a href="https://aquasecurity.github.io/trivy/" target="_blank" rel="noopener noreferrer">Trivy</a> to scan a container image for vulnerabilities, and then use <a href="https://project-copacetic.github.io/copacetic/website/" target="_blank" rel="noopener noreferrer">Copa</a> to patch the vulnerabilities found by Trivy, and then push the patched image to an <a href="https://azure.microsoft.com/products/container-registry?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Container Registry (ACR)</a>.</p>
<!-- -->
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">📋Overview<a href="https://luke.geek.nz/azure/automate-container-patching-with-trivy-copacetic-azure-devops/#overview" class="hash-link" aria-label="Direct link to 📋Overview" title="Direct link to 📋Overview">​</a></h2>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p><a href="https://github.com/project-copacetic/copacetic" target="_blank" rel="noopener noreferrer">Copa</a> gives the ability to patch containers quickly without going upstream for a complete rebuild. As the window between <a href="https://www.bleepingcomputer.com/news/security/hackers-scan-for-vulnerabilities-within-15-minutes-of-disclosure/" target="_blank" rel="noopener noreferrer">vulnerability disclosure and active exploitation</a> continues to narrow, there is a growing operational need to patch critical security vulnerabilities in container images so they can be quickly redeployed into production.</p><p>In addition to filling the operational gap not met by left-shift security practices and tools, the ability of Copa to patch a container without requiring a rebuild of the container image provides other benefits:</p><p><img decoding="async" loading="lazy" alt="Container image patching" src="https://luke.geek.nz/assets/images/direct-image-patching-9660f2e54a813b9973eec665e7bacff9.png" width="624" height="230" class="img_ev3q"></p><ul>
<li>Allows users other than the image publishers also to patch container images, such as DevSecOps engineers.</li>
<li>Reduces the storage and transmission costs of redistributing patched images by only creating an additional patch layer instead of rebuilding the entire image, which usually results in different layer hashes that break layer caching.</li>
<li>Reduces the turnaround time for patching a container image by not having to wait for base image updates and being a faster operation than a full image rebuild.</li>
<li>Reduces the complexity of patching the image from running a rebuild pipeline to running a single tool on the image.</li>
</ul></div></div>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>Copa currently only supports OS package vulnerabilities and does not support application dependencies or language-specific packages. When validated and tested with developers, it is recommended to use Copa in conjunction with Trivy to patch OS package vulnerabilities and other tools to patch application dependencies and language-specific packages.</p></div></div>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>The copa tool is an extensible engine that:</p><p>Parses the needed update packages from the container image’s vulnerability report produced by a scanner like Trivy. New adapters can be written to accommodate more report formats.
Obtains and processes the needed update packages using the appropriate package manager tools such as apt, apk, etc. New adapters can be written to support more package managers.
Applies the resulting update binaries to the container image using buildkit.</p><p><img decoding="async" loading="lazy" alt="Copa" src="https://luke.geek.nz/assets/images/vulnerability-patch-e57f146e24f2c339b2f80c0bb48b95bf.png" width="624" height="242" class="img_ev3q"></p><p>This approach is motivated by the core principles of making direct container patching broadly applicable and accessible:</p><ul>
<li>Copa supports patching existing container images <em>(Devs don't need to build their images using specific tools or modify them in some way to support container patching)</em>.</li>
<li>Copa supports containers without package managers, including distro less containers</li>
<li>Copa works with the existing vulnerability scanning and mitigation ecosystems.
<em>(Image publishers don't need to create new workflows for container patching since Copa supports patching container images using the security update packages already being published today.)</em>
<em>(Consumers do not need to migrate to a new and potentially more limited support ecosystem for custom distros or change their container vulnerability scanning pipelines to include remediation since Copa can be integrated seamlessly as an extra step to patch containers based on those scanning reports.)</em></li>
<li>Copa reduces the technical expertise needed and waiting on dependencies needed to patch an image.
<em>(For OS package vulnerabilities, no specialized knowledge about a specific image is needed to be patch it as Copa relies on the vulnerability remediation knowledge already embedded in the reports produced by popular container scanning tools today.)</em></li>
</ul></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="azure-devops-deploy">🚀Azure DevOps deploy<a href="https://luke.geek.nz/azure/automate-container-patching-with-trivy-copacetic-azure-devops/#azure-devops-deploy" class="hash-link" aria-label="Direct link to 🚀Azure DevOps deploy" title="Direct link to 🚀Azure DevOps deploy">​</a></h2>
<p>So let's get started by creating a new Azure DevOps pipeline that will use Trivy to scan a container image for vulnerabilities, and then use Copa to patch the vulnerabilities found by Trivy, and then push the patched image to an Azure Container Registry (ACR).</p>
<p>First we need to create the Service Connection, we can create a <a href="https://learn.microsoft.com/azure/devops/pipelines/ecosystems/containers/publish-to-acr?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Docker Registry service connection</a>.</p>
<p><img decoding="async" loading="lazy" alt="Create Service Connection" src="https://luke.geek.nz/assets/images/docker-registry-acr-serviceconnection-899ff4e48ae4dbd6aed45af177283510.png" width="681" height="1021" class="img_ev3q"></p>
<p>Then, we can use the pipeline to connect to the Container Registry and patch the Container.</p>
<!-- -->
<p>Make sure you update the parameters, and Service Principal variable name with the up-to-date versions of Trivy, Copacetic and BuildKit, at the time you run this, and of course the container image you want to patch.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="️pipeline">🛠️Pipeline<a href="https://luke.geek.nz/azure/automate-container-patching-with-trivy-copacetic-azure-devops/#%EF%B8%8Fpipeline" class="hash-link" aria-label="Direct link to 🛠️Pipeline" title="Direct link to 🛠️Pipeline">​</a></h3>
<p>You can also find the full pipeline code at the following gist: <a href="https://gist.github.com/lukemurraynz/ea00bc9c6b6a9468a82f3b679c40a220" target="_blank" rel="noopener noreferrer">lukemurraynz/copacetic.yml</a>.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># The name of the pipeline, including the date and a revision number</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> copa_$(Date</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">yyyyMMdd)_$(Rev</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">r)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># This pipeline is not triggered automatically by any event</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">trigger</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> none</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># This pipeline is not triggered automatically by any pull request</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">pr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> none</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Parameters for the pipeline</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">parameters</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The Docker image to be patched</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># This parameter specifies the Docker image that will be patched by the pipeline.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> image</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Image To Patch</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> string</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">default</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"azcontainerregistry.azurecr.io/api-firewall:0.6.14"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The version of Trivy to be used</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Trivy is a Simple and Comprehensive Vulnerability Scanner for Containers and other Artifacts,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># suitable for CI. This parameter specifies the version of Trivy to be used in the pipeline.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> trivyVersion</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Trivy Version'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> string</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">default</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'0.53.0'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The version of Copacetic to be used</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Copacetic is a tool for checking the health of services. This parameter specifies the version</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># of Copacetic to be used in the pipeline.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> copaVersion</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Copacetic Version'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> string</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">default</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'0.7.0'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The version of BuildKit to be used</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># BuildKit is a toolkit for converting source code to build artifacts in an efficient, </span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># expressive and repeatable manner. This parameter specifies the version of BuildKit to be used in the pipeline.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> buildkitVersion</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'BuildKit Version'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> string</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">default</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'0.15.0'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Variables for the pipeline</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">variables</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The port on which BuildKit will run</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">buildkit.port</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"8888"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The name of the service connection to be used</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">serviceConnectionName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'azcontainerregistry'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The system.debug variable is set to true. This enables verbose logging for the entire pipeline.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># When this is enabled, Azure Pipelines will output more detailed logs, which can be helpful for debugging.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">system.debug</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">stages</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">stage</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> patch</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">jobs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">job</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Copacetic</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">bash</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token scalar string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # Exit immediately if a command exits with a non-zero status</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            set -e</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # Download the Trivy tarball from the specified URL</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            wget "https://github.com/aquasecurity/trivy/releases/download/v${{ parameters.trivyVersion }}/trivy_${{ parameters.trivyVersion }}_Linux-64bit.tar.gz"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # Extract the Trivy binary to /usr/local/bin</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            sudo tar -C /usr/local/bin -zxvf trivy_${{ parameters.trivyVersion }}_Linux-*.tar.gz trivy</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # Make the Trivy binary executable</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            sudo chmod +x /usr/local/bin/trivy</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # Download the Copacetic tarball from the specified URL</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            wget "https://github.com/project-copacetic/copacetic/releases/download/v${{ parameters.copaVersion }}/copa_${{ parameters.copaVersion }}_linux_amd64.tar.gz"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # Extract the Copacetic binary to /usr/local/bin</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            sudo tar -C /usr/local/bin -zxvf copa_${{ parameters.copaVersion }}_*.tar.gz copa</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # Make the Copacetic binary executable</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            sudo chmod +x /usr/local/bin/copa</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Download and Install Trivy and Copa</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">bash</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token scalar string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # This script is used to run a new Docker container in the background.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # 'set -e' is used to exit the script immediately if a command exits with a non-zero status.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            set -e</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # The 'docker run' command is used to start a new Docker container.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # The '--detach' option is used to run the container in the background and print the new container ID.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # The '--rm' option is used to automatically remove the container when it exits.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # The '--privileged' option is used to give extended privileges to this container.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # The '-p' option is used to publish the container's port to the host.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # The '--name' option is used to assign a name to the container.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # The '--entrypoint' option is used to overwrite the default ENTRYPOINT of the image.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # The '--addr' option is used to specify the listening address of the BuildKit daemon.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            docker run \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">              --detach \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">              --rm \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">              --privileged \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">              -p 127.0.0.1:$(buildkit.port):$(buildkit.port)/tcp \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">              --name buildkitd \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">              --entrypoint buildkitd \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">              "moby/buildkit:v${{ parameters.buildkitVersion }}" \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">              --addr tcp://0.0.0.0:$(buildkit.port)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Run Buildkit</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Docker@2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Login to ACR</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">command</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> login</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">containerRegistry</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> $(serviceConnectionName)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token comment" style="color:rgb(98, 114, 164)"># This task uses the Docker@2 task to log in to Azure Container Registry (ACR)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token comment" style="color:rgb(98, 114, 164)"># The 'command: login' input tells the task to perform a 'docker login' command</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token comment" style="color:rgb(98, 114, 164)"># The 'containerRegistry: $(serviceConnectionName)' input specifies the service connection to use for logging in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token comment" style="color:rgb(98, 114, 164)"># The service connection contains the credentials needed to authenticate with ACR</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">bash</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token scalar string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # Exit immediately if a command exits with a non-zero status</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            set -e</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # Extract the tag from the image name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            tag=${IMAGE#*:}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # Extract the repository from the image name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            repo=${IMAGE%:*}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # Scan the image with Trivy and store the output as a JSON file named copa-patch.json</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            stdbuf -oL trivy image --vuln-type os --ignore-unfixed $IMAGE | grep Total</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token comment" style="color:rgb(98, 114, 164)"># The image to be patched</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">IMAGE</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> parameters.image </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Scan image for DevOps Output</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">bash</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token scalar string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # Exit immediately if a command exits with a non-zero status</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            set -e</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # Extract the tag from the image name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            tag=${IMAGE#*:}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # Extract the repository from the image name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            repo=${IMAGE%:*}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # Scan the image with Trivy and store the output as a JSON file named copa-patch.json</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            stdbuf -oL trivy image --vuln-type os --ignore-unfixed -f json $IMAGE | tee copa-patch.json</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # Use the scan result to patch the image, if needed</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            copa patch \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">              -i $IMAGE \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">              -r copa-patch.json \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">              -t $tag-patched \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">              -a tcp://0.0.0.0:$(buildkit.port)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            docker save -o patched-image.tar $repo:$tag-patched</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # The 'copa patch' command is used to patch the image.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # '-i $IMAGE' specifies the image to be patched.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # '-r copa-patch.json' specifies the file containing the scan results.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # '-t $tag-patched' specifies the tag for the patched image.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # '-a tcp://0.0.0.0:$(buildkit.port)' specifies the address of the BuildKit daemon.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # The 'docker save' command is used to save the new patched image as a tar file that can be used later.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token comment" style="color:rgb(98, 114, 164)"># The image to be patched</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">IMAGE</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> parameters.image </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Scan and Patch Image</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> PublishPipelineArtifact@1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">targetPath</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> $(System.DefaultWorkingDirectory)/copa</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">patch.json</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">artifactName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> scan_results</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Upload Scan Results as a pipeline artifact</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token comment" style="color:rgb(98, 114, 164)"># This task uses the PublishPipelineArtifact@1 task to upload the scan results as a pipeline artifact</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token comment" style="color:rgb(98, 114, 164)"># The 'targetPath: $(System.DefaultWorkingDirectory)/copa-patch.json' input specifies the file to upload</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token comment" style="color:rgb(98, 114, 164)"># The 'artifactName: scan_results' input specifies the name of the artifact in the pipeline</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> PublishPipelineArtifact@1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">targetPath</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> $(System.DefaultWorkingDirectory)/patched</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">image.tar</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">artifactName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> patched</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Upload patched image as a pipeline artifact</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token comment" style="color:rgb(98, 114, 164)"># This task uses the PublishPipelineArtifact@1 task to upload the patched image as a pipeline artifact</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token comment" style="color:rgb(98, 114, 164)"># The 'targetPath: $(System.DefaultWorkingDirectory)/patched-image.tar' input specifies the file to upload</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token comment" style="color:rgb(98, 114, 164)"># The 'artifactName: patched' input specifies the name of the artifact in the pipeline</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">bash</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token scalar string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # Exit immediately if a command exits with a non-zero status</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            set -e</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # Print each command that is executed to the terminal</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            set -x</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # Extract the tag from the image name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            tag=${IMAGE#*:}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # Extract the repository from the image name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            repo=${IMAGE%:*}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # Tag the patched image with the appropriate repository name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # The 'docker tag' command creates a new alias for the image</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # The format is 'docker tag source_image target_image'</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # In this case, the source and target images are the same, so this command effectively does nothing</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            docker tag $repo:$tag-patched $repo:$tag-patched</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # Push the patched image back to Azure Container Registry</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # The 'docker push' command pushes an image or a repository to a registry</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            docker push $repo:$tag-patched</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token comment" style="color:rgb(98, 114, 164)"># The image to be patched</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">IMAGE</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> parameters.image </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Push Patched Image to ACR</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>For demo purposes, I am using an older version of the <a href="https://hub.docker.com/_/api-firewall" target="_blank" rel="noopener noreferrer">api-firewall</a> image, which has known vulnerabilities that must be patched.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="deployment-results">✅Deployment results<a href="https://luke.geek.nz/azure/automate-container-patching-with-trivy-copacetic-azure-devops/#deployment-results" class="hash-link" aria-label="Direct link to ✅Deployment results" title="Direct link to ✅Deployment results">​</a></h3>
<p>Let's look at the image in Azure Container Registry before the patch.</p>
<p><img decoding="async" loading="lazy" alt="API FW Before Patch" src="https://luke.geek.nz/assets/images/api-firewall-acr-beforecopapatch-f7b59d864bc68fe82c35a4dd0962e007.png" width="1603" height="574" class="img_ev3q"></p>
<p>Now, let us deploy the pipeline and see the results.</p>
<p><img decoding="async" loading="lazy" alt="API FW Before Patch" src="https://luke.geek.nz/assets/images/api-firewall-ado-beforecopapatch-888841a2192db7c95f253180b5f7eeb8.png" width="1840" height="943" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="Copa ADO pipeline" src="https://luke.geek.nz/assets/images/copa-pipelinerun-f0ba56d6bbe249b36261d27d157b6870.gif" width="2238" height="1190" class="img_ev3q"></p>
<p>After the pipeline has run, we can see the patched image in the Azure Container Registry.</p>
<p><img decoding="async" loading="lazy" alt="API Firewall" src="https://luke.geek.nz/assets/images/api-firewall-acr-aftercopapatch-7ed500a7d4a5bbc90c4794f10f0792de.png" width="1552" height="552" class="img_ev3q"></p>
<p>If we re-run the pipeline again, this time targetting our new patched image, we can see that there are no patchable vulnerabilities found.</p>
<p><img decoding="async" loading="lazy" alt="Copa ADO pipeline" src="https://luke.geek.nz/assets/images/copa-pipelinererun-7b0415f1a2bdb060abffb91500174d26.gif" width="2238" height="1190" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>Remember that Copacetic is a tool that can be used to quickly patch container images without going upstream for a full rebuild - HOWEVER, it does not replace the need to do a full rebuild of the image, as it only patches OS package vulnerabilities, and does not support application dependencies or language-specific packages. It is also recommended not to layer patch on top of patch, as this can lead to a bloated image, and potential conflicts between patches, consider patching the same base image other an an already patched image, if new updates occur.</p></div></div>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Push Docker Images to Azure Container Registry with GitHub Codespaces]]></title>
            <link>https://luke.geek.nz/azure/push-docker-images-to-acr-using-github-codespaces/</link>
            <guid>https://luke.geek.nz/azure/push-docker-images-to-acr-using-github-codespaces/</guid>
            <pubDate>Tue, 16 Jul 2024 09:16:17 GMT</pubDate>
            <description><![CDATA[This article guides you through pulling and pushing Docker images from DockerHub to Azure Container Registry using GitHub Codespaces.]]></description>
            <content:encoded><![CDATA[<p><a href="https://github.com/features/codespaces" target="_blank" rel="noopener noreferrer">GitHub Codespaces</a> already have Docker preinstalled as a dependency for the Codespaces environment. This article will guide you through pulling and pushing a Docker image from DockerHub to Azure Container Registry using GitHub Codespaces.</p>
<!-- -->
<p>Pushing a container from Docker Hub to your own Azure Container Registry (ACR) can offer several benefits:</p>
<ul>
<li>Security: You can control who can access your container images, and gives you more control over vulnerability scanning.</li>
<li>Network latency: You can reduce network latency by hosting your container images closer to your deployment targets.</li>
<li>Compliance: You can meet compliance requirements by storing your container images in a specific region.</li>
<li>Integration: You can integrate your container images with other Azure services.</li>
</ul>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>This article assumes you have an <a href="https://learn.microsoft.com/azure/container-registry/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Container Registry</a> already provisioned, you don't need a <a href="https://hub.docker.com/" target="_blank" rel="noopener noreferrer">DockerHub</a> account, if you are pulling from the public repository.</p></div></div>
<ol>
<li>Launch a Codespace, for example: <a href="https://github.com/lukemurraynz/Codespace_IaC_Coding" target="_blank" rel="noopener noreferrer">lukemurraynz/Codespace_IaC_Coding</a>
<img decoding="async" loading="lazy" alt="Open Codespace" src="https://luke.geek.nz/assets/images/Open_IAC_Codespace-4219be529162c1b4167674a9b8a54953.gif" width="2027" height="1021" class="img_ev3q"></li>
<li>Install the <a href="https://marketplace.visualstudio.com/items?itemName=ms-azuretools.vscode-docker" target="_blank" rel="noopener noreferrer">Docker extension</a> for Visual Studio Code in the Codespace</li>
<li>Open the Docker extension and sign in to DockerHub
<img decoding="async" loading="lazy" alt="Install Docker Extension" src="https://luke.geek.nz/assets/images/Open_IAC_Codespace_InstallDockerExtension-f91ef7a3a2bf724a2c09ca9f1e698b5c.gif" width="1888" height="960" class="img_ev3q"></li>
<li>Now we need to log to our Azure Registry; under Registry, select Azure, and connect and log in to your Azure account</li>
<li>Now, we don't have any images, so we need to pull them down from the docker hub. Open the terminal and run the following command:</li>
</ol>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Replace <code>api-firewall:0.6.14</code> with the image and tag you want to pull from DockerHub.</p></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">docker</span><span class="token plain"> pull api-firewall:0.6.14</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="6">
<li>Now that our image is pulled down from the Dockerhub, we need to tag it with our Azure Container Registry and push it. We can do this directly from the Docker extension.</li>
<li>Right-click and select Push</li>
<li>Select Azure as the provider, and select your Azure Container Registry</li>
<li>Now, we need to tag the image with the Azure Container Registry to push it. You can adjust the name and Tag and click OK to Push it.
<img decoding="async" loading="lazy" alt="Push Azure Container Registry" src="https://luke.geek.nz/assets/images/Open_IAC_Codespace_PushContainerACR-6ecce687b3cbfa1c309cf00a3a51cfec.gif" width="1888" height="960" class="img_ev3q"></li>
<li>Now, navigate to your Azure Container Registry in the Azure Portal, and you should see your new image in the repository.
<img decoding="async" loading="lazy" alt="Azure Container Registry" src="https://luke.geek.nz/assets/images/Open_IAC_Codespace_PushedACR-7e4c5116a25736135dfe13d6d862aaa7.png" width="1875" height="806" class="img_ev3q"></li>
</ol>
<p>You have now successfully pulled and pushed a Docker image from DockerHub to Azure Container Registry using GitHub Codespaces.</p>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Unable to delete DevCenter Project]]></title>
            <link>https://luke.geek.nz/azure/devcenter-project-deletion-issues/</link>
            <guid>https://luke.geek.nz/azure/devcenter-project-deletion-issues/</guid>
            <pubDate>Mon, 15 Jul 2024 08:19:49 GMT</pubDate>
            <description><![CDATA[This article provides solutions to common problems encountered when trying to delete a DevCenter project.]]></description>
            <content:encoded><![CDATA[<p>When attempting to delete a devcenter project, you may encounter the following error:</p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>This resource is in a failed state.</p></div></div>
<p><img decoding="async" loading="lazy" alt="This resource is in a failed state" src="https://luke.geek.nz/assets/images/devcenter-failed-delete-project-85db72d48ef193b193175fa5259a214e.png" width="1667" height="765" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>The error message usually occurs when environments are created for these projects. This prevents the deletion of the Environment Type / Project / DevCenter. This behavior is designed to prevent accidental deletion.</p></div></div>
<ol>
<li>Sign-in to the <a href="https://azure.microsoft.com/get-started/azure-portal?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Portal</a> go to the project page.</li>
<li>Select Access Control (IAM) in the left panel, then click Add and choose Add role assignment
<img decoding="async" loading="lazy" alt="Dev Center - RBAC (Role Based Access Control)" src="https://luke.geek.nz/assets/images/devcenter-projectadmin-assignrole-255cb29911a82c7bfaddfaebf3dba4d6.png" width="626" height="162" class="img_ev3q"></li>
<li>Search the <strong>DevCenter Project Admin</strong> and grant this role to yourself. <strong>You still need to assign this role - even if you have Owner permissions.</strong>
<img decoding="async" loading="lazy" alt="DevCenter - Assign Project Admin role" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAApIAAAByCAIAAABvMaaaAAAAA3NCSVQICAjb4U/gAAAgAElEQVR4nO3df1BTZ74w8C+o4P4A+0N7+3r0VqJtT9I7hbn7lus79tCyCbUJ+9IcemvtWklrDWyvdnxJriPYTrUzq6TjJq7T2lZoLcH6+utKct1KaoHFctaZXna6C52WHN9qcCuHe29h7RZaFUXy/nF+5CQ5IQkkhOj3M8wYDuc8z3Oe5Dzf83zPA2b4/X5ACCGEUDrITHUDEEIIIRQrDNsIIYRQ2sCwjRBCCKUNDNsIIYRQ2sCwjRBCCKUNDNsIIYRQ2sCwjRBCCKUNDNsIIYRQ2pjN/zM8PHzsyOFLl/6a2tYghNLCHXfcuWr16pyc3FQ3BKFbTgb/V9Lea9j36KM/X3rvvaluD0IoDZz/6qvTpzteMFemuiEI3XKE2falS5cwZiOEYrT03nubm/9tmiv1A1y97r86Nn593D8+DjfHn2XOAJiVCbMzM+bOzpw7JyMjQcXelH2VWEnq+WkwO8b9Tvt+aPrT3waGx/wAmruyLdSdi+fNSWrLEEKIN+6H76+N/3BtPNUNSTw/wNg4jI37r47dgKvwk6zMn2ZlZk4hhtzEfZVYCe/5aRNT2GYuXN5z5q/vPUnc8eNZAPD/hq6t/r8Xj/zy7xfNizXqI4TQ5FwdG//blfFbZL74w7Xxy9fGb5ubOXfOZNYL31J9lVhT7PnpFL19Y+Ng+fA/D65ezMdsALhvftae//0/qj/8zyS3DSGUrhr3vzcyMiLfMjIy0rj/vXjLGRkd//YWi0N+gG+vjn8f/3T5FuyrxJp0z0+z6GH7i/+6+qjqJz+eE5Q7+J+LfnTpyo2ktQohlN6eoMsb6t8Z/u47/tvh775rqH/nCbo8rkKuXE+DMTRJRkbHL1+P49xv5b5KrHh7fvpFD9s/XB/Pnq2wW1o8A5hejFVNWpnprM4SY22MhdTEui9CCXD77bevX1/57rv133777bfffvvuu/Xr11fefvvtsZcwOjb+t6szevRMtu+ujo+OxdQD2FeJFXvPp0T0sP0Pfzf3tO+HkI0Dw2ORozbXRJMadeBr0pGMsUyhEMaioZ3cpKq1yhpfHkcZlN3L2ql4arJMVD7nNGpiDswToxxsryOeliE0Zbnz5q03Vzkb9zc53zdXVuXOmxfX4ZevY7o31k7Avkq4mdyl0cP2vLmZK+758Wvtg9KWazf8LxznXv75XZEPImva2F4v/9UAlZOY6jFWNVkFDWIh7fmuycXgyTHsExufZ9NO4wRajnHYVHp9ixsnyShtZWRk+P0wPu4HiC87d2Pcf3Vs5o6bMh1blhEFy4iCxxoGpG2dLxYsIwo2dQDAmU1EwTJiS+ckS7865r8R7Wl1+vRVAl08+BhRsIwoWPbiGWlbf4NReiNkb8HkxNLzqRI9bJ8dvHba98O1sfGifX3bWr+p/ei/De//5f+suPORvB/HVgVl9zboPfYmIepKc1kjvyV4xikkfhmLua+mXTZBJCocJgKE/YPnwYxVbWxinOV8sRYG+HlqZQuwdSXSNJ0TdxDnr5zTqLE4m2hywhktZakh+3ycUIvTItXLOY2a4BMR9hFPJaydIM9DlDs/a6LJKg+wNq1yAxiXR0/baYPHFfRDqVjZzUSgbcJ2xhKyj9TJjIUsdzJiMzBvjpKIf5793PPrnnt+nfw5dyxGb8Q3YoqDeODL+P7FONs7KZ1HT/EvfAc6+pNSQ9SuiLevJPwtBf8V+cbi4sHHJn/bkSz9Hx3z8a9OnEha2ybdsckWJWx/8d+j5R98fXD1oh0r/67l+XuKl/5kw/+6s239kpX3/TSeWiijnnW3cQBcE22GerbXy/a20W6dhQGgaAP/MwAhVlHAuD2kUUeEF8Q5jeIUvN3olubBrM0Bb3jZXm+D3mO2MkCY3L31BiBrW4WsNWPVuYx8AqAeqqTkuccFb7K93hjTx6yth+71ss0mAhhLiU0lzMjFE4nWTq6J1rqN7fwk3gh3V7jYfXoga9oVG8C4WvQ0BRQtu+ORF8saXWZPWNt66w2eSlLjkl4rBGbWZoc32V4vu0/fUoWBGyWH/Hm2/Dl3jIdfiTNFueZjrvsc1316+xIo23uO6z7HuZ9fHH+r43bm+AmApStLlwKcP9aalBuFq9G6It6+AgA+SbABPug+x3Wf47rPffrgcVm2YMYbaD1wAWBlaRkAnDo++Sn1xKL2fKpMFLY//6+rTzT95d/WLF52ZxYA/DQr81HVTyb3u9qqfBIAgLHboNbCxyhCZyR9fRwARevZHv7OSYhVAACqPIWozThsUGMVjtca+XkwAJA1b/JzccqoB3FjAOe0e/TWCr5AWXUgbYyEc75kA/EGghSr5pocLfp6MdYSpurQVLZSO7k2N9S+IaQMqArThBVzzt0eg5EC2R1PSLFAORr0gQPEtlG0Pui1ry/s0QJZs5c/a4o2KHQWQonw726XufJX0vPs3HnzzJW/+ne3K8bDr095onNmk3zC3bFlWdHBfhh4v6hgU4c0y5RNIsVc97Kig+GT5s4Xg3LgAR0nTgLAA2Wb1y4BuHDoo2REvmvRumISfXVm07NnX/60e0+xuGHxmj3mhSDmmQOd07Fl2fJdPji1LvAUQOq94O4VU9adLwZS07LSpJ3PbCKM7zdsWUYUPLbrLfk8vr/BuOzF4GZGmuhf7Dh0HmDpg5tXrQSAk0fPhO+SCFF7PlUihu3PuKu/aPyLa+3fq+/Knno1vh42T0UAAJ+41qhJjVprY/n4SRn5sMc5d/eJQV0p3gAAAGvTCVniEvF4OeH+IJzHLOa0zZ6IhUtaqviddS5jm1sptJP5qqBKw8JfWDsDXRAd1+ZixfsXyloLUjZC+W5msiJ2FkJT9dzz63JycuRbcnJynnt+XYyHT328XPFkWSCOdh49VframkUAAHDy2RNPClPzs+v4IH3x4GPPwn5+49pjj74YaxjgM+Slq1YsevwpVbLy5FG7Iv6+6jhxculTJQrZiIHWPz11mus+x3XvLzu17sUzUPz6uU83q2Dlfq77Y/NCgIH3i8Q5+qdPHVq+pROCeu/cqhPrTki1bHl0+/3CdmlnAIALO/5Udo7r/niz8Zml0lx5oPUAvLw1pubzGXLV2uJFxWWlkLw8+QwN2hP8lbQnP/jatfaeB++em4BKOOduj6HaAcAA6BvClzRTtKHKxVjyXWDcK06azbvbOKUpqWFfaEo5pjQvWdPeHFzahIE7vJYQbI8PQCzP18Pm0QSA/B4irATGBX0+DqgYwi7X7maBNWtkSXAHY7JTwN/NCEVwvr7oRSF0qypatdJ3tA9gIcCZ4ydWPvm2sL30g9eLAABgkXlz6fZdrRfXLN25C7a3CBsff0p14EI/rFgkL+rt7o8Vajhz/AQArHyyGACWqAF854+1XlyT6OR8cn7T9oElixS2Lnz+7TX8q6JVK+Fo2M879uyAzaf5Ofri4meWHjt/EUDWe1D8+v6yU8cBAAbe33aq9INuYfviNa+U7Tre8XpRMQAseXnrCr66krVLDp0bgOKFcLHjEDy1P6TrFq/5mFsT1gg+Q77kmccXAkDBUjh5/pRYcmLN2N9xjjjbvrDlvp8RiYnZ5bq6PD6lTNH8s+dQFK33uBw9UjoaKGst2LRBi7ksTg4o46QexxI6GmwbmhKWDia0RjLw2DiQ0JYotZOi9WzdS+IyuqYJ1sUzdhvUtnqlpfhsaw3pcTF8wtxmZ8S96thEnRBCM8ysBAyZxWWl/Dys48TJsrIihT3yCpYKr3zbDUI6d/ku3/nPQ7N4ivgMOZxaRxQsIzacBEhOnjwz2rrhSfXVlxeUEwNSuvvZU8oHnt/1qJD3Nuw4f6H7HACAetlCpV2XFCwLfKP6xyXec6Gds+jxp+BARz9A/0fHYG2x0p1EGD5DDhd2LOfbAJCsPHnUnk+VJLUrkCLW6HqqA7/NTNnbavsqxR8Ffq+aMupbPH20VpqKEqZmb0OeTStmtjeA1UQAUI72mj5z2BJuJZS1BsSV5ISpuV4VaNKU12ERJndrja8qcIKhU3OldlL2wBmZe1QEiHcnISu6GVdLyHo8QkeTHnsTF1Ssm5Y/20bopjInEXF7xebtZ493QOfRU6WrVijt0Nd9/v6liwEASqXFWVz3Oe51pRgfSlpDLpeEPPmcaH/ZKv6+Ki4rVVxA17Fl2bYH+ST5uQ9WKh8rrPgTvvin47J4PHD+S2lXIajzfH+6oBDdF6955YFjrRcHWg8AP3uOKrCGXC4pefKoPZ8qyfi/QIgKF1sR8YemZq8pfDPlYHvDttm9rD164ZTdGwiahMndrLgn5ej1OoIb4g6rUaHASBsJk7tX4TykZ8+KnRB2Rkq9QTnY0OoDuwUXKzRJ3jbl11KZQYUTpuZYVwghNK2yZmUk4HeRFz3+lHfnluNfbt4sy6Ce3HZwc/GaRQCdL244WbZ3DwCsWrnu2S1PRo7WnS8W/PofWz42y+MKnyFf8vKn4pL1iwcfE2bq4XndqcieHSV4TKKvVmzevuvR5UaQNX7TR8Wb4Sw8UMZPeTuPngIoCz2uuKz02Q2bVsnWsvEPI57d02l+vQgAOvbsOA+lAHwCfIfUqxcP/vrEylfeDi0PAIpW3f/rnXvggc0fhz9cuHjwseWfvxL0vvAZcij9QGrDmU3EhpNw9vxFUIUVMDVRez5VZmoWIB0xLk/QSjWE0CQp/kHl+C0ufubLU97g7GvpWlhHFCwjCtZ9ufn02ysAAIpfP7397Drxl5iVF42H4jPkwmRdqGspJOH3kaJ2xWT6apHZfe6D+3csF39vew1sNi9cZH7r5S838FuOgzjbXrzmlTJpJfmKPZ9u9j5bELTqXt57R8v2lwWqCGwPjb4yxWXqE6fUyumQcHyGXJ5+X/FkGSTn8USCPoSJl+H3+wFg1+t1m7fUproxaYuxaCpbAMga5WXnCN2Ekj1oXLp8Y+p/72Lg/aJ/gYPS73APvF9k6H4taLI4s82dnXH7j2ZF3S0hfZUQIR0eizObiBMTpDpSJMaeTwn8D7MTISwDjxCaotzszMHLU/xvBjv27Hhg87np+LsrSZKbHdOELxF9lQj9Df+yA546HU+H9zfs8m5/a4bFbIi551MCwzZCaCaaPStj3tzM7yb7H1vxjzxX7udizL7OQPPmZs6KbVXUFPtqajq2yJadr9zPrYlpQTiIqwGWbj7dGdNitGkUe8+nhJAkf6+h/tFHi5fee2+q24MQSgPnvvrqdEf7+spfJbuikdFb9L+R/mlWZk6cE75btq8SaxI9P82EsD08PHzsyKFLly6luj0IoTRwxx13/POqp+fNu20a6rp6ffxvV2fqf8aUBBkAt/0oc+6k1kPdan2VWFPp+ekkhG2EEJqxboz7v7s6PkNWXSVV9qyMKWZob52+Sqyp9/y0wbCNEEoP1274r93wXxvzj/n94+Mz909GxyUDIDMTZmdkzJmVkT07IysRf2cGbtK+Sqwk9fw0wLCNEEIIpY2ZnsRHCCGEkATDNkIIIZQ2MGwjhBBCaQPDNkIIIZQ2MGwjhBLjs88+S3UTELr5YdhGCCGE0gaGbYQQQihtYNhGCCGE0gaGbYQQQihtYNhGCCGE0gaGbYQQQihtYNhGCCGE0gaGbYQQQihtYNhGCCGE0gaGbYQQQihtYNhGCCGE0kZ6hO2xsbFf/vKXv/vd71LdEITQTDLqddXtbPElbf8Y4OiEplnUsM010aRGrXV4ZZucRo3awiSzWXLXr19fu3Ztb2/vq6++2tzcPF3VIoSmiB89hK9/op62Hu4eTmwNw6yn6bCbHZxgF+/hitIKJxfz/nHB0QlNvxhn29y7G+3e6Lsl3vXr11etWkXTtE6ne+eddw4cOHD8+HH5Djdu3Lhy5UoqmoYQioHW/kkn86HzTYsh+4+vrV5OOxM5111A13s/rzcsmGCXoa6uvpE49o9d1NFpZGTk/PnzCakLIUlsYfthg36k4eWG8MtttKehorSQ1KhJTaGxrmsYAIBzlqtJa4Nro/ZBjfpB3XZm2Me/JovMLrGIYabO+E9qUqN+qHx72wS3vmazee3atatWrQKArKyso0ePulwuj8cj7XD58uWBgYGYzxchNL2ychcsWKAq1D1d2/RhvWE+W+doGwUAxUFguMtu0j6oUZOaQr2jGwAABtu2r36oQE1q1A9tbBkEYKxqstyys5IiNbST40cbBgCAsZAaeqfLub5ITWrytRtdPn5jlQeArStRk+VODmT7wzDjqNDyJZdudPbweYCg4Us+ZCmIOjp99dVXb7/9dqI7FN3qYgvbOfS2nQbOYQkL3ENDWfRvXF2f/oermmAPbLT3iD/wtPgqmjyNFaqBI+blpjZtQ/uHO7Wjf6jlr9ie7YaqFqLmZM+f27YubNn4TOSZ/G9/+9vy8nLp2zlz5jQ2Nj788MPxnSVCaAbIpczGhfD79i5QHgSY10wNHLX3k//o+sRemDMCMMxYyzceHaXfOMl8cnKravQaXw77x6GnT7K9LhMRUgF7+MhQ5aHO9saKnN9vNTu8ULid+Y0WIM98qJNpXC3fvXt7qfndEUN9G/PJya15PXXPbHRJ8wdPi6+iSRyyWkYjnQ6OTiglYl2Slqvbvk3L7rbWBwduQmui1URubq7aYCRhZER6cKXfYC0kiMIKmgQg12+lVQtUNP0wwAA3BMAcOTJErt9Kq7KzCfrph2HgD12R6r3tttv4F36/n38xe/bsnJyc+M4SITQj5M7PBRgFxUGAGx0dBbg2NDSSnbuAes1MwWB7g2fo4R3OrZRqwQIVbaGFuLvQaNbmKhWft3GntZBYQBRaN+qB+0MXl527ICcLIHv+/AULcrNlezJHjg4R63daC4kFC1T0Nksh/NH1BzFu6zdYC4kFKnr1wwB9HBfpZHB0QikR+0ryXMNO+89Zx786fbKbz1Guzb5xtVZHPVRiY4N2l10heSoiaBPnYwFYm5ZfqFLlAYTQrWHQx8FCYr7yIJCt2+msmN9V+4uCB3UbXT4AtqsL8grzwyJ07nzFoA2QnS2OMtnKO4g4nxcgP18tfLtg/nyA4ZFrUjmBPfu8EcM2QikxO459c0t32luWWy3v6oUNo22Wkpe4tc6mnfnEyGFjiS22cghVHkDWNubw6sQsDEEIpYXhloajI8R6gxqIIeVBoHBrc5d1sMteZar9V2fhGyQJ7h52FFRRorBodFSYVIwOR0xtAwAAoVIDdPV4QasGABgcGgIg5s8HGIr/rBCaXvH93nauoe43WtbtESbWQxwHAPNzskaHuo642QkPlSs06nM+31vb1MUNDg76mJ1HIubII/rmm2+44OTVDz/8cPbs2bgLQggl1bXhwcFBX1fbke36Ims7WdNgUYPyIMAd3m7vGhyF7PlEFgAAEDqahHbbRmcXN8h5Dztc0Sa+fU0Ol29w0Oey1v0eCtcaCADIzc0BtquLCw7k1NOr5nPvbrV3cYODPtdrjq75xtXaGG8Oojl06NBbb70FABkZGfwWr9f7wgsvJKZ0dMuL98+t5Bq21T0kfkPQW9eS3O5yqsTcRhSSMReSTdUd2ZbP7TVpHyminqnjskIXlihYuXLl3XffLX171113ff/9919//TX/LR+z77nnntjPBCE0HdqtjxRRvzDV7mXVtYe6mk0qAFAeBLLmX2vf8EhB/vLSN6/p7b8xEUCYGg/VPuizP6ejSkyHh+dnRamLNBT2mEuKDC93zV/rfJNeAACQX7HxoZz2l3WFzzjlUb9ge/Obq7IPV+qoR0p3DmjfPF5HTTpqh4xOTz/99J///Oddu3YBQEZGxhdffLFu3bpXX311ssUjFCRDWkyRjs6ePXvjxo2xsbHr168/8MADc+fOTXWLELp1ffbZZz/72c9SVTtjIav6alvDl5enwvj4uNlsvnz58qVLly5dunTs2LElS5akulHoJpEef9w0kvvuuw8Arly5otFoMGYjhGaIzMzM+vp6AOjr6zty5AjGbJRA8SxJm3kyMjI0Gk2qW4EQQqFmzZp16NChVLcC3YTSO2wjhBCPcrC9qW4DQtMgvZPkCCGE0C0FwzZCCCGUNjBsI4QQQmkDwzZCCCGUNjBsI4QQQmkDwzZCCCGUNjBsI4QQQmkDwzZCCCGUNjBsI4QQQmlD+Ctpl4a+SW07EEI3ARxJEEq29P4fwBBCCKFbCibJEUIIobSBYRshhBBKGxi2EUIIobSBYRshhBBKGxi2EUIIobSBYRshhBBKGxi2EUIIobSBYRshhBBKGxi2EUIIobSBYRshhBBKGxi2I2GsatLKTGd1lhhrYyykJtZ9EbpZcM5ytbGJC99sLHeGbUUzFec0amh8w6YkatjmmmhSow58TTqSMZYpFMJYJvtOM1ZZ4+O5vCm7l7VT8dRkmah8zmnUxByYJ0Y52F5HPC1DKDWCR48pfvwJU7PXXUEkqGkpNPnR7GZAmNy9LlMcbyPnLE/QyHnTiGW2Tda0sb1e/qsBKidx+TFWNVkFDWIh7fmu6fzUGvaJjc+zaadxAi3HOGwqvb7FjZ8+dGuRRo/2mj4zTosRmrp4k+SU3dug99jFVJU0lxWSV8EzTiHxy1jMfTXtsgkiUeEQ7rakKbh4FGNVG5sYZ7ns9pxzGjWVLcDWlUjTdE7cQbwL45xGjcXZRJMTzmgpSw3Z5+OEWpwWqV7OadQEn4iwj3gqYe0E+Uyi3PlZE01WeYC1aZUbwLg8etpOGzyuoB9KxcpuJgJtE7YzlpB9pE5mLGS5kxGbgTekaCYjKiwGtscHwufWaVWTwqQzcDmL11fwBEtIg8s3SofQTp+sjsCFLB0dNlbI9y5XyP/Jr2suwpbQcQ/Ch4gI9U44mimm66IPCLLhS94/FkbcUypWYc/gzmRkTxyUBj35IYHypd4OfWflyc5A04xR3h2pWL4KXR0LLVVhzQgb82N4U4KSvrK+CiQ/uCZaHsuUzyVSGFJsQ1L4o+h3Gp9w9gdt6qy+n27s9/v7ncb7LZ38Xo00Wd3p9/s7q9XGxn5xP3V1p9/faSFDSxCKbnxCXd0p1sIX1Wkh7xdL6LSQYvnyYuUFitv7G59QK9fSaSGFOvga6cZ+oRZpc2e1WtpHOhFZLUrt7Hca+U7w+/2dzsZ+Wbco6KyWzi7QSFmx/s7q+9WBesW2dVarg15Xi50hVNRZfb901p3VsjNCaEYIHj2EAUH+afcHXebB15ds4xPOfuVr09/fSJPidScbJcRrJOLg4/f7+xurA8OIUHL4da28JWTck1/L4klFrDdsNAs//aC9ow0I/c7qwFkLP+1vpEn5a74xSntG6EylQS+o7wLly7oo+J2Vd11g1JKVrDCSywe6/sbGTr/8fQ9pgnzMj+VN8fc3PhEUnoxCg+jA2xH4xEb8lPY3OkMGc6EoxbcvKSazJE2VTwIAMHYb1Fr4KTShM5K+Pg6AovX8HTUA42rR0/yPVXkKjzIYhw1qrMLxWiM/DwYAsuZNfi5OGfUgbgzgnHaP3io84pJVB9LGSDjnSzYw6gihFqFqrsnRoq8XUwGEqTo0la3UTq7NDbVvCCkDqmLiJzWcc7fHYKT4M2LdbVxYsUA5GvSBA8S2UbQ+6LWvL+wOjqzZy581RRsUOguhmYKxVkoDguzyc9o9+gZxEQlRYeEzUrIBgWtzA62VXWFBIwBheqOG5Dc3OVr0FvGapPmZvSqflAaIUITJERhGhKLDruvwLUrjHqFSBV99E9UrF+H0Q0w8IASSlxRtkB1l2MePaoTOKDRGYc8InRlpcJYTy+fzKOK4Jr2zfEeJXQeUtRbEfRSqFkdyxhUYjQmTKcoSHunwmN4UxmEDMbgAUNYacLVPOGLKzsUVeJsIUwWl2HgiL2+axuDZkzjG18Pm0QQAAFtXoq6Ttut9AARl1JvdjINSOXf31b4hnLSvjwNKIbSxNh1pCzo+iHB/EM5j1nikb8h8DlQTtbelSt3C71nTprikhcyXHa/KJ/t8HAR9XsLaqZK6IDquzcXqhbefstbu3tjGmfiPjuLdzGRF7CyEUihw7ejrldd4Kl5+hI6GjW2cyeSz1+VZWGKCQ2Q8lWTwwEBVuBqsalKjXDtjVZvF/Q1GkA9tovAtoDTuUY5Wn7FEXQdkbavLRAAxYb0xnP5ER4RhLJrKFrE1dNiPibw86Im8Z4TODB+cIzcq0uCTpwocQ6jyWJcPgsfq0JGcg75I72000d8UCB5yibw81h3aIGWcz6fQrLAwVOFo76O1GhuQNe3N8ay6i1f8YZtz7vYYqh0ADIC+IXxJM0UbqlyMJd8Fxr3ipNm8u41TmpIa9nlDjo/p+Wx4p0x4hxNeSwi2R/aZFK9T+T1EWAmMC2K9urh2Nwus/A0GB2OyUxB0N8P5+qIXhVDaiXSvHKB4+QGhM8KGdk7V4zEYHRMd4uthIX+Cuii7l7XzT4iDfspY1fb8NtZO8K9dwubw6zp8i9K4R5jcvSbgnMYSi6rXQUWuN7bTjx1j0TjyW70Ogn/tinvPCJ0ZddiUURo0AYK7jvOFR+SwkZxrCu6POER/UyB4Asn1xXOLEN4spdhMVLjYCuCaaK1VFd8vIsUlziQ55yzX1eXxSQyK1nvMCguzKVrvcTl6pHQ0UNZasGmDFnNZnBxQRn1LVfzrqAgdDbYNiXvgT2iNpKcysDxBTGhLlNpJ0Xq27iVxfUrTBOtjGbsNalu90lJ8trWG9LgYPmFus4tLOex1bKJOCKH0QehoMjCMcE0OKZFOaI3gtrv6pMR60CHiqljOuVu4ISa0RrBtjHQphmWtOV+fNPdiXEIZ4de14hbFcY9vRJzZ8sinHyvO55MmtYyrJd49I3RmLINzy25pgV6lUrODug4Ye10gJIhVh43kQaMx53TGGh5ielMoo54NfEIYu41/+EKo8lghW845N9iUBuKgt4lzNjEThyExW560X12LZbYtz5YY9nlZ8f2h7G215TpSw38XSERQRr25qq/WIr1FhKnZq7r0caoAAAIgSURBVLKqtRqhFLKmzU0AEI72GlqrUQc2Rrwnpaw1Dm2Juk5fz9opU3N9j0ZqktJNVlwIk7sVjCVqUjzB0OIohXZSdm+DdEb6ehb4BLhOq7EFlcC4WkijNeTDStrsTVaqQlasvr5B75ngPhmhmxRham4DaRiRp5QJHQ22urz6sLk2IRsByNp9NeRuYbN7Xw8pZUr19aydCqTByZr2ZiqokDdqxKtebxBXloRf14TClrBxD5zGEmG8N+zzmgiIXC+EjWYRTj/m/tsbGEb0hrj3jNCZSoNeSHkGI2zQqFnlcwQI6UyFuSmhMJIHjcZkbauJX29EVqlbJsw8KwSjsDcFCAe7zyJ+QmQBy1JjL9GRNgCypqGGtCv2nextImvaTEqNVzXRWqFCfUOviZg4CTwVGX6/P1llpzfGqnYZY08TIYRQmmMspJuO4daBc5breqonNTxyTuNLsDepj35vevjHTSNgXJ7Jro1ACKH0w1iqQh8RJhzX7mblK9XQJExmJflNTlhsSda0OfDDhRC6mXHOcp20sIasaXMnLWpzQg5Z39CLOcypwSQ5QgghlDYwSY4QQgilDQzbCCGEUNrAsI0QQgilDQzbCCGEUNrAsI0QQgilDQzbCCGEUNoQfm/7+5Hh1LYDIYQQQlEJYfvSX4dS2w6EEEIIRYV/bgUhhBBKG/hsGyGEEEobGLYRQgihtIFhGyGEEEobGLYRQgihtPH/ATy4KBdd8xzOAAAAAElFTkSuQmCC" width="658" height="114" class="img_ev3q"></li>
<li>After the operation executes successfully, try to delete the project again</li>
</ol>
<p>If this doesn't work, then you may need to delete the Environment first; if you get an Internal Server error, then wait 2 minutes and retry the deletion again.</p>
<p><img decoding="async" loading="lazy" alt="DevCenter" src="https://luke.geek.nz/assets/images/devcenter-environments-5cf1cc4a63a9a37171dc5c07e18527de.png" width="1621" height="770" class="img_ev3q"></p>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Azure Container Apps Environment deployment - Missing Subnet]]></title>
            <link>https://luke.geek.nz/azure/containerapps-env-missing-subnet/</link>
            <guid>https://luke.geek.nz/azure/containerapps-env-missing-subnet/</guid>
            <pubDate>Thu, 11 Jul 2024 08:49:09 GMT</pubDate>
            <description><![CDATA[Missing subnet when attempting to deploy Container Apps Environment using the Azure Portal]]></description>
            <content:encoded><![CDATA[<p>When attempting to deploy a Container Apps Environment integrated into a VNET <em>(Virtual Network)</em> that was pre-created, you may have issues selecting a subnet which your Container Apps Environment should be deployed into, as your subnet may not be appearing in the Azure Portal to select.</p>
<p><img decoding="async" loading="lazy" alt="Container App Environment - Missing subnet" src="https://luke.geek.nz/assets/images/container-apps-env-subnetmissing-7fd2515443782c92d89e11f2eb18e7cb.png" width="1090" height="655" class="img_ev3q"></p>
<p>Before we continue, make sure that the subnet address ranges match at least the following:</p>
<table><thead><tr><th>Workload Profile</th><th>Minimum Subnet Size for Virtual Network Integration</th></tr></thead><tbody><tr><td>Standard</td><td>/27</td></tr><tr><td>Consumption</td><td>/23</td></tr></tbody></table>
<p>If you have a subnet that meets the requirements, you can proceed with trying the following steps.</p>
<ol>
<li>Delete the Subnet you want to use to deploy your Container Apps environment into it.</li>
<li>Now we need to recreate the subnet using the Azure CLI <em>(you can use the <a href="https://learn.microsoft.com/azure/cloud-shell/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure CloudShell</a>)</em> by running the following command <em>(replace the values with your own)</em>:</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">az network vnet subnet create --resource-group RG1  --vnet-name VNET1  </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--name</span><span class="token plain"> ACASubnet  --address-prefix </span><span class="token string" style="color:rgb(255, 121, 198)">'10.0.4.0/23'</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>After running the command, you should now be able to select the subnet created in the Azure Portal.</p>
<p><img decoding="async" loading="lazy" alt="Azure Container Apps - ACASubnet" src="https://luke.geek.nz/assets/images/container-apps-env-subnet-ae2894066227bf24d0701d6305d53bc0.png" width="1165" height="865" class="img_ev3q"></p>
<p>If we look at the differences between a subnet created in the Azure Portal Container Apps Environment experience and one created using the Azure CLI, we can see that there are differences:</p>
<p><img decoding="async" loading="lazy" alt="Subnet - Diff" src="https://luke.geek.nz/assets/images/container-apps-env-subnetdiff-41a7cbb1b57bd9a262c0c83e54341be7.png" width="1312" height="118" class="img_ev3q"></p>
<p>Working</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token property">"properties"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"addressPrefix"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"10.0.4.0/23"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Non-Working</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token property">"properties"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"addressPrefixes"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">"10.0.4.0/23"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In the non-working example, the addressPrefixes property is used instead of addressPrefix.</p>
<p>The difference lies in how the address prefix is represented:</p>
<ul>
<li>Working Example: Uses addressPrefix as a single-string property.</li>
<li>Non-working Example: Uses addressPrefixes as an array with one element</li>
</ul>
<p>📖 References:</p>
<ul>
<li>🔗<a href="https://learn.microsoft.com/training/modules/deploy-manage-container-app-using-azure-container-apps/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Guided project - Deploy and manage a container app using Azure Container Apps</a></li>
<li>🔗<a href="https://learn.microsoft.com/azure/container-apps/networking?tabs=workload-profiles-env%2Cazure-cli&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Networking in Azure Container Apps environment</a></li>
<li>🔗<a href="https://github.com/microsoft/azure-container-apps/issues/451" target="_blank" rel="noopener noreferrer">Failed to create Container Apps Environment with custom virtual network #451</a></li>
</ul>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Azure App Gateway Sinkhole for API Management with Terraform]]></title>
            <link>https://luke.geek.nz/azure/application-gateway-apim-sinkhole-terraform/</link>
            <guid>https://luke.geek.nz/azure/application-gateway-apim-sinkhole-terraform/</guid>
            <pubDate>Wed, 10 Jul 2024 05:29:56 GMT</pubDate>
            <description><![CDATA[This article provides a step-by-step guide on setting up an Azure Application Gateway Sinkhole using Terraform.]]></description>
            <content:encoded><![CDATA[<p>When you use an <a href="https://learn.microsoft.com/azure/api-management/api-management-key-concepts?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure API Management</a> solution in Internal mode, you may also want to use an <a href="https://learn.microsoft.com/azure/application-gateway/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Application Gateway</a> to provide additional security and performance features for external consumers as well and contain a mix of both Internal <em>(to your own vnet and private dns)</em> and <em>(external, accessed via public DNS)</em> APIs.</p>
<p><img decoding="async" loading="lazy" alt="APIM Management Internal" src="https://luke.geek.nz/assets/images/apim_internal_appgw-2604fcaed23f9dd476aba5879a864bf1.png" width="978" height="559" class="img_ev3q">
<em>(Image courtesy of: <a href="https://medium.com/@thahif.86/azure-apim-and-application-gateway-integration-9039378ba197" target="_blank" rel="noopener noreferrer">Azure APIM and Application Gateway Integration</a>)</em></p>
<p>In this scenario, you can use the following paths on your APIs:</p>
<ul>
<li><strong>Internal</strong>: <code>https://apim.yourdomain.com/internal/echo</code></li>
<li><strong>External</strong>: <code>https://apim.yourdomain.com/external/echo</code></li>
</ul>
<p><img decoding="async" loading="lazy" alt="Azure API Management - EchoAPI" src="https://luke.geek.nz/assets/images/apim_echoapi_external-e9a34e77e1ef9b48d3912406e4c12552.png" width="950" height="600" class="img_ev3q"></p>
<p>Where the path of Internal is only intended for internal consumers and internal APIs, and the external path is intended to be accessed externally <em>(and in some cases internally)</em>. You can drop all traffic that reaches the Azure Application Gateway with an /internal URL by routing it to a backend that doesn't exist.</p>
<p>To do this, you can create a Backend Pool named sinkhole and a Rule to route traffic to the sinkhole pool based on the path using the Application Gateway path routing rules.</p>
<p><img decoding="async" loading="lazy" alt="Azure App Gateway - Sinkhole" src="https://luke.geek.nz/assets/images/appgw_routingrules_sinkhole-f73fea724619e119e1fa856a8b974e18.png" width="1193" height="801" class="img_ev3q"></p>
<p>Here is the Terraform code on how you might implement this:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Public/external gateway rules</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">url_path_map</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">name</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"path-based-routing"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">default_backend_address_pool_name</span><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"apim"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">default_backend_http_settings_name</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"int-https-settings-gateway"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">path_rule</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">name</span><span class="token plain">                       </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"externalPathRule"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">paths</span><span class="token plain">                      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">"/external*"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">backend_address_pool_name</span><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"apim"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">backend_http_settings_name</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"int-https-settings-gateway"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">path_rule</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">name</span><span class="token plain">                       </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"internalPathRule"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">paths</span><span class="token plain">                      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">"/internal*"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">backend_address_pool_name</span><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"sinkhole"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">backend_http_settings_name</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"int-https-settings-gateway"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">request_routing_rule</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">name</span><span class="token plain">               </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"request-routing-public-apim-gateway"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">rule_type</span><span class="token plain">          </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"PathBasedRouting"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">http_listener_name</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"https-gateway-public"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">url_path_map_name</span><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"path-based-routing"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">priority</span><span class="token plain">           </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"100"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This Terraform code is configuring an Azure Application Gateway, which is a web traffic load balancer that enables you to manage traffic to your web applications.</p>
<p>Here's a breakdown of what each section does:</p>
<ul>
<li>url_path_map: This block defines a URL path-based routing rule. It specifies how HTTP traffic is routed to different backend pools based on the URL paths of the HTTP requests.</li>
<li>default_backend_address_pool_name and default_backend_http_settings_name define the default backend pool and HTTP settings to use if none of the specified path rules match.</li>
<li>Two path_rule blocks are defined. Each path_rule specifies a condition (based on the URL path) and the corresponding backend pool and HTTP settings to use when the condition is met. The first rule routes requests with paths starting with "/external" to the "apim" backend pool. The second rule routes requests with paths starting with "/internal" to the "sinkhole" backend pool.
request_routing_rule: This block defines a request routing rule, determining how the Application Gateway distributes traffic to the backend pools.</li>
<li>rule_type is set to "PathBasedRouting," which means the rule is based on URL paths.</li>
<li>http_listener_name specifies the HTTP listener to associate with the rule.</li>
</ul>
<p>url_path_map_name specifies the URL path map to use, which is defined in the url_path_map block.</p>
<p>Priority sets the priority of the rule. Lower numbers have higher priority. If a request matches multiple rules, the rule with the highest priority is applied.</p>
<p>So let us look at the sinkhole configuration:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">backend_address_pool</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">name</span><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"sinkhole"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">fqdns</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> null</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Here's a breakdown of what each line does:</p>
<ul>
<li>backend_address_pool: This block defines a backend address pool, which is a collection of IP addresses to which the Application Gateway can route network traffic.</li>
<li>"sinkhole": This line sets the name of the backend address pool to "sinkhole." This name is used to reference the backend address pool in other parts of the configuration.</li>
<li>fqdns = null: This line sets the fully qualified domain names (FQDNs) of the backend addresses to null. This means that the backend address pool does not contain any backend addresses. In the context of a "sinkhole" pool, this is likely intended to discard traffic or direct it to a non-existent endpoint.</li>
</ul>
<p>I hope this helps you understand how to configure a sinkhole pool in Azure Application Gateway using Terraform. This allows you to offer both external and internal APIs through the gateway. You can also have a private listener with a different routing rile if you want to offer all the internal and external APIs to your internal consumers/networks.</p>
<p>📖 References:</p>
<ul>
<li>🔗<a href="https://learn.microsoft.com/azure/api-management/api-management-using-with-internal-vnet?tabs=stv2&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Deploy your Azure API Management instance to a virtual network - internal mode</a></li>
<li>🔗<a href="https://learn.microsoft.com/azure/architecture/web-apps/api-management/architectures/protect-apis?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Protect APIs with Application Gateway and API Management</a></li>
<li>🔗<a href="https://learn.microsoft.com/azure/application-gateway/url-route-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">URL Path Based Routing overview</a></li>
<li>🔗<a href="https://github.com/Azure/apim-landing-zone-accelerator" target="_blank" rel="noopener noreferrer">apim-landing-zone-accelerator</a></li>
</ul>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Running your own Azure Proactive Resiliency Assessment]]></title>
            <link>https://luke.geek.nz/azure/proactive-resiliency-assessment/</link>
            <guid>https://luke.geek.nz/azure/proactive-resiliency-assessment/</guid>
            <pubDate>Sat, 06 Jul 2024 10:43:07 GMT</pubDate>
            <description><![CDATA[Detailed guide on setting up an Azure Proactive Resiliency Assessment.]]></description>
            <content:encoded><![CDATA[<p>The <a href="https://azure.github.io/Azure-Proactive-Resiliency-Library-v2/" target="_blank" rel="noopener noreferrer">Azure Proactive Resiliency Library</a> is a curated collection of best practices, guidance, and recommendations designed to improve the resiliency of applications and services running in Azure. Built on the Resiliency pillar of the Well-Architected Framework, this catalog provides valuable insights to ensure your workloads remain robust and reliable.</p>
<p>The library also includes automation capabilities (using Azure Graph queries) that allow you to collect data, analyze it, and generate detailed Word and PowerPoint reports. These reports, part of the Well-Architected Resiliency Assessment workshop, provide visibility into the resiliency of your Azure workloads. This toolset, often used by Microsoft Cloud Solution architects, can be leveraged to identify areas for improvement in your own Azure estate, following <a href="https://learn.microsoft.com/azure/well-architected/reliability/principles?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Resiliency</a> well-architected principles.</p>
<p>In this article, we will walk through the process of running the scripts to collect, analyze, and report on resiliency data for your workloads using the Azure Proactive Resiliency Library to help you identify and address potential reliability issues in your Azure environment.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-overview">🌐 Overview<a href="https://luke.geek.nz/azure/proactive-resiliency-assessment/#-overview" class="hash-link" aria-label="Direct link to 🌐 Overview" title="Direct link to 🌐 Overview">​</a></h2>
<p>Along with recommendations to increase Azure resource resiliency, supplementing the guidance on the Well-Architected Framework, the proactive resiliency library includes sample <a href="https://learn.microsoft.com/azure/governance/resource-graph/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Resource Graph queries</a>, to determine the current state of your resources.</p>
<p><img decoding="async" loading="lazy" alt="Azure Proactive Resiliency Library - Use Premium tier for critical production workloads" src="https://luke.geek.nz/assets/images/AzProactiveResiliencyLibrary_ContainerRegistry_Tier-edada5d36d2e0a4dcef066b0c5fe933a.png" width="1029" height="769" class="img_ev3q"></p>
<p>An improvement to this automation is the ability to run queries to collect, analyze, and create a Word and PowerPoint report for your Azure workloads; these reports are part of a Workshop delivery initiative - Well-Architected Reliability Assessment, usually driven by Microsoft Cloud Solution architects, we can leverage the same toolsets, to help increase visibility across the state of the reliability of our own Azure estate. This is not a set-and-forget tool but a starting point to help you understand the current state of your resources to help you make informed decisions on how to improve the reliability of your Azure workloads and an avenue to highlight Reliability improvements. This process works best when scoped to a specific workload vs an entire environment.</p>
<blockquote>
<p>This article is not meant as a substitute for the Microsoft-delivered Resiliency workshop but mainly to help you start your resiliency journey. The information in this article is based on the <a href="https://azure.github.io/Azure-Proactive-Resiliency-Library-v2/" target="_blank" rel="noopener noreferrer">Azure Proactive Resiliency Library v2</a> and the scripts provided in the public repository. Please contact your local Microsoft contact for information about their Resiliency workshop and the full delivery.</p>
</blockquote>
<p><img decoding="async" loading="lazy" alt="Azure Proactive Resiliency Library - Assessment" src="https://luke.geek.nz/assets/images/AzProactiveResiliencyLibrary_Assessment-8b13619c519131a14b9ebde7bb0e5a58.png" width="1283" height="766" class="img_ev3q"></p>
<blockquote>
<p>So, why must we consider reliability and resiliency in our Azure workloads?</p>
</blockquote>
<p>The answer is simple: ensure that your applications and services are available and reliable, even when failures occur. This is important for business continuity and ensuring that your customers can access your services when needed.</p>
<p><img decoding="async" loading="lazy" alt="Azure Proactive Resiliency Library - Importance of realibility" src="https://luke.geek.nz/assets/images/AzProactiveResiliencyLibrary_ImportanceRealiability-84010f457c76af363dd7111889e21081.png" width="1511" height="844" class="img_ev3q"></p>
<p>When managing resources and workloads in Azure, ensuring reliability is paramount to avoid unexpected failures and downtime. But why exactly do bad things happen, even when there seem to be numerous safeguards in place? Let's delve into reliability and why it's essential for your Azure environment by exploring the "Swiss Cheese Model" of accident causation, illustrated in the image above.</p>
<p>The <a href="https://en.wikipedia.org/wiki/Swiss_cheese_model" target="_blank" rel="noopener noreferrer">Swiss Cheese Model</a>, developed by James Reason, is a popular way to understand how errors and failures occur in complex systems. Each defense layer—represented as Swiss cheese slices—has holes or weaknesses. When these holes align across multiple layers, an accident can occur. Let's break down this model and see how it applies to Azure reliability.</p>
<ul>
<li>Institutional Level: Institutions may need more procedures and regulatory narrowness at the highest level. In the context of Azure, this could mean inadequate governance policies or a lack of compliance with best practices. These gaps can create vulnerabilities that might be exploited, leading to system failures.</li>
<li>Organizational Level: Organizations often face mixed messages and production pressures. This could translate to conflicting priorities for Azure between rapid deployment and maintaining robust security and reliability. Pressure to deliver quickly might lead to overlooked reliability checks, creating potential points of failure.</li>
<li>Professional Level: Issues such as responsibility shifting can arise at the professional level. In an Azure environment, this might occur when there is a lack of clear ownership over different architecture components, leading to neglected maintenance and updates.</li>
<li>Team Level: Teams might suffer from inadequate training. In Azure, this could mean insufficient knowledge about Azure services, leading to suboptimal configuration and resource management. Proper training ensures that teams can effectively manage and troubleshoot their environments.</li>
<li>Individual Level: Individual contributors might be distracted or make errors. In Azure, this could involve misconfigurations or overlooking critical logs and alerts. Encouraging a culture of attention to detail and thoroughness can help mitigate these risks.</li>
<li>Technical Level: Finally, technical issues such as clumsy technology, coding bugs, and deferred maintenance can directly impact reliability; in Azure, this might involve outdated software versions, unpatched vulnerabilities, or inefficient resource configurations.</li>
</ul>
<p>By understanding the layers of defense and potential triggers for failures, you can take proactive steps to enhance the reliability of your Azure resources and workloads, ensuring a robust, secure, and efficient cloud environment.</p>
<p>The Azure Proactive Resiliency library and the assessments we will run through will concentrate on the technical level to ensure that your Azure resources are configured correctly and are resilient to failures; however, the other layers of defense are also essential to consider and are a <a href="https://learn.microsoft.com/azure/reliability/overview?WT.mc_id=AZ-MVP-5004796#reliability-requirements" target="_blank" rel="noopener noreferrer">shared responsibility</a> between Microsoft and the customer.</p>
<p><img decoding="async" loading="lazy" alt="Azure Proactive Resiliency Library - shared responsibility" src="https://luke.geek.nz/assets/images/AzProactiveResiliencyLibrary_SharedResponsibility-f11723a008cf0c2993a7e12ee2c252ed.png" width="1500" height="826" class="img_ev3q"></p>
<p>So - let us get started with the Azure Proactive Resiliency Library and the assessment report.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-create-resiliency-reports">📊 Create Resiliency Reports<a href="https://luke.geek.nz/azure/proactive-resiliency-assessment/#-create-resiliency-reports" class="hash-link" aria-label="Direct link to 📊 Create Resiliency Reports" title="Direct link to 📊 Create Resiliency Reports">​</a></h2>
<p>The Assessment report is a 3 stage process.</p>
<ol>
<li>collect the data</li>
<li>analyse the data</li>
<li>create the report</li>
</ol>
<p><img decoding="async" loading="lazy" alt="Azure Proactive Resiliency Library - Assessment report" src="https://luke.geek.nz/assets/images/AzProactiveResiliencyLibrary_AssessmentProcess-72f9d8938d16ed43c8a53f7bd5f86977.png" width="993" height="588" class="img_ev3q"></p>
<blockquote>
<p>You can do both the data collection in an Azure CloudShell, which is useful for running this in customer environments; however, to create and analyze the data, you must run the script from a computer with Word and Excel installed.</p>
</blockquote>
<p><strong>It is worth noting that not all services will be supported by the automated resource graph queries, so you will need to check any services that are not supported manually, and when looking at running this for Production workloads, remember to consider the business context around the resiliency requirements.</strong></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-collect-the-data">📊 Collect the data<a href="https://luke.geek.nz/azure/proactive-resiliency-assessment/#-collect-the-data" class="hash-link" aria-label="Direct link to 📊 Collect the data" title="Direct link to 📊 Collect the data">​</a></h3>
<p>The Collector PowerShell script is designed to collect data from the Azure environment to help identify potential issues and areas for improvement using the Azure Resource Graph queries within this repository.</p>
<table><thead><tr><th>Parameter</th><th>Description</th><th>Example</th></tr></thead><tbody><tr><td>TenantID</td><td>Optional: tenant to be used.</td><td>12345678-1234-1234-1234-123456789012</td></tr><tr><td>SubscriptionIds</td><td>Required (or SubscriptionsFile): Specifies Subscription(s) to be included in the analysis.</td><td>12345678-1234-1234-1234-123456789012, 12345678-1234-1234-1234-123456789012</td></tr><tr><td>SubscriptionsFile</td><td>Optional (or SubscriptionIds): Specifies the file with the list to be analyzed (one subscription per line).</td><td>subscriptions.txt</td></tr><tr><td>RunbookFile</td><td>Optional: Specifies the file with the runbook (selectors &amp; checks) for use.</td><td>runbook.json</td></tr><tr><td>ResourceGroups</td><td>Optional: Specifies Resource Group(s) to be included in the analysis.</td><td>ResourceGroup1,ResourceGroup2</td></tr><tr><td>Debug</td><td>Optional: Writes debugging information for the script during the execution.</td><td>TRUE</td></tr></tbody></table>
<ol>
<li>Open an <a href="https://shell.azure.com/" target="_blank" rel="noopener noreferrer">Azure Cloud Shell</a> session</li>
<li>Type in:</li>
</ol>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">wget https:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token plain">github</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">com/Azure/Azure-Proactive-Resiliency-Library-v2/raw/main/tools/1_wara_collector</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ps1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">\1_wara_collector</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ps1 </span><span class="token operator">-</span><span class="token plain">SubscriptionIds </span><span class="token string" style="color:rgb(255, 121, 198)">'YOURSUBID'</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="3">
<li>Once the script has been completed, you will have a JSON file with the data collected and can proceed to the next step.</li>
</ol>
<p><img decoding="async" loading="lazy" alt="1_wara_collector.ps1" src="https://luke.geek.nz/assets/images/AzProactiveResiliencyLibrary_Collector-a07bda02f3e26a8c84361b3d705f488a.gif" width="934" height="402" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-analyse-the-data">📈 Analyse the data<a href="https://luke.geek.nz/azure/proactive-resiliency-assessment/#-analyse-the-data" class="hash-link" aria-label="Direct link to 📈 Analyse the data" title="Direct link to 📈 Analyse the data">​</a></h3>
<p>The Data Analyzer PowerShell script is the second script in the Azure Proactive Resiliency Library (APRL) tooling suite. This tool summarizes the collected data and provides actionable insights into the health and resiliency of the Azure environment.</p>
<p>If you used CloudShell in the previous step, you must download the JSON file to your local machine to run the Data Analyzer script.</p>
<blockquote>
<p><em>(The Data Analyzer script must be run from a Windows Machine with Excel installed.)</em></p>
</blockquote>
<p><img decoding="async" loading="lazy" alt="WARA_File download" src="https://luke.geek.nz/assets/images/AzProactiveResiliencyLibrary_CollectorDownload-8b223fb73c89398b177f0603781c5eb5.png" width="1265" height="860" class="img_ev3q"></p>
<p>Once the file is downloaded, you can run the Data Analyzer script to create the ExcelPlan.</p>
<ol>
<li>Open a PowerShell 7 terminal</li>
<li>Download the Data Analyzer script:</li>
</ol>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">https:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token plain">github</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">com/Azure/Azure-Proactive-Resiliency-Library-v2/raw/main/tools/2_wara_data_analyzer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ps1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Define the URL of the file to be downloaded</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$url</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"https://github.com/Azure/Azure-Proactive-Resiliency-Library-v2/raw/main/tools/2_wara_data_analyzer.ps1"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Define the path where the file will be saved</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$outputPath</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"d:\APRL\"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Use Invoke-WebRequest to download the file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Invoke-WebRequest</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Uri </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$url</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">OutFile </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$outputPath</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="2_wara_data_analyzer.ps1 download" src="https://luke.geek.nz/assets/images/AzProactiveResiliencyLibrary_DownloadAnalyzer-0ba193d589be9eb23b58770de1ed0c75.gif" width="934" height="402" class="img_ev3q"></p>
<p>Once downloaded, we can run it against the JSON file from the Data Collector script.</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$JSONFile</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">'WARA_File_2024-07-06_08_48.json'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">\2_wara_data_analyzer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ps1 </span><span class="token operator">-</span><span class="token plain">JSONFile </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$JSONFile</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Run Data Analyzer" src="https://luke.geek.nz/assets/images/AzProactiveResiliencyLibrary_RunDataAnalyzer-199d75938034dc882b9337cd8df1d415.gif" width="934" height="402" class="img_ev3q"></p>
<p>You should now have an Excel Action Plan with the data from the JSON file, including the recommendations and the current state of the resources.</p>
<p><img decoding="async" loading="lazy" alt="Excel Action Plan" src="https://luke.geek.nz/assets/images/AzProactiveResiliencyLibrary_WARAActionPlan-2a01842cf551304594d182ece755d1c4.gif" width="1798" height="1005" class="img_ev3q"></p>
<table><thead><tr><th>Worksheet Name</th><th>Description</th></tr></thead><tbody><tr><td>Recommendations</td><td>You will find all Recommendations, their category, impact, description, learn more links, and much more. Columns A and B count the number of Azure Resources associated with RecommendationID.</td></tr><tr><td>ImpactedResources</td><td>You will find a list of Azure Resources associated with a RecommendationID. These Azure Resources do not follow Microsoft's best practices for Reliability.</td></tr><tr><td>PivotTable</td><td>You will find a couple of pivot tables used to automatically create the charts.</td></tr><tr><td>Charts</td><td>You will find three charts that will be used in the Executive Summary PPTx.</td></tr><tr><td>ResourceTypes</td><td>You will find a list of all ResourceTypes the customer uses, the number of Resources deployed for each one, and if there are Recommendations for the ResourceType in APRL.</td></tr></tbody></table>
<blockquote>
<p>There will be resources that are not supported by the Resource Graph queries, so you will need to check these manually. Could you remove or add any recommendations based on your analysis before generating reports?</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-create-the-report">📝 Create the report<a href="https://luke.geek.nz/azure/proactive-resiliency-assessment/#-create-the-report" class="hash-link" aria-label="Direct link to 📝 Create the report" title="Direct link to 📝 Create the report">​</a></h3>
<p>The Report Generator PowerShell script is the final script in the Azure Proactive Resiliency Library (APRL) tooling suite. Its goal is to generate a Word and PowerPoint report based on the data collected and analyzed by the Collector and Data Analyzer scripts.</p>
<p>Now that we have our main Excel Action plan with the data, we can run the Report Generator script to create the Word and PowerPoint reports.</p>
<p>The previous script, would have downloaded the git repository for the Azure Proactive Library to your local device, so you can run the Report Generator script directly from that, the script needs to be ran.</p>
<p>This script requires specific Microsoft PowerPoint and Word templates:</p>
<ul>
<li>Mandatory - Executive Summary presentation - Template.pptx</li>
<li>Optional - Assessment Report - Template.docx</li>
</ul>
<p>These are stored in the Tools folder of the Azure Proactive Library repository.</p>
<p>The 3_wara_report_generator.ps1 script has the following parameters:</p>
<table><thead><tr><th>Parameter</th><th>Description</th><th>Example Demo Parameters</th></tr></thead><tbody><tr><td>ExcelFile</td><td>Mandatory: WARA Excel file generated by ‘2_wara_data_analyzer.ps1’ script and customized.</td><td>C:\path\to\WARA_Analysis.xlsx</td></tr><tr><td>CustomerName</td><td>Optional: specifies the Name of the Customer to be added to the PPTx and DOCx files.</td><td>Contoso Ltd</td></tr><tr><td>Heavy</td><td>Optional: Run the script at a lower pace to handle heavy environments.</td><td>TRUE</td></tr><tr><td>WorkloadName</td><td>Optional: specifies the Name of the Workload of the analyses to be added to the PPTx and DOCx files.</td><td>E-commerce Platform</td></tr><tr><td>PPTTemplateFile</td><td>Optional: specifies the PPTx template file for use as source. If not specified, the script will look for the file in the same path as the script.</td><td>C:\path\to\Template.pptx</td></tr><tr><td>WordTemplateFile</td><td>Optional: specifies the DOCx template file for use as source. If not specified, the script will look for the file in the same path as the script.</td><td>C:\path\to\Template.docx</td></tr><tr><td>Debugging</td><td>Optional: Writes a piece of Debugging information to a log file.</td><td>TRUE</td></tr></tbody></table>
<ol>
<li>Open a PowerShell 7 terminal</li>
<li>Run the following script <em>(adjust for your needs, it will look in the same folder that the script is located in for the word and excel templates)</em>:</li>
</ol>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$Excellocation</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">'D:\APRL\WARA Action Plan 2024-07-06_21_22.xlsx'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$WorkLoadName</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">'eCommerce'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$CustomerName</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">'Contoso Ltd'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">cd D:\APRL\Azure-Proactive-Resiliency-Library\tools\</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">\3_wara_reports_generator</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ps1 </span><span class="token operator">-</span><span class="token plain">ExcelFile </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$Excellocation</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">WorkLoadName </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$WorkLoadName</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">CustomerName </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$CustomerName</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="3_wara_reports_generator.ps1" src="https://luke.geek.nz/assets/images/AzProactiveResiliencyLibrary_RunReportGeneration-5dca82d5b42f677f4b551cc2882a9a57.gif" width="934" height="420" class="img_ev3q"></p>
<p>The script will generate a Word and PowerPoint report with the data from the Excel Action Plan and the recommendations for the Azure resources automatically included. You can then add additional information and recommendations based on the analysis of the data and the business context around the resources.</p>
<p><img decoding="async" loading="lazy" alt="PowerPoint Report" src="https://luke.geek.nz/assets/images/AzProactiveResiliencyLibrary_PowerPointGeneration-196b33ba918688bc927db58d2a93924a.gif" width="1899" height="1021" class="img_ev3q"></p>
<p>More detail can then be added to the Word document.</p>
<p><img decoding="async" loading="lazy" alt="Word Report" src="https://luke.geek.nz/assets/images/AzProactiveResiliencyLibrary_WordGeneration-170286825f67aca386f03be30a036031.gif" width="1899" height="1021" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-references">📖 References:<a href="https://luke.geek.nz/azure/proactive-resiliency-assessment/#-references" class="hash-link" aria-label="Direct link to 📖 References:" title="Direct link to 📖 References:">​</a></h2>
<ul>
<li>🔗<a href="https://azure.github.io/Azure-Proactive-Resiliency-Library-v2/tools/script-overviews/" target="_blank" rel="noopener noreferrer">Overview and Usage of APRL Scripts</a></li>
<li>🔗<a href="https://learn.microsoft.com/azure/well-architected/reliability/principles?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Reliability design principles</a></li>
<li>🔗<a href="https://learn.microsoft.com/azure/advisor/advisor-resiliency-reviews?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Advisor Resiliency Reviews</a></li>
<li>🔗<a href="https://learn.microsoft.com/azure/well-architected/mission-critical/mission-critical-design-methodology?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Design methodology for mission-critical workloads on Azure</a></li>
<li>🔗<a href="https://learn.microsoft.com/azure/architecture/reference-architectures/containers/aks-mission-critical/mission-critical-landing-zone?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Mission-critical baseline architecture in an Azure landing zone</a></li>
<li>🔗<a href="https://www.microsoft.com/licensing/docs/view/Service-Level-Agreements-SLA-for-Online-Services?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Service Level Agreements (SLA) for Online Services</a></li>
<li>🔗<a href="https://youtu.be/d7kzfogjmpE" target="_blank" rel="noopener noreferrer">Fireside Chat about Mission Critical applications on Azure with Leandro Carvalho</a></li>
</ul>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Infrastructure as Code GitHub Codespace Template]]></title>
            <link>https://luke.geek.nz/azure/iac-github-codespace/</link>
            <guid>https://luke.geek.nz/azure/iac-github-codespace/</guid>
            <pubDate>Fri, 14 Jun 2024 09:12:51 GMT</pubDate>
            <description><![CDATA[Codespace setup for Infrastructure as Code (IaC) coding, including Bicep and Terraform, and Linting.]]></description>
            <content:encoded><![CDATA[<p>I've written, about <a href="https://github.com/features/codespaces" target="_blank" rel="noopener noreferrer">GitHub Codespaces</a> before, in the article <a href="https://luke.geek.nz/azure/Getting-Started-with-GitHub-Codespaces/" target="_blank" rel="noopener noreferrer">Coding on the Cloud - Getting Started with GitHub Codespaces</a>, this article builds on it by supplying a Codespace setup for Infrastructure as Code <em>(IaC)</em> coding, including Bicep and Terraform, and Linting.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>The <strong><a href="https://github.com/lukemurraynz/Codespace_IaC_Coding/" target="_blank" rel="noopener noreferrer">lukemurraynz/Codespace_IaC_Coding</a></strong> Codespace includes essential tools for Infrastructure as Code development for Azure, tools like Azure CLI, PowerShell, Azure Bicep, Azure Developer CLI (azd), Terraform, TFLint, and Terragrunt. <strong>Feel free to fork, clone, or contribute to the repository. This template is aimed at getting you up and coding as soon as possible!</strong></p></div></div>
<ul>
<li><strong><a href="https://learn.microsoft.com/cli/azure/what-is-azure-cli?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure CLI</a></strong>: The Azure Command-Line Interface (CLI) is a cross-platform command-line tool to connect to Azure and execute administrative commands on Azure resources.</li>
<li><strong><a href="https://learn.microsoft.com/powershell/scripting/overview?view=powershell-7.4&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">PowerShell</a></strong>: PowerShell is a cross-platform task automation solution made up of a command-line shell, a scripting language, and a configuration management framework.</li>
<li><strong><a href="https://learn.microsoft.com/azure/azure-resource-manager/bicep/overview?tabs=bicep&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Bicep</a></strong>: Bicep is a domain-specific language (DSL) that uses declarative syntax to deploy Azure resources. In a Bicep file, you define the infrastructure you want to deploy to Azure, and then use that file throughout the development lifecycle to repeatedly deploy your infrastructure.</li>
<li><strong><a href="https://learn.microsoft.com/azure/developer/azure-developer-cli/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Developer CLI (azd)</a></strong>: Azure Developer CLI (azd) is an open-source tool that accelerates the time it takes for you to get your application from local development environment to Azure. azd provides best practice, developer-friendly commands that map to key stages in your workflow, whether you're working in the terminal, your editor or integrated development environment (IDE), or CI/CD (continuous integration/continuous deployment).</li>
<li><strong><a href="https://www.terraform.io/" target="_blank" rel="noopener noreferrer">Terraform</a></strong>: Infrastructure automation to provision and manage resources in any cloud or data center.</li>
<li><strong><a href="https://github.com/terraform-linters/tflint" target="_blank" rel="noopener noreferrer">TFLint</a></strong>: A Terraform linter for detecting errors that cannot be detected by terraform plan.</li>
<li><strong><a href="https://terragrunt.gruntwork.io/" target="_blank" rel="noopener noreferrer">Terragrunt</a></strong>: A thin wrapper for Terraform that provides extra tools for working with multiple Terraform modules.</li>
</ul>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Because this repository includes tools for both Bicep and Terraform IaC, it can take a few minutes to set up the Codespace. The setup process installs the necessary tools and extensions for Bicep and Terraform development. If you need to use only one of the tools, you can remove the unnecessary tools from the <code>.devcontainer/devcontainer.json</code> file.</p></div></div>
<p>The repository also includes uses <a href="https://megalinter.io/latest/" target="_blank" rel="noopener noreferrer">MegaLinter</a> to ensure code quality and adherence to best practices. MegaLinter analyzes the codebase for potential issues, coding standards violations, formatting discrepancies, and more across multiple languages and file formats. It helps maintain a high standard of code quality and consistency across the project.</p>
<p>Megalinter can be configured to automatically lint and open up a pull request with the changes, or it can be run manually. The repository is configured to run the MegaLinter on every push to the main branch, by setting a <a href="https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens#creating-a-fine-grained-personal-access-token" target="_blank" rel="noopener noreferrer">PAT (Personal Access Token)</a> in the repository secrets. The PAT is used to create a pull request with the linting results. Review the <a href="https://megalinter.io/7.8.0/configuration/" target="_blank" rel="noopener noreferrer">Megalinter</a> documentation for more information on how to configure it.</p>
<p><img decoding="async" loading="lazy" alt="GitHub IaC Codespace" src="https://luke.geek.nz/assets/images/GitHub_IaC_Codespace_PAT-3ef01ca2c601fcbe2cccae9b0b28a8e7.png" width="1243" height="890" class="img_ev3q"></p>
<p>VSCode is the default editor in the Codespace, and you can use the integrated terminal to run commands. The repository includes a <code>.devcontainer/devcontainer.json</code> file that defines the development container configuration. The configuration includes the tools and extensions required for Bicep and Terraform development, but also the base VSCode settings and extensions.</p>
<p>The Codespace configuration includes the following VSCode settings:</p>
<p><strong>editor.formatOnSaveMode</strong>: Configures format on save to be applied to the entire file.
<strong><a href="https://luke.geek.nz/azure/Azure-Bicep-Deploy-Pane/" target="_blank" rel="noopener noreferrer">bicep.experimental.deployPane</a></strong>: Enables the experimental deploy pane for Bicep.</p>
<p>VS Code Extensions to be Installed:</p>
<ul>
<li><strong><a href="https://marketplace.visualstudio.com/items?itemName=ms-azuretools.vscode-azurecontainerapps" target="_blank" rel="noopener noreferrer">ms-azuretools.vscode-azurecontainerapps</a></strong>: Azure Container Apps extension.</li>
<li><strong><a href="https://marketplace.visualstudio.com/items?itemName=ms-azuretools.vscode-azureresourcegroups" target="_blank" rel="noopener noreferrer">ms-azuretools.vscode-azureresourcegroups</a></strong>: Azure Resource Groups extension.</li>
<li><strong><a href="https://marketplace.visualstudio.com/items?itemName=ms-azuretools.vscode-bicep" target="_blank" rel="noopener noreferrer">ms-azuretools.vscode-bicep</a></strong>: Bicep extension.</li>
<li><strong><a href="https://marketplace.visualstudio.com/items?itemName=GitHub.copilot" target="_blank" rel="noopener noreferrer">GitHub.copilot</a></strong>: GitHub Copilot extension.</li>
<li><strong><a href="https://marketplace.visualstudio.com/items?itemName=GitHub.copilot-chat" target="_blank" rel="noopener noreferrer">GitHub.copilot-chat</a></strong>: GitHub Copilot Chat extension.</li>
<li><strong><a href="https://marketplace.visualstudio.com/items?itemName=ms-vscode.azure-account" target="_blank" rel="noopener noreferrer">ms-vscode.azure-account</a></strong>: Azure Account extension.</li>
<li><strong><a href="https://marketplace.visualstudio.com/items?itemName=HashiCorp.terraform" target="_blank" rel="noopener noreferrer">hashicorp.terraform</a></strong>: Terraform extension.</li>
<li><strong><a href="https://marketplace.visualstudio.com/items?itemName=golang.Go" target="_blank" rel="noopener noreferrer">golang.Go</a></strong>: Go language support extension.</li>
</ul>
<p><img decoding="async" loading="lazy" alt="GitHub IaC Codespace" src="https://luke.geek.nz/assets/images/GitHub_IaC_Codespace-afae2005beebc2ee6ff58c89511196eb.gif" width="1903" height="983" class="img_ev3q"></p>]]></content:encoded>
            <category>Azure</category>
            <category>Misc</category>
        </item>
        <item>
            <title><![CDATA[Cloud Design Patterns]]></title>
            <link>https://luke.geek.nz/azure/cloud-design-patterns/</link>
            <guid>https://luke.geek.nz/azure/cloud-design-patterns/</guid>
            <pubDate>Sun, 26 May 2024 09:05:39 GMT</pubDate>
            <description><![CDATA[Cloud design patterns help build reliable, scalable, secure applications in the cloud.]]></description>
            <content:encoded><![CDATA[<p>Cloud Design patterns help build reliable, scalable, secure applications in the cloud.</p>
<p>Today, we will cover common patterns, their use cases, and considerations.</p>
<p>The patterns we will cover today are only a small set of common patterns documented in the <a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Architecture Center</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="️-cloud-design-patterns">🌩️ Cloud Design Patterns<a href="https://luke.geek.nz/azure/cloud-design-patterns/#%EF%B8%8F-cloud-design-patterns" class="hash-link" aria-label="Direct link to 🌩️ Cloud Design Patterns" title="Direct link to 🌩️ Cloud Design Patterns">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="importance-of-design-patterns">Importance of Design Patterns<a href="https://luke.geek.nz/azure/cloud-design-patterns/#importance-of-design-patterns" class="hash-link" aria-label="Direct link to Importance of Design Patterns" title="Direct link to Importance of Design Patterns">​</a></h3>
<p>Design patterns are reusable solutions to common problems in software design. They are templates that can be applied to solve a problem in a specific context. They are not finished designs that can be transformed directly into code. They are a starting point for your design.</p>
<p><img decoding="async" loading="lazy" alt="Design Patterns" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPattnerns_Importance-e7c82f7f59275c9e6c178db732b041b3.gif" width="1903" height="1005" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Design patterns are not new. They have been around for a long time. The concept of design patterns was introduced by the architect <a href="https://en.wikipedia.org/wiki/Christopher_Alexander#:~:text=Alexander%25%20and%20personally%20built,architect%20and%20a%20general%20contractor.&amp;text=In%20software%2C%20Alexander%20is%20regarded,to%20its%20creator%2C%20Ward%20Cunningham" target="_blank" rel="noopener noreferrer">Christopher Alexander</a> in the field of architecture and later adopted by software engineers.</p></div></div>
<p>Design patterns are essential to consider when implementing your solutions as they help with the following:</p>
<p>Reusability - Design patterns promote reusability by providing proven solutions to common problems, allowing components and subsystems to be used in other applications and scenarios and interoperability</p>
<ul>
<li>Maintainability - They simplify administration and development, making maintaining and updating applications easier.</li>
<li>Consistency - Design patterns ensure consistency and coherence in component design and deployment, which is crucial for the overall quality of the application</li>
<li>Efficiency - By following established patterns, developers can avoid repetitive work and focus on implementing specific requirements, thus saving development time</li>
<li>Scalability - Design patterns help in designing scalable systems by providing guidelines for efficient resource allocation and management</li>
<li>Performance - They help optimize the use of system resources, leading to improved performance of the application&nbsp;</li>
<li>Modularity - Design patterns promote modular and structured code, making it easier to understand, modify, and maintain.</li>
</ul>
<p>This is as true in Modern Cloud solutions as it is in traditional development, with <a href="https://learn.microsoft.com/azure/well-architected/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">well-architected principles</a> more important than ever.</p>
<p>Take a Cloud Platform or ecosystem like Azure, with Services offering a theory of functionality that can be put together like Lego bricks.</p>
<ul>
<li>Scalability—Cloud design patterns address scalability by providing solutions for horizontal and vertical scaling, ensuring that applications can handle increased loads efficiently. This promotes sustainability by enabling dynamic resource allocation and reducing energy consumption during low-demand periods.</li>
<li>Resilience—Patterns like Circuit Breakers and Bulkhead help build resilient applications that can withstand failures and continue to function. Sustainable operations are achieved by minimizing downtime and resource wastage, thus ensuring efficient resource use.</li>
<li>Security—Security patterns such as API Gateway and Secure Token ensure that applications are protected against malicious actors while maintaining confidentiality, integrity, and availability. Secure systems support sustainability by preventing security breaches that could lead to resource wastage.</li>
<li>Operational Excellence - Patterns like Ambassador and Anti-Corruption Layer enhance operational excellence by simplifying the management and monitoring of cloud applications. Efficient management practices contribute to sustainability by optimizing resource usage and reducing unnecessary overhead.</li>
<li>Performance Efficiency - Patterns such as Cache-Aside and Compute Resource Consolidation optimize performance by efficiently managing resources and reducing latency. Effective resource management leads to sustainability by lowering the overall resource footprint and energy consumption.</li>
<li>Data Management—Data management patterns address data consistency, synchronization, and management challenges across different locations, which is crucial for cloud applications. Sustainable data practices ensure data is stored and processed efficiently, minimizing energy use and reducing environmental impact.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="acroymns">Acroymns<a href="https://luke.geek.nz/azure/cloud-design-patterns/#acroymns" class="hash-link" aria-label="Direct link to Acroymns" title="Direct link to Acroymns">​</a></h4>
<p>When talking about design patterns, we will be using a few acronyms, and it is important to understand what they mean in order to fully understand the context.</p>
<table><thead><tr><th>Acronym</th><th>Definition</th><th>Example</th></tr></thead><tbody><tr><td>Service</td><td>A service in cloud pattern design refers to a distinct function or set of functions a cloud application provides. Services are typically designed to be reusable and can be consumed by multiple clients or consumers.</td><td>In a microservices architecture, each microservice is a service that performs a specific business function, such as user authentication, payment processing, or data storage.</td></tr><tr><td>Consumer</td><td>A &nbsp;consumer is an entity (such as an application, service, or user) that consumes or uses the services provided by another service. Consumers send requests to services and receive responses.</td><td>A web application that calls an authentication service to verify user credentials is a consumer of that authentication service.</td></tr><tr><td>Tenant</td><td>In a multi-tenant architecture, a tenant is a group of users who share common access with specific privileges to the software instance. Each tenant's data is isolated and remains invisible to other tenants.</td><td>In a Software as a Service (SaaS) application, each customer (company or organization) is considered a tenant. They have their own isolated data and configuration settings within the shared application.</td></tr><tr><td>Facade</td><td>The Facade pattern provides a simplified interface to a complex subsystem, making it easier to use and understand. It acts as a high-level interface that hides the complexities of the underlying system.</td><td>In a software application, a facade can be used to provide a simplified API that abstracts away the complexities of interacting with multiple subsystems or modules.</td></tr><tr><td>Asynchronous</td><td>Asynchronous communication is a messaging pattern where the sender and receiver do not need to interact in real time. The sender can send a message and continue with other tasks, while the receiver processes the message at its own pace.</td><td>In a distributed system, asynchronous messaging can be used to decouple components and improve scalability. For example, a message queue can be used to send and receive messages between different services.</td></tr><tr><td>Synchronous</td><td>Synchronous communication is a messaging pattern where the sender and receiver interact in real time. The sender sends a message and waits for a response from the receiver before proceeding.</td><td>In a request-response scenario, a client sends a request to a server and waits for the server to process the request and send back a response. This pattern is commonly used in HTTP-based APIs.</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="archetypes-categories-of-patterns">Archetypes <em>(Categories)</em> of Patterns<a href="https://luke.geek.nz/azure/cloud-design-patterns/#archetypes-categories-of-patterns" class="hash-link" aria-label="Direct link to archetypes-categories-of-patterns" title="Direct link to archetypes-categories-of-patterns">​</a></h3>
<p>Cloud design patterns can be categorized into different Archetypes <em>(categories)</em> based on their characteristics and use cases. These archetypes provide a structured way to understand and apply patterns in cloud architecture design.</p>
<p>The categories include Data Management, Security, Reliability, Messaging, and Design and implementation. Let's examine each category in detail.</p>
<ul>
<li>Data Management patterns help us manage data in the cloud. Caching helps us reduce the number of database hits and improve application performance. Sharding helps us partition our data across multiple databases to improve scalability. Federation helps us distribute data across multiple databases for better availability and fault tolerance.</li>
<li>Security patterns help us secure our applications in the cloud. Perimeter Networks help us isolate our applications from the Internet. Identity Management helps us manage user identities and access to resources. Secure Communication helps us protect our data in transit.</li>
<li>Reliability patterns help us build highly available and fault-tolerant applications in the cloud. Retry helps us recover from transient failures. Circuit Breakers help us prevent cascading failure. Bulkhead helps us limit the damage caused by a failure.</li>
<li>Messaging patterns help us build scalable and decoupled applications in the cloud. Asynchronous Messaging helps us send messages between components in a non-blocking way. Event Sourcing helps us capture all changes to an application state. Competing Consumers help us process messages in parallel.</li>
<li>Design and implementation patterns help us build scalable and resilient cloud-native applications. Valet Key helps us delegate access to resources. Ambassador helps us expose services to external clients. Gateway helps us provide a single entry point to our application.</li>
</ul>
<p><img decoding="async" loading="lazy" alt="Cloud Design Patterns Archetypes" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatterns_Archetypes-9f8fe96f95134b7f90b57117774cc511.PNG" width="4000" height="2250" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>As usual, the choice of pattern depends on your application's specific requirements. To make an informed decision, it's essential to understand the characteristics and trade-offs of each pattern and business requirements. Sometimes, multiple patterns may be required, or even part of one, to solve a specific problem.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="pattern-deep-dives">Pattern Deep Dives<a href="https://luke.geek.nz/azure/cloud-design-patterns/#pattern-deep-dives" class="hash-link" aria-label="Direct link to Pattern Deep Dives" title="Direct link to Pattern Deep Dives">​</a></h3>
<p>The cloud has changed the way we design our applications. Let's examine some design patterns we can use in the cloud. These patterns help us solve common problems in cloud architecture and make our applications more reliable, scalable, and secure.</p>
<p>In the following sections, we will examine common cloud design patterns, their use cases, and considerations in depth.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="data-management-patterns">Data Management Patterns<a href="https://luke.geek.nz/azure/cloud-design-patterns/#data-management-patterns" class="hash-link" aria-label="Direct link to Data Management Patterns" title="Direct link to Data Management Patterns">​</a></h3>
<p><img decoding="async" loading="lazy" alt="Design Patterns - Data Management" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatterns_DataManagement-938a6255d99ff5338872172f50fb6d19.PNG" width="4000" height="2250" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-cache-aside">📚 Cache-Aside<a href="https://luke.geek.nz/azure/cloud-design-patterns/#-cache-aside" class="hash-link" aria-label="Direct link to 📚 Cache-Aside" title="Direct link to 📚 Cache-Aside">​</a></h3>
<blockquote>
<p>Load data on demand into a cache from a data store</p>
</blockquote>
<p>Many commercial caching systems provide read-through and write-through/write-behind operations. In these systems, an application retrieves data by referencing the cache.</p>
<p>If the data isn't in the cache, it's retrieved from the data store and added to the cache. Any modifications to data held in the cache are also automatically written back to the data store.</p>
<p>For caches that don't provide this functionality, it's the responsibility of the applications that use the cache to maintain the data.</p>
<p>If an application updates information, it can follow the write-through strategy by modifying the data store and invalidating the corresponding item in the cache. When the item is next required, using the cache-aside strategy will cause the updated data to be retrieved from the data store and added back into the cache.</p>
<p><img decoding="async" loading="lazy" alt="Cloud Design Pattern - CacheAsSide" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatterns_CacheAside-c416d22a006cae6f244c9bdc927de735.gif" width="1903" height="1005" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="issues--considerations">Issues &amp; considerations<a href="https://luke.geek.nz/azure/cloud-design-patterns/#issues--considerations" class="hash-link" aria-label="Direct link to Issues &amp; considerations" title="Direct link to Issues &amp; considerations">​</a></h4>
<p>Consider the following points when deciding how to implement this pattern:</p>
<ul>
<li>Lifetime of cached data. Many caches implement an expiration policy that invalidates data and removes it from the cache if it's not accessed for a specified period. For cache-aside to be effective, ensure that the expiration policy matches the pattern of access for applications that use the data. Don't make the expiration period too short because this can cause applications to continually retrieve data from the data store and add it to the cache. Similarly, don't make the expiration period so long that the cached data will likely become stale. Remember that caching is most effective for relatively static data or data that is read frequently.</li>
<li>Evicting data. Most caches have a limited size compared to the data store where the data originates, and they'll evict data if necessary. Most caches adopt a least-recently-used policy for selecting items to evict, but this might be customizable. Configure the global expiration property and other properties of the cache, as well as the expiration property of each cached item, to ensure that the cache is cost-effective. Applying a global eviction policy to every item in the cache isn't always appropriate. For example, if a cached item is costly to retrieve from the data store, it can be beneficial to keep this item in the cache at the expense of more frequently accessed but less costly items.</li>
<li>Priming the cache. Many solutions prepopulate the cache with the data that an application is likely to need during startup processing. The Cache-Aside pattern can still be useful if some of this data expires or is evicted.</li>
<li>Consistency. Implementing the Cache-Aside pattern doesn't guarantee consistency between the data store and the cache. An external process can change an item in the data store at any time, and this change might not be reflected in the cache until the next time the item is loaded. In a system replicating data across data stores, this problem can become serious if synchronization occurs frequently.</li>
<li>Local <em>(in-memory)</em> caching. A cache could be local to an application instance and stored in memory. Cache-aside can be useful in this environment if an application repeatedly accesses the same data. However, a local cache is private, so different application instances could each have a copy of the same cached data. This data could quickly become inconsistent between caches, so it might be necessary to expire data in a private cache and refresh it more frequently. In these scenarios, investigate a shared or distributed caching mechanism.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="when-to-use-this-pattern">When to use this pattern<a href="https://luke.geek.nz/azure/cloud-design-patterns/#when-to-use-this-pattern" class="hash-link" aria-label="Direct link to When to use this pattern" title="Direct link to When to use this pattern">​</a></h4>
<ul>
<li>When an in-built cache doesn't provide native read-through or write-back operations.</li>
<li>When resource demand is unpredictable, you want to avoid overloading the data store.</li>
<li>When the cached dataset is not static</li>
<li>When NOT caching session state information in a web application hosted in a web farm.</li>
</ul>
<!-- -->
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="azure-solutions">Azure Solutions<a href="https://luke.geek.nz/azure/cloud-design-patterns/#azure-solutions" class="hash-link" aria-label="Direct link to Azure Solutions" title="Direct link to Azure Solutions">​</a></h4>
<p>In this example, it uses <a href="https://learn.microsoft.com/azure/azure-cache-for-redis/cache-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Cache for Redis</a>. When an application needs to retrieve data, it will first check to see if it exists in Azure Cache for Redis.
If the data is found in Azure Cache for Redis (cache hit), the application will use this data.
If the data is not found in Azure Cache for Redis (cache miss), the application must retrieve it from the appropriate Azure database service.
For cache miss scenarios, the requesting application should add the data retrieved from the Azure Database service to Azure Cache for Redis.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-sharding">📚 Sharding<a href="https://luke.geek.nz/azure/cloud-design-patterns/#-sharding" class="hash-link" aria-label="Direct link to 📚 Sharding" title="Direct link to 📚 Sharding">​</a></h3>
<blockquote>
<p>Divide a data store into a set of horizontal partitions or shards.</p>
</blockquote>
<p>Dividing a data store into a set of horizontal partitions or shards. This can improve scalability when storing and accessing large volumes of data.</p>
<ul>
<li>The Lookup strategy. In this strategy, the sharding logic implements a map that routes a request for data to the shard containing that data using the shard key. In a multi-tenant application, all the data for a tenant might be stored together in a shard using the tenant ID as the shard key. Multiple tenants might share the same shard, but the data for a single tenant won't be spread across multiple shards.</li>
<li>The Range strategy. This strategy groups related items together in the same shard and orders them by shard key—the shard keys are sequential. It's useful for applications that frequently retrieve sets of items using range queries (queries that return a set of data items for a shard key that falls within a given range). For example, if an application regularly needs to find all orders placed in a given month, this data can be retrieved more quickly if all orders for a month are stored in date and time order in the same shard. If each order were stored in a different shard, they'd have to be fetched individually by performing many point queries (queries that return a single data item).&nbsp;</li>
<li>The Hash strategy. The purpose of this strategy is to reduce the chance of hotspots (shards that receive a disproportionate amount of load). It distributes the data across the shards in a way that achieves a balance between the size of each shard and the average load that each shard will encounter. The sharding logic computes the shard to store an item in based on a hash of one or more data attributes. The chosen hashing function should distribute data evenly across the shards, possibly by introducing some random element into the computation.</li>
</ul>
<p><img decoding="async" loading="lazy" alt="Cloud Design Pattern - Sharding" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatterns_Sharding-ea99e03e181d1c690f570c96e200f6e8.gif" width="1903" height="1005" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="issues--considerations-1">Issues &amp; considerations<a href="https://luke.geek.nz/azure/cloud-design-patterns/#issues--considerations-1" class="hash-link" aria-label="Direct link to Issues &amp; considerations" title="Direct link to Issues &amp; considerations">​</a></h4>
<p>Consider the following points when deciding how to implement this pattern:</p>
<ul>
<li>Balancing data across multiple shards.</li>
<li>Your queries need to be efficient and not require data from multiple shards or cause latency issues.</li>
<li>Designing for scalability (storage nodes – data &amp; throughput)</li>
<li>Designing for availability (replication, failover, recovery)</li>
<li>Make sure to use stable and unique key data to determine the sharding state</li>
<li>Monitoring, backup, and maintaining consistency of multiple shards can be difficult.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="when-to-use-this-pattern-1">When to use this pattern<a href="https://luke.geek.nz/azure/cloud-design-patterns/#when-to-use-this-pattern-1" class="hash-link" aria-label="Direct link to When to use this pattern" title="Direct link to When to use this pattern">​</a></h4>
<p>The primary focus of sharding is to improve the performance and scalability of a system. Still, as a by-product it can also improve availability due to how the data is divided into separate partitions. A failure in one partition doesn't necessarily prevent an application from accessing data held in other partitions, and an operator can perform maintenance or recovery of one or more partitions without making the entire data for an application inaccessible.&nbsp;</p>
<ul>
<li>When the data store is likely to need to scale beyond the resources of a single storage node.</li>
<li>When you can improve performance  by reducing contention on a single data store.</li>
<li>When you need to optimize cost by multiple instances of less expensive compute or storage.</li>
<li>Improve resilience and reliability.</li>
<li>When you have geographical concerns, i.e., Optimization based on where users or systems are located.</li>
</ul>
<!-- -->
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="azure-solutions-1">Azure Solutions<a href="https://luke.geek.nz/azure/cloud-design-patterns/#azure-solutions-1" class="hash-link" aria-label="Direct link to Azure Solutions" title="Direct link to Azure Solutions">​</a></h4>
<p>Consider a website that surfaces an expansive collection of information on published books worldwide.
The number of possible books cataloged in this workload and the typical query/usage patterns contra-indicate the usage of a single relational database to store the book information. The workload architect decides to shard the data across multiple database instances, using the books' static International Standard Book Number (ISBN) for the shard key. Specifically, they use the&nbsp;check digit&nbsp;(0 - 10) of the ISBN as that gives 11 possible logical shards, and the data will be balanced across each shard. First, they decide to colocate the 11 logical shards into three physical shard databases. They use the&nbsp;lookup&nbsp;sharding approach and store the key-to-server mapping information in a shard map database.</p>
<p>Azure resources that can be used to implement this pattern include <a href="https://learn.microsoft.com/azure/azure-sql/database/sql-database-paas-overview?view=azuresql&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure SQL Database</a>, <a href="https://learn.microsoft.com/azure/cosmos-db/introduction?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Cosmos DB</a>, and <a href="https://learn.microsoft.com/azure/storage/common/storage-introduction?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Storage</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-valet-key">🚗 Valet Key<a href="https://luke.geek.nz/azure/cloud-design-patterns/#-valet-key" class="hash-link" aria-label="Direct link to 🚗 Valet Key" title="Direct link to 🚗 Valet Key">​</a></h3>
<blockquote>
<p>Use a token or key that provides clients with restricted direct access to a specific resource or service.</p>
</blockquote>
<p>Data stores have the ability to handle the upload and download of data directly without requiring the application to perform any processing to move this data. However, this typically requires the client to have access to the store's security credentials. This can be a useful technique to minimize data transfer costs and the requirement to scale out the application and to maximize performance. It means, though, that the application is no longer able to manage the security of the data. After the client has a connection to the data store for direct access, the application can't act as the gatekeeper. It's no longer in control of the process and can't prevent subsequent uploads or downloads from the data store.
This isn't a realistic approach in distributed systems that need to serve untrusted clients.</p>
<p>Applications must be able to securely control access to data in a granular way, but still reduce the load on the server by setting up this connection and then allowing the client to communicate directly with the data store to perform the required read or write operations.</p>
<p><img decoding="async" loading="lazy" alt="Cloud Design Pattern - Valet Key" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatterns_ValetKey-d96a9ad0ddbef19ec0b9f2914e36edde.gif" width="1903" height="1005" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="issues--considerations-2">Issues &amp; considerations<a href="https://luke.geek.nz/azure/cloud-design-patterns/#issues--considerations-2" class="hash-link" aria-label="Direct link to Issues &amp; considerations" title="Direct link to Issues &amp; considerations">​</a></h4>
<p>By considering these issues and trade-offs, you can effectively implement the Valet Key pattern to enhance security, performance, and cost efficiency in your cloud applications.</p>
<ul>
<li>Ensure that the token or key used for access is securely generated and transmitted to prevent unauthorized access</li>
<li>It could introduce security and audit risks if not implemented correctly</li>
<li>Implement proper access controls and authorization mechanisms to restrict the actions that can be performed using the valet key</li>
<li>Cost savings from offloading processing must be weighed against the complexity of implementing and managing the Valet Key pattern</li>
<li>Monitor and audit access using the valet key to detect any unauthorized or malicious activities</li>
<li>Ensure that the resources are managed efficiently to avoid unnecessary costs, especially when dealing with frequent or large client requests</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="when-to-use-this-pattern-2">When to use this pattern<a href="https://luke.geek.nz/azure/cloud-design-patterns/#when-to-use-this-pattern-2" class="hash-link" aria-label="Direct link to When to use this pattern" title="Direct link to When to use this pattern">​</a></h4>
<p>Using a valet key doesn't require the resource to be locked, no remote server call is required, there's no limit on the number of valet keys that can be issued, and it avoids a single point of failure resulting from performing the data transfer through the application code.&nbsp;</p>
<p>Consider using the Valet Key pattern in the following scenarios:</p>
<ul>
<li>Offload data transfer from the application to minimize the use of valuable resources such as computing, memory, and bandwidth.</li>
<li>When the data is stored in a remote data store or a different datacenter from the application.</li>
<li>Minimize operational costs by enabling direct access to stores and queues.</li>
<li>Clients regularly upload or download data, particularly where there's a large volume or when each operation involves a large file</li>
<li>If the application doesn’t need to perform tasks on the data first.</li>
<li>When you need to provide secure, temporary access to specific resources or services.</li>
</ul>
<!-- -->
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="azure-solutions-2">Azure Solutions<a href="https://luke.geek.nz/azure/cloud-design-patterns/#azure-solutions-2" class="hash-link" aria-label="Direct link to Azure Solutions" title="Direct link to Azure Solutions">​</a></h4>
<p>Azure supports shared access signatures on Azure Storage for granular access control to data in blobs, tables, and queues, and for Service Bus queues and topics. A shared access signature token can be configured to provide specific access rights such as read, write, update, and delete to a specific table, a key range within a table, a queue, a blob, or a blob container. The validity can be a specified time period. This functionality is well-suited for accessing a valet key.</p>
<p>Azure resources that can be used to implement this pattern include <a href="https://learn.microsoft.com/azure/storage/common/storage-introduction?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Storage</a> and <a href="https://learn.microsoft.com/azure/azure-functions/functions-overview?pivots=programming-language-csharp&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Function</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-static-content-hosting">📦 Static Content Hosting<a href="https://luke.geek.nz/azure/cloud-design-patterns/#-static-content-hosting" class="hash-link" aria-label="Direct link to 📦 Static Content Hosting" title="Direct link to 📦 Static Content Hosting">​</a></h3>
<blockquote>
<p>Deploy static content to a cloud-based storage service that can deliver them directly to the client.</p>
</blockquote>
<p>Web applications typically include some elements of static content. This static content might include HTML pages and other resources such as images and documents that are available to the client, either as part of an HTML page (such as inline images, style sheets, and client-side JavaScript files) or as separate downloads (such as PDF documents).
Although web servers are optimized for dynamic rendering and output caching, they still have to handle requests to download static content. This consumes processing cycles that could often be better used for more important delivery and user-experience tasks.</p>
<p>Deploy static content to a cloud-based storage service that can deliver them directly to the client. This can reduce the need for potentially expensive compute instances.</p>
<p><img decoding="async" loading="lazy" alt="Cloud Design Pattern - StaticContent" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatterns_StaticContent-5fe5f4bf1d7fca7625bc68a6070178a0.gif" width="1903" height="1005" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="issues--considerations-3">Issues &amp; considerations<a href="https://luke.geek.nz/azure/cloud-design-patterns/#issues--considerations-3" class="hash-link" aria-label="Direct link to Issues &amp; considerations" title="Direct link to Issues &amp; considerations">​</a></h4>
<p>By considering these issues and trade-offs, you can effectively implement the Valet Key pattern to enhance security, performance, and cost efficiency in your cloud applications.</p>
<ul>
<li>If static content is not included in the application deployment package or process, it may need to be provisioned and deployed independently from the application.</li>
<li>Security access needs to be considered – i.e., Public write access to prevent unauthorized uploads.</li>
<li>Storage services might not support the use of a custom domain name</li>
<li>File compression, such as gzip, to reduce load times for clients.</li>
<li>Consider how to handle local development and testing</li>
<li>Geographic concerns: Consider using a content delivery network (CDN) to cache the storage container's contents in multiple data centers around the world.</li>
<li>Caching of existing assets.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="when-to-use-this-pattern-3">When to use this pattern<a href="https://luke.geek.nz/azure/cloud-design-patterns/#when-to-use-this-pattern-3" class="hash-link" aria-label="Direct link to When to use this pattern" title="Direct link to When to use this pattern">​</a></h4>
<p>Static Content Hosting is a common pattern used in web applications to offload the delivery of static content from the application server to a cloud-based storage service. This pattern is particularly useful when the application server is not optimized for serving static content or when the application server is under heavy load and needs to offload some of the work to improve performance and scalability.</p>
<ul>
<li>Reduce the hosting costs for websites and applications that contain some static resources. Cloud-hosted storage is typically much less expensive than compute instances</li>
<li>Improve the performance of your main WebApp by offloading  static content serving</li>
<li>Expose static resources and content for applications running in other hosting environments or on-premises servers.</li>
<li>Improve your application's performance and availability by using a content delivery network (CDN) to cache the contents of the storage container in multiple datacenters worldwide.</li>
</ul>
<!-- -->
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="azure-solutions-3">Azure Solutions<a href="https://luke.geek.nz/azure/cloud-design-patterns/#azure-solutions-3" class="hash-link" aria-label="Direct link to Azure Solutions" title="Direct link to Azure Solutions">​</a></h4>
<p>Azure resources that can be used to implement this pattern include <a href="https://learn.microsoft.com/azure/storage/blobs/storage-blobs-introduction?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Blob Storage</a>, <a href="https://learn.microsoft.com/azure/cdn/cdn-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Content Delivery Network (CDN)</a>, and <a href="https://learn.microsoft.com/azure/static-web-apps/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Static Web Apps</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="design--implementation-patterns">Design &amp; Implementation Patterns<a href="https://luke.geek.nz/azure/cloud-design-patterns/#design--implementation-patterns" class="hash-link" aria-label="Direct link to Design &amp; Implementation Patterns" title="Direct link to Design &amp; Implementation Patterns">​</a></h3>
<p><img decoding="async" loading="lazy" alt="Design &amp;amp; Implementation Patterns" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatterns_DesignImplementation-0d041cba67e09224f3dba8c3fa0d3357.PNG" width="4000" height="2250" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-ambassador">🎉 Ambassador<a href="https://luke.geek.nz/azure/cloud-design-patterns/#-ambassador" class="hash-link" aria-label="Direct link to 🎉 Ambassador" title="Direct link to 🎉 Ambassador">​</a></h3>
<blockquote>
<p>Create helper services that send network requests on behalf of a consumer service or application.</p>
</blockquote>
<p>Resilient cloud-based applications require features such as&nbsp;circuit breaking, routing, metering and monitoring, and the ability to make network-related configuration updates. It may be difficult or impossible to update legacy applications or existing code libraries to add these features because the code is no longer maintained or can't be easily modified by the development team.
Network calls may also require substantial configuration for connection, authentication, and authorization. If these calls are used across multiple applications, built using multiple languages and frameworks, the calls must be configured for each of these instances. In addition, network and security functionality may need to be managed by a central team within your organization. With a large code base, it can be risky for that team to update application code they aren't familiar with.</p>
<p>Put client frameworks and libraries into an external process that acts as a proxy between your application and external services. Deploy the proxy on the same host environment as your application to allow control over routing, resiliency, and security features and to avoid any host-related access restrictions.</p>
<p><img decoding="async" loading="lazy" alt="Cloud Design Patterns - Ambassador" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatterns_Ambassador-c492df8d860c4cf9f1077927a3cfcafe.gif" width="1903" height="1005" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="issues--considerations-4">Issues &amp; considerations<a href="https://luke.geek.nz/azure/cloud-design-patterns/#issues--considerations-4" class="hash-link" aria-label="Direct link to Issues &amp; considerations" title="Direct link to Issues &amp; considerations">​</a></h4>
<p>When implementing the Ambassador pattern, consider the following issues and considerations:</p>
<ul>
<li>Latency Overhead- The proxy adds some latency overhead. It is important to evaluate whether a client library, invoked directly by the application, might be a better approach to avoid this additional latency</li>
<li>Generalized Features - Including generalized features in the proxy can have unintended consequences. For example, the ambassador could handle retries, but this might not be safe unless all operations are idempotent. Ensure that the features implemented in the proxy do not introduce risks or conflicts with the application's requirements</li>
<li>Context Passing — Consider a mechanism that allows the client to pass some context to the proxy and back to the client. For example, include HTTP request headers to opt out of retry or specify the maximum number of times to retry. This flexibility can help tailor the proxy's behavior to specific needs.</li>
<li>Packaging and Deployment - Think about how to package and deploy the proxy. The proxy can be deployed as a sidecar to accompany the lifecycle of a consuming application or service. Alternatively, if an ambassador is shared by multiple separate processes on a common host, it can be deployed as a daemon or Windows service</li>
<li>Shared vs. Dedicated Instances - Decide whether to use a single shared instance for all clients or an instance for each client. This decision can impact resource utilization, performance, and isolation between different clients</li>
<li>Security and Configuration - Network calls may require substantial connection, authentication, and authorization configuration. If these calls are used across multiple applications built using multiple languages and frameworks, the calls must be configured for each of these instances. Additionally, network and security functionality may need to be managed by a central team within your organization</li>
<li>Specialized Teams - Features that are offloaded to the ambassador can be managed independently of the application. This allows for separate, specialized teams to implement and maintain security, networking, or authentication features that have been moved to the ambassador without disturbing the application's legacy functionalityBy addressing these issues and considerations, you can effectively implement the Ambassador pattern to enhance the networking capabilities, security, and maintainability of your applications.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="when-to-use-this">When to use this<a href="https://luke.geek.nz/azure/cloud-design-patterns/#when-to-use-this" class="hash-link" aria-label="Direct link to When to use this" title="Direct link to When to use this">​</a></h4>
<p>The Ambassador pattern should be used in the following scenarios:</p>
<ul>
<li>Offloading Common Client Connectivity Tasks - When you need to offload common client connectivity tasks such as monitoring, logging, routing, security (such as TLS), and resiliency patterns in a language-agnostic way</li>
<li>Legacy Applications - When dealing with legacy applications or other applications that are difficult to modify, the Ambassador pattern can extend their networking capabilities without requiring changes to the application code</li>
<li>Specialized Teams - When you want to enable a specialized team to implement and maintain security, networking, or authentication features independently of the application. This allows for updates and modifications to the ambassador without disturbing the application's legacy functionality</li>
<li>Resilient Cloud-Based Applications - When building resilient cloud-based applications that require features such as circuit breaking, routing, metering and monitoring, and the ability to make network-related configuration updates. The Ambassador pattern can facilitate these features without modifying the existing codebase</li>
<li>Centralized Management of Network and Security - When network calls require substantial configuration for connection, authentication, and authorization across multiple applications built using multiple languages and frameworks. The Ambassador pattern allows these configurations to be managed centrally, reducing the risk of updating application code by a team unfamiliar with it</li>
<li>Standardizing and Extending Instrumentation - When you need to standardize and extend instrumentation, such as monitoring performance metrics like latency or resource usage. The Ambassador pattern allows this monitoring to happen in the same host environment as the application</li>
<li>Supporting Cloud or Cluster Connectivity Requirements - When you need to support cloud or cluster connectivity requirements in a legacy application or an application that is difficult to modify considering these scenarios, you can effectively use the Ambassador pattern to enhance the networking capabilities, security, and maintainability of your applications.</li>
</ul>
<!-- -->
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="azure-solutions-4">Azure Solutions<a href="https://luke.geek.nz/azure/cloud-design-patterns/#azure-solutions-4" class="hash-link" aria-label="Direct link to Azure Solutions" title="Direct link to Azure Solutions">​</a></h4>
<p>Azure resources that can be used to implement this pattern include <a href="https://learn.microsoft.com/azure/api-management/api-management-key-concepts?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure API Management</a>, <a href="https://learn.microsoft.com/azure/frontdoor/front-door-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Front Door</a> and <a href="https://learn.microsoft.com/azure/firewall/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Firewall</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-sidecar">🚀 Sidecar<a href="https://luke.geek.nz/azure/cloud-design-patterns/#-sidecar" class="hash-link" aria-label="Direct link to 🚀 Sidecar" title="Direct link to 🚀 Sidecar">​</a></h3>
<blockquote>
<p>Deploy components of an application into a separate process or container to provide isolation and encapsulation.</p>
</blockquote>
<p>Deploy application components into a separate process or container to provide isolation and encapsulation. This pattern can also enable applications composed of heterogeneous components and technologies.
This pattern is named&nbsp;Sidecar&nbsp;because it resembles a sidecar attached to a motorcycle. In the pattern, the sidecar is attached to a parent application and provides supporting features for the application. The sidecar also shares the same lifecycle as the parent application, being created and retired alongside the parent. The sidecar pattern is sometimes referred to as the sidekick pattern and is a decomposition pattern.</p>
<p><img decoding="async" loading="lazy" alt="Cloud Design Pattern - Sidecar" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatterns_Sidecar-5ad26785315db760ecc98d9d3de4fb06.gif" width="1903" height="1005" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="issues--considerations-5">Issues &amp; considerations<a href="https://luke.geek.nz/azure/cloud-design-patterns/#issues--considerations-5" class="hash-link" aria-label="Direct link to Issues &amp; considerations" title="Direct link to Issues &amp; considerations">​</a></h4>
<p>When implementing the Sidecar pattern, consider the following issues and considerations.</p>
<ul>
<li>Deployment and Packaging - Carefully decide on the deployment and packaging format for services, processes, or containers. Containers are particularly well-suited to the sidecar pattern</li>
<li>Interprocess Communication - Choose the interprocess communication mechanism wisely. Aim to use language- or framework-agnostic technologies unless performance requirements make that impractical</li>
<li>Functionality Placement - Before placing functionality into a sidecar, consider whether it would work better as a separate service or a more traditional daemon. Also, evaluate if the functionality could be implemented as a library or using a traditional extension mechanism, as language-specific libraries may offer deeper integration and less network overhead</li>
<li>Resource Management - The sidecar can access the same resources as the primary application, which allows it to monitor system resources used by both the sidecar and the primary application</li>
<li>Latency - Communication between a parent application and sidecar services includes some overhead, notably call latency. This may not be an acceptable trade-off for chatty interfaces</li>
<li>Application Size and Resource Cost - For small applications, the resource cost of deploying a sidecar service for each instance may not be worth the advantage of isolation</li>
<li>Scaling - If the service needs to scale differently or independently from the main applications, it may be better to deploy the feature as a separate service</li>
<li>Security - By encapsulating tasks and deploying them out-of-process, you can reduce the surface area of sensitive processes to only the code needed to accomplish the task. Sidecars can also add cross-cutting security controls to an application component that is not natively designed with that functionality</li>
<li>Operational Excellence - The sidecar pattern provides an approach to implementing flexibility in tool integration that might enhance the application's observability without requiring the application to take direct implementation dependencies. It enables the sidecar functionality to evolve and be maintained independently of the application's lifecycle</li>
<li>Performance Efficiency - Moving cross-cutting tasks to a single process that can scale across multiple instances of the main process reduces the need to deploy duplicate functionality for each instance of the application, by addressing these issues and considerations, you can effectively implement the Sidecar pattern to enhance the modularity, security, and maintainability of your applications.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="when-to-use-this-1">When to use this<a href="https://luke.geek.nz/azure/cloud-design-patterns/#when-to-use-this-1" class="hash-link" aria-label="Direct link to When to use this" title="Direct link to When to use this">​</a></h4>
<p>The Sidecar pattern should be used in the following scenarios.</p>
<ul>
<li>Heterogeneous Set of Languages and Frameworks - When your primary application uses a heterogeneous set of languages and frameworks. A component located in a sidecar service can be consumed by applications written in different languages using different frameworks</li>
<li>Component Ownership by Remote Teams - When a component is owned by a remote team or a different organization. This allows the component to be developed and maintained independently of the main application</li>
<li>Co-location Requirement - When a component or feature must be co-located on the same host as the application. This ensures that the component can access the same resources and environment as the primary application</li>
<li>Independent Updates - When you need a service that shares the overall lifecycle of your main application but can be independently updated. This allows for flexibility in updating the sidecar without affecting the main application</li>
<li>Fine-grained resource Control - When you need fine-grained control over resource limits for a particular resource or component. For example, you may want to restrict the amount of memory a specific component uses. Deploying the component as a sidecar allows you to manage memory usage independently of the main application</li>
<li>Security Enhancements - When you need to encapsulate tasks and deploy them out-of-process to reduce the surface area of sensitive processes to only the code needed to accomplish the task. Sidecars can also add cross-cutting security controls to an application component that is not natively designed with that functionality</li>
<li>Operational Excellence - When you want to implement flexibility in tool integration that might enhance the application's observability without requiring the application to take direct implementation dependencies. The sidecar functionality can evolve and be maintained independently of the application's lifecycle</li>
<li>Performance Efficiency — When you want to move cross-cutting tasks to a single process that can scale across multiple instances of the main process, reducing the need to deploy duplicate functionality for each application instance. By considering these scenarios, you can effectively use the Sidecar pattern to enhance the modularity, security, and maintainability of your applications.</li>
</ul>
<!-- -->
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="azure-solutions-5">Azure Solutions<a href="https://luke.geek.nz/azure/cloud-design-patterns/#azure-solutions-5" class="hash-link" aria-label="Direct link to Azure Solutions" title="Direct link to Azure Solutions">​</a></h4>
<p>Use a&nbsp;sidecar&nbsp;container that enhances the application with the required SSL functionality without modifying the application code. The sidecar pattern is a powerful concept in container-based architectures that lets you decompose application functionality into different container images that run together in the same container group.
In an Azure Container Instances container group, each container can take over part of the functionality the application requires. Sidecar containers can use different container images from the application container, even from different image repositories. Containers in the same container group share some properties, such as the underlying network stack.</p>
<p>Azure resources that can be used to implement this pattern include <a href="https://learn.microsoft.com/azure/container-instances/container-instances-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Container Instances</a>, <a href="https://learn.microsoft.com/azure/aks/intro-kubernetes?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Kubernetes Service</a>, and <a href="https://learn.microsoft.com/azure/app-service/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure App Service</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="️-leader-election">🎖️ Leader Election<a href="https://luke.geek.nz/azure/cloud-design-patterns/#%EF%B8%8F-leader-election" class="hash-link" aria-label="Direct link to 🎖️ Leader Election" title="Direct link to 🎖️ Leader Election">​</a></h3>
<blockquote>
<p>Coordinate the actions performed by a collection of collaborating task instances in a distributed application by electing one instance as the leader who assumes responsibility for managing the other instances.</p>
</blockquote>
<p>A typical cloud application has many tasks acting in a coordinated manner. These tasks could all be instances running the same code and requiring access to the same resources, or they might be working together in parallel to perform the individual parts of a complex calculation.
The task instances might run separately for much of the time, but it might also be necessary to coordinate the actions of each instance to ensure that they don't conflict, cause contention for shared resources, or accidentally interfere with the work that other task instances are performing.
For example:
In a cloud-based system that implements horizontal scaling, multiple instances of the same task could be running at the same time with each instance serving a different user. If these instances write to a shared resource, it's necessary to coordinate their actions to prevent each instance from overwriting the changes made by the others.
If the tasks are performing individual elements of a complex calculation in parallel, the results need to be aggregated when they are all complete.</p>
<p><img decoding="async" loading="lazy" alt="Cloud Design Patterns - Leader Election" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatterns_LeaderElection-b9d849d2cba11ff24a0c38f7a3243c14.gif" width="1903" height="1005" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="issues--considerations-6">Issues &amp; considerations<a href="https://luke.geek.nz/azure/cloud-design-patterns/#issues--considerations-6" class="hash-link" aria-label="Direct link to Issues &amp; considerations" title="Direct link to Issues &amp; considerations">​</a></h4>
<p>When implementing the Leader Election pattern, consider the following issues and considerations.</p>
<ul>
<li>Preventing Multiple Leaders - Ensure the election process is managed carefully to prevent two or more instances from taking over the leader position simultaneously. This requires a robust mechanism for selecting a leader that can handle events such as network outages or process failures</li>
<li>Failure Detection - The system must be able to detect when the leader has failed or become unavailable (e.g., due to a communications failure). The speed of detection depends on the system's requirements. Some systems can tolerate a short period without a leader, while others need immediate detection and a new election</li>
<li>Handling Leader Termination - In systems with horizontal autoscaling, the leader could be terminated if the system scales back and shuts down some computing resources. Ensure the system can handle such scenarios and elect a new leader promptly</li>
<li>Avoiding Single Points of Failure - Using a shared, distributed mutex introduces a dependency on the external service that provides the mutex, which can become a single point of failure. If this service becomes unavailable, the system won't be able to elect a leader</li>
<li>Leader as a Bottleneck - Avoid making the leader a bottleneck in the system. The leader's role is to coordinate the work of subordinate tasks, not necessarily to participate in the work itself. Ensure the leader can delegate tasks effectively to avoid performance issues</li>
<li>Latency and Performance - The resulting latency from leader coordination can affect the performance and response times of other processes if they are waiting for the leader to coordinate an operation. Optimize the leader election process to minimize latency</li>
<li>Flexibility and Optimization - Implementing leader election algorithms manually provides the greatest flexibility for tuning and optimizing the code. However, this approach requires careful design and testing to ensure robustness</li>
<li>Election Algorithms - Consider using established leader election algorithms such as the Bully Algorithm or the Ring Algorithm. These algorithms assume each candidate in the election has a unique ID and can communicate reliably with other candidates</li>
<li>Coordination Requirements - Use the Leader Election pattern when tasks in a distributed application need careful coordination and there is no natural leader. This pattern is useful for cloud-hosted solutions where multiple instances need to work together without conflict</li>
<li>Alternative Solutions — Evaluate whether a more lightweight method, such as optimistic or pessimistic locking, can achieve the required coordination. Also, consider third-party solutions like Apache Zookeeper for managing leader election and coordination tasks. By addressing these issues and considerations, you can effectively implement the Leader Election pattern to ensure reliable and efficient coordination in distributed systems.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="when-to-use-this-2">When to use this<a href="https://luke.geek.nz/azure/cloud-design-patterns/#when-to-use-this-2" class="hash-link" aria-label="Direct link to When to use this" title="Direct link to When to use this">​</a></h4>
<p>The Leader Election pattern should be used in the following scenarios.</p>
<ul>
<li>Task Coordination - When you need to coordinate a task among multiple instances of a service or application. The Leader Election pattern ensures that one instance acts as the coordinator, preventing conflicts and ensuring smooth operation</li>
<li>Avoiding Single Points of Failure - When you want to avoid having a single point of failure in your application. By using leader election, if the current leader fails, a new leader is automatically selected, ensuring continuous operation without manual intervention&nbsp;</li>
<li>Distributed Systems - In distributed systems where multiple instances need to work together without conflict. The Leader Election pattern helps in managing coordination tasks effectively across different instances</li>
<li>High Availability Requirements - When your application requires high availability and resilience. The pattern helps in maintaining service continuity by electing a new leader if the current one fails, thus supporting failover mechanisms</li>
<li>Scalability - When you need to scale out your application horizontally. The Leader Election pattern can help manage the coordination of tasks across multiple instances, ensuring that the system scales efficiently without bottlenecks</li>
<li>Consensus Algorithms - When implementing consensus algorithms to manage failover and ensure that work is reliably redirected in case of node malfunctions. This is particularly useful in scenarios where reliability and self-healing are critical</li>
<li>Using Off-the-Shelf Solutions - When you prefer not to implement a leader election algorithm from scratch. Off-the-shelf solutions like Apache Zookeeper can be used to manage leader election and coordination tasks effectively. By considering these scenarios, you can effectively use the Leader Election pattern to ensure reliable and efficient coordination in distributed systems, enhancing the overall resilience and scalability of your application.</li>
</ul>
<!-- -->
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="azure-solutions-6">Azure Solutions<a href="https://luke.geek.nz/azure/cloud-design-patterns/#azure-solutions-6" class="hash-link" aria-label="Direct link to Azure Solutions" title="Direct link to Azure Solutions">​</a></h4>
<p>Azure resources that can be used to implement this pattern include <a href="https://learn.microsoft.com/azure/service-fabric/service-fabric-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Service Fabric</a>, <a href="https://learn.microsoft.com/azure/aks/intro-kubernetes?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Kubernetes Service</a>, and <a href="https://learn.microsoft.com/azure/azure-functions/functions-overview?pivots=programming-language-csharp&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Functions</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-strangler-fig">🌳 Strangler Fig<a href="https://luke.geek.nz/azure/cloud-design-patterns/#-strangler-fig" class="hash-link" aria-label="Direct link to 🌳 Strangler Fig" title="Direct link to 🌳 Strangler Fig">​</a></h3>
<blockquote>
<p>Incrementally migrate a legacy system by gradually replacing specific pieces of functionality with new applications and services.</p>
</blockquote>
<p>As systems age, the development tools, hosting technology, and even system architectures they were built on can become increasingly obsolete. As new features and functionality are added, the complexity of these applications can increase dramatically, making them harder to maintain or add new features to.
Completely replacing a complex system can be a huge undertaking. Often, you will need a gradual migration to a new system, while keeping the old system to handle features that haven't been migrated yet. However, running two separate versions of an application means that clients have to know where particular features are located. Every time a feature or service is migrated, clients need to be updated to point to the new location.</p>
<p>The Strangler Fig pattern involves gradually replacing parts of the legacy system with new services. This allows for a controlled and step-by-step transition rather than a wholesale move.</p>
<p><img decoding="async" loading="lazy" alt="Cloud Design Patterns - Strangler Fig" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatterns_StranglerFig-3445af1528afd171c01375016cff344d.gif" width="1903" height="1005" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="issues--considerations-7">Issues &amp; considerations<a href="https://luke.geek.nz/azure/cloud-design-patterns/#issues--considerations-7" class="hash-link" aria-label="Direct link to Issues &amp; considerations" title="Direct link to Issues &amp; considerations">​</a></h4>
<p>When implementing the Strangler Fig pattern, consider the following issues and considerations.</p>
<ul>
<li>Handling Services and Data Stores - Ensure that both new and legacy systems can access shared services and data stores. This is crucial for maintaining consistency and avoiding data integrity issues during the migration process&nbsp;</li>
<li>Structuring New Applications - Structure new applications and services in a way that they can easily be intercepted and replaced in future migrations. This helps in maintaining flexibility and ease of further transitions.</li>
<li>Facade Management - The facade, which intercepts requests and routes them to either the legacy or new system, must keep up with the migration. It should not become a single point of failure or a performance bottleneck. Proper management and monitoring of the facade are essential to ensure smooth operation2&nbsp;</li>
<li>Incremental Migration - The pattern supports incremental migration, which helps to minimize risk and spread the development effort over time. However, this requires careful planning to ensure that each increment is functional and does not disrupt the overall system</li>
<li>Client Updates - Running two separate versions of an application means that clients need to be updated to know where particular features are located. This can add complexity to the migration process, as each client must be aware of the changes and adapt accordingly</li>
<li>Avoiding Single Points of Failure - Ensure that the facade does not become a single point of failure. It should be designed to handle high availability and failover scenarios to maintain system reliability during the migration</li>
<li>Performance Considerations - The facade should not become a performance bottleneck. It must be capable of handling the load and routing requests efficiently to avoid degrading the user experience</li>
<li>Completing the Migration - At some point, when the migration is complete, the strangler fig facade will either go away or evolve into an adaptor for legacy clients. Plan for this transition to ensure that the final system is clean and does not retain unnecessary components2&nbsp;By addressing these issues and considerations, you can effectively implement the Strangler Fig pattern to ensure a smooth and controlled migration from a legacy system to a new architecture.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="when-to-use-this-3">When to use this<a href="https://luke.geek.nz/azure/cloud-design-patterns/#when-to-use-this-3" class="hash-link" aria-label="Direct link to When to use this" title="Direct link to When to use this">​</a></h4>
<p>The Strangler Fig pattern should be used in the following scenarios.</p>
<ul>
<li>Gradual Migration -  When you need to incrementally migrate a legacy system to a new architecture. This pattern allows you to gradually replace specific pieces of functionality with new applications and services, minimizing risk and spreading the development effort over time</li>
<li>Complex Systems - When dealing with complex systems where a complete replacement would be a huge undertaking. The Strangler Fig pattern enables a controlled decomposition of a monolith into a set of microservices, allowing the legacy system to continue functioning while new features are added to the new system</li>
<li>Maintaining Functionality - When it is essential to keep the legacy system operational during the migration. The facade in the Strangler Fig pattern intercepts requests and routes them to either the legacy application or the new services, ensuring that consumers can continue using the same interface without being aware of the migration</li>
<li>Avoiding Big Bang Rewrites - When you want to avoid the risks associated with a "big bang" rewrite. The Strangler Fig pattern supports an incremental approach, allowing you to add functionality to the new system at your own pace while ensuring the legacy application continues to function</li>
<li>Modernizing Legacy Systems - When modernizing legacy systems that have become increasingly obsolete due to outdated development tools, hosting technology, or system architectures. The pattern helps in gradually transitioning to a new system while maintaining the old system for features that haven't been migrated yet</li>
<li>Using Modern Orchestration Tools - When you want to leverage modern orchestration tools such as Azure DevOps to manage the lifecycle of each service. Once the application has been decomposed into constituent microservices, these tools can be used to manage the new system effectively. Considering these scenarios, you can effectively use the Strangler Fig pattern to ensure a smooth and controlled migration from a legacy system to a new architecture, enhancing the overall resilience and scalability of your application.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="azure-solutions-7">Azure Solutions<a href="https://luke.geek.nz/azure/cloud-design-patterns/#azure-solutions-7" class="hash-link" aria-label="Direct link to Azure Solutions" title="Direct link to Azure Solutions">​</a></h4>
<p>Many <a href="https://azure.microsoft.com/products?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure products</a>, can be used to implement this pattern.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="messaging-patterns">Messaging Patterns<a href="https://luke.geek.nz/azure/cloud-design-patterns/#messaging-patterns" class="hash-link" aria-label="Direct link to Messaging Patterns" title="Direct link to Messaging Patterns">​</a></h3>
<p><img decoding="async" loading="lazy" alt="Messaging Patterns" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatterns_Messaging-96157045d56ca73d261c3e61955ef24f.PNG" width="4000" height="2250" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-sequential-convoy">🚚 Sequential Convoy<a href="https://luke.geek.nz/azure/cloud-design-patterns/#-sequential-convoy" class="hash-link" aria-label="Direct link to 🚚 Sequential Convoy" title="Direct link to 🚚 Sequential Convoy">​</a></h4>
<blockquote>
<p>Process a set of related messages in a defined order without blocking the processing of other groups of messages.</p>
</blockquote>
<p>Applications often need to process a sequence of messages in the order they arrive, while still being able to scale out to handle increased load. In a distributed architecture, processing these messages in order is not straightforward, because the workers can scale independently and often pull messages independently</p>
<p>Push related messages into categories within the queuing system, and have the queue listeners lock and pull only from one category, one message at a time.</p>
<p><img decoding="async" loading="lazy" alt="Cloud Design Pattern - Sequential Covey" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatterns_SequentialCovey-cd14b2fb7322b541b41ce3b1dc7c7a7e.gif" width="1903" height="1005" class="img_ev3q"></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="issues--considerations-8">Issues &amp; considerations<a href="https://luke.geek.nz/azure/cloud-design-patterns/#issues--considerations-8" class="hash-link" aria-label="Direct link to Issues &amp; considerations" title="Direct link to Issues &amp; considerations">​</a></h5>
<p>The Sequential Convoy pattern is designed to process a set of related messages in a defined order without blocking the processing of other groups of messages. Here are some issues and considerations associated with this pattern</p>
<ul>
<li>Message Ordering - Ensuring that messages are processed in the order they arrive can be challenging in a distributed architecture. Workers can scale independently and often pull messages independently, which can disrupt the order of processing</li>
<li>Scalability - While the pattern allows for scaling out to handle increased load, it requires careful management to ensure that the order of messages is maintained. This can involve categorizing related messages within the queuing system and having queue listeners lock and pull only from one category at a time</li>
<li>Complexity in Implementation - Implementing the Sequential Convoy pattern can be complex, especially when dealing with interleaved transactions for multiple orders. The system must be designed to handle these transactions in a first-in-first-out (FIFO) manner at the order level</li>
<li>Resource Management - Efficiently managing resources to ensure that the processing of one group of messages does not block others is crucial. This involves coordinating actions across distributed services and remote resources</li>
<li>Error Handling - Handling errors in a sequential processing system can be more complex. If an error occurs, the system must ensure that subsequent messages are not processed until the error is resolved, which can involve implementing compensating transactions or other error recovery mechanisms By addressing these issues and considerations, the Sequential Convoy pattern can be effectively implemented to ensure ordered processing of related messages in a distributed system.</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="when-to-use-this-pattern-4">When to use this pattern<a href="https://luke.geek.nz/azure/cloud-design-patterns/#when-to-use-this-pattern-4" class="hash-link" aria-label="Direct link to When to use this pattern" title="Direct link to When to use this pattern">​</a></h5>
<p>The Sequential Convoy pattern should be used in the following scenarios.</p>
<ul>
<li>Ordered Message Processing - When you have messages that arrive in a specific order and must be processed in that same order. This is crucial for maintaining the integrity and consistency of the operations being performed</li>
<li>Categorized Messages - When arriving messages can be categorized in such a way that the category becomes a unit of scale for the system. For example, in an order tracking system, messages can be categorized by order ID, ensuring that all operations related to a specific order are processed sequentially</li>
<li>Avoiding Blocking - When you need to process a set of related messages in a defined order without blocking the processing of other groups of messages. This allows for efficient handling of multiple message groups concurrently while maintaining order within each group&nbsp;However, this pattern might not be suitable for extremely high throughput scenarios (millions of messages per minute or second), as the FIFO (First in and First Out) requirement limits the scaling that can be done by the system.</li>
</ul>
<!-- -->
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="azure-solutions-8">Azure Solutions<a href="https://luke.geek.nz/azure/cloud-design-patterns/#azure-solutions-8" class="hash-link" aria-label="Direct link to Azure Solutions" title="Direct link to Azure Solutions">​</a></h5>
<p>Azure resources that can be used to implement this pattern include <a href="https://learn.microsoft.com/azure/service-bus-messaging/service-bus-messaging-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Service Bus</a>, <a href="https://learn.microsoft.com/azure/event-grid/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Event Grid</a>, and <a href="https://learn.microsoft.com/azure/azure-functions/functions-overview?pivots=programming-language-csharp&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Functions</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-queue-based-load-leveling">📌 Queue-Based Load Leveling<a href="https://luke.geek.nz/azure/cloud-design-patterns/#-queue-based-load-leveling" class="hash-link" aria-label="Direct link to 📌 Queue-Based Load Leveling" title="Direct link to 📌 Queue-Based Load Leveling">​</a></h3>
<blockquote>
<p>Use a buffer between a task and a service that it invokes in order to smooth intermittent heavy loads.</p>
</blockquote>
<p>Use a queue that acts as a buffer between a task and a service it invokes to smooth intermittent heavy loads that can cause the service to fail or the task to time out. This can help minimize the impact of peaks in demand on availability and responsiveness for both the task and the service.
Context and problem, many solutions in the cloud involve running tasks that invoke services. In this environment, if a service is subjected to intermittent heavy loads, it can cause performance or reliability issues.
A service could be part of the same solution as the tasks that use it, or it could be a third-party service providing access to frequently used resources such as a cache or a storage service. If the same service is used by a number of tasks running concurrently, it can be difficult to predict the volume of requests to the service at any time.
A service might experience peaks in demand that cause it to overload and be unable to respond to requests in a timely manner. Flooding a service with a large number of concurrent requests can also result in the service failing if it's unable to handle the contention these requests cause.
Solution, Refactor the solution and introduce a queue between the task and the service.</p>
<p><img decoding="async" loading="lazy" alt="Cloud Design Patterns - Queue Based Levelling " src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatterns_QueueBasedLeveling-21042a47a507610395aa8ceebe68854b.gif" width="1903" height="1005" class="img_ev3q"></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="issues--considerations-9">Issues &amp; considerations<a href="https://luke.geek.nz/azure/cloud-design-patterns/#issues--considerations-9" class="hash-link" aria-label="Direct link to Issues &amp; considerations" title="Direct link to Issues &amp; considerations">​</a></h5>
<p>The Queue-Based Load Leveling pattern is designed to handle intermittent heavy loads by using a queue as a buffer between a task and a service it invokes. Here are some issues and considerations associated with this pattern</p>
<ul>
<li>Rate Control - It is necessary to implement application logic that controls the rate at which services handle messages to avoid overwhelming the target resource. This involves ensuring that spikes in demand are not passed to the next stage of the system</li>
<li>Testing Under Load - The system should be tested under load to ensure that it provides the required leveling. Adjustments may be needed in the number of queues and the number of service instances that handle messages to achieve optimal performance</li>
<li>Scalability - The pattern can help maximize scalability because both the number of queues and the number of services can be varied to meet demand. However, careful management is required to ensure that the system scales effectively without introducing bottlenecks</li>
<li>Availability - This pattern can help maximize availability because delays in services won't have an immediate and direct impact on the application. The application can continue to post messages to the queue even when the service isn't available or isn't currently processing messages</li>
<li>Cost Control - The number of service instances deployed only needs to be adequate to meet the average load rather than the peak load, which can help control costs. However, this requires careful monitoring and adjustment to ensure that the system remains cost-effective while meeting performance requirements</li>
<li>Throttling - Some services implement throttling when demand reaches a threshold beyond which the system could fail. Implementing load-leveling with these services can ensure that this threshold isn't reached, thereby maintaining service functionality</li>
<li>Temporal Decoupling - A message broker provides temporal decoupling, meaning the producer and consumer do not have to run concurrently. This allows the producer to send messages regardless of the consumer's availability, and the consumer can process messages at its own pace</li>
<li>Asynchronous Processing — The pattern supports asynchronous message processing, which can help maintain the responsiveness of the user interface and distribute processing across multiple servers to improve throughput. By considering these issues and implementing appropriate strategies, the Queue-Based Load Leveling pattern can effectively manage load and improve a system's resilience and scalability.</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="when-to-use-this-pattern-5">When to use this pattern<a href="https://luke.geek.nz/azure/cloud-design-patterns/#when-to-use-this-pattern-5" class="hash-link" aria-label="Direct link to When to use this pattern" title="Direct link to When to use this pattern">​</a></h5>
<p>The Queue-Based Load Leveling pattern should be used in the following scenarios:</p>
<ul>
<li>Handling Intermittent Heavy Loads - When a service is subjected to intermittent heavy loads that can cause performance or reliability issues, this pattern helps to smooth out these loads by using a queue as a buffer between the task and the service it invokes</li>
<li>Decoupling Tasks from Services - When you need to decouple tasks from services to allow the service to handle messages at its own pace, regardless of the volume of requests from concurrent tasks. This ensures that the service is not overwhelmed by a sudden spike in demand</li>
<li>Maximizing Availability - When you want to ensure that delays in services do not have an immediate and direct impact on the application. The application can continue to post messages to the queue even when the service isn't available or isn't currently processing messages</li>
<li>Maximizing Scalability - When you need to scale both the number of queues and the number of services to meet demand. This pattern allows for flexible scaling to handle varying loads</li>
<li>Cost Control - When you want to control costs by deploying a number of service instances that only need to be adequate to meet the average load rather than the peak load. This can help in reducing the overall cost of the system</li>
<li>Throttling - When services implement throttling to prevent system failure due to high demand. The Queue-Based Load Leveling pattern can help ensure that the demand does not exceed the service's capacity, thereby maintaining functionality</li>
<li>Asynchronous Processing — When you need to perform tasks asynchronously to maintain the responsiveness of the user interface and distribute processing across multiple servers to improve throughput, you can use the Queue-Based Load Leveling pattern in these scenarios to improve your system's resilience, scalability, and cost-effectiveness.</li>
</ul>
<!-- -->
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="azure-solutions-9">Azure Solutions<a href="https://luke.geek.nz/azure/cloud-design-patterns/#azure-solutions-9" class="hash-link" aria-label="Direct link to Azure Solutions" title="Direct link to Azure Solutions">​</a></h5>
<p>Azure resources that can be used to implement this pattern include <a href="https://learn.microsoft.com/azure/service-bus-messaging/service-bus-messaging-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Service Bus</a>, <a href="https://learn.microsoft.com/azure/event-grid/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Event Grid</a>, and <a href="https://learn.microsoft.com/azure/azure-functions/functions-overview?pivots=programming-language-csharp&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Functions</a>.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-publisher-subscriber">📌 Publisher-Subscriber<a href="https://luke.geek.nz/azure/cloud-design-patterns/#-publisher-subscriber" class="hash-link" aria-label="Direct link to 📌 Publisher-Subscriber" title="Direct link to 📌 Publisher-Subscriber">​</a></h4>
<blockquote>
<p>Enable an application to announce events to multiple interested consumers asynchronously, without coupling the senders to the receivers.</p>
</blockquote>
<p>Publisher-Subscriber, or PubSub for short, enables an application to announce events to multiple interested consumers asynchronously without coupling the senders to the receivers.</p>
<p>In cloud-based and distributed applications, system components often need to provide information to other components as events occur.
Asynchronous messaging is an effective way to decouple senders from consumers and avoid blocking the sender from waiting for a response. The sender uses an input messaging channel. The sender packages events into messages, using a known message format, and sends these messages via the input channel. The sender in this pattern is also called the&nbsp;publisher.</p>
<p>One output messaging channel per consumer. The consumers are known as&nbsp;subscribers.
A mechanism for copying each message from the input channel to the output channels for all subscribers interested in that message. This operation is typically handled by an intermediary such as a message broker or event bus.</p>
<p><img decoding="async" loading="lazy" alt="Cloud Design Pattern - Publisher-Subscriber (PubSub)" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatterns_PubSub-a01b413a68767c7c256453c7de35fec6.gif" width="1903" height="1005" class="img_ev3q"></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="issues--considerations-10">Issues &amp; considerations<a href="https://luke.geek.nz/azure/cloud-design-patterns/#issues--considerations-10" class="hash-link" aria-label="Direct link to Issues &amp; considerations" title="Direct link to Issues &amp; considerations">​</a></h5>
<p>The Publisher-Subscriber pattern, also known as Pub-Sub, is a messaging pattern where an application (publisher) sends messages or events to multiple interested consumers (subscribers) asynchronously. Here are some issues and considerations associated with this pattern</p>
<ul>
<li>Scalability - One of the main challenges is ensuring the system can scale efficiently as the number of subscribers increases. Each new subscriber typically requires additional resources and potentially changes to the application code to handle the new message queue</li>
<li>Message Delivery - Ensuring that messages are delivered to all subscribers reliably and in a timely manner can be complex. Message queues generally aim to deliver messages in a first-in-first-out (FIFO) manner, but this order is not always guaranteed, especially under high-load conditions</li>
<li>Monitoring and Alerts - Implementing effective monitoring and alerting mechanisms is crucial to tracking the performance of message queues, detecting stuck messages, and ensuring that subscribers are processing messages efficiently</li>
<li>Security - Ensuring that messages are encrypted and only authorized subscribers can access them is essential. This involves implementing robust authentication and authorization mechanisms</li>
<li>Handling Subscriptions - Deciding how to manage subscriptions is important. You need to determine whether subscribers can subscribe and unsubscribe at their own pace or if an approval mechanism is required</li>
<li>Message Duplication - Handling duplicate messages is necessary because message queues guarantee at least one delivery, which means there is a chance that a message might be delivered more than once. Implementing deduplication mechanisms can help manage this issue</li>
<li>Poison Messages - Managing poison messages, which are messages that repeatedly fail to be processed, is important. These messages should be moved to a separate poison queue to free up the main queue for other messages</li>
<li>One-Way Communication - The Pub-Sub pattern is inherently one-way, meaning that subscribers cannot send acknowledgments or responses back to the publisher. If two-way communication is needed, another pattern like Request-Reply should be implemented</li>
<li>Message Expiration - Defining how long messages should remain in the queue before they expire is important. This helps in managing the lifecycle of messages and ensuring that outdated messages do not clog the system</li>
<li>Wildcard Subscriptions — Implementing wildcard subscriptions can allow subscribers to subscribe to all topics with a single action, simplifying the management of multiple topics. By addressing these issues and considerations, the Publisher-Subscriber pattern can be effectively implemented to enable scalable, reliable, and secure asynchronous communication between publishers and multiple subscribers.</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="when-to-use-this-pattern-6">When to use this pattern<a href="https://luke.geek.nz/azure/cloud-design-patterns/#when-to-use-this-pattern-6" class="hash-link" aria-label="Direct link to When to use this pattern" title="Direct link to When to use this pattern">​</a></h5>
<p>The Publisher-Subscriber (Pub-Sub) pattern should be used in the following scenarios.</p>
<ul>
<li>Broadcasting Information to Multiple Consumers - When you need to send the same information to multiple consumers simultaneously, the Pub-Sub pattern is ideal. This allows a single publisher to broadcast messages to multiple subscribers without needing to send individual messages to each one</li>
<li>Decoupling Senders and Receivers - When you want to decouple the senders of messages from the receivers, enabling them to operate independently. This is useful in systems where the publisher does not need to know about the subscribers and vice versa</li>
<li>Asynchronous Communication - When you need to enable asynchronous communication between different parts of a system. This allows the publisher to send messages without waiting for the subscribers to process them, improving the overall responsiveness and scalability of the system</li>
<li>Event-Driven Architectures - When implementing event-driven architectures where components need to react to events as they happen. The Pub-Sub pattern allows for real-time event propagation to multiple interested parties</li>
<li>Handling Real-Time Notifications - When you need to provide real-time notifications to multiple subscribers, such as in monitoring systems, alerting mechanisms or live data feeds</li>
<li>Scalability and Flexibility - When you need a scalable and flexible system where new subscribers can be added without modifying the publisher. This allows the system to grow and adapt to new requirements easily</li>
<li>Filtering and Routing Messages — When you need to filter and route messages to specific subscribers based on certain criteria, you can use topics and content filtering mechanisms. By using the Publisher-Subscriber pattern in these scenarios, you can create a robust, scalable, and flexible messaging system that efficiently handles communication between different components.</li>
</ul>
<!-- -->
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="azure-solutions-10">Azure Solutions<a href="https://luke.geek.nz/azure/cloud-design-patterns/#azure-solutions-10" class="hash-link" aria-label="Direct link to Azure Solutions" title="Direct link to Azure Solutions">​</a></h5>
<p>Azure resources that can be used to implement this pattern include <a href="https://learn.microsoft.com/azure/service-bus-messaging/service-bus-messaging-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Service Bus</a>, <a href="https://learn.microsoft.com/azure/event-grid/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Event Grid</a>.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-asynchronous-request-reply">🔄 Asynchronous Request-Reply<a href="https://luke.geek.nz/azure/cloud-design-patterns/#-asynchronous-request-reply" class="hash-link" aria-label="Direct link to 🔄 Asynchronous Request-Reply" title="Direct link to 🔄 Asynchronous Request-Reply">​</a></h4>
<blockquote>
<p>Decouple backend processing from a frontend host, where backend processing needs to be asynchronous, but the frontend still needs a clear response.</p>
</blockquote>
<p>In modern application development, it's normal for client applications — often code running in a web client (browser) — to depend on remote APIs to provide business logic and compose functionality. In most cases, APIs for a client network infrastructure are largely out of the control of the application developer. Most APIs can respond quickly enough for responses to arrive back over the same connection. Application code can make a synchronous API call in a non-blocking way, giving the appearance of asynchronous processing, which is recommended for I/O-bound operations.
In some scenarios, however, the work done by the backend may be long-running, on the order of seconds, or might be a background process that is executed in minutes or even hours. In that case, it isn't feasible to wait for the work to complete before responding to the request. This situation is a potential problem for any synchronous request-reply pattern. Applications are designed to respond quickly, on the order of 100 ms or less.&nbsp;
One solution to this problem is to use HTTP polling. Polling is useful to client-side code, as it can be hard to provide call-back endpoints or use long-running connections. Even when callbacks are possible, the extra libraries and services that are required can sometimes add too much extra complexity.</p>
<p><img decoding="async" loading="lazy" alt="Cloud Design Pattern - Asyncronous Request-Reply" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatterns_AsyncronousRequestReply-ff3dc8c29388435577cb517154ad775c.gif" width="1903" height="1005" class="img_ev3q"></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="issues--considerations-11">Issues &amp; considerations<a href="https://luke.geek.nz/azure/cloud-design-patterns/#issues--considerations-11" class="hash-link" aria-label="Direct link to Issues &amp; considerations" title="Direct link to Issues &amp; considerations">​</a></h5>
<p>The Asynchronous Request-Reply pattern is used to decouple backend processing from a frontend host, where backend processing needs to be asynchronous, but the frontend still needs a clear response. Here are some issues and considerations associated with this pattern</p>
<ul>
<li>Latency and Response Time - The pattern is designed to handle scenarios where backend processing is long-running. However, this introduces latency in the response time, as the client has to poll for the result of the long-running operation. This can affect the user experience if not managed properly</li>
<li>Polling Mechanism - Implementing an efficient polling mechanism is crucial. The HTTP02 response should indicate the location and frequency that the client should poll for the response. This helps in managing the load on the server and ensures that the client does not overwhelm the server with frequent polling requests</li>
<li>Handling Long-Running Operations - The backend must be capable of handling long-running operations efficiently. This includes offloading processing to another component, such as a message queue, and ensuring that the status endpoint can accurately reflect the progress of the operation</li>
<li>Error Handling - Proper error handling mechanisms need to be in place. If an error occurs during processing, the error should persist at the resource URL described in the location header, and the appropriate response code (HTTP 4xx) should be returned. This ensures that the client is aware of any issues and can take appropriate action</li>
<li>Status Codes and Redirects - The API should return the correct status codes based on the state of the operation. For example, upon successful processing, the API should return HTTP00 (OK), HTTP01 (Created), or HTTP04 (No Content). If the status endpoint redirects on completion, HTTP 302 or HTTP 303 should be used</li>
<li>Client-Side Considerations - The client-side code must be designed to handle asynchronous responses. This includes managing the polling logic, handling different status codes, and updating the user interface based on the progress and completion of the operation</li>
<li>Scalability - The pattern allows the client process and the backend API to scale independently. However, this separation also brings additional complexity when the client requires success notification, as this step needs to become asynchronous</li>
<li>Security - Ensuring secure communication between the client and the server is essential. This includes validating both the request and the action to be performed before starting the long-running process and ensuring that sensitive data is protected during transmission</li>
<li>Legacy Clients - Some legacy clients might not support this pattern. It is important to consider the compatibility of the pattern with existing clients and whether additional support or alternative solutions are needed for those clients</li>
<li>Resource Management - Efficiently managing resources such as message queues and status endpoints is crucial to prevent resource exhaustion and ensure the system can handle many concurrent requests. By addressing these issues and considerations, the Asynchronous Request-Reply pattern can be effectively implemented to handle long-running operations while providing a clear response to the client.</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="when-to-use-this-pattern-7">When to use this pattern<a href="https://luke.geek.nz/azure/cloud-design-patterns/#when-to-use-this-pattern-7" class="hash-link" aria-label="Direct link to When to use this pattern" title="Direct link to When to use this pattern">​</a></h5>
<p>The Asynchronous Request-Reply pattern should be used in the following scenarios.</p>
<ul>
<li>Long-Running Backend Operations - When the backend processing is long-running, taking seconds, minutes, or even hours, and it is not feasible to keep the client waiting for the operation to complete. This pattern allows the client to initiate the request and then poll for the result later</li>
<li>Decoupling Frontend and Backend - When you need to decouple the frontend host from the backend processing. This is useful in scenarios where the frontend needs a clear response, but the backend processing needs to be asynchronous</li>
<li>Scalability - When you want to enable the client process and the backend API to scale independently. By using a message broker to separate the request and response stages, you can achieve better scalability and manage load more effectively</li>
<li>Handling High Latency - When factors such as network infrastructure, geographic location, or current load can add significant latency to the response. The pattern helps mitigate these issues by allowing the backend to process the request asynchronously and the client to poll for the result</li>
<li>Microservices Architectures - When implementing microservices architectures where server-to-server REST API calls are common. The pattern helps manage long-running operations and decouples services, making the system more resilient and scalable</li>
<li>Client-Side Polling - When it is difficult to provide call-back endpoints or use long-running connections on the client side. The pattern allows the client to poll for the result, which can be simpler and more efficient in certain scenariosBy using the Asynchronous Request-Reply pattern in these scenarios, you can effectively manage long-running operations, improve scalability, and decouple frontend and backend processing, leading to a more robust and responsive system.</li>
</ul>
<!-- -->
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="azure-solutions-11">Azure Solutions<a href="https://luke.geek.nz/azure/cloud-design-patterns/#azure-solutions-11" class="hash-link" aria-label="Direct link to Azure Solutions" title="Direct link to Azure Solutions">​</a></h5>
<p>An application that uses Azure Functions to implement this pattern. There are three functions in the solution:</p>
<ul>
<li>The asynchronous API endpoint.</li>
<li>The status endpoint.</li>
<li>A backend function that takes queued work items and executes them.</li>
</ul>
<p>Azure resources that can be used to implement this pattern include <a href="https://learn.microsoft.com/azure/azure-functions/functions-overview?pivots=programming-language-csharp&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Functions</a>, <a href="https://learn.microsoft.com/azure/service-bus-messaging/service-bus-messaging-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Service Bus</a>, and <a href="https://learn.microsoft.com/azure/storage/queues/storage-queues-introduction?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Storage Queues</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="reliability-patterns">Reliability Patterns<a href="https://luke.geek.nz/azure/cloud-design-patterns/#reliability-patterns" class="hash-link" aria-label="Direct link to Reliability Patterns" title="Direct link to Reliability Patterns">​</a></h3>
<p><img decoding="async" loading="lazy" alt="Reliability Patterns" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatterns_Reliability-70846e1cb6b986530554f7b4b68a7ab3.PNG" width="4000" height="2250" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="️-circuit-breaker">⚡️ Circuit Breaker<a href="https://luke.geek.nz/azure/cloud-design-patterns/#%EF%B8%8F-circuit-breaker" class="hash-link" aria-label="Direct link to ⚡️ Circuit Breaker" title="Direct link to ⚡️ Circuit Breaker">​</a></h4>
<blockquote>
<p>Handle faults that might take a variable amount of time to recover from when connecting to a remote service or resource. This can improve an application's stability and resiliency.</p>
</blockquote>
<p>In a distributed environment, calls to remote resources and services can fail due to transient faults, such as slow network connections, timeouts, or the resources being overcommitted or temporarily unavailable. These faults typically correct themselves after a short period of time, and a robust cloud application should be prepared to handle them by using a strategy such as the&nbsp;<a href="https://learn.microsoft.com/dotnet/architecture/cloud-native/application-resiliency-patterns?WT.mc_id=AZ-MVP-5004796#retry-pattern" target="_blank" rel="noopener noreferrer">Retry pattern</a>.
However, there can also be situations where faults are due to unanticipated events, and that might take much longer to fix. These faults can range in severity from a partial loss of connectivity to the complete failure of a service. In these situations, it might be pointless for an application to retry an operation that is unlikely to succeed continually, and instead, the application should quickly accept that the operation has failed and handle this failure accordingly. Additionally, if a service is very busy, failure in one part of the system might lead to cascading failures. The purpose of the Circuit Breaker pattern is different than the Retry pattern. The Retry pattern enables an application to retry an operation in the expectation that it'll succeed. The Circuit Breaker pattern prevents an application from performing an operation that is likely to fail. An application can combine these two patterns by using the Retry pattern to invoke an operation through a circuit breaker. However, the retry logic should be sensitive to any exceptions returned by the circuit breaker and abandon retry attempts if the circuit breaker indicates that a fault is not transient. The failure counter used by the&nbsp;Closed&nbsp;state is time-based. It's automatically reset at periodic intervals. This helps to prevent the circuit breaker from entering the&nbsp;Open&nbsp;state if it experiences occasional failures.</p>
<p><img decoding="async" loading="lazy" alt="Cloud Design Patterns - Circuit Breaker" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatterns_CircuitBreaker-f8429abda165e955f780a7b868662150.gif" width="1903" height="1005" class="img_ev3q"></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="issues--considerations-12">Issues &amp; considerations<a href="https://luke.geek.nz/azure/cloud-design-patterns/#issues--considerations-12" class="hash-link" aria-label="Direct link to Issues &amp; considerations" title="Direct link to Issues &amp; considerations">​</a></h5>
<p>The Circuit Breaker pattern is designed to handle faults that might take a variable amount of time to recover from, especially when connecting to remote services or resources. Here are some issues and considerations associated with this pattern</p>
<ul>
<li>State Management - The Circuit Breaker pattern typically involves three states: Closed, Open, and Half-Open. Managing these states correctly is crucial. The Closed state allows normal operation, the Open state immediately fails requests, and the Half-Open state allows a limited number of test requests to check if the issue has been resolved</li>
<li>Thresholds and Timeouts - Setting appropriate thresholds for the number of failures and timeouts is essential. If the thresholds are too low, the circuit breaker might open too frequently, causing unnecessary failures. If they are too high, the system might not protect itself effectively from cascading failures</li>
<li>Recovery Testing - In the Open state, the circuit breaker should periodically test the service to see if it has recovered. This can be done using a timer or by pinging the service. The interval for these tests should be carefully chosen based on the criticality of the operation and the nature of the service&nbsp;</li>
<li>Manual Override - Providing a manual override option can be beneficial in systems where the recovery time for a failing operation is extremely variable. This allows administrators to manually reset the circuit breaker or force it into the Open state as needed</li>
<li>Concurrency - The circuit breaker might be accessed by a large number of concurrent instances of an application. The implementation should ensure that it does not block concurrent requests or add excessive overhead to each call</li>
<li>Resource Differentiation - Using a single circuit breaker for multiple underlying independent providers can be problematic. For example, in a data store with multiple shards, one shard might be accessible while another is experiencing issues. The circuit breaker should differentiate between these resources to avoid unnecessary failures</li>
<li>Accelerated Circuit Breaking - Sometimes, a failure response can provide enough information for the circuit breaker to trip immediately and stay tripped for a minimum amount of time. For example, an overloaded shared resource might indicate that an immediate retry is not recommended</li>
<li>Replaying Failed Requests - In the Open state, the circuit breaker could record the details of each failed request and arrange for these requests to be replayed when the service becomes available again. This ensures that important operations are not lost</li>
<li>Inappropriate Timeouts - The circuit breaker might not fully protect applications from operations that fail in external services configured with lengthy timeouts. If the timeout is too long, a thread running the circuit breaker might be blocked for an extended period, tying up resources</li>
<li>Impact on Shared Resources - Aggressive retry policies can cause an increasing number of transient faults for other users and applications sharing the same resources. It is important to consider the impact of the circuit breaker on shared resources and other tenants in a multi-tenant environment. Addressing these issues and considerations, the Circuit Breaker pattern can be effectively implemented to improve the stability and resiliency of an application, preventing cascading failures and managing long-lasting faults efficiently.</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="when-to-use-this-pattern-8">When to use this pattern<a href="https://luke.geek.nz/azure/cloud-design-patterns/#when-to-use-this-pattern-8" class="hash-link" aria-label="Direct link to When to use this pattern" title="Direct link to When to use this pattern">​</a></h5>
<p>The Circuit Breaker pattern should be used in the following scenarios.</p>
<ul>
<li>Handling Persistent or Non-Transient Errors - When an application encounters persistent or non-transient errors, such as a service being down or a network failure, the Circuit Breaker pattern can prevent the application from continually trying to perform an operation that is likely to fail</li>
<li>Preventing Resource Exhaustion - If a service is frequently unavailable or busy, it might be due to resource exhaustion. The Circuit Breaker pattern helps to prevent further strain on the service by stopping additional requests until the service has had time to recover</li>
<li>Improving System Stability - The pattern provides stability while the system recovers from a failure and minimizes the impact on performance. It quickly rejects requests for operations that are likely to fail rather than waiting for them to time out or never return</li>
<li>Managing Long-Lasting Faults - When faults are likely to be long-lasting or terminal, the Circuit Breaker pattern can handle these faults as exceptions. The application can log the exception and try to continue by invoking an alternative service or offering degraded functionality</li>
<li>Avoiding Cascading Failures - The pattern helps mitigate failures and avoid cascading failures disrupting the entire application. By stopping requests to a failing service, it prevents the failure from propagating to other parts of the system</li>
<li>Testing Service Recovery - The Circuit Breaker pattern allows the application to periodically test the service to detect when it becomes available again. This can be done on an intermittent basis with long intervals between requests, depending on the criticality of the operation and the nature of the service</li>
<li>Logging and Monitoring—The pattern can be used to log all failed requests and monitor the operation's health. This information can be used to alert administrators when a circuit breaker trips to the Open state, providing insights into the system's health. Using the Circuit Breaker pattern in these scenarios, you can improve the resiliency and stability of your application, prevent resource exhaustion, and manage long-lasting faults effectively.</li>
</ul>
<!-- -->
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="azure-solutions-12">Azure Solutions<a href="https://luke.geek.nz/azure/cloud-design-patterns/#azure-solutions-12" class="hash-link" aria-label="Direct link to Azure Solutions" title="Direct link to Azure Solutions">​</a></h5>
<p>Azure resources that can be used to implement this pattern include <a href="https://learn.microsoft.com/azure/api-management/api-management-key-concepts?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure API Management</a>.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-deployment-stamps">📮 Deployment Stamps<a href="https://luke.geek.nz/azure/cloud-design-patterns/#-deployment-stamps" class="hash-link" aria-label="Direct link to 📮 Deployment Stamps" title="Direct link to 📮 Deployment Stamps">​</a></h4>
<blockquote>
<p>The deployment stamp pattern involves provisioning, managing, and monitoring a heterogeneous group of resources to host and operate multiple workloads or tenants.</p>
</blockquote>
<p>The deployment stamp pattern involves provisioning, managing, and monitoring a heterogeneous group of resources to host and operate multiple workloads or tenants. Each individual copy is called a&nbsp;stamp or sometimes a&nbsp;service unit,&nbsp;scale unit, or&nbsp;cell. In a multitenant environment, every stamp or scale unit can serve a predefined number of tenants. Multiple stamps can be deployed to scale the solution almost linearly and serve an increasing number of tenants. This approach can improve the scalability of your solution, allow you to deploy instances across multiple regions, and separate your customer data. consider grouping resources in&nbsp;scale units&nbsp;and provisioning multiple copies of your&nbsp;stamps. Each&nbsp;scale unit&nbsp;will host and serve a subset of your tenants. Stamps operate independently of each other and can be deployed and updated independently. A single geographical region might contain a single stamp or might contain multiple stamps to allow for horizontal scale-out within the region.&nbsp;</p>
<p><img decoding="async" loading="lazy" alt="Cloud Design - Deployment Stamps" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatternsDeploymentStamps-9cecdf26e6ffd5d2c505d7b35df121ae.gif" width="1903" height="1005" class="img_ev3q"></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="issues--considerations-13">Issues &amp; considerations<a href="https://luke.geek.nz/azure/cloud-design-patterns/#issues--considerations-13" class="hash-link" aria-label="Direct link to Issues &amp; considerations" title="Direct link to Issues &amp; considerations">​</a></h5>
<p>Several issues and considerations need to be addressed when implementing the deployment stamp pattern to ensure a successful deployment.</p>
<ul>
<li>Deployment Process - It's crucial to have automated and fully repeatable deployment processes. Tools like Bicep, JSON ARM templates, or Terraform modules can be used to declaratively define your stamps and keep the definitions consistent</li>
<li>Cross-Stamp Operations - When your solution is deployed across multiple stamps, operations that span multiple stamps, such as aggregating customer data, can become complex. Queries might need to be executed against each stamp, and the results aggregated. Alternatively, consider having all stamps publish data into a centralized data warehouse for consolidated reporting</li>
<li>Determining Scale-Out Policies - Stamps have a finite capacity, which might be defined using a proxy metric such as the number of tenants that can be deployed to the stamp. It's important to monitor the available and used capacity for each stamp and proactively deploy additional stamps to accommodate new tenants</li>
<li>Minimum Number of Stamps - It's advisable to deploy at least two stamps of your solution to avoid hard-coding assumptions in your code or configuration that won't apply when you scale out</li>
<li>Cost - Deploying multiple copies of your infrastructure components will likely involve a substantial increase in the cost of operating your solution. This includes the cost of additional memory, compute, and other resources required for each stamp2&nbsp;</li>
<li>Moving Between Stamps - Each stamp is deployed and operated independently, so moving tenants between stamps can be difficult. Custom logic is needed to transmit customer information to a different stamp and remove it from the original stamp. This process might require a backplane for communication between stamps, further increasing the complexity of the solution</li>
<li>Traffic Routing - Routing traffic to the correct stamp for a given request can require an additional component to resolve tenants to stamps. This component needs to be highly available to ensure reliable traffic routing</li>
<li>Shared Components - Some components might be shared across stamps. For example, a shared single-page app for all tenants could be deployed in one region and replicated globally using Azure CDN</li>
<li>Geographical Distribution - For multi-region applications, each tenant's data and traffic should be directed to a specific region. This ensures that requests are routed to the correct stamp based on the user's geographical location</li>
<li>Resiliency During Outages - Stamps are independent of one another, so if an outage affects a single stamp, tenants deployed to other stamps should not be affected. This isolation helps to contain the 'blast radius' of an incident or outage</li>
<li>Handling Single and Multi-Tenant Instances - The pattern should support both single and multi-tenant instances, ensuring that each tenant's data is isolated and secure</li>
<li>Update Frequency — Different stamps might need to be on different versions of your solution at the same time. This requires careful management of updates and version control across stamps. By considering these issues and implementing appropriate strategies, the Deployment Stamp pattern can effectively improve the scalability, resiliency, and manageability of your solution.</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="when-to-use-this-pattern-9">When to use this pattern<a href="https://luke.geek.nz/azure/cloud-design-patterns/#when-to-use-this-pattern-9" class="hash-link" aria-label="Direct link to When to use this pattern" title="Direct link to When to use this pattern">​</a></h5>
<p>The Deployment Stamp pattern is useful in the following scenarios</p>
<ul>
<li>Natural Limits on Scalability - If certain components of your system cannot or should not scale beyond a specific number of customers or requests, the Deployment Stamp pattern allows you to scale out by deploying multiple instances (stamps) of your solution</li>
<li>Tenant Isolation - When there is a requirement to separate certain tenants from others due to security concerns or compliance requirements, the Deployment Stamp pattern can be used to deploy these tenants onto their own isolated stamps</li>
<li>Multi-Region Applications - For applications that need to be deployed across multiple regions, each tenant's data and traffic can be directed to a specific region. This ensures that requests are routed to the correct stamp based on the user's geographical location</li>
<li>Resiliency During Outages - Stamps are independent of one another, so if an outage affects a single stamp, tenants deployed to other stamps should not be affected. This isolation helps to contain the 'blast radius' of an incident or outage, enhancing the overall resiliency of the application</li>
<li>Different Versions of the Solution - If there is a need to have some tenants on different versions of your solution at the same time, the Deployment Stamp pattern allows for this flexibility by deploying different stamps with different versions</li>
<li>High-Scale Platforms — The pattern is suitable for implementing high-scale platforms with users distributed over a wide area. It helps manage the load and ensure that the system can handle a large number of users efficiently. By using the Deployment Stamp pattern in these scenarios, you can achieve better scalability, isolation, and resiliency for your application.</li>
</ul>
<!-- -->
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="azure-solutions-13">Azure Solutions<a href="https://luke.geek.nz/azure/cloud-design-patterns/#azure-solutions-13" class="hash-link" aria-label="Direct link to Azure Solutions" title="Direct link to Azure Solutions">​</a></h5>
<p>Azure resources that can be used to implement this pattern include <a href="https://learn.microsoft.com/azure/traffic-manager/traffic-manager-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Traffic Manager</a>, <a href="https://learn.microsoft.com/azure/frontdoor/front-door-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Front Door</a>.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-bulkhead">🚢 Bulkhead<a href="https://luke.geek.nz/azure/cloud-design-patterns/#-bulkhead" class="hash-link" aria-label="Direct link to 🚢 Bulkhead" title="Direct link to 🚢 Bulkhead">​</a></h4>
<blockquote>
<p>In a bulkhead architecture, elements of an application are isolated into pools so that if one fails, the others will continue to function.</p>
</blockquote>
<p>The Bulkhead pattern is a type of application design that is tolerant of failure. In a bulkhead architecture, elements of an application are isolated into pools so that if one fails, the others will continue to function. It's named after the sectioned partitions (bulkheads) of a ship's hull. If the hull of a ship is compromised, only the damaged section fills with water, which prevents the ship from sinking. A cloud-based application may include multiple services, with each service having one or more consumers. Excessive load or failure in a service will impact all consumers of the service. Partition service instances into different groups, based on consumer load and availability requirements. This design helps to isolate failures and allows you to sustain service functionality for some consumers, even during a failure.</p>
<p>The Bulkhead pattern and the Deployment Stamp pattern are both architectural patterns used to improve the resiliency and scalability of applications, but they address different concerns and are implemented in different ways, for example, the Deployment Stamp isolates entire instances of applications, each with its own services, the bulkhead partner isolates different components or services within the same application or system and is primarily focuses on fault isolation and resource management within a single deployment. These patterns can work together for a highly resistant solution.</p>
<p><img decoding="async" loading="lazy" alt="Cloud Design Patterns - Bulkhead" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatternsBulkhead-907d6c3dd459dc9c800821acd5b027c7.gif" width="1903" height="1005" class="img_ev3q"></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="issues--considerations-14">Issues &amp; considerations<a href="https://luke.geek.nz/azure/cloud-design-patterns/#issues--considerations-14" class="hash-link" aria-label="Direct link to Issues &amp; considerations" title="Direct link to Issues &amp; considerations">​</a></h5>
<p>The Bulkhead pattern is designed to improve the resiliency of an application by isolating different parts of the system to prevent a failure in one part from cascading to others. Here are the key issues and considerations when implementing the Bulkhead pattern
Issues</p>
<ul>
<li>Resource Exhaustion - If a service or consumer fails or becomes misconfigured, it can exhaust resources such as connection pools, memory, or CPU. This can prevent other services or consumers from functioning properly.</li>
<li>Cascading Failures - Without isolation, a failure in one service can lead to cascading failures, affecting the entire system. This can happen if a single service consumes all available resources, leaving none for other services.</li>
<li>Complexity - Implementing the Bulkhead pattern adds complexity to the system. It requires careful planning and management of resource allocation and isolation.</li>
<li>Less Efficient Use of Resources - Isolating resources for different services or consumers can lead to less efficient use of resources. For example, some resources might remain underutilized while others are overutilized
Considerations</li>
<li>Partitioning Services and Consumers — Services and consumers should be divided into different groups based on load and availability requirements. This helps isolate failures and maintain service functionality for some consumers even during a failure.</li>
<li>Resource Allocation - Allocate separate resources (e.g., connection pools, memory) for each service or consumer. This ensures that a failure in one service does not affect the resources available to other services.</li>
<li>Granularity of Bulkheads - Determine the appropriate level of granularity for bulkheads. For example, you could isolate resources at the service level, consumer level, or even at the tenant level.</li>
<li>Combining with Other Patterns - Consider combining the Bulkhead pattern with other fault-handling patterns such as retry, circuit breaker, and throttling to provide more sophisticated fault handling.</li>
<li>Technology Overhead - Evaluate the overhead in terms of cost, performance, and manageability when partitioning services or consumers into bulkheads. For example, using containers can offer a good balance of resource isolation with fairly low overhead.</li>
<li>Monitoring and SLA - Monitor the performance and SLA of each partition to ensure that the isolation is effective and that resources are being used efficiently.</li>
<li>Critical vs. Standard Consumers - Isolate critical consumers from standard consumers to ensure that critical operations can continue even if standard operations fail.</li>
<li>Security—The segmentation between components helps constrain security incidents to the compromised bulkhead, enhancing the overall security of the system. By addressing these issues and considerations, the Bulkhead pattern can help improve the resiliency and reliability of your application, ensuring that failures are contained and do not affect the entire system.</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="when-to-use-this-pattern-10">When to use this pattern<a href="https://luke.geek.nz/azure/cloud-design-patterns/#when-to-use-this-pattern-10" class="hash-link" aria-label="Direct link to When to use this pattern" title="Direct link to When to use this pattern">​</a></h5>
<p>The Bulkhead pattern is particularly useful in the following scenarios</p>
<ul>
<li>Isolating Resources for Backend Services - Use the Bulkhead pattern to isolate resources used to consume a set of backend services. This is especially important if the application can provide some level of functionality even when one of the services is not responding</li>
<li>Isolating Critical Consumers from Standard Consumers - Implement the Bulkhead pattern to isolate critical consumers from standard consumers. This ensures that critical operations can continue even if standard operations fail</li>
<li>Protecting the Application from Cascading Failures - The Bulkhead pattern helps protect the application from cascading failures. By isolating different parts of the system, a failure in one part does not affect the entire system</li>
<li>Handling Resource Exhaustion - When a service or consumer fails or becomes misconfigured, it can exhaust resources such as connection pools, memory, or CPU. The Bulkhead pattern helps to prevent this by isolating resources for different services or consumers</li>
<li>Maintaining Service Functionality During Failures - The Bulkhead pattern allows you to sustain service functionality for some consumers even during a failure. By partitioning service instances into different groups based on consumer load and availability requirements, you can isolate failures and maintain service functionality</li>
<li>Combining with Other Fault-Handling Patterns - Consider combining the Bulkhead pattern with other fault-handling patterns such as retry, circuit breaker, and throttling to provide more sophisticated fault-handling</li>
<li>Deploying Services with Different Quality of Service - The Bulkhead pattern allows you to deploy services that offer a different quality of service for consuming applications. For example, a high-priority consumer pool can be configured to use high-priority services. By using the Bulkhead pattern in these scenarios, you can improve the resiliency and reliability of your application, ensuring that failures are contained and do not affect the entire system.</li>
</ul>
<!-- -->
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="azure-solutions-14">Azure Solutions<a href="https://luke.geek.nz/azure/cloud-design-patterns/#azure-solutions-14" class="hash-link" aria-label="Direct link to Azure Solutions" title="Direct link to Azure Solutions">​</a></h5>
<p>Azure resources that can be used to implement this pattern include <a href="https://learn.microsoft.com/azure/aks/intro-kubernetes?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Kubernetes Service (AKS)</a>, <a href="https://learn.microsoft.com/azure/container-instances/container-instances-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Container Instances</a>, and <a href="https://learn.microsoft.com/azure/azure-functions/functions-overview?pivots=programming-language-csharp&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Functions</a>.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-compensating-transaction">😊 Compensating Transaction<a href="https://luke.geek.nz/azure/cloud-design-patterns/#-compensating-transaction" class="hash-link" aria-label="Direct link to 😊 Compensating Transaction" title="Direct link to 😊 Compensating Transaction">​</a></h4>
<blockquote>
<p>If one or more of the steps fail, you can use the Compensating Transaction pattern to undo the work that the steps performed.</p>
</blockquote>
<p>When you use an eventually consistent operation that consists of a series of steps, the Compensating Transaction pattern can be useful. Specifically, if one or more of the steps fail, you can use the Compensating Transaction pattern to undo the work that the steps performed. Typically, you find operations that follow the eventual consistency model in cloud-hosted applications that implement complex business processes and workflows. Applications that run in the cloud frequently modify data. This data is sometimes spread across various data sources in different geographic locations. To avoid contention and improve performance in a distributed environment, an application shouldn't try to provide strong transactional consistency. Rather, the application should implement eventual consistency. In the eventual consistency model, a typical business operation consists of a series of separate steps. While the operation performs these steps, the overall view of the system state might be inconsistent. But when the operation finishes and all the steps have run, the system should become consistent again. The data that are affected by an operation that implements eventual consistency isn't always held in a database. For example, consider a service-oriented architecture (SOA) environment. An SOA operation can invoke an action in a service and cause a change in the state that's held by that service.</p>
<p>To undo the operation, you also have to undo this state change. This process can involve invoking the service again and performing another action that reverses the effects of the first.</p>
<p>The solution is to implement a compensating transaction. The steps in a compensating transaction undo the effects of the steps in the original operation. An intuitive approach is to replace the current state with the state the system was in at the start of the operation. But a compensating transaction can't always take that approach, because it might overwrite changes that other concurrent instances of an application have made. Instead, a compensating transaction must be an intelligent process that takes into account any work that concurrent instances do. This process is usually application-specific, driven by the nature of the work that the original operation performs.</p>
<p><img decoding="async" loading="lazy" alt="Cloud Design Pattern - Compensating Transaction" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatterns_CompensatingTransaction-6c8294a1cc7c89f819698e941e108ed6.gif" width="1903" height="1005" class="img_ev3q"></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="issues--considerations-15">Issues &amp; considerations<a href="https://luke.geek.nz/azure/cloud-design-patterns/#issues--considerations-15" class="hash-link" aria-label="Direct link to Issues &amp; considerations" title="Direct link to Issues &amp; considerations">​</a></h5>
<p>When implementing the Compensating Transaction pattern, there are several issues and considerations to keep in mind</p>
<ul>
<li>Determining Failure - It might not be easy to determine when a step in an operation that implements eventual consistency fails. A step might not fail immediately but could get blocked. Implementing a time-out mechanism can help identify such failures</li>
<li>Complexity of Compensation Logic - Compensation logic is often application-specific and relies on the application having sufficient information to undo the effects of each step in a failed operation. Generalizing this logic can be challenging</li>
<li>Idempotency - Define the steps in a compensating transaction as idempotent commands. This ensures that the steps can be repeated if the compensating transaction itself fails, which is crucial for maintaining consistency</li>
<li>Resilience and Reliability - The infrastructure handling the steps must be resilient both in the original operation and in the compensating transaction. It should not lose the information required to compensate for a failing step and must reliably monitor the progress of the compensation logic</li>
<li>State Restoration - A compensating transaction doesn't necessarily return the system data to its state at the start of the original operation. Instead, it compensates for the work that the operation completed successfully before it failed</li>
<li>Order of Steps - The order of the steps in the compensating transaction isn't necessarily the exact opposite of the steps in the original operation. For example, one data store might be more sensitive to inconsistencies than another, so the steps that undo changes to this store should occur first</li>
<li>Concurrency and Parallelism - It might be possible to perform some of the undo steps in parallel, depending on how the compensating logic is designed for each step. This can help speed up the compensation process</li>
<li>Manual Intervention - In some cases, manual intervention might be the only way to recover from a step that has failed. The system should raise an alert and provide as much information as possible about the reason for the failure</li>
<li>Resource Locking - To increase the likelihood of overall activity success, you can place a short-term, time-out–based lock on each resource required to complete an operation. Obtain these resources in advance and perform the work only after acquiring all the resources, finalizing all actions before the locks expire</li>
<li>Retry Logic - Implement retry logic that is more forgiving than usual to minimize failures that trigger a compensating transaction. If a step in an operation fails, handle the failure as a transient exception and repeat the step. Stop the operation and initiate a compensating transaction only if a step fails repeatedly or can't be recovered. By considering these issues and implementing appropriate strategies, you can effectively manage the complexities associated with compensating transactions and ensure the reliability and consistency of your application.</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="when-to-use-this-pattern-11">When to use this pattern<a href="https://luke.geek.nz/azure/cloud-design-patterns/#when-to-use-this-pattern-11" class="hash-link" aria-label="Direct link to When to use this pattern" title="Direct link to When to use this pattern">​</a></h5>
<p>The Compensating Transaction pattern should be used in the following scenarios.</p>
<ul>
<li>Undoing Operations in Eventual Consistency Models - Use this pattern to undo operations that implement the eventual consistency model. This is particularly useful when you need to maintain data consistency across distributed systems</li>
<li>Handling Failures in Long-Running Transactions - When dealing with long-running transactions that involve multiple steps, the Compensating Transaction pattern can be used to undo the effects of each step if the transaction fails at any point. This ensures that the system can recover gracefully from failures</li>
<li>Ensuring Reliability and Resilience - Implement this pattern to address malfunctions in critical workload paths by rolling back data changes, breaking transaction locks, or executing native system behavior to reverse the effect. This helps make the workload resilient to malfunctions and ensures it recovers to a fully functioning state after a failure</li>
<li>Complex Business Processes and Workflows - Use the Compensating Transaction pattern in cloud-hosted applications that implement complex business processes and workflows. This pattern helps in managing eventual consistency and ensuring that the system can handle failures effectively</li>
<li>Avoiding the Complexity of Distributed Transactions - When it is not feasible to use distributed transactions due to their complexity and overhead, the Compensating Transaction pattern can be an alternative. It allows you to break down a distributed transaction into separate, compensable tasks</li>
<li>Handling State Changes in Service-Oriented Architectures (SOA) - In an SOA environment, where operations can cause changes in the state held by services, the Compensating Transaction pattern can be used to undo these state changes if necessary</li>
<li>Manual Intervention and Recovery - In cases where manual intervention might be required to recover from a failed step, the Compensating Transaction pattern can be used to raise alerts and provide information about the failure, allowing for manual recovery actions using the Compensating Transaction pattern in these scenarios, you can ensure that your system can handle failures gracefully, maintain data consistency, and recover from errors effectively.</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="azure-solutions-15">Azure Solutions<a href="https://luke.geek.nz/azure/cloud-design-patterns/#azure-solutions-15" class="hash-link" aria-label="Direct link to Azure Solutions" title="Direct link to Azure Solutions">​</a></h5>
<p>Customers use a travel website to book itineraries. A single itinerary might consist of a series of flights and hotels. A customer who travels from Seattle to London and then on to Paris might perform the following steps when creating an itinerary:</p>
<ol>
<li>Book a seat on flight F1 from Seattle to London.</li>
<li>Book a seat on flight F2 from London to Paris.
3 Book a seat on flight F3 from Paris to Seattle.</li>
<li>Reserve a room at Hotel H1 in London.</li>
<li>Reserve a room at Hotel H2 in Paris.</li>
</ol>
<p>These steps constitute an eventually consistent operation, although each step is a separate action. In addition to performing these steps, the system must also record the counter operations for undoing each step. This information is needed in case the customer cancels the itinerary. The steps necessary to perform the counter operations can then run as a compensating transaction.</p>
<p>In many business solutions, failure of a single step doesn't always necessitate rolling back the system by using a compensating transaction. For example, consider the travel website scenario. Suppose the customer books flights F1, F2, and F3 but can't reserve a room at Hotel H1. It's preferable to offer the customer a room at a different hotel in the same city rather than canceling the flights. The customer can still decide to cancel. In that case, the compensating transaction runs and undoes the bookings for flights F1, F2, and F3. But the customer should make this decision, not the system.</p>
<p>Azure resources that can be used to implement this pattern include <a href="https://learn.microsoft.com/azure/azure-functions/functions-overview?pivots=programming-language-csharp&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Functions</a>, <a href="https://learn.microsoft.com/azure/logic-apps/logic-apps-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Logic Apps</a>, and <a href="https://learn.microsoft.com/azure/service-bus-messaging/service-bus-messaging-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Service Bus</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="security-patterns">Security Patterns<a href="https://luke.geek.nz/azure/cloud-design-patterns/#security-patterns" class="hash-link" aria-label="Direct link to Security Patterns" title="Direct link to Security Patterns">​</a></h3>
<p><img decoding="async" loading="lazy" alt="Security Patterns" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatterns_Security-9a83139c43344330ae46f562128457f2.PNG" width="4000" height="2250" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-backends-for-frontends">😊 Backends for Frontends<a href="https://luke.geek.nz/azure/cloud-design-patterns/#-backends-for-frontends" class="hash-link" aria-label="Direct link to 😊 Backends for Frontends" title="Direct link to 😊 Backends for Frontends">​</a></h4>
<blockquote>
<p>Create separate backend services to be consumed by specific frontend applications or interfaces.</p>
</blockquote>
<p>The Backends for Frontends (BFF) pattern involves creating separate backend services tailored to specific frontend applications or interfaces. This pattern is particularly useful when you want to avoid customizing a single backend for multiple interfaces, which can lead to conflicting requirements and development bottlenecks. An application may initially target a desktop web UI, with a backend service developed to support it. As the user base grows, a mobile application might be developed that needs to interact with the same backend. However, the capabilities and requirements of mobile devices differ significantly from desktop browsers, leading to competing requirements for the backend. An application may initially target a desktop web UI, with a backend service developed to support it. As the user base grows, a mobile application might be developed that needs to interact with the same backend. However, the capabilities and requirements of mobile devices differ significantly from desktop browsers, leading to competing requirements for the backend</p>
<p><img decoding="async" loading="lazy" alt="Cloud Design Pattern - Backends for Frontends" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatterns_BackendsForFrontEnds-47133a5cf1a841b794d2d81dfd40c7d1.gif" width="1903" height="1005" class="img_ev3q"></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="issues--considerations-16">Issues &amp; considerations<a href="https://luke.geek.nz/azure/cloud-design-patterns/#issues--considerations-16" class="hash-link" aria-label="Direct link to Issues &amp; considerations" title="Direct link to Issues &amp; considerations">​</a></h5>
<p>When implementing the Backends for Frontends (BFF) pattern, there are several issues and considerations to keep in mind
&nbsp;</p>
<ul>
<li>Competing Requirements - Different frontends (e.g., desktop web UI and mobile applications) have varying requirements in terms of screen size, performance, and display limitations. These differences can lead to competing requirements for the backend, making it challenging to serve both interfaces effectively</li>
<li>Development Bottlenecks - The backend can become a bottleneck in the development process due to the need to accommodate conflicting update requirements from different front-end teams. This can result in significant effort being spent on maintaining a single deployable resource that serves multiple frontends</li>
<li>Complexity in Maintenance - Maintaining separate backends for each frontend can increase the complexity of the system. Each backend needs to be updated and maintained independently, which can lead to increased operational overhead
Considerations</li>
<li>Segmentation and Isolation - The BFF pattern introduces segmentation and isolation by creating separate backend services for each frontend. This reduces the surface area of the API and limits lateral movement among different backends, which might expose different capabilities</li>
<li>Tailored Security and Authorization - The separation allows for tailored security and authorization mechanisms for each front end. This ensures that the security requirements for each frontend are addressed effectively, potentially reducing the surface area of an API</li>
<li>Optimized Interfaces - By creating separate backends for each client, you can expose an optimal interface for that client. This allows for different payload sizes or interaction patterns that are specific to the needs of each front, improving performance and user experience</li>
<li>Reduced Attack Surface - The BFF pattern reduces the attack surface by limiting the functionality exposed by each backend to only what is necessary for its corresponding front end. This minimizes the potential for security vulnerabilities</li>
<li>Enhanced Monitoring and Control - The separation of backends allows for more granular monitoring and control over each service. Security incidents can be contained within the specific backend, reducing the blast radius of any potential compromise</li>
<li>Compliance and Regulatory Requirements - Different frontends might have different compliance and regulatory requirements. The BFF pattern allows for these requirements to be addressed individually, ensuring that each backend complies with the necessary standards By considering these issues and implementing appropriate strategies, you can effectively manage the complexities associated with the Backends for Frontends pattern and ensure the reliability, security, and performance of your application.</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="when-to-use-this-pattern-12">When to use this pattern<a href="https://luke.geek.nz/azure/cloud-design-patterns/#when-to-use-this-pattern-12" class="hash-link" aria-label="Direct link to When to use this pattern" title="Direct link to When to use this pattern">​</a></h5>
<p>The Backends for Frontends (BFF) pattern should be used in the following scenarios.</p>
<ul>
<li>Different Client Requirements - When different types of clients, such as mobile applications and desktop web browsers, require different payload sizes or interaction patterns, the BFF pattern is useful. It allows you to create separate backends for each client, which exposes an optimal interface for that client</li>
<li>Avoiding Backend Bottlenecks - If the backend service becomes a bottleneck due to conflicting update requirements from different frontend teams, the BFF pattern can help. By creating separate backend services for each frontend, you can reduce the effort spent on maintaining a single deployable resource that serves multiple frontends</li>
<li>Competing Requirements - When the capabilities of different frontends (e.g., mobile devices vs. desktop browsers) differ significantly, leading to competing requirements for the backend, the BFF pattern can address these differences. It allows each backend to be optimized for the specific needs of its corresponding frontend</li>
<li>Security and Authorization - The BFF pattern is beneficial when you need to tailor security and authorization mechanisms for each front end. By individualizing the service layer for each front, you can reduce the surface area of the API and limit lateral movement among different backends, which might expose different capabilities</li>
<li>Optimized Interfaces - When you need to expose an optimal interface for each client, the BFF pattern is appropriate. This allows for different payload sizes or interaction patterns that are specific to the needs of each frontend, improving performance and user experience. Using the Backends for Frontends pattern in these scenarios, you can effectively manage the complexities associated with serving multiple frontends, ensure optimal performance, and enhance the security of your application.</li>
</ul>
<!-- -->
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="azure-solutions-16">Azure Solutions<a href="https://luke.geek.nz/azure/cloud-design-patterns/#azure-solutions-16" class="hash-link" aria-label="Direct link to Azure Solutions" title="Direct link to Azure Solutions">​</a></h5>
<p>Azure resources that can be used to implement this pattern include <a href="https://learn.microsoft.com/azure/api-management/api-management-key-concepts?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure API Management</a>, <a href="https://learn.microsoft.com/azure/application-gateway/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Application Gateway</a>, <a href="https://learn.microsoft.com/azure/app-service/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">App Service</a>.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-gatekeeper">🚧 Gatekeeper<a href="https://luke.geek.nz/azure/cloud-design-patterns/#-gatekeeper" class="hash-link" aria-label="Direct link to 🚧 Gatekeeper" title="Direct link to 🚧 Gatekeeper">​</a></h4>
<blockquote>
<p>Protect applications and services by using a dedicated host instance to broker requests between clients and the application or service.</p>
</blockquote>
<p>Cloud services expose endpoints that allow client applications to call their APIs. The code used to implement the APIs triggers or performs several tasks, including but not limited to authentication, authorization, parameter validation, and some or all request processing. The API code is likely to access storage and other services on behalf of the client.
If a malicious user compromises the system and gains access to the application's hosting environment, its security mechanisms and access to data and other services are exposed. As a result, the malicious user can gain unrestricted access to credentials, storage keys, sensitive information, and other services.</p>
<p>The GateKeeper patterns allow you to protect applications and services by using a dedicated host instance to broker requests between clients and the application or service. The broker validates and sanitizes the requests, and can provide an additional layer of security and limit the system's attack surface.</p>
<p><img decoding="async" loading="lazy" alt="Cloud Design Pattern - Gatekeeper" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatterns_Gatekeeper-dfdbd58457930fd19f00df9155c09beb.gif" width="1903" height="1005" class="img_ev3q"></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="issues--considerations-17">Issues &amp; considerations<a href="https://luke.geek.nz/azure/cloud-design-patterns/#issues--considerations-17" class="hash-link" aria-label="Direct link to Issues &amp; considerations" title="Direct link to Issues &amp; considerations">​</a></h5>
<p>The Gatekeeper pattern is a design pattern used to protect applications and services by acting as an intermediary that validates and sanitizes requests before passing them to the trusted host. Here are the key issues and considerations when implementing this pattern
&nbsp;</p>
<ul>
<li>Single Point of Failure - The gatekeeper instance could become a single point of failure. If the gatekeeper fails, it can disrupt the entire system. To mitigate this, consider deploying redundant instances and using an autoscaling mechanism to ensure capacity and maintain availability</li>
<li>Performance Impact - Adding the gatekeeper layer introduces additional processing and network communication, which can impact the overall performance of the system. This additional latency needs to be considered, especially for performance-critical applications</li>
<li>Complexity in Implementation - Implementing the gatekeeper pattern adds complexity to the system architecture. It requires careful design to ensure that the gatekeeper effectively validates and sanitizes requests without becoming a bottleneck or introducing new vulnerabilities
Considerations
&nbsp;</li>
<li>Controlled Validation - The gatekeeper should validate all incoming requests and reject those that do not meet the validation requirements. This helps in ensuring that only legitimate requests are processed by the trusted host</li>
<li>Limited Risk and Exposure - The gatekeeper should not have access to the credentials or keys used by the trusted host to access storage and services. This limits the risk and exposure in case the gatekeeper is compromised, as the attacker would not gain access to these sensitive credentials or keys</li>
<li>Appropriate Security - The gatekeeper should run in a limited privilege mode, while the rest of the application runs in full trust mode required to access storage and services. This ensures that even if the gatekeeper is compromised, it cannot directly access the application services or data</li>
<li>Secure Communication - Use secure communication channels (e.g., HTTPS, SSL, or TLS) between the gatekeeper and the trusted hosts or tasks. This helps protect the data in transit and ensures that the communication between the gatekeeper and the trusted hosts is secure</li>
<li>Internal or Protected Endpoints - Ensure that the trusted hosts expose only internal or protected endpoints that are used exclusively by the gatekeeper. The trusted hosts should not expose any external endpoints or interfaces to minimize the attack surface</li>
<li>Redundant Instances - To minimize the impact of a failure, deploy redundant instances of the gatekeeper and use an autoscaling mechanism to ensure that there is always sufficient capacity to handle incoming requests</li>
<li>Separation of Concerns - The gatekeeper should not perform any processing related to the application or services or access any data. Its function should be purely to validate and sanitize requests. The trusted hosts might need to perform additional request validation, but the core validation should be done by the gatekeeper. By considering these issues and implementing appropriate strategies, you can effectively manage the complexities associated with the Gatekeeper pattern and ensure the reliability, security, and performance of your application.</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="when-to-use-this-pattern-13">When to use this pattern<a href="https://luke.geek.nz/azure/cloud-design-patterns/#when-to-use-this-pattern-13" class="hash-link" aria-label="Direct link to When to use this pattern" title="Direct link to When to use this pattern">​</a></h5>
<p>The Gatekeeper pattern should be used in the following scenarios.</p>
<ul>
<li>Handling Sensitive Information - When your application handles sensitive information that requires a high degree of protection from malicious attacks, the Gatekeeper pattern is beneficial. It acts as an intermediary that validates and sanitizes requests before they reach the trusted host, thereby protecting sensitive data</li>
<li>High-Security Requirements - If your application exposes services that require robust security measures, such as web application firewalls, DDoS protection, bot detection, and centralized authentication and authorization checks, the Gatekeeper pattern can centralize these security functionalities</li>
<li>Mission-Critical Operations - For applications that perform mission-critical operations that cannot be disrupted, the Gatekeeper pattern ensures that only validated and sanitized requests are processed, reducing the risk of malicious attacks and system failures</li>
<li>Separate Request Validation - When there is a need to perform request validation separately from the main tasks or to centralize this validation to simplify maintenance and administration, the Gatekeeper pattern is appropriate. It ensures that the core validation is done by the gatekeeper, while the trusted hosts might perform additional validation</li>
<li>Reducing Attack Surface - The Gatekeeper pattern is useful when you want to reduce the attack surface of your system. By decoupling the public endpoints from the code that processes requests and accesses storage, the gatekeeper can provide an additional layer of security and limit the system's exposure to potential attacks</li>
<li>Secure Communication - When secure communication between clients and the application or service is required, the Gatekeeper pattern can be implemented using secure communication channels (e.g., HTTPS, SSL, or TLS) between the gatekeeper and the trusted hosts or tasks</li>
<li>Redundancy and Availability - In scenarios where high availability is crucial, deploying redundant instances of the gatekeeper and using an autoscaling mechanism can ensure that there is always sufficient capacity to handle incoming requests, minimizing the impact of a failure using the Gatekeeper pattern in these scenarios, you can enhance the security, reliability, and performance of your application, ensuring that it meets the necessary protection and operational requirements.</li>
</ul>
<!-- -->
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="azure-solutions-17">Azure Solutions<a href="https://luke.geek.nz/azure/cloud-design-patterns/#azure-solutions-17" class="hash-link" aria-label="Direct link to Azure Solutions" title="Direct link to Azure Solutions">​</a></h5>
<p>The Azure resources that can be used to implement this pattern include <a href="https://learn.microsoft.com/azure/application-gateway/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Application Gateway</a> and <a href="https://learn.microsoft.com/azure/firewall/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Firewall</a>.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-federated-identity">🤝 Federated Identity<a href="https://luke.geek.nz/azure/cloud-design-patterns/#-federated-identity" class="hash-link" aria-label="Direct link to 🤝 Federated Identity" title="Direct link to 🤝 Federated Identity">​</a></h4>
<blockquote>
<p>Delegate authentication to an external identity provider. This can simplify development, minimize the requirement for user administration, and improve the user experience of the application.</p>
</blockquote>
<p>Users typically need to work with multiple applications provided and hosted by different organizations they have a business relationship with.</p>
<p>Implement an authentication mechanism that can use federated identity. Separate user authentication from the application code and delegate authentication to a trusted identity provider.</p>
<p>This model is often called claims-based access control. Applications and services authorize access to features and functionality based on the claims contained in the token. The service that requires authentication must trust the IdP. The client application contacts the IdP, which performs the authentication.</p>
<p>Federated authentication provides a standards-based solution to the issue of trusting identities across diverse domains,</p>
<p>This type of authentication is becoming more common across all types of applications, especially cloud-hosted applications because it supports single sign-on without requiring a direct network connection to identity providers. The user doesn't have to enter credentials for every application. This increases security because it prevents the creation of credentials required to access many different applications, and it also hides the user's credentials from all but the original identity provider. Applications see just the authenticated identity information contained within the token.</p>
<p><img decoding="async" loading="lazy" alt="Cloud Design Patterns - Federated Identity" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatterns_FederatedIdentity-5b9a27bec42e4de3f7e85841b2a0718e.gif" width="1903" height="1005" class="img_ev3q"></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="issues--considerations-18">Issues &amp; considerations<a href="https://luke.geek.nz/azure/cloud-design-patterns/#issues--considerations-18" class="hash-link" aria-label="Direct link to Issues &amp; considerations" title="Direct link to Issues &amp; considerations">​</a></h5>
<p>When implementing the Federated Identity pattern, there are several issues and considerations to keep in mind
Issues
&nbsp;</p>
<ul>
<li>Single Point of Failure - Authentication can become a single point of failure. If the identity provider (IdP) or the Security Token Service (STS) fails, it can disrupt access to all applications relying on it. To mitigate this, consider deploying your identity management mechanism across multiple data centers to maintain reliability and availability</li>
<li>Complexity in Implementation - Implementing federated identity can be complex, especially if retrofitting it into existing applications that were built using different authentication mechanisms. This complexity can make it less cost-effective and more challenging to manage</li>
<li>Performance Impact - The additional steps involved in federated authentication, such as token issuance and validation, can introduce latency. This performance impact needs to be considered, especially for applications requiring high responsiveness</li>
<li>Security Vulnerabilities - Federated identity can expose security vulnerabilities if not properly managed. For example, if a user leaves the company and their account is not immediately deprovisioned, it can lead to unauthorized access. Ensuring timely de-provisioning and robust security practices is crucial</li>
<li>Administrative Overhead - While federated identity can reduce the administrative overhead of managing user credentials within the application, it requires careful management of the relationship with the identity provider. This includes ensuring that the identity provider's security practices are robust and that the integration is maintained.
&nbsp;* Role-Based Access Control (RBAC) - Federated identity allows for the implementation of RBAC based on role claims contained in the authentication token. This provides a more granular level of control over access to features and resources within the application</li>
<li>Home Realm Discovery - If there are multiple identity providers configured, the STS must determine which identity provider the user should be redirected to for authentication. This process, known as home realm discovery, can be automated based on various factors such as email address, subdomain, IP address, or cookies</li>
<li>User Experience - Federated identity can improve the user experience by enabling single sign-on (SSO) across multiple applications. Users do not need to remember multiple credentials, which simplifies their interaction with the system and reduces the likelihood of forgotten passwords</li>
<li>Security and Compliance - Offloading user management and authentication to a trusted identity provider can enhance security by leveraging the provider's advanced capabilities for identity-based threat detection and prevention. This also helps in meeting compliance requirements without implementing these capabilities in the application itself</li>
<li>Business Continuity - Federated systems typically require a load-balanced array of servers to ensure high availability for authentication requests. This setup helps maintain business continuity by providing redundancy and failover capabilities</li>
<li>Integration with Third-Party Services - Federated identity is useful for integrating with third-party services and applications, especially in scenarios where multiple organizations need to collaborate. It allows users from different organizations to authenticate using their own credentials, simplifying access management. By considering these issues and implementing appropriate strategies, you can effectively manage the complexities associated with the Federated Identity pattern and ensure the reliability, security, and performance of your application.</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="when-to-use-this-pattern-14">When to use this pattern<a href="https://luke.geek.nz/azure/cloud-design-patterns/#when-to-use-this-pattern-14" class="hash-link" aria-label="Direct link to When to use this pattern" title="Direct link to When to use this pattern">​</a></h5>
<p>The Federated Identity pattern should be used in the following scenarios.</p>
<ul>
<li>Single Sign-On in the Enterprise - When you need to authenticate employees for corporate applications hosted in the cloud outside the corporate security boundary, without requiring them to sign in every time they visit an application. This provides a seamless user experience similar to on-premises applications where users authenticate once and gain access to all relevant applications</li>
<li>Federated Identity with Multiple Partners - When you need to authenticate both corporate employees and business partners who do not have accounts in the corporate directory. This is common in business-to-business applications, applications that integrate with third-party services, and scenarios where companies with different IT systems have merged or shared resources</li>
<li>SaaS Applications - For independent software vendors providing a ready-to-use service for multiple clients or tenants. Each tenant can authenticate using a suitable identity provider, such as corporate credentials for business users or social identity credentials for consumers and clients of the tenant</li>
<li>Improving User Experience - When users typically need to work with multiple applications provided and hosted by different organizations, federated identity can simplify the user experience by allowing them to use the same credentials across all applications. This reduces the likelihood of forgotten passwords and provides a more cohesive user experience</li>
<li>Reducing Administrative Overhead - When you want to minimize the administrative overhead of managing user credentials within the application. By delegating authentication to a trusted identity provider, you can simplify development and reduce the need for user administration tasks such as password reminders and account deprovisioning</li>
<li>Enhancing Security - When you need to enhance security by offloading user management and authentication to a trusted identity provider. This can provide advanced capabilities for identity-based threat detection and prevention and ensure that user credentials are managed securely</li>
<li>Supporting Claims-Based Access Control — When you need to implement role-based access control (RBAC) based on role claims contained in the authentication token, this allows for a more granular level of control over access to features and resources within the application.</li>
</ul>
<!-- -->
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="azure-solutions-18">Azure Solutions<a href="https://luke.geek.nz/azure/cloud-design-patterns/#azure-solutions-18" class="hash-link" aria-label="Direct link to Azure Solutions" title="Direct link to Azure Solutions">​</a></h5>
<p>Azure services that can be used to implement this pattern include <a href="https://learn.microsoft.com/entra/fundamentals/whatis?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Microsoft Entra ID</a> and <a href="https://learn.microsoft.com/entra/external-id/external-identities-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Microsoft Entra ID External</a>.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="️-gateway-offloading">🛡️ Gateway Offloading<a href="https://luke.geek.nz/azure/cloud-design-patterns/#%EF%B8%8F-gateway-offloading" class="hash-link" aria-label="Direct link to 🛡️ Gateway Offloading" title="Direct link to 🛡️ Gateway Offloading">​</a></h4>
<blockquote>
<p>Offload shared or specialized service functionality to a gateway proxy.</p>
</blockquote>
<p>This pattern can simplify application development by moving shared service functionality, such as the use of SSL certificates, from other parts of the application into the gateway. Offload some features into a gateway, particularly cross-cutting concerns such as certificate management, authentication, SSL termination, monitoring, protocol translation, or throttling.</p>
<p>It is similar to the Gatekeeper pattern, which focuses on protecting applications by validating and sanitizing requests, decoupling public endpoints from backend processing, and centralizing security functionalities to limit the system's attack surface.</p>
<p>The Gateway Offloading&nbsp;focuses on offloading cross-cutting concerns and shared functionalities to a gateway to simplify application development and maintenance, enhance security, and ensure consistency in logging and monitoring.</p>
<p><img decoding="async" loading="lazy" alt="Cloud Design - Gateway Offloading" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatterns_GatewayOffloading-ce8501ca20441af693abcb1fce2f0914.gif" width="1903" height="1005" class="img_ev3q"></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="issues--considerations-19">Issues &amp; considerations<a href="https://luke.geek.nz/azure/cloud-design-patterns/#issues--considerations-19" class="hash-link" aria-label="Direct link to Issues &amp; considerations" title="Direct link to Issues &amp; considerations">​</a></h5>
<p>When implementing the Gateway Offloading pattern, there are several issues and considerations to keep in mind</p>
<ul>
<li>Coupling Across Services - Introducing a gateway can create coupling across services, which might not be suitable for all architectures. This coupling can lead to dependencies that complicate the deployment and scaling of individual services</li>
<li>Single Point of Failure - The gateway itself can become a single point of failure if not properly managed. It is crucial to ensure that the gateway is highly available and resilient to failure by running multiple instances and designing it for the capacity and scaling requirements of the application</li>
<li>Performance Overhead - Offloading functionality to a gateway can introduce performance overhead. The gateway must be designed to handle the additional load without becoming a bottleneck for the application. This includes ensuring that the gateway can scale appropriately to meet the demands of the application</li>
<li>Security Management - Properly handling security issues such as token validation, encryption, and SSL certificate management requires specialized skills. The gateway must be configured and managed by a team with the necessary expertise to ensure that security is not compromised</li>
<li>Administrative Overhead - While offloading shared functionalities to a gateway can reduce administrative overhead in some areas, it can also introduce new administrative tasks. For example, managing and updating SSL certificates or other shared resources at the gateway level requires careful coordination and planning</li>
<li>Consistency in Logging and Monitoring - The gateway can provide consistency in request and response logging and monitoring. However, it is essential to ensure that the gateway is correctly instrumented to provide the necessary level of monitoring and logging, even if individual services are not</li>
<li>Specialized Features - Offloading specialized features such as authentication, authorization, logging, monitoring, or throttling to the gateway allows dedicated teams to manage these features. This can simplify the development and maintenance of the core application but requires coordination between teams to ensure that the offloaded features are correctly implemented and maintained</li>
<li>Business Logic - Business logic should never be offloaded to the gateway. The gateway should only handle cross-cutting concerns that are used by the entire application, such as security or data transfer. Offloading business logic can lead to a tightly coupled architecture that is difficult to maintain and scale. Considering these issues and carefully planning the implementation, you can effectively use the Gateway Offloading pattern to simplify application development, enhance security, and ensure consistency in logging and monitoring.</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="when-to-use-this-pattern-15">When to use this pattern<a href="https://luke.geek.nz/azure/cloud-design-patterns/#when-to-use-this-pattern-15" class="hash-link" aria-label="Direct link to When to use this pattern" title="Direct link to When to use this pattern">​</a></h5>
<p>The Gateway Offloading pattern should be used in the following scenarios.</p>
<ul>
<li>Shared or Specialized Service Functionality - When you need to offload shared or specialized service functionality, such as SSL certificate management, authentication, authorization, logging, monitoring, or throttling, to a gateway proxy. This can simplify application development by moving these cross-cutting concerns from other parts of the application into the gateway</li>
<li>Reducing Administrative Overhead - When managing shared features across multiple services increases administrative overhead and the likelihood of deployment errors. Offloading these features to a gateway can reduce the need to configure, manage, and maintain them across all services, simplifying updates and reducing the risk of errors</li>
<li>Centralized Security Management - When you need to handle complex security tasks such as token validation, encryption, and SSL certificate management. Offloading these tasks to a gateway allows dedicated teams with specialized skills to manage them, ensuring that security is not compromised</li>
<li>Consistency in Logging and Monitoring - When you want to ensure consistency in request and response logging and monitoring across services. The gateway can be configured to provide a minimum level of monitoring and logging, even if individual services are not correctly instrumented</li>
<li>High Availability and Resilience - When you need to ensure that the gateway is highly available and resilient to failure. Running multiple instances of the gateway and designing it for the capacity and scaling requirements of the application can help avoid single points of failure and ensure that the gateway does not become a bottleneck</li>
<li>Simplifying Configuration and Management - When you want to simplify the configuration and management of supporting resources, such as web server certificates and secure website configurations. Offloading these responsibilities to a gateway can make service upgrades simpler and more manageable</li>
<li>Specialized Team Management - When you want to allow dedicated teams to implement features that require specialized expertise, such as security. This allows your core team to focus on the application functionality, leaving these specialized but cross-cutting concerns to the relevant experts</li>
<li>Network Security and Attack Mitigation - When you need to mitigate attacks at the edge ensure that internet traffic routes only through the gateway, not directly to the workloads or PaaS services. The gateway should have the ability to mitigate exploits and provide network security. By considering these scenarios, you can determine whether the Gateway Offloading pattern is suitable for your application and ensure that it meets the necessary security, user experience, and administrative requirements.</li>
</ul>
<!-- -->
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="azure-solutions-19">Azure Solutions<a href="https://luke.geek.nz/azure/cloud-design-patterns/#azure-solutions-19" class="hash-link" aria-label="Direct link to Azure Solutions" title="Direct link to Azure Solutions">​</a></h5>
<p>Azure resources that can be used to implement this pattern include <a href="https://learn.microsoft.com/azure/frontdoor/front-door-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Front Door with WAF</a>, <a href="https://learn.microsoft.com/azure/application-gateway/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Application Gateway</a> and <a href="https://learn.microsoft.com/azure/firewall/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Firewall</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="️-architecting-for-azure">🏗️ Architecting for Azure<a href="https://luke.geek.nz/azure/cloud-design-patterns/#%EF%B8%8F-architecting-for-azure" class="hash-link" aria-label="Direct link to 🏗️ Architecting for Azure" title="Direct link to 🏗️ Architecting for Azure">​</a></h3>
<p>The following Frameworks can help guide you, from the business requirements to the technical implementation of your solution:</p>
<ol>
<li><a href="https://learn.microsoft.com/azure/cloud-adoption-framework/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Cloud Adoption Framework</a> - Proven guidance and best practices that help you confidently adopt the cloud and achieve business outcomes.</li>
<li><a href="https://learn.microsoft.com/azure/architecture/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Architecture Center</a> - Guidance for architecting solutions on Azure using established patterns and practices</li>
<li><a href="https://learn.microsoft.com/azure/architecture/patterns/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Cloud Design Patterns (part of Architecture Center)</a> - Design patterns are useful for building reliable, scalable, secure applications in the cloud.</li>
<li><a href="https://learn.microsoft.com/azure/well-architected/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Well-Architected Framework</a> - A set of quality-driven tenets, architectural decision points, and review tools intended to help solution architects build a technical foundation for their workloads.</li>
</ol>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>"Design patterns are important for reusability, efficiency, maintainability, consistency, performance, and modularity</p><p>Cloud design patterns are important for scalability, resilience, operational excellence, performance efficiency, and security
Categories of patterns include data management, security, reliability, messaging, and design &amp; implementation
Implementing patterns in Azure involves using the Cloud Adoption Framework, Well-Architected Framework, and Azure Architecture Center</p><p>Recap: Design patterns are important in modern cloud architecture and can be implemented in Azure using established frameworks and guidance to ensure scalability, resilience, and security."</p></div></div>
<p><img decoding="async" loading="lazy" alt="The time is now, go build!The time is now, go build!" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatterns_TimettoBuild-9b4a19c83b962127f6596c68a936f92d.PNG" width="4000" height="2250" class="img_ev3q"></p>]]></content:encoded>
            <category>Azure</category>
            <category>Misc</category>
            <category>Service Management</category>
        </item>
        <item>
            <title><![CDATA[Export Azure DevOps Repositories to Azure Storage Account]]></title>
            <link>https://luke.geek.nz/azure/export-azure-devops-repos-azure-storage-account/</link>
            <guid>https://luke.geek.nz/azure/export-azure-devops-repos-azure-storage-account/</guid>
            <pubDate>Mon, 13 May 2024 08:21:56 GMT</pubDate>
            <description><![CDATA[This is a step-by-step guide on exporting Azure DevOps repositories to an Azure Storage Account for backup and recovery.]]></description>
            <content:encoded><![CDATA[<p>When recently deleted, Azure DevOps code repositories go into a soft-delete state, any repositories deleted are retained for 30 days before they are permanently deleted.</p>
<p>For Disaster Recovery scenarios or scenarios where you may not realize something has been deleted until after Microsoft retains the backup, you may want to export the repositories at a single point in time to an Azure storage account.</p>
<p>The Azure DevOps service is highly redundant and built on core Azure Platform infrastructure components, such as Availability Zones and is built using Azure Cloud native Storage and Azure SQL services, which are highly redundant and backed-up.</p>
<p>However, mistakes can happen, and there may be organizational requirements to retain backups of the repositories.</p>
<p>Today, we will examine exporting your repositories to an Azure Storage Account using a DevOps pipeline. This pipeline will capture the repositories at their current state and run nightly.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-overview">📚 Overview<a href="https://luke.geek.nz/azure/export-azure-devops-repos-azure-storage-account/#-overview" class="hash-link" aria-label="Direct link to 📚 Overview" title="Direct link to 📚 Overview">​</a></h2>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>"You can recover deleted organizations or projects within the 28-day window following deletion. But, once this period elapses, these entities are permanently deleted and can't be restored. While these backups serve as a crucial component for disaster recovery, customers need to practice appropriate data management and backup strategies to ensure comprehensive data protection."</p><p>"Accidental deletion here refers to scenarios that arise as a result of an incident on our services. It doesn't include customers' accidental deletion of assets (for example, repositories, work items, attachments, or artifacts).</p><p><strong>We don't support restoring assets that customers accidentally delete. These backups are meant only for business continuity and to aid recovery from outages or disaster scenarios.</strong>"</p><p>Reference: <a href="https://learn.microsoft.com/en-us/azure/devops/organizations/security/data-protection?view=azure-devops&amp;WT.mc_id=AZ-MVP-5004796#mistakes-happen" target="_blank" rel="noopener noreferrer">Data protection - Mistakes Happen</a></p></div></div>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>Please remember that this backup will only export the repositories and pipelines, not the work items, pipeline variables, or other artifacts. This will also backup any code stored in Azure DevOps, so if secrets or other sensitive information are stored in the code, please ensure that these are not stored in the code or are encrypted, or they may be readable by someone with access to the storage account.</p></div></div>
<p>Today, we will run a PowerShell script with an Azure DevOps pipeline. The script will connect to the Azure DevOps API and grab the zip file of each Repository in all Projects into an artifact, which then gets exported and copied to an Azure Storage Account.</p>
<!-- -->
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-deployment">🚀 Deployment<a href="https://luke.geek.nz/azure/export-azure-devops-repos-azure-storage-account/#-deployment" class="hash-link" aria-label="Direct link to 🚀 Deployment" title="Direct link to 🚀 Deployment">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="️-azure-storage-account">☁️ Azure Storage Account<a href="https://luke.geek.nz/azure/export-azure-devops-repos-azure-storage-account/#%EF%B8%8F-azure-storage-account" class="hash-link" aria-label="Direct link to ☁️ Azure Storage Account" title="Direct link to ☁️ Azure Storage Account">​</a></h3>
<p>We will need to create an Azure Storage Account to store the exported repositories. We can point towards an already existing Storage Account and Container.</p>
<p>We will deploy the Storage account fresh using <a href="https://learn.microsoft.com/azure/azure-resource-manager/bicep/overview?tabs=bicep&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Bicep</a> to our existing Resource Group for this article.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>I will use the <a href="https://luke.geek.nz/azure/Azure-Bicep-Deploy-Pane/" target="_blank" rel="noopener noreferrer">Deployment Pane</a> to deploy the Storage Account straight from Visual Studio Code, running in a <a href="https://luke.geek.nz/azure/Getting-Started-with-GitHub-Codespaces/" target="_blank" rel="noopener noreferrer">Codespace</a>.</p></div></div>
<p>We will use <a href="https://learn.microsoft.com/azure/storage/blobs/lifecycle-management-policy-configure?tabs=azure-portal&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Lifecycle Management policies</a> to help control the retention of the exported repositories. We will move the repositories to Cool Storage after 30 days, Archive Storage after 90 days, and delete them after 120 days.</p>
<p><img decoding="async" loading="lazy" alt="Export ADO - Create Storage Account" src="https://luke.geek.nz/assets/images/Export_ADO_CreateStgAccount-169b0507885b17bde9569ed0ccccb95d.gif" width="1864" height="974" class="img_ev3q"></p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// Parameters for the script</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> storageAccountName </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Name of the storage account</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> location </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">resourceGroup</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">location </span><span class="token comment" style="color:rgb(98, 114, 164)">// Location of the storage account, default to the location of the resource group</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> containerName </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'adoexport'</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Name of the container</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Resource definition for the storage account</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> storageAccount </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.Storage/storageAccounts@2023-01-01'</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> storageAccountName </span><span class="token comment" style="color:rgb(98, 114, 164)">// Set the name of the storage account</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">location</span><span class="token operator">:</span><span class="token plain"> location </span><span class="token comment" style="color:rgb(98, 114, 164)">// Set the location of the storage account</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">sku</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Standard_LRS'</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Set the SKU to Standard_LRS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">kind</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'StorageV2'</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Set the kind to StorageV2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">accessTier</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Hot'</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Set the access tier to Hot</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">allowBlobPublicAccess</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Disable public access to blobs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">publicNetworkAccess</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Disabled'</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Disable public network access</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Resource definition for the blob service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> blobService </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.Storage/storageAccounts/blobServices@2023-01-01'</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'default'</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Set the name of the blob service to default</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">parent</span><span class="token operator">:</span><span class="token plain"> storageAccount </span><span class="token comment" style="color:rgb(98, 114, 164)">// Set the parent to the storage account</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">lastAccessTimeTrackingPolicy</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">enable</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Enable last access time tracking</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Resource definition for the storage container</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> storageContainer </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.Storage/storageAccounts/blobServices/containers@2023-01-01'</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> containerName </span><span class="token comment" style="color:rgb(98, 114, 164)">// Set the name of the container</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">parent</span><span class="token operator">:</span><span class="token plain"> blobService </span><span class="token comment" style="color:rgb(98, 114, 164)">// Set the parent to the blob service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">publicAccess</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'None'</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Set public access to None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Define a new resource of type 'Microsoft.Storage/storageAccounts/managementPolicies'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> lifecyclePolicy </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.Storage/storageAccounts/managementPolicies@2023-01-01'</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// The name of the management policy. 'default' is a reserved name for the policy.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'default'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// The parent resource that this policy is associated with, which is the storage account.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">parent</span><span class="token operator">:</span><span class="token plain"> storageAccount</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">policy</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">rules</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token comment" style="color:rgb(98, 114, 164)">// This rule is enabled</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">enabled</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token comment" style="color:rgb(98, 114, 164)">// The name of the rule</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'MoveToCoolStorageAfter30Days'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token comment" style="color:rgb(98, 114, 164)">// The type of rule, in this case, it's a lifecycle rule</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Lifecycle'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">definition</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">actions</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token comment" style="color:rgb(98, 114, 164)">// The actions to take on base blobs (i.e., non-versioned blobs)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token property">baseBlob</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token comment" style="color:rgb(98, 114, 164)">// Move the blob to cool storage after it hasn't been modified for 30 days</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token property">tierToCool</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                  </span><span class="token property">daysAfterModificationGreaterThan</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">30</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token comment" style="color:rgb(98, 114, 164)">// The filters that determine which blobs the rule applies to</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">filters</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token comment" style="color:rgb(98, 114, 164)">// The types of blobs that the rule applies to. In this case, the rule applies to block blobs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token property">blobTypes</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token string" style="color:rgb(255, 121, 198)">'blockBlob'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">enabled</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'MoveToArchiveStorageAfter90Days'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Lifecycle'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">definition</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">actions</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token property">baseBlob</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token comment" style="color:rgb(98, 114, 164)">// Move the blob to archive storage after it hasn't been modified for 90 days</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token property">tierToArchive</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                  </span><span class="token property">daysAfterModificationGreaterThan</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">90</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">filters</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token property">blobTypes</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token string" style="color:rgb(255, 121, 198)">'blockBlob'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">enabled</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'DeleteBlobsAfter120Days'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Lifecycle'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">definition</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">actions</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token property">baseBlob</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token comment" style="color:rgb(98, 114, 164)">// Delete the blob after it hasn't been modified for 120 days</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token property">delete</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                  </span><span class="token property">daysAfterModificationGreaterThan</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">120</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">filters</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token property">blobTypes</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token string" style="color:rgb(255, 121, 198)">'blockBlob'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">output</span><span class="token plain"> storageAccountName </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> storageAccount</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">name </span><span class="token comment" style="color:rgb(98, 114, 164)">// Output the name of the storage account</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">output</span><span class="token plain"> containerName </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> storageContainer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">name </span><span class="token comment" style="color:rgb(98, 114, 164)">// Output the name of the storage account container</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Please note the Storage Account name and Container Name; we will need them for Azure DevOps pipeline variables.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="️-azure-devops-pipeline">🛠️ Azure DevOps Pipeline<a href="https://luke.geek.nz/azure/export-azure-devops-repos-azure-storage-account/#%EF%B8%8F-azure-devops-pipeline" class="hash-link" aria-label="Direct link to 🛠️ Azure DevOps Pipeline" title="Direct link to 🛠️ Azure DevOps Pipeline">​</a></h3>
<p>Now, it's time to set up your project and repository. If you don't know how to do that, you can follow the official Microsoft Learn documentation here: <a href="https://learn.microsoft.com/en-us/azure/devops/repos/git/create-new-repo?view=azure-devops&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Create a new Git repo in your project</a>.</p>
<p>Once your repository has been set up and initialized, we need to add the following files.</p>
<h1>💻 PowerShell Script</h1>
<p>The PowerShell script, <code>Export-AzDevOpsRepos.ps1</code>, is responsible for cloning all repositories in a given Azure DevOps organization and downloading them as ZIP files. It uses the Azure DevOps REST API to fetch all projects and their respective repositories. For each repository, it generates a URL to download the repository as a ZIP file and saves it to a local directory. If the script is run in an Azure Pipelines environment, it also uploads the directory containing the downloaded repositories as a pipeline artifact.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>The PowerShell script can also be run locally. If it detects an Azure DevOps agent, it will automatically collect the variables from the pipeline variables; otherwise, those variables can be added manually to the script to run it locally.</p><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$env</span><span class="token plain">:AGENT_ID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Running in Azure DevOps</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$personalAccessToken</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$env</span><span class="token string" style="color:rgb(255, 121, 198)">:pat"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Assuming PAT is stored as a secret variable in the pipeline</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$organization</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$env</span><span class="token string" style="color:rgb(255, 121, 198)">:AzDevOpsOrg"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Running on a local PC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$personalAccessToken</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">''</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$organization</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">''</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h1>🚀 Azure Pipelines</h1>
<p>The Azure Pipelines configuration file, <code>.azure-pipelines/pipeline.ci.adoexport.yml</code> sets up a CI pipeline that runs the PowerShell script on a schedule. The pipeline is configured to run on the latest Windows agent. It uses the Azure CLI task to run the PowerShell script and to manage access to an Azure storage account. After the script has run, the pipeline downloads any ZIP files produced as artifacts and copies them to the Azure storage account. The pipeline is scheduled to run daily at midnight.</p>
<div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">pipeline.ci.adoexport.yml</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">Export-AzDevOpsRepos.ps1</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Export Azure DevOps repositories"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Name of the pipeline</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">trigger</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> none </span><span class="token comment" style="color:rgb(98, 114, 164)"># Pipeline is not triggered automatically</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">schedules</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Define schedules for pipeline runs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">cron</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"0 12 * * *"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Run daily at midnight</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Daily midnight run </span><span class="token comment" style="color:rgb(98, 114, 164)"># Display name for the schedule</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">branches</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">include</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> main </span><span class="token comment" style="color:rgb(98, 114, 164)"># Only run on the 'main' branch</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">always</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Run even if there are no code changes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">pool</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">vmImage</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"windows-latest"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Use the latest Windows agent</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">checkout</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> self </span><span class="token comment" style="color:rgb(98, 114, 164)"># Checkout the source code from the repository</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">persistCredentials</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Persist credentials for subsequent steps</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Checkout code"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Display name for the step</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> AzureCLI@2 </span><span class="token comment" style="color:rgb(98, 114, 164)"># Use Azure CLI task</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Clone Azure DevOps Repositories"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Display name for the step</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">azureSubscription</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"$(azServiceConnection)"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Azure subscription to use</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">scriptType</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"ps"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Use PowerShell script</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">scriptLocation</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"scriptPath"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Script location is a file path</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">scriptPath</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"$(Build.Repository.LocalPath)/Export-AzDevOpsRepos.ps1"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Path to the PowerShell script</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">PAT</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> $(PAT) </span><span class="token comment" style="color:rgb(98, 114, 164)"># Personal Access Token for authentication</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">AzDevOpsOrg</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> $(AzDevOpsOrg) </span><span class="token comment" style="color:rgb(98, 114, 164)"># Azure DevOps organization</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> AzureCLI@2 </span><span class="token comment" style="color:rgb(98, 114, 164)"># Use Azure CLI task</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Allow Public Access to Azure DevOps Export Storage Account for upload </span><span class="token comment" style="color:rgb(98, 114, 164)"># Display name for the step</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">condition</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> succeeded() </span><span class="token comment" style="color:rgb(98, 114, 164)"># Run only if the previous step succeeded</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">azureSubscription</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"$(azServiceConnection)"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Azure subscription to use</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">scriptType</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> bash </span><span class="token comment" style="color:rgb(98, 114, 164)"># Use Bash script</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">scriptLocation</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> inlineScript </span><span class="token comment" style="color:rgb(98, 114, 164)"># Script location is inline</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token scalar string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        az storage account update --name "${storageAccount}"  --resource-group "${storageAccountRG}" --default-action Allow</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">storageAccount</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> $(storageAccount) </span><span class="token comment" style="color:rgb(98, 114, 164)"># Personal Access Token for authentication</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">storageAccountRG</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> $(storageAccountRG) </span><span class="token comment" style="color:rgb(98, 114, 164)"># Azure DevOps organization</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> AzureCLI@2 </span><span class="token comment" style="color:rgb(98, 114, 164)"># Use Azure CLI task</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Check Storage Network Access"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Display name for the step</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">condition</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> succeeded() </span><span class="token comment" style="color:rgb(98, 114, 164)"># Run only if the previous step succeeded</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">timeoutInMinutes</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">10</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Timeout after 10 minutes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">continueOnError</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Continue even if the step fails</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> check_storage_access </span><span class="token comment" style="color:rgb(98, 114, 164)"># Name of the step</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">azureSubscription</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"$(azServiceConnection)"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Azure subscription to use</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">scriptType</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> bash </span><span class="token comment" style="color:rgb(98, 114, 164)"># Use Bash script</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">scriptLocation</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> inlineScript </span><span class="token comment" style="color:rgb(98, 114, 164)"># Script location is inline</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token scalar string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        set -x</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        echo -e "Setting up authentication..."</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        AZURE_STORAGE_ACCOUNT=${storageAccount}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        AZURE_STORAGE_KEY=$(az storage account keys list --account-name ${storageAccount} --query '[0].value' --output tsv)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        echo -e "Checking storage account access every 60 seconds..."</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        sleep 10</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        for i in {1..60}; do</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">          if az storage container list --output none; then</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            echo "Access granted"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            break</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">          else</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            echo "Access denied, retrying in 60 seconds..."</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            sleep 60</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">          fi</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        done</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> DownloadPipelineArtifact@2 </span><span class="token comment" style="color:rgb(98, 114, 164)"># Download pipeline artifacts</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Download Build Artifacts"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Display name for the step</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">patterns</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"**/*.zip"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Include all ZIP files</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">path</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"$(Build.ArtifactStagingDirectory)"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Download artifacts to the staging directory</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">#Storage account needs the SPN to have a Storage Blob Data Contributor role to allow blob upload.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> AzureFileCopy@6 </span><span class="token comment" style="color:rgb(98, 114, 164)"># Use Azure File Copy task</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Copy artifacts to $(storageAccount)"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Display name for the step</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">azureSubscription</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"$(azServiceConnection)"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Azure subscription to use</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">blobPrefix</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"$(Build.DefinitionName)/$(Build.BuildId)"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Prefix for the blob names</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">containerName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> $(stgAccContainer) </span><span class="token comment" style="color:rgb(98, 114, 164)"># Name of the storage container</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">destination</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"AzureBlob"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Copy to Azure Blob storage</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">sourcePath</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"$(Build.ArtifactStagingDirectory)/*"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Source path for the artifacts</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">storage</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> $(storageAccount) </span><span class="token comment" style="color:rgb(98, 114, 164)"># Storage account to copy the artifacts to</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Log the status of artifact download and storage account operations</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> AzureCLI@2 </span><span class="token comment" style="color:rgb(98, 114, 164)"># Use Azure CLI task</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Remove Public Access from Azure DevOps Export Storage Account </span><span class="token comment" style="color:rgb(98, 114, 164)"># Display name for the step</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">condition</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> succeededOrFailed() </span><span class="token comment" style="color:rgb(98, 114, 164)"># Run whether the previous step succeeded or failed</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">azureSubscription</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"$(azServiceConnection)"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Azure subscription to use</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">scriptType</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> bash </span><span class="token comment" style="color:rgb(98, 114, 164)"># Use Bash script</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">scriptLocation</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> inlineScript </span><span class="token comment" style="color:rgb(98, 114, 164)"># Script location is inline</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token scalar string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        az storage account update --name "${storageAccount}" --resource-group "${storageAccountRG}" --default-action Deny</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">storageAccount</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> $(storageAccount) </span><span class="token comment" style="color:rgb(98, 114, 164)"># Personal Access Token for authentication</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">storageAccountRG</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> $(storageAccountRG) </span><span class="token comment" style="color:rgb(98, 114, 164)"># Azure DevOps organization</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$apiVersion</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">'7.1'</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Update API version to 6.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$env</span><span class="token plain">:AGENT_ID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Running in Azure DevOps</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$personalAccessToken</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$env</span><span class="token string" style="color:rgb(255, 121, 198)">:pat"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Assuming PAT is stored as a secret variable in the pipeline</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$organization</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$env</span><span class="token string" style="color:rgb(255, 121, 198)">:AzDevOpsOrg"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Running on a local PC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$personalAccessToken</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">''</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$organization</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">''</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$base64AuthInfo</span><span class="token plain"> = </span><span class="token namespace">[System.Convert]</span><span class="token plain">::ToBase64String</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token namespace">[System.Text.Encoding]</span><span class="token plain">::ASCII</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">GetBytes</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">":</span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$personalAccessToken</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$headers</span><span class="token plain"> = @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">Authorization = </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"Basic {0}"</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">f </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$base64AuthInfo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Get all projects</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$projects</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Invoke-RestMethod</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Uri </span><span class="token string" style="color:rgb(255, 121, 198)">"https://dev.azure.com/</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$organization</span><span class="token string" style="color:rgb(255, 121, 198)">/_apis/projects?api-version=</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$apiVersion</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Method Get </span><span class="token operator">-</span><span class="token plain">Headers </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$headers</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Verbose</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Output the count and names of the projects</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Number of projects: </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$projects</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">value</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Count</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Project names: </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$projects</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">value </span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token string function" style="color:rgb(80, 250, 123)"> </span><span class="token string function" style="color:rgb(80, 250, 123)">ForEach-Object</span><span class="token string function" style="color:rgb(80, 250, 123)"> </span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string function" style="color:rgb(80, 250, 123)"> </span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">name </span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># For each project, get all repositories and download them as zip</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Ensure the repositories directory exists before starting the loop</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$repositoriesPath</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$env</span><span class="token string" style="color:rgb(255, 121, 198)">:SYSTEM_DEFAULTWORKINGDIRECTORY/repositories"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">-not</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token function" style="color:rgb(80, 250, 123)">Test-Path</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Path </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$repositoriesPath</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Creating repositories directory: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$repositoriesPath</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">New-Item</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ItemType Directory </span><span class="token operator">-</span><span class="token plain">Path </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$repositoriesPath</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Out-Null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$projects</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">value </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">ForEach-Object</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$projectName</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">-not</span><span class="token plain"> </span><span class="token namespace">[string]</span><span class="token plain">::IsNullOrWhiteSpace</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$projectName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$projectName</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$projectName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Replace</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">' '</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'%20'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$result</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Invoke-RestMethod</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Uri </span><span class="token string" style="color:rgb(255, 121, 198)">"https://dev.azure.com/</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$organization</span><span class="token string" style="color:rgb(255, 121, 198)">/</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$projectName</span><span class="token string" style="color:rgb(255, 121, 198)">/_apis/git/repositories?api-version=</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$apiVersion</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Method Get </span><span class="token operator">-</span><span class="token plain">Headers </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$headers</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Verbose</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$result</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">value </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">ForEach-Object</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$repoName</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Attempting to clone the repository: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$repoName</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">-not</span><span class="token plain"> </span><span class="token namespace">[string]</span><span class="token plain">::IsNullOrWhiteSpace</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$repoName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$repoId</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">id</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$zipUrl</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"https://dev.azure.com/</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$organization</span><span class="token string" style="color:rgb(255, 121, 198)">/</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$projectName</span><span class="token string" style="color:rgb(255, 121, 198)">/_apis/git/repositories/</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$repoId</span><span class="token string" style="color:rgb(255, 121, 198)">/items?scopePath=/&amp;recursionLevel=Full&amp;api-version=</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$apiVersion</span><span class="token string" style="color:rgb(255, 121, 198)">&amp;`</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$format</span><span class="token string" style="color:rgb(255, 121, 198)">=zip"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$outputPath</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"repositories/</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$repoName</span><span class="token string" style="color:rgb(255, 121, 198)">.zip"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Output path: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$outputPath</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token comment" style="color:rgb(98, 114, 164)"># Ensure the directory exists before trying to download the file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$directoryPath</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Split-Path</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Path </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$outputPath</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Parent</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">-not</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token function" style="color:rgb(80, 250, 123)">Test-Path</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Path </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$directoryPath</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Creating directory: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$directoryPath</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token function" style="color:rgb(80, 250, 123)">New-Item</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ItemType Directory </span><span class="token operator">-</span><span class="token plain">Path </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$directoryPath</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Out-Null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">try</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Starting download for </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$repoName</span><span class="token string" style="color:rgb(255, 121, 198)"> from </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$zipUrl</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token function" style="color:rgb(80, 250, 123)">Invoke-WebRequest</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Uri </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$zipUrl</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">OutFile </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$outputPath</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Headers </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$headers</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Download completed for </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$repoName</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Failed to download </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$repoName</span><span class="token string" style="color:rgb(255, 121, 198)"> from </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$zipUrl</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Exception</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Message</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Check if the repositories directory exists before trying to upload it</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token function" style="color:rgb(80, 250, 123)">Test-Path</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Path </span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$env</span><span class="token string" style="color:rgb(255, 121, 198)">:SYSTEM_DEFAULTWORKINGDIRECTORY/repositories"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Repositories directory exists, uploading as an artifact."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"##vso[artifact.upload containerfolder=repositories;artifactname=AzureDevOpsExportedRepositories;]</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$env</span><span class="token string" style="color:rgb(255, 121, 198)">:SYSTEM_DEFAULTWORKINGDIRECTORY/repositories"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"The repositories directory does not exist, so you cannot upload it as an artifact."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></div>
<p>You can also find the latest files in the <a href="https://github.com/lukemurraynz/ADO_Export" target="_blank" rel="noopener noreferrer">lukemurraynz/ADO_Export</a> GitHub repository. Feel free to open a Pull Request, Suggest changes, or improve.</p>
<p>I am going to be lazy and just drag the files into the repo and commit them.</p>
<p><img decoding="async" loading="lazy" alt="Export_ADO_CommitFiles" src="https://luke.geek.nz/assets/images/Export_ADO_CommitFiles-b8ad417e67074d3ae587901f68555ea7.gif" width="1903" height="974" class="img_ev3q"></p>
<p>Once committed, it is time to set up our pipeline.</p>
<p>But first, we need to setup our <a href="https://learn.microsoft.com/azure/devops/organizations/accounts/use-personal-access-tokens-to-authenticate?view=azure-devops&amp;tabs=Windows&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">PAT (Personal Access Token)</a> and <a href="https://learn.microsoft.com/azure/devops/pipelines/library/service-endpoints?view=azure-devops&amp;tabs=yaml&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Service Connection</a>. Both I have completed.</p>
<p>For your PAT token, you will need the following permissions:</p>
<ul>
<li>Code (Read)</li>
<li>Project and Team (Read)</li>
</ul>
<p>For your Service Connection, you will need the following permissions:</p>
<p>Reader on the Subscription that Contains your Storage Account <em>(the subscription scoping is required for the Azure CLI commanders to check and access your Storage account; if you are using a Self-Managed DevOps agent, you may be able to avoid this)</em>, and Storage Blob Data Contributor on the Storage Account.</p>
<p>Then, we need to add to our pipeline the following:</p>
<table><thead><tr><th>Variable</th><th>Example</th><th>Notes</th></tr></thead><tbody><tr><td>azDevOpsOrg</td><td>Contoso</td><td>Your Azure DevOps Org - matching your URL ie (<a href="https://dev.azure.com/contoso" target="_blank" rel="noopener noreferrer">https://dev.azure.com/contoso</a>)</td></tr><tr><td>azServiceConnection</td><td>AzureServiceConnection</td><td>Your Service Connection name for Azure Resource Provider access to your Azure Resource Group</td></tr><tr><td>pat</td><td>2xj2jv4yf2h6xvqjgk7y2n4d2iucxltlzyxuhcdjxibnrf</td><td>Your PAT (Personal Access Token), used to authenticate to Azure DevOps. Set this as a secure string.</td></tr><tr><td>stgAccContainer</td><td>adoexport</td><td>The Container that will contain your ADO Exports inside of the Storage Account</td></tr><tr><td>storageAccount</td><td>adoexport23</td><td>Storage account that your ADO exports will be going into.</td></tr><tr><td>storageAccountRG</td><td>adoexport-rg</td><td>Resource Group, containing your Azure Storage Account</td></tr></tbody></table>
<p>So, let's import our pipeline and configure our variables!</p>
<ol>
<li>To import the Pipeline, navigate to your Azure DevOps Project, click on Pipelines, and then click on the "New Pipeline" button.</li>
<li>Click Azure Repos Git and select your repository.</li>
<li>Select Existing Azure Pipelines YAML file</li>
<li>Select your Pipeline and click Continue</li>
<li>Now, we can add our Variables by clicking Variables and then Add. If you have already imported the Pipeline, you can navigate to the Pipeline, click Edit, and then Variables.</li>
</ol>
<p><img decoding="async" loading="lazy" alt="Import Azure DevOps Pipeline &amp;amp; Configure Variables" src="https://luke.geek.nz/assets/images/Export_ADO_ImportPipelineVariables-7e89a1a95ca45e77a5c6ad1febab6765.gif" width="1903" height="974" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>By default, the pipeline has a cronjob configured to set it for midnight, but you can change this to any time you like by editing the pipeline file and changing the <a href="https://learn.microsoft.com/azure/devops/pipelines/process/scheduled-triggers?view=azure-devops&amp;tabs=yaml&amp;WT.mc_id=AZ-MVP-5004796#cron-syntax" target="_blank" rel="noopener noreferrer">cron syntax</a>.</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token key atrule">schedules</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Define schedules for pipeline runs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">cron</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"0 12 * * *"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Run daily at midnight</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Daily midnight run </span><span class="token comment" style="color:rgb(98, 114, 164)"># Display name for the schedule</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">branches</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">include</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> main </span><span class="token comment" style="color:rgb(98, 114, 164)"># Only run on the 'main' branch</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">always</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Run even if there are no code changes</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="️-run">🏃‍♂️ Run<a href="https://luke.geek.nz/azure/export-azure-devops-repos-azure-storage-account/#%EF%B8%8F-run" class="hash-link" aria-label="Direct link to 🏃‍♂️ Run" title="Direct link to 🏃‍♂️ Run">​</a></h2>
<p>Now that you have configured your Storage Account and Pipeline, it's time to run the pipeline manually to ensure there are no problems before your scheduled time runs.</p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>Before you run:</p><p>Double-check the permissions you have granted the Service Principal and your variable naming and values; else you may get an error similar to the following when attempting to copy the artifacts to the Storage Account:</p><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">ERROR: (InvalidApiVersionParameter) The api-version '2023-01-01' is invalid. The supported versions are '2024-03-01,2023-07-01,2023-07-01-preview,2023-03-01-preview,2022-12-01,2022-11-01-preview,2022-09-01,2022-06-01,2022-05-01,2022-03-01-preview,2022-01-01,2021-04-01,2021-01-01,2020-10-01,2020-09-01,2020-08-01,2020-07-01,2020-06-01,2020-05-01,2020-01-01,2019-11-01,2019-10-01,2019-09-01,2019-08-01,2019-07-01,2019-06-01,2019-05-10,2019-05-01,2019-03-01,2018-11-01,2018-09-01,2018-08-01,2018-07-01,2018-06-01,2018-05-01,2018-02-01,2018-01-01,2017-12-01,2017-08-01,2017-06-01,2017-05-10,2017-05-01,2017-03-01,2016-09-01,2016-07-01,2016-06-01,2016-02-01,2015-11-01,2015-01-01,2014-04-01-preview,2014-04-01,2014-01-01,2013-03-01,2014-02-26,2014-04'.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Code: InvalidApiVersionParameter</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>It means, that your variables are not parsing correctly, to the Azure CLI, make sure they are correct.</p></div></div>
<p><em>You may need to permit your Pipeline to use your Service Connection by clicking on the "Allow" button when the pipeline runs.</em></p>
<p>Your pipeline may take a while to run, depending on how many repositories you have and how large they are. You can monitor the progress of the pipeline by clicking on the pipeline, then clicking on the Job, and then the Task to see the output of the PowerShell script. This is why I would recommend running this on a schedule during a time that does not impact users, as it can hold up an agent while it runs; also be aware that depending on your repositories, running this every night can quickly use up any <a href="https://azure.microsoft.com/pricing/details/devops/azure-devops-services/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">build minutes you may have, if running from a Microsoft hosted agent</a>.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>If a Repository is only used for Azure Boards and not for code, it will not be exported, as the API will not return it <em>, i.e., you will use a (404) Not Found</em>.</p></div></div>
<p><img decoding="async" loading="lazy" alt="Azure DevOps - Artifact_Export" src="https://luke.geek.nz/assets/images/Artifact_Export-3ce83535131fbf52988deb4b2d59f7f3.png" width="1294" height="826" class="img_ev3q"></p>
<p>Once that's completed - you will be able to see your exported repositories in your storage account!</p>
<p><img decoding="async" loading="lazy" alt="Azure DevOps - Storage Account" src="https://luke.geek.nz/assets/images/Export_ADO_CheckAzureDevOpsExportStfAcc-1067ea82c3f3b98a9ae13131bfb85035.gif" width="1903" height="974" class="img_ev3q"></p>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Deploying Large Language Models on AKS with Kaito]]></title>
            <link>https://luke.geek.nz/azure/run-local-llm-aks/</link>
            <guid>https://luke.geek.nz/azure/run-local-llm-aks/</guid>
            <pubDate>Wed, 08 May 2024 21:49:34 GMT</pubDate>
            <description><![CDATA[Deploy large language models on AKS using Kaito, an operator that simplifies the deployment of AI/ML inference models in a Kubernetes cluster.]]></description>
            <content:encoded><![CDATA[<p>Today, we are going to look at deploying a large language model <em>(LLM)</em> directly into your AKS <em>(Azure Kubernetes Service)</em> cluster, running on GPU-enabled nodes, using <a href="https://github.com/Azure/kaito" target="_blank" rel="noopener noreferrer">Kaito <em>(Kubernetes AI Toolchain Operator)</em></a>.</p>
<blockquote>
<p>KAITO is an open-source operator that transforms how you deploy AI models on Kubernetes. It streamlines the process, automating critical tasks like infrastructure provisioning and resource optimization. It intelligently selects the optimal hardware configuration for your specific model, using available CPU and GPU resources on AKS. KAITO eliminates the manual setup complexities, accelerating your deployment time and reducing associated costs.</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-overview">👀 Overview<a href="https://luke.geek.nz/azure/run-local-llm-aks/#-overview" class="hash-link" aria-label="Direct link to 👀 Overview" title="Direct link to 👀 Overview">​</a></h2>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p><a href="https://github.com/Azure/kaito" target="_blank" rel="noopener noreferrer">Kaito</a> is an operator that automates the deployment of the AI/ML inference model in a Kubernetes cluster. The target models are popular open-sourced inference models such as Falcon and llama2. Kaito has the following critical differentiations compared to most of the mainstream model deployment methodologies built on top of virtual machine infrastructures:</p><ul>
<li>Manage large model files using container images. An HTTP server is provided to perform inference calls using the model library.</li>
<li>Avoid tuning deployment parameters to fit GPU hardware by providing preset configurations.</li>
<li>Auto-provision GPU nodes based on model requirements.</li>
<li>Host large model images in the public Microsoft Container Registry (MCR) if the license allows.</li>
</ul><p>Kaito follows the classic Kubernetes Custom Resource Definition(CRD)/controller design pattern. The user manages a workspace custom resource that describes the GPU requirements and the inference specification. Kaito controllers automate the deployment by reconciling the workspace custom resource.</p><p><img decoding="async" loading="lazy" alt="Kaito - Architecture" src="https://luke.geek.nz/assets/images/kaito-arch-2e8dc7b883bd663ee34c62f7781cd570.png" width="2666" height="1123" class="img_ev3q"></p><ul>
<li>Workspace controller: It reconciles the workspace custom resource, creates machine custom resources to trigger node auto-provisioning, and creates the inference workload (deployment or stateful set) based on the model preset configurations.</li>
<li>Node provisioner controller: The controller's name is gpu-provisioner in <a href="https://github.com/Azure/kaito/tree/main/charts/kaito/gpu-provisioner" target="_blank" rel="noopener noreferrer">Kaito helm chart</a>. It uses the machine CRD originated from Karpenter to interact with the workspace controller. It integrates with Azure Kubernetes Service(AKS) APIs to add new GPU nodes to the AKS cluster. Note that the gpu-provisioner is an open-sourced component. It can be replaced by other controllers if they support Karpenter-core APIs.</li>
</ul><blockquote>
<p>At the time of this article, <a href="https://azure.microsoft.com/updates/public-preview-kubernetes-ai-toolchain-operator-kaito-addon-for-aks/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Kaito is in preview</a> and <strong>is not recommended for production use</strong>.</p>
</blockquote><p>There are some significant benefits of running open-source LLMs with Kaito. Some advantages include:</p><ul>
<li>Automated GPU node provisioning and configuration: Kaito will automatically provision and configure GPU nodes for you. This can help reduce the operational burden of managing GPU nodes, configuring them for Kubernetes, and tuning model deployment parameters to fit GPU profiles.</li>
<li>Reduced cost: Kaito can help you save money by splitting inferencing across lower-end GPU nodes, which may also be more readily available and cost less than high-end GPU nodes.</li>
<li>Support for popular open-source LLMs: Kaito offers preset configurations for popular open-source LLMs. This can help you deploy and manage open-source LLMs on AKS and integrate them with your intelligent applications.</li>
<li>Fine-grained control: You can fully control data security and privacy, model development and configuration transparency, and fine-tune the model to fit your specific use case.</li>
<li>Network and data security: You can ensure these models are ring-fenced within your organization's network, and the data never leaves the Kubernetes cluster.</li>
</ul></div></div>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>A word of warning: when looking at running your model in your own AKS cluster, be aware of the <a href="https://learn.microsoft.com/en-us/azure/security/fundamentals/shared-responsibility-ai?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">AI Shared responsibility model</a>. There is a difference in the Azure AI PaaS <em>(Platform as a Service)</em> offerings, i.e., Model safety, compute, versioning, etc. and running your model in your own AKS cluster. So, although the Kaito operator helps you run some SLM models in your AKS cluster, you are responsible for the security, compliance, and governance of the entire system versus consuming a Microsoft-provided model as a service offering.</p></div></div>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>If you want to follow the guide and set up Kaito, make sure you have approved <a href="https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/azure-subscription-service-limits?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">quota</a> in your region for the GPU compute nodes. In this example, I am using a 12 vCPU Standard NCSv3 instance.</p><p>You can use the following Azure CLI command to check your use and limit:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">az vm list-usage </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--location</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">${AZURE_LOCATION}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--query</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"[? contains(localName, 'Standard NCSv3')]"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-o</span><span class="token plain"> table</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You can follow this Microsoft guide for requesting a quota increase: <a href="https://learn.microsoft.com/azure/quotas/regional-quota-requests?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Request a quota increase</a>.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-example-app---pets">🐶 Example App - Pets<a href="https://luke.geek.nz/azure/run-local-llm-aks/#-example-app---pets" class="hash-link" aria-label="Direct link to 🐶 Example App - Pets" title="Direct link to 🐶 Example App - Pets">​</a></h3>
<p>Today, we will use the <a href="https://github.com/Azure-Samples/aks-store-demo" target="_blank" rel="noopener noreferrer">aks store demo—Pets</a> sample microservices app, commonly used for AKS demos, tutorials, and experiments. We will deploy it to our AKS cluster, update it to use a locally hosted mistral model to generate the local product descriptions, and then call the externally hosted Azure OpenAI endpoint.</p>
<blockquote>
<p>This sample demo app consists of containerized microservices that can be easily deployed into an Azure Kubernetes Service (AKS) cluster. It is meant to show a realistic scenario using a polyglot architecture, event-driven design, and common open-source back-end services <em>(e.g., RabbitMQ, MongoDB)</em>. The application also leverages OpenAI's GPT-3 models to generate product descriptions. This can be done using either Azure OpenAI or OpenAI.</p>
</blockquote>
<p><img decoding="async" loading="lazy" alt="Demo Pets - Architecture with Azure OpenAI" src="https://luke.geek.nz/assets/images/demo-arch-with-openai-5682b589c10eb05f66a5f942e20b0526.png" width="3128" height="2384" class="img_ev3q"></p>
<p>The application has the following services:</p>
<table><thead><tr><th>Service</th><th>Description</th></tr></thead><tbody><tr><td><code>makeline-service</code></td><td>This service handles processing orders from the queue and completing them (Golang)</td></tr><tr><td><code>order-service</code></td><td>This service is used for placing orders (Javascript)</td></tr><tr><td><code>product-service</code></td><td>This service is used to perform CRUD operations on products (Rust)</td></tr><tr><td><code>store-front</code></td><td>Web app for customers to place orders (Vue.js)</td></tr><tr><td><code>store-admin</code></td><td>Web app used by store employees to view orders in queue and manage products (Vue.js)</td></tr><tr><td><code>virtual-customer</code></td><td>Simulates order creation on a scheduled basis (Rust)</td></tr><tr><td><code>virtual-worker</code></td><td>Simulates order completion on a scheduled basis (Rust)</td></tr><tr><td><code>ai-service</code></td><td>Optional service for adding generative text and graphics creation (Python)</td></tr><tr><td><code>mongodb</code></td><td>MongoDB instance for persisted data</td></tr><tr><td><code>rabbitmq</code></td><td>RabbitMQ for an order queue</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-overview-1">🚀 Overview<a href="https://luke.geek.nz/azure/run-local-llm-aks/#-overview-1" class="hash-link" aria-label="Direct link to 🚀 Overview" title="Direct link to 🚀 Overview">​</a></h3>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-prerequisites">📦 Prerequisites<a href="https://luke.geek.nz/azure/run-local-llm-aks/#-prerequisites" class="hash-link" aria-label="Direct link to 📦 Prerequisites" title="Direct link to 📦 Prerequisites">​</a></h3>
<ul>
<li><a href="https://github.com/" target="_blank" rel="noopener noreferrer">GitHub account</a> <em>(we will use a GitHub Codespace to deploy the App, and requirements)</em></li>
<li><a href="https://azure.microsoft.com/en-us/free/open-source?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure subscription</a> <em>(we will need an Azure subscription, to install the cluster the model to)</em></li>
<li><a href="https://learn.microsoft.com/azure/quotas/regional-quota-requests?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Request a quota increase</a> for a GPU compute workload <em>(ie Standard NCSv3)</em> in your region. I am based in New Zealand so that I will be deploying to Australia East.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-deploy-aks-cluster">🐝 Deploy AKS cluster<a href="https://luke.geek.nz/azure/run-local-llm-aks/#-deploy-aks-cluster" class="hash-link" aria-label="Direct link to 🐝 Deploy AKS cluster" title="Direct link to 🐝 Deploy AKS cluster">​</a></h3>
<ol>
<li>Let us deploy our Cluster and application using a pre-created Azure Developer CLI infrastructure as code deployment by connecting to the Codespace <em>(which already has the dependencies of Azure Developer CLI, Kubectl, Helm, Azure Bicep, and Terraform Azure CLI pre-installed)</em> at <a href="https://github.com/Azure-Samples/aks-store-demo" target="_blank" rel="noopener noreferrer">aks store demo—Pets</a>.
<img decoding="async" loading="lazy" alt="Open Codespace" src="https://luke.geek.nz/assets/images/Kaito-AKS_Codespace_Open-64c209ec93b7faae9d8375eecb3509e3.gif" width="1835" height="970" class="img_ev3q"></li>
<li>Now, we need to prep for the Azure Developer CLI deployment, which will use Terarform (a random pet name module for a unique name) to deploy our AKS cluster in our specified region. So, let's log in to Azure.</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># login to Azure CLI</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">az login --use-device-code</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># login to Azure Developer CLI</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">azd auth login</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Codespace Azure Login" src="https://luke.geek.nz/assets/images/Kaito-AKS_Codespace_AzLogin-b46496e3e30486ac1168c73ee5f70f46.gif" width="1856" height="970" class="img_ev3q"></p>
<ol start="3">
<li>Once logged in, we can configure a new Azure Developer CLI environment in preparation for our deployment.</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">azd </span><span class="token function" style="color:rgb(80, 250, 123)">env</span><span class="token plain"> new</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="4">
<li>Enter an environment name <em>(i.e., Kaito)</em>; the Azure Developer CLI uses this to store the environment settings for the deployment and won't reflect any of your deployed resources.</li>
<li>Now, we need to set a few environment variables for our deployment, which will be used by the Terraform deployment to deploy the Azure Open AI instance that Pets will use <em>(and we will replace it with Falcon later on; however, I recommend including it in the deployment to confirm that the OpenAI components are confirmed working first)</em>.</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">azd </span><span class="token function" style="color:rgb(80, 250, 123)">env</span><span class="token plain"> </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">set</span><span class="token plain"> DEPLOY_AZURE_OPENAI </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">azd </span><span class="token function" style="color:rgb(80, 250, 123)">env</span><span class="token plain"> </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">set</span><span class="token plain"> DEPLOY_AZURE_WORKLOAD_IDENTITY </span><span class="token boolean">true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>To confirm variables, you can run the following:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">azd </span><span class="token function" style="color:rgb(80, 250, 123)">env</span><span class="token plain"> get-values</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Check Azure Developer CLI variables" src="https://luke.geek.nz/assets/images/Kaito-AKS_Codespace_CheckAzdEnvVariables-9f4a2eb2daff2b3020329ed6e4fa06b6.gif" width="1856" height="970" class="img_ev3q"></p>
<ol start="6">
<li>Finally, it's time to deploy. Run the following command and select the Subscription you want to deploy the AKS cluster into and the region <em>(remember this region is the region for which you have requested the GPU quota increase)</em>.</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">azd up</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Azure Developer CLI -Up" src="https://luke.geek.nz/assets/images/Kaito-AKS_Codespace_AZDUp-1d3dd6a586b65003f0daf98c5a09c338.gif" width="1856" height="970" class="img_ev3q"></p>
<ol start="7">
<li>Once the deployment is complete, you will see the output (AKS and helm deployments for the PET microservices), including the AKS cluster name, the Azure OpenAI endpoint, and the OIDC issuer URL.</li>
</ol>
<p>After you have provided the information, the azd up command will start by registering Azure providers and features and installing Azure CLI extensions. From there, it will invoke the terraform apply command and execute "azd-hook" scripts, which is a neat way for you to "hook" into the deployment process and add any customizations. We will invoke a helm install command in our deployment to apply our Kubernetes manifests.</p>
<p>This will take a few minutes to complete. Once it's done, you will see the terraform apply command output and the created resources. You can also view the resources in the Azure portal.</p>
<p><img decoding="async" loading="lazy" alt="AKS Pet store Azure resource deployments" src="https://luke.geek.nz/assets/images/Kaito-AKS-rg-funnyrhino17-25db477192ccdfdc467492a98b8ec56f.png" width="2736" height="549" class="img_ev3q"></p>
<ol start="7">
<li>Once the deployment is complete, run the following command to load all the AZD environment variables into your shell to be used by the Kaito deployment.</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token builtin class-name" style="color:rgb(189, 147, 249)">eval</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">azd </span><span class="token string variable function" style="color:rgb(80, 250, 123);font-style:italic">env</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic"> get-values</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-test-the-pet-store-app">🧪 Test the Pet-store app<a href="https://luke.geek.nz/azure/run-local-llm-aks/#-test-the-pet-store-app" class="hash-link" aria-label="Direct link to 🧪 Test the Pet-store app" title="Direct link to 🧪 Test the Pet-store app">​</a></h3>
<p>Now, lets test that its working, by taking a look at the pet store admin public endpoint.</p>
<ol>
<li>Open your favorite browser and navigate to the <a href="https://portal.azure.com/#home" target="_blank" rel="noopener noreferrer">Azure Portal</a></li>
<li>Search for Kubernetes services</li>
<li>Find your AKS cluster and click on the resource</li>
<li>Click on Services and Ingresses</li>
<li>Find the store-admin service and click on the public endpoint to open the store-admin page.</li>
<li>You can test the current <em>(external to the AKS cluster)</em> Azure OpenAI endpoint by clicking on Products, Add Product, typing in a Keyword, clicking on the "Ask AI Assistant" button, and seeing the generated text.</li>
</ol>
<p><img decoding="async" loading="lazy" alt="AKS - Test Pet store admin OpenAI endpoint" src="https://luke.geek.nz/assets/images/Kaito-AKS_PetStoreAdminAzOpenAITest-5b4d00b101aaecbff857daf1ef47feb9.gif" width="1856" height="989" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-implement-kaito-and-falcon-llm">🐦 Implement Kaito and Falcon LLM<a href="https://luke.geek.nz/azure/run-local-llm-aks/#-implement-kaito-and-falcon-llm" class="hash-link" aria-label="Direct link to 🐦 Implement Kaito and Falcon LLM" title="Direct link to 🐦 Implement Kaito and Falcon LLM">​</a></h3>
<p>Now that the AKS cluster is deployed and the Pets store app is running, we can implement Kaito and run the Falcon 7b-instruct large language model.</p>
<blockquote>
<p>You can continue to set this up in the Codespace; I am going to switch to an <a href="https://learn.microsoft.com/azure/cloud-shell/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure CloudShell</a> to complete the rest of the implementation, mainly to come at the implementation, from the point of view of installing Kaito in an existing cluster, not related to the Pet store example <em>(i.e., make sure that there are no variables, etc. that we might be reliant on, without knowing why)</em>.</p>
</blockquote>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Researchers from Technology Innovation Institute, Abu Dhabi, introduced the <a href="https://arxiv.org/pdf/2311.16867.pdf" target="_blank" rel="noopener noreferrer">Falcon series</a>, which includes models with 7 billion, 40 billion, and 180 billion parameters. These models, intended to be causal decoder-only models, were trained on a high-quality, varied corpus mostly obtained from online data. Falcon-180B, the largest model in the series, is the only publicly available pretraining run ever, having been trained on a dataset of more than 3.5 trillion text tokens.</p><p>The researchers discovered that Falcon-180B shows great advancements over other models, including PaLM or Chinchilla. It outperforms models being developed concurrently, such as LLaMA 2 or Inflection-1. Falcon-180B achieves performance close to PaLM-2-Large, which is noteworthy given its lower pretraining and inference costs. With this ranking, Falcon-180B joins GPT-4 and PaLM-2-Large as the leading language models in the world. For more information, see the following resources:</p><ul>
<li><a href="https://arxiv.org/pdf/2311.16867.pdf" target="_blank" rel="noopener noreferrer">The Falcon Series of Open Language Models</a></li>
<li><a href="https://huggingface.co/tiiuae/falcon-40b-instruct" target="_blank" rel="noopener noreferrer">Falcon-40B-Instruct</a></li>
<li><a href="https://huggingface.co/tiiuae/falcon-180B" target="_blank" rel="noopener noreferrer">Falcon-180B</a></li>
<li><a href="https://huggingface.co/tiiuae/falcon-7b" target="_blank" rel="noopener noreferrer">Falcon-7B</a></li>
<li><a href="https://github.com/Azure-Samples/aks-kaito-terraform/blob/main/alcon-7B-Instruct" target="_blank" rel="noopener noreferrer">Falcon-7B-Instruct</a></li>
</ul><p>Reference: <a href="https://techcommunity.microsoft.com/t5/azure-for-isv-and-startups/deploy-kaito-on-aks-using-terraform/ba-p/4108930?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Deploy Kaito on AKS using Terraform</a></p></div></div>
<ol>
<li>To do this, we need to make sure that we have the preview version of the AKS CLI extension installed. You can check this by running the following command:</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">az extension list </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--query</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"[?name=='aks-preview']"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If you don't have it, you can install it:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">az extension </span><span class="token function" style="color:rgb(80, 250, 123)">add</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--name</span><span class="token plain"> aks-preview --allow-preview </span><span class="token boolean">true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>And if needed, update it:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">az extension update </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--name</span><span class="token plain"> aks-preview --allow-preview </span><span class="token boolean">true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="2">
<li>Re-login to Azure, if needed <em>(you don't need to login to the Azure Developer CLI; it was only required for previous steps)</em>. Next, we need to register the AIToolchainProvider resource provider by running the following command:</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">az feature register </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--namespace</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Microsoft.ContainerService"</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--name</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"AIToolchainOperatorPreview"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This will allow the Kaito (AI Toolchain Operator) APIs on your Azure subscription to be deployed into your AKS cluster. It could take a few minutes to register.</p>
<p><img decoding="async" loading="lazy" alt="Register AI Tool Chain Operator" src="https://luke.geek.nz/assets/images/Kaito-AKS_RegisterAIToolChainOperator-99bad2d117c9bb9ea81349d2a47e1259.gif" width="1109" height="372" class="img_ev3q"></p>
<ol start="3">
<li>Once the registration is complete, we can prepare to deploy the workload identity, workspace, and GPU-enabled node pool for Kaito; as part of this, we need to define the environment variables (if you are still using the Codespace, these should be carried over from the previous deployment; if not, we can set them)*. Adding the variables helps us avoid having to enter the values each time we run a command.</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token builtin class-name" style="color:rgb(189, 147, 249)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">AZURE_SUBSCRIPTION_ID</span><span class="token operator">=</span><span class="token string" style="color:rgb(255, 121, 198)">"9b06e177-a5bb-468b-9fd6-fc58e5b67239"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">AZURE_RESOURCE_GROUP</span><span class="token operator">=</span><span class="token string" style="color:rgb(255, 121, 198)">"rg-funnyrhino17"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">AZURE_LOCATION</span><span class="token operator">=</span><span class="token string" style="color:rgb(255, 121, 198)">"australiaeast"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">CLUSTER_NAME</span><span class="token operator">=</span><span class="token string" style="color:rgb(255, 121, 198)">"aks-funnyrhino17"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Set Kaito environment variables" src="https://luke.geek.nz/assets/images/Kaito-AKS_Variables-d4784967f1d65f9fcec1ca1de26373fa.gif" width="1109" height="372" class="img_ev3q"></p>
<ol start="4">
<li>We are now going to update our AKS cluster to enable the Kaito operator and OpenID Connect issuer <em>(required to enable connectivity to a Managed identity to create the Node pools)</em> by running the following command:</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">az aks update </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--name</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">${CLUSTER_NAME}</span><span class="token plain"> --resource-group </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">${AZURE_RESOURCE_GROUP}</span><span class="token plain"> --enable-oidc-issuer --enable-ai-toolchain-operator</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Update AI Toolchain Operator" src="https://luke.geek.nz/assets/images/Kaito-AKS_EnableAIToolChainOperatorExistingCluster-9e60cfca925df9a624cc9b8331b6b1db.gif" width="1109" height="372" class="img_ev3q"></p>
<ol start="5">
<li>Once updated, we can then connect directly to the cluster using the Kubernetes command line tool, Kubectl, by running the following command:</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">az aks get-credentials --resource-group </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">${AZURE_RESOURCE_GROUP}</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--name</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">${CLUSTER_NAME}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Connect to AKS cluster with Kubectl" src="https://luke.geek.nz/assets/images/Kaito-AKS_ConnectAKSClusterKubectl-95fb6925a5173eeba1388abe1c93d9d1.gif" width="1109" height="381" class="img_ev3q"></p>
<ol start="6">
<li>Then verify the connection:</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">kubectl get nodes</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Kubectl get nodes" src="https://luke.geek.nz/assets/images/Kaito-AKSKubectlgetnodes-de6170c0d6a6ed4c0db0751aaec04808.gif" width="1109" height="381" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p><code>kubectl</code> is a command line tool for interacting with Kubernetes clusters. It's part of the Kubernetes project and is used to deploy and manage applications on Kubernetes. It can also be used to inspect and debug cluster and application resources.</p><p>Kubectl is the Kubernetes command-line tool that allows you to run commands against Kubernetes clusters. You can use Kubectl to deploy applications, inspect and manage cluster resources, and view logs. It's a crucial component for interacting with Kubernetes and is used in various operations, from creating, updating, and deleting Kubernetes resources to debugging running applications.</p></div></div>
<ol start="8">
<li>Lets assign the managed identity, Contributor rights over the Resource Group, that contains the Cluster by running the following command:</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token builtin class-name" style="color:rgb(189, 147, 249)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">AKS_OIDC_ISSUER</span><span class="token operator">=</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">az aks show </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--name</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">"</span><span class="token variable string variable" style="color:rgb(189, 147, 249);font-style:italic">${CLUSTER_NAME}</span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">"</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> --resource-group </span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">"</span><span class="token variable string variable" style="color:rgb(189, 147, 249);font-style:italic">${AZURE_RESOURCE_GROUP}</span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">"</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--query</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">"oidcIssuerProfile.issuerUrl"</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-o</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> tsv</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">MC_RESOURCE_GROUP</span><span class="token operator">=</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">az aks show --resource-group $</span><span class="token variable punctuation" style="color:rgb(248, 248, 242);font-style:italic">{</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">AZURE_RESOURCE_GROUP</span><span class="token variable punctuation" style="color:rgb(248, 248, 242);font-style:italic">}</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--name</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> $</span><span class="token variable punctuation" style="color:rgb(248, 248, 242);font-style:italic">{</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">CLUSTER_NAME</span><span class="token variable punctuation" style="color:rgb(248, 248, 242);font-style:italic">}</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--query</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> nodeResourceGroup </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-o</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> tsv</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">KAITO_IDENTITY_PRINCIPAL_ID</span><span class="token operator">=</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">az identity show </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--name</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> ai-toolchain-operator-$</span><span class="token variable punctuation" style="color:rgb(248, 248, 242);font-style:italic">{</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">CLUSTER_NAME</span><span class="token variable punctuation" style="color:rgb(248, 248, 242);font-style:italic">}</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> --resource-group $</span><span class="token variable punctuation" style="color:rgb(248, 248, 242);font-style:italic">{</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">MC_RESOURCE_GROUP</span><span class="token variable punctuation" style="color:rgb(248, 248, 242);font-style:italic">}</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--query</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> principalId </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--output</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> tsv</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">KAITO_IDENTITY_CLIENT_ID</span><span class="token operator">=</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">az identity show  </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--name</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> ai-toolchain-operator-$</span><span class="token variable punctuation" style="color:rgb(248, 248, 242);font-style:italic">{</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">CLUSTER_NAME</span><span class="token variable punctuation" style="color:rgb(248, 248, 242);font-style:italic">}</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> --resource-group $</span><span class="token variable punctuation" style="color:rgb(248, 248, 242);font-style:italic">{</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">MC_RESOURCE_GROUP</span><span class="token variable punctuation" style="color:rgb(248, 248, 242);font-style:italic">}</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--query</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> clientId </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--output</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> tsv</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">az role assignment create </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--assignee</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$KAITO_IDENTITY_PRINCIPAL_ID</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--scope</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"/subscriptions/</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">${AZURE_SUBSCRIPTION_ID}</span><span class="token string" style="color:rgb(255, 121, 198)">/resourcegroups/</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">${AZURE_RESOURCE_GROUP}</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--role</span><span class="token plain"> Contributor</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">az identity federated-credential create </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--name</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Kaito-federated-identity"</span><span class="token plain"> --identity-name ai-toolchain-operator-</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">${CLUSTER_NAME}</span><span class="token plain"> --resource-group </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">${MC_RESOURCE_GROUP}</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--issuer</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">${AKS_OIDC_ISSUER}</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--subject</span><span class="token plain"> system:serviceaccount:kube-system:kaito-gpu-provisioner </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--audience</span><span class="token plain"> api://AzureADTokenExchange</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Assign Kaito Managed Identity federated credentials" src="https://luke.geek.nz/assets/images/Kaito-AKSAssignKaitoMI-3a562a1f7502ebb82363ef0ddcdfdb37.gif" width="1109" height="381" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>If you get 'Failed to connect to MSI. Please make sure MSI is configured correctly.' Make sure you relogin to Azure <em>(ie az login --use-device-code)</em>, you may need to assign Contributor rights manually as well. Reference: <a href="https://github.com/Azure/azure-cli/issues/17695" target="_blank" rel="noopener noreferrer">Error from CloudShell - Failed to connect to MSI. Please make sure MSI is configured correctly. #17695</a></p></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>You can check what entries are in the environment variables by running using echo to output the variable:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token builtin class-name" style="color:rgb(189, 147, 249)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$KAITO_IDENTITY_CLIENT_ID</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If the gpu-provisioner is not running, you can check the logs by running the following command:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">kubectl get pods --all-namespaces </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-l</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">app</span><span class="token operator">=</span><span class="token plain">ai-toolchain-operator</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Find the name of the gpu-provisioner pod, and then run the following command to get the logs:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">kubectl logs </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-n</span><span class="token plain"> kube-system </span><span class="token operator">&lt;</span><span class="token plain">gpu-provisioner-pod-name</span><span class="token operator">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>I had issues where the gpu-provisioner pod was not running and constantly restarted. The logs showed that the identity was not found, so I had to re-run the command to assign the correct managed identity and use the echo command to reveal the managed identity, highlighting the wrong one was selected.</p></div></div>
<p><img decoding="async" loading="lazy" alt="kaito-gpu-provisioner | Azure Portal overview" src="https://luke.geek.nz/assets/images/kaito-gpu-provisoner-deployment-azportal-cfdf9a59bb4b05ea42d1fa4f9c2b4c2b.png" width="1471" height="784" class="img_ev3q"></p>
<ol start="9">
<li>Let's now deploy the Falcon 7b instruct model to our AKS cluster.</li>
</ol>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>As soon as the models are grabbed from the remote registry, the GPU nodes will spin up, and you will start paying for their use, so just be aware.</p></div></div>
<p>We are going to use one of the <strong>supported models to create our interference endpoint in AKS, the Falcon 7b instruct model, as per their examples in the <a href="https://github.com/Azure/kaito/tree/main/examples/inference" target="_blank" rel="noopener noreferrer">Kaito GitHub repository</a></strong>.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">kubectl apply </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-f</span><span class="token plain"> https://raw.githubusercontent.com/Azure/kaito/main/examples/inference/kaito_workspace_falcon_7b-instruct.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>You can monitor the progress of the workspaces and model deployment by running the following command:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">kubectl get workspace workspace-falcon-7b-instruct </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-w</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote>
<p>The deployment can take a few minutes <em>(ie 20-50 minutes, the Resources because ready, before the workspace is ready)</em>, so be patient. It needs to pull the Falcon model from the Microsoft public container registry <em>(ie, Pulling image "mcr.microsoft.com/aks/kaito/kaito-falcon-7b-instruct:0.0.4")</em>.  It took me 45 minutes when I tested with the Mistral 7b model</p>
</blockquote><p>Wait for the Workspace to be ready before continuing.</p><p><img decoding="async" loading="lazy" alt="Deploy workspace-falcon-7b-instruct" src="https://luke.geek.nz/assets/images/Kaito-DeployFalcon7bInstruct-17fb3c57bf9f6cfb157a44c4c0798c05.gif" width="1105" height="415" class="img_ev3q"></p></div></div>
<p>Once the workspaces and pods/nodes have been provisioned, let us test the deployment by running the following command:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">kubectl get svc workspace-falcon-7b-instruct </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-o</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">jsonpath</span><span class="token operator">=</span><span class="token string" style="color:rgb(255, 121, 198)">'{.spec.clusterIP}'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">SERVICE_IP</span><span class="token operator">=</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">kubectl get svc workspace-falcon-7b-instruct </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-o</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">jsonpath</span><span class="token variable operator" style="color:rgb(189, 147, 249);font-style:italic">=</span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">'{.spec.clusterIP}'</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kubectl run </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-it</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--rm</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--restart</span><span class="token operator">=</span><span class="token plain">Never </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--image</span><span class="token operator">=</span><span class="token plain">curlimages/curl -- </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-X</span><span class="token plain"> POST http://</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$SERVICE_IP</span><span class="token plain">/chat </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-H</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"accept: application/json"</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-H</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Content-Type: application/json"</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-d</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"{</span><span class="token string entity" style="color:rgb(255, 121, 198)">\"</span><span class="token string" style="color:rgb(255, 121, 198)">prompt</span><span class="token string entity" style="color:rgb(255, 121, 198)">\"</span><span class="token string" style="color:rgb(255, 121, 198)">:</span><span class="token string entity" style="color:rgb(255, 121, 198)">\"</span><span class="token string" style="color:rgb(255, 121, 198)">What is your favorite ice cream flavor?</span><span class="token string entity" style="color:rgb(255, 121, 198)">\"</span><span class="token string" style="color:rgb(255, 121, 198)">}"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Test Falcon 7b instruct model" src="https://luke.geek.nz/assets/images/Kaito-TestFalcon7bInstruct-8b84bb46ea062f23695e4ed1a485d8a8.gif" width="1105" height="415" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-update-the-pet-store-app">🚀 Update the Pet-store app<a href="https://luke.geek.nz/azure/run-local-llm-aks/#-update-the-pet-store-app" class="hash-link" aria-label="Direct link to 🚀 Update the Pet-store app" title="Direct link to 🚀 Update the Pet-store app">​</a></h3>
<p>Almost there! Now that we know that our local chat endpoint is working with the Falcon 7b instruct model, we can update the Pet Store app to use the local Falcon 7b model and remove the Azure OpenAI to generate the product descriptions.</p>
<p>We will continue in our Terminal to do that, but like the previous steps, it can be done in the Codespace. The Pet Store application already has some great examples of doing this, so we will create a new manifest and repoint the application to use the local Falcon workspace instead of the public Azure Open AI endpoint that was created initially:</p>
<ol>
<li>First, we need to create a new config map to deploy the Pet Store app with the Falcon 7b instruct model by running the following command:</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">kubectl apply </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-n</span><span class="token plain"> pets </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-f</span><span class="token plain"> - </span><span class="token operator">&lt;&lt;</span><span class="token string" style="color:rgb(255, 121, 198)">EOF</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">apiVersion: v1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">kind: ConfigMap</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">metadata:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  name: ai-service-configmap</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">data:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  USE_LOCAL_LLM: "True"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  AI_ENDPOINT: "http://workspace-falcon-7b-instruct/chat"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">---</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">apiVersion: apps/v1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">kind: Deployment</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">metadata:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  name: ai-service</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">spec:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  replicas: 1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  selector:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    matchLabels:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">      app: ai-service</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  template:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    metadata:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">      labels:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        app: ai-service</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    spec:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">      nodeSelector:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        "kubernetes.io/os": linux</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">      containers:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">      - name: order-service</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        image: ghcr.io/azure-samples/aks-store-demo/ai-service:latest</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        ports:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        - containerPort: 5001</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        envFrom:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        - configMapRef:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            name: ai-service-configmap</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        resources:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          requests:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            cpu: 20m</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            memory: 50Mi</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          limits:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            cpu: 30m</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            memory: 85Mi</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        startupProbe:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          httpGet:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            path: /health</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            port: 5001</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          initialDelaySeconds: 60</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          failureThreshold: 3</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          timeoutSeconds: 3</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          periodSeconds: 5</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        readinessProbe:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          httpGet:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            path: /health</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            port: 5001</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          initialDelaySeconds: 3</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          failureThreshold: 3</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          timeoutSeconds: 3</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          periodSeconds: 5</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        livenessProbe:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          httpGet:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            path: /health</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            port: 5001</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          failureThreshold: 3</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          initialDelaySeconds: 3</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          timeoutSeconds: 3</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          periodSeconds: 3</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">---</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">apiVersion: v1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">kind: Service</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">metadata:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  name: ai-service</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">spec:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  type: ClusterIP</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  ports:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  - name: http</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    port: 5001</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    targetPort: 5001</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  selector:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    app: ai-service</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now, let's test it! We will remove the Azure OpenAI instance first and then test it!</p>
<p><img decoding="async" loading="lazy" alt="Test Pet Store Local LLM" src="https://luke.geek.nz/assets/images/Kaito-TestFalcon7bInstruct-PetStore-78688fa2c54260059b35c4f63db7723a.gif" width="1864" height="737" class="img_ev3q"></p>
<p>We can confirm within our AI Service ConfigMap now that the local endpoint is being used:</p>
<p><img decoding="async" loading="lazy" alt="Falcon 7b Kaito Local LLM" src="https://luke.geek.nz/assets/images/Falconb_Kaito_LocalLLM_ConfigMap-8aa381e07c3293d592fe1966440d7bf1.png" width="1147" height="932" class="img_ev3q"></p>]]></content:encoded>
            <category>Azure</category>
        </item>
    </channel>
</rss>