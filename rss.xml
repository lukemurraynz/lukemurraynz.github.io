<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>luke.geek.nz Blog</title>
        <link>https://luke.geek.nz/</link>
        <description>luke.geek.nz Blog</description>
        <lastBuildDate>Fri, 14 Jun 2024 09:12:51 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <language>en</language>
        <copyright>Copyright ¬© 2024 luke.geek.nz.</copyright>
        <item>
            <title><![CDATA[Infrastructure as Code GitHub Codespace Template]]></title>
            <link>https://luke.geek.nz/azure/iac-github-codespace/</link>
            <guid>https://luke.geek.nz/azure/iac-github-codespace/</guid>
            <pubDate>Fri, 14 Jun 2024 09:12:51 GMT</pubDate>
            <description><![CDATA[Codespace setup for Infrastructure as Code (IaC) coding, including Bicep and Terraform, and Linting.]]></description>
            <content:encoded><![CDATA[<p>I've written, about <a href="https://github.com/features/codespaces" target="_blank" rel="noopener noreferrer">GitHub Codespaces</a> before, in the article <a href="https://luke.geek.nz/azure/Getting-Started-with-GitHub-Codespaces/" target="_blank" rel="noopener noreferrer">Coding on the Cloud - Getting Started with GitHub Codespaces</a>, this article builds on it by supplying a Codespace setup for Infrastructure as Code <em>(IaC)</em> coding, including Bicep and Terraform, and Linting.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>The <strong><a href="https://github.com/lukemurraynz/Codespace_IaC_Coding/" target="_blank" rel="noopener noreferrer">lukemurraynz/Codespace_IaC_Coding</a></strong> Codespace includes essential tools for Infrastructure as Code development for Azure, tools like Azure CLI, PowerShell, Azure Bicep, Azure Developer CLI (azd), Terraform, TFLint, and Terragrunt. <strong>Feel free to fork, clone, or contribute to the repository. This template is aimed at getting you up and coding as soon as possible!</strong></p></div></div>
<ul>
<li><strong><a href="https://learn.microsoft.com/cli/azure/what-is-azure-cli?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure CLI</a></strong>: The Azure Command-Line Interface (CLI) is a cross-platform command-line tool to connect to Azure and execute administrative commands on Azure resources.</li>
<li><strong><a href="https://learn.microsoft.com/powershell/scripting/overview?view=powershell-7.4&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">PowerShell</a></strong>: PowerShell is a cross-platform task automation solution made up of a command-line shell, a scripting language, and a configuration management framework.</li>
<li><strong><a href="https://learn.microsoft.com/azure/azure-resource-manager/bicep/overview?tabs=bicep&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Bicep</a></strong>: Bicep is a domain-specific language (DSL) that uses declarative syntax to deploy Azure resources. In a Bicep file, you define the infrastructure you want to deploy to Azure, and then use that file throughout the development lifecycle to repeatedly deploy your infrastructure.</li>
<li><strong><a href="https://learn.microsoft.com/azure/developer/azure-developer-cli/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Developer CLI (azd)</a></strong>: Azure Developer CLI (azd) is an open-source tool that accelerates the time it takes for you to get your application from local development environment to Azure. azd provides best practice, developer-friendly commands that map to key stages in your workflow, whether you're working in the terminal, your editor or integrated development environment (IDE), or CI/CD (continuous integration/continuous deployment).</li>
<li><strong><a href="https://www.terraform.io/" target="_blank" rel="noopener noreferrer">Terraform</a></strong>: Infrastructure automation to provision and manage resources in any cloud or data center.</li>
<li><strong><a href="https://github.com/terraform-linters/tflint" target="_blank" rel="noopener noreferrer">TFLint</a></strong>: A Terraform linter for detecting errors that cannot be detected by terraform plan.</li>
<li><strong><a href="https://terragrunt.gruntwork.io/" target="_blank" rel="noopener noreferrer">Terragrunt</a></strong>: A thin wrapper for Terraform that provides extra tools for working with multiple Terraform modules.</li>
</ul>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Because this repository includes tools for both Bicep and Terraform IaC, it can take a few minutes to set up the Codespace. The setup process installs the necessary tools and extensions for Bicep and Terraform development. If you need to use only one of the tools, you can remove the unnecessary tools from the <code>.devcontainer/devcontainer.json</code> file.</p></div></div>
<p>The repository also includes uses <a href="https://megalinter.io/latest/" target="_blank" rel="noopener noreferrer">MegaLinter</a> to ensure code quality and adherence to best practices. MegaLinter analyzes the codebase for potential issues, coding standards violations, formatting discrepancies, and more across multiple languages and file formats. It helps maintain a high standard of code quality and consistency across the project.</p>
<p>Megalinter can be configured to automatically lint and open up a pull request with the changes, or it can be run manually. The repository is configured to run the MegaLinter on every push to the main branch, by setting a <a href="https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens#creating-a-fine-grained-personal-access-token" target="_blank" rel="noopener noreferrer">PAT (Personal Access Token)</a> in the repository secrets. The PAT is used to create a pull request with the linting results. Review the <a href="https://megalinter.io/7.8.0/configuration/" target="_blank" rel="noopener noreferrer">Megalinter</a> documentation for more information on how to configure it.</p>
<p><img decoding="async" loading="lazy" alt="GitHub IaC Codespace" src="https://luke.geek.nz/assets/images/GitHub_IaC_Codespace_PAT-3ef01ca2c601fcbe2cccae9b0b28a8e7.png" width="1243" height="890" class="img_ev3q"></p>
<p>VSCode is the default editor in the Codespace, and you can use the integrated terminal to run commands. The repository includes a <code>.devcontainer/devcontainer.json</code> file that defines the development container configuration. The configuration includes the tools and extensions required for Bicep and Terraform development, but also the base VSCode settings and extensions.</p>
<p>The Codespace configuration includes the following VSCode settings:</p>
<p><strong>editor.formatOnSaveMode</strong>: Configures format on save to be applied to the entire file.
<strong><a href="https://luke.geek.nz/azure/Azure-Bicep-Deploy-Pane/" target="_blank" rel="noopener noreferrer">bicep.experimental.deployPane</a></strong>: Enables the experimental deploy pane for Bicep.</p>
<p>VS Code Extensions to be Installed:</p>
<ul>
<li><strong><a href="https://marketplace.visualstudio.com/items?itemName=ms-azuretools.vscode-azurecontainerapps" target="_blank" rel="noopener noreferrer">ms-azuretools.vscode-azurecontainerapps</a></strong>: Azure Container Apps extension.</li>
<li><strong><a href="https://marketplace.visualstudio.com/items?itemName=ms-azuretools.vscode-azureresourcegroups" target="_blank" rel="noopener noreferrer">ms-azuretools.vscode-azureresourcegroups</a></strong>: Azure Resource Groups extension.</li>
<li><strong><a href="https://marketplace.visualstudio.com/items?itemName=ms-azuretools.vscode-bicep" target="_blank" rel="noopener noreferrer">ms-azuretools.vscode-bicep</a></strong>: Bicep extension.</li>
<li><strong><a href="https://marketplace.visualstudio.com/items?itemName=GitHub.copilot" target="_blank" rel="noopener noreferrer">GitHub.copilot</a></strong>: GitHub Copilot extension.</li>
<li><strong><a href="https://marketplace.visualstudio.com/items?itemName=GitHub.copilot-chat" target="_blank" rel="noopener noreferrer">GitHub.copilot-chat</a></strong>: GitHub Copilot Chat extension.</li>
<li><strong><a href="https://marketplace.visualstudio.com/items?itemName=ms-vscode.azure-account" target="_blank" rel="noopener noreferrer">ms-vscode.azure-account</a></strong>: Azure Account extension.</li>
<li><strong><a href="https://marketplace.visualstudio.com/items?itemName=HashiCorp.terraform" target="_blank" rel="noopener noreferrer">hashicorp.terraform</a></strong>: Terraform extension.</li>
<li><strong><a href="https://marketplace.visualstudio.com/items?itemName=golang.Go" target="_blank" rel="noopener noreferrer">golang.Go</a></strong>: Go language support extension.</li>
</ul>
<p><img decoding="async" loading="lazy" alt="GitHub IaC Codespace" src="https://luke.geek.nz/assets/images/GitHub_IaC_Codespace-afae2005beebc2ee6ff58c89511196eb.gif" width="1903" height="983" class="img_ev3q"></p>]]></content:encoded>
            <category>Azure</category>
            <category>Misc</category>
        </item>
        <item>
            <title><![CDATA[Cloud Design Patterns]]></title>
            <link>https://luke.geek.nz/azure/cloud-design-patterns/</link>
            <guid>https://luke.geek.nz/azure/cloud-design-patterns/</guid>
            <pubDate>Sun, 26 May 2024 09:05:39 GMT</pubDate>
            <description><![CDATA[Cloud design patterns help build reliable, scalable, secure applications in the cloud.]]></description>
            <content:encoded><![CDATA[<p>Cloud Design patterns help build reliable, scalable, secure applications in the cloud.</p>
<p>Today, we will cover common patterns, their use cases, and considerations.</p>
<p>The patterns we will cover today are only a small set of common patterns documented in the <a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Architecture Center</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-cloud-design-patterns">üå©Ô∏è Cloud Design Patterns<a href="https://luke.geek.nz/azure/cloud-design-patterns/#%EF%B8%8F-cloud-design-patterns" class="hash-link" aria-label="Direct link to üå©Ô∏è Cloud Design Patterns" title="Direct link to üå©Ô∏è Cloud Design Patterns">‚Äã</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="importance-of-design-patterns">Importance of Design Patterns<a href="https://luke.geek.nz/azure/cloud-design-patterns/#importance-of-design-patterns" class="hash-link" aria-label="Direct link to Importance of Design Patterns" title="Direct link to Importance of Design Patterns">‚Äã</a></h3>
<p>Design patterns are reusable solutions to common problems in software design. They are templates that can be applied to solve a problem in a specific context. They are not finished designs that can be transformed directly into code. They are a starting point for your design.</p>
<p><img decoding="async" loading="lazy" alt="Design Patterns" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPattnerns_Importance-e7c82f7f59275c9e6c178db732b041b3.gif" width="1903" height="1005" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Design patterns are not new. They have been around for a long time. The concept of design patterns was introduced by the architect <a href="https://en.wikipedia.org/wiki/Christopher_Alexander#:~:text=Alexander%25%20and%20personally%20built,architect%20and%20a%20general%20contractor.&amp;text=In%20software%2C%20Alexander%20is%20regarded,to%20its%20creator%2C%20Ward%20Cunningham" target="_blank" rel="noopener noreferrer">Christopher Alexander</a> in the field of architecture and later adopted by software engineers.</p></div></div>
<p>Design patterns are essential to consider when implementing your solutions as they help with the following:</p>
<p>Reusability - Design patterns promote reusability by providing proven solutions to common problems, allowing components and subsystems to be used in other applications and scenarios and interoperability</p>
<ul>
<li>Maintainability - They simplify administration and development, making maintaining and updating applications easier.</li>
<li>Consistency - Design patterns ensure consistency and coherence in component design and deployment, which is crucial for the overall quality of the application</li>
<li>Efficiency - By following established patterns, developers can avoid repetitive work and focus on implementing specific requirements, thus saving development time</li>
<li>Scalability - Design patterns help in designing scalable systems by providing guidelines for efficient resource allocation and management</li>
<li>Performance - They help optimize the use of system resources, leading to improved performance of the application&nbsp;</li>
<li>Modularity - Design patterns promote modular and structured code, making it easier to understand, modify, and maintain.</li>
</ul>
<p>This is as true in Modern Cloud solutions as it is in traditional development, with <a href="https://learn.microsoft.com/azure/well-architected/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">well-architected principles</a> more important than ever.</p>
<p>Take a Cloud Platform or ecosystem like Azure, with Services offering a theory of functionality that can be put together like Lego bricks.</p>
<ul>
<li>Scalability‚ÄîCloud design patterns address scalability by providing solutions for horizontal and vertical scaling, ensuring that applications can handle increased loads efficiently. This promotes sustainability by enabling dynamic resource allocation and reducing energy consumption during low-demand periods.</li>
<li>Resilience‚ÄîPatterns like Circuit Breakers and Bulkhead help build resilient applications that can withstand failures and continue to function. Sustainable operations are achieved by minimizing downtime and resource wastage, thus ensuring efficient resource use.</li>
<li>Security‚ÄîSecurity patterns such as API Gateway and Secure Token ensure that applications are protected against malicious actors while maintaining confidentiality, integrity, and availability. Secure systems support sustainability by preventing security breaches that could lead to resource wastage.</li>
<li>Operational Excellence - Patterns like Ambassador and Anti-Corruption Layer enhance operational excellence by simplifying the management and monitoring of cloud applications. Efficient management practices contribute to sustainability by optimizing resource usage and reducing unnecessary overhead.</li>
<li>Performance Efficiency - Patterns such as Cache-Aside and Compute Resource Consolidation optimize performance by efficiently managing resources and reducing latency. Effective resource management leads to sustainability by lowering the overall resource footprint and energy consumption.</li>
<li>Data Management‚ÄîData management patterns address data consistency, synchronization, and management challenges across different locations, which is crucial for cloud applications. Sustainable data practices ensure data is stored and processed efficiently, minimizing energy use and reducing environmental impact.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="acroymns">Acroymns<a href="https://luke.geek.nz/azure/cloud-design-patterns/#acroymns" class="hash-link" aria-label="Direct link to Acroymns" title="Direct link to Acroymns">‚Äã</a></h4>
<p>When talking about design patterns, we will be using a few acronyms, and it is important to understand what they mean in order to fully understand the context.</p>
<table><thead><tr><th>Acronym</th><th>Definition</th><th>Example</th></tr></thead><tbody><tr><td>Service</td><td>A service in cloud pattern design refers to a distinct function or set of functions a cloud application provides. Services are typically designed to be reusable and can be consumed by multiple clients or consumers.</td><td>In a microservices architecture, each microservice is a service that performs a specific business function, such as user authentication, payment processing, or data storage.</td></tr><tr><td>Consumer</td><td>A &nbsp;consumer is an entity (such as an application, service, or user) that consumes or uses the services provided by another service. Consumers send requests to services and receive responses.</td><td>A web application that calls an authentication service to verify user credentials is a consumer of that authentication service.</td></tr><tr><td>Tenant</td><td>In a multi-tenant architecture, a tenant is a group of users who share common access with specific privileges to the software instance. Each tenant's data is isolated and remains invisible to other tenants.</td><td>In a Software as a Service (SaaS) application, each customer (company or organization) is considered a tenant. They have their own isolated data and configuration settings within the shared application.</td></tr><tr><td>Facade</td><td>The Facade pattern provides a simplified interface to a complex subsystem, making it easier to use and understand. It acts as a high-level interface that hides the complexities of the underlying system.</td><td>In a software application, a facade can be used to provide a simplified API that abstracts away the complexities of interacting with multiple subsystems or modules.</td></tr><tr><td>Asynchronous</td><td>Asynchronous communication is a messaging pattern where the sender and receiver do not need to interact in real time. The sender can send a message and continue with other tasks, while the receiver processes the message at its own pace.</td><td>In a distributed system, asynchronous messaging can be used to decouple components and improve scalability. For example, a message queue can be used to send and receive messages between different services.</td></tr><tr><td>Synchronous</td><td>Synchronous communication is a messaging pattern where the sender and receiver interact in real time. The sender sends a message and waits for a response from the receiver before proceeding.</td><td>In a request-response scenario, a client sends a request to a server and waits for the server to process the request and send back a response. This pattern is commonly used in HTTP-based APIs.</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="archetypes-categories-of-patterns">Archetypes <em>(Categories)</em> of Patterns<a href="https://luke.geek.nz/azure/cloud-design-patterns/#archetypes-categories-of-patterns" class="hash-link" aria-label="Direct link to archetypes-categories-of-patterns" title="Direct link to archetypes-categories-of-patterns">‚Äã</a></h3>
<p>Cloud design patterns can be categorized into different Archetypes <em>(categories)</em> based on their characteristics and use cases. These archetypes provide a structured way to understand and apply patterns in cloud architecture design.</p>
<p>The categories include Data Management, Security, Reliability, Messaging, and Design and implementation. Let's examine each category in detail.</p>
<ul>
<li>Data Management patterns help us manage data in the cloud. Caching helps us reduce the number of database hits and improve application performance. Sharding helps us partition our data across multiple databases to improve scalability. Federation helps us distribute data across multiple databases for better availability and fault tolerance.</li>
<li>Security patterns help us secure our applications in the cloud. Perimeter Networks help us isolate our applications from the Internet. Identity Management helps us manage user identities and access to resources. Secure Communication helps us protect our data in transit.</li>
<li>Reliability patterns help us build highly available and fault-tolerant applications in the cloud. Retry helps us recover from transient failures. Circuit Breakers help us prevent cascading failure. Bulkhead helps us limit the damage caused by a failure.</li>
<li>Messaging patterns help us build scalable and decoupled applications in the cloud. Asynchronous Messaging helps us send messages between components in a non-blocking way. Event Sourcing helps us capture all changes to an application state. Competing Consumers help us process messages in parallel.</li>
<li>Design and implementation patterns help us build scalable and resilient cloud-native applications. Valet Key helps us delegate access to resources. Ambassador helps us expose services to external clients. Gateway helps us provide a single entry point to our application.</li>
</ul>
<p><img decoding="async" loading="lazy" alt="Cloud Design Patterns Archetypes" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatterns_Archetypes-9f8fe96f95134b7f90b57117774cc511.PNG" width="4000" height="2250" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>As usual, the choice of pattern depends on your application's specific requirements. To make an informed decision, it's essential to understand the characteristics and trade-offs of each pattern and business requirements. Sometimes, multiple patterns may be required, or even part of one, to solve a specific problem.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="pattern-deep-dives">Pattern Deep Dives<a href="https://luke.geek.nz/azure/cloud-design-patterns/#pattern-deep-dives" class="hash-link" aria-label="Direct link to Pattern Deep Dives" title="Direct link to Pattern Deep Dives">‚Äã</a></h3>
<p>The cloud has changed the way we design our applications. Let's examine some design patterns we can use in the cloud. These patterns help us solve common problems in cloud architecture and make our applications more reliable, scalable, and secure.</p>
<p>In the following sections, we will examine common cloud design patterns, their use cases, and considerations in depth.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="data-management-patterns">Data Management Patterns<a href="https://luke.geek.nz/azure/cloud-design-patterns/#data-management-patterns" class="hash-link" aria-label="Direct link to Data Management Patterns" title="Direct link to Data Management Patterns">‚Äã</a></h3>
<p><img decoding="async" loading="lazy" alt="Design Patterns - Data Management" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatterns_DataManagement-938a6255d99ff5338872172f50fb6d19.PNG" width="4000" height="2250" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-cache-aside">üìö Cache-Aside<a href="https://luke.geek.nz/azure/cloud-design-patterns/#-cache-aside" class="hash-link" aria-label="Direct link to üìö Cache-Aside" title="Direct link to üìö Cache-Aside">‚Äã</a></h3>
<blockquote>
<p>Load data on demand into a cache from a data store</p>
</blockquote>
<p>Many commercial caching systems provide read-through and write-through/write-behind operations. In these systems, an application retrieves data by referencing the cache.</p>
<p>If the data isn't in the cache, it's retrieved from the data store and added to the cache. Any modifications to data held in the cache are also automatically written back to the data store.</p>
<p>For caches that don't provide this functionality, it's the responsibility of the applications that use the cache to maintain the data.</p>
<p>If an application updates information, it can follow the write-through strategy by modifying the data store and invalidating the corresponding item in the cache. When the item is next required, using the cache-aside strategy will cause the updated data to be retrieved from the data store and added back into the cache.</p>
<p><img decoding="async" loading="lazy" alt="Cloud Design Pattern - CacheAsSide" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatterns_CacheAside-c416d22a006cae6f244c9bdc927de735.gif" width="1903" height="1005" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="issues--considerations">Issues &amp; considerations<a href="https://luke.geek.nz/azure/cloud-design-patterns/#issues--considerations" class="hash-link" aria-label="Direct link to Issues &amp; considerations" title="Direct link to Issues &amp; considerations">‚Äã</a></h4>
<p>Consider the following points when deciding how to implement this pattern:</p>
<ul>
<li>Lifetime of cached data. Many caches implement an expiration policy that invalidates data and removes it from the cache if it's not accessed for a specified period. For cache-aside to be effective, ensure that the expiration policy matches the pattern of access for applications that use the data. Don't make the expiration period too short because this can cause applications to continually retrieve data from the data store and add it to the cache. Similarly, don't make the expiration period so long that the cached data will likely become stale. Remember that caching is most effective for relatively static data or data that is read frequently.</li>
<li>Evicting data. Most caches have a limited size compared to the data store where the data originates, and they'll evict data if necessary. Most caches adopt a least-recently-used policy for selecting items to evict, but this might be customizable. Configure the global expiration property and other properties of the cache, as well as the expiration property of each cached item, to ensure that the cache is cost-effective. Applying a global eviction policy to every item in the cache isn't always appropriate. For example, if a cached item is costly to retrieve from the data store, it can be beneficial to keep this item in the cache at the expense of more frequently accessed but less costly items.</li>
<li>Priming the cache. Many solutions prepopulate the cache with the data that an application is likely to need during startup processing. The Cache-Aside pattern can still be useful if some of this data expires or is evicted.</li>
<li>Consistency. Implementing the Cache-Aside pattern doesn't guarantee consistency between the data store and the cache. An external process can change an item in the data store at any time, and this change might not be reflected in the cache until the next time the item is loaded. In a system replicating data across data stores, this problem can become serious if synchronization occurs frequently.</li>
<li>Local <em>(in-memory)</em> caching. A cache could be local to an application instance and stored in memory. Cache-aside can be useful in this environment if an application repeatedly accesses the same data. However, a local cache is private, so different application instances could each have a copy of the same cached data. This data could quickly become inconsistent between caches, so it might be necessary to expire data in a private cache and refresh it more frequently. In these scenarios, investigate a shared or distributed caching mechanism.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="when-to-use-this-pattern">When to use this pattern<a href="https://luke.geek.nz/azure/cloud-design-patterns/#when-to-use-this-pattern" class="hash-link" aria-label="Direct link to When to use this pattern" title="Direct link to When to use this pattern">‚Äã</a></h4>
<ul>
<li>When an in-built cache doesn't provide native read-through or write-back operations.</li>
<li>When resource demand is unpredictable, you want to avoid overloading the data store.</li>
<li>When the cached dataset is not static</li>
<li>When NOT caching session state information in a web application hosted in a web farm.</li>
</ul>
<!-- -->
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="azure-solutions">Azure Solutions<a href="https://luke.geek.nz/azure/cloud-design-patterns/#azure-solutions" class="hash-link" aria-label="Direct link to Azure Solutions" title="Direct link to Azure Solutions">‚Äã</a></h4>
<p>In this example, it uses <a href="https://learn.microsoft.com/azure/azure-cache-for-redis/cache-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Cache for Redis</a>. When an application needs to retrieve data, it will first check to see if it exists in Azure Cache for Redis.
If the data is found in Azure Cache for Redis (cache hit), the application will use this data.
If the data is not found in Azure Cache for Redis (cache miss), the application must retrieve it from the appropriate Azure database service.
For cache miss scenarios, the requesting application should add the data retrieved from the Azure Database service to Azure Cache for Redis.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-sharding">üìö Sharding<a href="https://luke.geek.nz/azure/cloud-design-patterns/#-sharding" class="hash-link" aria-label="Direct link to üìö Sharding" title="Direct link to üìö Sharding">‚Äã</a></h3>
<blockquote>
<p>Divide a data store into a set of horizontal partitions or shards.</p>
</blockquote>
<p>Dividing a data store into a set of horizontal partitions or shards. This can improve scalability when storing and accessing large volumes of data.</p>
<ul>
<li>The Lookup strategy. In this strategy, the sharding logic implements a map that routes a request for data to the shard containing that data using the shard key. In a multi-tenant application, all the data for a tenant might be stored together in a shard using the tenant ID as the shard key. Multiple tenants might share the same shard, but the data for a single tenant won't be spread across multiple shards.</li>
<li>The Range strategy. This strategy groups related items together in the same shard and orders them by shard key‚Äîthe shard keys are sequential. It's useful for applications that frequently retrieve sets of items using range queries (queries that return a set of data items for a shard key that falls within a given range). For example, if an application regularly needs to find all orders placed in a given month, this data can be retrieved more quickly if all orders for a month are stored in date and time order in the same shard. If each order were stored in a different shard, they'd have to be fetched individually by performing many point queries (queries that return a single data item).&nbsp;</li>
<li>The Hash strategy. The purpose of this strategy is to reduce the chance of hotspots (shards that receive a disproportionate amount of load). It distributes the data across the shards in a way that achieves a balance between the size of each shard and the average load that each shard will encounter. The sharding logic computes the shard to store an item in based on a hash of one or more data attributes. The chosen hashing function should distribute data evenly across the shards, possibly by introducing some random element into the computation.</li>
</ul>
<p><img decoding="async" loading="lazy" alt="Cloud Design Pattern - Sharding" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatterns_Sharding-ea99e03e181d1c690f570c96e200f6e8.gif" width="1903" height="1005" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="issues--considerations-1">Issues &amp; considerations<a href="https://luke.geek.nz/azure/cloud-design-patterns/#issues--considerations-1" class="hash-link" aria-label="Direct link to Issues &amp; considerations" title="Direct link to Issues &amp; considerations">‚Äã</a></h4>
<p>Consider the following points when deciding how to implement this pattern:</p>
<ul>
<li>Balancing data across multiple shards.</li>
<li>Your queries need to be efficient and not require data from multiple shards or cause latency issues.</li>
<li>Designing for scalability (storage nodes ‚Äì data &amp; throughput)</li>
<li>Designing for availability (replication, failover, recovery)</li>
<li>Make sure to use stable and unique key data to determine the sharding state</li>
<li>Monitoring, backup, and maintaining consistency of multiple shards can be difficult.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="when-to-use-this-pattern-1">When to use this pattern<a href="https://luke.geek.nz/azure/cloud-design-patterns/#when-to-use-this-pattern-1" class="hash-link" aria-label="Direct link to When to use this pattern" title="Direct link to When to use this pattern">‚Äã</a></h4>
<p>The primary focus of sharding is to improve the performance and scalability of a system. Still, as a by-product it can also improve availability due to how the data is divided into separate partitions. A failure in one partition doesn't necessarily prevent an application from accessing data held in other partitions, and an operator can perform maintenance or recovery of one or more partitions without making the entire data for an application inaccessible.&nbsp;</p>
<ul>
<li>When the data store is likely to need to scale beyond the resources of a single storage node.</li>
<li>When you can improve performance  by reducing contention on a single data store.</li>
<li>When you need to optimize cost by multiple instances of less expensive compute or storage.</li>
<li>Improve resilience and reliability.</li>
<li>When you have geographical concerns, i.e., Optimization based on where users or systems are located.</li>
</ul>
<!-- -->
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="azure-solutions-1">Azure Solutions<a href="https://luke.geek.nz/azure/cloud-design-patterns/#azure-solutions-1" class="hash-link" aria-label="Direct link to Azure Solutions" title="Direct link to Azure Solutions">‚Äã</a></h4>
<p>Consider a website that surfaces an expansive collection of information on published books worldwide.
The number of possible books cataloged in this workload and the typical query/usage patterns contra-indicate the usage of a single relational database to store the book information. The workload architect decides to shard the data across multiple database instances, using the books' static International Standard Book Number (ISBN) for the shard key. Specifically, they use the&nbsp;check digit&nbsp;(0 - 10) of the ISBN as that gives 11 possible logical shards, and the data will be balanced across each shard. First, they decide to colocate the 11 logical shards into three physical shard databases. They use the&nbsp;lookup&nbsp;sharding approach and store the key-to-server mapping information in a shard map database.</p>
<p>Azure resources that can be used to implement this pattern include <a href="https://learn.microsoft.com/azure/azure-sql/database/sql-database-paas-overview?view=azuresql&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure SQL Database</a>, <a href="https://learn.microsoft.com/azure/cosmos-db/introduction?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Cosmos DB</a>, and <a href="https://learn.microsoft.com/azure/storage/common/storage-introduction?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Storage</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-valet-key">üöó Valet Key<a href="https://luke.geek.nz/azure/cloud-design-patterns/#-valet-key" class="hash-link" aria-label="Direct link to üöó Valet Key" title="Direct link to üöó Valet Key">‚Äã</a></h3>
<blockquote>
<p>Use a token or key that provides clients with restricted direct access to a specific resource or service.</p>
</blockquote>
<p>Data stores have the ability to handle the upload and download of data directly without requiring the application to perform any processing to move this data. However, this typically requires the client to have access to the store's security credentials. This can be a useful technique to minimize data transfer costs and the requirement to scale out the application and to maximize performance. It means, though, that the application is no longer able to manage the security of the data. After the client has a connection to the data store for direct access, the application can't act as the gatekeeper. It's no longer in control of the process and can't prevent subsequent uploads or downloads from the data store.
This isn't a realistic approach in distributed systems that need to serve untrusted clients.</p>
<p>Applications must be able to securely control access to data in a granular way, but still reduce the load on the server by setting up this connection and then allowing the client to communicate directly with the data store to perform the required read or write operations.</p>
<p><img decoding="async" loading="lazy" alt="Cloud Design Pattern - Valet Key" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatterns_ValetKey-d96a9ad0ddbef19ec0b9f2914e36edde.gif" width="1903" height="1005" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="issues--considerations-2">Issues &amp; considerations<a href="https://luke.geek.nz/azure/cloud-design-patterns/#issues--considerations-2" class="hash-link" aria-label="Direct link to Issues &amp; considerations" title="Direct link to Issues &amp; considerations">‚Äã</a></h4>
<p>By considering these issues and trade-offs, you can effectively implement the Valet Key pattern to enhance security, performance, and cost efficiency in your cloud applications.</p>
<ul>
<li>Ensure that the token or key used for access is securely generated and transmitted to prevent unauthorized access</li>
<li>It could introduce security and audit risks if not implemented correctly</li>
<li>Implement proper access controls and authorization mechanisms to restrict the actions that can be performed using the valet key</li>
<li>Cost savings from offloading processing must be weighed against the complexity of implementing and managing the Valet Key pattern</li>
<li>Monitor and audit access using the valet key to detect any unauthorized or malicious activities</li>
<li>Ensure that the resources are managed efficiently to avoid unnecessary costs, especially when dealing with frequent or large client requests</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="when-to-use-this-pattern-2">When to use this pattern<a href="https://luke.geek.nz/azure/cloud-design-patterns/#when-to-use-this-pattern-2" class="hash-link" aria-label="Direct link to When to use this pattern" title="Direct link to When to use this pattern">‚Äã</a></h4>
<p>Using a valet key doesn't require the resource to be locked, no remote server call is required, there's no limit on the number of valet keys that can be issued, and it avoids a single point of failure resulting from performing the data transfer through the application code.&nbsp;</p>
<p>Consider using the Valet Key pattern in the following scenarios:</p>
<ul>
<li>Offload data transfer from the application to minimize the use of valuable resources such as computing, memory, and bandwidth.</li>
<li>When the data is stored in a remote data store or a different datacenter from the application.</li>
<li>Minimize operational costs by enabling direct access to stores and queues.</li>
<li>Clients regularly upload or download data, particularly where there's a large volume or when each operation involves a large file</li>
<li>If the application doesn‚Äôt need to perform tasks on the data first.</li>
<li>When you need to provide secure, temporary access to specific resources or services.</li>
</ul>
<!-- -->
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="azure-solutions-2">Azure Solutions<a href="https://luke.geek.nz/azure/cloud-design-patterns/#azure-solutions-2" class="hash-link" aria-label="Direct link to Azure Solutions" title="Direct link to Azure Solutions">‚Äã</a></h4>
<p>Azure supports shared access signatures on Azure Storage for granular access control to data in blobs, tables, and queues, and for Service Bus queues and topics. A shared access signature token can be configured to provide specific access rights such as read, write, update, and delete to a specific table, a key range within a table, a queue, a blob, or a blob container. The validity can be a specified time period. This functionality is well-suited for accessing a valet key.</p>
<p>Azure resources that can be used to implement this pattern include <a href="https://learn.microsoft.com/azure/storage/common/storage-introduction?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Storage</a> and <a href="https://learn.microsoft.com/azure/azure-functions/functions-overview?pivots=programming-language-csharp&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Function</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-static-content-hosting">üì¶ Static Content Hosting<a href="https://luke.geek.nz/azure/cloud-design-patterns/#-static-content-hosting" class="hash-link" aria-label="Direct link to üì¶ Static Content Hosting" title="Direct link to üì¶ Static Content Hosting">‚Äã</a></h3>
<blockquote>
<p>Deploy static content to a cloud-based storage service that can deliver them directly to the client.</p>
</blockquote>
<p>Web applications typically include some elements of static content. This static content might include HTML pages and other resources such as images and documents that are available to the client, either as part of an HTML page (such as inline images, style sheets, and client-side JavaScript files) or as separate downloads (such as PDF documents).
Although web servers are optimized for dynamic rendering and output caching, they still have to handle requests to download static content. This consumes processing cycles that could often be better used for more important delivery and user-experience tasks.</p>
<p>Deploy static content to a cloud-based storage service that can deliver them directly to the client. This can reduce the need for potentially expensive compute instances.</p>
<p><img decoding="async" loading="lazy" alt="Cloud Design Pattern - StaticContent" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatterns_StaticContent-5fe5f4bf1d7fca7625bc68a6070178a0.gif" width="1903" height="1005" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="issues--considerations-3">Issues &amp; considerations<a href="https://luke.geek.nz/azure/cloud-design-patterns/#issues--considerations-3" class="hash-link" aria-label="Direct link to Issues &amp; considerations" title="Direct link to Issues &amp; considerations">‚Äã</a></h4>
<p>By considering these issues and trade-offs, you can effectively implement the Valet Key pattern to enhance security, performance, and cost efficiency in your cloud applications.</p>
<ul>
<li>If static content is not included in the application deployment package or process, it may need to be provisioned and deployed independently from the application.</li>
<li>Security access needs to be considered ‚Äì i.e., Public write access to prevent unauthorized uploads.</li>
<li>Storage services might not support the use of a custom domain name</li>
<li>File compression, such as gzip, to reduce load times for clients.</li>
<li>Consider how to handle local development and testing</li>
<li>Geographic concerns: Consider using a content delivery network (CDN) to cache the storage container's contents in multiple data centers around the world.</li>
<li>Caching of existing assets.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="when-to-use-this-pattern-3">When to use this pattern<a href="https://luke.geek.nz/azure/cloud-design-patterns/#when-to-use-this-pattern-3" class="hash-link" aria-label="Direct link to When to use this pattern" title="Direct link to When to use this pattern">‚Äã</a></h4>
<p>Static Content Hosting is a common pattern used in web applications to offload the delivery of static content from the application server to a cloud-based storage service. This pattern is particularly useful when the application server is not optimized for serving static content or when the application server is under heavy load and needs to offload some of the work to improve performance and scalability.</p>
<ul>
<li>Reduce the hosting costs for websites and applications that contain some static resources. Cloud-hosted storage is typically much less expensive than compute instances</li>
<li>Improve the performance of your main WebApp by offloading  static content serving</li>
<li>Expose static resources and content for applications running in other hosting environments or on-premises servers.</li>
<li>Improve your application's performance and availability by using a content delivery network (CDN) to cache the contents of the storage container in multiple datacenters worldwide.</li>
</ul>
<!-- -->
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="azure-solutions-3">Azure Solutions<a href="https://luke.geek.nz/azure/cloud-design-patterns/#azure-solutions-3" class="hash-link" aria-label="Direct link to Azure Solutions" title="Direct link to Azure Solutions">‚Äã</a></h4>
<p>Azure resources that can be used to implement this pattern include <a href="https://learn.microsoft.com/azure/storage/blobs/storage-blobs-introduction?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Blob Storage</a>, <a href="https://learn.microsoft.com/azure/cdn/cdn-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Content Delivery Network (CDN)</a>, and <a href="https://learn.microsoft.com/azure/static-web-apps/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Static Web Apps</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="design--implementation-patterns">Design &amp; Implementation Patterns<a href="https://luke.geek.nz/azure/cloud-design-patterns/#design--implementation-patterns" class="hash-link" aria-label="Direct link to Design &amp; Implementation Patterns" title="Direct link to Design &amp; Implementation Patterns">‚Äã</a></h3>
<p><img decoding="async" loading="lazy" alt="Design &amp;amp; Implementation Patterns" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatterns_DesignImplementation-0d041cba67e09224f3dba8c3fa0d3357.PNG" width="4000" height="2250" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-ambassador">üéâ Ambassador<a href="https://luke.geek.nz/azure/cloud-design-patterns/#-ambassador" class="hash-link" aria-label="Direct link to üéâ Ambassador" title="Direct link to üéâ Ambassador">‚Äã</a></h3>
<blockquote>
<p>Create helper services that send network requests on behalf of a consumer service or application.</p>
</blockquote>
<p>Resilient cloud-based applications require features such as&nbsp;circuit breaking, routing, metering and monitoring, and the ability to make network-related configuration updates. It may be difficult or impossible to update legacy applications or existing code libraries to add these features because the code is no longer maintained or can't be easily modified by the development team.
Network calls may also require substantial configuration for connection, authentication, and authorization. If these calls are used across multiple applications, built using multiple languages and frameworks, the calls must be configured for each of these instances. In addition, network and security functionality may need to be managed by a central team within your organization. With a large code base, it can be risky for that team to update application code they aren't familiar with.</p>
<p>Put client frameworks and libraries into an external process that acts as a proxy between your application and external services. Deploy the proxy on the same host environment as your application to allow control over routing, resiliency, and security features and to avoid any host-related access restrictions.</p>
<p><img decoding="async" loading="lazy" alt="Cloud Design Patterns - Ambassador" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatterns_Ambassador-c492df8d860c4cf9f1077927a3cfcafe.gif" width="1903" height="1005" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="issues--considerations-4">Issues &amp; considerations<a href="https://luke.geek.nz/azure/cloud-design-patterns/#issues--considerations-4" class="hash-link" aria-label="Direct link to Issues &amp; considerations" title="Direct link to Issues &amp; considerations">‚Äã</a></h4>
<p>When implementing the Ambassador pattern, consider the following issues and considerations:</p>
<ul>
<li>Latency Overhead- The proxy adds some latency overhead. It is important to evaluate whether a client library, invoked directly by the application, might be a better approach to avoid this additional latency</li>
<li>Generalized Features - Including generalized features in the proxy can have unintended consequences. For example, the ambassador could handle retries, but this might not be safe unless all operations are idempotent. Ensure that the features implemented in the proxy do not introduce risks or conflicts with the application's requirements</li>
<li>Context Passing ‚Äî Consider a mechanism that allows the client to pass some context to the proxy and back to the client. For example, include HTTP request headers to opt out of retry or specify the maximum number of times to retry. This flexibility can help tailor the proxy's behavior to specific needs.</li>
<li>Packaging and Deployment - Think about how to package and deploy the proxy. The proxy can be deployed as a sidecar to accompany the lifecycle of a consuming application or service. Alternatively, if an ambassador is shared by multiple separate processes on a common host, it can be deployed as a daemon or Windows service</li>
<li>Shared vs. Dedicated Instances - Decide whether to use a single shared instance for all clients or an instance for each client. This decision can impact resource utilization, performance, and isolation between different clients</li>
<li>Security and Configuration - Network calls may require substantial connection, authentication, and authorization configuration. If these calls are used across multiple applications built using multiple languages and frameworks, the calls must be configured for each of these instances. Additionally, network and security functionality may need to be managed by a central team within your organization</li>
<li>Specialized Teams - Features that are offloaded to the ambassador can be managed independently of the application. This allows for separate, specialized teams to implement and maintain security, networking, or authentication features that have been moved to the ambassador without disturbing the application's legacy functionalityBy addressing these issues and considerations, you can effectively implement the Ambassador pattern to enhance the networking capabilities, security, and maintainability of your applications.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="when-to-use-this">When to use this<a href="https://luke.geek.nz/azure/cloud-design-patterns/#when-to-use-this" class="hash-link" aria-label="Direct link to When to use this" title="Direct link to When to use this">‚Äã</a></h4>
<p>The Ambassador pattern should be used in the following scenarios:</p>
<ul>
<li>Offloading Common Client Connectivity Tasks - When you need to offload common client connectivity tasks such as monitoring, logging, routing, security (such as TLS), and resiliency patterns in a language-agnostic way</li>
<li>Legacy Applications - When dealing with legacy applications or other applications that are difficult to modify, the Ambassador pattern can extend their networking capabilities without requiring changes to the application code</li>
<li>Specialized Teams - When you want to enable a specialized team to implement and maintain security, networking, or authentication features independently of the application. This allows for updates and modifications to the ambassador without disturbing the application's legacy functionality</li>
<li>Resilient Cloud-Based Applications - When building resilient cloud-based applications that require features such as circuit breaking, routing, metering and monitoring, and the ability to make network-related configuration updates. The Ambassador pattern can facilitate these features without modifying the existing codebase</li>
<li>Centralized Management of Network and Security - When network calls require substantial configuration for connection, authentication, and authorization across multiple applications built using multiple languages and frameworks. The Ambassador pattern allows these configurations to be managed centrally, reducing the risk of updating application code by a team unfamiliar with it</li>
<li>Standardizing and Extending Instrumentation - When you need to standardize and extend instrumentation, such as monitoring performance metrics like latency or resource usage. The Ambassador pattern allows this monitoring to happen in the same host environment as the application</li>
<li>Supporting Cloud or Cluster Connectivity Requirements - When you need to support cloud or cluster connectivity requirements in a legacy application or an application that is difficult to modify considering these scenarios, you can effectively use the Ambassador pattern to enhance the networking capabilities, security, and maintainability of your applications.</li>
</ul>
<!-- -->
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="azure-solutions-4">Azure Solutions<a href="https://luke.geek.nz/azure/cloud-design-patterns/#azure-solutions-4" class="hash-link" aria-label="Direct link to Azure Solutions" title="Direct link to Azure Solutions">‚Äã</a></h4>
<p>Azure resources that can be used to implement this pattern include <a href="https://learn.microsoft.com/azure/api-management/api-management-key-concepts?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure API Management</a>, <a href="https://learn.microsoft.com/azure/frontdoor/front-door-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Front Door</a> and <a href="https://learn.microsoft.com/azure/firewall/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Firewall</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-sidecar">üöÄ Sidecar<a href="https://luke.geek.nz/azure/cloud-design-patterns/#-sidecar" class="hash-link" aria-label="Direct link to üöÄ Sidecar" title="Direct link to üöÄ Sidecar">‚Äã</a></h3>
<blockquote>
<p>Deploy components of an application into a separate process or container to provide isolation and encapsulation.</p>
</blockquote>
<p>Deploy application components into a separate process or container to provide isolation and encapsulation. This pattern can also enable applications composed of heterogeneous components and technologies.
This pattern is named&nbsp;Sidecar&nbsp;because it resembles a sidecar attached to a motorcycle. In the pattern, the sidecar is attached to a parent application and provides supporting features for the application. The sidecar also shares the same lifecycle as the parent application, being created and retired alongside the parent. The sidecar pattern is sometimes referred to as the sidekick pattern and is a decomposition pattern.</p>
<p><img decoding="async" loading="lazy" alt="Cloud Design Pattern - Sidecar" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatterns_Sidecar-5ad26785315db760ecc98d9d3de4fb06.gif" width="1903" height="1005" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="issues--considerations-5">Issues &amp; considerations<a href="https://luke.geek.nz/azure/cloud-design-patterns/#issues--considerations-5" class="hash-link" aria-label="Direct link to Issues &amp; considerations" title="Direct link to Issues &amp; considerations">‚Äã</a></h4>
<p>When implementing the Sidecar pattern, consider the following issues and considerations.</p>
<ul>
<li>Deployment and Packaging - Carefully decide on the deployment and packaging format for services, processes, or containers. Containers are particularly well-suited to the sidecar pattern</li>
<li>Interprocess Communication - Choose the interprocess communication mechanism wisely. Aim to use language- or framework-agnostic technologies unless performance requirements make that impractical</li>
<li>Functionality Placement - Before placing functionality into a sidecar, consider whether it would work better as a separate service or a more traditional daemon. Also, evaluate if the functionality could be implemented as a library or using a traditional extension mechanism, as language-specific libraries may offer deeper integration and less network overhead</li>
<li>Resource Management - The sidecar can access the same resources as the primary application, which allows it to monitor system resources used by both the sidecar and the primary application</li>
<li>Latency - Communication between a parent application and sidecar services includes some overhead, notably call latency. This may not be an acceptable trade-off for chatty interfaces</li>
<li>Application Size and Resource Cost - For small applications, the resource cost of deploying a sidecar service for each instance may not be worth the advantage of isolation</li>
<li>Scaling - If the service needs to scale differently or independently from the main applications, it may be better to deploy the feature as a separate service</li>
<li>Security - By encapsulating tasks and deploying them out-of-process, you can reduce the surface area of sensitive processes to only the code needed to accomplish the task. Sidecars can also add cross-cutting security controls to an application component that is not natively designed with that functionality</li>
<li>Operational Excellence - The sidecar pattern provides an approach to implementing flexibility in tool integration that might enhance the application's observability without requiring the application to take direct implementation dependencies. It enables the sidecar functionality to evolve and be maintained independently of the application's lifecycle</li>
<li>Performance Efficiency - Moving cross-cutting tasks to a single process that can scale across multiple instances of the main process reduces the need to deploy duplicate functionality for each instance of the application, by addressing these issues and considerations, you can effectively implement the Sidecar pattern to enhance the modularity, security, and maintainability of your applications.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="when-to-use-this-1">When to use this<a href="https://luke.geek.nz/azure/cloud-design-patterns/#when-to-use-this-1" class="hash-link" aria-label="Direct link to When to use this" title="Direct link to When to use this">‚Äã</a></h4>
<p>The Sidecar pattern should be used in the following scenarios.</p>
<ul>
<li>Heterogeneous Set of Languages and Frameworks - When your primary application uses a heterogeneous set of languages and frameworks. A component located in a sidecar service can be consumed by applications written in different languages using different frameworks</li>
<li>Component Ownership by Remote Teams - When a component is owned by a remote team or a different organization. This allows the component to be developed and maintained independently of the main application</li>
<li>Co-location Requirement - When a component or feature must be co-located on the same host as the application. This ensures that the component can access the same resources and environment as the primary application</li>
<li>Independent Updates - When you need a service that shares the overall lifecycle of your main application but can be independently updated. This allows for flexibility in updating the sidecar without affecting the main application</li>
<li>Fine-grained resource Control - When you need fine-grained control over resource limits for a particular resource or component. For example, you may want to restrict the amount of memory a specific component uses. Deploying the component as a sidecar allows you to manage memory usage independently of the main application</li>
<li>Security Enhancements - When you need to encapsulate tasks and deploy them out-of-process to reduce the surface area of sensitive processes to only the code needed to accomplish the task. Sidecars can also add cross-cutting security controls to an application component that is not natively designed with that functionality</li>
<li>Operational Excellence - When you want to implement flexibility in tool integration that might enhance the application's observability without requiring the application to take direct implementation dependencies. The sidecar functionality can evolve and be maintained independently of the application's lifecycle</li>
<li>Performance Efficiency ‚Äî When you want to move cross-cutting tasks to a single process that can scale across multiple instances of the main process, reducing the need to deploy duplicate functionality for each application instance. By considering these scenarios, you can effectively use the Sidecar pattern to enhance the modularity, security, and maintainability of your applications.</li>
</ul>
<!-- -->
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="azure-solutions-5">Azure Solutions<a href="https://luke.geek.nz/azure/cloud-design-patterns/#azure-solutions-5" class="hash-link" aria-label="Direct link to Azure Solutions" title="Direct link to Azure Solutions">‚Äã</a></h4>
<p>Use a&nbsp;sidecar&nbsp;container that enhances the application with the required SSL functionality without modifying the application code. The sidecar pattern is a powerful concept in container-based architectures that lets you decompose application functionality into different container images that run together in the same container group.
In an Azure Container Instances container group, each container can take over part of the functionality the application requires. Sidecar containers can use different container images from the application container, even from different image repositories. Containers in the same container group share some properties, such as the underlying network stack.</p>
<p>Azure resources that can be used to implement this pattern include <a href="https://learn.microsoft.com/azure/container-instances/container-instances-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Container Instances</a>, <a href="https://learn.microsoft.com/azure/aks/intro-kubernetes?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Kubernetes Service</a>, and <a href="https://learn.microsoft.com/azure/app-service/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure App Service</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-leader-election">üéñÔ∏è Leader Election<a href="https://luke.geek.nz/azure/cloud-design-patterns/#%EF%B8%8F-leader-election" class="hash-link" aria-label="Direct link to üéñÔ∏è Leader Election" title="Direct link to üéñÔ∏è Leader Election">‚Äã</a></h3>
<blockquote>
<p>Coordinate the actions performed by a collection of collaborating task instances in a distributed application by electing one instance as the leader who assumes responsibility for managing the other instances.</p>
</blockquote>
<p>A typical cloud application has many tasks acting in a coordinated manner. These tasks could all be instances running the same code and requiring access to the same resources, or they might be working together in parallel to perform the individual parts of a complex calculation.
The task instances might run separately for much of the time, but it might also be necessary to coordinate the actions of each instance to ensure that they don't conflict, cause contention for shared resources, or accidentally interfere with the work that other task instances are performing.
For example:
In a cloud-based system that implements horizontal scaling, multiple instances of the same task could be running at the same time with each instance serving a different user. If these instances write to a shared resource, it's necessary to coordinate their actions to prevent each instance from overwriting the changes made by the others.
If the tasks are performing individual elements of a complex calculation in parallel, the results need to be aggregated when they are all complete.</p>
<p><img decoding="async" loading="lazy" alt="Cloud Design Patterns - Leader Election" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatterns_LeaderElection-b9d849d2cba11ff24a0c38f7a3243c14.gif" width="1903" height="1005" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="issues--considerations-6">Issues &amp; considerations<a href="https://luke.geek.nz/azure/cloud-design-patterns/#issues--considerations-6" class="hash-link" aria-label="Direct link to Issues &amp; considerations" title="Direct link to Issues &amp; considerations">‚Äã</a></h4>
<p>When implementing the Leader Election pattern, consider the following issues and considerations.</p>
<ul>
<li>Preventing Multiple Leaders - Ensure the election process is managed carefully to prevent two or more instances from taking over the leader position simultaneously. This requires a robust mechanism for selecting a leader that can handle events such as network outages or process failures</li>
<li>Failure Detection - The system must be able to detect when the leader has failed or become unavailable (e.g., due to a communications failure). The speed of detection depends on the system's requirements. Some systems can tolerate a short period without a leader, while others need immediate detection and a new election</li>
<li>Handling Leader Termination - In systems with horizontal autoscaling, the leader could be terminated if the system scales back and shuts down some computing resources. Ensure the system can handle such scenarios and elect a new leader promptly</li>
<li>Avoiding Single Points of Failure - Using a shared, distributed mutex introduces a dependency on the external service that provides the mutex, which can become a single point of failure. If this service becomes unavailable, the system won't be able to elect a leader</li>
<li>Leader as a Bottleneck - Avoid making the leader a bottleneck in the system. The leader's role is to coordinate the work of subordinate tasks, not necessarily to participate in the work itself. Ensure the leader can delegate tasks effectively to avoid performance issues</li>
<li>Latency and Performance - The resulting latency from leader coordination can affect the performance and response times of other processes if they are waiting for the leader to coordinate an operation. Optimize the leader election process to minimize latency</li>
<li>Flexibility and Optimization - Implementing leader election algorithms manually provides the greatest flexibility for tuning and optimizing the code. However, this approach requires careful design and testing to ensure robustness</li>
<li>Election Algorithms - Consider using established leader election algorithms such as the Bully Algorithm or the Ring Algorithm. These algorithms assume each candidate in the election has a unique ID and can communicate reliably with other candidates</li>
<li>Coordination Requirements - Use the Leader Election pattern when tasks in a distributed application need careful coordination and there is no natural leader. This pattern is useful for cloud-hosted solutions where multiple instances need to work together without conflict</li>
<li>Alternative Solutions ‚Äî Evaluate whether a more lightweight method, such as optimistic or pessimistic locking, can achieve the required coordination. Also, consider third-party solutions like Apache Zookeeper for managing leader election and coordination tasks. By addressing these issues and considerations, you can effectively implement the Leader Election pattern to ensure reliable and efficient coordination in distributed systems.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="when-to-use-this-2">When to use this<a href="https://luke.geek.nz/azure/cloud-design-patterns/#when-to-use-this-2" class="hash-link" aria-label="Direct link to When to use this" title="Direct link to When to use this">‚Äã</a></h4>
<p>The Leader Election pattern should be used in the following scenarios.</p>
<ul>
<li>Task Coordination - When you need to coordinate a task among multiple instances of a service or application. The Leader Election pattern ensures that one instance acts as the coordinator, preventing conflicts and ensuring smooth operation</li>
<li>Avoiding Single Points of Failure - When you want to avoid having a single point of failure in your application. By using leader election, if the current leader fails, a new leader is automatically selected, ensuring continuous operation without manual intervention&nbsp;</li>
<li>Distributed Systems - In distributed systems where multiple instances need to work together without conflict. The Leader Election pattern helps in managing coordination tasks effectively across different instances</li>
<li>High Availability Requirements - When your application requires high availability and resilience. The pattern helps in maintaining service continuity by electing a new leader if the current one fails, thus supporting failover mechanisms</li>
<li>Scalability - When you need to scale out your application horizontally. The Leader Election pattern can help manage the coordination of tasks across multiple instances, ensuring that the system scales efficiently without bottlenecks</li>
<li>Consensus Algorithms - When implementing consensus algorithms to manage failover and ensure that work is reliably redirected in case of node malfunctions. This is particularly useful in scenarios where reliability and self-healing are critical</li>
<li>Using Off-the-Shelf Solutions - When you prefer not to implement a leader election algorithm from scratch. Off-the-shelf solutions like Apache Zookeeper can be used to manage leader election and coordination tasks effectively. By considering these scenarios, you can effectively use the Leader Election pattern to ensure reliable and efficient coordination in distributed systems, enhancing the overall resilience and scalability of your application.</li>
</ul>
<!-- -->
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="azure-solutions-6">Azure Solutions<a href="https://luke.geek.nz/azure/cloud-design-patterns/#azure-solutions-6" class="hash-link" aria-label="Direct link to Azure Solutions" title="Direct link to Azure Solutions">‚Äã</a></h4>
<p>Azure resources that can be used to implement this pattern include <a href="https://learn.microsoft.com/azure/service-fabric/service-fabric-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Service Fabric</a>, <a href="https://learn.microsoft.com/azure/aks/intro-kubernetes?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Kubernetes Service</a>, and <a href="https://learn.microsoft.com/azure/azure-functions/functions-overview?pivots=programming-language-csharp&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Functions</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-strangler-fig">üå≥ Strangler Fig<a href="https://luke.geek.nz/azure/cloud-design-patterns/#-strangler-fig" class="hash-link" aria-label="Direct link to üå≥ Strangler Fig" title="Direct link to üå≥ Strangler Fig">‚Äã</a></h3>
<blockquote>
<p>Incrementally migrate a legacy system by gradually replacing specific pieces of functionality with new applications and services.</p>
</blockquote>
<p>As systems age, the development tools, hosting technology, and even system architectures they were built on can become increasingly obsolete. As new features and functionality are added, the complexity of these applications can increase dramatically, making them harder to maintain or add new features to.
Completely replacing a complex system can be a huge undertaking. Often, you will need a gradual migration to a new system, while keeping the old system to handle features that haven't been migrated yet. However, running two separate versions of an application means that clients have to know where particular features are located. Every time a feature or service is migrated, clients need to be updated to point to the new location.</p>
<p>The Strangler Fig pattern involves gradually replacing parts of the legacy system with new services. This allows for a controlled and step-by-step transition rather than a wholesale move.</p>
<p><img decoding="async" loading="lazy" alt="Cloud Design Patterns - Strangler Fig" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatterns_StranglerFig-3445af1528afd171c01375016cff344d.gif" width="1903" height="1005" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="issues--considerations-7">Issues &amp; considerations<a href="https://luke.geek.nz/azure/cloud-design-patterns/#issues--considerations-7" class="hash-link" aria-label="Direct link to Issues &amp; considerations" title="Direct link to Issues &amp; considerations">‚Äã</a></h4>
<p>When implementing the Strangler Fig pattern, consider the following issues and considerations.</p>
<ul>
<li>Handling Services and Data Stores - Ensure that both new and legacy systems can access shared services and data stores. This is crucial for maintaining consistency and avoiding data integrity issues during the migration process&nbsp;</li>
<li>Structuring New Applications - Structure new applications and services in a way that they can easily be intercepted and replaced in future migrations. This helps in maintaining flexibility and ease of further transitions.</li>
<li>Facade Management - The facade, which intercepts requests and routes them to either the legacy or new system, must keep up with the migration. It should not become a single point of failure or a performance bottleneck. Proper management and monitoring of the facade are essential to ensure smooth operation2&nbsp;</li>
<li>Incremental Migration - The pattern supports incremental migration, which helps to minimize risk and spread the development effort over time. However, this requires careful planning to ensure that each increment is functional and does not disrupt the overall system</li>
<li>Client Updates - Running two separate versions of an application means that clients need to be updated to know where particular features are located. This can add complexity to the migration process, as each client must be aware of the changes and adapt accordingly</li>
<li>Avoiding Single Points of Failure - Ensure that the facade does not become a single point of failure. It should be designed to handle high availability and failover scenarios to maintain system reliability during the migration</li>
<li>Performance Considerations - The facade should not become a performance bottleneck. It must be capable of handling the load and routing requests efficiently to avoid degrading the user experience</li>
<li>Completing the Migration - At some point, when the migration is complete, the strangler fig facade will either go away or evolve into an adaptor for legacy clients. Plan for this transition to ensure that the final system is clean and does not retain unnecessary components2&nbsp;By addressing these issues and considerations, you can effectively implement the Strangler Fig pattern to ensure a smooth and controlled migration from a legacy system to a new architecture.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="when-to-use-this-3">When to use this<a href="https://luke.geek.nz/azure/cloud-design-patterns/#when-to-use-this-3" class="hash-link" aria-label="Direct link to When to use this" title="Direct link to When to use this">‚Äã</a></h4>
<p>The Strangler Fig pattern should be used in the following scenarios.</p>
<ul>
<li>Gradual Migration -  When you need to incrementally migrate a legacy system to a new architecture. This pattern allows you to gradually replace specific pieces of functionality with new applications and services, minimizing risk and spreading the development effort over time</li>
<li>Complex Systems - When dealing with complex systems where a complete replacement would be a huge undertaking. The Strangler Fig pattern enables a controlled decomposition of a monolith into a set of microservices, allowing the legacy system to continue functioning while new features are added to the new system</li>
<li>Maintaining Functionality - When it is essential to keep the legacy system operational during the migration. The facade in the Strangler Fig pattern intercepts requests and routes them to either the legacy application or the new services, ensuring that consumers can continue using the same interface without being aware of the migration</li>
<li>Avoiding Big Bang Rewrites - When you want to avoid the risks associated with a "big bang" rewrite. The Strangler Fig pattern supports an incremental approach, allowing you to add functionality to the new system at your own pace while ensuring the legacy application continues to function</li>
<li>Modernizing Legacy Systems - When modernizing legacy systems that have become increasingly obsolete due to outdated development tools, hosting technology, or system architectures. The pattern helps in gradually transitioning to a new system while maintaining the old system for features that haven't been migrated yet</li>
<li>Using Modern Orchestration Tools - When you want to leverage modern orchestration tools such as Azure DevOps to manage the lifecycle of each service. Once the application has been decomposed into constituent microservices, these tools can be used to manage the new system effectively. Considering these scenarios, you can effectively use the Strangler Fig pattern to ensure a smooth and controlled migration from a legacy system to a new architecture, enhancing the overall resilience and scalability of your application.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="azure-solutions-7">Azure Solutions<a href="https://luke.geek.nz/azure/cloud-design-patterns/#azure-solutions-7" class="hash-link" aria-label="Direct link to Azure Solutions" title="Direct link to Azure Solutions">‚Äã</a></h4>
<p>Many <a href="https://azure.microsoft.com/products?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure products</a>, can be used to implement this pattern.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="messaging-patterns">Messaging Patterns<a href="https://luke.geek.nz/azure/cloud-design-patterns/#messaging-patterns" class="hash-link" aria-label="Direct link to Messaging Patterns" title="Direct link to Messaging Patterns">‚Äã</a></h3>
<p><img decoding="async" loading="lazy" alt="Messaging Patterns" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatterns_Messaging-96157045d56ca73d261c3e61955ef24f.PNG" width="4000" height="2250" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-sequential-convoy">üöö Sequential Convoy<a href="https://luke.geek.nz/azure/cloud-design-patterns/#-sequential-convoy" class="hash-link" aria-label="Direct link to üöö Sequential Convoy" title="Direct link to üöö Sequential Convoy">‚Äã</a></h4>
<blockquote>
<p>Process a set of related messages in a defined order without blocking the processing of other groups of messages.</p>
</blockquote>
<p>Applications often need to process a sequence of messages in the order they arrive, while still being able to scale out to handle increased load. In a distributed architecture, processing these messages in order is not straightforward, because the workers can scale independently and often pull messages independently</p>
<p>Push related messages into categories within the queuing system, and have the queue listeners lock and pull only from one category, one message at a time.</p>
<p><img decoding="async" loading="lazy" alt="Cloud Design Pattern - Sequential Covey" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatterns_SequentialCovey-cd14b2fb7322b541b41ce3b1dc7c7a7e.gif" width="1903" height="1005" class="img_ev3q"></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="issues--considerations-8">Issues &amp; considerations<a href="https://luke.geek.nz/azure/cloud-design-patterns/#issues--considerations-8" class="hash-link" aria-label="Direct link to Issues &amp; considerations" title="Direct link to Issues &amp; considerations">‚Äã</a></h5>
<p>The Sequential Convoy pattern is designed to process a set of related messages in a defined order without blocking the processing of other groups of messages. Here are some issues and considerations associated with this pattern</p>
<ul>
<li>Message Ordering - Ensuring that messages are processed in the order they arrive can be challenging in a distributed architecture. Workers can scale independently and often pull messages independently, which can disrupt the order of processing</li>
<li>Scalability - While the pattern allows for scaling out to handle increased load, it requires careful management to ensure that the order of messages is maintained. This can involve categorizing related messages within the queuing system and having queue listeners lock and pull only from one category at a time</li>
<li>Complexity in Implementation - Implementing the Sequential Convoy pattern can be complex, especially when dealing with interleaved transactions for multiple orders. The system must be designed to handle these transactions in a first-in-first-out (FIFO) manner at the order level</li>
<li>Resource Management - Efficiently managing resources to ensure that the processing of one group of messages does not block others is crucial. This involves coordinating actions across distributed services and remote resources</li>
<li>Error Handling - Handling errors in a sequential processing system can be more complex. If an error occurs, the system must ensure that subsequent messages are not processed until the error is resolved, which can involve implementing compensating transactions or other error recovery mechanisms By addressing these issues and considerations, the Sequential Convoy pattern can be effectively implemented to ensure ordered processing of related messages in a distributed system.</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="when-to-use-this-pattern-4">When to use this pattern<a href="https://luke.geek.nz/azure/cloud-design-patterns/#when-to-use-this-pattern-4" class="hash-link" aria-label="Direct link to When to use this pattern" title="Direct link to When to use this pattern">‚Äã</a></h5>
<p>The Sequential Convoy pattern should be used in the following scenarios.</p>
<ul>
<li>Ordered Message Processing - When you have messages that arrive in a specific order and must be processed in that same order. This is crucial for maintaining the integrity and consistency of the operations being performed</li>
<li>Categorized Messages - When arriving messages can be categorized in such a way that the category becomes a unit of scale for the system. For example, in an order tracking system, messages can be categorized by order ID, ensuring that all operations related to a specific order are processed sequentially</li>
<li>Avoiding Blocking - When you need to process a set of related messages in a defined order without blocking the processing of other groups of messages. This allows for efficient handling of multiple message groups concurrently while maintaining order within each group&nbsp;However, this pattern might not be suitable for extremely high throughput scenarios (millions of messages per minute or second), as the FIFO (First in and First Out) requirement limits the scaling that can be done by the system.</li>
</ul>
<!-- -->
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="azure-solutions-8">Azure Solutions<a href="https://luke.geek.nz/azure/cloud-design-patterns/#azure-solutions-8" class="hash-link" aria-label="Direct link to Azure Solutions" title="Direct link to Azure Solutions">‚Äã</a></h5>
<p>Azure resources that can be used to implement this pattern include <a href="https://learn.microsoft.com/azure/service-bus-messaging/service-bus-messaging-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Service Bus</a>, <a href="https://learn.microsoft.com/azure/event-grid/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Event Grid</a>, and <a href="https://learn.microsoft.com/azure/azure-functions/functions-overview?pivots=programming-language-csharp&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Functions</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-queue-based-load-leveling">üìå Queue-Based Load Leveling<a href="https://luke.geek.nz/azure/cloud-design-patterns/#-queue-based-load-leveling" class="hash-link" aria-label="Direct link to üìå Queue-Based Load Leveling" title="Direct link to üìå Queue-Based Load Leveling">‚Äã</a></h3>
<blockquote>
<p>Use a buffer between a task and a service that it invokes in order to smooth intermittent heavy loads.</p>
</blockquote>
<p>Use a queue that acts as a buffer between a task and a service it invokes to smooth intermittent heavy loads that can cause the service to fail or the task to time out. This can help minimize the impact of peaks in demand on availability and responsiveness for both the task and the service.
Context and problem, many solutions in the cloud involve running tasks that invoke services. In this environment, if a service is subjected to intermittent heavy loads, it can cause performance or reliability issues.
A service could be part of the same solution as the tasks that use it, or it could be a third-party service providing access to frequently used resources such as a cache or a storage service. If the same service is used by a number of tasks running concurrently, it can be difficult to predict the volume of requests to the service at any time.
A service might experience peaks in demand that cause it to overload and be unable to respond to requests in a timely manner. Flooding a service with a large number of concurrent requests can also result in the service failing if it's unable to handle the contention these requests cause.
Solution, Refactor the solution and introduce a queue between the task and the service.</p>
<p><img decoding="async" loading="lazy" alt="Cloud Design Patterns - Queue Based Levelling " src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatterns_QueueBasedLeveling-21042a47a507610395aa8ceebe68854b.gif" width="1903" height="1005" class="img_ev3q"></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="issues--considerations-9">Issues &amp; considerations<a href="https://luke.geek.nz/azure/cloud-design-patterns/#issues--considerations-9" class="hash-link" aria-label="Direct link to Issues &amp; considerations" title="Direct link to Issues &amp; considerations">‚Äã</a></h5>
<p>The Queue-Based Load Leveling pattern is designed to handle intermittent heavy loads by using a queue as a buffer between a task and a service it invokes. Here are some issues and considerations associated with this pattern</p>
<ul>
<li>Rate Control - It is necessary to implement application logic that controls the rate at which services handle messages to avoid overwhelming the target resource. This involves ensuring that spikes in demand are not passed to the next stage of the system</li>
<li>Testing Under Load - The system should be tested under load to ensure that it provides the required leveling. Adjustments may be needed in the number of queues and the number of service instances that handle messages to achieve optimal performance</li>
<li>Scalability - The pattern can help maximize scalability because both the number of queues and the number of services can be varied to meet demand. However, careful management is required to ensure that the system scales effectively without introducing bottlenecks</li>
<li>Availability - This pattern can help maximize availability because delays in services won't have an immediate and direct impact on the application. The application can continue to post messages to the queue even when the service isn't available or isn't currently processing messages</li>
<li>Cost Control - The number of service instances deployed only needs to be adequate to meet the average load rather than the peak load, which can help control costs. However, this requires careful monitoring and adjustment to ensure that the system remains cost-effective while meeting performance requirements</li>
<li>Throttling - Some services implement throttling when demand reaches a threshold beyond which the system could fail. Implementing load-leveling with these services can ensure that this threshold isn't reached, thereby maintaining service functionality</li>
<li>Temporal Decoupling - A message broker provides temporal decoupling, meaning the producer and consumer do not have to run concurrently. This allows the producer to send messages regardless of the consumer's availability, and the consumer can process messages at its own pace</li>
<li>Asynchronous Processing ‚Äî The pattern supports asynchronous message processing, which can help maintain the responsiveness of the user interface and distribute processing across multiple servers to improve throughput. By considering these issues and implementing appropriate strategies, the Queue-Based Load Leveling pattern can effectively manage load and improve a system's resilience and scalability.</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="when-to-use-this-pattern-5">When to use this pattern<a href="https://luke.geek.nz/azure/cloud-design-patterns/#when-to-use-this-pattern-5" class="hash-link" aria-label="Direct link to When to use this pattern" title="Direct link to When to use this pattern">‚Äã</a></h5>
<p>The Queue-Based Load Leveling pattern should be used in the following scenarios:</p>
<ul>
<li>Handling Intermittent Heavy Loads - When a service is subjected to intermittent heavy loads that can cause performance or reliability issues, this pattern helps to smooth out these loads by using a queue as a buffer between the task and the service it invokes</li>
<li>Decoupling Tasks from Services - When you need to decouple tasks from services to allow the service to handle messages at its own pace, regardless of the volume of requests from concurrent tasks. This ensures that the service is not overwhelmed by a sudden spike in demand</li>
<li>Maximizing Availability - When you want to ensure that delays in services do not have an immediate and direct impact on the application. The application can continue to post messages to the queue even when the service isn't available or isn't currently processing messages</li>
<li>Maximizing Scalability - When you need to scale both the number of queues and the number of services to meet demand. This pattern allows for flexible scaling to handle varying loads</li>
<li>Cost Control - When you want to control costs by deploying a number of service instances that only need to be adequate to meet the average load rather than the peak load. This can help in reducing the overall cost of the system</li>
<li>Throttling - When services implement throttling to prevent system failure due to high demand. The Queue-Based Load Leveling pattern can help ensure that the demand does not exceed the service's capacity, thereby maintaining functionality</li>
<li>Asynchronous Processing ‚Äî When you need to perform tasks asynchronously to maintain the responsiveness of the user interface and distribute processing across multiple servers to improve throughput, you can use the Queue-Based Load Leveling pattern in these scenarios to improve your system's resilience, scalability, and cost-effectiveness.</li>
</ul>
<!-- -->
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="azure-solutions-9">Azure Solutions<a href="https://luke.geek.nz/azure/cloud-design-patterns/#azure-solutions-9" class="hash-link" aria-label="Direct link to Azure Solutions" title="Direct link to Azure Solutions">‚Äã</a></h5>
<p>Azure resources that can be used to implement this pattern include <a href="https://learn.microsoft.com/azure/service-bus-messaging/service-bus-messaging-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Service Bus</a>, <a href="https://learn.microsoft.com/azure/event-grid/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Event Grid</a>, and <a href="https://learn.microsoft.com/azure/azure-functions/functions-overview?pivots=programming-language-csharp&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Functions</a>.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-publisher-subscriber">üìå Publisher-Subscriber<a href="https://luke.geek.nz/azure/cloud-design-patterns/#-publisher-subscriber" class="hash-link" aria-label="Direct link to üìå Publisher-Subscriber" title="Direct link to üìå Publisher-Subscriber">‚Äã</a></h4>
<blockquote>
<p>Enable an application to announce events to multiple interested consumers asynchronously, without coupling the senders to the receivers.</p>
</blockquote>
<p>Publisher-Subscriber, or PubSub for short, enables an application to announce events to multiple interested consumers asynchronously without coupling the senders to the receivers.</p>
<p>In cloud-based and distributed applications, system components often need to provide information to other components as events occur.
Asynchronous messaging is an effective way to decouple senders from consumers and avoid blocking the sender from waiting for a response. The sender uses an input messaging channel. The sender packages events into messages, using a known message format, and sends these messages via the input channel. The sender in this pattern is also called the&nbsp;publisher.</p>
<p>One output messaging channel per consumer. The consumers are known as&nbsp;subscribers.
A mechanism for copying each message from the input channel to the output channels for all subscribers interested in that message. This operation is typically handled by an intermediary such as a message broker or event bus.</p>
<p><img decoding="async" loading="lazy" alt="Cloud Design Pattern - Publisher-Subscriber (PubSub)" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatterns_PubSub-a01b413a68767c7c256453c7de35fec6.gif" width="1903" height="1005" class="img_ev3q"></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="issues--considerations-10">Issues &amp; considerations<a href="https://luke.geek.nz/azure/cloud-design-patterns/#issues--considerations-10" class="hash-link" aria-label="Direct link to Issues &amp; considerations" title="Direct link to Issues &amp; considerations">‚Äã</a></h5>
<p>The Publisher-Subscriber pattern, also known as Pub-Sub, is a messaging pattern where an application (publisher) sends messages or events to multiple interested consumers (subscribers) asynchronously. Here are some issues and considerations associated with this pattern</p>
<ul>
<li>Scalability - One of the main challenges is ensuring the system can scale efficiently as the number of subscribers increases. Each new subscriber typically requires additional resources and potentially changes to the application code to handle the new message queue</li>
<li>Message Delivery - Ensuring that messages are delivered to all subscribers reliably and in a timely manner can be complex. Message queues generally aim to deliver messages in a first-in-first-out (FIFO) manner, but this order is not always guaranteed, especially under high-load conditions</li>
<li>Monitoring and Alerts - Implementing effective monitoring and alerting mechanisms is crucial to tracking the performance of message queues, detecting stuck messages, and ensuring that subscribers are processing messages efficiently</li>
<li>Security - Ensuring that messages are encrypted and only authorized subscribers can access them is essential. This involves implementing robust authentication and authorization mechanisms</li>
<li>Handling Subscriptions - Deciding how to manage subscriptions is important. You need to determine whether subscribers can subscribe and unsubscribe at their own pace or if an approval mechanism is required</li>
<li>Message Duplication - Handling duplicate messages is necessary because message queues guarantee at least one delivery, which means there is a chance that a message might be delivered more than once. Implementing deduplication mechanisms can help manage this issue</li>
<li>Poison Messages - Managing poison messages, which are messages that repeatedly fail to be processed, is important. These messages should be moved to a separate poison queue to free up the main queue for other messages</li>
<li>One-Way Communication - The Pub-Sub pattern is inherently one-way, meaning that subscribers cannot send acknowledgments or responses back to the publisher. If two-way communication is needed, another pattern like Request-Reply should be implemented</li>
<li>Message Expiration - Defining how long messages should remain in the queue before they expire is important. This helps in managing the lifecycle of messages and ensuring that outdated messages do not clog the system</li>
<li>Wildcard Subscriptions ‚Äî Implementing wildcard subscriptions can allow subscribers to subscribe to all topics with a single action, simplifying the management of multiple topics. By addressing these issues and considerations, the Publisher-Subscriber pattern can be effectively implemented to enable scalable, reliable, and secure asynchronous communication between publishers and multiple subscribers.</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="when-to-use-this-pattern-6">When to use this pattern<a href="https://luke.geek.nz/azure/cloud-design-patterns/#when-to-use-this-pattern-6" class="hash-link" aria-label="Direct link to When to use this pattern" title="Direct link to When to use this pattern">‚Äã</a></h5>
<p>The Publisher-Subscriber (Pub-Sub) pattern should be used in the following scenarios.</p>
<ul>
<li>Broadcasting Information to Multiple Consumers - When you need to send the same information to multiple consumers simultaneously, the Pub-Sub pattern is ideal. This allows a single publisher to broadcast messages to multiple subscribers without needing to send individual messages to each one</li>
<li>Decoupling Senders and Receivers - When you want to decouple the senders of messages from the receivers, enabling them to operate independently. This is useful in systems where the publisher does not need to know about the subscribers and vice versa</li>
<li>Asynchronous Communication - When you need to enable asynchronous communication between different parts of a system. This allows the publisher to send messages without waiting for the subscribers to process them, improving the overall responsiveness and scalability of the system</li>
<li>Event-Driven Architectures - When implementing event-driven architectures where components need to react to events as they happen. The Pub-Sub pattern allows for real-time event propagation to multiple interested parties</li>
<li>Handling Real-Time Notifications - When you need to provide real-time notifications to multiple subscribers, such as in monitoring systems, alerting mechanisms or live data feeds</li>
<li>Scalability and Flexibility - When you need a scalable and flexible system where new subscribers can be added without modifying the publisher. This allows the system to grow and adapt to new requirements easily</li>
<li>Filtering and Routing Messages ‚Äî When you need to filter and route messages to specific subscribers based on certain criteria, you can use topics and content filtering mechanisms. By using the Publisher-Subscriber pattern in these scenarios, you can create a robust, scalable, and flexible messaging system that efficiently handles communication between different components.</li>
</ul>
<!-- -->
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="azure-solutions-10">Azure Solutions<a href="https://luke.geek.nz/azure/cloud-design-patterns/#azure-solutions-10" class="hash-link" aria-label="Direct link to Azure Solutions" title="Direct link to Azure Solutions">‚Äã</a></h5>
<p>Azure resources that can be used to implement this pattern include <a href="https://learn.microsoft.com/azure/service-bus-messaging/service-bus-messaging-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Service Bus</a>, <a href="https://learn.microsoft.com/azure/event-grid/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Event Grid</a>.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-asynchronous-request-reply">üîÑ Asynchronous Request-Reply<a href="https://luke.geek.nz/azure/cloud-design-patterns/#-asynchronous-request-reply" class="hash-link" aria-label="Direct link to üîÑ Asynchronous Request-Reply" title="Direct link to üîÑ Asynchronous Request-Reply">‚Äã</a></h4>
<blockquote>
<p>Decouple backend processing from a frontend host, where backend processing needs to be asynchronous, but the frontend still needs a clear response.</p>
</blockquote>
<p>In modern application development, it's normal for client applications ‚Äî often code running in a web client (browser) ‚Äî to depend on remote APIs to provide business logic and compose functionality. In most cases, APIs for a client network infrastructure are largely out of the control of the application developer. Most APIs can respond quickly enough for responses to arrive back over the same connection. Application code can make a synchronous API call in a non-blocking way, giving the appearance of asynchronous processing, which is recommended for I/O-bound operations.
In some scenarios, however, the work done by the backend may be long-running, on the order of seconds, or might be a background process that is executed in minutes or even hours. In that case, it isn't feasible to wait for the work to complete before responding to the request. This situation is a potential problem for any synchronous request-reply pattern. Applications are designed to respond quickly, on the order of 100 ms or less.&nbsp;
One solution to this problem is to use HTTP polling. Polling is useful to client-side code, as it can be hard to provide call-back endpoints or use long-running connections. Even when callbacks are possible, the extra libraries and services that are required can sometimes add too much extra complexity.</p>
<p><img decoding="async" loading="lazy" alt="Cloud Design Pattern - Asyncronous Request-Reply" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatterns_AsyncronousRequestReply-ff3dc8c29388435577cb517154ad775c.gif" width="1903" height="1005" class="img_ev3q"></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="issues--considerations-11">Issues &amp; considerations<a href="https://luke.geek.nz/azure/cloud-design-patterns/#issues--considerations-11" class="hash-link" aria-label="Direct link to Issues &amp; considerations" title="Direct link to Issues &amp; considerations">‚Äã</a></h5>
<p>The Asynchronous Request-Reply pattern is used to decouple backend processing from a frontend host, where backend processing needs to be asynchronous, but the frontend still needs a clear response. Here are some issues and considerations associated with this pattern</p>
<ul>
<li>Latency and Response Time - The pattern is designed to handle scenarios where backend processing is long-running. However, this introduces latency in the response time, as the client has to poll for the result of the long-running operation. This can affect the user experience if not managed properly</li>
<li>Polling Mechanism - Implementing an efficient polling mechanism is crucial. The HTTP02 response should indicate the location and frequency that the client should poll for the response. This helps in managing the load on the server and ensures that the client does not overwhelm the server with frequent polling requests</li>
<li>Handling Long-Running Operations - The backend must be capable of handling long-running operations efficiently. This includes offloading processing to another component, such as a message queue, and ensuring that the status endpoint can accurately reflect the progress of the operation</li>
<li>Error Handling - Proper error handling mechanisms need to be in place. If an error occurs during processing, the error should persist at the resource URL described in the location header, and the appropriate response code (HTTP 4xx) should be returned. This ensures that the client is aware of any issues and can take appropriate action</li>
<li>Status Codes and Redirects - The API should return the correct status codes based on the state of the operation. For example, upon successful processing, the API should return HTTP00 (OK), HTTP01 (Created), or HTTP04 (No Content). If the status endpoint redirects on completion, HTTP 302 or HTTP 303 should be used</li>
<li>Client-Side Considerations - The client-side code must be designed to handle asynchronous responses. This includes managing the polling logic, handling different status codes, and updating the user interface based on the progress and completion of the operation</li>
<li>Scalability - The pattern allows the client process and the backend API to scale independently. However, this separation also brings additional complexity when the client requires success notification, as this step needs to become asynchronous</li>
<li>Security - Ensuring secure communication between the client and the server is essential. This includes validating both the request and the action to be performed before starting the long-running process and ensuring that sensitive data is protected during transmission</li>
<li>Legacy Clients - Some legacy clients might not support this pattern. It is important to consider the compatibility of the pattern with existing clients and whether additional support or alternative solutions are needed for those clients</li>
<li>Resource Management - Efficiently managing resources such as message queues and status endpoints is crucial to prevent resource exhaustion and ensure the system can handle many concurrent requests. By addressing these issues and considerations, the Asynchronous Request-Reply pattern can be effectively implemented to handle long-running operations while providing a clear response to the client.</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="when-to-use-this-pattern-7">When to use this pattern<a href="https://luke.geek.nz/azure/cloud-design-patterns/#when-to-use-this-pattern-7" class="hash-link" aria-label="Direct link to When to use this pattern" title="Direct link to When to use this pattern">‚Äã</a></h5>
<p>The Asynchronous Request-Reply pattern should be used in the following scenarios.</p>
<ul>
<li>Long-Running Backend Operations - When the backend processing is long-running, taking seconds, minutes, or even hours, and it is not feasible to keep the client waiting for the operation to complete. This pattern allows the client to initiate the request and then poll for the result later</li>
<li>Decoupling Frontend and Backend - When you need to decouple the frontend host from the backend processing. This is useful in scenarios where the frontend needs a clear response, but the backend processing needs to be asynchronous</li>
<li>Scalability - When you want to enable the client process and the backend API to scale independently. By using a message broker to separate the request and response stages, you can achieve better scalability and manage load more effectively</li>
<li>Handling High Latency - When factors such as network infrastructure, geographic location, or current load can add significant latency to the response. The pattern helps mitigate these issues by allowing the backend to process the request asynchronously and the client to poll for the result</li>
<li>Microservices Architectures - When implementing microservices architectures where server-to-server REST API calls are common. The pattern helps manage long-running operations and decouples services, making the system more resilient and scalable</li>
<li>Client-Side Polling - When it is difficult to provide call-back endpoints or use long-running connections on the client side. The pattern allows the client to poll for the result, which can be simpler and more efficient in certain scenariosBy using the Asynchronous Request-Reply pattern in these scenarios, you can effectively manage long-running operations, improve scalability, and decouple frontend and backend processing, leading to a more robust and responsive system.</li>
</ul>
<!-- -->
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="azure-solutions-11">Azure Solutions<a href="https://luke.geek.nz/azure/cloud-design-patterns/#azure-solutions-11" class="hash-link" aria-label="Direct link to Azure Solutions" title="Direct link to Azure Solutions">‚Äã</a></h5>
<p>An application that uses Azure Functions to implement this pattern. There are three functions in the solution:</p>
<ul>
<li>The asynchronous API endpoint.</li>
<li>The status endpoint.</li>
<li>A backend function that takes queued work items and executes them.</li>
</ul>
<p>Azure resources that can be used to implement this pattern include <a href="https://learn.microsoft.com/azure/azure-functions/functions-overview?pivots=programming-language-csharp&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Functions</a>, <a href="https://learn.microsoft.com/azure/service-bus-messaging/service-bus-messaging-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Service Bus</a>, and <a href="https://learn.microsoft.com/azure/storage/queues/storage-queues-introduction?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Storage Queues</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="reliability-patterns">Reliability Patterns<a href="https://luke.geek.nz/azure/cloud-design-patterns/#reliability-patterns" class="hash-link" aria-label="Direct link to Reliability Patterns" title="Direct link to Reliability Patterns">‚Äã</a></h3>
<p><img decoding="async" loading="lazy" alt="Reliability Patterns" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatterns_Reliability-70846e1cb6b986530554f7b4b68a7ab3.PNG" width="4000" height="2250" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-circuit-breaker">‚ö°Ô∏è Circuit Breaker<a href="https://luke.geek.nz/azure/cloud-design-patterns/#%EF%B8%8F-circuit-breaker" class="hash-link" aria-label="Direct link to ‚ö°Ô∏è Circuit Breaker" title="Direct link to ‚ö°Ô∏è Circuit Breaker">‚Äã</a></h4>
<blockquote>
<p>Handle faults that might take a variable amount of time to recover from when connecting to a remote service or resource. This can improve an application's stability and resiliency.</p>
</blockquote>
<p>In a distributed environment, calls to remote resources and services can fail due to transient faults, such as slow network connections, timeouts, or the resources being overcommitted or temporarily unavailable. These faults typically correct themselves after a short period of time, and a robust cloud application should be prepared to handle them by using a strategy such as the&nbsp;<a href="https://learn.microsoft.com/dotnet/architecture/cloud-native/application-resiliency-patterns?WT.mc_id=AZ-MVP-5004796#retry-pattern" target="_blank" rel="noopener noreferrer">Retry pattern</a>.
However, there can also be situations where faults are due to unanticipated events, and that might take much longer to fix. These faults can range in severity from a partial loss of connectivity to the complete failure of a service. In these situations, it might be pointless for an application to retry an operation that is unlikely to succeed continually, and instead, the application should quickly accept that the operation has failed and handle this failure accordingly. Additionally, if a service is very busy, failure in one part of the system might lead to cascading failures. The purpose of the Circuit Breaker pattern is different than the Retry pattern. The Retry pattern enables an application to retry an operation in the expectation that it'll succeed. The Circuit Breaker pattern prevents an application from performing an operation that is likely to fail. An application can combine these two patterns by using the Retry pattern to invoke an operation through a circuit breaker. However, the retry logic should be sensitive to any exceptions returned by the circuit breaker and abandon retry attempts if the circuit breaker indicates that a fault is not transient. The failure counter used by the&nbsp;Closed&nbsp;state is time-based. It's automatically reset at periodic intervals. This helps to prevent the circuit breaker from entering the&nbsp;Open&nbsp;state if it experiences occasional failures.</p>
<p><img decoding="async" loading="lazy" alt="Cloud Design Patterns - Circuit Breaker" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatterns_CircuitBreaker-f8429abda165e955f780a7b868662150.gif" width="1903" height="1005" class="img_ev3q"></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="issues--considerations-12">Issues &amp; considerations<a href="https://luke.geek.nz/azure/cloud-design-patterns/#issues--considerations-12" class="hash-link" aria-label="Direct link to Issues &amp; considerations" title="Direct link to Issues &amp; considerations">‚Äã</a></h5>
<p>The Circuit Breaker pattern is designed to handle faults that might take a variable amount of time to recover from, especially when connecting to remote services or resources. Here are some issues and considerations associated with this pattern</p>
<ul>
<li>State Management - The Circuit Breaker pattern typically involves three states: Closed, Open, and Half-Open. Managing these states correctly is crucial. The Closed state allows normal operation, the Open state immediately fails requests, and the Half-Open state allows a limited number of test requests to check if the issue has been resolved</li>
<li>Thresholds and Timeouts - Setting appropriate thresholds for the number of failures and timeouts is essential. If the thresholds are too low, the circuit breaker might open too frequently, causing unnecessary failures. If they are too high, the system might not protect itself effectively from cascading failures</li>
<li>Recovery Testing - In the Open state, the circuit breaker should periodically test the service to see if it has recovered. This can be done using a timer or by pinging the service. The interval for these tests should be carefully chosen based on the criticality of the operation and the nature of the service&nbsp;</li>
<li>Manual Override - Providing a manual override option can be beneficial in systems where the recovery time for a failing operation is extremely variable. This allows administrators to manually reset the circuit breaker or force it into the Open state as needed</li>
<li>Concurrency - The circuit breaker might be accessed by a large number of concurrent instances of an application. The implementation should ensure that it does not block concurrent requests or add excessive overhead to each call</li>
<li>Resource Differentiation - Using a single circuit breaker for multiple underlying independent providers can be problematic. For example, in a data store with multiple shards, one shard might be accessible while another is experiencing issues. The circuit breaker should differentiate between these resources to avoid unnecessary failures</li>
<li>Accelerated Circuit Breaking - Sometimes, a failure response can provide enough information for the circuit breaker to trip immediately and stay tripped for a minimum amount of time. For example, an overloaded shared resource might indicate that an immediate retry is not recommended</li>
<li>Replaying Failed Requests - In the Open state, the circuit breaker could record the details of each failed request and arrange for these requests to be replayed when the service becomes available again. This ensures that important operations are not lost</li>
<li>Inappropriate Timeouts - The circuit breaker might not fully protect applications from operations that fail in external services configured with lengthy timeouts. If the timeout is too long, a thread running the circuit breaker might be blocked for an extended period, tying up resources</li>
<li>Impact on Shared Resources - Aggressive retry policies can cause an increasing number of transient faults for other users and applications sharing the same resources. It is important to consider the impact of the circuit breaker on shared resources and other tenants in a multi-tenant environment. Addressing these issues and considerations, the Circuit Breaker pattern can be effectively implemented to improve the stability and resiliency of an application, preventing cascading failures and managing long-lasting faults efficiently.</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="when-to-use-this-pattern-8">When to use this pattern<a href="https://luke.geek.nz/azure/cloud-design-patterns/#when-to-use-this-pattern-8" class="hash-link" aria-label="Direct link to When to use this pattern" title="Direct link to When to use this pattern">‚Äã</a></h5>
<p>The Circuit Breaker pattern should be used in the following scenarios.</p>
<ul>
<li>Handling Persistent or Non-Transient Errors - When an application encounters persistent or non-transient errors, such as a service being down or a network failure, the Circuit Breaker pattern can prevent the application from continually trying to perform an operation that is likely to fail</li>
<li>Preventing Resource Exhaustion - If a service is frequently unavailable or busy, it might be due to resource exhaustion. The Circuit Breaker pattern helps to prevent further strain on the service by stopping additional requests until the service has had time to recover</li>
<li>Improving System Stability - The pattern provides stability while the system recovers from a failure and minimizes the impact on performance. It quickly rejects requests for operations that are likely to fail rather than waiting for them to time out or never return</li>
<li>Managing Long-Lasting Faults - When faults are likely to be long-lasting or terminal, the Circuit Breaker pattern can handle these faults as exceptions. The application can log the exception and try to continue by invoking an alternative service or offering degraded functionality</li>
<li>Avoiding Cascading Failures - The pattern helps mitigate failures and avoid cascading failures disrupting the entire application. By stopping requests to a failing service, it prevents the failure from propagating to other parts of the system</li>
<li>Testing Service Recovery - The Circuit Breaker pattern allows the application to periodically test the service to detect when it becomes available again. This can be done on an intermittent basis with long intervals between requests, depending on the criticality of the operation and the nature of the service</li>
<li>Logging and Monitoring‚ÄîThe pattern can be used to log all failed requests and monitor the operation's health. This information can be used to alert administrators when a circuit breaker trips to the Open state, providing insights into the system's health. Using the Circuit Breaker pattern in these scenarios, you can improve the resiliency and stability of your application, prevent resource exhaustion, and manage long-lasting faults effectively.</li>
</ul>
<!-- -->
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="azure-solutions-12">Azure Solutions<a href="https://luke.geek.nz/azure/cloud-design-patterns/#azure-solutions-12" class="hash-link" aria-label="Direct link to Azure Solutions" title="Direct link to Azure Solutions">‚Äã</a></h5>
<p>Azure resources that can be used to implement this pattern include <a href="https://learn.microsoft.com/azure/api-management/api-management-key-concepts?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure API Management</a>.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-deployment-stamps">üìÆ Deployment Stamps<a href="https://luke.geek.nz/azure/cloud-design-patterns/#-deployment-stamps" class="hash-link" aria-label="Direct link to üìÆ Deployment Stamps" title="Direct link to üìÆ Deployment Stamps">‚Äã</a></h4>
<blockquote>
<p>The deployment stamp pattern involves provisioning, managing, and monitoring a heterogeneous group of resources to host and operate multiple workloads or tenants.</p>
</blockquote>
<p>The deployment stamp pattern involves provisioning, managing, and monitoring a heterogeneous group of resources to host and operate multiple workloads or tenants. Each individual copy is called a&nbsp;stamp or sometimes a&nbsp;service unit,&nbsp;scale unit, or&nbsp;cell. In a multitenant environment, every stamp or scale unit can serve a predefined number of tenants. Multiple stamps can be deployed to scale the solution almost linearly and serve an increasing number of tenants. This approach can improve the scalability of your solution, allow you to deploy instances across multiple regions, and separate your customer data. consider grouping resources in&nbsp;scale units&nbsp;and provisioning multiple copies of your&nbsp;stamps. Each&nbsp;scale unit&nbsp;will host and serve a subset of your tenants. Stamps operate independently of each other and can be deployed and updated independently. A single geographical region might contain a single stamp or might contain multiple stamps to allow for horizontal scale-out within the region.&nbsp;</p>
<p><img decoding="async" loading="lazy" alt="Cloud Design - Deployment Stamps" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatternsDeploymentStamps-9cecdf26e6ffd5d2c505d7b35df121ae.gif" width="1903" height="1005" class="img_ev3q"></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="issues--considerations-13">Issues &amp; considerations<a href="https://luke.geek.nz/azure/cloud-design-patterns/#issues--considerations-13" class="hash-link" aria-label="Direct link to Issues &amp; considerations" title="Direct link to Issues &amp; considerations">‚Äã</a></h5>
<p>Several issues and considerations need to be addressed when implementing the deployment stamp pattern to ensure a successful deployment.</p>
<ul>
<li>Deployment Process - It's crucial to have automated and fully repeatable deployment processes. Tools like Bicep, JSON ARM templates, or Terraform modules can be used to declaratively define your stamps and keep the definitions consistent</li>
<li>Cross-Stamp Operations - When your solution is deployed across multiple stamps, operations that span multiple stamps, such as aggregating customer data, can become complex. Queries might need to be executed against each stamp, and the results aggregated. Alternatively, consider having all stamps publish data into a centralized data warehouse for consolidated reporting</li>
<li>Determining Scale-Out Policies - Stamps have a finite capacity, which might be defined using a proxy metric such as the number of tenants that can be deployed to the stamp. It's important to monitor the available and used capacity for each stamp and proactively deploy additional stamps to accommodate new tenants</li>
<li>Minimum Number of Stamps - It's advisable to deploy at least two stamps of your solution to avoid hard-coding assumptions in your code or configuration that won't apply when you scale out</li>
<li>Cost - Deploying multiple copies of your infrastructure components will likely involve a substantial increase in the cost of operating your solution. This includes the cost of additional memory, compute, and other resources required for each stamp2&nbsp;</li>
<li>Moving Between Stamps - Each stamp is deployed and operated independently, so moving tenants between stamps can be difficult. Custom logic is needed to transmit customer information to a different stamp and remove it from the original stamp. This process might require a backplane for communication between stamps, further increasing the complexity of the solution</li>
<li>Traffic Routing - Routing traffic to the correct stamp for a given request can require an additional component to resolve tenants to stamps. This component needs to be highly available to ensure reliable traffic routing</li>
<li>Shared Components - Some components might be shared across stamps. For example, a shared single-page app for all tenants could be deployed in one region and replicated globally using Azure CDN</li>
<li>Geographical Distribution - For multi-region applications, each tenant's data and traffic should be directed to a specific region. This ensures that requests are routed to the correct stamp based on the user's geographical location</li>
<li>Resiliency During Outages - Stamps are independent of one another, so if an outage affects a single stamp, tenants deployed to other stamps should not be affected. This isolation helps to contain the 'blast radius' of an incident or outage</li>
<li>Handling Single and Multi-Tenant Instances - The pattern should support both single and multi-tenant instances, ensuring that each tenant's data is isolated and secure</li>
<li>Update Frequency ‚Äî Different stamps might need to be on different versions of your solution at the same time. This requires careful management of updates and version control across stamps. By considering these issues and implementing appropriate strategies, the Deployment Stamp pattern can effectively improve the scalability, resiliency, and manageability of your solution.</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="when-to-use-this-pattern-9">When to use this pattern<a href="https://luke.geek.nz/azure/cloud-design-patterns/#when-to-use-this-pattern-9" class="hash-link" aria-label="Direct link to When to use this pattern" title="Direct link to When to use this pattern">‚Äã</a></h5>
<p>The Deployment Stamp pattern is useful in the following scenarios</p>
<ul>
<li>Natural Limits on Scalability - If certain components of your system cannot or should not scale beyond a specific number of customers or requests, the Deployment Stamp pattern allows you to scale out by deploying multiple instances (stamps) of your solution</li>
<li>Tenant Isolation - When there is a requirement to separate certain tenants from others due to security concerns or compliance requirements, the Deployment Stamp pattern can be used to deploy these tenants onto their own isolated stamps</li>
<li>Multi-Region Applications - For applications that need to be deployed across multiple regions, each tenant's data and traffic can be directed to a specific region. This ensures that requests are routed to the correct stamp based on the user's geographical location</li>
<li>Resiliency During Outages - Stamps are independent of one another, so if an outage affects a single stamp, tenants deployed to other stamps should not be affected. This isolation helps to contain the 'blast radius' of an incident or outage, enhancing the overall resiliency of the application</li>
<li>Different Versions of the Solution - If there is a need to have some tenants on different versions of your solution at the same time, the Deployment Stamp pattern allows for this flexibility by deploying different stamps with different versions</li>
<li>High-Scale Platforms ‚Äî The pattern is suitable for implementing high-scale platforms with users distributed over a wide area. It helps manage the load and ensure that the system can handle a large number of users efficiently. By using the Deployment Stamp pattern in these scenarios, you can achieve better scalability, isolation, and resiliency for your application.</li>
</ul>
<!-- -->
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="azure-solutions-13">Azure Solutions<a href="https://luke.geek.nz/azure/cloud-design-patterns/#azure-solutions-13" class="hash-link" aria-label="Direct link to Azure Solutions" title="Direct link to Azure Solutions">‚Äã</a></h5>
<p>Azure resources that can be used to implement this pattern include <a href="https://learn.microsoft.com/azure/traffic-manager/traffic-manager-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Traffic Manager</a>, <a href="https://learn.microsoft.com/azure/frontdoor/front-door-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Front Door</a>.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-bulkhead">üö¢ Bulkhead<a href="https://luke.geek.nz/azure/cloud-design-patterns/#-bulkhead" class="hash-link" aria-label="Direct link to üö¢ Bulkhead" title="Direct link to üö¢ Bulkhead">‚Äã</a></h4>
<blockquote>
<p>In a bulkhead architecture, elements of an application are isolated into pools so that if one fails, the others will continue to function.</p>
</blockquote>
<p>The Bulkhead pattern is a type of application design that is tolerant of failure. In a bulkhead architecture, elements of an application are isolated into pools so that if one fails, the others will continue to function. It's named after the sectioned partitions (bulkheads) of a ship's hull. If the hull of a ship is compromised, only the damaged section fills with water, which prevents the ship from sinking. A cloud-based application may include multiple services, with each service having one or more consumers. Excessive load or failure in a service will impact all consumers of the service. Partition service instances into different groups, based on consumer load and availability requirements. This design helps to isolate failures and allows you to sustain service functionality for some consumers, even during a failure.</p>
<p>The Bulkhead pattern and the Deployment Stamp pattern are both architectural patterns used to improve the resiliency and scalability of applications, but they address different concerns and are implemented in different ways, for example, the Deployment Stamp isolates entire instances of applications, each with its own services, the bulkhead partner isolates different components or services within the same application or system and is primarily focuses on fault isolation and resource management within a single deployment. These patterns can work together for a highly resistant solution.</p>
<p><img decoding="async" loading="lazy" alt="Cloud Design Patterns - Bulkhead" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatternsBulkhead-907d6c3dd459dc9c800821acd5b027c7.gif" width="1903" height="1005" class="img_ev3q"></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="issues--considerations-14">Issues &amp; considerations<a href="https://luke.geek.nz/azure/cloud-design-patterns/#issues--considerations-14" class="hash-link" aria-label="Direct link to Issues &amp; considerations" title="Direct link to Issues &amp; considerations">‚Äã</a></h5>
<p>The Bulkhead pattern is designed to improve the resiliency of an application by isolating different parts of the system to prevent a failure in one part from cascading to others. Here are the key issues and considerations when implementing the Bulkhead pattern
Issues</p>
<ul>
<li>Resource Exhaustion - If a service or consumer fails or becomes misconfigured, it can exhaust resources such as connection pools, memory, or CPU. This can prevent other services or consumers from functioning properly.</li>
<li>Cascading Failures - Without isolation, a failure in one service can lead to cascading failures, affecting the entire system. This can happen if a single service consumes all available resources, leaving none for other services.</li>
<li>Complexity - Implementing the Bulkhead pattern adds complexity to the system. It requires careful planning and management of resource allocation and isolation.</li>
<li>Less Efficient Use of Resources - Isolating resources for different services or consumers can lead to less efficient use of resources. For example, some resources might remain underutilized while others are overutilized
Considerations</li>
<li>Partitioning Services and Consumers ‚Äî Services and consumers should be divided into different groups based on load and availability requirements. This helps isolate failures and maintain service functionality for some consumers even during a failure.</li>
<li>Resource Allocation - Allocate separate resources (e.g., connection pools, memory) for each service or consumer. This ensures that a failure in one service does not affect the resources available to other services.</li>
<li>Granularity of Bulkheads - Determine the appropriate level of granularity for bulkheads. For example, you could isolate resources at the service level, consumer level, or even at the tenant level.</li>
<li>Combining with Other Patterns - Consider combining the Bulkhead pattern with other fault-handling patterns such as retry, circuit breaker, and throttling to provide more sophisticated fault handling.</li>
<li>Technology Overhead - Evaluate the overhead in terms of cost, performance, and manageability when partitioning services or consumers into bulkheads. For example, using containers can offer a good balance of resource isolation with fairly low overhead.</li>
<li>Monitoring and SLA - Monitor the performance and SLA of each partition to ensure that the isolation is effective and that resources are being used efficiently.</li>
<li>Critical vs. Standard Consumers - Isolate critical consumers from standard consumers to ensure that critical operations can continue even if standard operations fail.</li>
<li>Security‚ÄîThe segmentation between components helps constrain security incidents to the compromised bulkhead, enhancing the overall security of the system. By addressing these issues and considerations, the Bulkhead pattern can help improve the resiliency and reliability of your application, ensuring that failures are contained and do not affect the entire system.</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="when-to-use-this-pattern-10">When to use this pattern<a href="https://luke.geek.nz/azure/cloud-design-patterns/#when-to-use-this-pattern-10" class="hash-link" aria-label="Direct link to When to use this pattern" title="Direct link to When to use this pattern">‚Äã</a></h5>
<p>The Bulkhead pattern is particularly useful in the following scenarios</p>
<ul>
<li>Isolating Resources for Backend Services - Use the Bulkhead pattern to isolate resources used to consume a set of backend services. This is especially important if the application can provide some level of functionality even when one of the services is not responding</li>
<li>Isolating Critical Consumers from Standard Consumers - Implement the Bulkhead pattern to isolate critical consumers from standard consumers. This ensures that critical operations can continue even if standard operations fail</li>
<li>Protecting the Application from Cascading Failures - The Bulkhead pattern helps protect the application from cascading failures. By isolating different parts of the system, a failure in one part does not affect the entire system</li>
<li>Handling Resource Exhaustion - When a service or consumer fails or becomes misconfigured, it can exhaust resources such as connection pools, memory, or CPU. The Bulkhead pattern helps to prevent this by isolating resources for different services or consumers</li>
<li>Maintaining Service Functionality During Failures - The Bulkhead pattern allows you to sustain service functionality for some consumers even during a failure. By partitioning service instances into different groups based on consumer load and availability requirements, you can isolate failures and maintain service functionality</li>
<li>Combining with Other Fault-Handling Patterns - Consider combining the Bulkhead pattern with other fault-handling patterns such as retry, circuit breaker, and throttling to provide more sophisticated fault-handling</li>
<li>Deploying Services with Different Quality of Service - The Bulkhead pattern allows you to deploy services that offer a different quality of service for consuming applications. For example, a high-priority consumer pool can be configured to use high-priority services. By using the Bulkhead pattern in these scenarios, you can improve the resiliency and reliability of your application, ensuring that failures are contained and do not affect the entire system.</li>
</ul>
<!-- -->
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="azure-solutions-14">Azure Solutions<a href="https://luke.geek.nz/azure/cloud-design-patterns/#azure-solutions-14" class="hash-link" aria-label="Direct link to Azure Solutions" title="Direct link to Azure Solutions">‚Äã</a></h5>
<p>Azure resources that can be used to implement this pattern include <a href="https://learn.microsoft.com/azure/aks/intro-kubernetes?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Kubernetes Service (AKS)</a>, <a href="https://learn.microsoft.com/azure/container-instances/container-instances-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Container Instances</a>, and <a href="https://learn.microsoft.com/azure/azure-functions/functions-overview?pivots=programming-language-csharp&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Functions</a>.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-compensating-transaction">üòä Compensating Transaction<a href="https://luke.geek.nz/azure/cloud-design-patterns/#-compensating-transaction" class="hash-link" aria-label="Direct link to üòä Compensating Transaction" title="Direct link to üòä Compensating Transaction">‚Äã</a></h4>
<blockquote>
<p>If one or more of the steps fail, you can use the Compensating Transaction pattern to undo the work that the steps performed.</p>
</blockquote>
<p>When you use an eventually consistent operation that consists of a series of steps, the Compensating Transaction pattern can be useful. Specifically, if one or more of the steps fail, you can use the Compensating Transaction pattern to undo the work that the steps performed. Typically, you find operations that follow the eventual consistency model in cloud-hosted applications that implement complex business processes and workflows. Applications that run in the cloud frequently modify data. This data is sometimes spread across various data sources in different geographic locations. To avoid contention and improve performance in a distributed environment, an application shouldn't try to provide strong transactional consistency. Rather, the application should implement eventual consistency. In the eventual consistency model, a typical business operation consists of a series of separate steps. While the operation performs these steps, the overall view of the system state might be inconsistent. But when the operation finishes and all the steps have run, the system should become consistent again. The data that are affected by an operation that implements eventual consistency isn't always held in a database. For example, consider a service-oriented architecture (SOA) environment. An SOA operation can invoke an action in a service and cause a change in the state that's held by that service.</p>
<p>To undo the operation, you also have to undo this state change. This process can involve invoking the service again and performing another action that reverses the effects of the first.</p>
<p>The solution is to implement a compensating transaction. The steps in a compensating transaction undo the effects of the steps in the original operation. An intuitive approach is to replace the current state with the state the system was in at the start of the operation. But a compensating transaction can't always take that approach, because it might overwrite changes that other concurrent instances of an application have made. Instead, a compensating transaction must be an intelligent process that takes into account any work that concurrent instances do. This process is usually application-specific, driven by the nature of the work that the original operation performs.</p>
<p><img decoding="async" loading="lazy" alt="Cloud Design Pattern - Compensating Transaction" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatterns_CompensatingTransaction-6c8294a1cc7c89f819698e941e108ed6.gif" width="1903" height="1005" class="img_ev3q"></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="issues--considerations-15">Issues &amp; considerations<a href="https://luke.geek.nz/azure/cloud-design-patterns/#issues--considerations-15" class="hash-link" aria-label="Direct link to Issues &amp; considerations" title="Direct link to Issues &amp; considerations">‚Äã</a></h5>
<p>When implementing the Compensating Transaction pattern, there are several issues and considerations to keep in mind</p>
<ul>
<li>Determining Failure - It might not be easy to determine when a step in an operation that implements eventual consistency fails. A step might not fail immediately but could get blocked. Implementing a time-out mechanism can help identify such failures</li>
<li>Complexity of Compensation Logic - Compensation logic is often application-specific and relies on the application having sufficient information to undo the effects of each step in a failed operation. Generalizing this logic can be challenging</li>
<li>Idempotency - Define the steps in a compensating transaction as idempotent commands. This ensures that the steps can be repeated if the compensating transaction itself fails, which is crucial for maintaining consistency</li>
<li>Resilience and Reliability - The infrastructure handling the steps must be resilient both in the original operation and in the compensating transaction. It should not lose the information required to compensate for a failing step and must reliably monitor the progress of the compensation logic</li>
<li>State Restoration - A compensating transaction doesn't necessarily return the system data to its state at the start of the original operation. Instead, it compensates for the work that the operation completed successfully before it failed</li>
<li>Order of Steps - The order of the steps in the compensating transaction isn't necessarily the exact opposite of the steps in the original operation. For example, one data store might be more sensitive to inconsistencies than another, so the steps that undo changes to this store should occur first</li>
<li>Concurrency and Parallelism - It might be possible to perform some of the undo steps in parallel, depending on how the compensating logic is designed for each step. This can help speed up the compensation process</li>
<li>Manual Intervention - In some cases, manual intervention might be the only way to recover from a step that has failed. The system should raise an alert and provide as much information as possible about the reason for the failure</li>
<li>Resource Locking - To increase the likelihood of overall activity success, you can place a short-term, time-out‚Äìbased lock on each resource required to complete an operation. Obtain these resources in advance and perform the work only after acquiring all the resources, finalizing all actions before the locks expire</li>
<li>Retry Logic - Implement retry logic that is more forgiving than usual to minimize failures that trigger a compensating transaction. If a step in an operation fails, handle the failure as a transient exception and repeat the step. Stop the operation and initiate a compensating transaction only if a step fails repeatedly or can't be recovered. By considering these issues and implementing appropriate strategies, you can effectively manage the complexities associated with compensating transactions and ensure the reliability and consistency of your application.</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="when-to-use-this-pattern-11">When to use this pattern<a href="https://luke.geek.nz/azure/cloud-design-patterns/#when-to-use-this-pattern-11" class="hash-link" aria-label="Direct link to When to use this pattern" title="Direct link to When to use this pattern">‚Äã</a></h5>
<p>The Compensating Transaction pattern should be used in the following scenarios.</p>
<ul>
<li>Undoing Operations in Eventual Consistency Models - Use this pattern to undo operations that implement the eventual consistency model. This is particularly useful when you need to maintain data consistency across distributed systems</li>
<li>Handling Failures in Long-Running Transactions - When dealing with long-running transactions that involve multiple steps, the Compensating Transaction pattern can be used to undo the effects of each step if the transaction fails at any point. This ensures that the system can recover gracefully from failures</li>
<li>Ensuring Reliability and Resilience - Implement this pattern to address malfunctions in critical workload paths by rolling back data changes, breaking transaction locks, or executing native system behavior to reverse the effect. This helps make the workload resilient to malfunctions and ensures it recovers to a fully functioning state after a failure</li>
<li>Complex Business Processes and Workflows - Use the Compensating Transaction pattern in cloud-hosted applications that implement complex business processes and workflows. This pattern helps in managing eventual consistency and ensuring that the system can handle failures effectively</li>
<li>Avoiding the Complexity of Distributed Transactions - When it is not feasible to use distributed transactions due to their complexity and overhead, the Compensating Transaction pattern can be an alternative. It allows you to break down a distributed transaction into separate, compensable tasks</li>
<li>Handling State Changes in Service-Oriented Architectures (SOA) - In an SOA environment, where operations can cause changes in the state held by services, the Compensating Transaction pattern can be used to undo these state changes if necessary</li>
<li>Manual Intervention and Recovery - In cases where manual intervention might be required to recover from a failed step, the Compensating Transaction pattern can be used to raise alerts and provide information about the failure, allowing for manual recovery actions using the Compensating Transaction pattern in these scenarios, you can ensure that your system can handle failures gracefully, maintain data consistency, and recover from errors effectively.</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="azure-solutions-15">Azure Solutions<a href="https://luke.geek.nz/azure/cloud-design-patterns/#azure-solutions-15" class="hash-link" aria-label="Direct link to Azure Solutions" title="Direct link to Azure Solutions">‚Äã</a></h5>
<p>Customers use a travel website to book itineraries. A single itinerary might consist of a series of flights and hotels. A customer who travels from Seattle to London and then on to Paris might perform the following steps when creating an itinerary:</p>
<ol>
<li>Book a seat on flight F1 from Seattle to London.</li>
<li>Book a seat on flight F2 from London to Paris.
3 Book a seat on flight F3 from Paris to Seattle.</li>
<li>Reserve a room at Hotel H1 in London.</li>
<li>Reserve a room at Hotel H2 in Paris.</li>
</ol>
<p>These steps constitute an eventually consistent operation, although each step is a separate action. In addition to performing these steps, the system must also record the counter operations for undoing each step. This information is needed in case the customer cancels the itinerary. The steps necessary to perform the counter operations can then run as a compensating transaction.</p>
<p>In many business solutions, failure of a single step doesn't always necessitate rolling back the system by using a compensating transaction. For example, consider the travel website scenario. Suppose the customer books flights F1, F2, and F3 but can't reserve a room at Hotel H1. It's preferable to offer the customer a room at a different hotel in the same city rather than canceling the flights. The customer can still decide to cancel. In that case, the compensating transaction runs and undoes the bookings for flights F1, F2, and F3. But the customer should make this decision, not the system.</p>
<p>Azure resources that can be used to implement this pattern include <a href="https://learn.microsoft.com/azure/azure-functions/functions-overview?pivots=programming-language-csharp&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Functions</a>, <a href="https://learn.microsoft.com/azure/logic-apps/logic-apps-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Logic Apps</a>, and <a href="https://learn.microsoft.com/azure/service-bus-messaging/service-bus-messaging-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Service Bus</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="security-patterns">Security Patterns<a href="https://luke.geek.nz/azure/cloud-design-patterns/#security-patterns" class="hash-link" aria-label="Direct link to Security Patterns" title="Direct link to Security Patterns">‚Äã</a></h3>
<p><img decoding="async" loading="lazy" alt="Security Patterns" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatterns_Security-9a83139c43344330ae46f562128457f2.PNG" width="4000" height="2250" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-backends-for-frontends">üòä Backends for Frontends<a href="https://luke.geek.nz/azure/cloud-design-patterns/#-backends-for-frontends" class="hash-link" aria-label="Direct link to üòä Backends for Frontends" title="Direct link to üòä Backends for Frontends">‚Äã</a></h4>
<blockquote>
<p>Create separate backend services to be consumed by specific frontend applications or interfaces.</p>
</blockquote>
<p>The Backends for Frontends (BFF) pattern involves creating separate backend services tailored to specific frontend applications or interfaces. This pattern is particularly useful when you want to avoid customizing a single backend for multiple interfaces, which can lead to conflicting requirements and development bottlenecks. An application may initially target a desktop web UI, with a backend service developed to support it. As the user base grows, a mobile application might be developed that needs to interact with the same backend. However, the capabilities and requirements of mobile devices differ significantly from desktop browsers, leading to competing requirements for the backend. An application may initially target a desktop web UI, with a backend service developed to support it. As the user base grows, a mobile application might be developed that needs to interact with the same backend. However, the capabilities and requirements of mobile devices differ significantly from desktop browsers, leading to competing requirements for the backend</p>
<p><img decoding="async" loading="lazy" alt="Cloud Design Pattern - Backends for Frontends" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatterns_BackendsForFrontEnds-47133a5cf1a841b794d2d81dfd40c7d1.gif" width="1903" height="1005" class="img_ev3q"></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="issues--considerations-16">Issues &amp; considerations<a href="https://luke.geek.nz/azure/cloud-design-patterns/#issues--considerations-16" class="hash-link" aria-label="Direct link to Issues &amp; considerations" title="Direct link to Issues &amp; considerations">‚Äã</a></h5>
<p>When implementing the Backends for Frontends (BFF) pattern, there are several issues and considerations to keep in mind
&nbsp;</p>
<ul>
<li>Competing Requirements - Different frontends (e.g., desktop web UI and mobile applications) have varying requirements in terms of screen size, performance, and display limitations. These differences can lead to competing requirements for the backend, making it challenging to serve both interfaces effectively</li>
<li>Development Bottlenecks - The backend can become a bottleneck in the development process due to the need to accommodate conflicting update requirements from different front-end teams. This can result in significant effort being spent on maintaining a single deployable resource that serves multiple frontends</li>
<li>Complexity in Maintenance - Maintaining separate backends for each frontend can increase the complexity of the system. Each backend needs to be updated and maintained independently, which can lead to increased operational overhead
Considerations</li>
<li>Segmentation and Isolation - The BFF pattern introduces segmentation and isolation by creating separate backend services for each frontend. This reduces the surface area of the API and limits lateral movement among different backends, which might expose different capabilities</li>
<li>Tailored Security and Authorization - The separation allows for tailored security and authorization mechanisms for each front end. This ensures that the security requirements for each frontend are addressed effectively, potentially reducing the surface area of an API</li>
<li>Optimized Interfaces - By creating separate backends for each client, you can expose an optimal interface for that client. This allows for different payload sizes or interaction patterns that are specific to the needs of each front, improving performance and user experience</li>
<li>Reduced Attack Surface - The BFF pattern reduces the attack surface by limiting the functionality exposed by each backend to only what is necessary for its corresponding front end. This minimizes the potential for security vulnerabilities</li>
<li>Enhanced Monitoring and Control - The separation of backends allows for more granular monitoring and control over each service. Security incidents can be contained within the specific backend, reducing the blast radius of any potential compromise</li>
<li>Compliance and Regulatory Requirements - Different frontends might have different compliance and regulatory requirements. The BFF pattern allows for these requirements to be addressed individually, ensuring that each backend complies with the necessary standards By considering these issues and implementing appropriate strategies, you can effectively manage the complexities associated with the Backends for Frontends pattern and ensure the reliability, security, and performance of your application.</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="when-to-use-this-pattern-12">When to use this pattern<a href="https://luke.geek.nz/azure/cloud-design-patterns/#when-to-use-this-pattern-12" class="hash-link" aria-label="Direct link to When to use this pattern" title="Direct link to When to use this pattern">‚Äã</a></h5>
<p>The Backends for Frontends (BFF) pattern should be used in the following scenarios.</p>
<ul>
<li>Different Client Requirements - When different types of clients, such as mobile applications and desktop web browsers, require different payload sizes or interaction patterns, the BFF pattern is useful. It allows you to create separate backends for each client, which exposes an optimal interface for that client</li>
<li>Avoiding Backend Bottlenecks - If the backend service becomes a bottleneck due to conflicting update requirements from different frontend teams, the BFF pattern can help. By creating separate backend services for each frontend, you can reduce the effort spent on maintaining a single deployable resource that serves multiple frontends</li>
<li>Competing Requirements - When the capabilities of different frontends (e.g., mobile devices vs. desktop browsers) differ significantly, leading to competing requirements for the backend, the BFF pattern can address these differences. It allows each backend to be optimized for the specific needs of its corresponding frontend</li>
<li>Security and Authorization - The BFF pattern is beneficial when you need to tailor security and authorization mechanisms for each front end. By individualizing the service layer for each front, you can reduce the surface area of the API and limit lateral movement among different backends, which might expose different capabilities</li>
<li>Optimized Interfaces - When you need to expose an optimal interface for each client, the BFF pattern is appropriate. This allows for different payload sizes or interaction patterns that are specific to the needs of each frontend, improving performance and user experience. Using the Backends for Frontends pattern in these scenarios, you can effectively manage the complexities associated with serving multiple frontends, ensure optimal performance, and enhance the security of your application.</li>
</ul>
<!-- -->
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="azure-solutions-16">Azure Solutions<a href="https://luke.geek.nz/azure/cloud-design-patterns/#azure-solutions-16" class="hash-link" aria-label="Direct link to Azure Solutions" title="Direct link to Azure Solutions">‚Äã</a></h5>
<p>Azure resources that can be used to implement this pattern include <a href="https://learn.microsoft.com/azure/api-management/api-management-key-concepts?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure API Management</a>, <a href="https://learn.microsoft.com/azure/application-gateway/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Application Gateway</a>, <a href="https://learn.microsoft.com/azure/app-service/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">App Service</a>.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-gatekeeper">üöß Gatekeeper<a href="https://luke.geek.nz/azure/cloud-design-patterns/#-gatekeeper" class="hash-link" aria-label="Direct link to üöß Gatekeeper" title="Direct link to üöß Gatekeeper">‚Äã</a></h4>
<blockquote>
<p>Protect applications and services by using a dedicated host instance to broker requests between clients and the application or service.</p>
</blockquote>
<p>Cloud services expose endpoints that allow client applications to call their APIs. The code used to implement the APIs triggers or performs several tasks, including but not limited to authentication, authorization, parameter validation, and some or all request processing. The API code is likely to access storage and other services on behalf of the client.
If a malicious user compromises the system and gains access to the application's hosting environment, its security mechanisms and access to data and other services are exposed. As a result, the malicious user can gain unrestricted access to credentials, storage keys, sensitive information, and other services.</p>
<p>The GateKeeper patterns allow you to protect applications and services by using a dedicated host instance to broker requests between clients and the application or service. The broker validates and sanitizes the requests, and can provide an additional layer of security and limit the system's attack surface.</p>
<p><img decoding="async" loading="lazy" alt="Cloud Design Pattern - Gatekeeper" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatterns_Gatekeeper-dfdbd58457930fd19f00df9155c09beb.gif" width="1903" height="1005" class="img_ev3q"></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="issues--considerations-17">Issues &amp; considerations<a href="https://luke.geek.nz/azure/cloud-design-patterns/#issues--considerations-17" class="hash-link" aria-label="Direct link to Issues &amp; considerations" title="Direct link to Issues &amp; considerations">‚Äã</a></h5>
<p>The Gatekeeper pattern is a design pattern used to protect applications and services by acting as an intermediary that validates and sanitizes requests before passing them to the trusted host. Here are the key issues and considerations when implementing this pattern
&nbsp;</p>
<ul>
<li>Single Point of Failure - The gatekeeper instance could become a single point of failure. If the gatekeeper fails, it can disrupt the entire system. To mitigate this, consider deploying redundant instances and using an autoscaling mechanism to ensure capacity and maintain availability</li>
<li>Performance Impact - Adding the gatekeeper layer introduces additional processing and network communication, which can impact the overall performance of the system. This additional latency needs to be considered, especially for performance-critical applications</li>
<li>Complexity in Implementation - Implementing the gatekeeper pattern adds complexity to the system architecture. It requires careful design to ensure that the gatekeeper effectively validates and sanitizes requests without becoming a bottleneck or introducing new vulnerabilities
Considerations
&nbsp;</li>
<li>Controlled Validation - The gatekeeper should validate all incoming requests and reject those that do not meet the validation requirements. This helps in ensuring that only legitimate requests are processed by the trusted host</li>
<li>Limited Risk and Exposure - The gatekeeper should not have access to the credentials or keys used by the trusted host to access storage and services. This limits the risk and exposure in case the gatekeeper is compromised, as the attacker would not gain access to these sensitive credentials or keys</li>
<li>Appropriate Security - The gatekeeper should run in a limited privilege mode, while the rest of the application runs in full trust mode required to access storage and services. This ensures that even if the gatekeeper is compromised, it cannot directly access the application services or data</li>
<li>Secure Communication - Use secure communication channels (e.g., HTTPS, SSL, or TLS) between the gatekeeper and the trusted hosts or tasks. This helps protect the data in transit and ensures that the communication between the gatekeeper and the trusted hosts is secure</li>
<li>Internal or Protected Endpoints - Ensure that the trusted hosts expose only internal or protected endpoints that are used exclusively by the gatekeeper. The trusted hosts should not expose any external endpoints or interfaces to minimize the attack surface</li>
<li>Redundant Instances - To minimize the impact of a failure, deploy redundant instances of the gatekeeper and use an autoscaling mechanism to ensure that there is always sufficient capacity to handle incoming requests</li>
<li>Separation of Concerns - The gatekeeper should not perform any processing related to the application or services or access any data. Its function should be purely to validate and sanitize requests. The trusted hosts might need to perform additional request validation, but the core validation should be done by the gatekeeper. By considering these issues and implementing appropriate strategies, you can effectively manage the complexities associated with the Gatekeeper pattern and ensure the reliability, security, and performance of your application.</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="when-to-use-this-pattern-13">When to use this pattern<a href="https://luke.geek.nz/azure/cloud-design-patterns/#when-to-use-this-pattern-13" class="hash-link" aria-label="Direct link to When to use this pattern" title="Direct link to When to use this pattern">‚Äã</a></h5>
<p>The Gatekeeper pattern should be used in the following scenarios.</p>
<ul>
<li>Handling Sensitive Information - When your application handles sensitive information that requires a high degree of protection from malicious attacks, the Gatekeeper pattern is beneficial. It acts as an intermediary that validates and sanitizes requests before they reach the trusted host, thereby protecting sensitive data</li>
<li>High-Security Requirements - If your application exposes services that require robust security measures, such as web application firewalls, DDoS protection, bot detection, and centralized authentication and authorization checks, the Gatekeeper pattern can centralize these security functionalities</li>
<li>Mission-Critical Operations - For applications that perform mission-critical operations that cannot be disrupted, the Gatekeeper pattern ensures that only validated and sanitized requests are processed, reducing the risk of malicious attacks and system failures</li>
<li>Separate Request Validation - When there is a need to perform request validation separately from the main tasks or to centralize this validation to simplify maintenance and administration, the Gatekeeper pattern is appropriate. It ensures that the core validation is done by the gatekeeper, while the trusted hosts might perform additional validation</li>
<li>Reducing Attack Surface - The Gatekeeper pattern is useful when you want to reduce the attack surface of your system. By decoupling the public endpoints from the code that processes requests and accesses storage, the gatekeeper can provide an additional layer of security and limit the system's exposure to potential attacks</li>
<li>Secure Communication - When secure communication between clients and the application or service is required, the Gatekeeper pattern can be implemented using secure communication channels (e.g., HTTPS, SSL, or TLS) between the gatekeeper and the trusted hosts or tasks</li>
<li>Redundancy and Availability - In scenarios where high availability is crucial, deploying redundant instances of the gatekeeper and using an autoscaling mechanism can ensure that there is always sufficient capacity to handle incoming requests, minimizing the impact of a failure using the Gatekeeper pattern in these scenarios, you can enhance the security, reliability, and performance of your application, ensuring that it meets the necessary protection and operational requirements.</li>
</ul>
<!-- -->
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="azure-solutions-17">Azure Solutions<a href="https://luke.geek.nz/azure/cloud-design-patterns/#azure-solutions-17" class="hash-link" aria-label="Direct link to Azure Solutions" title="Direct link to Azure Solutions">‚Äã</a></h5>
<p>The Azure resources that can be used to implement this pattern include <a href="https://learn.microsoft.com/azure/application-gateway/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Application Gateway</a> and <a href="https://learn.microsoft.com/azure/firewall/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Firewall</a>.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-federated-identity">ü§ù Federated Identity<a href="https://luke.geek.nz/azure/cloud-design-patterns/#-federated-identity" class="hash-link" aria-label="Direct link to ü§ù Federated Identity" title="Direct link to ü§ù Federated Identity">‚Äã</a></h4>
<blockquote>
<p>Delegate authentication to an external identity provider. This can simplify development, minimize the requirement for user administration, and improve the user experience of the application.</p>
</blockquote>
<p>Users typically need to work with multiple applications provided and hosted by different organizations they have a business relationship with.</p>
<p>Implement an authentication mechanism that can use federated identity. Separate user authentication from the application code and delegate authentication to a trusted identity provider.</p>
<p>This model is often called claims-based access control. Applications and services authorize access to features and functionality based on the claims contained in the token. The service that requires authentication must trust the IdP. The client application contacts the IdP, which performs the authentication.</p>
<p>Federated authentication provides a standards-based solution to the issue of trusting identities across diverse domains,</p>
<p>This type of authentication is becoming more common across all types of applications, especially cloud-hosted applications because it supports single sign-on without requiring a direct network connection to identity providers. The user doesn't have to enter credentials for every application. This increases security because it prevents the creation of credentials required to access many different applications, and it also hides the user's credentials from all but the original identity provider. Applications see just the authenticated identity information contained within the token.</p>
<p><img decoding="async" loading="lazy" alt="Cloud Design Patterns - Federated Identity" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatterns_FederatedIdentity-5b9a27bec42e4de3f7e85841b2a0718e.gif" width="1903" height="1005" class="img_ev3q"></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="issues--considerations-18">Issues &amp; considerations<a href="https://luke.geek.nz/azure/cloud-design-patterns/#issues--considerations-18" class="hash-link" aria-label="Direct link to Issues &amp; considerations" title="Direct link to Issues &amp; considerations">‚Äã</a></h5>
<p>When implementing the Federated Identity pattern, there are several issues and considerations to keep in mind
Issues
&nbsp;</p>
<ul>
<li>Single Point of Failure - Authentication can become a single point of failure. If the identity provider (IdP) or the Security Token Service (STS) fails, it can disrupt access to all applications relying on it. To mitigate this, consider deploying your identity management mechanism across multiple data centers to maintain reliability and availability</li>
<li>Complexity in Implementation - Implementing federated identity can be complex, especially if retrofitting it into existing applications that were built using different authentication mechanisms. This complexity can make it less cost-effective and more challenging to manage</li>
<li>Performance Impact - The additional steps involved in federated authentication, such as token issuance and validation, can introduce latency. This performance impact needs to be considered, especially for applications requiring high responsiveness</li>
<li>Security Vulnerabilities - Federated identity can expose security vulnerabilities if not properly managed. For example, if a user leaves the company and their account is not immediately deprovisioned, it can lead to unauthorized access. Ensuring timely de-provisioning and robust security practices is crucial</li>
<li>Administrative Overhead - While federated identity can reduce the administrative overhead of managing user credentials within the application, it requires careful management of the relationship with the identity provider. This includes ensuring that the identity provider's security practices are robust and that the integration is maintained.
&nbsp;* Role-Based Access Control (RBAC) - Federated identity allows for the implementation of RBAC based on role claims contained in the authentication token. This provides a more granular level of control over access to features and resources within the application</li>
<li>Home Realm Discovery - If there are multiple identity providers configured, the STS must determine which identity provider the user should be redirected to for authentication. This process, known as home realm discovery, can be automated based on various factors such as email address, subdomain, IP address, or cookies</li>
<li>User Experience - Federated identity can improve the user experience by enabling single sign-on (SSO) across multiple applications. Users do not need to remember multiple credentials, which simplifies their interaction with the system and reduces the likelihood of forgotten passwords</li>
<li>Security and Compliance - Offloading user management and authentication to a trusted identity provider can enhance security by leveraging the provider's advanced capabilities for identity-based threat detection and prevention. This also helps in meeting compliance requirements without implementing these capabilities in the application itself</li>
<li>Business Continuity - Federated systems typically require a load-balanced array of servers to ensure high availability for authentication requests. This setup helps maintain business continuity by providing redundancy and failover capabilities</li>
<li>Integration with Third-Party Services - Federated identity is useful for integrating with third-party services and applications, especially in scenarios where multiple organizations need to collaborate. It allows users from different organizations to authenticate using their own credentials, simplifying access management. By considering these issues and implementing appropriate strategies, you can effectively manage the complexities associated with the Federated Identity pattern and ensure the reliability, security, and performance of your application.</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="when-to-use-this-pattern-14">When to use this pattern<a href="https://luke.geek.nz/azure/cloud-design-patterns/#when-to-use-this-pattern-14" class="hash-link" aria-label="Direct link to When to use this pattern" title="Direct link to When to use this pattern">‚Äã</a></h5>
<p>The Federated Identity pattern should be used in the following scenarios.</p>
<ul>
<li>Single Sign-On in the Enterprise - When you need to authenticate employees for corporate applications hosted in the cloud outside the corporate security boundary, without requiring them to sign in every time they visit an application. This provides a seamless user experience similar to on-premises applications where users authenticate once and gain access to all relevant applications</li>
<li>Federated Identity with Multiple Partners - When you need to authenticate both corporate employees and business partners who do not have accounts in the corporate directory. This is common in business-to-business applications, applications that integrate with third-party services, and scenarios where companies with different IT systems have merged or shared resources</li>
<li>SaaS Applications - For independent software vendors providing a ready-to-use service for multiple clients or tenants. Each tenant can authenticate using a suitable identity provider, such as corporate credentials for business users or social identity credentials for consumers and clients of the tenant</li>
<li>Improving User Experience - When users typically need to work with multiple applications provided and hosted by different organizations, federated identity can simplify the user experience by allowing them to use the same credentials across all applications. This reduces the likelihood of forgotten passwords and provides a more cohesive user experience</li>
<li>Reducing Administrative Overhead - When you want to minimize the administrative overhead of managing user credentials within the application. By delegating authentication to a trusted identity provider, you can simplify development and reduce the need for user administration tasks such as password reminders and account deprovisioning</li>
<li>Enhancing Security - When you need to enhance security by offloading user management and authentication to a trusted identity provider. This can provide advanced capabilities for identity-based threat detection and prevention and ensure that user credentials are managed securely</li>
<li>Supporting Claims-Based Access Control ‚Äî When you need to implement role-based access control (RBAC) based on role claims contained in the authentication token, this allows for a more granular level of control over access to features and resources within the application.</li>
</ul>
<!-- -->
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="azure-solutions-18">Azure Solutions<a href="https://luke.geek.nz/azure/cloud-design-patterns/#azure-solutions-18" class="hash-link" aria-label="Direct link to Azure Solutions" title="Direct link to Azure Solutions">‚Äã</a></h5>
<p>Azure services that can be used to implement this pattern include <a href="https://learn.microsoft.com/entra/fundamentals/whatis?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Microsoft Entra ID</a> and <a href="https://learn.microsoft.com/entra/external-id/external-identities-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Microsoft Entra ID External</a>.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-gateway-offloading">üõ°Ô∏è Gateway Offloading<a href="https://luke.geek.nz/azure/cloud-design-patterns/#%EF%B8%8F-gateway-offloading" class="hash-link" aria-label="Direct link to üõ°Ô∏è Gateway Offloading" title="Direct link to üõ°Ô∏è Gateway Offloading">‚Äã</a></h4>
<blockquote>
<p>Offload shared or specialized service functionality to a gateway proxy.</p>
</blockquote>
<p>This pattern can simplify application development by moving shared service functionality, such as the use of SSL certificates, from other parts of the application into the gateway. Offload some features into a gateway, particularly cross-cutting concerns such as certificate management, authentication, SSL termination, monitoring, protocol translation, or throttling.</p>
<p>It is similar to the Gatekeeper pattern, which focuses on protecting applications by validating and sanitizing requests, decoupling public endpoints from backend processing, and centralizing security functionalities to limit the system's attack surface.</p>
<p>The Gateway Offloading&nbsp;focuses on offloading cross-cutting concerns and shared functionalities to a gateway to simplify application development and maintenance, enhance security, and ensure consistency in logging and monitoring.</p>
<p><img decoding="async" loading="lazy" alt="Cloud Design - Gateway Offloading" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatterns_GatewayOffloading-ce8501ca20441af693abcb1fce2f0914.gif" width="1903" height="1005" class="img_ev3q"></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="issues--considerations-19">Issues &amp; considerations<a href="https://luke.geek.nz/azure/cloud-design-patterns/#issues--considerations-19" class="hash-link" aria-label="Direct link to Issues &amp; considerations" title="Direct link to Issues &amp; considerations">‚Äã</a></h5>
<p>When implementing the Gateway Offloading pattern, there are several issues and considerations to keep in mind</p>
<ul>
<li>Coupling Across Services - Introducing a gateway can create coupling across services, which might not be suitable for all architectures. This coupling can lead to dependencies that complicate the deployment and scaling of individual services</li>
<li>Single Point of Failure - The gateway itself can become a single point of failure if not properly managed. It is crucial to ensure that the gateway is highly available and resilient to failure by running multiple instances and designing it for the capacity and scaling requirements of the application</li>
<li>Performance Overhead - Offloading functionality to a gateway can introduce performance overhead. The gateway must be designed to handle the additional load without becoming a bottleneck for the application. This includes ensuring that the gateway can scale appropriately to meet the demands of the application</li>
<li>Security Management - Properly handling security issues such as token validation, encryption, and SSL certificate management requires specialized skills. The gateway must be configured and managed by a team with the necessary expertise to ensure that security is not compromised</li>
<li>Administrative Overhead - While offloading shared functionalities to a gateway can reduce administrative overhead in some areas, it can also introduce new administrative tasks. For example, managing and updating SSL certificates or other shared resources at the gateway level requires careful coordination and planning</li>
<li>Consistency in Logging and Monitoring - The gateway can provide consistency in request and response logging and monitoring. However, it is essential to ensure that the gateway is correctly instrumented to provide the necessary level of monitoring and logging, even if individual services are not</li>
<li>Specialized Features - Offloading specialized features such as authentication, authorization, logging, monitoring, or throttling to the gateway allows dedicated teams to manage these features. This can simplify the development and maintenance of the core application but requires coordination between teams to ensure that the offloaded features are correctly implemented and maintained</li>
<li>Business Logic - Business logic should never be offloaded to the gateway. The gateway should only handle cross-cutting concerns that are used by the entire application, such as security or data transfer. Offloading business logic can lead to a tightly coupled architecture that is difficult to maintain and scale. Considering these issues and carefully planning the implementation, you can effectively use the Gateway Offloading pattern to simplify application development, enhance security, and ensure consistency in logging and monitoring.</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="when-to-use-this-pattern-15">When to use this pattern<a href="https://luke.geek.nz/azure/cloud-design-patterns/#when-to-use-this-pattern-15" class="hash-link" aria-label="Direct link to When to use this pattern" title="Direct link to When to use this pattern">‚Äã</a></h5>
<p>The Gateway Offloading pattern should be used in the following scenarios.</p>
<ul>
<li>Shared or Specialized Service Functionality - When you need to offload shared or specialized service functionality, such as SSL certificate management, authentication, authorization, logging, monitoring, or throttling, to a gateway proxy. This can simplify application development by moving these cross-cutting concerns from other parts of the application into the gateway</li>
<li>Reducing Administrative Overhead - When managing shared features across multiple services increases administrative overhead and the likelihood of deployment errors. Offloading these features to a gateway can reduce the need to configure, manage, and maintain them across all services, simplifying updates and reducing the risk of errors</li>
<li>Centralized Security Management - When you need to handle complex security tasks such as token validation, encryption, and SSL certificate management. Offloading these tasks to a gateway allows dedicated teams with specialized skills to manage them, ensuring that security is not compromised</li>
<li>Consistency in Logging and Monitoring - When you want to ensure consistency in request and response logging and monitoring across services. The gateway can be configured to provide a minimum level of monitoring and logging, even if individual services are not correctly instrumented</li>
<li>High Availability and Resilience - When you need to ensure that the gateway is highly available and resilient to failure. Running multiple instances of the gateway and designing it for the capacity and scaling requirements of the application can help avoid single points of failure and ensure that the gateway does not become a bottleneck</li>
<li>Simplifying Configuration and Management - When you want to simplify the configuration and management of supporting resources, such as web server certificates and secure website configurations. Offloading these responsibilities to a gateway can make service upgrades simpler and more manageable</li>
<li>Specialized Team Management - When you want to allow dedicated teams to implement features that require specialized expertise, such as security. This allows your core team to focus on the application functionality, leaving these specialized but cross-cutting concerns to the relevant experts</li>
<li>Network Security and Attack Mitigation - When you need to mitigate attacks at the edge ensure that internet traffic routes only through the gateway, not directly to the workloads or PaaS services. The gateway should have the ability to mitigate exploits and provide network security. By considering these scenarios, you can determine whether the Gateway Offloading pattern is suitable for your application and ensure that it meets the necessary security, user experience, and administrative requirements.</li>
</ul>
<!-- -->
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="azure-solutions-19">Azure Solutions<a href="https://luke.geek.nz/azure/cloud-design-patterns/#azure-solutions-19" class="hash-link" aria-label="Direct link to Azure Solutions" title="Direct link to Azure Solutions">‚Äã</a></h5>
<p>Azure resources that can be used to implement this pattern include <a href="https://learn.microsoft.com/azure/frontdoor/front-door-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Front Door with WAF</a>, <a href="https://learn.microsoft.com/azure/application-gateway/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Application Gateway</a> and <a href="https://learn.microsoft.com/azure/firewall/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Firewall</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-architecting-for-azure">üèóÔ∏è Architecting for Azure<a href="https://luke.geek.nz/azure/cloud-design-patterns/#%EF%B8%8F-architecting-for-azure" class="hash-link" aria-label="Direct link to üèóÔ∏è Architecting for Azure" title="Direct link to üèóÔ∏è Architecting for Azure">‚Äã</a></h3>
<p>The following Frameworks can help guide you, from the business requirements to the technical implementation of your solution:</p>
<ol>
<li><a href="https://learn.microsoft.com/azure/cloud-adoption-framework/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Cloud Adoption Framework</a> - Proven guidance and best practices that help you confidently adopt the cloud and achieve business outcomes.</li>
<li><a href="https://learn.microsoft.com/azure/architecture/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Architecture Center</a> - Guidance for architecting solutions on Azure using established patterns and practices</li>
<li><a href="https://learn.microsoft.com/azure/architecture/patterns/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Cloud Design Patterns (part of Architecture Center)</a> - Design patterns are useful for building reliable, scalable, secure applications in the cloud.</li>
<li><a href="https://learn.microsoft.com/azure/well-architected/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Well-Architected Framework</a> - A set of quality-driven tenets, architectural decision points, and review tools intended to help solution architects build a technical foundation for their workloads.</li>
</ol>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>"Design patterns are important for reusability, efficiency, maintainability, consistency, performance, and modularity</p><p>Cloud design patterns are important for scalability, resilience, operational excellence, performance efficiency, and security
Categories of patterns include data management, security, reliability, messaging, and design &amp; implementation
Implementing patterns in Azure involves using the Cloud Adoption Framework, Well-Architected Framework, and Azure Architecture Center</p><p>Recap: Design patterns are important in modern cloud architecture and can be implemented in Azure using established frameworks and guidance to ensure scalability, resilience, and security."</p></div></div>
<p><img decoding="async" loading="lazy" alt="The time is now, go build!The time is now, go build!" src="https://luke.geek.nz/assets/images/Blog_CloudDesignPatterns_TimettoBuild-9b4a19c83b962127f6596c68a936f92d.PNG" width="4000" height="2250" class="img_ev3q"></p>]]></content:encoded>
            <category>Azure</category>
            <category>Misc</category>
            <category>Service Management</category>
        </item>
        <item>
            <title><![CDATA[Export Azure DevOps Repositories to Azure Storage Account]]></title>
            <link>https://luke.geek.nz/azure/export-azure-devops-repos-azure-storage-account/</link>
            <guid>https://luke.geek.nz/azure/export-azure-devops-repos-azure-storage-account/</guid>
            <pubDate>Mon, 13 May 2024 08:21:56 GMT</pubDate>
            <description><![CDATA[This is a step-by-step guide on exporting Azure DevOps repositories to an Azure Storage Account for backup and recovery.]]></description>
            <content:encoded><![CDATA[<p>When recently deleted, Azure DevOps code repositories go into a soft-delete state, any repositories deleted are retained for 30 days before they are permanently deleted.</p>
<p>For Disaster Recovery scenarios or scenarios where you may not realize something has been deleted until after Microsoft retains the backup, you may want to export the repositories at a single point in time to an Azure storage account.</p>
<p>The Azure DevOps service is highly redundant and built on core Azure Platform infrastructure components, such as Availability Zones and is built using Azure Cloud native Storage and Azure SQL services, which are highly redundant and backed-up.</p>
<p>However, mistakes can happen, and there may be organizational requirements to retain backups of the repositories.</p>
<p>Today, we will examine exporting your repositories to an Azure Storage Account using a DevOps pipeline. This pipeline will capture the repositories at their current state and run nightly.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-overview">üìö Overview<a href="https://luke.geek.nz/azure/export-azure-devops-repos-azure-storage-account/#-overview" class="hash-link" aria-label="Direct link to üìö Overview" title="Direct link to üìö Overview">‚Äã</a></h2>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>"You can recover deleted organizations or projects within the 28-day window following deletion. But, once this period elapses, these entities are permanently deleted and can't be restored. While these backups serve as a crucial component for disaster recovery, customers need to practice appropriate data management and backup strategies to ensure comprehensive data protection."</p><p>"Accidental deletion here refers to scenarios that arise as a result of an incident on our services. It doesn't include customers' accidental deletion of assets (for example, repositories, work items, attachments, or artifacts).</p><p><strong>We don't support restoring assets that customers accidentally delete. These backups are meant only for business continuity and to aid recovery from outages or disaster scenarios.</strong>"</p><p>Reference: <a href="https://learn.microsoft.com/en-us/azure/devops/organizations/security/data-protection?view=azure-devops&amp;WT.mc_id=AZ-MVP-5004796#mistakes-happen" target="_blank" rel="noopener noreferrer">Data protection - Mistakes Happen</a></p></div></div>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>Please remember that this backup will only export the repositories and pipelines, not the work items, pipeline variables, or other artifacts. This will also backup any code stored in Azure DevOps, so if secrets or other sensitive information are stored in the code, please ensure that these are not stored in the code or are encrypted, or they may be readable by someone with access to the storage account.</p></div></div>
<p>Today, we will run a PowerShell script with an Azure DevOps pipeline. The script will connect to the Azure DevOps API and grab the zip file of each Repository in all Projects into an artifact, which then gets exported and copied to an Azure Storage Account.</p>
<!-- -->
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-deployment">üöÄ Deployment<a href="https://luke.geek.nz/azure/export-azure-devops-repos-azure-storage-account/#-deployment" class="hash-link" aria-label="Direct link to üöÄ Deployment" title="Direct link to üöÄ Deployment">‚Äã</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-azure-storage-account">‚òÅÔ∏è Azure Storage Account<a href="https://luke.geek.nz/azure/export-azure-devops-repos-azure-storage-account/#%EF%B8%8F-azure-storage-account" class="hash-link" aria-label="Direct link to ‚òÅÔ∏è Azure Storage Account" title="Direct link to ‚òÅÔ∏è Azure Storage Account">‚Äã</a></h3>
<p>We will need to create an Azure Storage Account to store the exported repositories. We can point towards an already existing Storage Account and Container.</p>
<p>We will deploy the Storage account fresh using <a href="https://learn.microsoft.com/azure/azure-resource-manager/bicep/overview?tabs=bicep&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Bicep</a> to our existing Resource Group for this article.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>I will use the <a href="https://luke.geek.nz/azure/Azure-Bicep-Deploy-Pane/" target="_blank" rel="noopener noreferrer">Deployment Pane</a> to deploy the Storage Account straight from Visual Studio Code, running in a <a href="https://luke.geek.nz/azure/Getting-Started-with-GitHub-Codespaces/" target="_blank" rel="noopener noreferrer">Codespace</a>.</p></div></div>
<p>We will use <a href="https://learn.microsoft.com/azure/storage/blobs/lifecycle-management-policy-configure?tabs=azure-portal&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Lifecycle Management policies</a> to help control the retention of the exported repositories. We will move the repositories to Cool Storage after 30 days, Archive Storage after 90 days, and delete them after 120 days.</p>
<p><img decoding="async" loading="lazy" alt="Export ADO - Create Storage Account" src="https://luke.geek.nz/assets/images/Export_ADO_CreateStgAccount-169b0507885b17bde9569ed0ccccb95d.gif" width="1864" height="974" class="img_ev3q"></p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// Parameters for the script</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> storageAccountName </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Name of the storage account</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> location </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">resourceGroup</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">location </span><span class="token comment" style="color:rgb(98, 114, 164)">// Location of the storage account, default to the location of the resource group</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> containerName </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'adoexport'</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Name of the container</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Resource definition for the storage account</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> storageAccount </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.Storage/storageAccounts@2023-01-01'</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> storageAccountName </span><span class="token comment" style="color:rgb(98, 114, 164)">// Set the name of the storage account</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">location</span><span class="token operator">:</span><span class="token plain"> location </span><span class="token comment" style="color:rgb(98, 114, 164)">// Set the location of the storage account</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">sku</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Standard_LRS'</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Set the SKU to Standard_LRS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">kind</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'StorageV2'</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Set the kind to StorageV2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">accessTier</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Hot'</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Set the access tier to Hot</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">allowBlobPublicAccess</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Disable public access to blobs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">publicNetworkAccess</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Disabled'</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Disable public network access</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Resource definition for the blob service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> blobService </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.Storage/storageAccounts/blobServices@2023-01-01'</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'default'</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Set the name of the blob service to default</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">parent</span><span class="token operator">:</span><span class="token plain"> storageAccount </span><span class="token comment" style="color:rgb(98, 114, 164)">// Set the parent to the storage account</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">lastAccessTimeTrackingPolicy</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">enable</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Enable last access time tracking</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Resource definition for the storage container</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> storageContainer </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.Storage/storageAccounts/blobServices/containers@2023-01-01'</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> containerName </span><span class="token comment" style="color:rgb(98, 114, 164)">// Set the name of the container</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">parent</span><span class="token operator">:</span><span class="token plain"> blobService </span><span class="token comment" style="color:rgb(98, 114, 164)">// Set the parent to the blob service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">publicAccess</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'None'</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Set public access to None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Define a new resource of type 'Microsoft.Storage/storageAccounts/managementPolicies'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> lifecyclePolicy </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.Storage/storageAccounts/managementPolicies@2023-01-01'</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// The name of the management policy. 'default' is a reserved name for the policy.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'default'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// The parent resource that this policy is associated with, which is the storage account.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">parent</span><span class="token operator">:</span><span class="token plain"> storageAccount</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">policy</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">rules</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token comment" style="color:rgb(98, 114, 164)">// This rule is enabled</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">enabled</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token comment" style="color:rgb(98, 114, 164)">// The name of the rule</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'MoveToCoolStorageAfter30Days'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token comment" style="color:rgb(98, 114, 164)">// The type of rule, in this case, it's a lifecycle rule</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Lifecycle'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">definition</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">actions</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token comment" style="color:rgb(98, 114, 164)">// The actions to take on base blobs (i.e., non-versioned blobs)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token property">baseBlob</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token comment" style="color:rgb(98, 114, 164)">// Move the blob to cool storage after it hasn't been modified for 30 days</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token property">tierToCool</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                  </span><span class="token property">daysAfterModificationGreaterThan</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">30</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token comment" style="color:rgb(98, 114, 164)">// The filters that determine which blobs the rule applies to</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">filters</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token comment" style="color:rgb(98, 114, 164)">// The types of blobs that the rule applies to. In this case, the rule applies to block blobs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token property">blobTypes</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token string" style="color:rgb(255, 121, 198)">'blockBlob'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">enabled</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'MoveToArchiveStorageAfter90Days'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Lifecycle'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">definition</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">actions</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token property">baseBlob</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token comment" style="color:rgb(98, 114, 164)">// Move the blob to archive storage after it hasn't been modified for 90 days</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token property">tierToArchive</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                  </span><span class="token property">daysAfterModificationGreaterThan</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">90</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">filters</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token property">blobTypes</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token string" style="color:rgb(255, 121, 198)">'blockBlob'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">enabled</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'DeleteBlobsAfter120Days'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Lifecycle'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">definition</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">actions</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token property">baseBlob</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token comment" style="color:rgb(98, 114, 164)">// Delete the blob after it hasn't been modified for 120 days</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token property">delete</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                  </span><span class="token property">daysAfterModificationGreaterThan</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">120</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">filters</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token property">blobTypes</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token string" style="color:rgb(255, 121, 198)">'blockBlob'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">output</span><span class="token plain"> storageAccountName </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> storageAccount</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">name </span><span class="token comment" style="color:rgb(98, 114, 164)">// Output the name of the storage account</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">output</span><span class="token plain"> containerName </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> storageContainer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">name </span><span class="token comment" style="color:rgb(98, 114, 164)">// Output the name of the storage account container</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Please note the Storage Account name and Container Name; we will need them for Azure DevOps pipeline variables.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-azure-devops-pipeline">üõ†Ô∏è Azure DevOps Pipeline<a href="https://luke.geek.nz/azure/export-azure-devops-repos-azure-storage-account/#%EF%B8%8F-azure-devops-pipeline" class="hash-link" aria-label="Direct link to üõ†Ô∏è Azure DevOps Pipeline" title="Direct link to üõ†Ô∏è Azure DevOps Pipeline">‚Äã</a></h3>
<p>Now, it's time to set up your project and repository. If you don't know how to do that, you can follow the official Microsoft Learn documentation here: <a href="https://learn.microsoft.com/en-us/azure/devops/repos/git/create-new-repo?view=azure-devops&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Create a new Git repo in your project</a>.</p>
<p>Once your repository has been set up and initialized, we need to add the following files.</p>
<h1>üíª PowerShell Script</h1>
<p>The PowerShell script, <code>Export-AzDevOpsRepos.ps1</code>, is responsible for cloning all repositories in a given Azure DevOps organization and downloading them as ZIP files. It uses the Azure DevOps REST API to fetch all projects and their respective repositories. For each repository, it generates a URL to download the repository as a ZIP file and saves it to a local directory. If the script is run in an Azure Pipelines environment, it also uploads the directory containing the downloaded repositories as a pipeline artifact.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>The PowerShell script can also be run locally. If it detects an Azure DevOps agent, it will automatically collect the variables from the pipeline variables; otherwise, those variables can be added manually to the script to run it locally.</p><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$env</span><span class="token plain">:AGENT_ID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Running in Azure DevOps</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$personalAccessToken</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$env</span><span class="token string" style="color:rgb(255, 121, 198)">:pat"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Assuming PAT is stored as a secret variable in the pipeline</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$organization</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$env</span><span class="token string" style="color:rgb(255, 121, 198)">:AzDevOpsOrg"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Running on a local PC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$personalAccessToken</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">''</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$organization</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">''</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h1>üöÄ Azure Pipelines</h1>
<p>The Azure Pipelines configuration file, <code>.azure-pipelines/pipeline.ci.adoexport.yml</code> sets up a CI pipeline that runs the PowerShell script on a schedule. The pipeline is configured to run on the latest Windows agent. It uses the Azure CLI task to run the PowerShell script and to manage access to an Azure storage account. After the script has run, the pipeline downloads any ZIP files produced as artifacts and copies them to the Azure storage account. The pipeline is scheduled to run daily at midnight.</p>
<div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">pipeline.ci.adoexport.yml</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">Export-AzDevOpsRepos.ps1</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Export Azure DevOps repositories"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Name of the pipeline</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">trigger</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> none </span><span class="token comment" style="color:rgb(98, 114, 164)"># Pipeline is not triggered automatically</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">schedules</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Define schedules for pipeline runs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">cron</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"0 12 * * *"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Run daily at midnight</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Daily midnight run </span><span class="token comment" style="color:rgb(98, 114, 164)"># Display name for the schedule</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">branches</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">include</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> main </span><span class="token comment" style="color:rgb(98, 114, 164)"># Only run on the 'main' branch</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">always</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Run even if there are no code changes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">pool</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">vmImage</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"windows-latest"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Use the latest Windows agent</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">checkout</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> self </span><span class="token comment" style="color:rgb(98, 114, 164)"># Checkout the source code from the repository</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">persistCredentials</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Persist credentials for subsequent steps</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Checkout code"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Display name for the step</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> AzureCLI@2 </span><span class="token comment" style="color:rgb(98, 114, 164)"># Use Azure CLI task</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Clone Azure DevOps Repositories"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Display name for the step</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">azureSubscription</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"$(azServiceConnection)"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Azure subscription to use</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">scriptType</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"ps"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Use PowerShell script</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">scriptLocation</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"scriptPath"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Script location is a file path</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">scriptPath</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"$(Build.Repository.LocalPath)/Export-AzDevOpsRepos.ps1"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Path to the PowerShell script</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">PAT</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> $(PAT) </span><span class="token comment" style="color:rgb(98, 114, 164)"># Personal Access Token for authentication</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">AzDevOpsOrg</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> $(AzDevOpsOrg) </span><span class="token comment" style="color:rgb(98, 114, 164)"># Azure DevOps organization</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> AzureCLI@2 </span><span class="token comment" style="color:rgb(98, 114, 164)"># Use Azure CLI task</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Allow Public Access to Azure DevOps Export Storage Account for upload </span><span class="token comment" style="color:rgb(98, 114, 164)"># Display name for the step</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">condition</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> succeeded() </span><span class="token comment" style="color:rgb(98, 114, 164)"># Run only if the previous step succeeded</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">azureSubscription</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"$(azServiceConnection)"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Azure subscription to use</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">scriptType</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> bash </span><span class="token comment" style="color:rgb(98, 114, 164)"># Use Bash script</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">scriptLocation</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> inlineScript </span><span class="token comment" style="color:rgb(98, 114, 164)"># Script location is inline</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token scalar string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        az storage account update --name "${storageAccount}"  --resource-group "${storageAccountRG}" --default-action Allow</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">storageAccount</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> $(storageAccount) </span><span class="token comment" style="color:rgb(98, 114, 164)"># Personal Access Token for authentication</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">storageAccountRG</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> $(storageAccountRG) </span><span class="token comment" style="color:rgb(98, 114, 164)"># Azure DevOps organization</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> AzureCLI@2 </span><span class="token comment" style="color:rgb(98, 114, 164)"># Use Azure CLI task</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Check Storage Network Access"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Display name for the step</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">condition</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> succeeded() </span><span class="token comment" style="color:rgb(98, 114, 164)"># Run only if the previous step succeeded</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">timeoutInMinutes</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">10</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Timeout after 10 minutes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">continueOnError</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Continue even if the step fails</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> check_storage_access </span><span class="token comment" style="color:rgb(98, 114, 164)"># Name of the step</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">azureSubscription</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"$(azServiceConnection)"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Azure subscription to use</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">scriptType</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> bash </span><span class="token comment" style="color:rgb(98, 114, 164)"># Use Bash script</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">scriptLocation</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> inlineScript </span><span class="token comment" style="color:rgb(98, 114, 164)"># Script location is inline</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token scalar string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        set -x</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        echo -e "Setting up authentication..."</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        AZURE_STORAGE_ACCOUNT=${storageAccount}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        AZURE_STORAGE_KEY=$(az storage account keys list --account-name ${storageAccount} --query '[0].value' --output tsv)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        echo -e "Checking storage account access every 60 seconds..."</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        sleep 10</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        for i in {1..60}; do</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">          if az storage container list --output none; then</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            echo "Access granted"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            break</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">          else</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            echo "Access denied, retrying in 60 seconds..."</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            sleep 60</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">          fi</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        done</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> DownloadPipelineArtifact@2 </span><span class="token comment" style="color:rgb(98, 114, 164)"># Download pipeline artifacts</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Download Build Artifacts"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Display name for the step</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">patterns</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"**/*.zip"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Include all ZIP files</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">path</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"$(Build.ArtifactStagingDirectory)"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Download artifacts to the staging directory</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">#Storage account needs the SPN to have a Storage Blob Data Contributor role to allow blob upload.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> AzureFileCopy@6 </span><span class="token comment" style="color:rgb(98, 114, 164)"># Use Azure File Copy task</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Copy artifacts to $(storageAccount)"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Display name for the step</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">azureSubscription</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"$(azServiceConnection)"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Azure subscription to use</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">blobPrefix</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"$(Build.DefinitionName)/$(Build.BuildId)"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Prefix for the blob names</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">containerName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> $(stgAccContainer) </span><span class="token comment" style="color:rgb(98, 114, 164)"># Name of the storage container</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">destination</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"AzureBlob"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Copy to Azure Blob storage</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">sourcePath</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"$(Build.ArtifactStagingDirectory)/*"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Source path for the artifacts</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">storage</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> $(storageAccount) </span><span class="token comment" style="color:rgb(98, 114, 164)"># Storage account to copy the artifacts to</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Log the status of artifact download and storage account operations</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> AzureCLI@2 </span><span class="token comment" style="color:rgb(98, 114, 164)"># Use Azure CLI task</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Remove Public Access from Azure DevOps Export Storage Account </span><span class="token comment" style="color:rgb(98, 114, 164)"># Display name for the step</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">condition</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> succeededOrFailed() </span><span class="token comment" style="color:rgb(98, 114, 164)"># Run whether the previous step succeeded or failed</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">azureSubscription</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"$(azServiceConnection)"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Azure subscription to use</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">scriptType</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> bash </span><span class="token comment" style="color:rgb(98, 114, 164)"># Use Bash script</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">scriptLocation</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> inlineScript </span><span class="token comment" style="color:rgb(98, 114, 164)"># Script location is inline</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token scalar string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        az storage account update --name "${storageAccount}" --resource-group "${storageAccountRG}" --default-action Deny</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">storageAccount</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> $(storageAccount) </span><span class="token comment" style="color:rgb(98, 114, 164)"># Personal Access Token for authentication</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">storageAccountRG</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> $(storageAccountRG) </span><span class="token comment" style="color:rgb(98, 114, 164)"># Azure DevOps organization</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$apiVersion</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">'7.1'</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Update API version to 6.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$env</span><span class="token plain">:AGENT_ID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Running in Azure DevOps</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$personalAccessToken</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$env</span><span class="token string" style="color:rgb(255, 121, 198)">:pat"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Assuming PAT is stored as a secret variable in the pipeline</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$organization</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$env</span><span class="token string" style="color:rgb(255, 121, 198)">:AzDevOpsOrg"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Running on a local PC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$personalAccessToken</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">''</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$organization</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">''</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$base64AuthInfo</span><span class="token plain"> = </span><span class="token namespace">[System.Convert]</span><span class="token plain">::ToBase64String</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token namespace">[System.Text.Encoding]</span><span class="token plain">::ASCII</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">GetBytes</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">":</span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$personalAccessToken</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$headers</span><span class="token plain"> = @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">Authorization = </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"Basic {0}"</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">f </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$base64AuthInfo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Get all projects</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$projects</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Invoke-RestMethod</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Uri </span><span class="token string" style="color:rgb(255, 121, 198)">"https://dev.azure.com/</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$organization</span><span class="token string" style="color:rgb(255, 121, 198)">/_apis/projects?api-version=</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$apiVersion</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Method Get </span><span class="token operator">-</span><span class="token plain">Headers </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$headers</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Verbose</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Output the count and names of the projects</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Number of projects: </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$projects</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">value</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Count</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Project names: </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$projects</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">value </span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token string function" style="color:rgb(80, 250, 123)"> </span><span class="token string function" style="color:rgb(80, 250, 123)">ForEach-Object</span><span class="token string function" style="color:rgb(80, 250, 123)"> </span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string function" style="color:rgb(80, 250, 123)"> </span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">name </span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># For each project, get all repositories and download them as zip</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Ensure the repositories directory exists before starting the loop</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$repositoriesPath</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$env</span><span class="token string" style="color:rgb(255, 121, 198)">:SYSTEM_DEFAULTWORKINGDIRECTORY/repositories"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">-not</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token function" style="color:rgb(80, 250, 123)">Test-Path</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Path </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$repositoriesPath</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Creating repositories directory: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$repositoriesPath</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">New-Item</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ItemType Directory </span><span class="token operator">-</span><span class="token plain">Path </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$repositoriesPath</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Out-Null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$projects</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">value </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">ForEach-Object</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$projectName</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">-not</span><span class="token plain"> </span><span class="token namespace">[string]</span><span class="token plain">::IsNullOrWhiteSpace</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$projectName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$projectName</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$projectName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Replace</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">' '</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'%20'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$result</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Invoke-RestMethod</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Uri </span><span class="token string" style="color:rgb(255, 121, 198)">"https://dev.azure.com/</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$organization</span><span class="token string" style="color:rgb(255, 121, 198)">/</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$projectName</span><span class="token string" style="color:rgb(255, 121, 198)">/_apis/git/repositories?api-version=</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$apiVersion</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Method Get </span><span class="token operator">-</span><span class="token plain">Headers </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$headers</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Verbose</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$result</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">value </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">ForEach-Object</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$repoName</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Attempting to clone the repository: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$repoName</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">-not</span><span class="token plain"> </span><span class="token namespace">[string]</span><span class="token plain">::IsNullOrWhiteSpace</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$repoName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$repoId</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">id</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$zipUrl</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"https://dev.azure.com/</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$organization</span><span class="token string" style="color:rgb(255, 121, 198)">/</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$projectName</span><span class="token string" style="color:rgb(255, 121, 198)">/_apis/git/repositories/</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$repoId</span><span class="token string" style="color:rgb(255, 121, 198)">/items?scopePath=/&amp;recursionLevel=Full&amp;api-version=</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$apiVersion</span><span class="token string" style="color:rgb(255, 121, 198)">&amp;`</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$format</span><span class="token string" style="color:rgb(255, 121, 198)">=zip"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$outputPath</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"repositories/</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$repoName</span><span class="token string" style="color:rgb(255, 121, 198)">.zip"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Output path: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$outputPath</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token comment" style="color:rgb(98, 114, 164)"># Ensure the directory exists before trying to download the file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$directoryPath</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Split-Path</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Path </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$outputPath</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Parent</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">-not</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token function" style="color:rgb(80, 250, 123)">Test-Path</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Path </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$directoryPath</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Creating directory: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$directoryPath</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token function" style="color:rgb(80, 250, 123)">New-Item</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ItemType Directory </span><span class="token operator">-</span><span class="token plain">Path </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$directoryPath</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Out-Null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">try</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Starting download for </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$repoName</span><span class="token string" style="color:rgb(255, 121, 198)"> from </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$zipUrl</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token function" style="color:rgb(80, 250, 123)">Invoke-WebRequest</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Uri </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$zipUrl</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">OutFile </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$outputPath</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Headers </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$headers</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Download completed for </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$repoName</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Failed to download </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$repoName</span><span class="token string" style="color:rgb(255, 121, 198)"> from </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$zipUrl</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Exception</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Message</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Check if the repositories directory exists before trying to upload it</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token function" style="color:rgb(80, 250, 123)">Test-Path</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Path </span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$env</span><span class="token string" style="color:rgb(255, 121, 198)">:SYSTEM_DEFAULTWORKINGDIRECTORY/repositories"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Repositories directory exists, uploading as an artifact."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"##vso[artifact.upload containerfolder=repositories;artifactname=AzureDevOpsExportedRepositories;]</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$env</span><span class="token string" style="color:rgb(255, 121, 198)">:SYSTEM_DEFAULTWORKINGDIRECTORY/repositories"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"The repositories directory does not exist, so you cannot upload it as an artifact."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></div>
<p>You can also find the latest files in the <a href="https://github.com/lukemurraynz/ADO_Export" target="_blank" rel="noopener noreferrer">lukemurraynz/ADO_Export</a> GitHub repository. Feel free to open a Pull Request, Suggest changes, or improve.</p>
<p>I am going to be lazy and just drag the files into the repo and commit them.</p>
<p><img decoding="async" loading="lazy" alt="Export_ADO_CommitFiles" src="https://luke.geek.nz/assets/images/Export_ADO_CommitFiles-b8ad417e67074d3ae587901f68555ea7.gif" width="1903" height="974" class="img_ev3q"></p>
<p>Once committed, it is time to set up our pipeline.</p>
<p>But first, we need to setup our <a href="https://learn.microsoft.com/azure/devops/organizations/accounts/use-personal-access-tokens-to-authenticate?view=azure-devops&amp;tabs=Windows&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">PAT (Personal Access Token)</a> and <a href="https://learn.microsoft.com/azure/devops/pipelines/library/service-endpoints?view=azure-devops&amp;tabs=yaml&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Service Connection</a>. Both I have completed.</p>
<p>For your PAT token, you will need the following permissions:</p>
<ul>
<li>Code (Read)</li>
<li>Project and Team (Read)</li>
</ul>
<p>For your Service Connection, you will need the following permissions:</p>
<p>Reader on the Subscription that Contains your Storage Account <em>(the subscription scoping is required for the Azure CLI commanders to check and access your Storage account; if you are using a Self-Managed DevOps agent, you may be able to avoid this)</em>, and Storage Blob Data Contributor on the Storage Account.</p>
<p>Then, we need to add to our pipeline the following:</p>
<table><thead><tr><th>Variable</th><th>Example</th><th>Notes</th></tr></thead><tbody><tr><td>azDevOpsOrg</td><td>Contoso</td><td>Your Azure DevOps Org - matching your URL ie (<a href="https://dev.azure.com/contoso" target="_blank" rel="noopener noreferrer">https://dev.azure.com/contoso</a>)</td></tr><tr><td>azServiceConnection</td><td>AzureServiceConnection</td><td>Your Service Connection name for Azure Resource Provider access to your Azure Resource Group</td></tr><tr><td>pat</td><td>2xj2jv4yf2h6xvqjgk7y2n4d2iucxltlzyxuhcdjxibnrf</td><td>Your PAT (Personal Access Token), used to authenticate to Azure DevOps. Set this as a secure string.</td></tr><tr><td>stgAccContainer</td><td>adoexport</td><td>The Container that will contain your ADO Exports inside of the Storage Account</td></tr><tr><td>storageAccount</td><td>adoexport23</td><td>Storage account that your ADO exports will be going into.</td></tr><tr><td>storageAccountRG</td><td>adoexport-rg</td><td>Resource Group, containing your Azure Storage Account</td></tr></tbody></table>
<p>So, let's import our pipeline and configure our variables!</p>
<ol>
<li>To import the Pipeline, navigate to your Azure DevOps Project, click on Pipelines, and then click on the "New Pipeline" button.</li>
<li>Click Azure Repos Git and select your repository.</li>
<li>Select Existing Azure Pipelines YAML file</li>
<li>Select your Pipeline and click Continue</li>
<li>Now, we can add our Variables by clicking Variables and then Add. If you have already imported the Pipeline, you can navigate to the Pipeline, click Edit, and then Variables.</li>
</ol>
<p><img decoding="async" loading="lazy" alt="Import Azure DevOps Pipeline &amp;amp; Configure Variables" src="https://luke.geek.nz/assets/images/Export_ADO_ImportPipelineVariables-7e89a1a95ca45e77a5c6ad1febab6765.gif" width="1903" height="974" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>By default, the pipeline has a cronjob configured to set it for midnight, but you can change this to any time you like by editing the pipeline file and changing the <a href="https://learn.microsoft.com/azure/devops/pipelines/process/scheduled-triggers?view=azure-devops&amp;tabs=yaml&amp;WT.mc_id=AZ-MVP-5004796#cron-syntax" target="_blank" rel="noopener noreferrer">cron syntax</a>.</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token key atrule">schedules</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Define schedules for pipeline runs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">cron</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"0 12 * * *"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Run daily at midnight</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Daily midnight run </span><span class="token comment" style="color:rgb(98, 114, 164)"># Display name for the schedule</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">branches</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">include</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> main </span><span class="token comment" style="color:rgb(98, 114, 164)"># Only run on the 'main' branch</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">always</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Run even if there are no code changes</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-run">üèÉ‚Äç‚ôÇÔ∏è Run<a href="https://luke.geek.nz/azure/export-azure-devops-repos-azure-storage-account/#%EF%B8%8F-run" class="hash-link" aria-label="Direct link to üèÉ‚Äç‚ôÇÔ∏è Run" title="Direct link to üèÉ‚Äç‚ôÇÔ∏è Run">‚Äã</a></h2>
<p>Now that you have configured your Storage Account and Pipeline, it's time to run the pipeline manually to ensure there are no problems before your scheduled time runs.</p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>Before you run:</p><p>Double-check the permissions you have granted the Service Principal and your variable naming and values; else you may get an error similar to the following when attempting to copy the artifacts to the Storage Account:</p><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">ERROR: (InvalidApiVersionParameter) The api-version '2023-01-01' is invalid. The supported versions are '2024-03-01,2023-07-01,2023-07-01-preview,2023-03-01-preview,2022-12-01,2022-11-01-preview,2022-09-01,2022-06-01,2022-05-01,2022-03-01-preview,2022-01-01,2021-04-01,2021-01-01,2020-10-01,2020-09-01,2020-08-01,2020-07-01,2020-06-01,2020-05-01,2020-01-01,2019-11-01,2019-10-01,2019-09-01,2019-08-01,2019-07-01,2019-06-01,2019-05-10,2019-05-01,2019-03-01,2018-11-01,2018-09-01,2018-08-01,2018-07-01,2018-06-01,2018-05-01,2018-02-01,2018-01-01,2017-12-01,2017-08-01,2017-06-01,2017-05-10,2017-05-01,2017-03-01,2016-09-01,2016-07-01,2016-06-01,2016-02-01,2015-11-01,2015-01-01,2014-04-01-preview,2014-04-01,2014-01-01,2013-03-01,2014-02-26,2014-04'.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Code: InvalidApiVersionParameter</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>It means, that your variables are not parsing correctly, to the Azure CLI, make sure they are correct.</p></div></div>
<p><em>You may need to permit your Pipeline to use your Service Connection by clicking on the "Allow" button when the pipeline runs.</em></p>
<p>Your pipeline may take a while to run, depending on how many repositories you have and how large they are. You can monitor the progress of the pipeline by clicking on the pipeline, then clicking on the Job, and then the Task to see the output of the PowerShell script. This is why I would recommend running this on a schedule during a time that does not impact users, as it can hold up an agent while it runs; also be aware that depending on your repositories, running this every night can quickly use up any <a href="https://azure.microsoft.com/pricing/details/devops/azure-devops-services/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">build minutes you may have, if running from a Microsoft hosted agent</a>.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>If a Repository is only used for Azure Boards and not for code, it will not be exported, as the API will not return it <em>, i.e., you will use a (404) Not Found</em>.</p></div></div>
<p><img decoding="async" loading="lazy" alt="Azure DevOps - Artifact_Export" src="https://luke.geek.nz/assets/images/Artifact_Export-3ce83535131fbf52988deb4b2d59f7f3.png" width="1294" height="826" class="img_ev3q"></p>
<p>Once that's completed - you will be able to see your exported repositories in your storage account!</p>
<p><img decoding="async" loading="lazy" alt="Azure DevOps - Storage Account" src="https://luke.geek.nz/assets/images/Export_ADO_CheckAzureDevOpsExportStfAcc-1067ea82c3f3b98a9ae13131bfb85035.gif" width="1903" height="974" class="img_ev3q"></p>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Deploying Large Language Models on AKS with Kaito]]></title>
            <link>https://luke.geek.nz/azure/run-local-llm-aks/</link>
            <guid>https://luke.geek.nz/azure/run-local-llm-aks/</guid>
            <pubDate>Wed, 08 May 2024 21:49:34 GMT</pubDate>
            <description><![CDATA[Deploy large language models on AKS using Kaito, an operator that simplifies the deployment of AI/ML inference models in a Kubernetes cluster.]]></description>
            <content:encoded><![CDATA[<p>Today, we are going to look at deploying a large language model <em>(LLM)</em> directly into your AKS <em>(Azure Kubernetes Service)</em> cluster, running on GPU-enabled nodes, using <a href="https://github.com/Azure/kaito" target="_blank" rel="noopener noreferrer">Kaito <em>(Kubernetes AI Toolchain Operator)</em></a>.</p>
<blockquote>
<p>KAITO is an open-source operator that transforms how you deploy AI models on Kubernetes. It streamlines the process, automating critical tasks like infrastructure provisioning and resource optimization. It intelligently selects the optimal hardware configuration for your specific model, using available CPU and GPU resources on AKS. KAITO eliminates the manual setup complexities, accelerating your deployment time and reducing associated costs.</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-overview">üëÄ Overview<a href="https://luke.geek.nz/azure/run-local-llm-aks/#-overview" class="hash-link" aria-label="Direct link to üëÄ Overview" title="Direct link to üëÄ Overview">‚Äã</a></h2>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p><a href="https://github.com/Azure/kaito" target="_blank" rel="noopener noreferrer">Kaito</a> is an operator that automates the deployment of the AI/ML inference model in a Kubernetes cluster. The target models are popular open-sourced inference models such as Falcon and llama2. Kaito has the following critical differentiations compared to most of the mainstream model deployment methodologies built on top of virtual machine infrastructures:</p><ul>
<li>Manage large model files using container images. An HTTP server is provided to perform inference calls using the model library.</li>
<li>Avoid tuning deployment parameters to fit GPU hardware by providing preset configurations.</li>
<li>Auto-provision GPU nodes based on model requirements.</li>
<li>Host large model images in the public Microsoft Container Registry (MCR) if the license allows.</li>
</ul><p>Kaito follows the classic Kubernetes Custom Resource Definition(CRD)/controller design pattern. The user manages a workspace custom resource that describes the GPU requirements and the inference specification. Kaito controllers automate the deployment by reconciling the workspace custom resource.</p><p><img decoding="async" loading="lazy" alt="Kaito - Architecture" src="https://luke.geek.nz/assets/images/kaito-arch-2e8dc7b883bd663ee34c62f7781cd570.png" width="2666" height="1123" class="img_ev3q"></p><ul>
<li>Workspace controller: It reconciles the workspace custom resource, creates machine custom resources to trigger node auto-provisioning, and creates the inference workload (deployment or stateful set) based on the model preset configurations.</li>
<li>Node provisioner controller: The controller's name is gpu-provisioner in <a href="https://github.com/Azure/kaito/tree/main/charts/kaito/gpu-provisioner" target="_blank" rel="noopener noreferrer">Kaito helm chart</a>. It uses the machine CRD originated from Karpenter to interact with the workspace controller. It integrates with Azure Kubernetes Service(AKS) APIs to add new GPU nodes to the AKS cluster. Note that the gpu-provisioner is an open-sourced component. It can be replaced by other controllers if they support Karpenter-core APIs.</li>
</ul><blockquote>
<p>At the time of this article, <a href="https://azure.microsoft.com/updates/public-preview-kubernetes-ai-toolchain-operator-kaito-addon-for-aks/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Kaito is in preview</a> and <strong>is not recommended for production use</strong>.</p>
</blockquote><p>There are some significant benefits of running open-source LLMs with Kaito. Some advantages include:</p><ul>
<li>Automated GPU node provisioning and configuration: Kaito will automatically provision and configure GPU nodes for you. This can help reduce the operational burden of managing GPU nodes, configuring them for Kubernetes, and tuning model deployment parameters to fit GPU profiles.</li>
<li>Reduced cost: Kaito can help you save money by splitting inferencing across lower-end GPU nodes, which may also be more readily available and cost less than high-end GPU nodes.</li>
<li>Support for popular open-source LLMs: Kaito offers preset configurations for popular open-source LLMs. This can help you deploy and manage open-source LLMs on AKS and integrate them with your intelligent applications.</li>
<li>Fine-grained control: You can fully control data security and privacy, model development and configuration transparency, and fine-tune the model to fit your specific use case.</li>
<li>Network and data security: You can ensure these models are ring-fenced within your organization's network, and the data never leaves the Kubernetes cluster.</li>
</ul></div></div>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>A word of warning: when looking at running your model in your own AKS cluster, be aware of the <a href="https://learn.microsoft.com/en-us/azure/security/fundamentals/shared-responsibility-ai?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">AI Shared responsibility model</a>. There is a difference in the Azure AI PaaS <em>(Platform as a Service)</em> offerings, i.e., Model safety, compute, versioning, etc. and running your model in your own AKS cluster. So, although the Kaito operator helps you run some SLM models in your AKS cluster, you are responsible for the security, compliance, and governance of the entire system versus consuming a Microsoft-provided model as a service offering.</p></div></div>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>If you want to follow the guide and set up Kaito, make sure you have approved <a href="https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/azure-subscription-service-limits?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">quota</a> in your region for the GPU compute nodes. In this example, I am using a 12 vCPU Standard NCSv3 instance.</p><p>You can use the following Azure CLI command to check your use and limit:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">az vm list-usage </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--location</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">${AZURE_LOCATION}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--query</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"[? contains(localName, 'Standard NCSv3')]"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-o</span><span class="token plain"> table</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You can follow this Microsoft guide for requesting a quota increase: <a href="https://learn.microsoft.com/azure/quotas/regional-quota-requests?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Request a quota increase</a>.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-example-app---pets">üê∂ Example App - Pets<a href="https://luke.geek.nz/azure/run-local-llm-aks/#-example-app---pets" class="hash-link" aria-label="Direct link to üê∂ Example App - Pets" title="Direct link to üê∂ Example App - Pets">‚Äã</a></h3>
<p>Today, we will use the <a href="https://github.com/Azure-Samples/aks-store-demo" target="_blank" rel="noopener noreferrer">aks store demo‚ÄîPets</a> sample microservices app, commonly used for AKS demos, tutorials, and experiments. We will deploy it to our AKS cluster, update it to use a locally hosted mistral model to generate the local product descriptions, and then call the externally hosted Azure OpenAI endpoint.</p>
<blockquote>
<p>This sample demo app consists of containerized microservices that can be easily deployed into an Azure Kubernetes Service (AKS) cluster. It is meant to show a realistic scenario using a polyglot architecture, event-driven design, and common open-source back-end services <em>(e.g., RabbitMQ, MongoDB)</em>. The application also leverages OpenAI's GPT-3 models to generate product descriptions. This can be done using either Azure OpenAI or OpenAI.</p>
</blockquote>
<p><img decoding="async" loading="lazy" alt="Demo Pets - Architecture with Azure OpenAI" src="https://luke.geek.nz/assets/images/demo-arch-with-openai-5682b589c10eb05f66a5f942e20b0526.png" width="3128" height="2384" class="img_ev3q"></p>
<p>The application has the following services:</p>
<table><thead><tr><th>Service</th><th>Description</th></tr></thead><tbody><tr><td><code>makeline-service</code></td><td>This service handles processing orders from the queue and completing them (Golang)</td></tr><tr><td><code>order-service</code></td><td>This service is used for placing orders (Javascript)</td></tr><tr><td><code>product-service</code></td><td>This service is used to perform CRUD operations on products (Rust)</td></tr><tr><td><code>store-front</code></td><td>Web app for customers to place orders (Vue.js)</td></tr><tr><td><code>store-admin</code></td><td>Web app used by store employees to view orders in queue and manage products (Vue.js)</td></tr><tr><td><code>virtual-customer</code></td><td>Simulates order creation on a scheduled basis (Rust)</td></tr><tr><td><code>virtual-worker</code></td><td>Simulates order completion on a scheduled basis (Rust)</td></tr><tr><td><code>ai-service</code></td><td>Optional service for adding generative text and graphics creation (Python)</td></tr><tr><td><code>mongodb</code></td><td>MongoDB instance for persisted data</td></tr><tr><td><code>rabbitmq</code></td><td>RabbitMQ for an order queue</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-overview-1">üöÄ Overview<a href="https://luke.geek.nz/azure/run-local-llm-aks/#-overview-1" class="hash-link" aria-label="Direct link to üöÄ Overview" title="Direct link to üöÄ Overview">‚Äã</a></h3>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-prerequisites">üì¶ Prerequisites<a href="https://luke.geek.nz/azure/run-local-llm-aks/#-prerequisites" class="hash-link" aria-label="Direct link to üì¶ Prerequisites" title="Direct link to üì¶ Prerequisites">‚Äã</a></h3>
<ul>
<li><a href="https://github.com/" target="_blank" rel="noopener noreferrer">GitHub account</a> <em>(we will use a GitHub Codespace to deploy the App, and requirements)</em></li>
<li><a href="https://azure.microsoft.com/en-us/free/open-source?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure subscription</a> <em>(we will need an Azure subscription, to install the cluster the model to)</em></li>
<li><a href="https://learn.microsoft.com/azure/quotas/regional-quota-requests?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Request a quota increase</a> for a GPU compute workload <em>(ie Standard NCSv3)</em> in your region. I am based in New Zealand so that I will be deploying to Australia East.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-deploy-aks-cluster">üêù Deploy AKS cluster<a href="https://luke.geek.nz/azure/run-local-llm-aks/#-deploy-aks-cluster" class="hash-link" aria-label="Direct link to üêù Deploy AKS cluster" title="Direct link to üêù Deploy AKS cluster">‚Äã</a></h3>
<ol>
<li>Let us deploy our Cluster and application using a pre-created Azure Developer CLI infrastructure as code deployment by connecting to the Codespace <em>(which already has the dependencies of Azure Developer CLI, Kubectl, Helm, Azure Bicep, and Terraform Azure CLI pre-installed)</em> at <a href="https://github.com/Azure-Samples/aks-store-demo" target="_blank" rel="noopener noreferrer">aks store demo‚ÄîPets</a>.
<img decoding="async" loading="lazy" alt="Open Codespace" src="https://luke.geek.nz/assets/images/Kaito-AKS_Codespace_Open-64c209ec93b7faae9d8375eecb3509e3.gif" width="1835" height="970" class="img_ev3q"></li>
<li>Now, we need to prep for the Azure Developer CLI deployment, which will use Terarform (a random pet name module for a unique name) to deploy our AKS cluster in our specified region. So, let's log in to Azure.</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># login to Azure CLI</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">az login --use-device-code</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># login to Azure Developer CLI</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">azd auth login</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Codespace Azure Login" src="https://luke.geek.nz/assets/images/Kaito-AKS_Codespace_AzLogin-b46496e3e30486ac1168c73ee5f70f46.gif" width="1856" height="970" class="img_ev3q"></p>
<ol start="3">
<li>Once logged in, we can configure a new Azure Developer CLI environment in preparation for our deployment.</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">azd </span><span class="token function" style="color:rgb(80, 250, 123)">env</span><span class="token plain"> new</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="4">
<li>Enter an environment name <em>(i.e., Kaito)</em>; the Azure Developer CLI uses this to store the environment settings for the deployment and won't reflect any of your deployed resources.</li>
<li>Now, we need to set a few environment variables for our deployment, which will be used by the Terraform deployment to deploy the Azure Open AI instance that Pets will use <em>(and we will replace it with Falcon later on; however, I recommend including it in the deployment to confirm that the OpenAI components are confirmed working first)</em>.</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">azd </span><span class="token function" style="color:rgb(80, 250, 123)">env</span><span class="token plain"> </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">set</span><span class="token plain"> DEPLOY_AZURE_OPENAI </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">azd </span><span class="token function" style="color:rgb(80, 250, 123)">env</span><span class="token plain"> </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">set</span><span class="token plain"> DEPLOY_AZURE_WORKLOAD_IDENTITY </span><span class="token boolean">true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>To confirm variables, you can run the following:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">azd </span><span class="token function" style="color:rgb(80, 250, 123)">env</span><span class="token plain"> get-values</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Check Azure Developer CLI variables" src="https://luke.geek.nz/assets/images/Kaito-AKS_Codespace_CheckAzdEnvVariables-9f4a2eb2daff2b3020329ed6e4fa06b6.gif" width="1856" height="970" class="img_ev3q"></p>
<ol start="6">
<li>Finally, it's time to deploy. Run the following command and select the Subscription you want to deploy the AKS cluster into and the region <em>(remember this region is the region for which you have requested the GPU quota increase)</em>.</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">azd up</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Azure Developer CLI -Up" src="https://luke.geek.nz/assets/images/Kaito-AKS_Codespace_AZDUp-1d3dd6a586b65003f0daf98c5a09c338.gif" width="1856" height="970" class="img_ev3q"></p>
<ol start="7">
<li>Once the deployment is complete, you will see the output (AKS and helm deployments for the PET microservices), including the AKS cluster name, the Azure OpenAI endpoint, and the OIDC issuer URL.</li>
</ol>
<p>After you have provided the information, the azd up command will start by registering Azure providers and features and installing Azure CLI extensions. From there, it will invoke the terraform apply command and execute "azd-hook" scripts, which is a neat way for you to "hook" into the deployment process and add any customizations. We will invoke a helm install command in our deployment to apply our Kubernetes manifests.</p>
<p>This will take a few minutes to complete. Once it's done, you will see the terraform apply command output and the created resources. You can also view the resources in the Azure portal.</p>
<p><img decoding="async" loading="lazy" alt="AKS Pet store Azure resource deployments" src="https://luke.geek.nz/assets/images/Kaito-AKS-rg-funnyrhino17-25db477192ccdfdc467492a98b8ec56f.png" width="2736" height="549" class="img_ev3q"></p>
<ol start="7">
<li>Once the deployment is complete, run the following command to load all the AZD environment variables into your shell to be used by the Kaito deployment.</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token builtin class-name" style="color:rgb(189, 147, 249)">eval</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">azd </span><span class="token string variable function" style="color:rgb(80, 250, 123);font-style:italic">env</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic"> get-values</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-test-the-pet-store-app">üß™ Test the Pet-store app<a href="https://luke.geek.nz/azure/run-local-llm-aks/#-test-the-pet-store-app" class="hash-link" aria-label="Direct link to üß™ Test the Pet-store app" title="Direct link to üß™ Test the Pet-store app">‚Äã</a></h3>
<p>Now, lets test that its working, by taking a look at the pet store admin public endpoint.</p>
<ol>
<li>Open your favorite browser and navigate to the <a href="https://portal.azure.com/#home" target="_blank" rel="noopener noreferrer">Azure Portal</a></li>
<li>Search for Kubernetes services</li>
<li>Find your AKS cluster and click on the resource</li>
<li>Click on Services and Ingresses</li>
<li>Find the store-admin service and click on the public endpoint to open the store-admin page.</li>
<li>You can test the current <em>(external to the AKS cluster)</em> Azure OpenAI endpoint by clicking on Products, Add Product, typing in a Keyword, clicking on the "Ask AI Assistant" button, and seeing the generated text.</li>
</ol>
<p><img decoding="async" loading="lazy" alt="AKS - Test Pet store admin OpenAI endpoint" src="https://luke.geek.nz/assets/images/Kaito-AKS_PetStoreAdminAzOpenAITest-5b4d00b101aaecbff857daf1ef47feb9.gif" width="1856" height="989" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-implement-kaito-and-falcon-llm">üê¶ Implement Kaito and Falcon LLM<a href="https://luke.geek.nz/azure/run-local-llm-aks/#-implement-kaito-and-falcon-llm" class="hash-link" aria-label="Direct link to üê¶ Implement Kaito and Falcon LLM" title="Direct link to üê¶ Implement Kaito and Falcon LLM">‚Äã</a></h3>
<p>Now that the AKS cluster is deployed and the Pets store app is running, we can implement Kaito and run the Falcon 7b-instruct large language model.</p>
<blockquote>
<p>You can continue to set this up in the Codespace; I am going to switch to an <a href="https://learn.microsoft.com/azure/cloud-shell/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure CloudShell</a> to complete the rest of the implementation, mainly to come at the implementation, from the point of view of installing Kaito in an existing cluster, not related to the Pet store example <em>(i.e., make sure that there are no variables, etc. that we might be reliant on, without knowing why)</em>.</p>
</blockquote>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Researchers from Technology Innovation Institute, Abu Dhabi, introduced the <a href="https://arxiv.org/pdf/2311.16867.pdf" target="_blank" rel="noopener noreferrer">Falcon series</a>, which includes models with 7 billion, 40 billion, and 180 billion parameters. These models, intended to be causal decoder-only models, were trained on a high-quality, varied corpus mostly obtained from online data. Falcon-180B, the largest model in the series, is the only publicly available pretraining run ever, having been trained on a dataset of more than 3.5 trillion text tokens.</p><p>The researchers discovered that Falcon-180B shows great advancements over other models, including PaLM or Chinchilla. It outperforms models being developed concurrently, such as LLaMA 2 or Inflection-1. Falcon-180B achieves performance close to PaLM-2-Large, which is noteworthy given its lower pretraining and inference costs. With this ranking, Falcon-180B joins GPT-4 and PaLM-2-Large as the leading language models in the world. For more information, see the following resources:</p><ul>
<li><a href="https://arxiv.org/pdf/2311.16867.pdf" target="_blank" rel="noopener noreferrer">The Falcon Series of Open Language Models</a></li>
<li><a href="https://huggingface.co/tiiuae/falcon-40b-instruct" target="_blank" rel="noopener noreferrer">Falcon-40B-Instruct</a></li>
<li><a href="https://huggingface.co/tiiuae/falcon-180B" target="_blank" rel="noopener noreferrer">Falcon-180B</a></li>
<li><a href="https://huggingface.co/tiiuae/falcon-7b" target="_blank" rel="noopener noreferrer">Falcon-7B</a></li>
<li><a href="https://github.com/Azure-Samples/aks-kaito-terraform/blob/main/alcon-7B-Instruct" target="_blank" rel="noopener noreferrer">Falcon-7B-Instruct</a></li>
</ul><p>Reference: <a href="https://techcommunity.microsoft.com/t5/azure-for-isv-and-startups/deploy-kaito-on-aks-using-terraform/ba-p/4108930?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Deploy Kaito on AKS using Terraform</a></p></div></div>
<ol>
<li>To do this, we need to make sure that we have the preview version of the AKS CLI extension installed. You can check this by running the following command:</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">az extension list </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--query</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"[?name=='aks-preview']"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If you don't have it, you can install it:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">az extension </span><span class="token function" style="color:rgb(80, 250, 123)">add</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--name</span><span class="token plain"> aks-preview --allow-preview </span><span class="token boolean">true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>And if needed, update it:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">az extension update </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--name</span><span class="token plain"> aks-preview --allow-preview </span><span class="token boolean">true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="2">
<li>Re-login to Azure, if needed <em>(you don't need to login to the Azure Developer CLI; it was only required for previous steps)</em>. Next, we need to register the AIToolchainProvider resource provider by running the following command:</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">az feature register </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--namespace</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Microsoft.ContainerService"</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--name</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"AIToolchainOperatorPreview"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This will allow the Kaito (AI Toolchain Operator) APIs on your Azure subscription to be deployed into your AKS cluster. It could take a few minutes to register.</p>
<p><img decoding="async" loading="lazy" alt="Register AI Tool Chain Operator" src="https://luke.geek.nz/assets/images/Kaito-AKS_RegisterAIToolChainOperator-99bad2d117c9bb9ea81349d2a47e1259.gif" width="1109" height="372" class="img_ev3q"></p>
<ol start="3">
<li>Once the registration is complete, we can prepare to deploy the workload identity, workspace, and GPU-enabled node pool for Kaito; as part of this, we need to define the environment variables (if you are still using the Codespace, these should be carried over from the previous deployment; if not, we can set them)*. Adding the variables helps us avoid having to enter the values each time we run a command.</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token builtin class-name" style="color:rgb(189, 147, 249)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">AZURE_SUBSCRIPTION_ID</span><span class="token operator">=</span><span class="token string" style="color:rgb(255, 121, 198)">"9b06e177-a5bb-468b-9fd6-fc58e5b67239"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">AZURE_RESOURCE_GROUP</span><span class="token operator">=</span><span class="token string" style="color:rgb(255, 121, 198)">"rg-funnyrhino17"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">AZURE_LOCATION</span><span class="token operator">=</span><span class="token string" style="color:rgb(255, 121, 198)">"australiaeast"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">CLUSTER_NAME</span><span class="token operator">=</span><span class="token string" style="color:rgb(255, 121, 198)">"aks-funnyrhino17"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Set Kaito environment variables" src="https://luke.geek.nz/assets/images/Kaito-AKS_Variables-d4784967f1d65f9fcec1ca1de26373fa.gif" width="1109" height="372" class="img_ev3q"></p>
<ol start="4">
<li>We are now going to update our AKS cluster to enable the Kaito operator and OpenID Connect issuer <em>(required to enable connectivity to a Managed identity to create the Node pools)</em> by running the following command:</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">az aks update </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--name</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">${CLUSTER_NAME}</span><span class="token plain"> --resource-group </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">${AZURE_RESOURCE_GROUP}</span><span class="token plain"> --enable-oidc-issuer --enable-ai-toolchain-operator</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Update AI Toolchain Operator" src="https://luke.geek.nz/assets/images/Kaito-AKS_EnableAIToolChainOperatorExistingCluster-9e60cfca925df9a624cc9b8331b6b1db.gif" width="1109" height="372" class="img_ev3q"></p>
<ol start="5">
<li>Once updated, we can then connect directly to the cluster using the Kubernetes command line tool, Kubectl, by running the following command:</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">az aks get-credentials --resource-group </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">${AZURE_RESOURCE_GROUP}</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--name</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">${CLUSTER_NAME}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Connect to AKS cluster with Kubectl" src="https://luke.geek.nz/assets/images/Kaito-AKS_ConnectAKSClusterKubectl-95fb6925a5173eeba1388abe1c93d9d1.gif" width="1109" height="381" class="img_ev3q"></p>
<ol start="6">
<li>Then verify the connection:</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">kubectl get nodes</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Kubectl get nodes" src="https://luke.geek.nz/assets/images/Kaito-AKSKubectlgetnodes-de6170c0d6a6ed4c0db0751aaec04808.gif" width="1109" height="381" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p><code>kubectl</code> is a command line tool for interacting with Kubernetes clusters. It's part of the Kubernetes project and is used to deploy and manage applications on Kubernetes. It can also be used to inspect and debug cluster and application resources.</p><p>Kubectl is the Kubernetes command-line tool that allows you to run commands against Kubernetes clusters. You can use Kubectl to deploy applications, inspect and manage cluster resources, and view logs. It's a crucial component for interacting with Kubernetes and is used in various operations, from creating, updating, and deleting Kubernetes resources to debugging running applications.</p></div></div>
<ol start="8">
<li>Lets assign the managed identity, Contributor rights over the Resource Group, that contains the Cluster by running the following command:</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token builtin class-name" style="color:rgb(189, 147, 249)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">AKS_OIDC_ISSUER</span><span class="token operator">=</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">az aks show </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--name</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">"</span><span class="token variable string variable" style="color:rgb(189, 147, 249);font-style:italic">${CLUSTER_NAME}</span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">"</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> --resource-group </span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">"</span><span class="token variable string variable" style="color:rgb(189, 147, 249);font-style:italic">${AZURE_RESOURCE_GROUP}</span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">"</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--query</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">"oidcIssuerProfile.issuerUrl"</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-o</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> tsv</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">MC_RESOURCE_GROUP</span><span class="token operator">=</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">az aks show --resource-group $</span><span class="token variable punctuation" style="color:rgb(248, 248, 242);font-style:italic">{</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">AZURE_RESOURCE_GROUP</span><span class="token variable punctuation" style="color:rgb(248, 248, 242);font-style:italic">}</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--name</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> $</span><span class="token variable punctuation" style="color:rgb(248, 248, 242);font-style:italic">{</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">CLUSTER_NAME</span><span class="token variable punctuation" style="color:rgb(248, 248, 242);font-style:italic">}</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--query</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> nodeResourceGroup </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-o</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> tsv</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">KAITO_IDENTITY_PRINCIPAL_ID</span><span class="token operator">=</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">az identity show </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--name</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> ai-toolchain-operator-$</span><span class="token variable punctuation" style="color:rgb(248, 248, 242);font-style:italic">{</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">CLUSTER_NAME</span><span class="token variable punctuation" style="color:rgb(248, 248, 242);font-style:italic">}</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> --resource-group $</span><span class="token variable punctuation" style="color:rgb(248, 248, 242);font-style:italic">{</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">MC_RESOURCE_GROUP</span><span class="token variable punctuation" style="color:rgb(248, 248, 242);font-style:italic">}</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--query</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> principalId </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--output</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> tsv</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">KAITO_IDENTITY_CLIENT_ID</span><span class="token operator">=</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">az identity show  </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--name</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> ai-toolchain-operator-$</span><span class="token variable punctuation" style="color:rgb(248, 248, 242);font-style:italic">{</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">CLUSTER_NAME</span><span class="token variable punctuation" style="color:rgb(248, 248, 242);font-style:italic">}</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> --resource-group $</span><span class="token variable punctuation" style="color:rgb(248, 248, 242);font-style:italic">{</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">MC_RESOURCE_GROUP</span><span class="token variable punctuation" style="color:rgb(248, 248, 242);font-style:italic">}</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--query</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> clientId </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--output</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> tsv</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">az role assignment create </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--assignee</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$KAITO_IDENTITY_PRINCIPAL_ID</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--scope</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"/subscriptions/</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">${AZURE_SUBSCRIPTION_ID}</span><span class="token string" style="color:rgb(255, 121, 198)">/resourcegroups/</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">${AZURE_RESOURCE_GROUP}</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--role</span><span class="token plain"> Contributor</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">az identity federated-credential create </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--name</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Kaito-federated-identity"</span><span class="token plain"> --identity-name ai-toolchain-operator-</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">${CLUSTER_NAME}</span><span class="token plain"> --resource-group </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">${MC_RESOURCE_GROUP}</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--issuer</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">${AKS_OIDC_ISSUER}</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--subject</span><span class="token plain"> system:serviceaccount:kube-system:kaito-gpu-provisioner </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--audience</span><span class="token plain"> api://AzureADTokenExchange</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Assign Kaito Managed Identity federated credentials" src="https://luke.geek.nz/assets/images/Kaito-AKSAssignKaitoMI-3a562a1f7502ebb82363ef0ddcdfdb37.gif" width="1109" height="381" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>If you get 'Failed to connect to MSI. Please make sure MSI is configured correctly.' Make sure you relogin to Azure <em>(ie az login --use-device-code)</em>, you may need to assign Contributor rights manually as well. Reference: <a href="https://github.com/Azure/azure-cli/issues/17695" target="_blank" rel="noopener noreferrer">Error from CloudShell - Failed to connect to MSI. Please make sure MSI is configured correctly. #17695</a></p></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>You can check what entries are in the environment variables by running using echo to output the variable:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token builtin class-name" style="color:rgb(189, 147, 249)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$KAITO_IDENTITY_CLIENT_ID</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If the gpu-provisioner is not running, you can check the logs by running the following command:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">kubectl get pods --all-namespaces </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-l</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">app</span><span class="token operator">=</span><span class="token plain">ai-toolchain-operator</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Find the name of the gpu-provisioner pod, and then run the following command to get the logs:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">kubectl logs </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-n</span><span class="token plain"> kube-system </span><span class="token operator">&lt;</span><span class="token plain">gpu-provisioner-pod-name</span><span class="token operator">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>I had issues where the gpu-provisioner pod was not running and constantly restarted. The logs showed that the identity was not found, so I had to re-run the command to assign the correct managed identity and use the echo command to reveal the managed identity, highlighting the wrong one was selected.</p></div></div>
<p><img decoding="async" loading="lazy" alt="kaito-gpu-provisioner | Azure Portal overview" src="https://luke.geek.nz/assets/images/kaito-gpu-provisoner-deployment-azportal-cfdf9a59bb4b05ea42d1fa4f9c2b4c2b.png" width="1471" height="784" class="img_ev3q"></p>
<ol start="9">
<li>Let's now deploy the Falcon 7b instruct model to our AKS cluster.</li>
</ol>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>As soon as the models are grabbed from the remote registry, the GPU nodes will spin up, and you will start paying for their use, so just be aware.</p></div></div>
<p>We are going to use one of the <strong>supported models to create our interference endpoint in AKS, the Falcon 7b instruct model, as per their examples in the <a href="https://github.com/Azure/kaito/tree/main/examples/inference" target="_blank" rel="noopener noreferrer">Kaito GitHub repository</a></strong>.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">kubectl apply </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-f</span><span class="token plain"> https://raw.githubusercontent.com/Azure/kaito/main/examples/inference/kaito_workspace_falcon_7b-instruct.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>You can monitor the progress of the workspaces and model deployment by running the following command:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">kubectl get workspace workspace-falcon-7b-instruct </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-w</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote>
<p>The deployment can take a few minutes <em>(ie 20-50 minutes, the Resources because ready, before the workspace is ready)</em>, so be patient. It needs to pull the Falcon model from the Microsoft public container registry <em>(ie, Pulling image "mcr.microsoft.com/aks/kaito/kaito-falcon-7b-instruct:0.0.4")</em>.  It took me 45 minutes when I tested with the Mistral 7b model</p>
</blockquote><p>Wait for the Workspace to be ready before continuing.</p><p><img decoding="async" loading="lazy" alt="Deploy workspace-falcon-7b-instruct" src="https://luke.geek.nz/assets/images/Kaito-DeployFalcon7bInstruct-17fb3c57bf9f6cfb157a44c4c0798c05.gif" width="1105" height="415" class="img_ev3q"></p></div></div>
<p>Once the workspaces and pods/nodes have been provisioned, let us test the deployment by running the following command:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">kubectl get svc workspace-falcon-7b-instruct </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-o</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">jsonpath</span><span class="token operator">=</span><span class="token string" style="color:rgb(255, 121, 198)">'{.spec.clusterIP}'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">SERVICE_IP</span><span class="token operator">=</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">kubectl get svc workspace-falcon-7b-instruct </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-o</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">jsonpath</span><span class="token variable operator" style="color:rgb(189, 147, 249);font-style:italic">=</span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">'{.spec.clusterIP}'</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kubectl run </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-it</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--rm</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--restart</span><span class="token operator">=</span><span class="token plain">Never </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--image</span><span class="token operator">=</span><span class="token plain">curlimages/curl -- </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-X</span><span class="token plain"> POST http://</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$SERVICE_IP</span><span class="token plain">/chat </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-H</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"accept: application/json"</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-H</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Content-Type: application/json"</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-d</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"{</span><span class="token string entity" style="color:rgb(255, 121, 198)">\"</span><span class="token string" style="color:rgb(255, 121, 198)">prompt</span><span class="token string entity" style="color:rgb(255, 121, 198)">\"</span><span class="token string" style="color:rgb(255, 121, 198)">:</span><span class="token string entity" style="color:rgb(255, 121, 198)">\"</span><span class="token string" style="color:rgb(255, 121, 198)">What is your favorite ice cream flavor?</span><span class="token string entity" style="color:rgb(255, 121, 198)">\"</span><span class="token string" style="color:rgb(255, 121, 198)">}"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Test Falcon 7b instruct model" src="https://luke.geek.nz/assets/images/Kaito-TestFalcon7bInstruct-8b84bb46ea062f23695e4ed1a485d8a8.gif" width="1105" height="415" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-update-the-pet-store-app">üöÄ Update the Pet-store app<a href="https://luke.geek.nz/azure/run-local-llm-aks/#-update-the-pet-store-app" class="hash-link" aria-label="Direct link to üöÄ Update the Pet-store app" title="Direct link to üöÄ Update the Pet-store app">‚Äã</a></h3>
<p>Almost there! Now that we know that our local chat endpoint is working with the Falcon 7b instruct model, we can update the Pet Store app to use the local Falcon 7b model and remove the Azure OpenAI to generate the product descriptions.</p>
<p>We will continue in our Terminal to do that, but like the previous steps, it can be done in the Codespace. The Pet Store application already has some great examples of doing this, so we will create a new manifest and repoint the application to use the local Falcon workspace instead of the public Azure Open AI endpoint that was created initially:</p>
<ol>
<li>First, we need to create a new config map to deploy the Pet Store app with the Falcon 7b instruct model by running the following command:</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">kubectl apply </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-n</span><span class="token plain"> pets </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-f</span><span class="token plain"> - </span><span class="token operator">&lt;&lt;</span><span class="token string" style="color:rgb(255, 121, 198)">EOF</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">apiVersion: v1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">kind: ConfigMap</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">metadata:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  name: ai-service-configmap</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">data:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  USE_LOCAL_LLM: "True"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  AI_ENDPOINT: "http://workspace-falcon-7b-instruct/chat"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">---</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">apiVersion: apps/v1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">kind: Deployment</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">metadata:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  name: ai-service</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">spec:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  replicas: 1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  selector:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    matchLabels:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">      app: ai-service</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  template:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    metadata:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">      labels:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        app: ai-service</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    spec:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">      nodeSelector:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        "kubernetes.io/os": linux</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">      containers:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">      - name: order-service</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        image: ghcr.io/azure-samples/aks-store-demo/ai-service:latest</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        ports:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        - containerPort: 5001</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        envFrom:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        - configMapRef:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            name: ai-service-configmap</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        resources:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          requests:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            cpu: 20m</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            memory: 50Mi</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          limits:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            cpu: 30m</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            memory: 85Mi</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        startupProbe:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          httpGet:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            path: /health</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            port: 5001</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          initialDelaySeconds: 60</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          failureThreshold: 3</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          timeoutSeconds: 3</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          periodSeconds: 5</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        readinessProbe:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          httpGet:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            path: /health</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            port: 5001</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          initialDelaySeconds: 3</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          failureThreshold: 3</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          timeoutSeconds: 3</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          periodSeconds: 5</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        livenessProbe:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          httpGet:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            path: /health</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            port: 5001</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          failureThreshold: 3</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          initialDelaySeconds: 3</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          timeoutSeconds: 3</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          periodSeconds: 3</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">---</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">apiVersion: v1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">kind: Service</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">metadata:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  name: ai-service</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">spec:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  type: ClusterIP</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  ports:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  - name: http</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    port: 5001</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    targetPort: 5001</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  selector:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    app: ai-service</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now, let's test it! We will remove the Azure OpenAI instance first and then test it!</p>
<p><img decoding="async" loading="lazy" alt="Test Pet Store Local LLM" src="https://luke.geek.nz/assets/images/Kaito-TestFalcon7bInstruct-PetStore-78688fa2c54260059b35c4f63db7723a.gif" width="1864" height="737" class="img_ev3q"></p>
<p>We can confirm within our AI Service ConfigMap now that the local endpoint is being used:</p>
<p><img decoding="async" loading="lazy" alt="Falcon 7b Kaito Local LLM" src="https://luke.geek.nz/assets/images/Falconb_Kaito_LocalLLM_ConfigMap-8aa381e07c3293d592fe1966440d7bf1.png" width="1147" height="932" class="img_ev3q"></p>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Authorization Permission Mismatch error with Azure Storage]]></title>
            <link>https://luke.geek.nz/azure/authorization-permission-mismatch-error-azure-storage/</link>
            <guid>https://luke.geek.nz/azure/authorization-permission-mismatch-error-azure-storage/</guid>
            <pubDate>Mon, 06 May 2024 08:23:54 GMT</pubDate>
            <description><![CDATA[Resolve the "AuthorizationPermissionMismatch" error when copying files to Azure Storage in Azure DevOps pipeline.]]></description>
            <content:encoded><![CDATA[<p>When attempting to copy files in an Azure DevOps pipeline to an Azure Storage account, I received the following error:</p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>##[error]Upload to container: 'StorageContainer' in storage account: 'ContosoStorageAccount' with blob prefix: '736' failed with error: 'AzCopy.exe exited with non-zero exit code while uploading files to blob storage.' For more info please refer to <a href="https://aka.ms/azurefilecopyreadme" target="_blank" rel="noopener noreferrer">https://aka.ms/azurefilecopyreadme</a>.</p></div></div>
<p>After reviewing the Azure DevOps raw pipeline logs I noticed the following:</p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>2024-05-06T06:25:34.1051117Z --------------------------------------------------------------------------------
2024-05-06T06:25:34.1052461Z RESPONSE 403: 403 This request is not authorized to perform this operation using this permission.
2024-05-06T06:25:34.1053291Z ERROR CODE: AuthorizationPermissionMismatch
2024-05-06T06:25:34.1055333Z --------------------------------------------------------------------------------</p></div></div>
<blockquote>
<p>The fix was to make sure that the Service Principal that Azure DevOps is using to read/write to the Azure Storage account has the correct permissions to the Data plane *not just the Management plane.</p>
</blockquote>
<p>In my case, I needed to assign the  <strong><a href="https://learn.microsoft.com/azure/role-based-access-control/built-in-roles?WT.mc_id=AZ-MVP-5004796#storage" target="_blank" rel="noopener noreferrer">Storage Blob Data Contributor</a> role to the Service Principal</strong>.</p>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Federated Credentials to AKS Managed Identity]]></title>
            <link>https://luke.geek.nz/azure/federated-credentials-aks/</link>
            <guid>https://luke.geek.nz/azure/federated-credentials-aks/</guid>
            <pubDate>Sun, 05 May 2024 08:39:07 GMT</pubDate>
            <description><![CDATA[Workloads deployed on an Azure Kubernetes Services (AKS) cluster require Microsoft Entra application credentials or managed identities to access Microsoft Entra-protected resources, such as Azure Key Vault and Microsoft Graph. Microsoft Entra Workload ID integrates with the capabilities native to Kubernetes to federate with external identity providers.]]></description>
            <content:encoded><![CDATA[<p>Workloads deployed on an Azure Kubernetes Services (AKS) cluster require Microsoft Entra application credentials or managed identities to access Microsoft Entra-protected resources, such as Azure Key Vault and Microsoft Graph. Microsoft Entra Workload ID integrates with the capabilities native to Kubernetes to federate with external identity providers.</p>
<p>Let's look at how that might be set up for Managed Identity for AKS (Azure Kubernetes Service) in Azure.</p>
<p><img decoding="async" loading="lazy" alt="AKS Workload Identity" src="https://luke.geek.nz/assets/images/aks-workload-identity-model-e921e08544288984f5cc6c418a26f595.png" width="1070" height="614" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>There is a lot of detail around identity, federated identity, and workload identity that I won't be going into today.</p><p>If this is something you want to dig into, I recommend the following:</p><ul>
<li><a href="https://learn.microsoft.com/en-us/azure/aks/workload-identity-overview?tabs=dotnet&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Use Microsoft Entra Workload ID with Azure Kubernetes Service (AKS)</a></li>
<li><a href="https://learn.microsoft.com/azure/aks/use-oidc-issuer?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Create an OpenID Connect provider on Azure Kubernetes Service (AKS)</a></li>
<li><a href="https://www.youtube.com/watch?v=i2GobU0Wg48" target="_blank" rel="noopener noreferrer">AKS Workload Identity - Quick Tutorial</a></li>
</ul></div></div>
<p>So, let us look at adding a Federated Credential to a User Assigned Managed identity.</p>
<p>Click on <strong>Settings</strong> and <strong>Federated credentials</strong></p>
<p>We will look at one I set up earlier. How this is used is application-specific, but in this example, the Federated credentials are used by an AI Service running on an AKS cluster to talk to an Azure OpenAI instance that the User Assigned Managed identity has access to.</p>
<p><img decoding="async" loading="lazy" alt="Federated Credentials" src="https://luke.geek.nz/assets/images/UserManagedIdentityEditFederatedCredential-351518c0ea04428d7606d78007c82f43.gif" width="1861" height="981" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>It is worth knowing that to use Federated Credentials and open the OIC APIs on your cluster, you will need to either create a new cluster or update it. The OIC APIs are not open by default on the cluster. See <a href="https://learn.microsoft.com/en-us/azure/aks/use-oidc-issuer?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Create an OpenID Connect provider on Azure Kubernetes Service (AKS)</a> for more information.</p></div></div>
<p>First up is:</p>
<p><strong>Cluster Issue URL</strong>, in my example, I have:</p>
<div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">https://australiaeast.oic.prod-aks.azure.com/00000000-0000-0000-0000-000000000000/00000000-0000-0000-0000-000000000000/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>So what is this? This is the URL of the OpenID Connect provider with which the AKS cluster is federating. It is also the URL that the AKS cluster will use to authenticate the User Assigned Managed identity.</p>
<p>To get the URL, you can use the Azure CLI and run the following query:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">az aks show </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-n</span><span class="token plain"> myAKScluster </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-g</span><span class="token plain"> myResourceGroup </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--query</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"oidcIssuerProfile.issuerUrl"</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-otsv</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>To test that it is responding and open, you can navigate to the URL discovery endpoint '/openid/v1/jwks', for example:</p>
<p><a href="https://australiaeast.oic.prod-aks.azure.com/00000000-0000-0000-0000-000000000000/00000000-0000-0000-0000-000000000000/openid/v1/jwks" target="_blank" rel="noopener noreferrer">https://australiaeast.oic.prod-aks.azure.com/00000000-0000-0000-0000-000000000000/00000000-0000-0000-0000-000000000000/openid/v1/jwks</a></p>
<p>You will get an HTTP response back similar to the following:</p>
<div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">"keys": [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    "use": "sig",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    "kty": "RSA",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    "kid": "4gZVAbix5cXrHnMF9D6rp-EOpB92gfamRWVG873e9s5",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    "alg": "RS256",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    "n": "wCZChNTi7ymXkmLeMP95PUl-9b2Fnzm1xLlslLw4Cc_1oMVbvNUbJS6r4_bgylTYSowUCqQLZUPH_DClav4aJC-G3OYlCkQrG3wFnB7b70Q8qJrwsVr2XaYh8lwfah_BceiDEJNc2yjjEBQoHs3zbi3qOVhYp3_BYHVoXuBJnhEgMb5bpxzgN-ZrM2QwmLzLSv9BB_iq034B3P0Exn8n0yWvXPFe_pWPzwyC_l4dgMN_TpNMLjaBYoJ-wdfim7eEJuOgVfuV1O8smMeXhUNUoRKOvFNw9H2qjZM243JhVBnLX1C7Oj_8L2AW7wSptuThl-gIqy9nrcSPT_oHhVUwAgO-gwFCRSgilFiBhsG9-wkflSdELeJCRpLi1j_8OOON0LTX6vZrHjwGzGa0bC5zgouKCFE1iNtVc3HoNKczZL-wiERUIgo8YKey_uOdeOtdBPOLVO0igfN4xtDZnxb_CzSUJ3fJHGAg03k3MBEpr0KAMmhsTSo-KUqfcgnclHkOywGdwnX-oT43SvcItEDbUiKyFV-i0CabAVebzF4O6r_ovpK4N2QJ-4s8_bHx4d3RMstML1D_yEpy40PeFjQq5ZPQQt1AUfkT1jP5-siCdJgm8HTc0zIPwfZfwKdKefYMRmamNHwk3TNV9gdOX0fnKP07R9FBKCgypqeDcLYZYgMt",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    "e": "AQAB"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  },</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    "use": "sig",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    "kty": "RSA",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    "kid": "wQ4TGh1obxJ6l8nxEiV-hf-lccLnJwXxx7Rw8E-UDBo",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    "alg": "RS256",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    "n": "ydxfJlP6Qmh_dfkhWkrGQrrad-o0ShvZCShIUz4-k8bhH98xAhSgC52EmXnbCvkbDxHpwQIZ8GQHFGjbFC-Z-ZbdIpETd-MVwp70HXyoejuFNmdghTeLZaN5Q-lf1U8gjnxfzUo5tL_Vwcd1RhGi3YXwQmiEGJoZ5ZWhQs75O8iAnvyOzDqWt0CxraIAVPoY9aJ1IBTPlA0bIdDtuCTiynCMQiozO4dx72BDMjJ3ZcEwKrFZBFAu71SPr4xs7ErUYqZFtZxmcDxKkhTNCPd9dUkmo6uknMuVSHj5OqeXexDdKhZKcJhTFBGF89oWtIjx0ix9G8VTqTJsDZp3_LBcs6Ob0hpfyaGePhibZTqhDXD_Nr3p-yw78lXO0ceD1xz8ZJyY4EzxtY2yobAGGNsg_wU23XJsIkJLOGiCAjRg81PxbtlEPzClXkxbrZTjKI9OVJxujGxt01PmgiLN38piThL3zsvGF_4N-ApX1fpdKH9Owl2xsmVd-zzzoJ1l8y9FKZpgnJKQ-VECIbVNwzO6KEm2f7O6MKpqB5hLi-QPH-ZLk3zbi_55zb8h1PZxmuam4rS3MHi98IxxmVz8fbMVirosQhzP7oYuM-L1ZgZLzwKvDenmoUYIfzwUl6QCsM3DxZs_07sxUrZk0isNvBHU3wXKsCtSXJyf0CJyq6TAYCD1",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    "e": "AQAB"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>However, for the Federated credential configuration for AKS, the OIC URL from the Azure CLI <code>az aks show</code> command is enough.</p>
<p>Second is the <strong>Namespace</strong>. This is the Namespace in which the User Assigned Managed identity will be used. In my example, I have 'pets' as this is my Application namespace. Be as specific as you can.</p>
<p>In Kubernetes, a namespace organizes and isolates resources within a cluster. It acts as a virtual cluster within the main cluster. Namespaces allow you to group related objects (such as pods, services, and deployments) together and provide a scope for resource names.</p>
<p>Third is the <strong>Service Account</strong>. This Service Account will be linked to the Federated credential inside of AKS.</p>
<p>A service account is an identity used by pods (containers) running within a namespace to authenticate with other services or APIs. Each namespace can have multiple service accounts, and they are associated with specific permissions. When a pod is created, it can be assigned a service account. The pod then uses the credentials associated with that service account to access other resources (e.g., secrets, APIs). Service accounts are useful for controlling access and ensuring that pods have the appropriate permissions.</p>
<p>That leaves the <strong>Subject identifier</strong>. This is the Subject identifier.</p>
<p>In AKS Federated credentials, the subject identifier refers to the identity the managed identity will trust. When using workload identity, the subject identifier is typically the service account associated with a pod. The subject identifier establishes trust between the managed identity (related to the AKS cluster) and the service account (associated with the pod). Once this trust is established, the managed identity can securely use the service account‚Äôs credentials to access other Azure services.</p>
<p>Namespaces provide isolation, service accounts represent identities for pods, and subject identifiers (usually service accounts) are used in federated credentials to establish trust between the managed identity and Kubernetes workloads.</p>
<p>Under the Credentials details, we have <strong>Name</strong> and <strong>Audience</strong>.</p>
<p>The <strong>name</strong> refers to the identifier associated with a managed identity or service principal in Azure. In AKS (Azure Kubernetes Service), when configuring federated credentials using managed identities, you create a managed identity (or use an existing one) to represent your AKS cluster. This managed identity is assigned a unique name, which is used to identify it within Entra ID. For example, creating a managed identity named ‚Äúmy-aks-cluster-identity‚Äù becomes the name associated with the identity.</p>
<p>The <strong>audience</strong> (also known as the ‚Äúaud‚Äù claim) is a critical part of security tokens (such as JWTs) issued by Azure AD. In the context of AKS federated credentials, the audience represents the intended recipient of the token. When a pod in AKS requests an access token (e.g., to access Azure Key Vault secrets), the audience is set to the specific Azure resource (e.g., Key Vault) the pod wants to access. The audience ensures that the token is valid only for the specified resource. For example, if a pod seeks to access a secret stored in Azure Key Vault, the audience in the token will be set to the Key Vault‚Äôs endpoint.</p>
<p>The <code>api://AzureADTokenExchange</code> audience is typically used when a service needs to obtain a token to act on behalf of a user or another service. For example:</p>
<ul>
<li>A user logs in to a web application (front-end), and the application needs to call an API (back-end) on behalf of the user. The front-end application requests an on-behalf-of token with the <code>api://AzureADTokenExchange</code> audience.</li>
<li>A service (acting as a middle-tier) receives an access token from a client and needs to call another downstream service.</li>
</ul>
<p><em>(e.g., a database or an API)</em>. It exchanges the token for an on-behalf-of token using the same audience.</p>
<p>The api://AzureADTokenExchange audience is used explicitly for token exchange scenarios, allowing services to obtain tokens on behalf of users or other services.</p>
<p>Name: The unique identifier for a managed identity or service principal.
Audience: The intended recipient (Azure resource) for the security token.</p>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Uncollapsing the Azure Portal Blade Menu]]></title>
            <link>https://luke.geek.nz/azure/uncollapsing-azure-portal-blade-menu/</link>
            <guid>https://luke.geek.nz/azure/uncollapsing-azure-portal-blade-menu/</guid>
            <pubDate>Sun, 05 May 2024 07:53:07 GMT</pubDate>
            <description><![CDATA[There have been some changes to the Azure Portal that have people scratching their heads; I am talking about the infamous collapsable Blade menu.]]></description>
            <content:encoded><![CDATA[<p>There have been some changes to the Azure Portal that have people scratching their heads; I am talking about the infamous collapsable Blade menu.</p>
<p><img decoding="async" loading="lazy" alt="Azure Portal - Collapse Blade Menu" src="https://luke.geek.nz/assets/images/Azure_Portal_CollapseableMenu-320e53b992b333fd398c13d7c7e8431e.png" width="424" height="692" class="img_ev3q"></p>
<p>I actually like it because it gives the flexibility to hide areas that you may be potentially distracted by, especially as more and more service functionality is brought into the Azure Portal. However, a concern I have is not being able to see new services or options offered in the blade of a service, so for that reason alone, at the moment, I have configured my Azure Portal to have the Blade menu always open.</p>
<p>You can do this fairly easily per user: click on Settings <em>(top right)</em>, click Appearance + Startup views, select Expanded Service menu behavior, and then click Apply.</p>
<p><img decoding="async" loading="lazy" alt="Azure Expanded Menu" src="https://luke.geek.nz/assets/images/AzurePortal_ExpandedMenuSetting-e37ad96a6d76e876dee1ebb573883726.gif" width="1861" height="965" class="img_ev3q"></p>
<p>You can also leave it collapsed, then expand the Blade menu of a resource, by clicking on the <em>little</em> expand icon at the top of the Blade menu, to expand or collapse all headers of the resource pane.</p>
<p><img decoding="async" loading="lazy" alt="Azure Portal - Collapse Resource Blade Menu" src="https://luke.geek.nz/assets/images/AzurePortal_CollapseableResource-2e3a4304c526ae53fac9c17046947206.png" width="362" height="146" class="img_ev3q"></p>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Troubleshooting scenarios for Azure Open AI]]></title>
            <link>https://luke.geek.nz/azure/troubleshooting-scenarios-azure-open-ai/</link>
            <guid>https://luke.geek.nz/azure/troubleshooting-scenarios-azure-open-ai/</guid>
            <pubDate>Fri, 26 Apr 2024 01:36:46 GMT</pubDate>
            <description><![CDATA[Troubleshooting Azure Open AI and API calls to OpenAI can be challenging, especially when you may not know where to start!]]></description>
            <content:encoded><![CDATA[<p>Troubleshooting Azure Open AI and API calls to OpenAI can be challenging, especially when you may not know where to start!</p>
<p>The idea of this article is to give you not only a place to start with some common scenarios you may run into but also a way of thinking - to help you troubleshoot. This is not a technical 'get-your-hands dirty, delve into those logs' type article.</p>
<p>I am a big fan of the KT, or <a href="https://kepner-tregoe.com/" target="_blank" rel="noopener noreferrer">Kepner-Tregoe</a> problem analysis methodology, and I have used it in many scenarios throughout my career to help discover and test the root cause of various problems. So, we will use the base of this problem analysis methodology to help us troubleshoot the scenarios we will discuss in this article.</p>
<p><img decoding="async" loading="lazy" alt="Kepner-Tregoe Method" src="https://luke.geek.nz/assets/images/KT_Method-265bb6f9d9b479b3cbb62da099a35273.png" width="1856" height="1524" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-the-kepner-tregoe-kt">‚ùì The Kepner-Tregoe (KT)<a href="https://luke.geek.nz/azure/troubleshooting-scenarios-azure-open-ai/#-the-kepner-tregoe-kt" class="hash-link" aria-label="Direct link to ‚ùì The Kepner-Tregoe (KT)" title="Direct link to ‚ùì The Kepner-Tregoe (KT)">‚Äã</a></h2>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>The Kepner-Tregoe (KT) Problem Management methodology incorporates elements such as:</p><ul>
<li>"Is" <em>(what we know to be true about the problem)</em></li>
<li>"Is Not" <em>(what we know to be false or different from the problem)</em></li>
<li>"Could Be" <em>(possible causes)</em></li>
<li>"Could Not Be" <em>(what is not a possible cause)</em></li>
<li>"Distinctive Clarity" <em>(what sets this problem apart from others)</em></li>
</ul><p>and "Next Steps" <em>(actions to further diagnose or solve the problem)</em></p></div></div>
<p>You may find that with some issues, we instinctively do a lot of this. Still, this method helps, gives you context, allows you to check any bias you may have in trying to find the root cause, and gives you some great tools to rule out and test any theories, given it has been a few years since I have been through the formal training. Still, it's one of those methodologies that have stuck with me, and I always keep it in mind when troubleshooting issues. Obviously, you can use this methodology for more than just troubleshooting OpenAI issues; this is the scenario we are going to cover today.</p>
<blockquote>
<p>The key to successful troubleshooting, if any IT <em>(Information Technology)</em> issue - is having a clear problem statement, and in the 'real world' really concentrating on the one single problem statement to remain effective for this article; however, we will be covering a mix of common scenarios problems, to help give you high-level ideas and context when troubleshooting issues.</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-problem-statements">‚ùó Problem Statements<a href="https://luke.geek.nz/azure/troubleshooting-scenarios-azure-open-ai/#-problem-statements" class="hash-link" aria-label="Direct link to ‚ùó Problem Statements" title="Direct link to ‚ùó Problem Statements">‚Äã</a></h2>
<p>Today, we are going to look at the following statements:</p>
<table><thead><tr><th>Type of Problem Statement</th><th>Problem Statement</th></tr></thead><tbody><tr><td>Chunking Control</td><td>"Inconsistent accuracy during high-volume transactions suggests that the chunking process is not fully controlled. The problem manifests where API consumption occurs and is especially prominent when handling complex inputs of varying sizes."</td></tr><tr><td>Token Limit Checks</td><td>"Unexpected API call failures, which are confirmed to occur before the API request is made, indicate that the token limit pre-check may not be accurately estimating token sizes, particularly at the time of calling and in cases of complex requests."</td></tr><tr><td>Region Usage</td><td>"Increased latency and occasional service disruptions are observed in a specific default region during peak usage times, suggesting that network latency or regional service performance may not be optimized for the workload, impacting certain regions more than others."</td></tr><tr><td>Model Versioning</td><td>"Encoding and performance issues have arisen across all API endpoints following model or API updates, which are more pronounced in certain versions, indicating that using outdated model versions or incompatibilities between model versions and API might be the underlying cause."</td></tr><tr><td>Streaming Response</td><td>"User experience issues with the streaming implementation on the front-end application during real-time interactions suggest that there might be backend streaming service limitations or insufficient front-end optimization, affecting certain user interactions."</td></tr><tr><td>Token Volume Expectancy</td><td>"The system occasionally experiences overload or underperformance across all API endpoints during 24/7 operation, implying that token volume expectancy might not be accurately predicted or that the system's scaling and load balancing are not adequately configured."</td></tr><tr><td>Logging Practices</td><td>"Issues in diagnostic effectiveness within the logging system arise during error occurrences, which may be due to incomplete logging data or incorrect logging configurations, affecting the resolution of problems by not capturing comprehensive data."</td></tr><tr><td>API Versioning</td><td>"Persisting aborted issues and doubts regarding production readiness after using a preview API version suggest that stability might be compromised due to the continued use of a less stable preview version rather than the GA version across the API service."</td></tr></tbody></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-is-and-is-nots">üéØ IS and Is Nots<a href="https://luke.geek.nz/azure/troubleshooting-scenarios-azure-open-ai/#-is-and-is-nots" class="hash-link" aria-label="Direct link to üéØ IS and Is Nots" title="Direct link to üéØ IS and Is Nots">‚Äã</a></h2>
<p>Let's look at each problem and work out various Is and Nots and potential causes at a high level.</p>
<table><thead><tr><th>Troubleshooting Criteria</th><th>Is (What is True)</th><th>Is Not (What is False)</th><th>Could Be (Possible Causes)</th><th>Could Not Be (What is not a cause)</th><th>Distinctive Clarity (What sets this apart)</th><th>Next Steps</th></tr></thead><tbody><tr><td>Control of Chunking</td><td>Chunking process is implemented</td><td>Perfect control over chunking</td><td>Inadequate chunk size management</td><td>A problem with the API itself</td><td>How chunking affects the accuracy of responses</td><td><a href="https://learn.microsoft.com/azure/search/vector-search-how-to-chunk-documents?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Evaluate and refine the semantic chunking process</a></td></tr><tr><td>Token Limit Check</td><td>Pre-call token limit check is in place</td><td>Always under the token limit</td><td>Misestimation of token size</td><td>A network connectivity issue</td><td>Instances when token limits are exceeded</td><td><a href="https://techcommunity.microsoft.com/t5/fasttrack-for-azure/strategies-for-optimizing-high-volume-token-usage-with-azure/ba-p/4007751?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Implement stricter checks and alerts for token limits</a></td></tr><tr><td>Region Selection</td><td>Using a specific default region</td><td>Region is the cause of all issues</td><td>Network latency or regional service disruption</td><td>Model versioning issues</td><td>The impact of region selection on response times</td><td><a href="https://learn.microsoft.com/azure/ai-services/openai/quotas-limits?WT.mc_id=AZ-MVP-5004796#regional-quota-limits" target="_blank" rel="noopener noreferrer">Test performance in different regions; consider geo-redundancy</a></td></tr><tr><td>Model Version</td><td>Using a specified model version</td><td>All versions have the same performance</td><td>Outdated model causing issues</td><td>A problem with user input</td><td>Differences in encoding and performance between versions</td><td><a href="https://learn.microsoft.com/azure/ai-services/openai/how-to/working-with-models?tabs=powershell&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Upgrade to the latest GA or recommended version of the model</a></td></tr><tr><td>Streaming Response</td><td>Streaming is being used</td><td>Streaming is flawless</td><td>Streaming implementation affecting user experience</td><td>Token limit issues</td><td>User experience with streaming vs. non-streaming responses</td><td><a href="https://github.com/microsoft/semantic-kernel/blob/main/python/notebooks/11-streaming-completions.ipynb" target="_blank" rel="noopener noreferrer">Optimize streaming experience based on user feedback</a></td></tr><tr><td>Token Volume</td><td>Expected volume is known</td><td>The system can handle any volume</td><td>Insufficient API rate limiting or scaling</td><td>An issue with the model's capabilities</td><td>Peak token volume times or patterns</td><td><a href="https://techcommunity.microsoft.com/t5/fasttrack-for-azure/smart-load-balancing-for-openai-endpoints-and-azure-api/ba-p/3991616?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Plan for scaling and load balancing based on expected volume</a></td></tr><tr><td>Logging</td><td>Logging practices are in place</td><td>All necessary data is being logged</td><td>Incomplete or incorrect logging</td><td>An issue with the model's accuracy</td><td>The level of detail and usefulness of logs</td><td><a href="https://learn.microsoft.com/azure/architecture/ai-ml/openai/architecture/log-monitor-azure-openai?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Enhance logging for better diagnostics and problem resolution</a></td></tr><tr><td>API Version</td><td>Currently using a non-GA API version</td><td>GA version has been tested</td><td>Use of preview API versions causing issues</td><td>An issue unrelated to the API version</td><td>The stability and features of GA vs. preview API versions</td><td><a href="https://learn.microsoft.com/azure/ai-services/openai/reference?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Test and migrate to the GA version of the API</a></td></tr><tr><td>System Message Control</td><td>System messages are being used</td><td>Full control over system messages</td><td>System message limits not being respected by the model</td><td>An issue with the API call structure</td><td>How system messages guide user interactions</td><td><a href="https://learn.microsoft.com/azure/ai-services/openai/concepts/system-message?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Ensure system message limits are enforced and informative</a></td></tr><tr><td>System Message Compliance</td><td>Checks for model adherence to system messages</td><td>The model always adheres to system message limits</td><td>Oversights in system message enforcement</td><td>An issue with user expectations</td><td>Instances of non-compliance impacting user experience</td><td><a href="https://www.microsoft.com/en-us/security/blog/2024/02/22/announcing-microsofts-open-automation-framework-to-red-team-generative-ai-systems?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Regularly verify model compliance with system message limits</a></td></tr><tr><td>Hallucinations and Accuracy</td><td>Occurrences of hallucinations and inaccuracies</td><td>The model is always accurate</td><td>Model training or complexity of queries</td><td>An issue with the input data quality</td><td>Specific scenarios where inaccuracies are more frequent</td><td><a href="https://semaphoreci.com/blog/openai-models" target="_blank" rel="noopener noreferrer">Investigate model choice and implement LLM OPS for evaluation</a></td></tr><tr><td>Request and Timeout Issues</td><td>Experiencing request or timeout issues</td><td>All requests are processed promptly</td><td>High server load, inadequate resources, or network latency</td><td>Complete system failure</td><td>Frequency and conditions of timeouts and request failures</td><td><a href="https://learn.microsoft.com/en-us/azure/ai-services/openai/how-to/latency?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Analyze server and network logs, monitor system performance, and optimize configuration</a></td></tr></tbody></table>
<p><img decoding="async" loading="lazy" alt="KT - Dimensions of a Problem" src="https://luke.geek.nz/assets/images/KT_DimensionsofaProblem-852d874de358772c61eb1fbfe3771e57.jpeg" width="700" height="612" class="img_ev3q"></p>
<p>Although this is a very theoretical article, hopefully, it points you in the right direction and <em>thinking</em> when needing to troubleshoot your issues with Azure OpenAI. As a Consultant or Engineer, it can be very quick to jump straight into solutions without fully knowing the extent of the issue or the problem you are actually trying to solve.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-references">üîó References<a href="https://luke.geek.nz/azure/troubleshooting-scenarios-azure-open-ai/#-references" class="hash-link" aria-label="Direct link to üîó References" title="Direct link to üîó References">‚Äã</a></h2>
<ul>
<li><a href="https://learn.microsoft.com/azure/ai-services/openai/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Open AI</a></li>
<li><a href="https://learn.microsoft.com/azure/ai-services/openai/faq?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure OpenAI Service frequently asked questions</a></li>
<li><a href="https://kepner-tregoe.com/" target="_blank" rel="noopener noreferrer">Kepner-Tregoe</a></li>
<li><a href="https://platform.openai.com/tokenizer" target="_blank" rel="noopener noreferrer">OpenAI Tokenizier</a></li>
<li><a href="https://learn.microsoft.com/azure/ai-services/openai/whats-new?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">What's new in Azure OpenAI Service</a></li>
</ul>]]></content:encoded>
            <category>Azure</category>
            <category>Misc</category>
            <category>Service Management</category>
        </item>
        <item>
            <title><![CDATA[Resolving 404 Error with OpenAI Azure Function Binding]]></title>
            <link>https://luke.geek.nz/azure/404-attempting-query-openai-azure-function-binding/</link>
            <guid>https://luke.geek.nz/azure/404-attempting-query-openai-azure-function-binding/</guid>
            <pubDate>Sun, 21 Apr 2024 05:06:54 GMT</pubDate>
            <description><![CDATA[Troubleshooting a 404 error when querying OpenAI using Azure Function binding in Azure.]]></description>
            <content:encoded><![CDATA[<p>When attempting to work with <a href="https://learn.microsoft.com/azure/ai-services/openai/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Open AI</a>, you may want to work with an <a href="https://learn.microsoft.com/azure/azure-functions/functions-overview?pivots=programming-language-csharp&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Functions</a> to adjust or massage the response, to do so you can use the <a href="https://github.com/Azure/azure-functions-openai-extension" target="_blank" rel="noopener noreferrer">Azure Functions bindings for OpenAI's GPT engine
</a> to query the OpenAI API. However, you may encounter a 404 Not Found error when attempting to query OpenAI using the Azure Function binding.</p>
<p><img decoding="async" loading="lazy" alt="Azure Function - 404 Not Found" src="https://luke.geek.nz/assets/images/AzureFunction_OpenAIBinding_NotFound-587a391d4d41999ddd4b2ad615cf6d6b.png" width="1512" height="487" class="img_ev3q"></p>
<p>If you encounter this error, it could be likely that you are using the Azure Function ExtensionBundle, which does not contain the necessary dependencies to query the OpenAI API.</p>
<p>The binding requires at least the following:</p>
<ul>
<li>Microsoft.Azure.WebJobs.Extensions.OpenAI: 0.12.0-alpha</li>
<li>Microsoft.Azure.WebJobs.Extensions.OpenAI.Kusto: 0.12.0-alpha</li>
</ul>
<p><img decoding="async" loading="lazy" alt="Nuget Webjob extensions" src="https://luke.geek.nz/assets/images/AzureFunction_OpenAIBinding_NugetPackageRequirements-f386ce32d8d8ee0aee1301bc66e4fcbd.png" width="828" height="212" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>The binding type(s) 'textCompletion' were not found in the configured extension bundle. Please ensure the correct version of the extension bundle is configured.</p></div></div>
<p>Both packages are not integrated into the <a href="https://github.com/Azure/azure-functions-extension-bundles/releases/tag/4.13.2" target="_blank" rel="noopener noreferrer">4.13.2</a> version of the ExtensionBundle, which, at the time of writing, is not available in the production ExtensionBundle shipped with new Azure Functions <em>(which is 4.13.2)</em>.</p>
<p><strong>However</strong>, it is integrated into the Extension Bundle Preview. For example, Extension Bundle Preview for <a href="https://github.com/Azure/azure-functions-extension-bundles/releases/tag/4.18.0-Preview" target="_blank" rel="noopener noreferrer">4.18.0</a> features:</p>
<ul>
<li>Microsoft.Azure.WebJobs.Extensions.OpenAI: 0.13.0-alpha</li>
<li>Microsoft.Azure.WebJobs.Extensions.OpenAI.Kusto: 0.13.0-alpha</li>
</ul>
<p><img decoding="async" loading="lazy" alt="Extensions Bundles Preview release4.18.0" src="https://luke.geek.nz/assets/images/AzureFunction_OpenAIBinding_ExtensionsBundlePreview4.18.0-bb2fc9c284b05f8d92a260a5fbac3148.png" width="785" height="532" class="img_ev3q"></p>
<p>üîß To use the latest Preview Bundle and enable the OpenAI binding extension, you need to update your function apps: host.json file:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"version"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"2.0"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"managedDependency"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"Enabled"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   </span><span class="token property">"extensionBundle"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"id"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Microsoft.Azure.Functions.ExtensionBundle.Preview"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"version"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"[4.*, 5.0.0)"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Update the id of <code>Microsoft.Azure.Functions.ExtensionBundle.Preview</code> and the version to <code>[4.*, 5.0.0)</code> in accordance with the latest <a href="https://github.com/Azure/azure-functions-extension-bundles/releases" target="_blank" rel="noopener noreferrer">bundle releases</a> to ensure you are using the latest Preview Bundle. The wildcard <code>*</code> will ensure you use the latest Extension Bundle Preview version within that major release.</p>
<p>You should now be able to query the OpenAI API using the Azure Function binding.</p>
<p><img decoding="async" loading="lazy" alt="Run After Binding" src="https://luke.geek.nz/assets/images/AzureFunction_OpenAIBinding_SuccessRunAfterBindingUpdate-3c622c0941c147c84c64527389c7d10d.png" width="1426" height="818" class="img_ev3q"></p>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Implementing a Sandbox Environment in Microsoft Azure]]></title>
            <link>https://luke.geek.nz/azure/implementing-sandbox-vending/</link>
            <guid>https://luke.geek.nz/azure/implementing-sandbox-vending/</guid>
            <pubDate>Sun, 14 Apr 2024 00:26:42 GMT</pubDate>
            <description><![CDATA[This article highlights reference implementation considerations for implementing a Sandbox environment in Microsoft Azure.]]></description>
            <content:encoded><![CDATA[<p>When working with Microsoft Azure, you may want an environment for learning, whether for an individual or a team.</p>
<p>This article aims to highlight some reference implementation considerations for implementing a Sandbox environment within the Microsoft Azure platform.</p>
<p><img decoding="async" loading="lazy" alt="Azure Environment Concepts" src="https://luke.geek.nz/assets/images/Azure_Environment_Concepts-8a14a53df5888d03491157996cdd2a2c.png" width="4000" height="2250" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-overview">üìù Overview<a href="https://luke.geek.nz/azure/implementing-sandbox-vending/#-overview" class="hash-link" aria-label="Direct link to üìù Overview" title="Direct link to üìù Overview">‚Äã</a></h2>
<p>When working with Microsoft Azure, you may want an environment for learning, whether for an individual or a team.</p>
<p>Cloud Sandboxes are contained, isolated environments that allow the evaluation of new Cloud services and features (without impacting production environments).</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>This follows from a previous article about <a href="https://luke.geek.nz/azure/microsoft-azure-sandbox-design-considerations/" target="_blank" rel="noopener noreferrer">Sandbox Design</a> considerations but focuses on the implementation elements. This article aims to give you some ideas on how you can achieve Sandbox vending and is opinionated based on my experience. However, it's purely intended to show one (of many) possible ways. Just make sure you understand the business requirements and what you need to achieve.</p></div></div>
<p>A design area of the Ready phase of the <a href="https://learn.microsoft.com/azure/cloud-adoption-framework/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Cloud Adoption Framework</a> is the design and implementation of the <a href="https://learn.microsoft.com/azure/cloud-adoption-framework/ready/landing-zone/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Landing Zone</a>, it would be asmiss of me not to bring up <a href="https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/landing-zone/design-area/subscription-vending?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Subscription vending</a>.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>"Subscription vending provides a platform mechanism for programmatically issuing subscriptions to application teams that need to deploy workloads."</p></div></div>
<p>Subscription Vending is the foundation of what we will discuss today: Sandbox vending.</p>
<p>I will base this article on Unmanaged Sandboxes <em>(Subscription-scoped Sandboxes)</em>; however, much of the same information can be used across all Sandbox types.</p>
<p><img decoding="async" loading="lazy" alt="Sandbox Types" src="https://luke.geek.nz/assets/images/Azure_Sandbox_Types-3ca36f3329a48acbf215c3222a060d86.png" width="4000" height="2250" class="img_ev3q"></p>
<!-- -->
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-scenario">üé¨ Scenario<a href="https://luke.geek.nz/azure/implementing-sandbox-vending/#-scenario" class="hash-link" aria-label="Direct link to üé¨ Scenario" title="Direct link to üé¨ Scenario">‚Äã</a></h2>
<p>The scenario we are going to run through today involves creating an <a href="https://luke.geek.nz/azure/microsoft-azure-sandbox-design-considerations/" target="_blank" rel="noopener noreferrer">Unmanaged</a> <em>(i.e., subscription-scoped)</em> Sandbox <em>(Sandbox vending)</em> per user or team, which could be a method of implementing it.</p>
<p>To go through this scenario, we will use the following Disciplines of <a href="https://learn.microsoft.com/azure/cloud-adoption-framework/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Cloud Adoption</a> to help separate elements.</p>
<p><img decoding="async" loading="lazy" alt="Disciplines of Cloud Governance" src="https://luke.geek.nz/assets/images/Azure_Sandbox_CloudGovernance_Disciplines-e9552882c6984c5635c744a8e1361221.png" width="4000" height="2250" class="img_ev3q"></p>
<table><thead><tr><th>Discipline</th><th>Description</th></tr></thead><tbody><tr><td>Cost Management</td><td>Cost is a primary concern for cloud users. Develop policies for cost control for all cloud platforms.</td></tr><tr><td>Security Baseline</td><td>Policies and enforcement apply those requirements across network, data, and asset configurations.</td></tr><tr><td>Resource Consistency</td><td>Resources can be configured consistently to manage risks related to onboarding, drift, discoverability, and recovery.</td></tr><tr><td>Identity Baseline</td><td>Identity Baseline discipline focuses on ensuring that identity is consistently applied across cloud adoption efforts.</td></tr><tr><td>Deployment Acceleration</td><td>Centralization, standardization, and consistency in approaches to deployment and configuration improve governance practices.</td></tr></tbody></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-cost-management">üí∞ Cost Management<a href="https://luke.geek.nz/azure/implementing-sandbox-vending/#-cost-management" class="hash-link" aria-label="Direct link to üí∞ Cost Management" title="Direct link to üí∞ Cost Management">‚Äã</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-finops">üí∞ FinOps<a href="https://luke.geek.nz/azure/implementing-sandbox-vending/#-finops" class="hash-link" aria-label="Direct link to üí∞ FinOps" title="Direct link to üí∞ FinOps">‚Äã</a></h3>
<p>When working with a Sandbox environment, you need to be aware of the costs associated with it. <a href="https://www.finops.org/framework/principles/" target="_blank" rel="noopener noreferrer">FinOps principles</a> can be key.</p>
<p><a href="https://learn.microsoft.com/azure/azure-resource-manager/management/tag-resources?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Tags</a> can be key to help you showback/chargeback costs and help you assign resource owners.</p>
<p>Recommended Tags for a Sandbox environment could be:</p>
<ul>
<li>"costCenter": "sandbox"</li>
<li>"costModel": "show-back"</li>
<li>"environment": "sandbox"</li>
<li>"resourceowner": "your_name"</li>
<li>"project": "sandbox_project"</li>
</ul>
<p>Although the Sandbox environment is for learning, you still need to be aware of its associated costs and keep these as lean as possible.</p>
<p>You can also implement Cost Management and Governance workbooks that allow Sandbox users access to interactive dashboards to help them understand their costs and usage.</p>
<ul>
<li><a href="https://microsoft.github.io/finops-toolkit/governance-workbook" target="_blank" rel="noopener noreferrer">Governance workbook</a> - Monitor the governance posture of your Azure environment. Leverage recommendations to address compliance issues.</li>
<li><a href="https://microsoft.github.io/finops-toolkit/optimization-workbook" target="_blank" rel="noopener noreferrer">Cost optimization workbook</a> - Give your engineers a single pane of glass for cost optimization with this handy Azure Monitor workbook.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-budgets">üí∞ Budgets<a href="https://luke.geek.nz/azure/implementing-sandbox-vending/#-budgets" class="hash-link" aria-label="Direct link to üí∞ Budgets" title="Direct link to üí∞ Budgets">‚Äã</a></h3>
<p>Implement <a href="https://learn.microsoft.com/azure/cost-management-billing/costs/tutorial-acm-create-budgets?tabs=psbudget&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Budgets</a> for each Sandbox, assigned to the Sandbox owner.</p>
<p>Monthly resource spending should be forecast initially and amended as the footprint changes.</p>
<p>Budget alerts are set up to highlight unplanned spending, not to prevent it <em>(i.e., they are alerting thresholds, not limits)</em>.</p>
<p>Each Sandbox environment could start with a consistent Budget and can be adjusted IF required as an exception.
Budgets are intended to drive Sandbox owners to keep their costs under control by having the information on hand.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-security-baseline">üîí Security Baseline<a href="https://luke.geek.nz/azure/implementing-sandbox-vending/#-security-baseline" class="hash-link" aria-label="Direct link to üîí Security Baseline" title="Direct link to üîí Security Baseline">‚Äã</a></h2>
<p>Security is a key concern for any environment, and the Sandbox environment is no different; however, there are some tradeoffs. The key to a successful Sandbox environment is that it's an environment for learning, so the level of security you would adopt should be less. However, there are some stop gaps that should be implemented.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-defender-for-cloud">üõ°Ô∏è Defender for Cloud<a href="https://luke.geek.nz/azure/implementing-sandbox-vending/#%EF%B8%8F-defender-for-cloud" class="hash-link" aria-label="Direct link to üõ°Ô∏è Defender for Cloud" title="Direct link to üõ°Ô∏è Defender for Cloud">‚Äã</a></h3>
<p><a href="https://learn.microsoft.com/azure/defender-for-cloud/defender-for-cloud-introduction?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Defender for Cloud</a> is a cloud-native application protection platform (CNAPP) that consists of security measures and practices designed to protect cloud-based applications from various cyber threats and vulnerabilities.</p>
<p><img decoding="async" loading="lazy" alt="Defender for Cloud" src="https://luke.geek.nz/assets/images/defender-for-cloud-pillars-ebd2a2d6c79e8ec18c23f41f291634d9.png" width="1207" height="448" class="img_ev3q"></p>
<p>Defender for Cloud should be enabled on all Sandboxes to help protect against threats and increase visibility. It is a great learning tool.</p>
<p>As people learn how to use Azure technologies, they may not necessarily know how to secure them or how their services might be adapted for a more secure environment. Defender for Cloud helps increase the knowledge around resources in alignment with <a href="https://learn.microsoft.com/azure/defender-for-cloud/alerts-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">current security best practices</a>.</p>
<blockquote>
<p>"While the security team is responsible for improving the security posture, team members might not actually implement security recommendations.
Using governance rules driven by the security team helps you to drive accountability and an SLA around the remediation process."</p>
</blockquote>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p><a href="https://learn.microsoft.com/en-us/azure/defender-for-cloud/governance-rules?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Governance rules</a> are key.</p></div></div>
<p>For example, using Tags, you could assign resource owners to resources and help drive accountability, alerts, and remediation. Defender for Cloud can be a great learning tool by informing your Sandbox users of potential security issues.</p>
<p>You should also consider possible scenarios, such as the Sandbox environment being one method to exfiltrate data, so make sure you look at <a href="https://learn.microsoft.com/purview/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Purview</a> and <a href="https://learn.microsoft.com/en-us/azure/defender-for-cloud/defender-for-storage-data-sensitivity?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">data sensitivity</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-azure-policy">üìú Azure Policy<a href="https://luke.geek.nz/azure/implementing-sandbox-vending/#-azure-policy" class="hash-link" aria-label="Direct link to üìú Azure Policy" title="Direct link to üìú Azure Policy">‚Äã</a></h3>
<p><a href="https://learn.microsoft.com/azure/governance/policy/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Policy</a> is a service in Azure that you use to create, assign, and manage policies. These policies enforce different rules and effects over your resources so those resources stay compliant with your corporate standards and service level agreements.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>I highly recommend that you deploy your policies and initiatives using <a href="https://azure.github.io/enterprise-azure-policy-as-code/" target="_blank" rel="noopener noreferrer">Azure Enterprise Policy as Code</a>.</p></div></div>
<p>There are tradeoffs with the type of Azure policies you deploy in a Sandbox environment vs what you would deploy in your Production or even Dev/Test environment; recommended policies as a base I would recommend are:</p>
<p>Reference: <a href="https://github.com/Azure/Enterprise-Scale/blob/main/docs/wiki/ALZ-Policies.md" target="_blank" rel="noopener noreferrer">ALZ policies</a></p>
<table><thead><tr><th>Assignment Name</th><th>Definition Name</th><th>Policy Type</th><th>Description</th><th>Effect(s)</th></tr></thead><tbody><tr><td><strong>Enforce ALZ Sandbox Guardrails</strong></td><td><strong>Enforce policies in the Sandbox Landing Zone</strong></td><td><code>Policy Definition Set,</code> <strong>Custom</strong></td><td>This initiative will help enforce and govern subscriptions that are placed within the Sandbox Management Group. Policies included: <ul><li>Deny vNET peering across subscriptions</li><li>Deny the deployment of vWAN/ER/VPN gateways.</li></ul></td><td>Enforce</td></tr></tbody></table>
<table><thead><tr><th>Assignment Name</th><th>Definition Name</th><th>Policy Type</th><th>Description</th><th>Effect(s)</th></tr></thead><tbody><tr><td><strong>Enforce ALZ Decommissioned Guardrails</strong></td><td><strong>Enforce policies in the Decommissioned Landing Zone</strong></td><td><code>Policy Definition Set,</code> <strong>Custom</strong></td><td>This initiative will help enforce and govern subscriptions that are placed within the decommissioned Management Group as part of your Subscription decommissioning process. Policies included: <ul><li>Deny the deployment of new resources</li><li>Deploy an auto VM shutdown policy at UTC 00:00</li></ul></td><td>Enforce</td></tr></tbody></table>
<p>The Decommissioned Management group is where you would move your Sandbox subscriptions once they are no longer required and you want to decommission them.</p>
<p><img decoding="async" loading="lazy" alt="Azure Policy - Azure Landing Zones - Initiative" src="https://luke.geek.nz/assets/images/AzurePolicy_ALZSandboxIniiative-8d8de7a7effabe552851d520910029d8.png" width="1166" height="498" class="img_ev3q"></p>
<p>Key policies are part of the ALZ Sandbox Guardrails, which are essentially the policies to restrict the deployment of network resources. These policies would allow you to link virtual networks to on-premises, peer-to-peer virtual networks and allow Sandbox users to connect to production virtual networks or virtual networks outside your organization's control.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-terms-of-use">üìú Terms of use<a href="https://luke.geek.nz/azure/implementing-sandbox-vending/#-terms-of-use" class="hash-link" aria-label="Direct link to üìú Terms of use" title="Direct link to üìú Terms of use">‚Äã</a></h3>
<p>Make sure you don't forget about the People/Processes of your sandbox. You should implement Terms of Use for the Sandbox environment so that users understand the rules and regulations of the environment, such as 'Do not store Production data'.</p>
<p>You can combine this directly into the Azure Portal login experience by using <a href="https://learn.microsoft.com/en-us/entra/identity/conditional-access/terms-of-use?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Microsoft Entra terms of use</a>.</p>
<p><img decoding="async" loading="lazy" alt="Microsoft Entra - Terms of use" src="https://luke.geek.nz/assets/images/user-tou-0335508519c8d3feed95ed2401942df4.png" width="1372" height="838" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-resource-consistency">üîÑ Resource Consistency<a href="https://luke.geek.nz/azure/implementing-sandbox-vending/#-resource-consistency" class="hash-link" aria-label="Direct link to üîÑ Resource Consistency" title="Direct link to üîÑ Resource Consistency">‚Äã</a></h2>
<p>Resource Consistency is key. It ensures that resources are configured consistently to manage onboarding, drift, discoverability, and recovery risks.</p>
<p>This is where a lot of automation comes into play to prevent drift and inconsistencies in creating (and decommissioning) a Sandbox environment.</p>
<p><img decoding="async" loading="lazy" alt="Azure DevOps Pipeline - Sandbox" src="https://luke.geek.nz/assets/images/ResourceConsistency_SBX_ADOPipelines-e66d08ed0d8ae21e1e243967604f23be.png" width="4000" height="2250" class="img_ev3q"></p>
<p>Ideally, you would have a user interface where a user could request a Sandbox environment <em>(I will talk more about this in the deployment acceleration section)</em>, which would trigger an Azure DevOps pipeline or GitHub action, as an example, to create the environment.</p>
<p>Using Infrastructure as Code <em>(IaC)</em>, you can ensure that the environment is consistent and repeatable and can be provisioned and decommissioned.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-enterprise-policy-as-code">üìö Enterprise Policy as Code<a href="https://luke.geek.nz/azure/implementing-sandbox-vending/#-enterprise-policy-as-code" class="hash-link" aria-label="Direct link to üìö Enterprise Policy as Code" title="Direct link to üìö Enterprise Policy as Code">‚Äã</a></h3>
<p><a href="https://learn.microsoft.com/azure/cloud-adoption-framework/ready/policy-management/enterprise-policy-as-code?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Enterprise Policy as Code or EPAC</a> for short comprises a number of scripts which can be used in CI/CD based system or a semi-automated use to deploy Policies, Policy Sets, Assignments, Policy Exemptions and Role Assignments.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>This is a solution created by Microsoft employees but without Microsoft's official support as an open-source initiative.</p></div></div>
<p>EPAC is designed for organizations with a large number of Policies, Policy Sets, and Assignments. It is also designed for organizations with multiple tenants and/or environments. The solution primarily consists of PowerShell scripts intended to run operations such as policy planning, deployment, and sync of external policies, such as Enterprise Landing Zone policies, into the EPAC repo.</p>
<p>Enterprise Policy as Code can also be used to control exemptions. An example is running this nightly; any policies or exemptions not in the repository are removed.</p>
<p>Enterprise Policy as Code could be used for Sandbox environments, providing an opportunity to clean up outdated policies, assignments, and exemptions and maintain consistency.</p>
<p><img decoding="async" loading="lazy" alt="Enterprise Policy as Code - Sandbox" src="https://luke.geek.nz/assets/images/SandboxPolicy_EPAC-ed7330acd413862edc53f896f17f3cff.gif" width="1685" height="741" class="img_ev3q"></p>
<p>Feel free to refer a blog post, I did previously on <a href="https://luke.geek.nz/azure/enterprise-policy-code-azure-devops/" target="_blank" rel="noopener noreferrer">Enterprise Policy as Code, with Azure DevOps</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-azure-devopsgithub">üõ†Ô∏è Azure DevOps/GitHub<a href="https://luke.geek.nz/azure/implementing-sandbox-vending/#%EF%B8%8F-azure-devopsgithub" class="hash-link" aria-label="Direct link to üõ†Ô∏è Azure DevOps/GitHub" title="Direct link to üõ†Ô∏è Azure DevOps/GitHub">‚Äã</a></h3>
<p><a href="https://azure.microsoft.com/products/devops?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure DevOps</a> or <a href="https://github.com/" target="_blank" rel="noopener noreferrer">GitHub</a>, both offer features, such as Boards/Discussions, Code Repos, Pipelines <em>(or Actions)</em> which can be used as a platform, for IaC <em>(Infrastructure as Code)</em> and CI/CD <em>(Continous Integration and Continous Deployment)</em>, and is definitely recommended to be factored in your Sandbox design, when it comes to automation and desired state of your Sandbox environment.</p>
<p>The following automation recommendations assume you have access to Azure DevOps or GitHub <em>(or similar)</em>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-symphony">üéº Symphony<a href="https://luke.geek.nz/azure/implementing-sandbox-vending/#-symphony" class="hash-link" aria-label="Direct link to üéº Symphony" title="Direct link to üéº Symphony">‚Äã</a></h3>
<p>A large part of the Sandbox vending is a DevOps pipeline and connectivity to Azure that allows Terraform and the pipeline in Azure DevOps to connect to make changes in Azure. Terraform is the car, and Symphony is the road that it travels on.</p>
<p><a href="https://github.com/microsoft/symphony" target="_blank" rel="noopener noreferrer">Symphony</a> is a framework and set of patterns and best practices for developing, testing, and deploying infrastructure on Azure using Infrastructure as Code <em>(IAC)</em> It includes modern DevOps practices for IAC such as Main and Pull Request workflows, IaC Code Validation &amp; Linting, Automated Testing, Security Scanning, Multi-environment deployments, modules dependencies and more. A mature workflow for IAC not only automates the deployment of the IAC resources but also incorporates engineering fundamentals, resource validation, dependency management, test execution, security scanning, and more.</p>
<p>The Symphony pipelines for Azure DevOps and Terraform, for example, are:</p>
<table><thead><tr><th>Pipeline Name</th><th>Comments</th></tr></thead><tbody><tr><td>pipeline.ci.terraform.yml</td><td>This YAML file defines a Continuous Integration (CI) pipeline for Azure DevOps, which triggers changes to the main branch, sets up certain variables, and executes several stages, including validation of configuration and preview deployment using Terraform templates. This file is the command file, triggering the other pipelines.</td></tr><tr><td>pipeline.destroy.terraform.yml</td><td>This YAML file defines a pipeline in Azure DevOps that uses a specific agent image to run a job based on a template for destroying a Terraform environment, with the environment details and key vault information passed as parameters. The pipeline does not trigger automatically on any branch or pull request changes.</td></tr><tr><td>template.terraform.previewdeploy.yml</td><td>This YAML file defines a job in an Azure DevOps pipeline that sets up a clean workspace, installs Terraform and Go, retrieves secrets from an Azure Key Vault, updates network rules and storage account settings, and executes a Terraform plan and apply operation. It also cleans up by removing the agent IP from the Key Vault and denying public access to the Terraform DevOps Storage after the job is done.</td></tr><tr><td>template.terraform.report.yml</td><td>This YAML file defines a job in an Azure DevOps pipeline that, depending on a condition, cleans the workspace, retrieves secrets from an Azure Key Vault, and executes a bash script to backup the state files of a specified environment using Terraform.</td></tr><tr><td>template.terraform.test.yml</td><td>This YAML file defines an end-to-end test job in an Azure DevOps pipeline that sets up a clean workspace, installs Terraform and Go, retrieves secrets from an Azure Key Vault, adds the agent IP to the Key Vault and storage account, runs tests, publishes the test results, and finally removes the agent IP from the Key Vault and storage account.</td></tr><tr><td>template.terraform.validate.yml</td><td>This YAML file defines a validation job in an Azure DevOps pipeline that sets up a clean workspace, installs necessary tools, runs GitLeaks for code analysis, adds the agent IP to a Key Vault, runs Terraform lint and validate, optionally runs layer tests, publishes test results, and finally removes the agent IP from the Key Vault and denies public access to the Terraform DevOps Storage.</td></tr></tbody></table>
<p>Using a framework such as Symphony gives you a good starting point for your deployments.</p>
<p><img decoding="async" loading="lazy" alt="Symphony - Prestep" src="https://luke.geek.nz/assets/images/Azure_Sandbox_Symphony_Prestep-a29849b2b838befc80dbd28876732690.png" width="1002" height="190" class="img_ev3q">
<img decoding="async" loading="lazy" alt="Symphony - Preview &amp;amp; Deploy" src="https://luke.geek.nz/assets/images/Azure_Sandbox_Symphony_PreviewandDeploy-6946810c4b662519f60539042cf8284b.png" width="1721" height="227" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-terraform">üèóÔ∏è Terraform<a href="https://luke.geek.nz/azure/implementing-sandbox-vending/#%EF%B8%8F-terraform" class="hash-link" aria-label="Direct link to üèóÔ∏è Terraform" title="Direct link to üèóÔ∏è Terraform">‚Äã</a></h3>
<p><a href="https://learn.microsoft.com/azure/azure-resource-manager/bicep/overview?tabs=bicep&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Bicep</a> and <a href="https://www.terraform.io/" target="_blank" rel="noopener noreferrer">Terraform</a> are both tools used for infrastructure-as-code (IaC), which means they allow you to define and manage your cloud infrastructure using code. Both are declarative, meaning you define the desired state of your infrastructure and the tool figures out how to make it so. Bicep is more focused on Microsoft Azure, while Terraform is more focused on multi-cloud.</p>
<p>For this article, I will focus on Terraform, based purely on work done with it around Sandbox provisioning and decommissioning. The Terraform state file helps with a lot of the Sandbox decommissioning aspect.</p>
<p>Terraform modules that can be used during Sandbox provisioning are:</p>
<table><thead><tr><th>Name</th><th>Link</th></tr></thead><tbody><tr><td>azuread</td><td><a href="https://registry.terraform.io/providers/hashicorp/azuread/latest" target="_blank" rel="noopener noreferrer">https://registry.terraform.io/providers/hashicorp/azuread/latest</a></td></tr><tr><td>azurerm</td><td><a href="https://registry.terraform.io/providers/hashicorp/azurerm/latest" target="_blank" rel="noopener noreferrer">https://registry.terraform.io/providers/hashicorp/azurerm/latest</a></td></tr><tr><td>random</td><td><a href="https://registry.terraform.io/providers/hashicorp/random/latest" target="_blank" rel="noopener noreferrer">https://registry.terraform.io/providers/hashicorp/random/latest</a></td></tr><tr><td>time</td><td><a href="https://registry.terraform.io/providers/hashicorp/time/latest" target="_blank" rel="noopener noreferrer">https://registry.terraform.io/providers/hashicorp/time/latest</a></td></tr><tr><td>Azure/lz-vending/azurerm</td><td><a href="https://registry.terraform.io/modules/Azure/lz-vending/azurerm/latest" target="_blank" rel="noopener noreferrer">https://registry.terraform.io/modules/Azure/lz-vending/azurerm/latest</a></td></tr></tbody></table>
<p>The real foundation of Sandbox vending is the <a href="https://github.com/Azure/terraform-azurerm-lz-vending" target="_blank" rel="noopener noreferrer">Azure/terraform-azurerm-lz-vending</a> Terraform module.</p>
<p>It can be used to create Azure resources according to the landing zone <em>(Sandbox)</em> vending pattern. It can be used to provision resources such as subscriptions, management group associations, role assignments, and virtual networks.</p>
<p>Here is an example <em>(partial snippet of an overall solution)</em> of how you COULD use the module by having multiple YAML files per Sandbox and using a for_each loop to create each Sandbox environment:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># This module is used to create resources in Azure according to the landing zone vending pattern.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">module</span><span class="token keyword type variable" style="color:rgb(189, 147, 249);font-style:italic"> "lz_vending" </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The source and version of the module.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">source</span><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Azure/lz-vending/azurerm"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">version</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"4.0.2"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The for_each loop allows us to create multiple instances of this module, one for each item in the landing_zone_data_map.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">for_each</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> local.landing_zone_data_map</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The location where the resources will be created.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">location</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> var.location</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Subscription variables.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Enables the resource provider creation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">subscription_register_resource_providers_enabled</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The map of resource providers to register.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">subscription_register_resource_providers_and_features</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> var.subscription_register_resource_providers_and_features</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Enables the creation of a subscription alias.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">subscription_alias_enabled</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The billing scope for the subscription.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">subscription_billing_scope</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"/providers/Microsoft.Billing/billingAccounts/0000000/enrollmentAccounts/</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">$</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string interpolation" style="color:rgb(255, 121, 198)">each</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation" style="color:rgb(255, 121, 198)">value</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation" style="color:rgb(255, 121, 198)">billing_enrollment_account</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The display name for the subscription. It is converted to lowercase to maintain consistency.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">subscription_display_name</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> (</span><span class="token string" style="color:rgb(255, 121, 198)">"SUB-Contoso-</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">$</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string interpolation" style="color:rgb(255, 121, 198)">each</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation" style="color:rgb(255, 121, 198)">value</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation" style="color:rgb(255, 121, 198)">name</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string" style="color:rgb(255, 121, 198)">_</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">$</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string interpolation keyword" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation type variable" style="color:rgb(189, 147, 249);font-style:italic">env</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string" style="color:rgb(255, 121, 198)">-001"</span><span class="token plain">)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The alias name for the subscription. It is also converted to lowercase.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">subscription_alias_name</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> (</span><span class="token string" style="color:rgb(255, 121, 198)">"SUB-Contoso</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">$</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string interpolation" style="color:rgb(255, 121, 198)">each</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation" style="color:rgb(255, 121, 198)">value</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation" style="color:rgb(255, 121, 198)">name</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string" style="color:rgb(255, 121, 198)">_</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">$</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string interpolation keyword" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation type variable" style="color:rgb(189, 147, 249);font-style:italic">env</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string" style="color:rgb(255, 121, 198)">-001"</span><span class="token plain">)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The workload type for the subscription.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">subscription_workload</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> each.value.workload</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Management group association variables.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Enables the association of the subscription with a management group.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">subscription_management_group_association_enabled</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The ID of the management group to associate with the subscription.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">subscription_management_group_id</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> each.value.management_group_id</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Tags to apply to the subscription. The Owner tags are set to the owner of the workload.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">subscription_tags</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> merge(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    var.tags,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"resource-owner"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> each.value.owner,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"expiry_date"</span><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> each.value.expiry_date</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Role assignment variables.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">role_assignment_enabled</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">role_assignments</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># using role definition name, created at subscription scope</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">contrib_user_sub</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">principal_id</span><span class="token plain">   </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> azuread_group.contributor</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">each.key</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">.id</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">definition</span><span class="token plain">     </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Contributor"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">relative_scope</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">""</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Virtual network variables.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Enables the creation of a virtual network.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">virtual_network_enabled</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Enables the creation of a network watcher resource group.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">network_watcher_resource_group_enabled</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The details of the virtual network to create.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">virtual_networks</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">one</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)"># The name of the virtual network. It is converted to lowercase.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">name</span><span class="token plain">                        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> lower(</span><span class="token string" style="color:rgb(255, 121, 198)">"vnet-</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">$</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string interpolation keyword" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation type variable" style="color:rgb(189, 147, 249);font-style:italic">env</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string" style="color:rgb(255, 121, 198)">-</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">$</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string interpolation" style="color:rgb(255, 121, 198)">each</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation" style="color:rgb(255, 121, 198)">value</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation" style="color:rgb(255, 121, 198)">name</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain">)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">resource_group_lock_enabled</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)"># The address space for the virtual network.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">address_space</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">"192.168.1.0/24"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)"># The name of the resource group where the virtual network will be created. It is converted to lowercase.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">resource_group_name</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> lower(</span><span class="token string" style="color:rgb(255, 121, 198)">"rg-contoso-networks-</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">$</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string interpolation keyword" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation type variable" style="color:rgb(189, 147, 249);font-style:italic">env</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string" style="color:rgb(255, 121, 198)">-aue-001"</span><span class="token plain">)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)"># The location where the virtual network will be created.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">location</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> var.location</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This will create a Subscription, Resource Group, and define Contributor access, based on data from a data map, that looks at each YAML file in a folder.</p>
<p>"for_each = local.landing_zone_data_map" - This is the key part, as it allows you to create multiple instances of the module, one for each item in the landing_zone_data_map.</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">locals</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># landing_zone_data_dir is the directory containing the YAML files for the landing zones.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># It is set to the root directory of the current Terraform project.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">landing_zone_data_dir</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> path.root</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># landing_zone_data_map is a map that stores the decoded YAML data from each landing zone file.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># It uses a for loop to iterate over each file in the landing_zone_files list.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># For each file, it reads the contents of the file using the file function and decodes the YAML data using the yamldecode function.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The file path is constructed by concatenating the landing_zone_data_dir and the file name.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The decoded YAML data is then stored in the landing_zone_data_map with the file name as the key.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">landing_zone_data_map</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    for f in local.landing_zone_files :</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">f</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain">&gt; yamldecode(file(</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">$</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string interpolation keyword" style="color:rgb(189, 147, 249);font-style:italic">local</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation type variable" style="color:rgb(189, 147, 249);font-style:italic">landing_zone_data_dir</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string" style="color:rgb(255, 121, 198)">/</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">$</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string interpolation" style="color:rgb(255, 121, 198)">f</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain">))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># landing_zone_files is the list of landing zone YAML files to be processed.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># It uses the fileset function to find all files in the landing_zone_data_dir that match the pattern "landing_zone_*.yaml".</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">landing_zone_files</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> fileset(local.landing_zone_data_dir, </span><span class="token string" style="color:rgb(255, 121, 198)">"sbx_landing_zone_*.yaml"</span><span class="token plain">)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Here is an example YAML file:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> SandboxOwner1 </span><span class="token comment" style="color:rgb(98, 114, 164)"># Name of the landing zone. No spaces.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">workload</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> DevTest </span><span class="token comment" style="color:rgb(98, 114, 164)"># Type of subscription for the landing zone (DevTest vs Production (PAY AS YOU GO)). Most Sandboxes will be Production (Pay As You Go), unless all users have a Visual Studio Enterprise subscription.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">owner</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> admin@contoso.com </span><span class="token comment" style="color:rgb(98, 114, 164)"># Owner of the landing zone</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">billing_enrollment_account</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">123456</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Billing enrollment account for the landing zone. Limit of 5000 API requests for new subscriptions. Later Subscriptions may need a new billing enrollment.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">management_group_id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Unmanaged</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">Sandbox </span><span class="token comment" style="color:rgb(98, 114, 164)"># Management group ID for the landing zone</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">budget_amount</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">1000</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Budget amount for the landing zone, numerical value</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">expiry_date</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token datetime number">2024-10-16</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># The date when the landing zone will expire, the default should be 3 months from the date of provisioning. After this date, resources may be automatically cleaned up.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">cost-centre</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Contoso (Cloud) </span><span class="token comment" style="color:rgb(98, 114, 164)"># Cost center for the landing zone</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">cost-model</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> show</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">back </span><span class="token comment" style="color:rgb(98, 114, 164)"># Cost model for the landing zone</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This is a very basic example, but it gives you an idea of how you could use the module to create a Subscription and Resource Group and define Contributor access based on data from a data map that looks at each YAML file in a folder. The Expiry date is used as part of the Sandbox decommissioning process and also added as a Tag to the Subscription, along with the Owner, which can also be used as an email recipient of a Budget.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>There is a <a href="https://learn.microsoft.com/azure/cost-management-billing/manage/programmatically-create-subscription-enterprise-agreement?tabs=rest&amp;WT.mc_id=AZ-MVP-5004796#limitations-of-azure-enterprise-subscription-creation-api" target="_blank" rel="noopener noreferrer">limit</a> to the number of API requests you can make to create a new subscription, so you may need to create a new billing enrollment account if you hit this limit, which is why its included in the yaml.</p></div></div>
<p>Using this method, you can create a new Sandbox environment by creating a new YAML file, running the Terraform apply command, and decommissioning the environment by removing the YAML file and running the Terraform apply command again.</p>
<p>For the decommissioning, you can run a separate pipeline to check the expiry of the YAML file, then delete it if it's past its due date, which could then trigger the removal.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-identity-baseline">üë§ Identity Baseline<a href="https://luke.geek.nz/azure/implementing-sandbox-vending/#-identity-baseline" class="hash-link" aria-label="Direct link to üë§ Identity Baseline" title="Direct link to üë§ Identity Baseline">‚Äã</a></h2>
<p>To connect to your Sandbox environment, you need to ensure that you have the correct Identity Baseline in place.</p>
<p>I recommend you merge your Sandbox identity access, i.e. Entra ID Groups, Access packages, etc., into your IaC pipelines so that access is granted automatically when a new Sandbox environment is created and removed when no longer required.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-entitlement-management">üë• Entitlement Management<a href="https://luke.geek.nz/azure/implementing-sandbox-vending/#-entitlement-management" class="hash-link" aria-label="Direct link to üë• Entitlement Management" title="Direct link to üë• Entitlement Management">‚Äã</a></h3>
<p><a href="https://learn.microsoft.com/en-us/entra/id-governance/entitlement-management-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Entitlement management</a> is an identity governance feature that enables organizations to manage identity and access lifecycle at scale, by automating access request workflows, access assignments, reviews, and expiration.</p>
<p><img decoding="async" loading="lazy" alt="Entitlement Management" src="https://luke.geek.nz/assets/images/Azure_Sandbox_IAM_EntitlementManagement-3a3fbc032980fedbf153fe5d90324647.png" width="4000" height="2250" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-access-packages">üì¶ Access packages<a href="https://luke.geek.nz/azure/implementing-sandbox-vending/#-access-packages" class="hash-link" aria-label="Direct link to üì¶ Access packages" title="Direct link to üì¶ Access packages">‚Äã</a></h3>
<p>With an access package, an administrator or delegated access package manager lists the resources (groups, apps, and sites), and the roles the users need for those resources.
Access packages also include one or more policies. A policy defines the rules or guardrails for assigning access to an access package. Each policy can be used to ensure that only the appropriate users can have access to assignments. Access is time-limited and will expire if not renewed.</p>
<p><img decoding="async" loading="lazy" alt="Access Packages" src="https://luke.geek.nz/assets/images/Azure_Sandbox_IAM_AccessPackages-58def0c07c76fe116fd7faea813d5c17.png" width="4000" height="2250" class="img_ev3q"></p>
<p>You can use Access packages to grant access to your Sandbox environment and then remove access when the environment is no longer required.</p>
<p>Access Packages can be used to delegate access to each Sandbox environment to its owner. This allows Sandbox owners, who may have financial delegation, to control who has access to their environment and remove that access when no longer required.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-conditional-access">üîí Conditional Access<a href="https://luke.geek.nz/azure/implementing-sandbox-vending/#-conditional-access" class="hash-link" aria-label="Direct link to üîí Conditional Access" title="Direct link to üîí Conditional Access">‚Äã</a></h3>
<p>Make sure you factor Conditional Access into your Sandbox design by making sure that only the users who may be using compliant devices or from trusted networks can access the environment.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-deployment-acceleration">üöÄ Deployment Acceleration<a href="https://luke.geek.nz/azure/implementing-sandbox-vending/#-deployment-acceleration" class="hash-link" aria-label="Direct link to üöÄ Deployment Acceleration" title="Direct link to üöÄ Deployment Acceleration">‚Äã</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-onboarding-self-service">üñ•Ô∏è Onboarding self-service<a href="https://luke.geek.nz/azure/implementing-sandbox-vending/#%EF%B8%8F-onboarding-self-service" class="hash-link" aria-label="Direct link to üñ•Ô∏è Onboarding self-service" title="Direct link to üñ•Ô∏è Onboarding self-service">‚Äã</a></h3>
<p>Onboarding of a new Sandbox environment could be automated from start to end, using a self-service portal. An example is:</p>
<p>A <a href="https://learn.microsoft.com/power-apps/powerapps-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">PowerApp</a> that allows a user to request a new Sandbox environment, by filling in a form, that then triggers a <a href="https://learn.microsoft.com/power-automate/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">PowerAutomate</a> flow, to gain approval, and then creates a new YAML file, in a folder, that then triggers a Terraform apply command, to create the new Sandbox environment.</p>
<p><img decoding="async" loading="lazy" alt="Cloud Landing Zone Request - PowerApp" src="https://luke.geek.nz/assets/images/Azure_SandboxPowerApps-03eff2da8da6f063c4081fc6b8660235.png" width="1765" height="992" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="reference-links">üìñReference Links<a href="https://luke.geek.nz/azure/implementing-sandbox-vending/#reference-links" class="hash-link" aria-label="Direct link to üìñReference Links" title="Direct link to üìñReference Links">‚Äã</a></h2>
<ul>
<li><a href="https://www.youtube.com/watch?v=dkNAnw1InA0" target="_blank" rel="noopener noreferrer">Azure Sandbox Environment - Turbo360 Podcast</a></li>
</ul>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Change the Timezone of your Azure Container App]]></title>
            <link>https://luke.geek.nz/azure/change-timezone-azure-container-app/</link>
            <guid>https://luke.geek.nz/azure/change-timezone-azure-container-app/</guid>
            <pubDate>Sat, 06 Apr 2024 08:52:05 GMT</pubDate>
            <description><![CDATA[This article provides a guide on how to change the timezone of your Azure Container App. It includes reasons why you might need to do this, a step-by-step process, and references for further reading.]]></description>
            <content:encoded><![CDATA[<p>Updating the timezone of your Azure Container Apps containers might not be a common operation, but there are scenarios where it could be necessary.</p>
<p>Example scenarios on why you may want to update the Timezone (from UTC) to another timezone may be because of the following:</p>
<ul>
<li>Application requirements</li>
<li>Logging and debugging concerns</li>
<li>Compliance and regulations
Or general application testing and development</li>
</ul>
<p>You could have this built into the container itself, which would be preferred to keep a consistent experience and to work with any time offset that may be needed (daylight savings, etc), but you can update the container environment.</p>
<p>üì∫ To demo this, I am using a Container App Environment and a Container App using the 'Simple hello world container' quickstart image.</p>
<p>My revision mode is set to Single; however, the same steps can be applied with multiple revision modes. Just ensure you test and update the right revision or the date change may not be applied.</p>
<p>To update the timezone, we will be the 'TZ' Environment variable, and this change will trigger a new Revision.</p>
<p>First, let us check the current timezone of the container app by running the following command <em>(on a running Container App)</em> from the Console:</p>
<div class="language-PowerShell language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">    date</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Check Time/date" src="https://luke.geek.nz/assets/images/Update_AzContainerAppTimeZone-Before-95e71d7e58d2ecfc9f2acce713268128.gif" width="1820" height="964" class="img_ev3q"></p>
<p>This will return the current date and time in UTC.</p>
<p>Now, let us update the Timezone. To do that, we need to specify the timezone in the TZ database format; to find this format, we can use sites like <a href="https://en.wikipedia.org/wiki/List_of_tz_database_time_zones" target="_blank" rel="noopener noreferrer">Wikipedia</a> or <a href="https://timezone.mariushosting.com/" target="_blank" rel="noopener noreferrer">mariushosting Docker Time Zone (TZ)</a>, as I am based in New Zealand, I will be using: Pacific/Auckland.</p>
<p><img decoding="async" loading="lazy" alt="Timezone - Pacific/Auckland" src="https://luke.geek.nz/assets/images/mariushostingDockerTimeZoneNZ-1d69b9f5b7a40c3e28c103d7470619c0.png" width="1371" height="742" class="img_ev3q"></p>
<p>To do this:</p>
<div class="theme-admonition theme-admonition-danger admonition_xJq3 alert alert--danger"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>danger</div><div class="admonitionContent_BuS1"><p>‚ö†Ô∏è If you're using Single Revision mode: This may trigger an outage, during the creation of a new revision, make sure you test this in a safe environment.</p></div></div>
<ol>
<li><strong>Navigate</strong> to your <strong>Container App</strong> in the Azure Portal</li>
<li>Click on <strong>Containers</strong></li>
<li>Click <strong>Edit and Deploy</strong></li>
<li>Click your <strong>Container image</strong></li>
<li>Navigate down to <strong>Environment variables</strong></li>
<li><strong>Add</strong>: <strong>TZ</strong> with the value of your <strong>timezone</strong> <em>(Manual Entry, although you could also have this as a Secret in a KeyVault)</em>.</li>
<li>Click <strong>Save</strong></li>
<li>Click <strong>Create</strong> to create your Revision</li>
<li>You can then navigate back to the Console and type in Date to confirm the timezone has been updated.</li>
</ol>
<p><img decoding="async" loading="lazy" alt="Update Azure Container Apps - Timezone" src="https://luke.geek.nz/assets/images/Update_AzContainerAppTimeZone-a07fc34a0c2548c427afa0fcc0212b69.gif" width="1820" height="964" class="img_ev3q"></p>
<p>üìñ References:</p>
<ul>
<li><a href="https://support.circleci.com/hc/en-us/articles/115015771347-How-do-I-set-the-timezones-in-Docker-images" target="_blank" rel="noopener noreferrer">Default timezone in Docker containers</a></li>
<li><a href="https://stackoverflow.com/questions/57607381/how-do-i-change-timezone-in-a-docker-container" target="_blank" rel="noopener noreferrer">How do I change timezone in a docker container?</a></li>
</ul>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Azure Container Apps - Overview]]></title>
            <link>https://luke.geek.nz/azure/azure-container-apps-overview/</link>
            <guid>https://luke.geek.nz/azure/azure-container-apps-overview/</guid>
            <pubDate>Tue, 02 Apr 2024 09:15:09 GMT</pubDate>
            <description><![CDATA[Overview of Azure Container Apps and some of the Cloud Native ecosystem.]]></description>
            <content:encoded><![CDATA[<p><a href="https://learn.microsoft.com/azure/container-apps/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Container Apps</a>, <a href="https://keda.sh/" target="_blank" rel="noopener noreferrer">KEDA</a>, and <a href="https://dapr.io/" target="_blank" rel="noopener noreferrer">Dapr</a> ‚Äî what are these, and how do they work together? This article aims to give a high-level insight into Azure Container Apps and some of the <a href="https://landscape.cncf.io/" target="_blank" rel="noopener noreferrer">Cloud Native ecosystem</a> that surrounds this container orchestrator.</p>
<p><img decoding="async" loading="lazy" alt="Azure Container Apps - Overview" src="https://luke.geek.nz/assets/images/ACA_BlogHeading_Overview-fb813fccf27d0516ff4e0a6463e03073.png" width="1280" height="720" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>‚Äú<a href="https://learn.microsoft.com/azure/container-apps/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Container Apps</a> is a fully managed <a href="https://kubernetes.io/" target="_blank" rel="noopener noreferrer">Kubernetes-based</a> application platform that helps you deploy apps from code or containers without orchestrating complex infrastructure.‚Äù</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-understanding-azure-container-apps">‚òÅÔ∏è Understanding Azure Container Apps<a href="https://luke.geek.nz/azure/azure-container-apps-overview/#%EF%B8%8F-understanding-azure-container-apps" class="hash-link" aria-label="Direct link to ‚òÅÔ∏è Understanding Azure Container Apps" title="Direct link to ‚òÅÔ∏è Understanding Azure Container Apps">‚Äã</a></h2>
<p>In this section, we will take a look at the following:</p>
<ul>
<li>Overview of Microservices</li>
<li>Getting started with Container APPS</li>
<li>Differences between ACA and other Azure container solutions</li>
</ul>
<p><img decoding="async" loading="lazy" alt="Understanding Azure Container Apps" src="https://luke.geek.nz/assets/images/ACA_Overview_UnderstandingAzContainerApps-205fbccd7ac73366d5a31d296332d0ad.png" width="1280" height="720" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p><a href="https://learn.microsoft.com/azure/container-apps/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Container Apps</a> is a fully managed serverless container service for building and deploying modern apps at scale&nbsp;- without managing infrastructure. It is built on top of Kubernetes and provides a simple, fully managed experience for deploying containerized applications.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-monoliths-microservices-and-containers-huh">ü§î Monoliths, Microservices and Containers? Huh?<a href="https://luke.geek.nz/azure/azure-container-apps-overview/#-monoliths-microservices-and-containers-huh" class="hash-link" aria-label="Direct link to ü§î Monoliths, Microservices and Containers? Huh?" title="Direct link to ü§î Monoliths, Microservices and Containers? Huh?">‚Äã</a></h3>
<p>To understand why we might need Container Apps, we need to go back to some of the elements of software development.</p>
<p>Containers can be a valuable tool for deploying and managing microservices, but they are not always necessary. Let's explore why you may not need containers for microservices and how they can generally help.</p>
<p>Microservices architecture is a software development approach where an application is built as a collection of small, loosely coupled services that can be developed, deployed, and scaled independently. Each microservice focuses on a specific business capability and communicates with other microservices through well-defined APIs.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>While containers are not always necessary for deploying microservices, they offer benefits such as isolation, portability, scalability, and deployment consistency. Evaluating your specific requirements, existing infrastructure, and resource constraints will help determine whether containers are the right choice for your microservices architecture, and is intended to help you understand how it could be used, especially around some of the Cloud Native integration components.</p></div></div>
<p><strong>Why you may not need containers for microservices:</strong></p>
<ul>
<li>Simplicity: If your microservices are developed using a single programming language or framework and can be easily deployed on traditional servers or virtual machines, containers may not be necessary. In such cases, deploying microservices directly on servers or virtual machines can be simpler and more straightforward.</li>
<li>Existing Infrastructure: If you already have a well-established infrastructure with efficient deployment processes and tools in place, containers may not be required. Leveraging your existing infrastructure can save time and effort in adopting and managing container technologies.</li>
<li>Resource Constraints: Containers introduce additional overhead in terms of resource utilization. If you have limited resources or strict resource constraints, deploying microservices directly on servers or virtual machines may be more efficient.</li>
</ul>
<p><strong>However, how containers can generally help with microservices:</strong></p>
<ul>
<li>Isolation: Containers provide a lightweight and isolated runtime environment for each microservice. This isolation ensures that changes or issues in one microservice do not affect others, improving overall system stability.</li>
<li>Portability: Containers encapsulate the dependencies and runtime environment required by a microservice, making it highly portable. Microservices packaged as containers can be easily deployed and run on different platforms, such as local development machines, cloud environments, or on-premises servers.</li>
<li>Scalability: Containers enable easy scaling of microservices. With container orchestration platforms like Kubernetes, you can dynamically scale the number of containers running a specific microservice based on demand, ensuring optimal resource utilization.</li>
<li>Deployment Consistency: Containers provide a consistent deployment model, ensuring that the microservice runs the same way across different environments. This consistency simplifies the deployment process and reduces the chances of configuration-related issues.</li>
</ul>
<p>First, let's take a look at Monoliths.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-monoliths">üè¢ Monoliths<a href="https://luke.geek.nz/azure/azure-container-apps-overview/#-monoliths" class="hash-link" aria-label="Direct link to üè¢ Monoliths" title="Direct link to üè¢ Monoliths">‚Äã</a></h4>
<p><img decoding="async" loading="lazy" alt="Azure Container Apps - What is a Monolith?" src="https://luke.geek.nz/assets/images/ACA_Overview_UnderstandingWhatIsAMonolith-1793a09d888a656f65fcd3415ca5f140.PNG" width="1280" height="720" class="img_ev3q"></p>
<p>"In software engineering, a monolithic application is a single unified software application that is self-contained and independent from other applications but typically lacks flexibility"‚ÄîWikipedia.</p>
<p><img decoding="async" loading="lazy" alt="Monolith shortcomings" src="https://luke.geek.nz/assets/images/ACA_Overview_Monolith_Shortcomings-0852c45a008051947c103f82e9761333.PNG" width="1280" height="720" class="img_ev3q"></p>
<p>Generally, monolithic architectures suffer from drawbacks that can delay application development and deployment. These drawbacks become especially significant when the product's complexity increases or when the development team grows in size.</p>
<p>The codebase of monolithic applications can be difficult to understand because it may be extensive. This can make it difficult for new developers to modify the code to meet changing business or technical requirements.</p>
<p>As requirements evolve or become more complex, it becomes difficult to correctly implement changes without hampering the code's quality and affecting the application's overall operation.</p>
<p>üìñ References:</p>
<ul>
<li><a href="https://www.techtarget.com/whatis/definition/monolithic-architecture" target="_blank" rel="noopener noreferrer">monolithic architecture</a></li>
<li><a href="https://developer.ibm.com/articles/challenges-and-patterns-for-modernizing-a-monolithic-application-into-microservices/" target="_blank" rel="noopener noreferrer">Challenges and patterns for modernizing a monolithic application into microservices</a></li>
<li><a href="https://learn.microsoft.com/azure/container-apps/microservices?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Microservices with Azure Container Apps</a></li>
</ul>
<p>Next up is Microservices, a more modular approach to software development.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-microservices">üèóÔ∏è Microservices<a href="https://luke.geek.nz/azure/azure-container-apps-overview/#%EF%B8%8F-microservices" class="hash-link" aria-label="Direct link to üèóÔ∏è Microservices" title="Direct link to üèóÔ∏è Microservices">‚Äã</a></h4>
<p>At its core, the concept of the microservices architecture is an approach to application development in which a large application is built as a collection of modular and cooperating services.</p>
<p>However, in order to successfully achieve a robust microservices architecture, the underlying infrastructure must also be correctly designed. In fact, due to the distributed nature of the microservices architecture, the line between what used to be separate application details and implementation details grows blurrier.</p>
<p>Containers simplify the continuous deployment of microservices.</p>
<p><img decoding="async" loading="lazy" alt="What are Microservices" src="https://luke.geek.nz/assets/images/ACA_Overview_UnderstandingWhatIsMicroservices-c649f3bd42065f6d2439d34cbb23d463.PNG" width="1280" height="720" class="img_ev3q"></p>
<p>üìñ References:</p>
<ul>
<li><a href="https://hackernoon.com/https-medium-com-spruha-pandya-of-microservices-containers-6f0ea25dac3" target="_blank" rel="noopener noreferrer">Of Microservices &amp; Containers</a></li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-deployment-modes">üöÄ Deployment modes<a href="https://luke.geek.nz/azure/azure-container-apps-overview/#-deployment-modes" class="hash-link" aria-label="Direct link to üöÄ Deployment modes" title="Direct link to üöÄ Deployment modes">‚Äã</a></h4>
<p>The deployment of microservices and traditional monolith applications is usually done separately, which is an oversimplification.</p>
<p><img decoding="async" loading="lazy" alt="Monolith shortcomings" src="https://luke.geek.nz/assets/images/ACA_Overview_UnderstandingMonolithMicroservices-5f33f10c9f723eff8a5c2bef55f67e93.gif" width="1905" height="964" class="img_ev3q"></p>
<table><thead><tr><th>Aspect</th><th>Microservices</th><th>Monolith Application</th></tr></thead><tbody><tr><td>Service instantiation</td><td>Instantiate services instead of spinning up new machines =&gt; faster</td><td>Spinning up new machines for each instance =&gt; slower</td></tr><tr><td>Hardware utilization</td><td>Better utilization of hardware</td><td>Less efficient utilization of hardware</td></tr><tr><td>Cost</td><td>Optimized cost due to efficient resource usage</td><td>Potentially higher cost due to inefficient resource usage</td></tr><tr><td>Time to market</td><td>Lower time to market: more confident when it comes to upgrading a service</td><td>Higher time to market: less confident when it comes to upgrading a service</td></tr><tr><td>Independence</td><td>Services are independently implemented, deployed, scaled, and versioned</td><td>All components are tightly coupled and scaled together</td></tr></tbody></table>
<p><strong>So, let's take a look at how Microservices and Containers can work together.</strong></p>
<p>Let‚Äôs delve into the differences between&nbsp;microservices&nbsp;and&nbsp;containers:</p>
<table><thead><tr><th>Aspect</th><th>Microservices</th><th>Containers</th></tr></thead><tbody><tr><td>Definition</td><td>Microservices are an architectural style that breaks down an application into small, autonomous services. These services communicate via well-defined interfaces using lightweight APIs.</td><td>A container is a technology that bundles an application along with all its dependencies into a package. This package allows the application to be deployed consistently across different environments, abstracting away differences in operating systems and underlying infrastructure.</td></tr><tr><td>Structure</td><td>Microservices are self-contained and encapsulate their logic. They interact through well-defined interfaces, allowing independent development and deployment.</td><td>Containers ride on a host operating system, similar to virtual machines (VMs), but they share the OS kernel. This makes them lighter and faster to boot than VMs. Containers are hosted on a container runtime, which enables multiple containers (each several megabytes in size) to run on a single server.</td></tr><tr><td>Popular Tools</td><td>Microservices can be developed with various programming languages and frameworks.</td><td>Docker is a well-known commercial container management solution, while Kubernetes (often referred to as K8s) is a widely used free and open-source container management system.</td></tr><tr><td>Pros</td><td>Enhance maintainability, testability, and scalability. Organized around business capabilities and are typically owned by small teams.</td><td>Excellent for packaging and deploying applications consistently, regardless of the environment. More lightweight and faster to boot than VMs.</td></tr><tr><td>Cons</td><td>Complexity in managing multiple services. Need for coordination and communication between services.</td><td>Requires knowledge of container management and orchestration tools. Potential security risks if not properly isolated.</td></tr><tr><td>Use Case</td><td>Suitable for building modular, scalable applications.</td><td>Provides the infrastructure for running microservices, ensuring consistent deployment and management across different environments.</td></tr></tbody></table>
<p><img decoding="async" loading="lazy" alt="microservices&nbsp;and&nbsp;containers" src="https://luke.geek.nz/assets/images/ACA_Overview_UnderstandingMicroservicesandContainers-67eb803db2d2e482c2f45d0b80ded74d.PNG" width="1280" height="720" class="img_ev3q"></p>
<p>Containers provide the infrastructure for running microservices, ensuring consistent deployment and management across different environments.&nbsp;Microservices, on the other hand, define the architectural approach for building modular, scalable applications.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-container-orchestration">üéõÔ∏è Container orchestration<a href="https://luke.geek.nz/azure/azure-container-apps-overview/#%EF%B8%8F-container-orchestration" class="hash-link" aria-label="Direct link to üéõÔ∏è Container orchestration" title="Direct link to üéõÔ∏è Container orchestration">‚Äã</a></h3>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Container orchestration is required to transition from deploying containers individually on a single host, to deploying complex multi-container apps on many machines. It requires a distributed platform, independent from infrastructure, that stays online through the entire lifetime of your application, surviving hardware failure and software updates.</p></div></div>
<p><img decoding="async" loading="lazy" alt="Container orchastration" src="https://luke.geek.nz/assets/images/ACA_Overview_UnderstandingContainerOrchastration-77949c4d372a4784d69f5e041c8b6e84.PNG" width="1280" height="720" class="img_ev3q"></p>
<p>Existing Container orchestration solutions include the following:</p>
<table><thead><tr><th>Solution</th><th>Description</th><th>Pros</th><th>Cons</th></tr></thead><tbody><tr><td>Kubernetes</td><td>An open-source platform designed to automate deploying, scaling, and operating application containers.</td><td>Highly flexible and customizable. Large community support.</td><td>Complexity in setup and management.</td></tr><tr><td>Docker Swarm</td><td>Docker's own native container orchestration.</td><td>Easy to set up. Integrated into Docker CLI.</td><td>Limited functionality compared to Kubernetes.</td></tr><tr><td>Amazon ECS</td><td>A highly scalable, high-performance container orchestration service that supports Docker containers.</td><td>Deep integration with AWS services.</td><td>Only available on AWS.</td></tr><tr><td>Azure Kubernetes Service (AKS)</td><td>Managed Kubernetes service provided by Azure.</td><td>Deep integration with Azure services. Managed Kubernetes with less operational complexity.</td><td>Only available on Azure.</td></tr><tr><td>Azure Container Apps</td><td>A serverless container service that enables you to run containerized applications at scale.</td><td>Serverless, event-driven, and supports Linux containers. Deep integration with Azure services.</td><td>Only available on Azure.</td></tr></tbody></table>
<p><strong>So, what is Container orchestration?</strong></p>
<p><img decoding="async" loading="lazy" alt="Container orchastration" src="https://luke.geek.nz/assets/images/ACA_Overview_WhatisContainerOrchastration-963aa3154bb30dbbd3198166a652e57e.gif" width="1905" height="964" class="img_ev3q"></p>
<p>Container orchestration&nbsp;plays a crucial role in managing and scaling containerized applications. Here are some reasons why it‚Äôs essential:</p>
<table><thead><tr><th>Feature</th><th>Description</th></tr></thead><tbody><tr><td>Scaling and Load Balancing</td><td>Container orchestration tools like Kubernetes allow you to dynamically scale your application by adding or removing containers based on demand. Load balancing ensures that incoming requests are distributed evenly across containers, preventing overload on any single instance.</td></tr><tr><td>High Availability</td><td>Orchestration ensures that your application remains available even if individual containers fail. It automatically restarts failed containers or replaces them with healthy ones.</td></tr><tr><td>Service Discovery and DNS</td><td>Containers come and go, making it challenging to keep track of their IP addresses. Orchestration tools provide service discovery and DNS resolution, allowing containers to find each other by name.</td></tr><tr><td>Rolling Updates and Rollbacks</td><td>When deploying new versions of your application, orchestration allows for rolling updates. You can gradually replace old containers with new ones, minimizing downtime. In case of issues, you can easily roll back to a previous version.</td></tr><tr><td>Configuration Management</td><td>Orchestration tools manage environment variables, secrets, and other configuration settings for containers. This centralizes configuration management and ensures consistency.</td></tr><tr><td>Resource Optimization</td><td>Orchestration optimizes resource utilization by scheduling containers efficiently across nodes. It balances CPU, memory, and storage requirements.</td></tr><tr><td>Networking and Security</td><td>Orchestration handles networking, including creating virtual networks for communication between containers. It also manages security policies, access controls, and network segmentation.</td></tr><tr><td>Monitoring and Logging</td><td>Container orchestration platforms provide monitoring dashboards and logs. You can track performance, troubleshoot issues, and gain insights into your application.</td></tr></tbody></table>
<p>Container orchestration simplifies deployment, enhances reliability, and ensures efficient management of containerized applications.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-container-apps">üëë Container Apps<a href="https://luke.geek.nz/azure/azure-container-apps-overview/#-container-apps" class="hash-link" aria-label="Direct link to üëë Container Apps" title="Direct link to üëë Container Apps">‚Äã</a></h2>
<p><a href="https://learn.microsoft.com/azure/container-apps/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Container Apps</a>&nbsp;is a&nbsp;serverless platform&nbsp;that simplifies running containerized applications</p>
<ol>
<li>Azure Container Apps allows you to focus on your application logic without worrying about server configuration, container orchestration, or deployment details.</li>
<li>It reduces operational complexity and saves costs by providing up-to-date server resources.</li>
<li>Common use cases include deploying API endpoints, handling background processing jobs, event-driven processing, and running microservices.</li>
</ol>
<p><img decoding="async" loading="lazy" alt="Azure Container Apps" src="https://luke.geek.nz/assets/images/ACA_Overview_AzContainerApps-a3e602470b025818a294eafad1517428.gif" width="1905" height="964" class="img_ev3q"></p>
<p><strong>You may be wondering what sort of applications you can build with Azure Container Apps.</strong></p>
<p>Here are some common ones including:</p>
<ul>
<li>Deploying API endpoints</li>
<li>Hosting background processing applications</li>
<li>Handling event-driven processing</li>
<li>Running microservices</li>
</ul>
<p>With each of those applications, you can dynamically scale based on:</p>
<ul>
<li>HTTP traffic</li>
<li>Event-driven processing</li>
<li>CPU or memory load</li>
<li>Any&nbsp;KEDA-supported scaler</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-what-are-the-differences-between-azure-container-apps-and-other-container-solutions">ü§î What are the differences between Azure Container Apps and other Container solutions?<a href="https://luke.geek.nz/azure/azure-container-apps-overview/#-what-are-the-differences-between-azure-container-apps-and-other-container-solutions" class="hash-link" aria-label="Direct link to ü§î What are the differences between Azure Container Apps and other Container solutions?" title="Direct link to ü§î What are the differences between Azure Container Apps and other Container solutions?">‚Äã</a></h3>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Azure customers can easily deploy microservices using either Azure Kubernetes Service for flexible customized container solutions or Azure Container Apps for productivity-optimized, fully-managed serverless container solutions. Azure delivers app portability to support business growth powered by open source in the Kubernetes ecosystem.</p></div></div>
<p>Azure Container Apps is built on a foundation of powerful open-source technology to deliver the same microservices benefits as Kubernetes as a fully managed and serverless app hosting option. Behind the scenes, every container app runs on Azure Kubernetes Service, with Kubernetes Event Driven Autoscaling (KEDA), Distributed Application Runtime (Dapr), and Envoy deeply integrated in the hosting service. However, developers and operators are not exposed to this underlying Kubernetes infrastructure. The open-source-centric approach enables a path for teams to build microservices without having to overcome the concept and operational overhead of working with Kubernetes directly and enables continued app portability by leveraging open standards and APIs</p>
<p><img decoding="async" loading="lazy" alt="Azure Conter Apps and AKS" src="https://luke.geek.nz/assets/images/ACA_Overview_UnderstandingAKSACA-d685034136047b286b4be51d6fc65761.PNG" width="1280" height="720" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="Azure Conter Apps and AKS" src="https://luke.geek.nz/assets/images/ACA_Overview_UnderstandingAKS-282ccb1a916c18f70a5c7eb248f62f89.PNG" width="1280" height="720" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="Azure Conter Apps and AKS" src="https://luke.geek.nz/assets/images/ACA_Overview_UnderstandingAKSCompareACA-07ff2cbab2f5c7dd977e7a3afbf00510.PNG" width="1280" height="720" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="building-azure-container-apps">‚ö°Building Azure Container Apps<a href="https://luke.geek.nz/azure/azure-container-apps-overview/#building-azure-container-apps" class="hash-link" aria-label="Direct link to ‚ö°Building Azure Container Apps" title="Direct link to ‚ö°Building Azure Container Apps">‚Äã</a></h2>
<p>Now that we know where Azure Container Apps fits in the Cloud Native ecosystem let's take a look at potential tools for building Azure Container Apps.</p>
<p><img decoding="async" loading="lazy" alt="Building Azure Container Apps" src="https://luke.geek.nz/assets/images/ACA_Overview_BuildingContainerAppsApps-18270a1aa314452d6520950c24fbc954.PNG" width="1280" height="720" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-azure-container-app-deployment-options">üöÄ Azure Container App Deployment options<a href="https://luke.geek.nz/azure/azure-container-apps-overview/#-azure-container-app-deployment-options" class="hash-link" aria-label="Direct link to üöÄ Azure Container App Deployment options" title="Direct link to üöÄ Azure Container App Deployment options">‚Äã</a></h3>
<p>Although anything that can connect to the Azure APIs can essentially create a <a href="https://learn.microsoft.com/azure/container-apps/environment?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Container App Environment</a>, common tools are:</p>
<ul>
<li><a href="https://learn.microsoft.com/azure/container-apps/quickstart-portal?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Portal Deployment</a></li>
<li><a href="https://learn.microsoft.com/azure/container-apps/containerapp-up?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure CLI deployment</a></li>
<li><a href="https://learn.microsoft.com/azure/container-apps/azure-resource-manager-api-spec?tabs=arm-template&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">ARM template deployment</a></li>
<li><a href="https://learn.microsoft.com/azure/templates/microsoft.app/containerapps?pivots=deployment-language-bicep&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Bicep template deployment</a></li>
<li><a href="https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/container_app" target="_blank" rel="noopener noreferrer">Terraform template deployment</a></li>
<li><a href="https://www.pulumi.com/registry/packages/azure-native/api-docs/app/containerapp/" target="_blank" rel="noopener noreferrer">Pulumi</a> or other API tools</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-container-app-environments">üåê Container App environments<a href="https://luke.geek.nz/azure/azure-container-apps-overview/#-container-app-environments" class="hash-link" aria-label="Direct link to üåê Container App environments" title="Direct link to üåê Container App environments">‚Äã</a></h3>
<p>But before you jump into the tools to create, you need to understand what you will be deploying and building, so let us take a look at <a href="https://learn.microsoft.com/azure/container-apps/environment?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Container App Environments</a>.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>A Container app environment is a secure boundary around groups of container apps that share the same virtual network and write logs to the same logging destination.</p><p>Container app environments are fully managed, where Azure handles OS upgrades, scale operations, failover procedures, and resource balancing.</p></div></div>
<table><thead><tr><th>Reasons to deploy container apps to the same environment</th><th>Reasons to deploy container apps to different environments</th></tr></thead><tbody><tr><td>Manage related services</td><td>Two applications never share the same compute resources</td></tr><tr><td>Deploy different applications to the same virtual network</td><td>Two Dapr applications can't communicate via the Dapr service invocation API</td></tr><tr><td>Instrument Dapr applications that communicate via the Dapr service invocation API</td><td></td></tr><tr><td>Have applications to share the same Dapr configuration</td><td></td></tr><tr><td>Have applications share the same log analytics workspace</td><td></td></tr><tr><td>Provide an existing virtual network when you create an environment</td><td></td></tr></tbody></table>
<p><img decoding="async" loading="lazy" alt="Container App Environment" src="https://luke.geek.nz/assets/images/ACA_Overview_ContainerAppEnvironments-79a5150c878526f386f697edcc9080c0.gif" width="1892" height="964" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-container-types">üì¶ Container Types<a href="https://luke.geek.nz/azure/azure-container-apps-overview/#-container-types" class="hash-link" aria-label="Direct link to üì¶ Container Types" title="Direct link to üì¶ Container Types">‚Äã</a></h4>
<p>Azure Container Apps supports two types of Containers.</p>
<p>App Container <em>(Sidecar)</em> - The container that runs your application code
Init Containers - Containers that run before the app container starts</p>
<p><img decoding="async" loading="lazy" alt="Azure Container Apps - Container Types" src="https://luke.geek.nz/assets/images/ACA_Overview_BuildingContainerAppContainerTypes-a73e87e6c2c991b81ae6a5b89667a676.PNG" width="1280" height="720" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-container-registry">üì¶ Container registry<a href="https://luke.geek.nz/azure/azure-container-apps-overview/#-container-registry" class="hash-link" aria-label="Direct link to üì¶ Container registry" title="Direct link to üì¶ Container registry">‚Äã</a></h4>
<p>Azure Container Apps supports multiple container registries, including:</p>
<ul>
<li><a href="https://azure.microsoft.com/products/container-registry?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Container Registry</a></li>
<li><a href="https://hub.docker.com/" target="_blank" rel="noopener noreferrer">Docker Hub</a> and other registries.</li>
</ul>
<p>Public and private registries, i.e., Azure Container Registry, are on a private endpoint.</p>
<p><img decoding="async" loading="lazy" alt="Azure Container Apps - Container Registries" src="https://luke.geek.nz/assets/images/ACA_Overview_BuildingContainerAppContainerRegistry-ad0e16d654fac9164f55ce87fbf12d42.PNG" width="1280" height="720" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-container-revisions">üîÑ Container Revisions<a href="https://luke.geek.nz/azure/azure-container-apps-overview/#-container-revisions" class="hash-link" aria-label="Direct link to üîÑ Container Revisions" title="Direct link to üîÑ Container Revisions">‚Äã</a></h4>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Azure Container Apps implements container app versioning by creating <a href="https://learn.microsoft.com/azure/container-apps/revisions?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">revisions</a>. A revision is an immutable snapshot of a container app version.</p></div></div>
<p>The first revision is automatically provisioned when you deploy your container app.
New revisions are automatically provisioned when you make a&nbsp;revision-scope&nbsp;change to your container app.
While revisions are immutable, they're affected by&nbsp;application-scope&nbsp;changes, which apply to all revisions.
You can create new revisions by updating a previous revision.
You can retain up to 100 revisions, giving you a historical record of your container app updates.
You can run multiple revisions concurrently.
You can split external HTTP traffic between active revisions.</p>
<p><img decoding="async" loading="lazy" alt="Container App Revisions" src="https://luke.geek.nz/assets/images/ACA_Overview_BuildingContainerAppRevisions-b2412f888e36fbff019990168ac180ba.PNG" width="1280" height="720" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="Container App Revisions" src="https://luke.geek.nz/assets/images/ACA_Overview_ContainerAppRevisions-c45d1218ba550ac15ace569db3a2a05b.gif" width="1892" height="964" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-container-shutdowns">‚èπÔ∏è Container shutdowns<a href="https://luke.geek.nz/azure/azure-container-apps-overview/#%EF%B8%8F-container-shutdowns" class="hash-link" aria-label="Direct link to ‚èπÔ∏è Container shutdowns" title="Direct link to ‚èπÔ∏è Container shutdowns">‚Äã</a></h4>
<p>It's worth noting how your Containers will shut down as Azure Container Apps scales your Apps or you deactivate a revision, as this can affect your application.</p>
<p>The containers are shut down in the following situations:</p>
<ul>
<li>As a container app scales in</li>
<li>As a container app is being deleted</li>
<li>As a revision is being deactivated</li>
</ul>
<p>When a shutdown is initiated, the container host sends a SIGTERM message to your container. The code implemented in the container can respond to this operating system-level message to handle termination.</p>
<p>If your application doesn't respond within 30 seconds to the SIGTERM message, then SIGKILL terminates your container.</p>
<p>Additionally, make sure your application can gracefully handle shutdowns. Containers restart regularly, so don't expect the state to persist inside a container. Instead, use external caches for expensive in-memory cache requirements.</p>
<p>üìñ References:</p>
<ul>
<li><a href="https://learn.microsoft.com/azure/container-apps/application-lifecycle-management?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Application lifecycle management in Azure Container Apps</a></li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-secret-management">üîí Secret Management<a href="https://luke.geek.nz/azure/azure-container-apps-overview/#-secret-management" class="hash-link" aria-label="Direct link to üîí Secret Management" title="Direct link to üîí Secret Management">‚Äã</a></h4>
<p>Securely store sensitive configuration elements that are then available to containers through environment variables, scale rules, and Dapr.</p>
<p><img decoding="async" loading="lazy" alt="Azure Container Apps - Secret Management" src="https://luke.geek.nz/assets/images/ACA_Overview_BuildingContainerAppSecretManagement-1d4e811be73673cdc3a3b152bd05c134.PNG" width="1280" height="720" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="Azure Container Apps - Secrets" src="https://luke.geek.nz/assets/images/ACA_Overview_Secrets-776fffb4f69c745c60f6d447a87bd07e.gif" width="1892" height="964" class="img_ev3q"></p>
<p>Those environment variables can also reference an <a href="https://azure.microsoft.com/products/key-vault?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Key Vault</a>. For further information, refer to the following Microsoft documentation: <a href="https://learn.microsoft.com/azure/container-apps/manage-secrets?tabs=azure-portal&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Manage secrets in Azure Container Apps</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-cloud-native-ecosystem">‚òÅÔ∏è Cloud Native Ecosystem<a href="https://luke.geek.nz/azure/azure-container-apps-overview/#%EF%B8%8F-cloud-native-ecosystem" class="hash-link" aria-label="Direct link to ‚òÅÔ∏è Cloud Native Ecosystem" title="Direct link to ‚òÅÔ∏è Cloud Native Ecosystem">‚Äã</a></h2>
<p>Azure Container Apps integrates several Cloud Native technologies, including <a href="https://keda.sh/" target="_blank" rel="noopener noreferrer">KEDA</a> and <a href="https://dapr.io/" target="_blank" rel="noopener noreferrer">Dapr</a>, to provide a fully managed serverless container service.</p>
<p>These technologies are part of the <a href="https://www.cncf.io/" target="_blank" rel="noopener noreferrer">Cloud Native Computing Foundation</a> and designed to help developers build and deploy modern applications at scale.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-dapr">üëï Dapr<a href="https://luke.geek.nz/azure/azure-container-apps-overview/#-dapr" class="hash-link" aria-label="Direct link to üëï Dapr" title="Direct link to üëï Dapr">‚Äã</a></h3>
<p><a href="https://dapr.io/" target="_blank" rel="noopener noreferrer">Dapr (Distributed Application Runtime)</a> is a portable, event-driven runtime for building distributed applications across the cloud and edge.</p>
<p><img decoding="async" loading="lazy" alt="Azure Container Apps - Dapr" src="https://luke.geek.nz/assets/images/ACA_Overview_UnderstandingDaprIntegration-51d3b98ecf5eb8623bbf378b1e4496f9.PNG" width="1280" height="720" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p><a href="https://techcommunity.microsoft.com/t5/microsoft-developer-community/open-at-microsoft-dapr/ba-p/3857064?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Dapr</a> is a new way to build modern distributed applications. Born at Microsoft in 2019 as an incubation project, it was donated to the Cloud Native Computing Foundation in 2021 and is now a highly successful open-source project. Dapr helps you write flexible and secure microservices that leverage industry-proven best practices to build connected distributed applications faster. By letting Dapr‚Äôs sidecar take care of the complex challenges such as service discovery, message broker integration, encryption, observability, and secret management, you can focus on business logic and keep your code simple.</p></div></div>
<p>Dapr is a set of integrated APIs with built-in best practices and patterns to build distributed applications. Dapr increases your developer productivity by 20-40% with out-of-the-box features such as workflow, pub/sub, state management, secret stores, external configuration, bindings, actors, distributed lock, and cryptography. You benefit from the built-in security, reliability, and observability capabilities, so you don't need to write boilerplate code to achieve production-ready applications.
Dapr's component model decouples the integrated API with the underlying resources. For instance, when you're using the Dapr publish-subscribe API, you can change the message broker by swapping out a yaml component file to switch from RabbitMQ to Kafka (or any other supported broker) without changing your application code.</p>
<p><img decoding="async" loading="lazy" alt="Dapr High-level" src="https://luke.geek.nz/assets/images/ACA_Overview_UnderstandingDaprIntegrationHigh_Level-8874086ad4f069eb6cc5093d1edf7288.PNG" width="1280" height="720" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="Dapr Building Blocks" src="https://luke.geek.nz/assets/images/ACA_Overview_UnderstandingDaprIntegrationBuildingBlocks-4b37cc5f906373111cdd120ddff5bb8d.PNG" width="1280" height="720" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="Dapr Sidecar architecture" src="https://luke.geek.nz/assets/images/ACA_Overview_UnderstandingDaprIntegrationSidecar-3b89ef6c3cfb222f075e6a3491542592.PNG" width="1280" height="720" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="Dapr Sidecar architecture - Container Apps" src="https://luke.geek.nz/assets/images/ACA_Overview_UnderstandingDaprIntegrationSidecarContainerApps-045b1c3c8af04737d3eddee7004ef906.PNG" width="1280" height="720" class="img_ev3q"></p>
<p>Dapr integration is built into Azure Container Apps, so you can focus on building your application without worrying about the underlying infrastructure. Dapr operates as a sidecar alongside your application, providing features only where needed.</p>
<p>Dapr integration is available straight from the Azure Portal for both the Envirionment and Container App itself.</p>
<p><img decoding="async" loading="lazy" alt="Azure Container Apps - Dapr Portal Integration" src="https://luke.geek.nz/assets/images/ACA_Overview_UnderstandingDaprIntegrationContainerAppPortalIntegration-7a2e6a382c9f8feebae438ce3ef9446f.gif" width="1892" height="964" class="img_ev3q"></p>
<p>Also, make sure to check out <a href="https://learn.microsoft.com/azure/container-apps/dapr-component-resiliency?tabs=bicep&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Dapr component resiliency</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-keda">üìö KEDA<a href="https://luke.geek.nz/azure/azure-container-apps-overview/#-keda" class="hash-link" aria-label="Direct link to üìö KEDA" title="Direct link to üìö KEDA">‚Äã</a></h3>
<p><a href="https://keda.sh/" target="_blank" rel="noopener noreferrer">KEDA (Kubernetes-based Event-Driven Autoscaling)</a> is a Kubernetes-based event-driven autoscaling component.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>KEDA is a Kubernetes-based Event Driven Autoscaler. With KEDA, you can drive the scaling of any container in Kubernetes based on the number of events needing to be processed.</p></div></div>
<p><img decoding="async" loading="lazy" alt="Azure Container Apps - KEDA" src="https://luke.geek.nz/assets/images/ACA_Overview_UnderstandingKEDAlntegration-23b4683fba11a70182de2748395659b0.png" width="1427" height="936" class="img_ev3q"></p>
<p>KEDA (Kubernetes-based Event Driven Autoscaling) is an open-source project that provides event-driven autoscaling for Kubernetes workloads. KEDA can scale any container in response to events from various sources such as Azure Service Bus, Azure Event Hubs, Azure Storage Queues, Azure Storage Blobs, RabbitMQ, Kafka, and more.</p>
<p>An example of KEDA event scaling is being able to scale your Containers based on KEDA scalers, such as Azure DevOps pipelines. You can refer to a previous blog post I did on leveraging KEDA scalers with <a href="https://luke.geek.nz/azure/hosted-agents-container-apps-job/" target="_blank" rel="noopener noreferrer">Container App Jobs to create Self-Hosted Azure DevOps Agents</a>.</p>
<p>KEDA really opens up the possibilities of scaling your Containers, based on events, and is a great addition to Azure Container Apps, and like DAPR KEDA is built-in to Azure Container Apps and managed by Microsoft.</p>
<p><img decoding="async" loading="lazy" alt="KEDA" src="https://luke.geek.nz/assets/images/ACA_Overview_KEDA-5791552cd0c716630523e3eaf7f28104.gif" width="1892" height="964" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-azure-container-apps-networking--storage">üíª Azure Container Apps Networking &amp; Storage<a href="https://luke.geek.nz/azure/azure-container-apps-overview/#-azure-container-apps-networking--storage" class="hash-link" aria-label="Direct link to üíª Azure Container Apps Networking &amp; Storage" title="Direct link to üíª Azure Container Apps Networking &amp; Storage">‚Äã</a></h2>
<p>Now, let us talk about Networking and Storage.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-networking">üåê Networking<a href="https://luke.geek.nz/azure/azure-container-apps-overview/#-networking" class="hash-link" aria-label="Direct link to üåê Networking" title="Direct link to üåê Networking">‚Äã</a></h3>
<p><img decoding="async" loading="lazy" alt="Azure Container Apps - Networking Overview" src="https://luke.geek.nz/assets/images/ACA_Overview_NetworkArchitecture_HighLevel-7aadcc2f1d5c36baa4bb333702bb2c44.PNG" width="1280" height="720" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p><a href="https://learn.microsoft.com/azure/container-apps/networking?tabs=workload-profiles-env%2Cazure-cli&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Container Apps run in the context of an environment</a>, which is supported by a virtual network (VNET).</p><p>When you create an environment, you can provide a custom VNET, otherwise a VNET is automatically generated for you. Generated VNETs are inaccessible to you as they're created in Microsoft's tenant.</p><p>To take full control over your VNET, provide an existing VNET to Container Apps as you create your environment.</p></div></div>
<p><img decoding="async" loading="lazy" alt="Azure Container Apps - Networking Overview" src="https://luke.geek.nz/assets/images/ACA_Overview_NetworkArchitecture_HighLevel2-00aaf617bfe6da080d8856ca330f58ec.PNG" width="1280" height="720" class="img_ev3q"></p>
<p><strong>Accessibility levels</strong></p>
<p>Using internal and external accessibility levels, you can configure whether your container app allows public ingress or ingress only from within your VNet at the environment level.</p>
<p><img decoding="async" loading="lazy" alt="Azure Container Apps - Accessibility levels" src="https://luke.geek.nz/assets/images/ACA_Overview_NetworkAccessibilitylevels-7f9007f566651c94cb6c726b80fa90c9.PNG" width="1280" height="720" class="img_ev3q"></p>
<p>Custom VNET (Virtual Network) integration</p>
<p>If you want your container app to restrict all outside access, create an&nbsp;internal Container app environment.</p>
<p>When you provide your own VNet, you need to provide a subnet that is dedicated to the Container App environment you deploy. This subnet isn't available to other services.</p>
<p>Network addresses are assigned from a subnet range you define as the environment is created.</p>
<p>You can define the subnet range used by the Container Apps environment.</p>
<p>You can restrict inbound requests to the environment exclusively to the VNet by deploying the environment internally.</p>
<p><strong>User-defined routes</strong></p>
<p>User-defined routes (UDR) and controlled egress through NAT Gateway are supported in the workload profiles environment. These features aren't supported in the consumption-only environment.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>When using UDR with Azure Firewall in Azure Container Apps, you need to add certain FQDNs and service tags to the firewall's allowlist. To learn more, see <a href="https://learn.microsoft.com/azure/container-apps/networking?WT.mc_id=AZ-MVP-5004796#configuring-udr-with-azure-firewall" target="_blank" rel="noopener noreferrer">configuring UDR with Azure Firewall</a>.</p></div></div>
<p><strong>Envoy</strong></p>
<p>Azure Container Apps uses <a href="https://www.envoyproxy.io/" target="_blank" rel="noopener noreferrer">Envoy proxy</a> <em>(also part of the Cloud Native Computing Foundation)</em> as an edge HTTP proxy. TLS is terminated on the edge, and requests are routed based on their traffic splitting rules, which route traffic to the correct application.</p>
<p>Azure Container Apps uses Envoy as a network proxy for all HTTP requests. Envoy provides some capabilities such as:</p>
<ul>
<li>Scaling to zero: Envoy allows your container apps to scale to zero instances when there is no traffic and scale up when there is demand. Envoy acts as a buffer between the clients and the container apps and handles the cold start latency.</li>
<li>HTTPS redirection: Envoy automatically redirects all HTTP requests to HTTPS, ensuring secure communication between the clients and the container apps.</li>
<li>TLS termination: Envoy terminates the transport layer security (TLS) at the edge of the container app environment and forwards the requests to the container apps over plain HTTP. This reduces the overhead of encryption and decryption for the container apps.</li>
<li>Mutual TLS: Envoy supports mutual TLS (mTLS) when you use Dapr as a sidecar for your container apps. mTLS provides an additional layer of security by requiring both the client and the server to present valid certificates for authentication.</li>
<li>Ingress controls: Envoy allows you to configure some ingress controls for your container apps, such as IP restrictions, CORS, WAF, etc.</li>
</ul>
<p><img decoding="async" loading="lazy" alt="Azure Container Apps - Envoy" src="https://luke.geek.nz/assets/images/ACA_Overview_NetworkEnvoy-d7ffd0c40db8ff122a3dbc2f9ba8e54d.gif" width="1892" height="964" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="Azure Container Apps - Network Lockdown" src="https://luke.geek.nz/assets/images/ACA_Overview_Networklockdown-35aa92cc1fb855c18cabfacd07f80a33.PNG" width="1280" height="720" class="img_ev3q"></p>
<p>üìñ References:</p>
<ul>
<li><a href="https://learn.microsoft.com/azure/container-apps/networking?tabs=workload-profiles-env%2Cazure-cli&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Networking in Azure Container Apps environment</a></li>
<li><a href="https://techcommunity.microsoft.com/t5/startups-at-microsoft/from-chaos-to-clarity-simplifying-your-networking-with-azure/ba-p/4034625?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">From Chaos to Clarity: Simplifying Your Networking with Azure Container Apps</a></li>
<li><a href="https://learn.microsoft.com/azure/container-apps/networking?tabs=consumption-only-env%2Cazure-cli&amp;WT.mc_id=AZ-MVP-5004796#user-defined-routes-udr" target="_blank" rel="noopener noreferrer">User defined routes (UDR)</a></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-storage">üíæ Storage<a href="https://luke.geek.nz/azure/azure-container-apps-overview/#-storage" class="hash-link" aria-label="Direct link to üíæ Storage" title="Direct link to üíæ Storage">‚Äã</a></h3>
<p>A container app has access to different types of storage. A single app can take advantage of more than one type of storage if necessary.</p>
<p><img decoding="async" loading="lazy" alt="Azure Container Apps - Storage" src="https://luke.geek.nz/assets/images/ACA_Overview_Storage-807107196bc8e44a8ce8602ebfae8cb3.gif" width="1892" height="964" class="img_ev3q"></p>
<p>üìñ References:</p>
<ul>
<li><a href="https://learn.microsoft.com/azure/container-apps/storage-mounts?pivots=azure-cli&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Use storage mounts in Azure Container Apps</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-observability">üëÄ Observability<a href="https://luke.geek.nz/azure/azure-container-apps-overview/#-observability" class="hash-link" aria-label="Direct link to üëÄ Observability" title="Direct link to üëÄ Observability">‚Äã</a></h2>
<p>Azure Container Apps provides several built-in observability features that together give you a holistic view of your container app‚Äôs health throughout its application lifecycle</p>
<p>These features help in monitoring and diagnosing the state of the application to improve performance and respond to trends and critical problems.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-application-lifecycle-observability">üëÅÔ∏è Application lifecycle observability<a href="https://luke.geek.nz/azure/azure-container-apps-overview/#%EF%B8%8F-application-lifecycle-observability" class="hash-link" aria-label="Direct link to üëÅÔ∏è Application lifecycle observability" title="Direct link to üëÅÔ∏è Application lifecycle observability">‚Äã</a></h3>
<table><thead><tr><th>Phase</th><th>Features</th><th>Description</th></tr></thead><tbody><tr><td>Development and Test</td><td>Log streaming, Container console</td><td>Real-time access to containers' application logs and console for debugging issues</td></tr><tr><td>Deployment</td><td>Azure Monitor metrics, Azure Monitor alerts, Azure Monitor Log Analytics</td><td>Continuous monitoring after deployment for identifying problems around error rates, performance, and resource consumption</td></tr><tr><td>Maintenance</td><td>Azure Monitor metrics, Azure Monitor alerts, Azure Monitor Log Analytics</td><td>Manages updates to your container app by creating revisions. Allows running multiple revisions concurrently for blue green deployments or A/B testing. Helps in monitoring applications across revisions</td></tr></tbody></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-azure-landing-zone-for-container-apps">üè° Azure Landing Zone for Container Apps<a href="https://luke.geek.nz/azure/azure-container-apps-overview/#-azure-landing-zone-for-container-apps" class="hash-link" aria-label="Direct link to üè° Azure Landing Zone for Container Apps" title="Direct link to üè° Azure Landing Zone for Container Apps">‚Äã</a></h2>
<p>Last but not least, now that we have investigated and examined some of the finer points of Azure Container Apps, we need somewhere to put it. Following the Enterprise Scale landing zone approach, the Well-architected and Ready phase of the Cloud Adoption Framework has an Application Landing zone reference architecture for Azure Container Apps.</p>
<p>Azure landing zone accelerators provide architectural guidance, reference architectures, reference implementations, and automation to deploy workload platforms on Azure at scale. They are aligned with industry proven practices, such as those presented in <a href="https://learn.microsoft.com/azure/cloud-adoption-framework/ready/landing-zone/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure landing zones guidance</a> in the Cloud Adoption Framework.</p>
<p><img decoding="async" loading="lazy" alt="Azure Container Apps - Landing Zone" src="https://luke.geek.nz/assets/images/ACA_Overview_LandingZoneContainerApps-5d2b35f1512e2637b221e554cac58504.gif" width="1892" height="964" class="img_ev3q"></p>
<p>This reference architecture can be found on GitHub directly: <a href="https://aka.ms/aca-lza" target="_blank" rel="noopener noreferrer">Azure/aca-landing-zone-accelerator</a>.</p>
<p>Thank you for sticking with me until the end! I hope you found this article useful. As usual, feel free to reach out to me on social media if there's anything you want covered that I may have missed, if you have any queries, or if you want me to cover anything else.</p>
<p><strong><a href="https://learn.microsoft.com/azure/container-apps/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Get started with Azure Container Apps today</a>!</strong></p>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Book Review Cloud Solution Architects Career Master Plan]]></title>
            <link>https://luke.geek.nz/azure/book-review-cloud-solution-architects-career-master-plan/</link>
            <guid>https://luke.geek.nz/azure/book-review-cloud-solution-architects-career-master-plan/</guid>
            <pubDate>Fri, 22 Mar 2024 05:40:29 GMT</pubDate>
            <description><![CDATA[This is a review of the book 'Cloud Solution Architect's Career Master Plan'. The book provides valuable insights for aspiring Cloud Solution Architects.]]></description>
            <content:encoded><![CDATA[<p>Book review of <a href="https://www.amazon.com/Cloud-Solution-Architects-Career-Master/dp/1805129716" target="_blank" rel="noopener noreferrer">Cloud Solution Architect's Career Master Plan: Proven techniques and practical tips to help you become a successful solution architect</a></p>
<p><img decoding="async" loading="lazy" alt="Cloud Solution Architect&amp;#39;s Career Master Plan" src="https://luke.geek.nz/assets/images/csa-career-master-plan-kindle-book-d5513446900fd6bb274f15f793a7eb76.jpg" width="4080" height="3072" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Although this book was given to me to review <em>(for free, I have no formal relationship with either Packt Publishing or the authors, although I thank them for allowing me to review this book (Early Access), I am reviewing this book from an entirely independent view)</em>, as someone who architects and builds Azure solutions, this is the type of book, I usually would read, based on the title and synopsis, so let us open the page...</p></div></div>
<p>Book synopsis:</p>
<blockquote>
<p>Proven techniques and effective tips to help you become a successful solution architect.</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a href="https://luke.geek.nz/azure/book-review-cloud-solution-architects-career-master-plan/#introduction" class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction">‚Äã</a></h2>
<p><a href="https://www.amazon.com/Cloud-Solution-Architects-Career-Master/dp/1805129716" target="_blank" rel="noopener noreferrer">Cloud Solution Architect's Career Master Plan</a> is a Packtpub published (in March 2024) book written by the following authors:</p>
<ul>
<li><a href="https://www.linkedin.com/in/rickweyenberg/" target="_blank" rel="noopener noreferrer">Rick Weyenberg</a></li>
<li><a href="https://www.linkedin.com/in/kylemburns/" target="_blank" rel="noopener noreferrer">Kyle Burns</a></li>
</ul>
<p>First up - let's take a look at who this book is for. According to the authors, this book is for aspiring Cloud Solution Architects:</p>
<blockquote>
<p>If you are a self-motivated IT professional and would like to pursue a career as a solution architect, then
this book is for you. You should have a solid base of traditional software architecture understanding, but not in-depth cloud concepts and design considerations.
This book will also be valuable for anyone who is considering a solution architect role as a potential career field but doesn‚Äôt know where to get started. No experience in the cloud architect role is needed to get started.</p>
</blockquote>
<p>In order to set the context of my review, I need to give a brief blurb about my own IT Career to give the context of what lense I am reviewing from and what I am looking for in a book like this, my background is Systems/Infrastructure Engineer, then moving into Cloud-based roles, from project delivery/implementation to technical assurance roles, working with third-party service partners to deliver services, and now as a Senior Consultant/Architect <em>(the New Zealand IT industry, is very much generalised, one day you will be architecting strategic solutions, the next you will be doing infrastructure as code, as an engineer, we need to adapt to fit what needs doing at the time)</em>, so I am looking for a book that can help me in my career and  role, and also help me to mentor and guide others in their career.</p>
<p>There are 8 Chapters in this book, covering Introduction to the Cloud Solution Architect Role, Pursuing the Cloud Architect Role, Preparing for and after the Offer, and is 124 pages long.</p>
<p>I am going to break my review into several areas and look at answering questions such as:</p>
<ol>
<li>Does the book provide a clear understanding of the CSA‚Äôs role? How well does it explain the evolution of cloud computing?</li>
<li>Are the educational recommendations practical and accessible? Does the book cover a range of certifications?</li>
<li>Does the book offer actionable advice for gaining experience? Are the examples and suggestions relevant to current industry standards?</li>
<li>Is the book offer advice that is up-to-date and industry-specific? How helpful are the resume and interview tips?</li>
</ol>
<p>So lets take a look and see if the book answers these questions. I don't want to give away too much of the book, but hopefully, this review will give you a good idea of what to expect from the book.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="role-overview">Role overview<a href="https://luke.geek.nz/azure/book-review-cloud-solution-architects-career-master-plan/#role-overview" class="hash-link" aria-label="Direct link to Role overview" title="Direct link to Role overview">‚Äã</a></h2>
<p>For the role Overview section, we are going to take a look at the book and see whether it discusses the responsibilities and evolution of a Cloud Solution Architect (CSA).</p>
<blockquote>
<p>Question: Does the book provide a clear understanding of the CSA‚Äôs role? How well does it explain the evolution of cloud computing?</p>
</blockquote>
<p>Chapters 1 and 2, are dedicated to answering this very question, with Chapter 1: understanding the responsibilities of a Cloud Solution Architect, and Chapter 2: Types of Cloud Solution Architect roles.</p>
<p>Chapter 1 outlines the evolution of Cloud computing, from the first concepts of what became the internet in the 1960s to the modern-day Cloud within the 2000s. The authors do a very good job of being concise on these details - and vendor agnostic, which is clear throughout the entire book. It's worth noting that although the authors have ties to Microsoft as part of their day-to-day roles, they cover Azure, AWS, and Google concepts as well. Cloud Solution Architect is not specific to one Cloud or hyper scaler, and in my opinion, the authors concentrate on that very view - it's purely about being able to fill the gap that Cloud architecture has as an Architect.</p>
<p>Not only does the Chapter outline the history, but gives insights into core Cloud concepts as well, along with high-level points around the <a href="https://learn.microsoft.com/azure/cloud-adoption-framework/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Microsoft Cloud Adoption</a> and <a href="https://learn.microsoft.com/azure/well-architected/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Well-Architected Framework</a>.</p>
<p>Regarding a CSA (Cloud Solution Architect) role, the book outlines the upsides and downsides of the role and some of the responsibilities that come with it, across elements from on-premises, IaaS <em>(Infrastructure as a Service)</em>, PaaS <em>(Platform as a Service)</em> and SaaS <em>(Software as a Service)</em>, including various architectural patterns that CSAs need to know.</p>
<p>One of the highlights of the role overview Chapter is that the authors have distilled the role of 'Cloud Solution Architect', which could mean different things to different people - a very open-ended job title, into the various sub-categories that exist for CSAs and organisations such as Microsoft adhere to, such as Cloud Solution Architect (Infrastructure), Cloud Solution Architect (Applications), Cloud Solution Architect (Data and AI), and Cloud Solution Architect (Security) etc., highlighting the differences in these particular roles, including tools and relevant certifications for each Architect function.</p>
<p><strong>Overall, these Chapters do a good job of setting the scene for the rest of the book, give a good overview of the role and the responsibilities that come with it, and, in my opinion, clearly answer the question of What a CSA is, and what they do, and even covers industry-specific <em>(such as Healthcare or Utilities)</em>.</strong></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="educational-pathways">Educational Pathways<a href="https://luke.geek.nz/azure/book-review-cloud-solution-architects-career-master-plan/#educational-pathways" class="hash-link" aria-label="Direct link to Educational Pathways" title="Direct link to Educational Pathways">‚Äã</a></h2>
<p>For this section, we will examine the various educational paths and certifications available for aspiring CSAs by answering the following question:</p>
<blockquote>
<p>Question: Are the educational recommendations practical and accessible? Does the book cover a range of certifications?</p>
</blockquote>
<p><img decoding="async" loading="lazy" alt="Cloud Architect" src="https://luke.geek.nz/assets/images/Cloud_Architect_MSDesigner-58f091de3210d35a0b86d0aa491a1657.jpeg" width="1024" height="1024" class="img_ev3q"></p>
<p><strong>I alluded to this in the previous section (Role overview); the book authors have included a list of relevant certifications for each CSA (Cloud Solution Architect) function, ie AWS Certified Machine Learning, AI Engineer Associate, for AI/ML CSAs (Artificial Intelligence/Machine Learning Cloud Solution Architects), including a draft of fundamentals certifications across multiple platforms. It is my opinion, that the book covers educational pathways pretty well, with a vendor-neutral focus, from technical certification recommendations to even soft-skills and growth-mindset recommended reading, some great content and pathways to get started on your journey as a Cloud Solution Architect.</strong></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="real-world-application">Real-World Application<a href="https://luke.geek.nz/azure/book-review-cloud-solution-architects-career-master-plan/#real-world-application" class="hash-link" aria-label="Direct link to Real-World Application" title="Direct link to Real-World Application">‚Äã</a></h2>
<p>In this section, we will evaluate the book's practical advice for gaining experience and industry-specific knowledge - outside of the book.</p>
<p>We will consider how the book addresses gaining real experience through side projects, open-source contributions, and hackathons.</p>
<p><img decoding="async" loading="lazy" alt="Cloud Architect" src="https://luke.geek.nz/assets/images/Cloud_Architect_MSDesigner1-9462ef8d5fd0b5be14bbd76d47f2eb3a.jpeg" width="1024" height="1024" class="img_ev3q"></p>
<blockquote>
<p>Question: Does the book offer actionable advice for gaining experience? Are the examples and suggestions relevant to current industry standards?</p>
</blockquote>
<p><strong>When looking at a role, such as a Cloud Solution Architect, gaining experience is key, and the book does a good job of outlining the various ways to gain experience, from side projects, to open source contributions, to hackathons, and even to the importance of networking, and building relationships with other professionals in the industry, and the importance of mentorship, and how to find a mentor.</strong>
<strong>As a community advocate and someone who has learned by helping the community <em>(outside of my day-to-day role)</em>, by contributing to open-source projects, Microsoft Learn documentation editing and writing, and helping on Microsoft Q&amp;A etc., public speaking, etc. - the guidance this book offers is key and even touches on the high-level roadmap of, being a consumer of an open-source project and moving to more of a Contributor role. The path to a Cloud Solution Architect is not always a straight line, and the book does a good job of outlining this: the importance of gaining experience and the various ways to do so, which are not necessarily your traditional, become an engineer, then either go into architecture or management.</strong></p>
<p>To quote from the book itself:</p>
<blockquote>
<p>"In 1975, Steve Wozniak started working on a side project to design a general-purpose computing device suitable for hobbyist use. This device became the Apple I and helped start Apple Computer down the path toward becoming a household name. In May 2023, Apple announced a revenue of $94.8 billion for the second quarter of 2023."</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="job-pursuit-strategy">Job Pursuit Strategy<a href="https://luke.geek.nz/azure/book-review-cloud-solution-architects-career-master-plan/#job-pursuit-strategy" class="hash-link" aria-label="Direct link to Job Pursuit Strategy" title="Direct link to Job Pursuit Strategy">‚Äã</a></h2>
<p>In this section, we will review the guidance provided for pursuing a job, crafting a resume, and preparing for interviews.</p>
<blockquote>
<p>Question: Is the job pursuit advice up-to-date and industry-specific? How helpful are the resume and interview tips?</p>
</blockquote>
<p>Now that the book has covered alot of theory about what a CSA (Cloud Solution Architect) is and how to get experience and education <em>(in my opinion, covered successfully)</em>, now lets see how whether the guidance can help us with the next step, of preparing for interviews, and crafting a resume.</p>
<p><img decoding="async" loading="lazy" alt="Cloud Architect" src="https://luke.geek.nz/assets/images/Cloud_Architect_MSDesigner2-59348657cd37f4c6266471a5e7b84002.jpeg" width="1024" height="1024" class="img_ev3q"></p>
<p>First, we need to keep in mind that this book came out in March 2024, around the same time as this review. So, the information on hand is relevant and up-to-date at the time of this review, and the job pursuit advice is relevant for the current job market. However, different industries, companies, and geographical locations may have different requirements for an Architect, so make sure to read the fine print of that role.</p>
<p><strong>Going back to the book - the book has already touched on a Cloud Solution Architect, what that is, and how to get experience and industry-specific concerns, but what the book hasn't touched on YET - is the different levels, for example, Junior, Senior, Principal Cloud Solution Architect, I question I had before reading this book was:</strong></p>
<p><strong>What was the difference between a Senior Cloud Solution Architect and a Principal Architect? This book answered that.</strong></p>
<p><strong>The book also covered, average salary <em>(again company, geographical specific)</em>,  and recommendations on resume tips and skills. These sections were very high-level but straight to the point - the authors allowed room for you to adjust and make their recommendations your own and adjustable for the actual role you are applying for. I took the recommendations as a way to structure the sentences and my achievements on my resume, and skills (both technical and soft skills) that I may need or didn't think to add.</strong></p>
<p><strong>Alongside the resume tips are tips about leveraging Social Media and also some relevant interview questions.</strong></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="authors-expertise">Author's Expertise<a href="https://luke.geek.nz/azure/book-review-cloud-solution-architects-career-master-plan/#authors-expertise" class="hash-link" aria-label="Direct link to Author's Expertise" title="Direct link to Author's Expertise">‚Äã</a></h2>
<p>I believe the authors have the correct expertise to make this book viable <em>(and based on my own knowledge, reading this book)</em> and accurate.</p>
<ul>
<li><a href="https://www.linkedin.com/in/kylemburns/" target="_blank" rel="noopener noreferrer">Kyle Burns</a> is a Microsoft Principal Cloud Solution Architect - concentrating on Azure App Dev.</li>
<li><a href="https://www.linkedin.com/in/rickweyenberg/" target="_blank" rel="noopener noreferrer">Rick Weyenberg</a> is a Microsoft Principal Azure Cloud Solution Architect with an industry focus for automotive.</li>
</ul>
<p><strong>It is my opinion that this duo is indeed suited to write this type of book, and this can be seen from the actionable and valid output of the book itself.</strong></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://luke.geek.nz/azure/book-review-cloud-solution-architects-career-master-plan/#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">‚Äã</a></h2>
<p><strong>Cloud Solution Architect's Career Master Plan (1st Edition) is a book containing 124 pages of actionable and useful content for those interested in what a Cloud Solution Architect is and how to start your journey to becoming one. Key traits needed, in my opinion, for a Cloud Solution Architect are a desire to learn and stay up to date with emerging technologies; this is reflected in the guidance of the book. Overall, I had no pre-conceptions when I was asked to review this book, but it was very timely for me personally, where I am in my own career, and the questions that I had.</strong></p>
<p><strong>I would like to point out that this book goes beyond by dedicating a section to giving back to the Community and the importance of mentorship, networking, soft skills and a growth mindset, which are key to being a successful Cloud Solution Architect and highly recommend picking up to read. The only issue I had was that there was missing an 's' to an image for on-premises! My OCD kicked in! But it was a privilege to review, definitely one I will refer to!</strong></p>
<p>If interested, feel free to checkout another Book review I did on <a href="https://luke.geek.nz/azure/misc/Book-Review-Azure-architecture-explained/" target="_blank" rel="noopener noreferrer">Book Review Azure Architecture Explained</a>, another great book on the more technical and governance aspects of architecting solutions in Azure.</p>]]></content:encoded>
            <category>Azure</category>
            <category>Misc</category>
        </item>
        <item>
            <title><![CDATA[Microsoft Azure - Sandbox Design Considerations]]></title>
            <link>https://luke.geek.nz/azure/microsoft-azure-sandbox-design-considerations/</link>
            <guid>https://luke.geek.nz/azure/microsoft-azure-sandbox-design-considerations/</guid>
            <pubDate>Thu, 21 Mar 2024 04:40:28 GMT</pubDate>
            <description><![CDATA[Sandbox Design Considerations for Microsoft Azure]]></description>
            <content:encoded><![CDATA[<p>When working with Microsoft Azure, you may want an environment for learning, whether for an individual or a team. This article aims to highlight some architectural considerations when implementing a Sandbox environment within the Microsoft Azure platform.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>Your Sandbox isn‚Äôt a pathway to production; it‚Äôs a pathway to ‚ÄúCLICK, CLICK, OOPS.‚Äù</p></div></div>
<p><img decoding="async" loading="lazy" alt="Microsoft Azure - Sandbox Design Considerations" src="https://luke.geek.nz/assets/images/BlogHeading_MicrosoftAzure_SandboxDesignConsiderations-ada674642f7ef4887f0bf67997d4e069.png" width="901" height="481" class="img_ev3q"></p>
<!-- -->
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-what-is-a-cloud-sandbox-environment">‚òÅÔ∏è What is a Cloud Sandbox environment?<a href="https://luke.geek.nz/azure/microsoft-azure-sandbox-design-considerations/#%EF%B8%8F-what-is-a-cloud-sandbox-environment" class="hash-link" aria-label="Direct link to ‚òÅÔ∏è What is a Cloud Sandbox environment?" title="Direct link to ‚òÅÔ∏è What is a Cloud Sandbox environment?">‚Äã</a></h2>
<p>What am I talking about when talking about a Sandbox environment?</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Cloud Sandboxes are contained, isolated environments that allow the evaluation of new Cloud services and features <em>(without impacting production environments)</em>.</p><ul>
<li>Sandbox is a pathway to learning, not to development</li>
<li>Build and experiment with capabilities with an open platform</li>
<li>Co-innovate with trust and safeguards</li>
</ul><p>The general principles for a Sandbox environment are:</p><ul>
<li>Cannot store Production data</li>
<li>Secure identity with production controls</li>
<li>Environment for learning, not production</li>
</ul></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="why-would-i-want-a-sandbox-environment">‚ùîWhy would I want a Sandbox environment?<a href="https://luke.geek.nz/azure/microsoft-azure-sandbox-design-considerations/#why-would-i-want-a-sandbox-environment" class="hash-link" aria-label="Direct link to ‚ùîWhy would I want a Sandbox environment?" title="Direct link to ‚ùîWhy would I want a Sandbox environment?">‚Äã</a></h2>
<p>Having an environment for learning is key to driving the adoption of Cloud technologies by giving consumers the ability to leverage and test Azure resources in an isolated environment from Production; users using the Sandbox could be users new to Microsoft Azure or those who may already have Azure knowledge but want to trial and test preview features, that may not be compliant with Production controls.</p>
<p><img decoding="async" loading="lazy" alt="Gartner Top 10 - Strategic Technology Trends for 2024" src="https://luke.geek.nz/assets/images/Gartner_Top_10_StrategicTechTrends_2024-1bf229c397604392905a94f689431837.png" width="1914" height="750" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Platform Engineering is the discipline of building and operating self-service internal platforms ‚Äî each platform is a layer created and maintained by a dedicated product team, designed to support the needs of its users by interfacing with tools and processes.</p></div></div>
<p>According to the Gartner Top 10 technology trends for 2024, Platform Engineering is a key element to enabling developers and application teams to remain competitive, not only from a business standpoint but also from talent retention, empowering employees to do more, the premise of Platform Engineering is for a 'Platform Team' to manage the governance of the Cloud platforms <em>(following key well-architected framework guidelines, such as Operational Excellence, Security, Performance and Reliability)</em> and also allowing the Application owners to deploy and manage their applications, without having to worry about the necessary organisational guardrails.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-are-the-antipatterns-to-avoid">üò∑What are the antipatterns to avoid?<a href="https://luke.geek.nz/azure/microsoft-azure-sandbox-design-considerations/#what-are-the-antipatterns-to-avoid" class="hash-link" aria-label="Direct link to üò∑What are the antipatterns to avoid?" title="Direct link to üò∑What are the antipatterns to avoid?">‚Äã</a></h2>
<p>The word 'anti-patterns' can be quite negative terminology to use. However, it's really a trade-off between having an environment protected, i.e., with regulatory requirements, etc., like you would in Production, which in most cases prevents your Sandbox consumers from being able to learn without running into the various guardrails and having an environment on the opposite end of the scale, where there are no guardrails in place.</p>
<p>When we look at anti-patterns, we need to remember what we are trying to achieve with the Cloud Sandboxes, i.e. give Sandbox consumers an environment for learning Cloud technologies.</p>
<p>So, let us take a look at some patterns and areas to avoid.</p>
<ul>
<li>Regional restrictions - the reason why you might want to restrict Regional Restrictions is due to the fact that not all Azure services are available in all regions.</li>
<li>Over extensive blocklists</li>
<li>Trying to build the entire platform at once</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="sandbox-patterns">üìãSandbox Patterns<a href="https://luke.geek.nz/azure/microsoft-azure-sandbox-design-considerations/#sandbox-patterns" class="hash-link" aria-label="Direct link to üìãSandbox Patterns" title="Direct link to üìãSandbox Patterns">‚Äã</a></h2>
<p>Ok, let's talk Patterns! Every organisation may have a different Sandbox requirement, but before we discuss the particular of patterns, let's first talk about Platform Landing Zones at a high level so I can make sure we are all talking the same language.</p>
<p>In the context of Platform Landing Zones, I am referring to an Azure environment setup like the Enterprise Scale Landing Zone Reference architecture (ESLZ), where the Landing Zone features common components for the Platform, such as Security and Connectivity, and is usually the base of your networking infrastructure, such as Virtual WAN (Wide Area Network) connecting to your on-premises environment or a Virtual Network connecting different Applications and dependencies together.</p>
<p>The Platform Landing Zone design aims to keep Platform management consistent, centralised, and secure, allowing your application teams to leverage the shared services supplied by the Platform Landing Zone design. An organisation may have requirements to move from this reference pattern - and that is ok - but the premise here is that the Platform Landing Zone is looked after by a Platform or Infrastructure team <em>(in most cases)</em> and the environment is architected in a way that does not impede application teams, to deliver business value, while making sure that their solutions are secure and where necessary, consistent.</p>
<p><img decoding="async" loading="lazy" alt="Azure Landing Zone - Sandbox - Reference Architecture" src="https://luke.geek.nz/assets/images/Azure_Landing_Zone-Sandbox-ReferenceArchitecture-1fcbfd121ee389dfd62133124d618eb2.png" width="1330" height="1066" class="img_ev3q"></p>
<p>A sandbox usually contains:</p>
<ul>
<li>Data isolation</li>
<li>Network security (segregated)</li>
<li>Identity and access controls</li>
<li>Compliance and regulatory considerations</li>
</ul>
<p>So, let us discuss Sandbox Types.</p>
<p><img decoding="async" loading="lazy" alt="Azure Sandbox Types" src="https://luke.geek.nz/assets/images/Azure_Sandbox_Types-cde8ffbf467e4e3cc94ae61b2e7b82d5.png" width="929" height="528" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="Azure Sandbox Types" src="https://luke.geek.nz/assets/images/Azure_Sandbox_Types2-675c09308c8dd8798a1c0d7bebeb5b96.png" width="1062" height="646" class="img_ev3q"></p>
<p>The term: Managed, below - is in the context of the Azure Cloud Adoption Framework, where the environment is managed by the organisation and is part of the organisation's governance, identity and compliance controls, and Platform team managed.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="sandbox-type---personal">Sandbox Type - Personal<a href="https://luke.geek.nz/azure/microsoft-azure-sandbox-design-considerations/#sandbox-type---personal" class="hash-link" aria-label="Direct link to Sandbox Type - Personal" title="Direct link to Sandbox Type - Personal">‚Äã</a></h3>
<p>When referring to a Personal Sandbox, I am referring to a Free, Pay As You Go, or Azure Sponsorship, <a href="https://visualstudio.microsoft.com/subscriptions/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Visual Studio Enterprise subscription(s)</a> that are used by an individual, an example is a Cloud Engineer, who has access to a Visual Studio Enterprise subscription and then uses the free credit, to spin up an Azure subscription - that is unmanaged and not part of the organisation's network, identity or compliance controls. These subscriptions usually have a hard limit on the type of resources you can deploy or Budget.</p>
<p>Personal subscriptions are outside of the organisation's control and are not managed by the organisation. They are usually used for learning and not for production workloads. For individuals with these licenses, these subscriptions can be key to preparing for certification or individual upskilling.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="sandbox-type---unmanaged">Sandbox Type - Unmanaged<a href="https://luke.geek.nz/azure/microsoft-azure-sandbox-design-considerations/#sandbox-type---unmanaged" class="hash-link" aria-label="Direct link to Sandbox Type - Unmanaged" title="Direct link to Sandbox Type - Unmanaged">‚Äã</a></h3>
<p>When I refer to an Unmanaged Sandbox, I am referring to an Azure subscription that is managed by the organisation but is not part of the organisation's network, identity, or production compliance controls (although it would be auditable).
These subscriptions are usually used for learning, not for production workloads. For individuals or teams, these subscriptions can be key to preparing for certification or team upskilling with Cloud technologies and preview features.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="sandbox-type---lightly-managed">Sandbox Type - Lightly Managed<a href="https://luke.geek.nz/azure/microsoft-azure-sandbox-design-considerations/#sandbox-type---lightly-managed" class="hash-link" aria-label="Direct link to Sandbox Type - Lightly Managed" title="Direct link to Sandbox Type - Lightly Managed">‚Äã</a></h3>
<p>When referring to Lightly Managed Sandboxes, these are more managed than an Unmanaged subscription because they are Resource Group limited; for example, a team of 10 may have access to a Lightly Managed Sandbox, where they can deploy resources into a specific Resource Group, or Resource Groups that they have access to, however, the overall governance of the Subscription is done by the Platform team. This is useful when you have a lot of individuals wanting a specific regulated Resource Group to stand up resources into, vs giving them a Subscription each.</p>
<p>Resource Group tags can be key to <a href="https://techcommunity.microsoft.com/t5/fasttrack-for-azure/the-azure-finops-guide/ba-p/3704132?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">FinOps</a> cost management and tracking.</p>
<p>Lightly Managed sandboxes can be useful for smaller organisations that do not want Subscription sprawl.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="sandbox-type---highly-managed">Sandbox Type - Highly Managed<a href="https://luke.geek.nz/azure/microsoft-azure-sandbox-design-considerations/#sandbox-type---highly-managed" class="hash-link" aria-label="Direct link to Sandbox Type - Highly Managed" title="Direct link to Sandbox Type - Highly Managed">‚Äã</a></h3>
<p>Highly Managed Sandboxes are usually used for testing the same set of services repeatedly, where the users (particularly Developers) don't necessarily care about the underly Azure platform and resources and are more focussed on the application and services they are deploying, for example, a developer may want to test a new version of a service, and they can deploy the service into a Highly Managed Sandbox, and then run their tests, and then destroy the environment.
Highly Managed Sandboxes are useful for standing up consistant infrastructure, such as an Azure Kubernetes Service or App Service, that is used every single time.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>The main difference is that managed sandboxes have pre-determined services that can be deployed as needed, which is useful for testing the same set of services repeatedly.
Lightly managed sandboxes are useful when many individuals want a specific regulated Resource Group to allocate resources to.</p><p>In contrast, the unmanaged sandbox is more open and less restrictive, which makes it ideal for learning and trying new technologies for a small to large team.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="sandbox-type-decisions">Sandbox Type decisions<a href="https://luke.geek.nz/azure/microsoft-azure-sandbox-design-considerations/#sandbox-type-decisions" class="hash-link" aria-label="Direct link to Sandbox Type decisions" title="Direct link to Sandbox Type decisions">‚Äã</a></h3>
<p>When deciding on the type of Sandbox, you need to consider the following:</p>
<ul>
<li><strong>The purpose of the Sandbox</strong>. What are you trying to achieve with the Sandbox? Are you trying to give users an environment to learn, or are you trying to give users an environment to test a specific set of services?</li>
<li><strong>The scope of the Sandbox</strong>. Are you trying to give users an environment to learn, or are you trying to give users an environment to test a specific set of services?</li>
<li><strong>The lifecycle of the Sandbox</strong>. How long do you want it to be available? Do you want it to be available for a specific period of time?</li>
<li><strong>The Cost of the Sandbox</strong>. How much are you willing to spend on it? Who has the financial authority to approve Cloud spending?</li>
<li><strong>Access to the Sandbox</strong>. Who has access to the Sandbox, and how do you manage access to the Sandbox?</li>
<li><strong>Management of the Sandbox</strong>. Who is responsible for managing the Sandbox? How do you manage the lifecycle of the Sandbox?</li>
<li><strong>Governance of the Sandbox</strong>. How do you manage the governance of the Sandbox? How do you manage the compliance of the Sandbox?</li>
<li><strong>Migration of the Sandbox</strong>. How do you migrate the Sandbox to a different environment? How do you migrate the Sandbox to a different subscription? ie what would migration of a proof of technology from a Sandbox environment into Dev/Test or Production look like?</li>
<li><strong>Security of the Sandbox</strong>. How do you manage the security of the Sandbox? How do you manage the identity and access to a Sandbox? How do you manage the compliance of the Sandbox?</li>
<li><strong>Monitoring of the Sandbox</strong> How do you monitor the Sandbox? How do you manage the cost of the Sandbox? How do you manage the performance of resources in the Sandbox (and do you need to)?</li>
<li><strong>Integration of the Sandbox</strong>. How do you integrate the Sandbox with other environments? How do you integrate the Sandbox with other subscriptions? How do you integrate the Sandbox with other services?</li>
</ul>
<p>Consideration of all of the above will help you decide on the type of Sandbox that is right for your organisation.</p>
<p><img decoding="async" loading="lazy" alt="Azure Sandbox Decisions" src="https://luke.geek.nz/assets/images/Azure_Sandbox_TypeDecisions-b186854a710240c85b32fd01003a7c7c.png" width="1955" height="707" class="img_ev3q"></p>
<table><thead><tr><th>Criteria</th><th>Personal</th><th>Unmanaged</th><th>Lightly Managed</th><th>Highly Managed</th></tr></thead><tbody><tr><td>Purpose</td><td>Learning, individual upskilling</td><td>Learning, team upskilling</td><td>Regulated resource group for team</td><td>Testing specific services repeatedly</td></tr><tr><td>Scope</td><td>Individual</td><td>Small to large team</td><td>Specific team</td><td>Specific services</td></tr><tr><td>Lifecycle</td><td>Determined by individual</td><td>Determined by team</td><td>Managed by platform team</td><td>Managed by platform team</td></tr><tr><td>Cost</td><td>Limited by subscription type</td><td>Auditable, managed by organisation</td><td>Managed by platform team</td><td>Managed by platform team</td></tr><tr><td>Access</td><td>Individual</td><td>Team</td><td>Regulated by platform team</td><td>Regulated by platform team</td></tr><tr><td>Management</td><td>Individual</td><td>Team</td><td>Platform team</td><td>Platform team</td></tr><tr><td>Governance</td><td>Individual</td><td>Auditable, managed by organisation</td><td>Managed by platform team</td><td>Managed by platform team</td></tr><tr><td>Migration</td><td>Individual responsibility</td><td>Team responsibility</td><td>Managed by platform team</td><td>Managed by platform team</td></tr><tr><td>Security</td><td>Individual responsibility</td><td>Auditable, managed by organisation</td><td>Managed by platform team</td><td>Managed by platform team</td></tr><tr><td>Monitoring</td><td>Individual responsibility</td><td>Team responsibility</td><td>Managed by platform team</td><td>Managed by platform team</td></tr><tr><td>Integration</td><td>Individual responsibility</td><td>Team responsibility</td><td>Managed by platform team</td><td>Managed by platform team</td></tr></tbody></table>
<p>Let's look at a scenario:</p>
<p>We have a Data Scientist named Samuel.</p>
<p><img decoding="async" loading="lazy" alt="Samuel - Data Scientist" src="https://luke.geek.nz/assets/images/Azure_Sandbox_Scenario_Samuel-b0c9876207b7160c4c4ac62467344cd6.png" width="1820" height="868" class="img_ev3q"></p>
<p>Samuel's goals are to:</p>
<ol>
<li><strong>Deliver high-quality and robust machine learning solutions that can enhance customer satisfaction and loyalty</strong>x, as well as increase the revenue and profitability of the company.</li>
<li><strong>Learn the latest and most advanced techniques and methods in the field of artificial intelligence, such as natural language processing</strong>, computer vision, and deep learning, to create innovative and cutting-edge models.</li>
<li>To <strong>collaborate and learn from other data scientists and experts in the field, both within and outside his company</strong>, to improve his knowledge.</li>
<li><strong>Self-management and accountability of cost management</strong> and access to the environment for Data/AI projects across multiple responsible team members**.</li>
</ol>
<p>If we also take a look at the <a href="https://learn.microsoft.com/azure/security/fundamentals/shared-responsibility-ai?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Microsoft AI Shared responsibility model</a>, we can see that the Data Scientist, is responsible for the Data, the AI model, and the AI application, and the Platform team is responsible for the underlying infrastructure, and the AI platform.</p>
<p><img decoding="async" loading="lazy" alt="Microsoft AI Shared Responsibility Model" src="https://luke.geek.nz/assets/images/Azure_Sandbox_Scenario_Samuel_AI_SharedResponsibility-af413845edd8fcdabfe075a907a2cfe4.png" width="953" height="607" class="img_ev3q"></p>
<p>Because of Samuel's requirements and the shared responsibility model, we can see that Samuel would benefit from an Unmanaged Sandbox, where he can deploy resources into a specific Subscription he has access to, alongside members of his team and approved external identities, while also being isolated from Production. He has also accepted responsibility for Cost.</p>
<p>The reference architecture of Samuel's Sandbox could look like the following:</p>
<p><img decoding="async" loading="lazy" alt="Azure Sandbox - Reference Architecture - Samuel" src="https://luke.geek.nz/assets/images/Sandbox_Reference_Architecture-e35333694d33cb2d60dc914d30879f73.png" width="1775" height="981" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="pathway-to-production">üöôPathway to Production<a href="https://luke.geek.nz/azure/microsoft-azure-sandbox-design-considerations/#pathway-to-production" class="hash-link" aria-label="Direct link to üöôPathway to Production" title="Direct link to üöôPathway to Production">‚Äã</a></h2>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Remember: The Sandbox is not a pathway to production; it is a pathway to "CLICK, CLICK, OOPS".</p></div></div>
<p><strong>However</strong>, there will be times when users have learnt something in the Sandbox, and they want to move their solution into a Dev/Test or Production environment, and this is where the <a href="https://learn.microsoft.com/azure/cloud-adoption-framework/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Cloud Adoption Framework</a> comes into play, and the <a href="https://learn.microsoft.com/azure/well-architected/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Well-Architected Framework</a> can be used to help guide the migration of the solution from the Sandbox into a Dev/Test or Production environment.</p>
<p>Make sure to consider the following:</p>
<ol>
<li><strong>Identify and document the requirements and specifications of the product after your learning</strong>: After experimenting and learning in the Sandbox, it's crucial to identify and document the requirements and specifications of the product. This includes understanding the technical requirements, the business needs, and the user expectations. This step is in line with the Strategy phase of the Cloud Adoption Framework.</li>
<li><strong>Security considerations (RBAC, Access, CISO review)</strong>: Security is a paramount concern when moving from a Sandbox to a Production environment. Considerations should include Role-Based Access Control (RBAC) to ensure only authorized individuals have access, a thorough review of access permissions, and a review by the Chief Information Security Officer (CISO) or equivalent. This aligns with the Well-Architected Framework's security pillar.</li>
<li><strong>Ensure that the data, code, models, and outputs are suitable for Production; change</strong>: Before moving to Production, ensure that all data, code, models, and outputs are production-ready. This means they should be thoroughly tested, reliable, and meet all necessary regulations and standards. This is part of the Plan and Ready phases of the Cloud Adoption Framework.</li>
<li><strong>Deploy the production using CI/CD where possible</strong>: Continuous Integration/Continuous Deployment (CI/CD) is a best practice for deploying applications. It allows for frequent code changes, automated testing, and quick deployment to production. This is part of the Migrate and Innovate phases of the Cloud Adoption Framework.</li>
<li><strong>Test and debug</strong>: Rigorous testing and debugging are essential to ensure the product works as expected and any issues are identified and fixed before going live. This aligns with the Well-Architected Framework's reliability pillar.</li>
<li><strong>Monitor and manage</strong>: Once in production, the application should be continuously monitored and managed to ensure it remains secure, performs well, and meets user needs. This includes monitoring for any issues, managing updates and changes, and regularly reviewing performance. This is part of the Govern and Manage phases of the Cloud Adoption Framework.</li>
</ol>
<p>Also, make sure you make sure of Cloud Adoption Framework Landing Zone guidance, such as <a href="https://learn.microsoft.com/en-gb/azure/cloud-adoption-framework/ready/enterprise-scale/testing-approach?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Dev/Test Management Group and subscription Landing Zone guidance, such as a Canary Management Group structure</a>.</p>
<p>Although not mandatory, the canary environment management group hierarchy can be used to simplify testing of the following resource types without ending up with a range of exemptions and overprivileged access to Production resources, where it is not required:</p>
<ul>
<li><strong>Management groups</strong>: Management groups in Azure provide a level of scope above subscriptions. They give you enterprise-grade management at a large scale no matter what type of subscriptions you might have. All subscriptions within a management group automatically inherit the conditions applied at the management group level.</li>
<li><strong>Subscription placement</strong>: The placement of subscriptions within the management group hierarchy is crucial. It allows for the application of governance conditions at different levels, providing flexibility and control over the environment.</li>
<li><strong>Roles (built-in and custom)</strong>: Azure provides several built-in roles that you can assign to users, groups, and services. You can also create custom roles if the built-in roles don't meet your specific needs.</li>
<li><strong>Assignments</strong>: Assignments in Azure RBAC are the links between roles and security principals (user, group, service principal, or managed identity). They define the access a security principal has.</li>
<li><strong>Azure Policy</strong>: Azure Policy is a service in Azure that you use to create, assign, and manage policies. These policies enforce different rules and effects over your resources, helping to ensure your resources stay compliant with your corporate standards and service level agreements.</li>
<li><strong>Definitions (built-in and custom)</strong>: Azure Policy uses policy definitions to express what to evaluate and what action to take. There are built-in definitions provided by Azure and you can also create custom definitions.</li>
<li><strong>Initiatives, also known as set definitions</strong>: An initiative definition is a set or group of policy definitions to help track your compliance state for a larger goal. Initiatives bring together one or more policies as a group to accomplish things like enabling real-time policy enforcement and more comprehensive coverage.</li>
</ul>
<p>The Canary Landing Zone architecture is useful as it provides a controlled environment for testing changes and updates before they are applied to the production resources.</p>
<p><img decoding="async" loading="lazy" alt="Azure Landing Zones - Canary" src="https://luke.geek.nz/assets/images/canary-mgmt-groups-97d6d855227f32f80a5e08731d991498.png" width="1407" height="542" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="products-and-tools">üö¢Products and tools<a href="https://luke.geek.nz/azure/microsoft-azure-sandbox-design-considerations/#products-and-tools" class="hash-link" aria-label="Direct link to üö¢Products and tools" title="Direct link to üö¢Products and tools">‚Äã</a></h2>
<p>When considering a Sandbox environment, you may want to consider the following products and tools to assist.</p>
<ul>
<li><a href="https://learn.microsoft.com/azure/deployment-environments/overview-what-is-azure-deployment-environments?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Deployment Environments</a> - useful for 'Highly Managed Sandboxes', Azure Deployment Environments, allows you to pre-define a set of services through infrastructure as code, and offer it up to developers or Sandbox consumers, as a Service, that they can then deploy and tear down as required.</li>
<li><a href="https://learn.microsoft.com/azure/devtest-labs/devtest-lab-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Dev/Test Labs</a> - Azure DevTest Labs is a service for easily creating, using, and managing infrastructure-as-a-service (IaaS) virtual machines (VMs) and platform-as-a-service (PaaS) environments in labs. Labs offer preconfigured bases and artifacts for creating VMs, and Azure Resource Manager (ARM) templates for creating environments like Azure Web Apps or SharePoint farms. Azure DevTest Labs is useful for Lightly Managed Sandboxes, where you want to give a team access to a specific Resource Group.</li>
<li><a href="https://learn.microsoft.com/entra/id-governance/entitlement-management-access-package-create?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Entra ID Access Packages</a> - Access packages are great for giving delegated access to a specific set of resources, for a specific period of time, and can be useful for Lightly and Unmanaged  Sandboxes, where you want to give a team access to a specific Resource Group or Subscription.</li>
<li><a href="https://learn.microsoft.com/purview/purview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Microsoft Purview</a> - Microsoft Purview is a unified data governance service that helps you manage and govern your on-premises, multi-cloud, and software-as-a-service (SaaS) data. You can use Purview to understand your data, manage data policies, and ensure data privacy and compliance. Microsoft Purview is useful for understanding the data that is being used in the Sandbox.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="reference-links">üìñReference Links<a href="https://luke.geek.nz/azure/microsoft-azure-sandbox-design-considerations/#reference-links" class="hash-link" aria-label="Direct link to üìñReference Links" title="Direct link to üìñReference Links">‚Äã</a></h2>
<ol>
<li><a href="https://youtu.be/WR9zRbzYfTQ" target="_blank" rel="noopener noreferrer">Festive Tech Calender - 2023 - Azure Sandbox Design</a></li>
<li><a href="https://www.gartner.com/en/articles/gartner-top-10-strategic-technology-trends-for-2024" target="_blank" rel="noopener noreferrer">Gartner Top 10 Strategic Technology Trends for 2024</a></li>
<li><a href="https://learn.microsoft.com/en-us/azure/architecture/guide/azure-sandbox/azure-sandbox?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Sandbox (Azure Architecture Center)</a></li>
<li><a href="https://azure.microsoft.com/en-us/solutions/cloud-enablement/cloud-adoption-framework?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Microsoft Azure Cloud Adoption Framework</a></li>
<li><a href="https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/azure-subscription-service-limits?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure subscription and service limits, quotas and constraints</a></li>
<li><a href="https://github.com/BevanSin/AzureSandbox" target="_blank" rel="noopener noreferrer">BevanSin/AzureSandbox</a></li>
<li><a href="https://github.com/dazzlejim/AzureSandbox" target="_blank" rel="noopener noreferrer">dazzlejim/AzureSandbox</a></li>
<li><a href="https://www.youtube.com/watch?v=dkNAnw1InA0" target="_blank" rel="noopener noreferrer">Azure Sandbox Environment - Turbo360 Podcast</a></li>
</ol>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Tag Azure Resources with Owner using Azure Automation]]></title>
            <link>https://luke.geek.nz/azure/tag-azure-resources-owner-azure-automation-runbook/</link>
            <guid>https://luke.geek.nz/azure/tag-azure-resources-owner-azure-automation-runbook/</guid>
            <pubDate>Thu, 07 Mar 2024 07:10:25 GMT</pubDate>
            <description><![CDATA[Tag Azure Resources with Owner using Azure Automation runbook]]></description>
            <content:encoded><![CDATA[<p>Inspired by <a href="https://techcommunity.microsoft.com/t5/core-infrastructure-and-security/tagging-azure-resources-with-a-creator/ba-p/1479819?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Tagging Azure Resources with a Creator</a> an Azure function + event grid solution, that will tag resources with the creator of the resource. I wanted to see if I could do the same thing using Azure Automation runbooks, instead of using event grid but a schedule instead, to make use of an already existing <a href="https://learn.microsoft.com/azure/automation/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Automation</a> account.</p>
<p>It turns out you can, so let's take a look.</p>
<p><img decoding="async" loading="lazy" alt="Blog Heading - Tag Azure Resources with Owner using Azure Automation runbook" src="https://luke.geek.nz/assets/images/BlogHeading_TagAzureResourceswithOwnerAzureAutomation-55e6ea6bd6488ab6d0b4a8794fd4696e.png" width="1200" height="627" class="img_ev3q"></p>
<!-- -->
<p>Make sure to change the ManagementGroupID variable to match your own environment.</p>
<p>This runbook uses a System Managed Identity from the Azure Automation account, so make sure this has Contributor rights to the subscription or management group you want to tag resources in.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>This PowerShell script is designed to tag Azure resources with the user's email address who last modified them. It's particularly useful for tracking who is responsible for each resource in your Azure environment. Here's a step-by-step breakdown of what the script does:</p><ol>
<li><strong>Disable AzContext Autosave</strong>: The script starts by disabling the autosave feature for the Azure context. This ensures the script doesn't inherit any Azure context from previous sessions.</li>
<li><strong>Suppress Warnings</strong>: The script suppresses warnings related to breaking changes in Azure PowerShell. This is to prevent these warnings from cluttering the output.</li>
<li><strong>Import Modules</strong>: The script imports the Az.Accounts and Az.Resources modules, which provide the cmdlets needed to interact with Azure.</li>
<li><strong>Define Variables</strong>: The script defines a variable for the tag name (<code>$tagName</code>) and the management group ID (<code>$ManagementGroupID</code>).</li>
<li><strong>Connect to Azure</strong>: The script uses a Managed Service Identity.</li>
<li><strong>Get Subscriptions</strong>: The script defines a function (<code>Get-AzSubscriptionsFromManagementGroup</code>) that retrieves all the subscription IDs under a specified management group, including subscriptions under child management groups. It then calls this function to get the subscription IDs under the management group specified by <code>$ManagementGroupID</code>.</li>
<li><strong>Process Each Subscription</strong>: For each subscription ID retrieved, the script sets the Azure context to that subscription and retrieves all resources in the subscription.</li>
<li><strong>Process Each Resource</strong>: For each resource in the subscription, the script checks if the resource has a tag with the name specified by <code>$tagName</code>.</li>
<li><strong>Add Tag If Not Present</strong>: If the resource does not have a tag with the name specified by <code>$tagName</code>, the script retrieves the Azure activity logs for the resource for the past seven days and finds the user's email address who last modified the resource. It then adds a tag to the resource with the name specified by <code>$tagName</code> and the value set to the user's email address.
This script is designed to be run on a schedule, such as once a day, to ensure that all resources are tagged with the user's email address who last modified them.</li>
</ol></div></div>
<p><img decoding="async" loading="lazy" alt="Tag Azure Resources with Owner" src="https://luke.geek.nz/assets/images/Tag_Owner-RunbookRun-97574d5317f6c9877723c2255265e661.gif" width="1905" height="964" class="img_ev3q"></p>
<p>The Runbook is as follows:</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">&lt;# Ensures you do not inherit an AzContext in your runbook #&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Disable-AzContextAutosave</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Scope </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">Process</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Out-Null</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">#Toggle to stop warnings with regard to Breaking Changes in Azure PowerShell</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Set-Item</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Path Env:\SuppressAzurePowerShellBreakingChangeWarnings </span><span class="token operator">-</span><span class="token plain">Value </span><span class="token boolean">$true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Import the required modules</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Import-Module</span><span class="token plain"> Az</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Accounts</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Import-Module</span><span class="token plain"> Az</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Resources</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Define the tag name as a variable</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$tagName</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"Createdby"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">#Adjust to suit your management group; this is the top scope that the Script will run under</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ManagementGroupID</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">'mg-landingzones'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">&lt;# Connect using a Managed Service Identity #&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Connect-AzAccount</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Identity</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Get the subscription IDs under the specified management group AND child management groups</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzSubscriptionsFromManagementGroup</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ManagementGroupName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$mg</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzManagementGroup</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">GroupId </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ManagementGroupName</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Expand</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">foreach</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$child</span><span class="token plain"> in </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$mg</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Children</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$child</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Type</span><span class="token plain"> </span><span class="token operator">-match</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'/managementGroups$'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzSubscriptionsFromManagementGroup</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ManagementGroupName </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$child</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$child</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Select-Object</span><span class="token plain"> @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">N = </span><span class="token string" style="color:rgb(255, 121, 198)">'Name'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> E = </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">DisplayName </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">N = </span><span class="token string" style="color:rgb(255, 121, 198)">'Id'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> E = </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Name </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Setting ManagementGroupID to </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$mgid</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">DisplayName</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">'..."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Retrieving management group with ID '</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$ManagementGroupID</span><span class="token string" style="color:rgb(255, 121, 198)">'..."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$mgid</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzManagementGroup</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">GroupId </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ManagementGroupID</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Expand</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Successfully retrieved management group with ID '</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$ManagementGroupID</span><span class="token string" style="color:rgb(255, 121, 198)">'."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Retrieving subscription IDs from management group '</span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$mgid</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">DisplayName</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">'..."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$subIds</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzSubscriptionsFromManagementGroup</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ManagementGroupName </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ManagementGroupID</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">foreach</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$subId</span><span class="token plain"> in </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$subIds</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Setting subscription context for subscription </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$subId</span><span class="token string" style="color:rgb(255, 121, 198)">..."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Set-AzContext</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Subscription </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$subId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Id</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resources</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzResource</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Found resources in subscription </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$subId</span><span class="token string" style="color:rgb(255, 121, 198)">."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">foreach</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resource</span><span class="token plain"> in </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resources</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Processing resource </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$resource</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Name</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">..."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$tags</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resource</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Tags</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$null</span><span class="token plain"> </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$tags</span><span class="token plain"> </span><span class="token operator">-or</span><span class="token plain"> </span><span class="token operator">-not</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$tags</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ContainsKey</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$tagName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Resource </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$resource</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Name</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)"> does not have 'resource-owner' and  tags. Adding tags..."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$endTime</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-Date</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$startTime</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$endTime</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">AddDays</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">-</span><span class="token plain">7</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$owners</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzLog</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ResourceId </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resource</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ResourceId </span><span class="token operator">-</span><span class="token plain">StartTime </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$startTime</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">EndTime </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$endTime</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Where-Object</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Authorization</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Action </span><span class="token operator">-like</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"*/write*"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Select-Object</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ExpandProperty Caller </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$owner</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$owners</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Where-Object</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token plain"> </span><span class="token operator">-match</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Select-Object</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">First 1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token comment" style="color:rgb(98, 114, 164)">#Objects created by a Service Principal will tag the objects with a GUID instead of a name by default. You can fix this behavior by giving the Managed Identity the Application Developer role in Entra ID. </span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token comment" style="color:rgb(98, 114, 164)"># If owner is null, stop the script</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$null</span><span class="token plain"> </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$owner</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"No owner found that matches an email address."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token comment" style="color:rgb(98, 114, 164)"># Output owners</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Owners: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$owners</span><span class="token string" style="color:rgb(255, 121, 198)">, selected owner: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$owner</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$existingTags</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resource</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Tags</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$modifiedTags</span><span class="token plain"> = @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$tagName</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$owner</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token comment" style="color:rgb(98, 114, 164)"># Merge existing tags with new tags</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$allTags</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$existingTags</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$modifiedTags</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resource</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Set-AzResource</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Tag </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$allTags</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Force</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>The script is also held on <a href="https://github.com/lukemurraynz/Azure/blob/main/Azure%20Automation/Tag-ResourceOwner.ps1" target="_blank" rel="noopener noreferrer">GitHub</a>, so feel free to raise an Issue or Pull Request if you have any improvements.
If there are no logged users due to the resource being written to or created outside of the Log retention, the resource will be skipped.</p></div></div>
<p>This script could be extended with the <a href="https://techcommunity.microsoft.com/t5/azure-governance-and-management/announcing-the-public-preview-of-change-actor/ba-p/4076626?WT.mc_id=AZ-MVP-5004796#:~:text=Identifying%20who%20made%20a%20change,all%20your%20tenants%20and%20subscriptions" target="_blank" rel="noopener noreferrer">Change Actor feed</a> to determine who made a recent change to the resource.</p>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Enterprise Policy as Code with Azure DevOps]]></title>
            <link>https://luke.geek.nz/azure/enterprise-policy-code-azure-devops/</link>
            <guid>https://luke.geek.nz/azure/enterprise-policy-code-azure-devops/</guid>
            <pubDate>Sun, 18 Feb 2024 23:25:11 GMT</pubDate>
            <description><![CDATA[Enterprise Azure Policy as Code, or EPAC for short, comprises a number of scripts which can be used in a CI/CD-based system or a semi-automated use to deploy Policies, Policy Sets, Assignments, Policy Exemptions and Role Assignments. Let us take a look at its use.]]></description>
            <content:encoded><![CDATA[<p>Enterprise Azure Policy as Code (EPAC) comprises a number of scripts which can be used in a CI/CD-based system or a semi-automated use to deploy Azure Policies, Policy Sets, Assignments, Policy Exemptions and Role Assignments! This is a great way to ensure that your Azure environment complies with your company's policies and standards, so let us look at it!</p>
<p><img decoding="async" loading="lazy" alt="Blog Heading - EPAC ADO" src="https://luke.geek.nz/assets/images/BlogHeading_EPAC_ADO-a41d97fd00f51d878eaeb05f1062f2f0.png" width="1200" height="628" class="img_ev3q"></p>
<!-- -->
<p><a href="https://azure.github.io/enterprise-azure-policy-as-code/" target="_blank" rel="noopener noreferrer">Enterprise Azure Policy as Code (EPAC)</a> allows you to define and deploy your Azure policies and exemptions as code. This is a great way to ensure consistency of one or more Azure environments, including managing your exemptions in a way that is auditable and a way that can be integrated into CI/CD pull request approval processes.</p>
<p>So, let's delve a little further into it.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-enterprise-azure-policy-as-code">What is Enterprise Azure Policy as Code?<a href="https://luke.geek.nz/azure/enterprise-policy-code-azure-devops/#what-is-enterprise-azure-policy-as-code" class="hash-link" aria-label="Direct link to What is Enterprise Azure Policy as Code?" title="Direct link to What is Enterprise Azure Policy as Code?">‚Äã</a></h2>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Enterprise Azure Policy as Code, or EPAC for short, comprises a number of scripts which can be used in a CI/CD-based system or a semi-automated use to deploy Policies, Policy Sets, Assignments, Policy Exceptions and Role Assignments.</p><p>Main features include:</p><ul>
<li>Multi-tenant/environment policy deployment</li>
<li>Easy CI/CD Integration</li>
<li>Extract existing policy objects from an environment</li>
<li>Support JSON and CSV inputs for large, complex policies</li>
<li>PowerShell Module</li>
<li>Integration with Azure Landing Zone recommended policies</li>
<li>Starter Kit with examples</li>
<li>Schema to provide Intellisense for VS Code development</li>
</ul></div></div>
<p>Enterprise Policy as Code, runs primarily on PowerShell scripts, at the time of writing, there is 114 PowerShell scripts that make up this solution <em>(not all are in use for day-to-day operations)</em>, from the actual deployment to the plan, importing existing policies and initiatives, creating GitHub or Azure DevOps issues, for policy remediation tasks and even importing Azure Landing Zone policies into the solution, this solution is jam-packed with an ever-expanding toolset.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>It is worth noting that although this solution was designed and implemented by Microsoft employees, this is an <a href="https://opensource.microsoft.com/codeofconduct/" target="_blank" rel="noopener noreferrer">Open Source initiative</a> and is not officially supported by Microsoft, but the community is very active, and the solution is constantly being updated and improved upon. All <a href="https://github.com/Azure/enterprise-azure-policy-as-code/issues" target="_blank" rel="noopener noreferrer">Issues</a> can be raised directly on GitHub, and if you have any queries, concerns or issues, I suggest you look here first.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="why-would-you-use-enterprise-azure-policy-as-code">Why would you use Enterprise Azure Policy as Code?<a href="https://luke.geek.nz/azure/enterprise-policy-code-azure-devops/#why-would-you-use-enterprise-azure-policy-as-code" class="hash-link" aria-label="Direct link to Why would you use Enterprise Azure Policy as Code?" title="Direct link to Why would you use Enterprise Azure Policy as Code?">‚Äã</a></h2>
<p>So, why would you use EPAC? Before we go into that - let's go back to basics - Azure Policy.</p>
<p><img decoding="async" loading="lazy" alt="What is Azure Policy" src="https://luke.geek.nz/assets/images/WhatIsAzurePolicy-b02306db2a09442ad39eab10756720af.png" width="1680" height="945" class="img_ev3q"></p>
<p><a href="https://learn.microsoft.com/azure/governance/policy/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure policies</a> are essential to Azure governance; they are the 'make it so' of the Azure environment <em>(and beyond)</em>.</p>
<p>The policies exist to help across areas such as:</p>
<ul>
<li>Maintain regulatory compliance with industry standards</li>
<li>Security and performance consistencies</li>
<li>Enterprise-wide design principles</li>
<li>Controlling cost</li>
</ul>
<p>But how do they do that? Let us take a look at the definitions that make them sing!</p>
<p>For this, we are to look at some of the key components of a definition for the 'Function apps should authenticate to Azure Container Registry using a managed identity' policy.</p>
<p><img decoding="async" loading="lazy" alt="Azure Policy definition" src="https://luke.geek.nz/assets/images/PolicyDefinition-abd0e9ab78b3adc92f5a82019c89215b.png" width="1680" height="945" class="img_ev3q"></p>
<ul>
<li>Metadata</li>
<li>Parameters</li>
<li>Rules</li>
</ul>
<p>Metadata includes items such as: DisplayName, Mode <em>(Indexed vs All)</em>, version and categories.
Parameters give you the flexibility to adjust your policy to your environment, in this case, the policy is looking for a specific Azure Container Registry, but you could have a parameter for the resource group, the subscription, or even the identity that it uses, which can be adjusted to be unique between environments.
Rules are the actual policy; in this case, the policy is looking for a specific identity to be used to authenticate to the Azure Container Registry but will contain the type of resources that the policy will affect, the aliases or resource properties that it needs to look for to evaluate against, and even change.</p>
<p>So, why would you use EPAC? Imagine you have a large number of policies, a large number of environments, or even a large number of policy exemptions, managing your policies as code is a great way to manage them all in a consistent and auditable way, especially when you are working with different versions of policies, and policies deployed to different scopes as well.</p>
<p><img decoding="async" loading="lazy" alt="Azure Policy Scopes" src="https://luke.geek.nz/assets/images/EnterprisePolicyAsCode_PolicyAssignmentScope-7d18c856613c5eb49fafde315dae583b.png" width="1680" height="945" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-do-you-use-enterprise-azure-policy-as-code">How do you use Enterprise Azure Policy as Code?<a href="https://luke.geek.nz/azure/enterprise-policy-code-azure-devops/#how-do-you-use-enterprise-azure-policy-as-code" class="hash-link" aria-label="Direct link to How do you use Enterprise Azure Policy as Code?" title="Direct link to How do you use Enterprise Azure Policy as Code?">‚Äã</a></h2>
<p>Now that we have looked into some of the complexity of Azure policies, especially at scale. Let us take a look into how we can get going with <a href="https://azure.github.io/enterprise-azure-policy-as-code/" target="_blank" rel="noopener noreferrer">Enterprise Policy as Code</a>.</p>
<p>In this article, I am going to assume a few things:</p>
<ol>
<li>You have permission to deploy policies and policy assignments in your Azure environment</li>
<li>You have an Azure DevOps environment (we will use Azure DevOps pipelines in this article, however there is also GitHub action workflows that can be used if you are using GitHub as well) and <a href="https://azure.github.io/enterprise-azure-policy-as-code/ci-cd-app-registrations/" target="_blank" rel="noopener noreferrer">Service Connection configured</a>.</li>
</ol>
<p>We are going to leverage the EPAC <a href="https://github.com/Azure/enterprise-azure-policy-as-code/tree/main/StarterKit" target="_blank" rel="noopener noreferrer">StarterKit</a>, for the pipelines and scripts.</p>
<p>Before we get CI/CD pipelines set up, we need to do a few things locally first.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-1-import-existing-policies">Step 1: Import existing policies<a href="https://luke.geek.nz/azure/enterprise-policy-code-azure-devops/#step-1-import-existing-policies" class="hash-link" aria-label="Direct link to Step 1: Import existing policies" title="Direct link to Step 1: Import existing policies">‚Äã</a></h3>
<p>So, let's import our existing policies and set up our environment! I highly recommend importing your existing environment first, as this will give you a good starting point for your policies, policy sets and exemptions.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>This requires a computer running: <a href="https://learn.microsoft.com/powershell/scripting/install/installing-powershell-on-windows?view=powershell-7.4&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">PowerShell</a> 7.3.1 or later, 7.3.4 <em>(latest)</em> recommended, and the <a href="https://learn.microsoft.com/powershell/azure/install-azure-powershell?view=azps-11.3.0&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure PowerShell</a> module installed (Az required 9.3.0 or later).</p></div></div>
<p>In my environment, I have a range of Custom and Builtin policies and initiatives, that are mostly deployed to at the top level, including Sandbox policies, and am I also running an NZISM 3.5 initiative, which is a builtin iniative but not the most up-to-date, so as part of the EPAC implementation, I want to replace the policy assignment with 3.6 custom and assign my Sandbox policies to the Sandbox Management Group.</p>
<p>So let us get cracking!</p>
<ol>
<li>First, we need to install the EPAC PowerShell module and the Az module and connect to our Azure environment.</li>
</ol>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Install-Module</span><span class="token plain"> EnterprisePolicyAsCode </span><span class="token operator">-</span><span class="token plain">Scope CurrentUser</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Install-Module</span><span class="token plain"> Az </span><span class="token operator">-</span><span class="token plain">Scope CurrentUser</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Connect-AzAccount</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Install PowerShell modules" src="https://luke.geek.nz/assets/images/EPAC_InstallPowerShellModules-254029f276bc1c4a575625334538f865.gif" width="1427" height="430" class="img_ev3q"></p>
<ol start="2">
<li>Once that's installed and you are connected to the Azure environment that you want to export your policies from, now we can do the export. To do the export, you have to generate a BuildDefinition folder to contain your policies, assignments and exemptions.</li>
</ol>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">New-EPACDefinitionFolder</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">DefinitionsRootFolder Definitions</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Create Definitions folder" src="https://luke.geek.nz/assets/images/EPAC_CreateDefinitionsFolder-0c8ac69994b2446e31f8d70ee41b5b70.gif" width="1427" height="430" class="img_ev3q"></p>
<p>That will create the following folders and files, giving us the base scaffolding for Enterprise Policy as Code:</p>
<table><thead><tr><th>Folder &amp; Files</th><th>Type</th><th>Notes</th></tr></thead><tbody><tr><td>policyAssignments</td><td>Folder</td><td>Contains your Assignments (for both Policy and Initiatives)</td></tr><tr><td>policyDefinitions</td><td>Folder</td><td>Contains your Policy Definitions</td></tr><tr><td>policyDocumentations</td><td>Folder</td><td>Contains documentation about your policies</td></tr><tr><td>policySetDefinitions</td><td>Folder</td><td>Contains the definitions for your initiatives (or PolicySets)</td></tr><tr><td>global-settings.jsonc</td><td>File</td><td>Main configuration file, containing your environments and deployment paths</td></tr></tbody></table>
<ol start="3">
<li>Now that we have our base, scaffold - before we can import our existing Definitions and Assignments, we need to edit the 'global-settings.jsonc' file, to add in environment context.</li>
</ol>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>The file is a JSONC file, which is a JSON file with comments, so you can add comments to the file, which is great for documentation. The same jsonc format is also used for PolicyDefinitions and assignments, allowing you to add more context and notes to your policies and assignments! I encourage you to use this functionality to add notes and comments to your assignments!</p></div></div>
<p>So open the global-settings.jsonc file, and paste the following example:</p>
<div class="language-jsonc codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsonc codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        "$schema": "https://raw.githubusercontent.com/Azure/enterprise-azure-policy-as-code/main/Schemas/global-settings-schema.json",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        "pacOwnerId": "f2ce1aea-944e-4517-94fb-edada00633ae", // Generate a guid using New-Guid and place it here</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        "managedIdentityLocations": {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            "*": "australiaeast" // Update the default location for managed identities</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        "globalNotScopes": {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            "*": [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                "/resourceGroupPatterns/excluded-rg*"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            ]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        "pacEnvironments": [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                "pacSelector": "quick-start",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                "cloud": "AzureCloud",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                "tenantId": "bdb8ea1c-17da-4423-8895-6b79af002b4e", // Replace this with your tenant Id</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                "deploymentRootScope": "/providers/Microsoft.Management/managementGroups/root" // Replace this with a management group that represents the functional root in your environment. </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Create global-settings.jsconc" src="https://luke.geek.nz/assets/images/EPAC_Create-global-settings.jsconc-112062cb27d7038ca537f96c06032d52.gif" width="1651" height="912" class="img_ev3q"></p>
<p><strong>Reference: <a href="https://azure.github.io/enterprise-azure-policy-as-code/quick-start/" target="_blank" rel="noopener noreferrer">EPAC Quick Start</a></strong></p>
<p>We now need to define our overall environment, and we can start by using PowerShell to generate our own unique pacOwnerId.</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">New-Guid</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The pacOwner helps to identify who or what owns an Assignment or Policy definition deployment and needs to be unique to your EPAC environment. The pacOwnerId is used to identity policy resources that are deployed by your EPAC repository, or another EPAC isntance, legacy or another solution entirely.</p>
<p>Another thing you may need to adjust is the managedIdentityLocations, this is the default location for managed identities that are used for policies that are DeployIfNotExist and Modify. This is the location that the managed identity will be created in, if it does not exist. I will keep this as the example, AustraliaEast which is the primary region that my resources are deployed into.</p>
<p>If you run multiple regions, you can remove the wildcard and replace it with the pacEnvironments name that represents your other regions.</p>
<p>Although you can add exclusions to your individual Policy and PolicySetAssignments, the globalNotScopes is a way to exclude resources from all Policy and PolicySetAssignments, without having to add it to every single assignment, in this case, the example excludes all resources that are in a resource group that starts with 'excluded-rg'. You can exclude resources at different scopes, ie Resource Group, Subscriptions, Resouce Groups.</p>
<p>Now, lets take a look at pacEnvironments. pacEnvironments is a way to define your environments, and the deploymentRootScope is the scope that represents the functional root in your environment. This is the top scope that all your Policy and PolicySetAssignments will be deployed to, and is the scope that you will be deploying your policies definitions to.</p>
<p>The pacSelector will be used in your assignments to select what environment and scope you are deploying to, as you can have multiple environments, so give it a name that you can understand - ie 'epac-prod', 'epac-dev', 'epac-qa' etc. This will be reused in your assignments and pipelines.</p>
<p>Make sure the tenantId matches your Entra ID and the deploymentRootScope is the top-level scope that you want to deploy your policies to.</p>
<p>Save the file.</p>
<ol start="4">
<li>The next step is to import your existing policies and assignments, the commands will use the information you just defined in the 'global-settings.jsonc' file, to review of the scope and the environment of the export.</li>
</ol>
<p>To do that, we will go back to PowerShell:</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token function" style="color:rgb(80, 250, 123)">Export-AzPolicyResources</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">DefinitionsRootFolder </span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">\Definitions </span><span class="token operator">-</span><span class="token plain">OutputFolder Output</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Export-AzPolicyResources.gif" src="https://luke.geek.nz/assets/images/Export-AzPolicyResources-274a0a1cef4a119017c2e35e0303f775.gif" width="1425" height="442" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>If you want to target a specific environment, ie you have a Management Group, where you want to deploy your policies and test using the Azure Portal first <strong>(this can be useful for quickly importing assignments and policies in a format that's ready to go by EPAC)</strong>, then you can add the '-InputPacSelector' parameter and target a specific environment for export, else it will do all environments listed in the global-settings.</p></div></div>
<p>Depending on the complexity of your environment, it could take a while, but once it is done, you will have a new folder called 'Output', which will contain an export of your policy-ownerships, definitions, assignments and exemptions in an Enterprise Policy as Code useable format <em>(JSON)</em>.</p>
<p>Your Output folder will contain the policy exemptions, assignments, and definitions of your existing environment.</p>
<p>You can copy the files and folders from the Output folder, into the original Definitions folder, originally created, to bring in your existing policies and assignments into your EPAC environment.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>Now is a great time to look at those exemptions and policy assignments and see if they are still relevant, and if they are, add comments to the files to give context to the assignments and exemptions and to help with the deployment of the policies and assignments in the future.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-2-configure-azure-devops">Step 2: Configure Azure DevOps<a href="https://luke.geek.nz/azure/enterprise-policy-code-azure-devops/#step-2-configure-azure-devops" class="hash-link" aria-label="Direct link to Step 2: Configure Azure DevOps" title="Direct link to Step 2: Configure Azure DevOps">‚Äã</a></h3>
<p>Now that we have our policies and assignments imported, we can now configure our Azure DevOps environment, to automatically deploy them. I am going to go through the process from the beginning but feel free to skip to the relevant sections if you already have a project and repository setup.</p>
<ol>
<li>Login to Azure DevOps</li>
<li>Create a new project</li>
<li>Give the project a name, and a description, and select the visibility of the project <strong>(ie Private)</strong></li>
<li>Click 'Create'</li>
<li>Navigate to Repos</li>
<li>Click on Files</li>
<li>Initialize the repository with a README or add a new file</li>
</ol>
<p><img decoding="async" loading="lazy" alt="Create EPAC ADO Project" src="https://luke.geek.nz/assets/images/Create-ADO_EPACProject-35acaa80d23ed95c3393478b99d48bc6.gif" width="1905" height="964" class="img_ev3q"></p>
<p>Now that the repository has been initialized. We can now add the files from the EPAC StarterKit to the repository.</p>
<p>Clone the repository to your local computer copy the Definitions folder to the repository and commit.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>You can Clone the Git repository using <a href="https://azuredevopslabs.com/labs/azuredevops/git/?T.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Visual Studio Code</a>, or Git CLI or even <a href="https://luke.geek.nz/2021/12/30/git-using-github-desktop-on-windows-for-sysadmins/" target="_blank" rel="noopener noreferrer">GitHub Desktop</a>.</p></div></div>
<p>Once cloned, copy the Definitions folder from the Output folder, into the repository, and commit the changes.</p>
<p>Now that we have our repository setup, we can now create a pipeline to deploy our policies and assignments, to get started we will grab the Azure Pipelines from the <a href="https://github.com/Azure/enterprise-azure-policy-as-code/tree/main/StarterKit/Pipelines" target="_blank" rel="noopener noreferrer">StarterKit</a> folder, and copy them into the repository, along with the Scripts folder.</p>
<p>For this article, we will use the single-tenant-pipeline.yml file, as we are only deploying to a single environment, but if you are deploying to multiple environments, you can use the multi-tenant-pipeline.yml file.</p>
<p><img decoding="async" loading="lazy" alt="Create ADO Pipeline" src="https://luke.geek.nz/assets/images/Create_ADO-PipelineTemplate-131d7d4064333057e45023afd10bc612.gif" width="1905" height="964" class="img_ev3q"></p>
<p>Once downloaded, make sure you commit it to your repository. We will have to edit the pipeline, but before we do that - we need a Service Connection for Azure DevOps to connect to Azure to deploy the policies and assignments.</p>
<ol>
<li>Open your EPAC Azure DevOps project</li>
<li>Click on Project Settings</li>
<li>Select Service Connections</li>
<li>Click on Create Service Connection</li>
<li>Click Azure Resource Manager</li>
<li>Click Next</li>
<li>Select Workload Identity Federation (Automatic) and click Next</li>
<li>Select Management Group</li>
<li>Select your top-level management group, that matches your Enterprise Policy as Code environment (ie where the definitions will be deployed to)</li>
<li>Type in a name and description and click Save <strong>(make sure this is a name that is easy to understand, and what its function is, we will reuse the name in our pipelines)</strong></li>
</ol>
<p><img decoding="async" loading="lazy" alt="Create Service Principal" src="https://luke.geek.nz/assets/images/Create_ADO-SPN-7c51a1d317687cbfca9f09efa4646cce.gif" width="1905" height="964" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Enterprise Policy as Code (EPAC) suggests the least privileged and just enough permissions to deploy the policies, assignment and RBAC <strong>(Role Based Access Control)</strong> where they need to.</p><p>The pipeline itself will look for the following separate Service Connections:</p><ul>
<li>devServiceConnection - This service connection is used for development purposes, allowing the pipeline to connect to the development environment and deploy policies and assignments.</li>
<li>tenantPlanServiceConnection - This service connection is used for managing the policy plan, which includes creating and updating policy definitions, policy sets, and policy initiatives.</li>
<li>tenantDeployServiceConnection - This service connection is used for deploying policy assignments and exemptions to the target environment.</li>
<li>tenantRolesServiceConnection - This service connection is used for managing RBAC (Role-Based Access Control) roles and permissions in the target environment.</li>
</ul><p>So consider whether you have separate scopes and service principals for your environments.</p></div></div>
<p>For the purposes of this article, I am going to use the same service principal to deploy all the EPAC functions, so let's edit the pipeline to use it.</p>
<ol>
<li>You can edit the Pipeline, either locally with Visual Studio Code and recommit it, or edit it directly in Azure DevOps, update the following variables with the relevant service connection names:</li>
</ol>
<ul>
<li>devServiceConnection</li>
<li>tenantPlanServiceConnection</li>
<li>tenantDeployServiceConnection</li>
<li>tenantRolesServiceConnection</li>
</ul>
<p><img decoding="async" loading="lazy" alt="Edit ADO Pipeline" src="https://luke.geek.nz/assets/images/Edit_ADO-Pipeline_SPN-59f9f6285d55fdebcd41ddf30877575d.gif" width="1905" height="964" class="img_ev3q"></p>
<p>The single-tenant Azure DevOps pipeline has 5 stages:</p>
<table><thead><tr><th>Stage</th><th>Notes</th></tr></thead><tbody><tr><td>devStage</td><td>This stage is used for planning, deploying, and assigning roles in the development environment. It uses the&nbsp;devServiceConnection&nbsp;to connect to Azure. The stage is only executed if the build reason is 'Manual', 'IndividualCI', or 'BatchedCI' and the source branch is not 'main'.</td></tr><tr><td>tenantPlanFeatureStage</td><td>This stage is used for planning feature branches in the tenant environment. It uses the tenantPlanServiceConnection to connect to Azure. This stage depends on the devStage and is only executed if the devStage has not failed or been canceled, the build reason is 'Manual', 'IndividualCI', or 'BatchedCI', and the source branch is not 'main'.</td></tr><tr><td>tenantPlanMainStage</td><td>This stage is used for planning the main branch in the tenant environment. It uses the tenantPlanServiceConnection to connect to Azure. This stage depends on the tenantPlanFeatureStage and is only executed if the tenantPlanFeatureStage has not failed or been canceled, the build reason is 'Manual', 'IndividualCI', or 'BatchedCI', and the source branch is 'main'.</td></tr><tr><td>tenantDeployPolicyStage</td><td>This stage is used for deploying policies in the tenant environment. It uses the tenantDeployServiceConnection to connect to Azure. This stage depends on the tenantPlanMainStage and is only executed if the tenantPlanMainStage has not failed or been canceled, the tenantPlanMainStage has policy changes to deploy, the build reason is 'Manual', 'IndividualCI', or 'BatchedCI', and the source branch is 'main'.</td></tr><tr><td>tenantRolesStage</td><td>This stage is used for deploying role assignments in the tenant environment. It uses the tenantRolesServiceConnection to connect to Azure. This stage depends on the tenantDeployPolicyStage and is only executed if the tenantDeployPolicyStage has not failed or been canceled, the tenantPlanMainStage has role changes to deploy, the build reason is 'Manual', 'IndividualCI', or 'BatchedCI', and the source branch is 'main'.</td></tr></tbody></table>
<p>The name 'Tenant' is used to represent the environment that the policies and assignments are being deployed to. Tenant is the default name of the EPAC environment, so we will need to change this, to reflect our own environments. This is the pacSelector name, in the global-settings.jsonc file, that we created earlier.</p>
<p>I will go back and add a new Service Connection, for Development, and add another development environment to the global-settings.jsonc. You don't need to do this, but it does give you the option to test your policies and assignments before deploying them to your main environment.</p>
<p>Now we need to edit the pipeline again, to align to our pacEnvironments.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>You could do a a full Find and Replace, of the Word Tenant on the pipeline and replace it with your Production pacEnvironment name, just be wary that the stage name is used as a depedency for other steps, so you will need to make sure all references have been updated.</p></div></div>
<p>Once you have made the changes, commit the pipeline to your repository.</p>
<p><img decoding="async" loading="lazy" alt="Edit ADO Pipeline - pacEnvironment" src="https://luke.geek.nz/assets/images/Edit_ADO-Pipeline_pacEnvironments-07b7d7bbe8d09e9716bb05d15ea2c305.gif" width="1905" height="964" class="img_ev3q"></p>
<p>Before we look at actually running the pipeline and redeploying the policies under Enterprise Policy as Code, we need to be aware of another environment option - and that is desiredState.</p>
<p>desiredState allows you to control, how much control EPAC has over your environment, ie how much of a 'make it so'.</p>
<p>desiredState options are:</p>
<ul>
<li>full</li>
<li>ownedOnly</li>
</ul>
<p>If the desired state strategy is 'Full', then EPAC will manage all the policies and assignments in the environment and will remove any policies and assignments that are not in the EPAC repository.
If the desiredState strategy is 'ownedOnly', then EPAC will only manage the policies and assignments that are in the EPAC repository, and will not remove any policies and assignments that are not in the EPAC repository.</p>
<p>Full is the default desiredState, so if you want to use ownedOnly, you will need to add the desiredState to the global-settings.jsonc file for the environment.</p>
<div class="language-jsonc codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsonc codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">// desiredState is an optional object that specifies the desired state of the environment.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          "desiredState": { // [optional]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              // strategy specifies the strategy to achieve the desired state. The default is "full".</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              "ownedOnly": "full" // default full</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Another environment option is related to Defender for Cloud. <a href="https://learn.microsoft.com/azure/defender-for-cloud/policy-reference?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Defender for Cloud</a> uses Azure Policy Assignments to enable and configure the various capabilities.
Enterprise Policy as Code could remove the Defender for Cloud assignments if they are not in the EPAC repository, so you can add the following to the global-settings.jsonc file to prevent this from happening.</p>
<div class="language-jsonc codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsonc codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain"> "desiredState": { // [optional]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              // strategy specifies the strategy to achieve the desired state. The default is "full".</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              "strategy": "full" ,// default full</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              "keepDfcSecurityAssignments": true // default false</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If set to true or strategy is ownedOnly, EPAC will not remove Security Policy assignments created by Defender for Cloud.
If omitted or set to false and strategy is full, EPAC will remove Security Policy Set Assignments created by Defender for Cloud.</p>
<p>Even though these settings are managed by the default behaviour of Enterprise Policy as Code, I prefer to make sure they are added in the configuration for awareness. Security Policies should be managed by EPAC at the Management Group level; this is the recommended approach for managing Security Policies instead of relying on the auto-assignments, but as usual, it comes down to business requirements.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-3-run-the-pipeline">Step 3: Run the Pipeline<a href="https://luke.geek.nz/azure/enterprise-policy-code-azure-devops/#step-3-run-the-pipeline" class="hash-link" aria-label="Direct link to Step 3: Run the Pipeline" title="Direct link to Step 3: Run the Pipeline">‚Äã</a></h3>
<div class="theme-admonition theme-admonition-danger admonition_xJq3 alert alert--danger"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>danger</div><div class="admonitionContent_BuS1"><p>Make sure you test your deployment in a development environment before deploying to your main environment, especially if you are using the 'full' desiredState strategy.</p></div></div>
<p>Now it's time to import the pipeline.</p>
<ol>
<li>Login to Azure DevOps</li>
<li>Navigate to your EPAC project</li>
<li>Navigate to Pipelines</li>
<li>Click on Create Pipeline</li>
<li>Click on Azure Repos Git</li>
<li>Select your repository</li>
<li>Select Existing Azure pipelines YAML file</li>
<li>Under path, select single-tenant-pipeline.yml</li>
<li>Click Save</li>
</ol>
<p><img decoding="async" loading="lazy" alt="Import ADO Pipeline" src="https://luke.geek.nz/assets/images/Import_ADO-Pipeline-c0c611311aca5b5fff308746e277797d.gif" width="1905" height="964" class="img_ev3q"></p>
<p>Now that it's imported, we can run the pipeline. The first pipeline deployment is aimed at making the state of Azure match the EPAC environment and also giving access to the pipelines to the Service Connections.</p>
<p><img decoding="async" loading="lazy" alt="Run ADO Pipeline" src="https://luke.geek.nz/assets/images/Run_ADO-Pipeline-72afa5d25f14d97a32c20e47e2a72943.gif" width="1905" height="964" class="img_ev3q"></p>
<p>If this is the first time the pipeline has been run, there may be delays, as you need to approve the pipeline to be able to use the Service Connections.</p>
<p>Congratulations! You have deployed your Azure Policy as Code!</p>
<p>If you login to the Azure Portal and navigate to your <a href="https://portal.azure.com/#view/Microsoft_Azure_Policy/PolicyMenuBlade/~/Assignments" target="_blank" rel="noopener noreferrer">Policies and assignments</a>, they should match.</p>
<p><img decoding="async" loading="lazy" alt="Azure Policy Assignments" src="https://luke.geek.nz/assets/images/AzurePortal_PolicyAssignments-d9665ddff7687b4d9ee52c07d99066ca.png" width="1860" height="630" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="policy-configuration">Policy configuration<a href="https://luke.geek.nz/azure/enterprise-policy-code-azure-devops/#policy-configuration" class="hash-link" aria-label="Direct link to Policy configuration" title="Direct link to Policy configuration">‚Äã</a></h2>
<p>Now that the policies and assignments are deployed, you can start to configure your policies and assignments to match your environment.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="change-assignment-scope">Change assignment scope<a href="https://luke.geek.nz/azure/enterprise-policy-code-azure-devops/#change-assignment-scope" class="hash-link" aria-label="Direct link to Change assignment scope" title="Direct link to Change assignment scope">‚Äã</a></h3>
<p>In my scenario, my Sandbox policies are assigned to my Lukegeeknz Management Group, and I want them to be assigned to my Sandbox Management Group, so I will need to update the policy assignments to reflect this.</p>
<p>I will test this by deploying it into a New Branch, which will trigger the dev Plan.</p>
<p><img decoding="async" loading="lazy" alt="Change assignment scope" src="https://luke.geek.nz/assets/images/Change_EPAC-AssignmentScopeSandbox-b20af13b32d9f00de96df5bbc45c6289.gif" width="1905" height="964" class="img_ev3q"></p>
<p>And we can see in the plan that the assignment will change successfully.</p>
<p><img decoding="async" loading="lazy" alt="Azure DevOps epac-dev plan" src="https://luke.geek.nz/assets/images/Run_ADO-Pipeline_Dev_Plan-592f4f43bc055370866dba7cec16af03.png" width="1110" height="747" class="img_ev3q"></p>
<p>Now, let's merge or change into Production by opening up a Pull Request; once approved and merged, the Sandbox assignment will be updated in Production.</p>
<p><img decoding="async" loading="lazy" alt="EPAC Pull Request" src="https://luke.geek.nz/assets/images/Change_EPAC-AssignmentScopeSandboxPR-603ce031e8264642485384496e822f89.gif" width="1905" height="964" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="Azure Policy Assignment" src="https://luke.geek.nz/assets/images/AzurePortal_PolicyAssignments.pngAfterChange-07735dd82cf91181554af7de91fca2c3.png" width="1630" height="634" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="reference">Reference<a href="https://luke.geek.nz/azure/enterprise-policy-code-azure-devops/#reference" class="hash-link" aria-label="Direct link to Reference" title="Direct link to Reference">‚Äã</a></h2>
<p>You can view my EPAC code for reference directly on GitHub: <a href="https://github.com/lukemurraynz/EPAC_ADO" target="_blank" rel="noopener noreferrer">lukemurraynz/EPAC_ADO</a>.</p>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Accessing KeyVault from Azure DevOps]]></title>
            <link>https://luke.geek.nz/azure/accessing-keyvault-azure-devops/</link>
            <guid>https://luke.geek.nz/azure/accessing-keyvault-azure-devops/</guid>
            <pubDate>Sat, 03 Feb 2024 10:56:08 GMT</pubDate>
            <description><![CDATA[Access an Azure Key vault from a Microsoft-hosted agent in Azure DevOps]]></description>
            <content:encoded><![CDATA[<p>If you are running a <a href="https://learn.microsoft.com/azure/devops/pipelines/agents/agents?view=azure-devops&amp;tabs=yaml%2Cbrowser&amp;WT.mc_id=AZ-MVP-5004796#microsoft-hosted-agents" target="_blank" rel="noopener noreferrer">Microsoft-hosted Azure DevOps agent</a>, you may need to access a <a href="https://azure.microsoft.com/products/key-vault?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">KeyVault</a> to retrieve secrets. This is a common scenario when deploying resources to Azure.</p>
<p>In this post, I will show you how to access a KeyVault from an Azure DevOps pipeline by adding the IP of the Azure DevOps agent directly into your Azure Keyvault and removing it after it retrieves the secrets.</p>
<p><img decoding="async" loading="lazy" alt="Accessing KeyVault from a Azurne DevOps&nbsp;Microsoft&nbsp;Hosted&nbsp;Agent" src="https://luke.geek.nz/assets/images/BlogHeadingAccessingKeyVaultfromAzureDevOps-544d1dbdffe23f468b00b7e0022bd75d.gif" title="Accessing KeyVault from a Azurne DevOps&nbsp;Microsoft&nbsp;Hosted&nbsp;Agent" width="1200" height="628" class="img_ev3q"></p>
<!-- -->
<p>When attempting to retrieve secrets from a KeyVault using Azure DevOps, you may get an error such as:</p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>##[error]Get secrets failed. Error: Client address is not authorized and caller is not a trusted service.</p></div></div>
<p>This is due to the Firewall of the Keyvault being enabled, which is best practice.</p>
<p>You have a few options here:</p>
<ul>
<li>Option 1: Enable private endpoint for the KeyVault and use a <a href="https://learn.microsoft.com/azure/devops/pipelines/agents/agents?view=azure-devops&amp;tabs=yaml%2Cbrowser&amp;WT.mc_id=AZ-MVP-5004796#self-hosted-agents" target="_blank" rel="noopener noreferrer">self-hosted agent</a>. This is the most secure option, but it requires more setup and configuration, and a self-hosted agent, running on a Virtual Machine or <a href="https://luke.geek.nz/azure/hosted-agents-container-apps-job/" target="_blank" rel="noopener noreferrer">Container Apps</a>.</li>
<li>Option 2: Add the IP of the Azure DevOps agent to the KeyVault firewall rules. This is the easiest option, but it's not the most secure, as the IP address of the Microsoft hosted agents can change <em>(the Microsoft hosted agents have a dynamic IP address)</em>.</li>
</ul>
<p>Not all organisations have the resources to support a self-hosted agent, so we will look at Option 2.</p>
<p><img decoding="async" loading="lazy" alt="Azure KeyVault - Networking Blade (Azure Portal)" src="https://luke.geek.nz/assets/images/Azure_KeyVault_NetworkingPane-05c5e2d8f1cd5c4f5bebd7206b9ea4e4.png" title="Azure KeyVault - Networking Blade (Azure Portal)" width="1681" height="830" class="img_ev3q"></p>
<p>As a status, the Microsoft Hosted agents can come from any number of <a href="https://www.microsoft.com/en-us/download/details.aspx?id=56519?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Microsoft-owned IP addresses</a> from the region, that your Azure DevOps organisation is hosted.</p>
<p>You may immediately want to check the <strong>Allow trusted Microsoft services to bypass this firewall</strong> as an instant thought, but <a href="https://learn.microsoft.com/en-us/azure/key-vault/general/network-security?WT.mc_id=AZ-MVP-5004796#key-vault-firewall-enabled-trusted-services-only" target="_blank" rel="noopener noreferrer"> Azure DevOps</a> is not an assumed trusted Microsoft service, and its not hosted within your subscription boundary.</p>
<p>So, that leaves us with enabling public access to the key vault, right? Because the IP will be different each time? Not quite! What we can do is:</p>
<ol>
<li>Add the IP of the Azure DevOps agent to the KeyVault firewall rules.</li>
<li>Do the task, required from Azure DevOps (i.e. retrieve the secrets)</li>
<li>Remove the IP of the Azure DevOps agent from the KeyVault firewall rules.</li>
</ol>
<p>So, let's take a look at the Tasks you can use in your Azure DevOps pipelines to achieve this.</p>
<p>The following tasks use an Azure CLI command to grab the IP address of the Azure DevOps agent and then add it to the KeyVault firewall rules, and then remove it after the secrets have been retrieved, tasks below. References to the KeyVaultArmSvcConnectionName is the Service Connection that is used to authenticate to the Azure Subscription, so make sure this is adjusted for your environment.
The keyVaultName is the name of the keyVault you want to access.</p>
<p>Note: The condition criteria is set to succeed or fail so that the task will run regardless of whether previous tasks have succeeded or failed.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">AzureCLI@2.yml</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># This task uses Azure CLI to add the IP address of the Azure DevOps agent to the firewall of an Azure Key Vault.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> AzureCLI@2  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Specifies the task to use Azure CLI version 2.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Add Agent IP From Key Vault  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The name displayed for this task in the Azure DevOps pipeline.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">condition</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> succeededOrFailed()  </span><span class="token comment" style="color:rgb(98, 114, 164)"># This task will run regardless of whether previous tasks have succeeded or failed.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The section where you specify input parameters for the task.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">azureSubscription</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> parameters.keyVaultArmSvcConnectionName </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The Azure subscription that the task should use. The value is taken from the keyVaultArmSvcConnectionName parameter.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">scriptType</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> bash  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Specifies that the script to be run is a Bash script.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">scriptLocation</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> inlineScript  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Specifies that the script will be provided directly in the pipeline file, rather than being located in an external file.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Begins the section where the actual script is provided. The | character indicates that a multi-line string will follow.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      agentIP=$(curl </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">s https</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">//checkip.amazonaws.com)  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Uses the curl command to get the public IP address of the Azure DevOps agent and stores it in the agentIP variable.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">echo "Agent IP</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> $agentIP"  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Prints the IP address to the console.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      az keyvault network</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">rule add </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">name "$</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> parameters.keyVaultName </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">" </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">ip</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">address "$agentIP" </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">only</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">show</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">errors  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Uses the Azure CLI to add the IP address of the Azure DevOps agent to the firewall of the Azure Key Vault specified by the keyVaultName parameter. The --only-show-errors option means that the command will only output information if an error occurs.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h1>Remove Agent IP to KeyVault Firewall after your other tasks</h1>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">AzureCLI@2.yml</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># This task uses Azure CLI to remove the IP address of the Azure DevOps agent from the firewall of an Azure Key Vault.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> AzureCLI@2  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Specifies the task to use Azure CLI version 2.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Remove Agent IP From Key Vault  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The name displayed for this task in the Azure DevOps pipeline.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">condition</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> succeededOrFailed()  </span><span class="token comment" style="color:rgb(98, 114, 164)"># This task will run regardless of whether previous tasks have succeeded or failed.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The section where you specify input parameters for the task.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">azureSubscription</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> parameters.keyVaultArmSvcConnectionName </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The Azure subscription that the task should use. The value is taken from the keyVaultArmSvcConnectionName parameter.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">scriptType</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> bash  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Specifies that the script to be run is a Bash script.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">scriptLocation</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> inlineScript  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Specifies that the script will be provided directly in the pipeline file, rather than being located in an external file.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Begins the section where the actual script is provided. The | character indicates that a multi-line string will follow.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      agentIP=$(curl </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">s https</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">//checkip.amazonaws.com)  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Uses the curl command to get the public IP address of the Azure DevOps agent and stores it in the agentIP variable.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">echo "Agent IP</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> $agentIP"  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Prints the IP address to the console.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      az keyvault network</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">rule remove </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">name "$</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> parameters.keyVaultName </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">" </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">ip</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">address "$agentIP" </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">only</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">show</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">errors  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Uses the Azure CLI to remove the IP address of the Azure DevOps agent from the firewall of the Azure Key Vault specified by the keyVaultName parameter. The --only-show-errors option means that the command will only output information if an error occurs.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Using the Azure Naming Tool API to name your Bicep resources]]></title>
            <link>https://luke.geek.nz/azure/azure-naming-tool-api-bicep-resources/</link>
            <guid>https://luke.geek.nz/azure/azure-naming-tool-api-bicep-resources/</guid>
            <pubDate>Tue, 16 Jan 2024 03:44:02 GMT</pubDate>
            <description><![CDATA[Deployment of Azure Naming Tool into an Azure WebApp and testing the API.]]></description>
            <content:encoded><![CDATA[<p>The <a href="https://github.com/mspnp/AzureNamingTool" target="_blank" rel="noopener noreferrer">Azure Naming Tool</a> was created to help administrators define and manage their naming conventions for Azure resources while providing a simple interface for users to generate a compliant name.
The tool was developed using a naming pattern based on <a href="https://learn.microsoft.com/azure/cloud-adoption-framework/ready/azure-best-practices/naming-and-tagging?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Microsoft's best practices</a>. Once an administrator has defined the organizational components, users can use the tool to generate a name for the desired Azure resource.</p>
<p>Today, we will use the Azure Naming Tool API to generate a name for our storage account bicep resource.</p>
<p><img decoding="async" loading="lazy" alt="Azure Naming Tool Logo" src="https://luke.geek.nz/assets/images/azurenamingtoollogo-988ade636a1de804bd46948462c4e980.png" title="Azure Naming Tool Logo" width="750" height="450" class="img_ev3q"></p>
<!-- -->
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="https://luke.geek.nz/azure/azure-naming-tool-api-bicep-resources/#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">‚Äã</a></h2>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>I had a previous Blog article for <a href="https://luke.geek.nz/2022/07/11/deploy-azure-naming-tool-into-an-azure-webapp-as-a-container/" target="_blank" rel="noopener noreferrer">Deploying Azure Naming Tool into an Azure WebApp as a container</a> this was a previous version, as of June 2022, but check it out, if you run into issues with your deployment. Today, we will deploy the latest version at the time of this article straight to a WebApp.</p></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>The process is reasonably well documented directly on <a href="https://github.com/mspnp/AzureNamingTool/wiki" target="_blank" rel="noopener noreferrer">Wiki of GitHub repository</a> for Azure Naming Tool, and it is what I followed, but to trigger the Publishing Profile button (if it greyed out) in the Azure Portal, for a brand new web app, I was able to go into Configuration/General Settings and Turn Basic Auth Publishing Off, Save, then back on, Save, and the button was enabled.</p></div></div>
<p>So, now we have our Azure Naming Tool set up and deployed; we can test it out by using the API to generate a name for our storage account bicep resource.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="scripts">Scripts<a href="https://luke.geek.nz/azure/azure-naming-tool-api-bicep-resources/#scripts" class="hash-link" aria-label="Direct link to Scripts" title="Direct link to Scripts">‚Äã</a></h2>
<blockquote>
<p>To do this, we will have three scripts:</p>
</blockquote>
<ul>
<li><strong>main.bicep</strong> - This is our main bicep file, which will deploy our storage account and use the Azure Naming Tool API to generate a name for it.</li>
<li><strong>command.ps1</strong> - This will be our PowerShell script, which will call the Azure Naming Tool API, generate a name for our storage account, and then trigger the Bicep deployment.</li>
<li><strong>Request-ResourceName.ps1</strong> - This is our PowerShell function that will call the Azure Naming Tool API and return the generated name value.</li>
</ul>
<p>Command.ps1 will call the other scripts.</p>
<p>So let us take a look at those:</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">command.ps1</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Check if the Az.Accounts module is installed</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$module</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-Module</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ListAvailable </span><span class="token operator">-</span><span class="token plain">Name Az</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Accounts</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># If the module is not installed, install it</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$null</span><span class="token plain"> </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$module</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Install-Module</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name Az</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Accounts </span><span class="token operator">-</span><span class="token plain">Scope CurrentUser </span><span class="token operator">-</span><span class="token plain">Force</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Check if the Az.Resources module is installed</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$module</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-Module</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ListAvailable </span><span class="token operator">-</span><span class="token plain">Name Az</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Resources</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># If the module is not installed, install it</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$null</span><span class="token plain"> </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$module</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Install-Module</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name Az</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Resources </span><span class="token operator">-</span><span class="token plain">Scope CurrentUser </span><span class="token operator">-</span><span class="token plain">Force</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Connect-AzAccount -UseDeviceAuthentication</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Import the Request-ResourceName function</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">\</span><span class="token function" style="color:rgb(80, 250, 123)">Request-ResourceName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ps1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Define the API key and the Azure Naming Tool site name</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$API</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">''</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$AzNamingToolSiteName</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">''</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Call the function with some example parameters</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$storageAccountName</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Request-ResourceName</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">API </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$API</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">AzNamingToolSiteName </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$AzNamingToolSiteName</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">resourceEnvironment </span><span class="token string" style="color:rgb(255, 121, 198)">'dev'</span><span class="token plain">  </span><span class="token operator">-</span><span class="token plain">resourceInstance </span><span class="token string" style="color:rgb(255, 121, 198)">'1'</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">resourceLocation </span><span class="token string" style="color:rgb(255, 121, 198)">'aue'</span><span class="token plain">  </span><span class="token operator">-</span><span class="token plain">resourceType </span><span class="token string" style="color:rgb(255, 121, 198)">'st'</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">createdBy </span><span class="token string" style="color:rgb(255, 121, 198)">'me'</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">resourceProjAppSvc </span><span class="token string" style="color:rgb(255, 121, 198)">'spa'</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Select-Object</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ExpandProperty resourceName</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Define the resource group and location</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceGroupName</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">'stgaccount_rg'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Create the resource group if it doesn't exist</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceGroup</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzResourceGroup</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceGroupName</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ErrorAction SilentlyContinue</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$null</span><span class="token plain"> </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceGroup</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">New-AzResourceGroup</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceGroupName</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Location </span><span class="token string" style="color:rgb(255, 121, 198)">'australiaeast'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Deploy the Bicep file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">New-AzResourceGroupDeployment</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ResourceGroupName </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceGroupName</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">TemplateFile </span><span class="token string" style="color:rgb(255, 121, 198)">'./main.bicep'</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">storageAccountName </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$storageAccountName</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">main.bicep</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> storageAccountName </span><span class="token datatype class-name">string</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> location </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">resourceGroup</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">location</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> storageacc </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.Storage/storageAccounts@2023-01-01'</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> storageAccountName</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">location</span><span class="token operator">:</span><span class="token plain"> location</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">accessTier</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Hot'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">sku</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain">  </span><span class="token string" style="color:rgb(255, 121, 198)">'Standard_LRS'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">kind</span><span class="token operator">:</span><span class="token plain">  </span><span class="token string" style="color:rgb(255, 121, 198)">'BlobStorage'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">Request-ResourceName.ps1</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Define the function that requests a resource name</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Request-ResourceName</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Define the parameters that the function accepts</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[Parameter(Mandatory=$true)]</span><span class="token plain"> </span><span class="token namespace">[string]</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$API</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The API key</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[Parameter(Mandatory=$true)]</span><span class="token plain"> </span><span class="token namespace">[string]</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$AzNamingToolSiteName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The Azure Naming Tool site name</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[Parameter(Mandatory=$true)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">ValidateSet</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'dev'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'prd'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'sbx'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'shd'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'stg'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'tst'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'uat'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[ValidateLength(1,5)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[string]</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceEnvironment</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The environment of the resource</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[Parameter(Mandatory=$false)]</span><span class="token plain"> </span><span class="token namespace">[string]</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceFunction</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The function of the resource</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[Parameter(Mandatory=$true)]</span><span class="token plain"> </span><span class="token namespace">[string]</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceInstance</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The instance of the resource</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[Parameter(Mandatory=$true)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">ValidateSet</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'aue'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'aus'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'nzn'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'	usw'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[ValidateLength(1,10)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[string]</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceLocation</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The location of the resource</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[Parameter(Mandatory=$false)]</span><span class="token plain"> </span><span class="token namespace">[string]</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceOrg</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The organization of the resource</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">Parameter</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">Mandatory=</span><span class="token boolean">$false</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> HelpMessage=</span><span class="token string" style="color:rgb(255, 121, 198)">"The shortcode of the project. This needs to match an existing Project in Azure Naming Tool."</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[ValidateLength(1,3)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[string]</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceProjAppSvc</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The project or application service of the resource</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[Parameter(Mandatory=$true)]</span><span class="token plain"> </span><span class="token namespace">[string]</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceType</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The type of the resource</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[Parameter(Mandatory=$false)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[ValidateLength(1,5)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[string]</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceUnitDept</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The unit or department of the resource</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[Parameter(Mandatory=$false)]</span><span class="token plain"> </span><span class="token namespace">[Hashtable]</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$customComponents</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Any custom components for the resource</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[Parameter(Mandatory=$false)]</span><span class="token plain"> </span><span class="token namespace">[string]</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$createdBy</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The creator of the resource</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Define the headers for the API request</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$headers</span><span class="token plain"> = @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">'accept'</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">'*/*'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">'APIKey'</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$API</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">'Content-Type'</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">'application/json'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Define the body of the API request</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$body</span><span class="token plain"> = @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">'resourceEnvironment'</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceEnvironment</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">'resourceFunction'</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceFunction</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">'resourceInstance'</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceInstance</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">'resourceLocation'</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceLocation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">'resourceOrg'</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceOrg</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">'resourceProjAppSvc'</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceProjAppSvc</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">'resourceType'</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceType</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">'resourceUnitDept'</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceUnitDept</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">'customComponents'</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$customComponents</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">'createdBy'</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$createdBy</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">ConvertTo-Json</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Depth 6  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Convert the body to JSON format</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Send the API request and store the response</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">try</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$response</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Invoke-RestMethod</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Uri </span><span class="token string" style="color:rgb(255, 121, 198)">"https://</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$AzNamingToolSiteName</span><span class="token string" style="color:rgb(255, 121, 198)">.azurewebsites.net/api/ResourceNamingRequests/RequestName"</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Method Post </span><span class="token operator">-</span><span class="token plain">Headers </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$headers</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Body </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$body</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$null</span><span class="token plain"> </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$response</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"The API returned a successful response with no body."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"The API returned a successful response, with the name generated as: </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$response</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">resourceName</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"An error occurred: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Return the response</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$response</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="deployment">Deployment<a href="https://luke.geek.nz/azure/azure-naming-tool-api-bicep-resources/#deployment" class="hash-link" aria-label="Direct link to Deployment" title="Direct link to Deployment">‚Äã</a></h2>
<p>Now that we have the scripts, it's time to run it. I am going to run this from a GitHub Codespace that already has the latest version of PowerShell and Bicep installed. I have whitelisted the IP of the Codespace to allow it to access the Azure Naming Tool WebApp.</p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>Your Azure Naming Tool configuration is key! It needs to align with your organisational needs, naming conventions, projects and departments where necessary. Different resource types, will require different configurations, so make sure you plan this out, the Azure Naming Tool reference page can be key to review for successful name generation.</p></div></div>
<p>First, we will need the API Key, so within the Azure Naming Tool, click on Admin, enter your password and Copy the Full Access API Key. This key is needed as the generated API resource name is a POST operation.</p>
<p><img decoding="async" loading="lazy" alt="Copy Azure Naming Tool API" src="https://luke.geek.nz/assets/images/AzureNamingTool_CopyAPIKey-b49125659c11a5b15d570d61c92f364a.gif" title="Azure Naming Tool API Key" width="1969" height="944" class="img_ev3q"></p>
<p>You will also need the name of your Azure Naming Tool WebApp, the Request-ResourceName script does make an assumption that this is an Azure hosted website <em>(ie <a href="https://aznamingtoolgeeknz.azurewebsites.net/" target="_blank" rel="noopener noreferrer">https://aznamingtoolgeeknz.azurewebsites.net/</a>)</em>. If you are hosting it elsewhere, you will need to update the script to reflect the domain name.</p>
<p>Enter the API and WebApp name into the command.ps1 script, these are parameters for the script, along with resourceType, resourceInstance, resourceLocation, etc. Different resource types and configurations will require different parameters.</p>
<p>Now it's time to create our Storage Account using a Name generated from the Azure Naming Tool.</p>
<p>The command script will trigger a REST API call to Azure Naming Tool to generate a name for our storage account. Then we will use that name as a parameter for the storageAccountName Bicep deployment.</p>
<p><img decoding="async" loading="lazy" alt="Generate Name using Azure Naming Tool API" src="https://luke.geek.nz/assets/images/AzureNamingTool_RunAPIGenerateName-b607292f529c299be8d77ac10e3db4bd.gif" title="Azure Naming Tool generate name" width="1903" height="944" class="img_ev3q"></p>
<p>Our Storage account is now created:</p>
<p><img decoding="async" loading="lazy" alt="Azure Storage account created" src="https://luke.geek.nz/assets/images/Created_StorageAccount-909a11e3549734d09f4b34dc798ff8c5.png" title="Created Azure Storage account" width="1883" height="453" class="img_ev3q"></p>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Add existing Azure resource to a Deployment Stack]]></title>
            <link>https://luke.geek.nz/azure/existing-resource-deploymentstack/</link>
            <guid>https://luke.geek.nz/azure/existing-resource-deploymentstack/</guid>
            <pubDate>Tue, 09 Jan 2024 06:05:43 GMT</pubDate>
            <description><![CDATA[Add existing Azure resources to a Deployment Stack using Bicep.]]></description>
            <content:encoded><![CDATA[<p>An Azure <a href="https://learn.microsoft.com/azure/azure-resource-manager/bicep/deployment-stacks?tabs=azure-powershell&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">deployment stack</a> is a type of Azure resource that enables the management of a group of Azure resources as an atomic unit.</p>
<p>If you deploy a new Deployment Stack, all resources in your ARM/Bicep template will be included as Managed resources, but what if you want to include a resource deployed outside of Bicep into your Deployment Stack?</p>
<p><img decoding="async" loading="lazy" alt="Blog Heading " src="https://luke.geek.nz/assets/images/BlogHeading_DeploymentStackMissingResource-392444bd56f4fa1fc9df54f4b2ad10fb.gif" width="1200" height="628" class="img_ev3q"></p>
<p>A community member approached me to ask how they could do this, so let us take a look.</p>
<!-- -->
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>An Azure deployment stack is a type of Azure resource that enables the management of a group of Azure resources as an atomic unit. When a Bicep file or an ARM JSON template is submitted to a deployment stack, it defines the resources that are managed by the stack. If a resource that was previously included in the template is removed, it will either be detached or deleted based on the specified actionOnUnmanage behaviour of the deployment stack. Similar to other Azure resources, access to the deployment stack can be restricted using Azure role-based access control (Azure RBAC). To create and update a deployment stack, you can utilize Azure CLI, Azure PowerShell, or the Azure portal, along with Bicep files. These Bicep files are compiled into ARM JSON templates, which are then deployed as a deployment object by the stack.</p></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>Check out a previous post I did on <a href="https://luke.geek.nz/azure/Azure-Bicep-Deployment-with-Deployment-Stacks/" target="_blank" rel="noopener noreferrer">Deployment Stacks</a> for a bit more detail on how they can be used and setup.</p></div></div>
<p>In our demo, we will have a Resource Group, with an existing Storage account already pre created <em>(using the Azure Portal)</em> and a Deployment Stack, consisting of an Azure KeyVault deployed using Bicep.</p>
<p>The PowerShell command used to deploy the Bicep is:</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">New-AzResourceGroupDeploymentStack</span><span class="token plain"> `</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token operator">-</span><span class="token plain">Name </span><span class="token string" style="color:rgb(255, 121, 198)">"MyDeploymentStack"</span><span class="token plain"> `</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token operator">-</span><span class="token plain">ResourceGroupName </span><span class="token string" style="color:rgb(255, 121, 198)">"deploymentstacks-rg"</span><span class="token plain"> `</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token operator">-</span><span class="token plain">TemplateFile </span><span class="token string" style="color:rgb(255, 121, 198)">"main.bicep"</span><span class="token plain"> `</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token operator">-</span><span class="token plain">DenySettingsMode </span><span class="token string" style="color:rgb(255, 121, 198)">"none"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>And the Bicep we initially deployed <em>(where the Storage account isn't part of the Deployment Stack, and the KeyVault is a dummy resource for something to deploy)</em> is:</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> storage </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.Storage/storageAccounts@2023-01-01'</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">existing</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'stfacc1337'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> keyvault </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.KeyVault/vaults@2023-07-01'</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'keyvaulstest13345'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">location</span><span class="token operator">:</span><span class="token plain">  </span><span class="token function" style="color:rgb(80, 250, 123)">resourceGroup</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">location</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">accessPolicies</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">tenantId</span><span class="token operator">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">subscription</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">tenantId</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">objectId</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'00000000-0000-0000-0000-000000000000'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">permissions</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">keys</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">'all'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">secrets</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">'all'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">certificates</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">'all'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">sku</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">family</span><span class="token operator">:</span><span class="token plain">   </span><span class="token string" style="color:rgb(255, 121, 198)">'A'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain">  </span><span class="token string" style="color:rgb(255, 121, 198)">'standard'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token property">tenantId</span><span class="token operator">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">subscription</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">tenantId</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Deployment Stack - Missing Storage account" src="https://luke.geek.nz/assets/images/DeploymentStack_LackingStgAccount-7c4805869587d85f1bbce1218c144e86.png" width="1886" height="684" class="img_ev3q"></p>
<p>As you can see, even though the 'stfacc1337' storage account is tested as a referenceable object in Bicep by using the <a href="https://learn.microsoft.com/azure/azure-resource-manager/bicep/existing-resource?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">existing</a> flag, it hasn't been brought into the Deployment Stack.</p>
<p>Being able to reference the module in Bicep isn't enough to bring it into the Deployment Stack, and this is by design <em>(<a href="https://github.com/Azure/deployment-stacks/issues/146" target="_blank" rel="noopener noreferrer">Issue #146</a>)</em>.</p>
<blockquote>
<p>So, if you can't reference an existing resource, how can you bring it into the deployment stack?</p>
</blockquote>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>Answer!</div><div class="admonitionContent_BuS1"><p><strong>The answer is: You need to import it into the Bicep!</strong>
From this moment forward, it would be wise to manage that imported resource in Bicep. Any changes to that resource outside of the Bicep will conflict with the code and state, and you may find your changes being reversed on the next deployment.</p></div></div>
<p>A resource needs to exist in Infrastructure as Code, in order to be added to a Deployment Stack, the easiest way is to import it.</p>
<p>I did a separate <a href="https://luke.geek.nz/azure/azure-bicep-and-insert-resource/" target="_blank" rel="noopener noreferrer">blog article</a> on using the Bicep Visual Studio extension to import an existing resource, so refer to that, but in essence, it can import the resource from ARM, and compile it into an identical resource into Bicep, matching what you have deployed.</p>
<p>The Bicep now looks like this:</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token decorator">@description</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'Generated from /subscriptions/a42e282a-c1e4-4abc-9fa1-1dd1ecbd6bf9/resourceGroups/deploymentstacks-rg/providers/Microsoft.Storage/storageAccounts/stfacc1337'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> stfacc </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.Storage/storageAccounts@2023-01-01'</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">sku</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Standard_RAGRS'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">kind</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'StorageV2'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'stfacc1337'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">location</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'australiaeast'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">tags</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">dnsEndpointType</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Standard'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">defaultToOAuthAuthentication</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">publicNetworkAccess</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Enabled'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">allowCrossTenantReplication</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">minimumTlsVersion</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'TLS1_2'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">allowBlobPublicAccess</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">allowSharedKeyAccess</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">networkAcls</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">ipv6Rules</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">bypass</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'AzureServices'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">virtualNetworkRules</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">ipRules</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">defaultAction</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Allow'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">supportsHttpsTrafficOnly</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">encryption</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">requireInfrastructureEncryption</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">services</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">file</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">keyType</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Account'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">enabled</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">blob</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">keyType</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Account'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">enabled</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">keySource</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.Storage'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">accessTier</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Hot'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> keyvault </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.KeyVault/vaults@2023-07-01'</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'keyvaulstest13345'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">location</span><span class="token operator">:</span><span class="token plain">  </span><span class="token function" style="color:rgb(80, 250, 123)">resourceGroup</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">location</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">accessPolicies</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">tenantId</span><span class="token operator">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">subscription</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">tenantId</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">objectId</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'00000000-0000-0000-0000-000000000000'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">permissions</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">keys</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">'all'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">secrets</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">'all'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">certificates</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">'all'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">sku</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">family</span><span class="token operator">:</span><span class="token plain">   </span><span class="token string" style="color:rgb(255, 121, 198)">'A'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain">  </span><span class="token string" style="color:rgb(255, 121, 198)">'standard'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token property">tenantId</span><span class="token operator">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">subscription</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">tenantId</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now redeploy the Deployment Stack.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>The create-stack commands can also be used to update deployment stacks!</p></div></div>
<blockquote>
<p>Once your Deployment Stack has been deployed, your resource is now imported.</p>
</blockquote>
<p><img decoding="async" loading="lazy" alt="Deployment Stacks - Including Storage account" src="https://luke.geek.nz/assets/images/DeploymentStack_IncludingStgAccount-970c80f71959bcfe9eaf91669fcedf88.png" width="1904" height="691" class="img_ev3q"></p>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[The specified service namespace is invalid EventHub]]></title>
            <link>https://luke.geek.nz/azure/service-namespace-invalid-eventhub/</link>
            <guid>https://luke.geek.nz/azure/service-namespace-invalid-eventhub/</guid>
            <pubDate>Fri, 05 Jan 2024 07:52:10 GMT</pubDate>
            <description><![CDATA[The specified service namespace is invalid when attempting to deploy an Azure EventHub using Bicep]]></description>
            <content:encoded><![CDATA[<p>When deploying an Event Hub using Azure Bicep, you may get the following error:</p>
<p>"code": "BadRequest",
"message": "The specified service namespace is invalid. CorrelationId: 652cc73c-1fa7-450a-9788-b73ad6a818df"</p>
<p><img decoding="async" loading="lazy" alt="The specified service namespace is invalid" src="https://luke.geek.nz/assets/images/EventHub_ServiceNamespaceisInvalid-9eeab3667abb3efbbf089a2d33e530d0.png" width="779" height="305" class="img_ev3q"></p>
<p>This could be caused by the name of your namespace needing to meet the naming requirements.</p>
<!-- -->
<p>For example:</p>
<p>The namespace identifier should adhere to the following naming conventions:</p>
<ul>
<li>The name must be unique across Azure. The system immediately checks to see if the name is available.</li>
<li>The name length is at least 6 and at most 50 characters.</li>
<li>The name can contain only letters, numbers, and hyphens ‚Äú-‚Äú.</li>
<li>The name must start with a letter and end with a letter or number.</li>
<li>The name doesn't end with ‚Äú-sb‚Äú or ‚Äú-mgmt‚Äú.</li>
</ul>
<p>Reference:</p>
<ul>
<li><a href="https://learn.microsoft.com/rest/api/servicebus/create-namespace?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Create Namespace</a>, even though this article dates back to an API from 2021, the naming standards are still valid in the API for 2023-01-01-preview.</li>
<li><a href="https://learn.microsoft.com/en-us/azure/service-bus-messaging/service-bus-quickstart-portal#:~:text=Enter%20a%20name,sb%E2%80%9C%20or%20%E2%80%9C-mgmt?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Create Service Bus Namespace in Portal</a></li>
</ul>]]></content:encoded>
            <category>Azure</category>
        </item>
    </channel>
</rss>