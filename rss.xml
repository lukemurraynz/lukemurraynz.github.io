<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>luke.geek.nz Blog</title>
        <link>https://luke.geek.nz/</link>
        <description>luke.geek.nz Blog</description>
        <lastBuildDate>Sat, 07 Jun 2025 06:29:11 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <language>en</language>
        <copyright>Copyright ¬© 2025 luke.geek.nz.</copyright>
        <item>
            <title><![CDATA[Validate Azure Zone Redundancy with az zones CLI]]></title>
            <link>https://luke.geek.nz/azure/zone-redundancy-cli/</link>
            <guid>https://luke.geek.nz/azure/zone-redundancy-cli/</guid>
            <pubDate>Sat, 07 Jun 2025 06:29:11 GMT</pubDate>
            <description><![CDATA[Learn to use the Azure CLI 'az zones' extension to check zone redundancy and ensure high availability for your Azure workloads.]]></description>
            <content:encoded><![CDATA[<p><a href="https://learn.microsoft.com/azure/well-architected/reliability/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Reliability</a> <em>(Resiliency, availability, recovery)</em> is part of one of the main pillars of the <a href="https://learn.microsoft.com/azure/well-architected/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Well-Architected Framework</a>. It is essential for ensuring that applications and services remain operational and performant, even in the face of failures or unexpected events. Reliability encompasses various aspects, including fault tolerance, disaster recovery, and high availability.</p>
<p>Reliability is also a shared responsibility between the cloud provider <em>(ie, Microsoft)</em> and the customer. While Azure provides a robust infrastructure and services designed for reliability, customers must also implement best practices and strategies to ensure their applications are resilient and can recover from failures.</p>
<p><img decoding="async" loading="lazy" alt="ReliabilitySharedResponsibility" src="https://luke.geek.nz/assets/images/ReliabilitySharedResponsibility-f11723a008cf0c2993a7e12ee2c252ed.png" width="1500" height="826" class="img_ev3q"></p>
<p>But a key question arises: <strong>How do we check the reliability <em>(in this example, Zone redundancy of our Workload)</em> ?</strong></p>
<p>One of the tools we can use for this is the <code>az zones</code> command line tool.</p>
<!-- -->
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>I just want to say that Resiliency is not just about the infrastructure, but also about the application design and architecture. It is essential to consider how your application will handle failures and recover from them, as there are numerous layers to take into account when implementing technology.</p><p><img decoding="async" loading="lazy" alt="ImportanceReliability" src="https://luke.geek.nz/assets/images/ImportanceReliability-84010f457c76af363dd7111889e21081.png" width="1511" height="844" class="img_ev3q"></p><p>However, the resiliency platform capabilities, although sometimes not directly visible, are essential for the reliability of your application. They provide the foundation upon which your workload sits.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-what-makes-up-an-azure-region">üè¢ What Makes Up an Azure Region?<a href="https://luke.geek.nz/azure/zone-redundancy-cli/#-what-makes-up-an-azure-region" class="hash-link" aria-label="Direct link to üè¢ What Makes Up an Azure Region?" title="Direct link to üè¢ What Makes Up an Azure Region?">‚Äã</a></h2>
<p>Before we go into the details of the <code>az zones</code> command line tool, I want to touch on what the tool will be highlighting for us.</p>
<p>If we go into what a region consists of, we can see that it is made up of multiple availability zones. An availability zone is a physically separate zone within an Azure region, designed to be isolated from failures in other zones. Each availability zone <em>(one or more datacenters)</em> has its own power, cooling, and networking infrastructure, ensuring that if one zone experiences an outage, the others remain operational.</p>
<p><img decoding="async" loading="lazy" alt="Azure Availability Zones" src="https://luke.geek.nz/assets/images/AvailabilityZones-1ae3c9e34a273371fdbfaa9665171978.jpg" width="1280" height="720" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-designing-for-reliability-with-availability-zones">üõ°Ô∏è Designing for Reliability with Availability Zones<a href="https://luke.geek.nz/azure/zone-redundancy-cli/#%EF%B8%8F-designing-for-reliability-with-availability-zones" class="hash-link" aria-label="Direct link to üõ°Ô∏è Designing for Reliability with Availability Zones" title="Direct link to üõ°Ô∏è Designing for Reliability with Availability Zones">‚Äã</a></h2>
<p>When designing your workloads for reliability within Azure, it is crucial to consider the availability zones. By deploying resources across multiple availability zones, you can achieve higher levels of fault tolerance and availability. This means that even if one zone goes down, your application can continue to function using resources in other zones.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>If you are interested in more about Workload criticality, refer to a previous blog post I did: <a href="https://luke.geek.nz/azure/business-critical-workloads/" target="_blank" rel="noopener noreferrer">Understanding Workload Criticality in the Cloud
</a>. This goes a bit deeper into SLA, SLO, and composite SLAs</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-how-do-you-know-if-your-workload-is-zone-redundant">üîç How Do You Know If Your Workload Is Zone Redundant?<a href="https://luke.geek.nz/azure/zone-redundancy-cli/#-how-do-you-know-if-your-workload-is-zone-redundant" class="hash-link" aria-label="Direct link to üîç How Do You Know If Your Workload Is Zone Redundant?" title="Direct link to üîç How Do You Know If Your Workload Is Zone Redundant?">‚Äã</a></h2>
<p>So, how do you know that your workload is redundant? This is where the <code>az zones</code> command line tool comes in handy.</p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>This extension is in active development. While an effort has been made to include the most common resource types and their zone redundancy configuration, there are still plenty of resource types missing. More will be added in future releases. In the meantime, if you need specific resources added or have found errors, please raise a <a href="https://github.com/Azure/azure-cli-extensions/issues" target="_blank" rel="noopener noreferrer">Github issue</a>. The extension still has missing resource types. These are shown as Unknown in the results. It is essential that you validate zone redundancy of these resources yourself, since your whole application is only zone redundant if all resources are zone redundant.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-understanding-zone-redundancy-status">üß© Understanding Zone Redundancy Status<a href="https://luke.geek.nz/azure/zone-redundancy-cli/#-understanding-zone-redundancy-status" class="hash-link" aria-label="Direct link to üß© Understanding Zone Redundancy Status" title="Direct link to üß© Understanding Zone Redundancy Status">‚Äã</a></h2>
<p>This CLI Extension helps validate the zone redundancy status of resources within a specific scope. For each resource, one of the following statuses will be returned:</p>
<table><thead><tr><th>Status</th><th>Description</th></tr></thead><tbody><tr><td>Unknown</td><td>Unable to verify status. You'll need to check the resource manually.</td></tr><tr><td>Yes</td><td>Resource is configured for zone redundancy</td></tr><tr><td>Always</td><td>Resource is always zone redundant, no configuration needed</td></tr><tr><td>No</td><td>Resource is not configured for zone redundancy, but could be in another configuration</td></tr><tr><td>Never</td><td>Resource cannot be configured for zone redundancy</td></tr><tr><td>Dependent</td><td>Resource is zone redundant if parent or related resource is zone redundant</td></tr><tr><td>NoZonesInRegion</td><td>The region the resource is deployed in does not have Availability Zones</td></tr></tbody></table>
<p>By running this against a specific resource group that contains your production resources, you can be sure that you have not overlooked any resources in your quest for zone redundancy. If the results show 'No' on one of your resources, that means that you need to change the configuration to enable ZR. If it shows 'Never', that probably means you need to deploy multiple of those resources to the different zones manually.</p>
<blockquote>
<p>Zonal services are considered to be Zone Redundant if they are deployed to at least 2 zones.</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-getting-started-with-az-zones-validate">üöÄ Getting Started with <code>az zones validate</code><a href="https://luke.geek.nz/azure/zone-redundancy-cli/#-getting-started-with-az-zones-validate" class="hash-link" aria-label="Direct link to -getting-started-with-az-zones-validate" title="Direct link to -getting-started-with-az-zones-validate">‚Äã</a></h2>
<p>So let's get going - with the <a href="https://learn.microsoft.com/cli/azure/install-azure-cli?view=azure-cli-latest&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure CLI</a> installed, it's time to run a validate command - this will prompt the Azure CLI to install the extension.</p>
<p>Make sure you log in with: <code>az login</code>
Then type: <code>az zones validate</code></p>
<p><img decoding="async" loading="lazy" alt="Az Zones validate" src="https://luke.geek.nz/assets/images/AzZonesValidate-2fcdc4164e6727e2d045550ff4f6e24d.gif" width="1202" height="496" class="img_ev3q"></p>
<p>This will prompt the zones extension to be installed and run the validate command.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-output-formats-and-exporting-results">üìä Output Formats and Exporting Results<a href="https://luke.geek.nz/azure/zone-redundancy-cli/#-output-formats-and-exporting-results" class="hash-link" aria-label="Direct link to üìä Output Formats and Exporting Results" title="Direct link to üìä Output Formats and Exporting Results">‚Äã</a></h2>
<p>Next, let us rerun it - this time in a Table format:</p>
<p><code>az zones validate -o table</code></p>
<p><img decoding="async" loading="lazy" alt="Az Zones validate - Output Tables" src="https://luke.geek.nz/assets/images/AzZonesValidate_OutputTable-34594e7e5dc8f4359ed2f1e1ec6e61b6.gif" width="1201" height="496" class="img_ev3q"></p>
<p>The Table format makes it easier to read, in my opinion, and then we could export and then open it up in Excel, for example, to view outside of the terminal <code> az zones validate -o table &gt; ZonesOutput.csv</code>.</p>
<p>As we can see, I have a range of resource types in my Azure environment:</p>
<p><img decoding="async" loading="lazy" alt="Az Zones validate - open in Excel" src="https://luke.geek.nz/assets/images/AzZones_ExcelExportView-f775739c29a20550176249560f7cd6f5.png" width="1691" height="647" class="img_ev3q"></p>
<p>I can see that I have User Assigned Managed Identitties with the class of: Always - meaning it is <a href="https://learn.microsoft.com/azure/storage/common/storage-redundancy?WT.mc_id=AZ-MVP-5004796#zone-redundant-storage" target="_blank" rel="noopener noreferrer">zone-redundant</a> and no other changes are needed.
I can see that I have Disks, which are not zone redundant. THis means that they are not Zone-Redundant _(remember zone redundant is deployed to 2 or more zones) - in this case I would have to change the configuration from an <a href="https://learn.microsoft.com/azure/storage/common/storage-redundancy?WT.mc_id=AZ-MVP-5004796#locally-redundant-storage" target="_blank" rel="noopener noreferrer">LRS <em>(Locally Redundant storage)</em></a> to <a href="https://learn.microsoft.com/azure/storage/common/storage-redundancy?WT.mc_id=AZ-MVP-5004796#zone-redundant-storage" target="_blank" rel="noopener noreferrer">ZRS _(Zone reundant storage)_</a> SKU or adjust the system using the disk - to be redundant, ie failover cluster.
I can see I have an Expressroute circuit with the status of Unknown, This means that the zones CLI extension isn't able to verify this resource type. So you would need to check manually - make sure your <a href="https://learn.microsoft.com/en-us/azure/vpn-gateway/about-zone-redundant-vnet-gateways?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">virtual network gateways are zone-redundant</a>. It's worth noting that Virtual Networks are zone-redundant by default.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-scoping-your-validation">üéØ Scoping Your Validation<a href="https://luke.geek.nz/azure/zone-redundancy-cli/#-scoping-your-validation" class="hash-link" aria-label="Direct link to üéØ Scoping Your Validation" title="Direct link to üéØ Scoping Your Validation">‚Äã</a></h2>
<p>Now it's worth noting that when we ran <code>az zones validate</code> it ran across all resources across subscriptions in the tenant we have access to, if we wanted to limit the scope of the scan, we can.</p>
<p>We can limit it by Resources with a specific tag only:</p>
<p>`az zones validate --tags Environment=dev'</p>
<p><img decoding="async" loading="lazy" alt="Azure Zones Validate" src="https://luke.geek.nz/assets/images/AzZonesValidate_TagScope-050fade1e61afc73f43a59c6cbafbddc.gif" width="1200" height="496" class="img_ev3q"></p>
<p><em>(It's worth noting the Tag value pair is case sensitive.)</em></p>
<p>And we can also limit it by Resource Group or Subscription:</p>
<p><code>az zones validate --resource-groups defaultresourcegroup-eau</code></p>
<p><code>az zones validate --subscription lukemurray-mvp-visualstudioenterprise-sub-dev</code></p>
<p><img decoding="async" loading="lazy" alt="Azure Zones Validate - Scope" src="https://luke.geek.nz/assets/images/AzZonesValidate_ScopeRGSub-a4f7009bfaed5a86cde79e5231f95aa5.gif" width="1200" height="496" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-additional-options-and-filtering">üßπ Additional Options and Filtering<a href="https://luke.geek.nz/azure/zone-redundancy-cli/#-additional-options-and-filtering" class="hash-link" aria-label="Direct link to üßπ Additional Options and Filtering" title="Direct link to üßπ Additional Options and Filtering">‚Äã</a></h2>
<p>You can also use the <code>--omit-dependent</code> to remove resource dependencies from the scan and output.</p>
<p>You can also use a JMESPath custom query ie, if I wanted to only view the resiliency of my disks: <code>az zones validate --output table --query "[?resourceType=='microsoft.compute/disks'].{Resource:name, Location:location, ZoneRedundant:zoneRedundant}"</code></p>
<p><img decoding="async" loading="lazy" alt="Azure Zones Validate " src="https://luke.geek.nz/assets/images/AzZonesValidate_ScopeResourceType-092c66b6286e014ce767906187ed1335.gif" width="1200" height="496" class="img_ev3q"></p>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Azure Container Apps Configure Planned Maintenance Windows]]></title>
            <link>https://luke.geek.nz/azure/container-apps-planned-maintenance/</link>
            <guid>https://luke.geek.nz/azure/container-apps-planned-maintenance/</guid>
            <pubDate>Tue, 03 Jun 2025 00:52:39 GMT</pubDate>
            <description><![CDATA[Learn how to configure planned maintenance windows for Azure Container Apps using Bicep, minimizing downtime and ensuring application reliability with step-by-step guidance.]]></description>
            <content:encoded><![CDATA[<p>Announced at Microsoft Build 2025, <a href="https://learn.microsoft.com/azure/container-apps/planned-maintenance?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Planned maintenance is now generally available in Azure Container Apps</a>. This feature allows you to control when non-critical updates are applied to your Container Apps environment to minimize downtime and impact to applications. Non-critical updates include minor security patches, bug fixes, and new releases.</p>
<!-- -->
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Critical and urgent updates, however, are applied as needed to ensure security and reliability compliance, even outside of planned maintenance windows.</p><table><thead><tr><th>Update Type</th><th>Description</th><th>Timing</th></tr></thead><tbody><tr><td>Critical</td><td>Urgent fixes that include updates essential to the security and stability of your app.</td><td>Anytime ‚Äì applied as needed to ensure security and reliability compliance.</td></tr><tr><td>Noncritical</td><td>Routine security patches, bug fixes, and the introduction of new features.</td><td>If a planned maintenance window is defined, updates only start during that time span.If a maintenance window isn't configured, updates can be applied at any time.</td></tr></tbody></table></div></div>
<p>Let's take a look at how to configure this feature in your Azure Container Apps environment.</p>
<p>You can use the <a href="https://learn.microsoft.com/azure/container-apps/planned-maintenance?WT.mc_id=AZ-MVP-5004796#add-a-window" target="_blank" rel="noopener noreferrer">Azure CLI</a> to set up a maintenance window for your Container Apps environment. However, today we will focus on using Bicep.</p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><ul>
<li>You can only have one maintenance window per environment.</li>
<li>The minimum duration for a maintenance window is 8 hours.</li>
<li>Planned maintenance is an optional, best-effort feature that is ideal for environments with interdependent applications seeking added resiliency. When critical updates are available, Container Apps can apply them outside of the maintenance window to ensure the security and reliability of the platform and your applications.</li>
<li>Maintenance windows are available in all container apps and jobs, except when they run on consumption workload profiles.</li>
</ul></div></div>
<p>In my demo, I have an existing Container Apps environment (a Consumption environment with one Container App), so I will be adding a maintenance window to that. If you are creating a new environment, you can add the maintenance window as part of the environment creation.</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token decorator">@maxLength</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">64</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> maintenanceConfigName </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'default'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token decorator">@minValue</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">8</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token decorator">@maxValue</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">24</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> durationHours </span><span class="token datatype class-name">int</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">8</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token decorator">@minValue</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token decorator">@maxValue</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">23</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> startHourUtc </span><span class="token datatype class-name">int</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token decorator">@allowed</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string" style="color:rgb(255, 121, 198)">'Monday'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string" style="color:rgb(255, 121, 198)">'Tuesday'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string" style="color:rgb(255, 121, 198)">'Wednesday'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string" style="color:rgb(255, 121, 198)">'Thursday'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string" style="color:rgb(255, 121, 198)">'Friday'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string" style="color:rgb(255, 121, 198)">'Saturday'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string" style="color:rgb(255, 121, 198)">'Sunday'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> weekDay </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Sunday'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> containerAppEnv </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.App/managedEnvironments@2025-02-02-preview'</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">existing</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'cae-gvdzidrs5xh4i'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> symbolicname </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.App/managedEnvironments/maintenanceConfigurations@2025-02-02-preview'</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> maintenanceConfigName</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">parent</span><span class="token operator">:</span><span class="token plain"> containerAppEnv</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">scheduledEntries</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">durationHours</span><span class="token operator">:</span><span class="token plain"> durationHours</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">startHourUtc</span><span class="token operator">:</span><span class="token plain"> startHourUtc</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">weekDay</span><span class="token operator">:</span><span class="token plain"> weekDay</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="Container Apps maintenanceConfigurations" src="https://luke.geek.nz/assets/images/Capps_MaintWinBicepDeploy-45c3728bbeafa52d520a8e32a23f303b.gif" width="1918" height="1117" class="img_ev3q"></p>
<p>Once deployed, we can view the maintenance window in the Azure Portal, under the Container Apps environment, in Settings, and under Planned Maintenance.</p>
<p><img decoding="async" loading="lazy" alt="Container Apps maintenanceConfigurations in Azure Portal" src="https://luke.geek.nz/assets/images/ContainerAppsEnvPlannedMaintenance-7a7cd43990ee16948024e60bafb9ecd3.jpg" width="1456" height="603" class="img_ev3q"></p>
<p>Then, in the <a href="https://learn.microsoft.com/en-gb/azure/container-apps/planned-maintenance?WT.mc_id=AZ-MVP-5004796#view-maintenance-history" target="_blank" rel="noopener noreferrer">Diagnose and solve problems blade</a>, you can view the configured maintenance window and upgrade events that occurred in the last month.</p>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Test KAITO Model Completion on AKS with kubectl & curl]]></title>
            <link>https://luke.geek.nz/azure/aks-kaito-completion/</link>
            <guid>https://luke.geek.nz/azure/aks-kaito-completion/</guid>
            <pubDate>Mon, 26 May 2025 22:51:04 GMT</pubDate>
            <description><![CDATA[Learn to test the KAITO model's completion endpoint on AKS using kubectl and curl for real-time text generation.]]></description>
            <content:encoded><![CDATA[<p>The other day, I wrote an article about <a href="https://luke.geek.nz/azure/aks-kaito-vscode-deployment/" target="_blank" rel="noopener noreferrer">Deploy &amp; Test KAITO on AKS with Visual Studio Code</a>. One of the areas I showcased was testing the completion of the KAITO model within Visual Studio Code; however, I didn't touch on how to use the completion endpoint directly.</p>
<!-- -->
<p>In this example, we are going to connect to the cluster, grab the workspace, and then run a curl container to test the completion endpoint of the KAITO model:</p>
<p><img decoding="async" loading="lazy" alt="KAITO Completion Response" src="https://luke.geek.nz/assets/images/KAITOAKSEndpointTest-7ed2769136eefcc8930710e87afa528e.gif" width="1047" height="529" class="img_ev3q"></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">az aks get-credentials --resource-group kaitovscodetest </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--name</span><span class="token plain"> kaitocodetest --overwrite-existing</span><br></span></code></pre></div></div>
<p>Once connected to the AKS cluster, we can retrieve the service IP of the <code>workspace-phi-3-mini-4k-instruct</code> service, where the KAITO model is running. This workplace may change depending on the deployment, so you may need to adjust the service name accordingly.</p>
<p>You can find the service name by running:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain"> kubectl get svc</span><br></span></code></pre></div></div>
<p>Then you can run the following command to test the completion endpoint of the KAITO model using a curl container. This command will send a POST request with a prompt to the KAITO model and return the generated text.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token builtin class-name" style="color:rgb(189, 147, 249)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">SERVICE_IP</span><span class="token operator">=</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">kubectl get svc workspace-phi-3-mini-4k-instruct </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-o</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">jsonpath</span><span class="token variable operator" style="color:rgb(189, 147, 249);font-style:italic">=</span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">'{.spec.clusterIP}'</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kubectl run </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-it</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--rm</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--restart</span><span class="token operator">=</span><span class="token plain">Never </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--image</span><span class="token operator">=</span><span class="token plain">curlimages/curl -- </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-X</span><span class="token plain"> POST </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-H</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"accept: application/json"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-H</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Content-Type: application/json"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-d</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        "prompt": "You are a technical writer. Draft a markdown-formatted introduction for a blog post titled \"üç¶ The Science and Art of Ice Cream\". Use an engaging, approachable tone and provide a brief overview of why understanding the science behind ice cream leads to better flavors and textures.",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        "return_full_text": false,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        "clean_up_tokenization_spaces": false,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        "prefix": null,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        "handle_long_generation": null,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        "generate_kwargs": {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            "max_length": 5000,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            "min_length": 0,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            "do_sample": true,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            "early_stopping": false,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            "num_beams": 1,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            "num_beam_groups": 1,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            "diversity_penalty": 0.0,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            "temperature": 1.0,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            "top_k": 10,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            "top_p": 1,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            "typical_p": 1,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            "repetition_penalty": 1,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            "length_penalty": 1,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            "no_repeat_ngram_size": 0,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            "encoder_no_repeat_ngram_size": 0,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            "bad_words_ids": null,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            "num_return_sequences": 1,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            "output_scores": false,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            "return_dict_in_generate": false,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            "forced_bos_token_id": null,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            "forced_eos_token_id": null,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            "remove_invalid_values": null</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    }'</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">"http://</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$SERVICE_IP</span><span class="token string" style="color:rgb(255, 121, 198)">/v1/completions"</span><br></span></code></pre></div></div>
<p>This command will run a curl container and send a POST request to the completion endpoint of the KAITO model, passing in the prompt and other parameters. The response will be printed to the console, allowing you to see the generated text.</p>
<p>You can adjust the <code>prompt</code> and other parameters in the JSON payload to test different inputs and configurations.</p>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Azure Extended Zones in Perth]]></title>
            <link>https://luke.geek.nz/azure/extended-zones-perth/</link>
            <guid>https://luke.geek.nz/azure/extended-zones-perth/</guid>
            <pubDate>Mon, 26 May 2025 06:20:51 GMT</pubDate>
            <description><![CDATA[Discover Azure Extended Zones in Perth‚Äîlow latency, data residency, and deployment with Azure PowerShell for critical workloads.]]></description>
            <content:encoded><![CDATA[<p><a href="https://learn.microsoft.com/azure/extended-zones/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Extended Zones</a> are small-footprint extensions of Azure placed in metros, industry centers, or a specific jurisdiction to serve low-latency and data-residency workloads. Azure Extended Zones supports virtual machines (VMs), containers, storage, and a selected set of Azure services and can run latency-sensitive and throughput-intensive applications close to end users and within approved data residency boundaries.</p>
<p>Recently announced <a href="https://azure.microsoft.com/en-gb/updates?id=492737?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Extended Zones in Perth, Australia</a>, provide a new option for customers to run their workloads <em>(<strong>make note only a subset of <a href="https://learn.microsoft.com/en-us/azure/extended-zones/overview?WT.mc_id=AZ-MVP-5004796#service-offerings-for-azure-extended-zones" target="_blank" rel="noopener noreferrer">resources are compatible</a></strong>)</em> closer to home.</p>
<p>This is particularly beneficial for industries that require low latency and data residency, such as finance, healthcare, and government.</p>
<p><img decoding="async" loading="lazy" alt="Extended Zones" src="https://luke.geek.nz/assets/images/AzureExtendedZones-Industries-8e471b545e08c46dffc943d0fb87a33c.JPG" width="1280" height="720" class="img_ev3q"></p>
<!-- -->
<p>So let us dig a bit deeper into the details of Azure Extended Zones in Perth, Australia.</p>
<p>Located in Perth <em>(location undisclosed)</em>, the Azure Extended Zones in Perth are designed to provide low latency and high availability for applications that require data residency within Australia. The zones are connected to the Azure backbone network, ensuring fast and reliable connectivity to other Azure regions. However, they are not self-sufficient and require a connection to an Azure region <em>(classed as the parent region)</em>.</p>
<p><img decoding="async" loading="lazy" alt="Extended Zones in Perth" src="https://luke.geek.nz/assets/images/AzureExtendedZones-Perth-661bf466f3d428df8c9a060d442abfea.JPG" width="1280" height="720" class="img_ev3q"></p>
<p>The parent region for the Extended Zones in Perth is the Australia East region, which is located in Sydney. This means that the Extended Zones in Perth are connected to the Australia East region, allowing customers to take advantage of the full range of Azure services available in that region. The metadata for the resources in the Extended Zones will be stored in the Australia East region, but the data itself will remain in the Extended Zones in Perth.</p>
<h1>üåê Where Are Azure Extended Zones Available?</h1>
<p>At the moment, there are 2 Extended Zones:</p>
<ul>
<li>Los Angeles</li>
<li>Perth</li>
</ul>
<h1>üõ†Ô∏è Viewing Extended Zone Details</h1>
<p>If we run a <code>Get-AzEdgeZonesExtendedZone</code> command, we can see the details of the Extended Zones in Perth:</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">Get-AzEdgeZonesExtendedZone</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">fl</span><span class="token plain"> </span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="Extended Zones in Perth" src="https://luke.geek.nz/assets/images/GetAzEdgeZonesExtendedZone-ab89d27067608f029789246c81cd8a84.gif" width="1083" height="406" class="img_ev3q"></p>
<p>This command will return the details of the Extended Zones in Perth, including the name, location, parent <em>(Home)</em> region, longitude, and latitude.</p>
<p><img decoding="async" loading="lazy" alt="Extended Zones in Perth Map" src="https://luke.geek.nz/assets/images/AzureExtendedZonePerthMap-eb14aaab4939cf2e7bc6e29f3b6e9d61.jpg" width="639" height="454" class="img_ev3q"></p>
<h1>üìù Registering the Extended Zone</h1>
<p>Before we can deploy a resource into the Extended Zone, we first need to register the Extended Zone in our subscription. We can do this by running the following command:</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">Register-AzEdgeZonesExtendedZone</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name </span><span class="token string" style="color:rgb(255, 121, 198)">'Perth'</span><br></span></code></pre></div></div>
<p>Once the registration is complete, you will see the <code>RegistrationState</code> change to <code>Registered</code>.</p>
<h1>üì¶ Deploying Resources to Perth Extended Zone</h1>
<p>Once deployed, you can create resources in the Extended Zone using the Azure portal, Azure CLI, or Azure PowerShell. For our purposes, we will use Azure PowerShell to create a Storage account in the Perth Extended Zone.</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$rgName</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">'perth-extended-zone-rg'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">New-AzResourceGroup</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$rgName</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Location </span><span class="token string" style="color:rgb(255, 121, 198)">'Australia East'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$storageAccountName</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">'perthextendedzone'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">New-AzStorageAccount</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ResourceGroupName </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$rgName</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$storageAccountName</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Location </span><span class="token string" style="color:rgb(255, 121, 198)">'Australia East'</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">SkuName Premium_LRS </span><span class="token operator">-</span><span class="token plain">EdgeZone </span><span class="token string" style="color:rgb(255, 121, 198)">'Perth'</span><br></span></code></pre></div></div>
<p>Once created, we can run a <code>Get-AzStorageAccount</code> command to see the details of the Storage account:</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">Get-AzStorageAccount</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ResourceGroupName </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$rgName</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$storageAccountName</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Select-Object</span><span class="token plain"> Location</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">Name=</span><span class="token string" style="color:rgb(255, 121, 198)">'ExtendedLocation'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain">Expression=</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ExtendedLocation</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="Get-AzStorageAccount" src="https://luke.geek.nz/assets/images/DeployAzStorageAccountAzEdgeZonesExtendedZone-fbba3313bcd7ff93fc5beabd7c600d2d.gif" width="847" height="406" class="img_ev3q"></p>
<p>If we view the storage account in the portal, we can see that the storage account is deployed in the Perth Extended Zone, with the metadata stored in the Australia East region:</p>
<p><img decoding="async" loading="lazy" alt="Storage Account in Perth Extended Zone" src="https://luke.geek.nz/assets/images/StorageAccountPerthExtendedZone-6e83d5a345c392b0922bcf6f110cd407.jpg" width="1576" height="812" class="img_ev3q"></p>
<p>Creating a Resource in the Azure Portal is simple: select a supported resource, select the primary region, and select the Extended Zone.</p>
<p><img decoding="async" loading="lazy" alt="Create Resource in Extended Zone" src="https://luke.geek.nz/assets/images/CreateResourceInExtendedZonePortal-d69b3574a7f8a8a4f4a1ebdaa19323d0.gif" width="1887" height="854" class="img_ev3q"></p>
<h1>‚ö†Ô∏è Important Considerations</h1>
<p>It's worth noting that if there is an issue in the Australia East region, the Extended Zones in Perth may continue to operate temporarily for existing workloads. However, they are not fully self-sufficient and rely on a connection to the Australia East region for resource creation and management. Until the issue in the Australia East region is resolved, you may face limitations in creating or managing resources in the Extended Zones.</p>
<p>Also worth noting, that the Extended Zones in Perth are not a replacement for the Azure regions in Australia, but rather an extension of the Azure regions to provide low latency and data residency for applications that require it - for example The Extended Zones in Perth are not designed to be used as a disaster recovery site for the Azure regions in Australia - note that the Storage account in the Extended Zone is not geo-replicated or zone-resilient, so consider resiliency and availability when deploying resources in the Extended Zones.</p>
<h1>üèÅ Conclusion</h1>
<p>In conclusion, Azure Extended Zones in Perth, Australia, provide a new option for customers to run their workloads closer to home, with low latency and data residency. The Extended Zones are connected to the Azure backbone network, ensuring fast and reliable connectivity to other Azure regions. However, they are not self-sufficient and require a connection to an Azure region (classed as the parent region).</p>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Deploy & Test KAITO on AKS with Visual Studio Code]]></title>
            <link>https://luke.geek.nz/azure/aks-kaito-vscode-deployment/</link>
            <guid>https://luke.geek.nz/azure/aks-kaito-vscode-deployment/</guid>
            <pubDate>Sun, 25 May 2025 05:59:41 GMT</pubDate>
            <description><![CDATA[Deploy and test KAITO on Azure Kubernetes Service (AKS) using Visual Studio Code and the AKS extension for a streamlined AI setup.]]></description>
            <content:encoded><![CDATA[<p>Today, we will look at deploying Kubernetes AI Toolchain Operator <em>(KAITO)</em> straight from Visual Studio Code.</p>
<!-- -->
<p>Last year, I wrote a blog article on <a href="https://luke.geek.nz/azure/run-local-llm-aks/" target="_blank" rel="noopener noreferrer">Deploying Large Language Models on AKS with KAITO</a>. Since then, the KAITO team has been working hard to make it easier to deploy and manage AI workloads on Kubernetes‚Äîand in this case, straight from Visual Studio Code using the <a href="https://learn.microsoft.com/azure/aks/aks-extension-vs-code?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Kubernetes Service (AKS) extension</a>.</p>
<p>So let's look at how to deploy KAITO straight from Visual Studio Code.</p>
<blockquote>
<p>I almost didn't write this article due to the ease of deployment, but I noticed that a few people were searching for KAITO on my site, so I thought I would write it to help those who are looking for a way to deploy KAITO on AKS.</p>
</blockquote>
<p>I have the following prerequisites already set up:</p>
<ul>
<li>An Azure account with an AKS cluster configured for KAITO, such as:<!-- -->
<ul>
<li>Name: <code>KAITOcodetest</code></li>
<li>Location: <code>australiaeast</code></li>
<li>Kubernetes version: <code>1.31.7</code></li>
<li>System pool: 2x <code>Standard_D8ds_v5</code> (autoscaling 2-5, 300GB ephemeral OS disk, zone 1, taint: <code>CriticalAddonsOnly=true:NoSchedule</code>)</li>
<li>User pool: 2x <code>Standard_D8ds_v5</code> (autoscaling 2-100, 300GB ephemeral OS disk, zone 1)</li>
<li>RBAC enabled, OIDC issuer enabled, Azure Policy and Container Insights enabled</li>
<li>Network: Azure CNI Overlay, Standard Load Balancer</li>
<li>Workload Identity enabled</li>
</ul>
</li>
<li>Visual Studio Code installed</li>
<li>The <a href="https://learn.microsoft.com/azure/aks/aks-extension-vs-code?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Kubernetes Service (AKS) extension</a> is installed in Visual Studio Code</li>
</ul>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p><a href="https://learn.microsoft.com/azure/aks/intro-aks-automatic?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">AKS Automatic clusters</a> are not supported by the KAITO extension at this stage. You must use a standard AKS cluster.</p></div></div>
<p>So let's get started. First, we need to install the KAITO workspace.</p>
<p>After authentication to Azure, we should be able to see the AKS cluster under your specific subscription. If you don't see it, you may need to refresh the view or go and create the cluster first.</p>
<p>Let's install the <a href="https://learn.microsoft.com/azure/aks/ai-toolchain-operator?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">KAITO addon</a> into the cluster first and set up the federated credentials‚Äî <em>(this can take a few minutes to complete)</em>.</p>
<p><img decoding="async" loading="lazy" alt="Screenshot showing the Visual Studio Code interface with the Azure Kubernetes Service (AKS) extension, highlighting the steps to install the KAITO addon into an AKS cluster." src="https://luke.geek.nz/assets/images/InstallKAITOAksExtension-fcf9b6c576c3955f8c9688ff145e160a.gif" width="1741" height="891" class="img_ev3q"></p>
<p>Once the KAITO addon is installed, we can create a new KAITO workspace. This will create a new namespace in the cluster and install the KAITO operator into that namespace.</p>
<p><img decoding="async" loading="lazy" alt="Create KAITO Workspace" src="https://luke.geek.nz/assets/images/InstallKAITOWorkspaceAksExtension-e9b6fcbaac9b045299c8e7fb2994edaa.gif" width="1741" height="891" class="img_ev3q"></p>
<p>As you can see, you can customise the CRD for the workspace, such as the name, VM compute, etc. In my case, I am going to use the base Standard_NC6s_v3 VM SKU, which is a 6 vCPU, 24GB RAM VM with 100GB ephemeral OS disk. This deployment can take 20-40 minutes or more to complete, so be patient.</p>
<p>Once completed, you will see the deployment in the AKS extension view, and you can see the status of the workspace; in my example, it is running.</p>
<p><img decoding="async" loading="lazy" alt="KAITO Workspace Status" src="https://luke.geek.nz/assets/images/InstallKAITOManageWorkspaceAksExtension-5dcf9bf7db3ac704240d60d923c29352.jpg" width="1197" height="586" class="img_ev3q"></p>
<p>Now, let us test.</p>
<p><img decoding="async" loading="lazy" alt="Test KAITO Workspace" src="https://luke.geek.nz/assets/images/InstallKAITOTestAksExtension-0b5b1d57491d79debb1b452b2369da5f.gif" width="1741" height="891" class="img_ev3q"></p>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Scan Your Kubernetes Cluster with KubeBuddy]]></title>
            <link>https://luke.geek.nz/azure/kubebuddy-scanning-clusters/</link>
            <guid>https://luke.geek.nz/azure/kubebuddy-scanning-clusters/</guid>
            <pubDate>Wed, 07 May 2025 21:47:58 GMT</pubDate>
            <description><![CDATA[Scan your AKS cluster with KubeBuddy to detect issues and generate actionable reports for better operations.]]></description>
            <content:encoded><![CDATA[<p>Today, we will look at <a href="https://kubebuddy.kubedeck.io/" target="_blank" rel="noopener noreferrer">KubeBuddy</a>.</p>
<p><img decoding="async" loading="lazy" alt="KubeBuddy Logo" src="https://luke.geek.nz/assets/images/KubeBuddyLogo-a3c35e036f509cc1eafd17ff55da4010.png" width="3600" height="804" class="img_ev3q"></p>
<p>The tag line of KubeBuddy is:</p>
<blockquote>
<p>Kubernetes says your cluster is healthy. It‚Äôs probably not.</p>
</blockquote>
<!-- -->
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="https://luke.geek.nz/azure/kubebuddy-scanning-clusters/#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">‚Äã</a></h2>
<p>Developed by Microsoft Azure MVP, <a href="https://www.linkedin.com/in/%E2%98%81-richard-hooper/" target="_blank" rel="noopener noreferrer">Richard Hooper</a> - let us take a look at KubeBuddy against an <a href="https://learn.microsoft.com/azure/aks/what-is-aks?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Kubernetes Cluster <em>(AKS)</em></a>.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p><a href="https://kubebuddy.kubedeck.io/" target="_blank" rel="noopener noreferrer">KubeBuddy</a>, powered by <a href="https://github.com/kubedeckio" target="_blank" rel="noopener noreferrer">Kubedeck</a>, is a comprehensive diagnostic tool designed to address the hidden issues within Kubernetes clusters. It aims to solve problems related to node failures, pod crashes, security risks, and networking issues. By running externally via your terminal or Docker, KubeBuddy ensures no cluster intrusion, providing clean execution without agents or Helm charts. It generates actionable reports in HTML, JSON, or CLI formats, offering quick insights and sharing capabilities. KubeBuddy's stateless design means scans don't persist anything, ensuring no runtime footprint or security baggage. It can be used locally, in CI/CD, or on a jump host, making it versatile for various work environments.</p></div></div>
<p>Today, we are going to run it locally, against an <a href="https://learn.microsoft.com/azure/aks/what-is-aks?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Kubernetes Cluster <em>(AKS)</em></a> - using <a href="https://learn.microsoft.com/powershell/scripting/overview?view=powershell-7.5&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">PowerShell</a>. If you are so inclined, you can go down the <a href="https://kubebuddy.kubedeck.io/usage/docker-usage/" target="_blank" rel="noopener noreferrer">docker</a> route.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-connect--scan">‚öôÔ∏è Connect &amp; Scan<a href="https://luke.geek.nz/azure/kubebuddy-scanning-clusters/#%EF%B8%8F-connect--scan" class="hash-link" aria-label="Direct link to ‚öôÔ∏è Connect &amp; Scan" title="Direct link to ‚öôÔ∏è Connect &amp; Scan">‚Äã</a></h2>
<p>KubeBuddy uses your existing Kubeconfig to scan your cluster externally; no agents are required. So, let's get started.</p>
<p>I have an AKS cluster. This cluster is deployed in the Australia East region. Its System Node Pool size is Standard_DS2_v2, and its User Node Pool size is Standard_D4as_v5. I will run this on a GitHub Codespace, running Ubuntu 20.04.6 LTS and PowerShell 7.5.1 with kubectl and Azure CLI installed, but from the PowerShell terminal.</p>
<p>First, let's install the KubeBuddy module.</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">Install-Module</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name KubeBuddy </span><span class="token operator">-</span><span class="token plain">Scope CurrentUser </span><span class="token operator">-</span><span class="token plain">Force </span><span class="token operator">-</span><span class="token plain">AllowClobber</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="Install - KubeBuddy PowerShell Module" src="https://luke.geek.nz/assets/images/InstallKubeBuddyPSModule-2a36aba6bc9a1629eefb688a283f141b.gif" width="1151" height="300" class="img_ev3q"></p>
<p>Once installed, we need to log in to Azure using the Azure CLI and then connect to the AKS cluster.</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># =========================</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Variables</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># =========================</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceGroup</span><span class="token plain">      = </span><span class="token string" style="color:rgb(255, 121, 198)">"akscluster-rg"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$clusterName</span><span class="token plain">        = </span><span class="token string" style="color:rgb(255, 121, 198)">"lukesakscluster"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$subscriptionId</span><span class="token plain">     = </span><span class="token string" style="color:rgb(255, 121, 198)">"7a30b0c4-5b48-419e-8e57-439b127b69d2"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># =========================</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Helper Functions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># =========================</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Log</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token namespace">[string]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$message</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function" style="color:rgb(80, 250, 123)">Get-Date</span><span class="token string function" style="color:rgb(80, 250, 123)"> </span><span class="token string function operator" style="color:rgb(80, 250, 123)">-</span><span class="token string function" style="color:rgb(80, 250, 123)">Format o</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$message</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># =========================</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Main Logic</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># =========================</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Write-Log</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Setting Azure subscription context..."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">az account </span><span class="token function" style="color:rgb(80, 250, 123)">set</span><span class="token plain"> </span><span class="token operator">--</span><span class="token plain">subscription </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$subscriptionId</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Write-Log</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Getting AKS credentials for cluster '</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$clusterName</span><span class="token string" style="color:rgb(255, 121, 198)">' in resource group '</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceGroup</span><span class="token string" style="color:rgb(255, 121, 198)">'..."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">az aks </span><span class="token function" style="color:rgb(80, 250, 123)">get-credentials</span><span class="token plain"> </span><span class="token operator">--</span><span class="token plain">resource-</span><span class="token function" style="color:rgb(80, 250, 123)">group</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceGroup</span><span class="token plain"> </span><span class="token operator">--</span><span class="token plain">name </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$clusterName</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Write-Log</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"AKS credentials setup."</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="Get AKS Credentials" src="https://luke.geek.nz/assets/images/ConnectAzlKubeBuddyPSModule-6c8838202845ac04667bbd2fc00ba762.gif" width="1151" height="300" class="img_ev3q"></p>
<p>Once we have the AKS credentials and set the kuberconfig, we can run KubeBuddy.</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># =========================</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Variables</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># =========================</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceGroup</span><span class="token plain">      = </span><span class="token string" style="color:rgb(255, 121, 198)">"akscluster-rg"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$clusterName</span><span class="token plain">        = </span><span class="token string" style="color:rgb(255, 121, 198)">"lukesakscluster"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$subscriptionId</span><span class="token plain">     = </span><span class="token string" style="color:rgb(255, 121, 198)">"7a30b0c4-5b48-419e-8e57-439b127b69d2"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># =========================</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Helper Functions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># =========================</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Log</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token namespace">[string]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$message</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function" style="color:rgb(80, 250, 123)">Get-Date</span><span class="token string function" style="color:rgb(80, 250, 123)"> </span><span class="token string function operator" style="color:rgb(80, 250, 123)">-</span><span class="token string function" style="color:rgb(80, 250, 123)">Format o</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$message</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># =========================</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Main Logic</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># =========================</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Write-Log</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Invoking KubeBuddy for AKS cluster management..."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Invoke-KubeBuddy</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Aks </span><span class="token operator">-</span><span class="token plain">SubscriptionId </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$subscriptionId</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ResourceGroup </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceGroup</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ClusterName </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$clusterName</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Write-Log</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"KubeBuddy invocation complete."</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="Invoke KubeBuddy" src="https://luke.geek.nz/assets/images/InvokeKubeBuddyPSModule-242ae5444c232db86f80b541fe45a148.gif" width="1151" height="300" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-deliver-insights">üìà Deliver Insights<a href="https://luke.geek.nz/azure/kubebuddy-scanning-clusters/#-deliver-insights" class="hash-link" aria-label="Direct link to üìà Deliver Insights" title="Direct link to üìà Deliver Insights">‚Äã</a></h2>
<p>Generates clear, actionable reports in HTML, JSON, or CLI format for immediate action.</p>
<p>Now that we can run KubeBuddy, we can look at the results. KubeBuddy will run a series of tests against the AKS cluster and return the results. Instead of the interactive mode shown earlier, we are going to have it generate a HTML report with the AKS check results <em>(assuming we have the kubeconfig connected as part of earlier steps)</em>.</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">Invoke-KubeBuddy</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">HtmlReport</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="Invoke KubeBuddy HTML Report" src="https://luke.geek.nz/assets/images/InvokeKubeBuddyHTMLReport-def86b9cbefe4ef72b2bfefdaba9efc2.gif" width="1151" height="300" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="KubeBuddy HTML Report" src="https://luke.geek.nz/assets/images/KubeBuddyHTMLReport-b895f164dfdac41ae9f749f3b92635e2.gif" width="1880" height="901" class="img_ev3q"></p>
<p>We can see that my Kubernetes cluster is not healthy. The AKS cluster has issues, and the HTML report includes recommended actions.</p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>So far, the alerts and reports are only Kubernetes-based for the HTML reports. If we are using Docker, we will have to authenticate using a Service Principal for the Aks health checks, but with the PowerShell method, we are already authenticated, so we can simply add the Aks switch.</p></div></div>
<p>And rerun the KubeBuddy report command, with the AKS switch:</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">Invoke-KubeBuddy</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">AKS </span><span class="token operator">-</span><span class="token plain">SubscriptionId </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$subscriptionId</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ResourceGroup </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceGroup</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ClusterName </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$clusterName</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">HtmlReport</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="KubeBuddy HTML Checks" src="https://luke.geek.nz/assets/images/KubeBuddyHTMLAksChecks-53cf9c5fadd0a926787b5ee4b7b42efa.jpg" width="1910" height="1272" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-analyze-issues">üîé Analyze Issues<a href="https://luke.geek.nz/azure/kubebuddy-scanning-clusters/#-analyze-issues" class="hash-link" aria-label="Direct link to üîé Analyze Issues" title="Direct link to üîé Analyze Issues">‚Äã</a></h2>
<p>Detects hidden problems like misconfigurations, security risks, and resource failures in seconds.</p>
<p>Now that we have scanned our cluster and retrieved the reports, it's time to review and analyse the issues we have encountered.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>You can do a comparison of 2 different reports to see if you are going up and down:</p><p>For example, if you run the following command to do the output as a text file:</p><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">Invoke-KubeBuddy</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">txtReport </span><span class="token operator">-</span><span class="token plain">Aks </span><span class="token operator">-</span><span class="token plain">SubscriptionId </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$SubscriptionId</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ResourceGroup </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceGroup</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ClusterName </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ClusterName</span><br></span></code></pre></div></div><p>Then run a script similar to the one below to create a comparison file:</p><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># =========================</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Variables (snake_case)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># =========================</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$report_path_1</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"./kubebuddy-report-20250508-082143.txt"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$report_path_2</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"./kubebuddy-report-20250507-181629.txt"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$output_diff_path</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"./kubebuddy-report-diff.txt"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># =========================</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Parameters (camelCase)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># =========================</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token namespace">[string]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$reportFile1</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$report_path_1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token namespace">[string]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$reportFile2</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$report_path_2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token namespace">[string]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$outputFile</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$output_diff_path</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># =========================</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Helper Functions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># =========================</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token plain"> Validate-FileExists </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token namespace">[string]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$filePath</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[string]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$paramName</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">-not</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token function" style="color:rgb(80, 250, 123)">Test-Path</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$filePath</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">throw</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"File '</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$filePath</span><span class="token string" style="color:rgb(255, 121, 198)">' specified by '</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$paramName</span><span class="token string" style="color:rgb(255, 121, 198)">' does not exist."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># =========================</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Main Logic</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># =========================</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">try</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Validate input files</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Validate-FileExists </span><span class="token operator">-</span><span class="token plain">filePath </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$reportFile1</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">paramName </span><span class="token string" style="color:rgb(255, 121, 198)">"reportFile1"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Validate-FileExists </span><span class="token operator">-</span><span class="token plain">filePath </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$reportFile2</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">paramName </span><span class="token string" style="color:rgb(255, 121, 198)">"reportFile2"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Compare files (ignoring whitespace differences)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$diff</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Compare-Object</span><span class="token plain"> `</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token operator">-</span><span class="token plain">ReferenceObject </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token function" style="color:rgb(80, 250, 123)">Get-Content</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$reportFile1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> `</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token operator">-</span><span class="token plain">DifferenceObject </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token function" style="color:rgb(80, 250, 123)">Get-Content</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$reportFile2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> `</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token operator">-</span><span class="token plain">IncludeEqual:</span><span class="token boolean">$false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$diff</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$diff</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Out-File</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">FilePath </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$outputFile</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Differences found. See </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$outputFile</span><span class="token string" style="color:rgb(255, 121, 198)"> for details."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"No differences found between the reports."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Write-Error</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Exception</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Message</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">exit</span><span class="token plain"> 1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre></div></div><p>This will generate a diff file, which you can then pass into something like Copilot or another script to do something like this:</p><p><img decoding="async" loading="lazy" alt="KubeBuddy" src="https://luke.geek.nz/assets/images/CompareKubeBuddyRuns-d5632c7a030f240490eb0db1bc490e21.gif" width="998" height="652" class="img_ev3q"></p></div></div>
<p>You can follow the recommendations, ie, <a href="https://learn.microsoft.com/azure/aks/use-managed-identity?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Use a managed identity in Azure Kubernetes Service (AKS)</a> that the reports give you. Be aware that some of the issues can only be resolved during the cluster creation. So, ideally, you would run this report as early in the lifecycle as possible, during the proof of technology phase, and take the recommendations into account as part of provisioning any UAT or Production workloads.</p>
<p>Give <a href="https://kubebuddy.kubedeck.io/" target="_blank" rel="noopener noreferrer">KubeBuddy</a> a go today!</p>]]></content:encoded>
            <category>Azure</category>
            <category>Misc</category>
        </item>
        <item>
            <title><![CDATA[GitHub Codespace Secrets]]></title>
            <link>https://luke.geek.nz/misc/codespace-secrets/</link>
            <guid>https://luke.geek.nz/misc/codespace-secrets/</guid>
            <pubDate>Mon, 05 May 2025 06:25:14 GMT</pubDate>
            <description><![CDATA[Learn how to set up, configure, and use GitHub Codespace secrets.]]></description>
            <content:encoded><![CDATA[<p>Today, we are going to look at Codespace Secrets.</p>
<!-- -->
<p>GitHub Codespaces secrets are environment variables that are securely stored in your GitHub account and made available to your Codespace environment. They help you manage sensitive information without hardcoding it in your repository.</p>
<p>This is a root-level configuration, so it's at the same level as features.</p>
<p>These are <a href="https://docs.github.com/en/codespaces/managing-your-codespaces/managing-your-account-specific-secrets-for-github-codespaces" target="_blank" rel="noopener noreferrer">account-specific secrets</a>.</p>
<p>You can configure them from your <a href="https://github.com/settings/codespaces" target="_blank" rel="noopener noreferrer">Codespace account settings</a> and allow them for specific repositories.</p>
<p><img decoding="async" loading="lazy" alt="GitHub - Codespace Secrets" src="https://luke.geek.nz/assets/images/GitHubCodespace_Secrets-ab7e971ab6b997825e5700fe21de67b0.jpg" width="1017" height="658" class="img_ev3q"></p>
<p>And when you open up a Codespace, and run a command like 'printenv' you can see the value as environment variables, you can then call.</p>
<p><img decoding="async" loading="lazy" alt="GitHub Codespace" src="https://luke.geek.nz/assets/images/GitHubCodespace_SecretAccountSettingTest-a5188f57b8ed8ff8d3b8175444aefd12.gif" width="1162" height="342" class="img_ev3q"></p>
<p>However, thats not scalable, as it requires everyone to add in the secrets to their secrets ahead of time.</p>
<p>You can configure the name of these secrets in your devcontainer.json file, as below:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token property">"secrets"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		</span><span class="token property">"AZURE_OPENAI_ENDPOINT"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		</span><span class="token property">"AZURE_OPENAI_KEY"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><br></span></code></pre></div></div>
<p>This is a root-level configuration, just like Features and customizations, so it sits at the same level, like below:.</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token property">"name"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Python 3"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token property">"image"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"mcr.microsoft.com/devcontainers/python:1-3.12-bullseye"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token property">"secrets"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		</span><span class="token property">"AZURE_OPENAI_ENDPOINT"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		</span><span class="token property">"AZURE_OPENAI_KEY"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	 </span><span class="token property">"features"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre></div></div>
<p>This allows you to prompt for the secrets as part of the Codespace build.</p>
<p><img decoding="async" loading="lazy" alt="Codespace Secret Configuration Test" src="https://luke.geek.nz/assets/images/GitHubCodespace_CodespaceSettingTest-38937c6f0d7216c4656879de95ed1d21.gif" width="1843" height="746" class="img_ev3q"></p>
<p>It is accessed normally through the environment variables as well:</p>
<p><img decoding="async" loading="lazy" alt="Codespace Secret Configuration Test" src="https://luke.geek.nz/assets/images/GitHubCodespace_CodespaceSettingTestEnv-9a973d32155c7e5393f29819fe366083.gif" width="1527" height="309" class="img_ev3q"></p>
<p>For those with a keen eye, will also realise that the environment variables are now entered into your Secrets Account settings, scoped to your repository:</p>
<p><img decoding="async" loading="lazy" alt="Codespace Secrets" src="https://luke.geek.nz/assets/images/GitHubCodespace_SecretsAfterCodespace-004957be42699c5ff87e4b96586f75cd.jpg" width="1441" height="489" class="img_ev3q"></p>
<p>From there, you can change the value.</p>
<p>Then you can use a link like below <em>(replace your repo with your own)</em> to point users directly to your Codespace, with the Secret field:</p>
<p><a href="https://github.com/codespaces/new?hide_repo_select=true&amp;ref=main&amp;repo=lukemurraynz/CodespaceSecret&amp;machine=basicLinux32gb&amp;devcontainer_path=.devcontainer%2Fdevcontainer.json" target="_blank" rel="noopener noreferrer">https://github.com/codespaces/new?hide_repo_select=true&amp;ref=main&amp;repo=lukemurraynz/CodespaceSecret&amp;machine=basicLinux32gb&amp;devcontainer_path=.devcontainer%2Fdevcontainer.json</a></p>
<p><img decoding="async" loading="lazy" alt="Codespace Link" src="https://luke.geek.nz/assets/images/GitHubCodespace_SecretsAfterCodespaceLink-74c41247a162df6f2b81713f91c75bfd.jpg" width="1202" height="955" class="img_ev3q"></p>
<p>Then you can call the values in your script and applications as needed.</p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>These are not encrypted, even though they are scoped to your account only. If you output these in text, they will be shown, so be careful with their use in your application.</p></div></div>
<p>PowerShell example:</p>
<div class="language-PowerShell language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Get environment variables for AZURE_OPENAI_KEY and AZURE_OPENAI_ENDPOINT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$azureOpenAiEndpoint</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$env</span><span class="token plain">:AZURE_OPENAI_ENDPOINT</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$azureOpenAiKey</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$env</span><span class="token plain">:AZURE_OPENAI_KEY</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"AZURE_OPENAI_ENDPOINT: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$azureOpenAiEndpoint</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"AZURE_OPENAI_KEY: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$azureOpenAiKey</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><br></span></code></pre></div></div>
<p>Python example:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> os</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">azure_openai_endpoint </span><span class="token operator">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"AZURE_OPENAI_ENDPOINT"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">azure_openai_key </span><span class="token operator">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"AZURE_OPENAI_KEY"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">print</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">f"AZURE_OPENAI_ENDPOINT: </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string-interpolation interpolation">azure_openai_endpoint</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">print</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">f"AZURE_OPENAI_KEY: </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string-interpolation interpolation">azure_openai_key</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre></div></div>]]></content:encoded>
            <category>Misc</category>
        </item>
        <item>
            <title><![CDATA[Azure Container Registry Continuous Patching for Security]]></title>
            <link>https://luke.geek.nz/azure/acr-continuous-patching-security/</link>
            <guid>https://luke.geek.nz/azure/acr-continuous-patching-security/</guid>
            <pubDate>Fri, 25 Apr 2025 05:16:22 GMT</pubDate>
            <description><![CDATA[Learn how to use Azure Container Registry's Continuous Patching to detect and fix vulnerabilities in container images with Trivy and Copa.]]></description>
            <content:encoded><![CDATA[<p>Last year, I blogged about <a href="https://luke.geek.nz/azure/automate-container-patching-with-trivy-copacetic-azure-devops/" target="_blank" rel="noopener noreferrer">Container Patching with Azure DevOps, Trivy and Copacetic</a>, and how to use Azure DevOps to automate the patching of your container images using Trivy and Copacetic. This was a great solution, but it required a lot of manual work to set up and maintain. Today, I am going to take a look at Continuous Patching with Azure Container Registry (ACR) and how to use it to automate the patching of your container images.</p>
<!-- -->
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-what-is-acr-continuous-patching">üõ°Ô∏è What is ACR Continuous Patching?<a href="https://luke.geek.nz/azure/acr-continuous-patching-security/#%EF%B8%8F-what-is-acr-continuous-patching" class="hash-link" aria-label="Direct link to üõ°Ô∏è What is ACR Continuous Patching?" title="Direct link to üõ°Ô∏è What is ACR Continuous Patching?">‚Äã</a></h2>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>At the time of writing, this is a <strong>Preview feature</strong>, so the experience we run through today may change in the future or the feature may be removed entirely.</p><p>The following limitations apply:</p><ul>
<li>Windows-based container images aren't supported.</li>
<li>Only "OS-level" vulnerabilities that originate from system packages will be patched. This includes system packages in the container image managed by an OS package manager such as "apt‚Äù and "yum‚Äù. Vulnerabilities that originate from application packages, such as packages used by programming languages like Go, Python, and NodeJS, cannot be patched.</li>
<li>End of Service Life (EOSL) images are not supported by Continuous Patching. EOSL images refer to images where updates, security patches, or technical support are no longer available for the underlying operating system. Examples include images based on older operating system versions, such as Debian 8 and Fedora 28. EOSL images will be skipped from the patch, despite having vulnerabilities. The recommended approach is to upgrade the underlying operating system of your image to a supported version.</li>
</ul></div></div>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p><a href="https://learn.microsoft.com/azure/container-registry/container-registry-intro?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Container Registry</a>'s Continuous Patching feature automates the detection and remediation of operating system(OS) level vulnerabilities in container images. By scheduling regular scans with <a href="https://trivy.dev/" target="_blank" rel="noopener noreferrer">Trivy</a> and applying security fixes using <a href="https://project-copacetic.github.io/copacetic/website/" target="_blank" rel="noopener noreferrer">Copa</a>, you can maintain secure, up-to-date images in your registry, without requiring access to source code or build pipelines. Simply customize the schedule and target images to keep your Azure Container Registry(ACR) environment safe and compliant.</p><p>Here are a few scenarios to use Continuous Patching:</p><ul>
<li>Enforcing container security and hygiene: Continuous Patching enables users to quickly fix OS container CVEs without the need to rebuild from upstream fully.</li>
<li>Speed of Use: Continuous Patching eliminates the dependency on upstream updates for specific images by automatically updating packages. Vulnerabilities can appear every day, while popular image publishers may only release new content once a month. With Continuous Patching, you can ensure that container images within your registry are patched as soon as the latest set of OS vulnerabilities is detected.</li>
</ul></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-test-environment-setup">üß™ Test Environment Setup<a href="https://luke.geek.nz/azure/acr-continuous-patching-security/#-test-environment-setup" class="hash-link" aria-label="Direct link to üß™ Test Environment Setup" title="Direct link to üß™ Test Environment Setup">‚Äã</a></h2>
<p>In my testing, I am going to use the <a href="https://hub.docker.com/_/api-firewall" target="_blank" rel="noopener noreferrer">api-firewall</a> image, version <a href="https://hub.docker.com/layers/library/api-firewall/0.6.16/images/sha256-d6538706176b7c481355abb46dbeb25afcb272647e37dc2521e2a40db55a046c" target="_blank" rel="noopener noreferrer">0.6.16</a> that I have pushed to my Azure Container Registry.</p>
<p><img decoding="async" loading="lazy" alt="Image - Azure Container Registry" src="https://luke.geek.nz/assets/images/ContinuousPatching_ACR_APIFirewallImageBefore-dce33642a27641f40c03cfa5f94d07d0.jpg" width="1534" height="739" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-how-continuous-patching-works">‚öôÔ∏è How Continuous Patching Works<a href="https://luke.geek.nz/azure/acr-continuous-patching-security/#%EF%B8%8F-how-continuous-patching-works" class="hash-link" aria-label="Direct link to ‚öôÔ∏è How Continuous Patching Works" title="Direct link to ‚öôÔ∏è How Continuous Patching Works">‚Äã</a></h2>
<p>Let's take a look at how this will work.</p>
<p>Continuous Patching in ACR creates a new image per patch. ACR relies on a tag convention to version and identify patched images. The two main approaches are incremental and floating.</p>
<table><thead><tr><th>Feature</th><th>Incremental Tagging</th><th>Floating Tagging</th></tr></thead><tbody><tr><td><strong>How It Works</strong></td><td>Adds numerical suffix (-1, -2, etc.) to original tag</td><td>Uses single mutable tag "-patched" that always points to latest version</td></tr><tr><td><strong>Example</strong></td><td>If base is python:3.11:- First patch: python:3.11-1- Second patch: python:3.11-2</td><td>If base is python:3.11:- All patches use: python:3.11-patched</td></tr><tr><td><strong>Special Rules</strong></td><td>- Tags -1 to -999 are considered patch tags- Tags with -x where x &gt; 999 are treated as original tags- Avoid pushing your tags ending with -1 to --999- Errors if -999 versions are reached</td><td>Tag automatically updates with each new patch</td></tr><tr><td><strong>Version History</strong></td><td>Preserved (each patch gets unique tag)</td><td>Not preserved (single tag is updated)</td></tr></tbody></table>
<p><img decoding="async" loading="lazy" alt="Image - Azure Container Registry" src="https://luke.geek.nz/assets/images/patching_timeline_example1-5a26b93211e3b33dae083218aa7fdef9.png" width="1312" height="868" class="img_ev3q"></p>
<p>Incremental (default) is ideal for environments where auditability and rollbacks are crucial, as a unique tag identifies each new patch.</p>
<p>Floating is ideal if you prefer a single pointer to the latest patch for your CI/CD pipelines. Reduces complexity by eliminating the need to update references in downstream applications with each patch, but sacrifices strict versioning, making it challenging to roll back.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-getting-started-with-continuous-patching">üöÄ Getting Started with Continuous Patching<a href="https://luke.geek.nz/azure/acr-continuous-patching-security/#-getting-started-with-continuous-patching" class="hash-link" aria-label="Direct link to üöÄ Getting Started with Continuous Patching" title="Direct link to üöÄ Getting Started with Continuous Patching">‚Äã</a></h2>
<p>So let us get started. To begin, I will utilize my <a href="https://github.com/lukemurraynz/Codespace_IaC_Coding" target="_blank" rel="noopener noreferrer">Codespace_IaC_Coding</a> Codespace configuration, which already meets the prerequisites I need, specifically <a href="https://learn.microsoft.com/cli/azure/what-is-azure-cli?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure CLI</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-installing-the-required-extension">üì¶ Installing the Required Extension<a href="https://luke.geek.nz/azure/acr-continuous-patching-security/#-installing-the-required-extension" class="hash-link" aria-label="Direct link to üì¶ Installing the Required Extension" title="Direct link to üì¶ Installing the Required Extension">‚Äã</a></h3>
<p>To start, we need to install the CLI extension for ACR Continuous Patching:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">az extension </span><span class="token function" style="color:rgb(80, 250, 123)">add</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-n</span><span class="token plain"> acrcssc</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="Install Custom extension" src="https://luke.geek.nz/assets/images/ACR_ContinuousPatching_InstallExtension-57e1b5c89e8cd11fb261b36e76a0a9f8.gif" width="1567" height="312" class="img_ev3q"></p>
<p>Then we need to log in to our Azure Container Registry:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">az login</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">az acr login </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-n</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain">myRegistry</span><span class="token operator">&gt;</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="Login to ACR" src="https://luke.geek.nz/assets/images/ACR_ContinuousPatching_LoginAzureACR-07600f44193d9ee82b6cf85a33b4c2ea.gif" width="1567" height="312" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-configuring-the-continuous-patching-schema">üìù Configuring the Continuous Patching Schema<a href="https://luke.geek.nz/azure/acr-continuous-patching-security/#-configuring-the-continuous-patching-schema" class="hash-link" aria-label="Direct link to üìù Configuring the Continuous Patching Schema" title="Direct link to üìù Configuring the Continuous Patching Schema">‚Äã</a></h3>
<p>Now we need to prepare the JSON schema that we will use to configure our Continuous Patching.</p>
<p>This schema defines which repositories and tags to patch, when to patch them, and how to tag the patched images.</p>
<p>The schema includes these key components:</p>
<ul>
<li><code>version</code> - Used by the ACR team to track schema versions. Don't modify this unless instructed.</li>
<li><code>tag-convention</code> - Optional field that specifies the tagging method. Values can be "incremental" (default) or "floating".</li>
<li><code>repositories</code> - An array of objects containing:<!-- -->
<ul>
<li><code>repository</code> - The name of the repository to patch</li>
<li><code>tags</code> - Array of specific tags to patch (use wildcard <code>*</code> to include all tags)</li>
<li><code>enabled</code> - Boolean (true/false) to enable or disable patching for this repository</li>
</ul>
</li>
</ul>
<p>For example:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"version"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"v1"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"tag-convention"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"incremental"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"repositories"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"repository"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"api-firewall"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"tags"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">"0.6.7"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"latest"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"enabled"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre></div></div>
<p>So let us create the file as below:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">cat</span><span class="token plain"> </span><span class="token operator">&lt;&lt;</span><span class="token string" style="color:rgb(255, 121, 198)">EOF</span><span class="token string bash punctuation" style="color:rgb(248, 248, 242)"> </span><span class="token string bash punctuation operator" style="color:rgb(248, 248, 242)">&gt;</span><span class="token string bash punctuation" style="color:rgb(248, 248, 242)"> continuouspatching.json</span><span class="token string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  "version": "v1",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  "tag-convention": "incremental",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  "repositories": [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">      "repository": "api-firewall",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">      "tags": ["0.6.7", "latest"],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">      "enabled": true</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  ]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">EOF</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-running-a-dry-run">üßê Running a Dry Run<a href="https://luke.geek.nz/azure/acr-continuous-patching-security/#-running-a-dry-run" class="hash-link" aria-label="Direct link to üßê Running a Dry Run" title="Direct link to üßê Running a Dry Run">‚Äã</a></h3>
<p>Next, we can run a dry run of the supply-chain workflow to validate that our repository and tags are correct:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">az acr supply-chain workflow create </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-r</span><span class="token plain"> myRegistry </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-g</span><span class="token plain"> myResourceGroup </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-t</span><span class="token plain"> continuouspatchv1 </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--config</span><span class="token plain"> ./continuouspatching.json </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--schedule</span><span class="token plain"> 1d --dry-run</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="Image - ACR Continuous Patching" src="https://luke.geek.nz/assets/images/ACR_ContinuousPatching_DryRun_SupplyChain-603d2d21a835ab6c96ae67d3420dd5c4.gif" width="1567" height="312" class="img_ev3q"></p>
<p>You can also view the run in the Azure Portal, and see it pull the CSSC <em>(Microsoft's Containers Secure Supply Chain (CSSC) framework)</em> image to run the workflow.</p>
<p><img decoding="async" loading="lazy" alt="Image - ACR Continuous Patching" src="https://luke.geek.nz/assets/images/ContinuousPatching_ACR_DryRun_AzurePortal-1939ee81d3ed66fc00641542c76b360f.jpg" width="1427" height="904" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>You can use the <code>az acr supply-chain workflow update</code> command to update the workflow configuration, if needed, at a later stage.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-understanding-the-scheduling-system">üìÖ Understanding the Scheduling System<a href="https://luke.geek.nz/azure/acr-continuous-patching-security/#-understanding-the-scheduling-system" class="hash-link" aria-label="Direct link to üìÖ Understanding the Scheduling System" title="Direct link to üìÖ Understanding the Scheduling System">‚Äã</a></h2>
<p>Before we do, let's understand how scheduling works in ACR Continuous Patching.</p>
<blockquote>
<p>The scheduling system works like a calendar with fixed dates each month, not like a countdown timer!</p>
</blockquote>
<p>The <code>--schedule</code> parameter sets how many days between patch runs, but these always align to fixed days counting from the 1st of each month. Think of it like marking specific dates on a calendar.</p>
<p>For example, if you choose <code>--schedule 7d</code>, patching will run on the 1st, 8th, 15th, 22nd, and 29th of each month (every 7 days from the 1st).</p>
<p>Here's what happens with different schedule values:</p>
<table><thead><tr><th>Schedule</th><th>Runs on these days each month</th><th>Example</th></tr></thead><tbody><tr><td><code>1d</code></td><td>Every day</td><td>Patches run daily</td></tr><tr><td><code>3d</code></td><td>1st, 4th, 7th, 10th, 13th, 16th, 19th, 22nd, 25th, 28th, 31st</td><td>If today is the 5th, next run is on the 7th</td></tr><tr><td><code>7d</code></td><td>1st, 8th, 15th, 22nd, 29th</td><td>If today is the 10th, next run is on the 15th</td></tr><tr><td><code>14d</code></td><td>1st, 15th, 29th</td><td>If today is the 20th, next run is on the 29th</td></tr><tr><td><code>30d</code></td><td>1st, 31st (if month has 31 days)</td><td>Runs at the beginning and end of the month</td></tr></tbody></table>
<p>When you add the <code>--run-immediately</code> flag, a patch happens right away, and then the next one follows the regular schedule.</p>
<p>Remember: The schedule always resets at the beginning of each month. So if your last patch in January was on the 29th with a <code>7d</code> schedule, the next one will be on February 1st, not February 5th.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-executing-the-workflow">‚ñ∂Ô∏è Executing the Workflow<a href="https://luke.geek.nz/azure/acr-continuous-patching-security/#%EF%B8%8F-executing-the-workflow" class="hash-link" aria-label="Direct link to ‚ñ∂Ô∏è Executing the Workflow" title="Direct link to ‚ñ∂Ô∏è Executing the Workflow">‚Äã</a></h3>
<p>Now let's run the workflow:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">az acr supply-chain workflow create </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-r</span><span class="token plain"> myRegistry </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-g</span><span class="token plain"> myResourceGroup </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-t</span><span class="token plain"> continuouspatchv1 </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--config</span><span class="token plain"> ./continuouspatching.json </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--schedule</span><span class="token plain"> 14d --run-immediately </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--verbose</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>If you get the following warning:</p><p><code>Failed to validate and deploy template: (DeploymentFailed) At least one resource deployment operation failed. Please list deployment operations for details. Please see https://aka.ms/arm-deployment-operations for usage details. Code: DeploymentFailed Message: At least one resource deployment operation failed. Please list deployment operations for details. Please see https://aka.ms/arm-deployment-operations for usage details. Target: /subscriptions/11b74992-d520-46e1-a9e9-b55c57d2e890/resourceGroups/acrcontinuouspatchingtest/providers/Microsoft.Resources/deployments/continuouspatchingdeployment Exception Details:      (RoleAssignmentUpdateNotPermitted) Tenant ID, application ID, principal ID, and scope are not allowed to be updated.         Code: RoleAssignmentUpdateNotPermitted         Message: Tenant ID, application ID, principal ID, and scope are not allowed to be updated.      (RoleAssignmentUpdateNotPermitted) Tenant ID, application ID, principal ID, and scope are not allowed to be updated.</code></p><p>It may mean that the Tasks have existed before, but if the Tasks were deleted in the portal, then it won't have removed the permission assignments.</p><p>You can check the permissions in the Access control (IAM) portal, and if they exist, you can delete them manually from the portal.</p><p>If you run the following workflow delete command <em>(preferred)</em>, it will delete the assigned RBAC permissions as well:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">az acr supply-chain workflow delete </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-r</span><span class="token plain"> myRegistry </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-g</span><span class="token plain"> myResourceGroup </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-t</span><span class="token plain"> continuouspatchv1 </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--yes</span><br></span></code></pre></div></div></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>You can add the <code>--verbose</code> flag to the command to get more detailed output during the workflow creation process and the <code>--debug</code> flag to get even more detailed output, including the HTTP requests and responses sent to Azure.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-reviewing-the-created-tasks">üîß Reviewing the Created Tasks<a href="https://luke.geek.nz/azure/acr-continuous-patching-security/#-reviewing-the-created-tasks" class="hash-link" aria-label="Direct link to üîß Reviewing the Created Tasks" title="Direct link to üîß Reviewing the Created Tasks">‚Äã</a></h2>
<p>Now that the Tasks have been created, you can see them in the Azure Portal.</p>
<p><img decoding="async" loading="lazy" alt="Image - ACR Continuous Patching" src="https://luke.geek.nz/assets/images/ContinuousPatching_ACR_Run_TasksAzurePortal-26db6c4b7b7ae19c124e940bed4da868.jpg" width="1355" height="389" class="img_ev3q"></p>
<p>You can also run the following command to see the state of the workflows:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">az acr supply-chain workflow show </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-r</span><span class="token plain"> myRegistry </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-g</span><span class="token plain"> myResourceGroup </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-t</span><span class="token plain"> Continuouspatchv1  </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-o</span><span class="token plain"> table</span><br></span></code></pre></div></div>
<p>The workflow creates three tasks in your Azure Container Registry:</p>
<table><thead><tr><th>Task Name</th><th>Description</th><th>Purpose</th></tr></thead><tbody><tr><td><strong>cssc-trigger-workflow</strong></td><td>Triggers the continuous patching workflow based on your configured schedule</td><td>This is the main scheduler that runs on your defined schedule (every 14 days in our example). It checks which repositories match your configuration and initiates the scanning process.</td></tr><tr><td><strong>cssc-scan-image</strong></td><td>Performs vulnerability scanning using Trivy</td><td>This task scans your container images for OS-level vulnerabilities. If vulnerabilities are found, it automatically triggers the patching task.</td></tr><tr><td><strong>cssc-patch-image</strong></td><td>Applies security patches using Copacetic</td><td>This task does the actual patching work, fixing OS vulnerabilities in your container images without needing to rebuild them from source.</td></tr></tbody></table>
<p>These three tasks work together to form a complete patching pipeline: the trigger starts on schedule, the scanner identifies vulnerabilities, and the patcher automatically fixes them.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-monitoring-task-execution">üìä Monitoring Task Execution<a href="https://luke.geek.nz/azure/acr-continuous-patching-security/#-monitoring-task-execution" class="hash-link" aria-label="Direct link to üìä Monitoring Task Execution" title="Direct link to üìä Monitoring Task Execution">‚Äã</a></h3>
<p>You can check the logs of the run by looking up the recent Runs:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">az acr task logs </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--registry</span><span class="token plain"> myRegistry</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="Image - ACR Continuous Patching" src="https://luke.geek.nz/assets/images/ContinuousPatching_ACR_Logs-90da0d0534e4ad212fd5f823d9960350.jpg" width="1424" height="697" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-viewing-the-results">üéØ Viewing the Results<a href="https://luke.geek.nz/azure/acr-continuous-patching-security/#-viewing-the-results" class="hash-link" aria-label="Direct link to üéØ Viewing the Results" title="Direct link to üéØ Viewing the Results">‚Äã</a></h2>
<p>Now, if we go into the repositories in the Azure Portal, we can see that the image has been patched with the incremental tag.</p>
<p><img decoding="async" loading="lazy" alt="Image - Azure Container Registry" src="https://luke.geek.nz/assets/images/ContinuousPatching_ACR_Patched-648c61e407761be61dcff3dc5dc424fe.jpg" width="979" height="410" class="img_ev3q"></p>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Processing SFTP Events with Azure Function and Event Hub]]></title>
            <link>https://luke.geek.nz/azure/sftp-event-hub-function/</link>
            <guid>https://luke.geek.nz/azure/sftp-event-hub-function/</guid>
            <pubDate>Fri, 18 Apr 2025 02:13:25 GMT</pubDate>
            <description><![CDATA[A practical guide to setting up Azure Storage SFTP with Event Hub and Azure Functions to monitor and process file uploads]]></description>
            <content:encoded><![CDATA[<p>Today, we are going to use the <a href="https://learn.microsoft.com/azure/storage/blobs/secure-file-transfer-protocol-support?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Storage SFTP functionality</a> and an <a href="https://learn.microsoft.com/azure/event-hubs/event-hubs-about?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Event Hub</a> to trigger an <a href="https://learn.microsoft.com/azure/azure-functions/functions-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Function</a>. The Azure Function will then process the Write Logs, and output the File name, SFTP Local User name, Agent header and the SFTP Client IP address to the host, from there you can do whatever you want with the data.</p>
<!-- -->
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-environment-overview">üèóÔ∏è Environment Overview<a href="https://luke.geek.nz/azure/sftp-event-hub-function/#%EF%B8%8F-environment-overview" class="hash-link" aria-label="Direct link to üèóÔ∏è Environment Overview" title="Direct link to üèóÔ∏è Environment Overview">‚Äã</a></h2>
<p>So for my environment, I have a:</p>
<ul>
<li>A SFTP Hierarchical namespace-enabled storage account</li>
<li>A Flex Consumption Azure Function App</li>
<li>A Standard Event Hub Namespace with an event hub instance with 1 partition and 1 consumer group</li>
</ul>
<p>These resources are hosted in the New Zealand North Azure region.</p>
<!-- -->
<p>So I've already pre-created these resources, but is there some more information about the resource configuration that you can follow along with?</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-storage-account-configuration">üì¶ Storage Account Configuration<a href="https://luke.geek.nz/azure/sftp-event-hub-function/#-storage-account-configuration" class="hash-link" aria-label="Direct link to üì¶ Storage Account Configuration" title="Direct link to üì¶ Storage Account Configuration">‚Äã</a></h2>
<p>For the Azure Storage account with SFTP enabled, I'm using the following configuration:</p>
<ul>
<li>
<p><strong>Name</strong>: sftptestluketest</p>
</li>
<li>
<p><strong>Location</strong>: New Zealand North</p>
</li>
<li>
<p><strong>Performance</strong>: Standard</p>
</li>
<li>
<p><strong>Redundancy</strong>: Locally-redundant storage (LRS)</p>
</li>
<li>
<p><strong>Account kind</strong>: StorageV2 (general purpose v2)</p>
</li>
<li>
<p><strong>Access tier</strong>: Hot</p>
</li>
<li>
<p><strong>Key features enabled</strong>:</p>
<ul>
<li>Hierarchical namespace (HNS) ‚úÖ</li>
<li>SFTP support ‚úÖ</li>
<li>Local user authentication ‚úÖ</li>
</ul>
</li>
<li>
<p><strong>Security settings</strong>:</p>
<ul>
<li>Minimum TLS version: 1.2</li>
<li>Public blob access: Disabled</li>
<li>Network access: Public (default action: Allow)</li>
<li>HTTPS only: Enabled</li>
<li>Azure services bypass: Enabled</li>
<li>Shared key access: Enabled</li>
</ul>
</li>
<li>
<p><strong>Diagnostic settings</strong>:</p>
<ul>
<li>StorageWrite logs sent to Event Hub Namespace</li>
<li>Configured to capture StorageWrite logs for all blob operations</li>
</ul>
<p><img decoding="async" loading="lazy" alt="Azure Storage SFTP Blob Diagnostic" src="https://luke.geek.nz/assets/images/AzureSFTPBlogStorageDiagEH-87de513a67721d5d1b696b6fe014a737.jpg" width="1150" height="847" class="img_ev3q"></p>
</li>
</ul>
<p>The hierarchical namespace (HNS) is a prerequisite for SFTP support in Azure Storage. This enables the directory and subdirectory structure that SFTP clients expect when connecting.</p>
<p>With SFTP and local users enabled, you can create local SFTP users that can authenticate with password and/or SSH key authentication, and assign them permissions to specific containers and directories within your storage account.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-event-hub-namespace-configuration">üì° Event Hub Namespace Configuration<a href="https://luke.geek.nz/azure/sftp-event-hub-function/#-event-hub-namespace-configuration" class="hash-link" aria-label="Direct link to üì° Event Hub Namespace Configuration" title="Direct link to üì° Event Hub Namespace Configuration">‚Äã</a></h2>
<p>For receiving and processing the Azure Storage SFTP events, I've set up an Event Hub Namespace with the following configuration:</p>
<ul>
<li><strong>Name</strong>: sftpeventhub</li>
<li><strong>Location</strong>: New Zealand North</li>
<li><strong>Pricing tier</strong>: Standard</li>
<li><strong>Throughput capacity</strong>: 1 throughput unit (base capacity)</li>
<li><strong>Key features</strong>:<!-- -->
<ul>
<li>Auto-inflate enabled ‚úÖ</li>
<li>Maximum throughput units: 5 (scales automatically as needed)</li>
<li>Zone redundant ‚úÖ</li>
<li>Kafka support enabled ‚úÖ</li>
</ul>
</li>
<li><strong>Security settings</strong>:<!-- -->
<ul>
<li>Minimum TLS version: 1.2</li>
<li>Network access: Public</li>
</ul>
</li>
</ul>
<p>Within this namespace, I've created an Event Hub instance with a single partition and a dedicated consumer group that will be used by the Azure Function to process SFTP events.</p>
<p><img decoding="async" loading="lazy" alt="Event Hub Namespace Configuration" src="https://luke.geek.nz/assets/images/EventHubNSConfig-4c3ef7400af9ff54c1f0e16917092a12.jpg" width="1979" height="938" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-function-app-configuration">‚öôÔ∏è Function App Configuration<a href="https://luke.geek.nz/azure/sftp-event-hub-function/#%EF%B8%8F-function-app-configuration" class="hash-link" aria-label="Direct link to ‚öôÔ∏è Function App Configuration" title="Direct link to ‚öôÔ∏è Function App Configuration">‚Äã</a></h2>
<p>For processing the SFTP events from the Event Hub, I've set up an Azure Function App with the following configuration:</p>
<ul>
<li><strong>Name</strong>: sftptest</li>
<li><strong>Location</strong>: Australia East (Different from Storage and Event Hub to demonstrate cross-region capability)</li>
<li><strong>Hosting plan</strong>: FlexConsumption (serverless)</li>
<li><strong>Runtime stack</strong>: PowerShell 7.4</li>
<li><strong>Operating system</strong>: Linux</li>
<li><strong>Key features</strong>:<!-- -->
<ul>
<li>Application Insights enabled ‚úÖ</li>
<li>HTTPS only ‚úÖ</li>
<li>System-assigned managed identity ‚úÖ</li>
</ul>
</li>
<li><strong>Scaling configuration</strong>:<!-- -->
<ul>
<li>Maximum instance count: 100</li>
<li>Instance memory: 2048 MB</li>
</ul>
</li>
<li><strong>Security settings</strong>:<!-- -->
<ul>
<li>Public network access: Enabled</li>
<li>Client certificate mode: Required</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-authentication-setup">üîí Authentication Setup<a href="https://luke.geek.nz/azure/sftp-event-hub-function/#-authentication-setup" class="hash-link" aria-label="Direct link to üîí Authentication Setup" title="Direct link to üîí Authentication Setup">‚Äã</a></h2>
<p>The Function App connects to the Event Hub namespace using the System Managed Identity of the Function App, which is granted the <code>Azure Event Hubs Data Receiver</code> role on the Event Hub namespace.</p>
<p><img decoding="async" loading="lazy" alt="Function App Configuration" src="https://luke.geek.nz/assets/images/Function_SMI_EventHubDataReceiver-d0fdd7c8fa804fe6271f264284f38341.jpg" width="1727" height="319" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-function-app-settings">üõ†Ô∏è Function App Settings<a href="https://luke.geek.nz/azure/sftp-event-hub-function/#%EF%B8%8F-function-app-settings" class="hash-link" aria-label="Direct link to üõ†Ô∏è Function App Settings" title="Direct link to üõ†Ô∏è Function App Settings">‚Äã</a></h2>
<p>To use the Event Hub trigger in the Azure Function with Managed Identity authentication, you need to add the following settings to the Function App settings :</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"EventHubConnection__credential"</span><span class="token operator">:</span><span class="token plain"> managedIdentity</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"EventHubConnection__fullyQualifiedNamespace"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"&lt;Your Event Hub Namespace&gt;.servicebus.windows.net"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="Event Hub App setting" src="https://luke.geek.nz/assets/images/Function_AppSetting-79719db595e3bd486e82dfb4df1d02dd.jpg" width="1975" height="562" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-function-configuration-file">üìã Function Configuration File<a href="https://luke.geek.nz/azure/sftp-event-hub-function/#-function-configuration-file" class="hash-link" aria-label="Direct link to üìã Function Configuration File" title="Direct link to üìã Function Configuration File">‚Äã</a></h2>
<p>The namespace, Consumer Group, and identity type will need to be updated in the function.json file.</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"bindings"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"type"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"eventHubTrigger"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"name"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"eventHubMessages"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"direction"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"in"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"eventHubName"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"sftp"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"connection"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"EventHubConnection"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"cardinality"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"many"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"consumerGroup"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"$Default"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"identity"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"SystemAssigned"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"fullyQualifiedNamespace"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"sftpeventhub.servicebus.windows.net"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-powershell-code">üíª PowerShell Code<a href="https://luke.geek.nz/azure/sftp-event-hub-function/#-powershell-code" class="hash-link" aria-label="Direct link to üíª PowerShell Code" title="Direct link to üíª PowerShell Code">‚Äã</a></h2>
<p>Here is my run.ps1 file for the Azure Function:</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$eventHubMessages</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$TriggerMetadata</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"PowerShell SFTP event hub trigger function called"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Process each message</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$eventHubMessages</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">ForEach-Object</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Get the records array from the message</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token plain"> </span><span class="token operator">-is</span><span class="token plain"> </span><span class="token namespace">[System.Management.Automation.OrderedHashtable]</span><span class="token plain"> </span><span class="token operator">-or</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token plain"> </span><span class="token operator">-is</span><span class="token plain"> </span><span class="token namespace">[hashtable]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ContainsKey</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'records'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Processing SFTP Storage events..."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token comment" style="color:rgb(98, 114, 164)"># Filter for StorageWrite operations with status code 200</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$filteredRecords</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">records </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Where-Object</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">category </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"StorageWrite"</span><span class="token plain"> </span><span class="token operator">-and</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">statusCode </span><span class="token operator">-eq</span><span class="token plain"> 200 </span><span class="token operator">-and</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">operationName </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"SftpCreate"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Found </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$filteredRecords</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Count</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)"> StorageWrite 200 operations"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token comment" style="color:rgb(98, 114, 164)"># Display only the requested information</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">foreach</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$record</span><span class="token plain"> in </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$filteredRecords</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$output</span><span class="token plain"> = </span><span class="token namespace">[ordered]</span><span class="token plain">@</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token string" style="color:rgb(255, 121, 198)">'Operation'</span><span class="token plain">     = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$record</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">operationName</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token string" style="color:rgb(255, 121, 198)">'FileName'</span><span class="token plain">      = </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$record</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">properties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">objectKey </span><span class="token operator">-match</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'^(?:[^/]*/){3}(.*)$'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$matches</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$record</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">properties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">objectKey </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token string" style="color:rgb(255, 121, 198)">'UserID'</span><span class="token plain">        = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$record</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">identity</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">requester</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">objectId</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token string" style="color:rgb(255, 121, 198)">'UserIPAddress'</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$record</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">callerIpAddress</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token string" style="color:rgb(255, 121, 198)">'UserAgent'</span><span class="token plain">     = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$record</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">properties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">userAgentHeader</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token string" style="color:rgb(255, 121, 198)">'Time'</span><span class="token plain">          = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$record</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">time</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token comment" style="color:rgb(98, 114, 164)"># Output in a clean table format</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"----------------------------------------"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">foreach</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$key</span><span class="token plain"> in </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$output</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Keys</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$key</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">PadRight</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function" style="color:rgb(80, 250, 123)">12</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">): </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$output</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$key</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$filteredRecords</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Count </span><span class="token operator">-gt</span><span class="token plain"> 0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"----------------------------------------"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Message wasn't in the expected format"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>You can find the Function App code in the following GitHub repository <a href="https://github.com/lukemurraynz/SFTPEventHubFunction" target="_blank" rel="noopener noreferrer">lukemurraynz/SFTPEventHubFunction</a> for this blog post.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-see-it-in-action">üîç See it in Action!<a href="https://luke.geek.nz/azure/sftp-event-hub-function/#-see-it-in-action" class="hash-link" aria-label="Direct link to üîç See it in Action!" title="Direct link to üîç See it in Action!">‚Äã</a></h2>
<p>So let us take a look at it in action!</p>
<p><img decoding="async" loading="lazy" alt="Azure SFTP Blob Write Run" src="https://luke.geek.nz/assets/images/SFTPEventHubFunctionRun-d4f4fc4c01b6f2f8f6a9fa6dbc4367c1.gif" width="1904" height="852" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-performance-considerations">‚è±Ô∏è Performance Considerations<a href="https://luke.geek.nz/azure/sftp-event-hub-function/#%EF%B8%8F-performance-considerations" class="hash-link" aria-label="Direct link to ‚è±Ô∏è Performance Considerations" title="Direct link to ‚è±Ô∏è Performance Considerations">‚Äã</a></h2>
<p><em>(On average, I have seen this take about 2 minutes, from the initial file upload, to the Function execution)</em>.</p>
<p><img decoding="async" loading="lazy" alt="SFTP Function execution" src="https://luke.geek.nz/assets/images/SFTPFuncExecuteTime-09cc1f865276c6fa785435c065263aa8.jpg" width="823" height="313" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-next-steps-and-extensions">üöÄ Next Steps and Extensions<a href="https://luke.geek.nz/azure/sftp-event-hub-function/#-next-steps-and-extensions" class="hash-link" aria-label="Direct link to üöÄ Next Steps and Extensions" title="Direct link to üöÄ Next Steps and Extensions">‚Äã</a></h2>
<p>Hopefully, that's given you the base to work from; you could potentially add logic around if a file from x user, do this, or notify the user of receipt based on a map lookup, etc.</p>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Sending Emails with MCP and Azure Communication Services]]></title>
            <link>https://luke.geek.nz/azure/mcp-acs-email-integration/</link>
            <guid>https://luke.geek.nz/azure/mcp-acs-email-integration/</guid>
            <pubDate>Mon, 07 Apr 2025 09:05:54 GMT</pubDate>
            <description><![CDATA[Learn how to use the Model Context Protocol (MCP) to connect GitHub Copilot to Azure Communication Services for sending emails directly from AI interactions.]]></description>
            <content:encoded><![CDATA[<p>You've probably heard the acronym 'MCP' before or <a href="https://modelcontextprotocol.io/" target="_blank" rel="noopener noreferrer">Model Context Protocol <em>(MCP)</em></a>. Open-sourced by Anthropic in November 2024, it has quickly become the go-to standard for connecting AI assistants to systems of various types.</p>
<blockquote>
<p>The Model Context Protocol is an open standard that enables developers to build secure, two-way connections between their data sources and AI-powered tools. The architecture is straightforward: Developers can expose their data through MCP servers or build AI applications (MCP clients) that connect to these servers.</p>
</blockquote>
<p>Today, we are going to use the MCP protocol to connect to <a href="https://learn.microsoft.com/azure/communication-services/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Communication Services</a> and send an email from an MCP client and server running on a GitHub Codespace from GitHub Copilot.</p>
<!-- -->
<p>The MCP protocol has two different transport layers:</p>
<ul>
<li>Stdio transport: This is the default transport layer. It uses standard input and output to communicate between the MCP client and server. This is useful for local development and testing.</li>
<li>HTTP transport: This transport layer uses HTTP to communicate between the MCP client and server. This is useful for production environments where the MCP client and server run on different machines.</li>
</ul>
<p>In our use case, we will use the Stdio transport layer because we are running the MCP client and server on the same machine (GitHub Codespace).</p>
<p>There are also different types of primitives that an MCP server can expose:</p>
<ul>
<li>Resources are a core primitive in the Model Context Protocol (MCP) that allows servers to expose data and content that clients can read and use as context for LLM interactions.</li>
<li>Prompts enable servers to define reusable prompt templates and workflows that clients can quickly surface to users and LLMs. They provide a powerful way to standardize and share common LLM interactions.</li>
<li>Tools are a powerful primitive in the Model Context Protocol (MCP) that enable servers to expose executable functionality to clients. Through tools, LLMs can interact with external systems, perform computations, and take actions in the real world.</li>
</ul>
<p><img decoding="async" loading="lazy" alt="Model Context Protocol (MCP) Explained" src="https://luke.geek.nz/assets/images/MCPClearlyExplained-63b1db26cb3ef86366c4b367fa411856.gif" width="1086" height="1280" class="img_ev3q">
<em>(Image credit: <a href="https://blog.dailydoseofds.com/p/visual-guide-to-model-context-protocol" target="_blank" rel="noopener noreferrer">blog.dailydoseofds.com</a>)</em></p>
<p>We will use the <code>Tool</code> primitive to expose a tool for sending emails using Azure Communication Services. The MCP server will expose the tool, which the MCP client will use to send the email when prompted in the GitHub Copilot chat.</p>
<p>The MCP server will run on a GitHub Codespace and send an email using Azure Communication Services. The MCP client will run on the same Codespace and send the email using GPT-4o.</p>
<p>Using Python, we will use the <a href="https://github.com/modelcontextprotocol/python-sdk" target="_blank" rel="noopener noreferrer">MCP Python SDK</a> to do a lot of the heavy lifting for us. The SDK is a wrapper around the MCP protocol and allows us to create an MCP server quickly, and thanks to a recent update by <a href="https://github.blog/news-insights/product-news/github-copilot-agent-mode-activated/#model-context-protocol-mcp-is-now-available-in-public-preview" target="_blank" rel="noopener noreferrer">GitHub Model Context Protocol (MCP) is now avaliable in Public preview in GitHub Copilot</a>, which allows us us to use the MCP protocol straight from GitHub Copilot chat without needing Claude Desktop for example, installed.</p>
<p>We are going to create three tools:</p>
<ol>
<li>send_email
Purpose: Send a simple email to a single recipient.
Parameters:</li>
</ol>
<ul>
<li>recipient: The email address of the recipient.</li>
<li>subject: The subject line of the email.</li>
<li>content: The HTML or plain text content of the email.
Usage: This tool is used for sending basic emails without attachments.</li>
</ul>
<ol start="2">
<li>send_email_with_attachments
Purpose: Send an email with file attachments to a single recipient.
Parameters:</li>
</ol>
<ul>
<li>recipient: The email address of the recipient.</li>
<li>subject: The subject line of the email.</li>
<li>content: The HTML or plain text content of the email.</li>
<li>attachments: A list of file paths to attach to the email.
Usage: This tool is used when you need to send documents, images, or other files along with the email.</li>
</ul>
<ol start="3">
<li>send_bulk_email
Purpose: Send the same email to multiple recipients in a single operation.
Parameters:</li>
</ol>
<ul>
<li>recipients: A list of email addresses to send the email to.</li>
<li>subject: The subject line of the email.</li>
<li>content: The HTML or plain text content of the email.
Usage: This tool is ideal for sending announcements, updates, or newsletters to a group of recipients.</li>
</ul>
<p>Each tool will be implemented as a function in Python, and we will use the MCP Python SDK to expose these functions as tools in the MCP server. The MCP client will then be able to call these tools to send emails using Azure Communication Services based on the prompts we provide in GitHub Copilot chat.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>You can find the ACS Email MCP server code on my GitHub repo here: <a href="https://github.com/lukemurraynz/mcp-server-acsemail" target="_blank" rel="noopener noreferrer">lukemurraynz/mcp-server-acsemail</a>. Feel free to clone it, run it, and open any Pull Requests if you find any issues or have suggestions for improvements.</p></div></div>
<p>Due to the Python dependencies, we will be using a devcontainer, using the <a href="https://hub.docker.com/r/microsoft/devcontainers-python" target="_blank" rel="noopener noreferrer">python:3.12-bullseye</a> image as our base image. This will allow us to use the latest version of Python, and the postCreateCommand we will install the python depedencies using pip.</p>
<div class="language-txt codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-txt codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">mcp</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">azure-communication-email</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">python-dotenv</span><br></span></code></pre></div></div>
<p>Assuming you have the Azure Communication Services Email resource created, and the connection string saved in a <code>.env</code> file in the root of your project. The connection string should look something like this:</p>
<div class="language-txt codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-txt codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Azure Communication Services credentials</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">ACS_CONNECTION_STRING=endpoint='https://azcommunicationservicestest.australia.communication.azure.com/;accesskey=FPipiKEH95KCHYQnJOxqMV0P7ZpP3qcKWZHaAhulbKCWI3fPyQZQJQQJ99BDACULyCphGPgtAAAAAZCS58g3'</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">ACS_SENDER_ADDRESS='DoNotReply@58b87ce7-7f73-444a-ba0b-d754677503cf.azurecomm.net'</span><br></span></code></pre></div></div>
<p>The <code>ACS_SENDER_ADDRESS</code> is the email address that will be used to send the email. This is the email address that will appear in the "From" field of the email.</p>
<p>The Python code for the MCP server is as follows:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># basic import </span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">from</span><span class="token plain"> mcp</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">server</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">fastmcp </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> FastMCP</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> logging</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">from</span><span class="token plain"> azure</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">communication</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">email </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> EmailClient</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> os</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">from</span><span class="token plain"> dotenv </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> load_dotenv</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">from</span><span class="token plain"> typing </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> Dict</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> Any</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> Optional</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Configure logging</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">logging</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">basicConfig</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    level</span><span class="token operator">=</span><span class="token plain">logging</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">INFO</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">format</span><span class="token operator">=</span><span class="token string" style="color:rgb(255, 121, 198)">'%(asctime)s - %(name)s - %(levelname)s - %(message)s'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">logger </span><span class="token operator">=</span><span class="token plain"> logging</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">getLogger</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"acs-email-sender"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Load environment variables</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">load_dotenv</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Azure Communication Services configuration</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">ACS_CONNECTION_STRING </span><span class="token operator">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">getenv</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"ACS_CONNECTION_STRING"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">ACS_SENDER_ADDRESS </span><span class="token operator">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">getenv</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"ACS_SENDER_ADDRESS"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Validation at startup</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">validate_config</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">bool</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">"""Validate the required configuration is present"""</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">not</span><span class="token plain"> ACS_CONNECTION_STRING </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">or</span><span class="token plain"> ACS_CONNECTION_STRING </span><span class="token operator">==</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"your_acs_connection_string_here"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        logger</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">error</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">f"ACS_CONNECTION_STRING is not configured properly"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token boolean">False</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">not</span><span class="token plain"> ACS_SENDER_ADDRESS </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">or</span><span class="token plain"> ACS_SENDER_ADDRESS </span><span class="token operator">==</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"DoNotReply@your-domain.azurecomm.net"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        logger</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">error</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">f"ACS_SENDER_ADDRESS is not configured properly"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token boolean">False</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    logger</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">f"Email configuration validated. Sender: </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string-interpolation interpolation">ACS_SENDER_ADDRESS</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token boolean">True</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Cache the email client to avoid recreating it for each request</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">_email_client</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Optional</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">EmailClient</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">get_email_client</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token plain"> Optional</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">EmailClient</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">"""Get or create an EmailClient instance"""</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">global</span><span class="token plain"> _email_client</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> _email_client </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">is</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">try</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            _email_client </span><span class="token operator">=</span><span class="token plain"> EmailClient</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">from_connection_string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ACS_CONNECTION_STRING</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            logger</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"Email Client initialized successfully"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">except</span><span class="token plain"> Exception </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">as</span><span class="token plain"> e</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            logger</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">error</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">f"Failed to initialize Email Client: </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string-interpolation interpolation builtin" style="color:rgb(189, 147, 249)">str</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string-interpolation interpolation">e</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> _email_client</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># instantiate an MCP server client</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">mcp </span><span class="token operator">=</span><span class="token plain"> FastMCP</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"Email Sender"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># DEFINE TOOLS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:rgb(248, 248, 242)">@mcp</span><span class="token decorator annotation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token decorator annotation punctuation" style="color:rgb(248, 248, 242)">tool</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">name</span><span class="token operator">=</span><span class="token string" style="color:rgb(255, 121, 198)">"send_email"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">send_email</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">recipient</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">str</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> subject</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">str</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> content</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">str</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">str</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">"""Send all emails using Azure Communication Services</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">    Args:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">        recipient: Email address of the recipient</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">        subject: Subject line of the email</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">        content: HTML content of the email</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">    Returns:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">        A message indicating the status of the email sending operation</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">    """</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    logger</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">f"Starting email sending process to: </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string-interpolation interpolation">recipient</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Validate configuration</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">not</span><span class="token plain"> validate_config</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Error: Email service is not configured properly. Check your .env file."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Get email client</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    email_client </span><span class="token operator">=</span><span class="token plain"> get_email_client</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">not</span><span class="token plain"> email_client</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Error: Unable to initialize email client"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">try</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Create the email message</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        logger</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">f"Creating email message with subject: </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string-interpolation interpolation">subject</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        message </span><span class="token operator">=</span><span class="token plain"> create_email_message</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">recipient</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> subject</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> content</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Send the email</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        logger</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">f"Beginning email send operation"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        poller </span><span class="token operator">=</span><span class="token plain"> email_client</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">begin_send</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">message</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        logger</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">f"Email send operation initiated, waiting for result"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        result </span><span class="token operator">=</span><span class="token plain"> poller</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">result</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> process_email_result</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">result</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> recipient</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">except</span><span class="token plain"> Exception </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">as</span><span class="token plain"> e</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        logger</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">error</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">f"Failed to send email: </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string-interpolation interpolation builtin" style="color:rgb(189, 147, 249)">str</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string-interpolation interpolation">e</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> exc_info</span><span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">f"Failed to send email: </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string-interpolation interpolation builtin" style="color:rgb(189, 147, 249)">str</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string-interpolation interpolation">e</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">create_email_message</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">recipient</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">str</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> subject</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">str</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> content</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">str</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token plain"> Dict</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token builtin" style="color:rgb(189, 147, 249)">str</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> Any</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">"""Create an email message for Azure Communication Services"""</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">"content"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token string" style="color:rgb(255, 121, 198)">"subject"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> subject</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token string" style="color:rgb(255, 121, 198)">"plainText"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> content</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token string" style="color:rgb(255, 121, 198)">"html"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> content</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">"recipients"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token string" style="color:rgb(255, 121, 198)">"to"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token string" style="color:rgb(255, 121, 198)">"address"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> recipient</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token string" style="color:rgb(255, 121, 198)">"displayName"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Email Recipient"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">"senderAddress"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ACS_SENDER_ADDRESS</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">process_email_result</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">result</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Any</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> recipient</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">str</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">str</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">"""Process the result from an email send operation"""</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">isinstance</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">result</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">dict</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">and</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'id'</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">in</span><span class="token plain"> result</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        message_id </span><span class="token operator">=</span><span class="token plain"> result</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'id'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'unknown'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        logger</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">f"Email sent successfully to </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string-interpolation interpolation">recipient</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">. Message ID: </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string-interpolation interpolation">message_id</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">f"Email sent to </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string-interpolation interpolation">recipient</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)"> successfully! Message ID: </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string-interpolation interpolation">message_id</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">elif</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">hasattr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">result</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'message_id'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        logger</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">f"Email sent successfully to </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string-interpolation interpolation">recipient</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">. Message ID: </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string-interpolation interpolation">result</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string-interpolation interpolation">message_id</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">f"Email sent to </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string-interpolation interpolation">recipient</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)"> successfully! Message ID: </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string-interpolation interpolation">result</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string-interpolation interpolation">message_id</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        logger</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">f"Email sent successfully to </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string-interpolation interpolation">recipient</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">."</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">f"Email sent to </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string-interpolation interpolation">recipient</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)"> successfully!"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:rgb(248, 248, 242)">@mcp</span><span class="token decorator annotation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token decorator annotation punctuation" style="color:rgb(248, 248, 242)">tool</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">name</span><span class="token operator">=</span><span class="token string" style="color:rgb(255, 121, 198)">"send_email_with_attachments"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">send_email_with_attachments</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">recipient</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">str</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> subject</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">str</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> content</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">str</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> attachments</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">list</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">str</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">"""Send email with file attachments using Azure Communication Services</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">    Args:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">        recipient: Email address of the recipient</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">        subject: Subject line of the email</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">        content: HTML content of the email</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">        attachments: List of file paths to attach</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">    Returns:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">        A message indicating the status of the email sending operation</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">    """</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    logger</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">f"Starting email sending process with attachments to: </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string-interpolation interpolation">recipient</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Validate configuration</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">not</span><span class="token plain"> validate_config</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Error: Email service is not configured properly. Check your .env file."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Get email client</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    email_client </span><span class="token operator">=</span><span class="token plain"> get_email_client</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">not</span><span class="token plain"> email_client</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Error: Unable to initialize email client"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">try</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Create the email message with attachments</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        logger</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">f"Creating email message with subject: </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string-interpolation interpolation">subject</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)"> and </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string-interpolation interpolation builtin" style="color:rgb(189, 147, 249)">len</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string-interpolation interpolation">attachments</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)"> attachments"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        message </span><span class="token operator">=</span><span class="token plain"> create_email_message_with_attachments</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">recipient</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> subject</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> content</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> attachments</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Send the email</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        logger</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">f"Beginning email send operation with attachments"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        poller </span><span class="token operator">=</span><span class="token plain"> email_client</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">begin_send</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">message</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        logger</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">f"Email send operation initiated, waiting for result"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        result </span><span class="token operator">=</span><span class="token plain"> poller</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">result</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> process_email_result</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">result</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> recipient</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">except</span><span class="token plain"> Exception </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">as</span><span class="token plain"> e</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        logger</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">error</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">f"Failed to send email with attachments: </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string-interpolation interpolation builtin" style="color:rgb(189, 147, 249)">str</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string-interpolation interpolation">e</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> exc_info</span><span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">f"Failed to send email with attachments: </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string-interpolation interpolation builtin" style="color:rgb(189, 147, 249)">str</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string-interpolation interpolation">e</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">create_email_message_with_attachments</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">recipient</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">str</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> subject</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">str</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> content</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">str</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> attachments</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">list</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token plain"> Dict</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token builtin" style="color:rgb(189, 147, 249)">str</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> Any</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">"""Create an email message with attachments for Azure Communication Services"""</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> base64</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    message </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">"content"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token string" style="color:rgb(255, 121, 198)">"subject"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> subject</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token string" style="color:rgb(255, 121, 198)">"plainText"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> content</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token string" style="color:rgb(255, 121, 198)">"html"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> content</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">"recipients"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token string" style="color:rgb(255, 121, 198)">"to"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token string" style="color:rgb(255, 121, 198)">"address"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> recipient</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token string" style="color:rgb(255, 121, 198)">"displayName"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Email Recipient"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">"senderAddress"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ACS_SENDER_ADDRESS</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">"attachments"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> file_path </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">in</span><span class="token plain"> attachments</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">try</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">with</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">open</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">file_path</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"rb"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">as</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">file</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                file_content </span><span class="token operator">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">file</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">read</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                filename </span><span class="token operator">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">path</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">basename</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">file_path</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token comment" style="color:rgb(98, 114, 164)"># Base64 encode the file content</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                encoded_content </span><span class="token operator">=</span><span class="token plain"> base64</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">b64encode</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">file_content</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">decode</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'utf-8'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token comment" style="color:rgb(98, 114, 164)"># Add attachment to message</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                message</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">"attachments"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">append</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token string" style="color:rgb(255, 121, 198)">"name"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> filename</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token string" style="color:rgb(255, 121, 198)">"contentType"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"application/octet-stream"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token string" style="color:rgb(255, 121, 198)">"contentInBase64"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> encoded_content</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                logger</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">f"Added attachment: </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string-interpolation interpolation">filename</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">except</span><span class="token plain"> Exception </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">as</span><span class="token plain"> e</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            logger</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">warning</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">f"Failed to add attachment </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string-interpolation interpolation">file_path</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">: </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string-interpolation interpolation builtin" style="color:rgb(189, 147, 249)">str</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string-interpolation interpolation">e</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> message</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:rgb(248, 248, 242)">@mcp</span><span class="token decorator annotation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token decorator annotation punctuation" style="color:rgb(248, 248, 242)">tool</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">name</span><span class="token operator">=</span><span class="token string" style="color:rgb(255, 121, 198)">"send_bulk_email"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">send_bulk_email</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">recipients</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">list</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> subject</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">str</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> content</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">str</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">str</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">"""Send email to multiple recipients using Azure Communication Services</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">    Args:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">        recipients: List of email addresses to send to</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">        subject: Subject line of the email</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">        content: HTML content of the email</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">    Returns:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">        A message indicating the status of the email sending operation</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">    """</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    logger</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">f"Starting bulk email sending process to </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string-interpolation interpolation builtin" style="color:rgb(189, 147, 249)">len</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string-interpolation interpolation">recipients</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)"> recipients"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Validate configuration</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">not</span><span class="token plain"> validate_config</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Error: Email service is not configured properly. Check your .env file."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Get email client</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    email_client </span><span class="token operator">=</span><span class="token plain"> get_email_client</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">not</span><span class="token plain"> email_client</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Error: Unable to initialize email client"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    success_count </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    failed_recipients </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">try</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Create the email message for multiple recipients</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        logger</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">f"Creating bulk email message with subject: </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string-interpolation interpolation">subject</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        message </span><span class="token operator">=</span><span class="token plain"> create_bulk_email_message</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">recipients</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> subject</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> content</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Send the email</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        logger</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">f"Beginning bulk email send operation"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        poller </span><span class="token operator">=</span><span class="token plain"> email_client</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">begin_send</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">message</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        logger</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">f"Bulk email send operation initiated, waiting for result"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        result </span><span class="token operator">=</span><span class="token plain"> poller</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">result</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        success_count </span><span class="token operator">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">len</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">recipients</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">f"Bulk email sent successfully to </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string-interpolation interpolation">success_count</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)"> recipients!"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">except</span><span class="token plain"> Exception </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">as</span><span class="token plain"> e</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        logger</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">error</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">f"Failed to send bulk email: </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string-interpolation interpolation builtin" style="color:rgb(189, 147, 249)">str</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string-interpolation interpolation">e</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> exc_info</span><span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">f"Failed to send bulk email: </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string-interpolation interpolation builtin" style="color:rgb(189, 147, 249)">str</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string-interpolation interpolation">e</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">create_bulk_email_message</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">recipients</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">list</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> subject</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">str</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> content</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">str</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token plain"> Dict</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token builtin" style="color:rgb(189, 147, 249)">str</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> Any</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">"""Create an email message for multiple recipients using Azure Communication Services"""</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    to_list </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> recipient </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">in</span><span class="token plain"> recipients</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        to_list</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">append</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token string" style="color:rgb(255, 121, 198)">"address"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> recipient</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token string" style="color:rgb(255, 121, 198)">"displayName"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Email Recipient"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">"content"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token string" style="color:rgb(255, 121, 198)">"subject"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> subject</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token string" style="color:rgb(255, 121, 198)">"plainText"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> content</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token string" style="color:rgb(255, 121, 198)">"html"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> content</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">"recipients"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token string" style="color:rgb(255, 121, 198)">"to"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> to_list</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">"senderAddress"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ACS_SENDER_ADDRESS</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># execute and return the stdio output</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> __name__ </span><span class="token operator">==</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"__main__"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Validate configuration at startup</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">not</span><span class="token plain"> validate_config</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        logger</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">warning</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"Starting with invalid configuration - email sending will fail"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    logger</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"Starting MCP server for ACS Email Sender"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    mcp</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">run</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">transport</span><span class="token operator">=</span><span class="token string" style="color:rgb(255, 121, 198)">"stdio"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre></div></div>
<p>To allow GitHub Copilot to recognize and run the server, a <code>.vscode/mcp.json</code> file is created to run the server.</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"servers"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"email"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">"command"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"python"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">"args"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token string" style="color:rgb(255, 121, 198)">"/workspaces/mcp-server-acsemail/src/server.py"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre></div></div>
<p>So lets test this, first we will test an email of the selection using the <code>send_email</code> tool.</p>
<p><img decoding="async" loading="lazy" alt="MCP Email Test" src="https://luke.geek.nz/assets/images/MCP-ACS_SendEmail-43c64eefc04099c4be7fe45bdf6c8588.gif" width="1909" height="903" class="img_ev3q"></p>
<p>Next, let's test the same, but to multiple recipients using the <code>send_bulk_email</code> tool.</p>
<p><img decoding="async" loading="lazy" alt="MCP Email Test" src="https://luke.geek.nz/assets/images/MCP-ACS_BulkSendEmail-144fda6dcbdcdaf44222512b6e67fdaf.gif" width="1909" height="903" class="img_ev3q"></p>
<p>Last, let's try sending the README.md as an attachment using the <code>send_email_with_attachments</code> tool.</p>
<p><img decoding="async" loading="lazy" alt="MCP Email Test" src="https://luke.geek.nz/assets/images/MCP-ACS_SendEmailWithAttachment-87bf8e137fafe90431e713e6e23e0cc5.gif" width="1909" height="903" class="img_ev3q"></p>
<p>Hopefully, that gives you a glimpse of how to use the MCP protocol to connect to <a href="https://learn.microsoft.com/azure/communication-services/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Communication Services</a> and send emails using GitHub Copilot chat. The MCP protocol is a powerful tool that allows you to connect AI assistants to systems of various types, and with the recent updates to GitHub Copilot, it is now easier than ever to use! This was just my first test usecase, can't wait to see what else we can do with it!</p>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Understanding Workload Criticality in the Cloud]]></title>
            <link>https://luke.geek.nz/azure/business-critical-workloads/</link>
            <guid>https://luke.geek.nz/azure/business-critical-workloads/</guid>
            <pubDate>Sat, 05 Apr 2025 05:41:20 GMT</pubDate>
            <description><![CDATA[Learn to assess workload criticality in Azure, understand SLAs, and make informed decisions based on business impact and risks.]]></description>
            <content:encoded><![CDATA[<p>Today, we are going to take a look at something a little different. We are going to talk about workload criticality, methods to assess how critical your workload is, and the ramifications of that criticality in terms of the Cloud.</p>
<p><img decoding="async" loading="lazy" alt="Workload Criticality" src="https://luke.geek.nz/assets/images/workload-criticality-57088a9821a86fd1b9dac85df45854e1.jpg" width="1280" height="269" class="img_ev3q"></p>
<!-- -->
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-defining-a-workload">üì¶ Defining a Workload<a href="https://luke.geek.nz/azure/business-critical-workloads/#-defining-a-workload" class="hash-link" aria-label="Direct link to üì¶ Defining a Workload" title="Direct link to üì¶ Defining a Workload">‚Äã</a></h2>
<p>First, let's define Workload.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>A workload is a collection of resources and code ‚Äì Services/VMs, applications, data, or appliances ‚Äì that delivers business value, such as a customer-facing application.</p></div></div>
<p><img decoding="async" loading="lazy" alt="Workload" src="https://luke.geek.nz/assets/images/workload-definition-b360958c5268542e0a72b673ea562093.jpg" width="1280" height="720" class="img_ev3q"></p>
<p>All these resources in the Microsoft Azure Cloud can be designed to work together to deliver a service or application. The resources can be anything from a simple web app to a complex multi-tier application with multiple services and databases.</p>
<p>In the Microsoft Azure Cloud, these resources can be deployed in different regions, availability zones, and resource groups. This allows for high availability and disaster recovery options to be built into the application architecture.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-shared-responsibility-in-the-cloud">ü§ù Shared Responsibility in the Cloud<a href="https://luke.geek.nz/azure/business-critical-workloads/#-shared-responsibility-in-the-cloud" class="hash-link" aria-label="Direct link to ü§ù Shared Responsibility in the Cloud" title="Direct link to ü§ù Shared Responsibility in the Cloud">‚Äã</a></h2>
<p>Let us delve into the <a href="https://learn.microsoft.com/azure/well-architected/reliability/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Reliability</a> and Availability of these workloads by looking at the <a href="https://learn.microsoft.com/azure/reliability/concept-shared-responsibility?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Shared responsibility model</a>.</p>
<p>There is some overlap in the responsibility of your workloads in the Cloud, and this is where the criticality of your workload comes into play. The more critical the workload, the more responsibility you have regarding availability and reliability, and the more you need to consider the implications of that criticality in your architecture and design. Before I jump ahead, let's assume Microsoft's responsibility as the customer and us as the cloud provider.</p>
<p><img decoding="async" loading="lazy" alt="Shared responsibility model" src="https://luke.geek.nz/assets/images/shared-responsibility-model-735216dd0ee7a96792dd46deb54c9180.jpg" width="1877" height="1270" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Microsoft is solely responsible for <a href="https://learn.microsoft.com/en-us/azure/reliability/concept-shared-responsibility?WT.mc_id=AZ-MVP-5004796#core-platform-reliability" target="_blank" rel="noopener noreferrer">core platform reliability</a>. Microsoft is also responsible for providing <a href="https://learn.microsoft.com/en-us/azure/reliability/concept-shared-responsibility?WT.mc_id=AZ-MVP-5004796#resilience-enhancing-capabilities" target="_blank" rel="noopener noreferrer">resilience-enhancing capabilities</a> that you can use. You're responsible for selecting and using the appropriate components.</p></div></div>
<p>The configuration of each of the resources that make up your workload determines how reliable and available it is. The more critical the workload, the more you need to consider its implications for your architecture and design.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-service-level-agreements-slas">üìù Service Level Agreements (SLAs)<a href="https://luke.geek.nz/azure/business-critical-workloads/#-service-level-agreements-slas" class="hash-link" aria-label="Direct link to üìù Service Level Agreements (SLAs)" title="Direct link to üìù Service Level Agreements (SLAs)">‚Äã</a></h2>
<blockquote>
<p>Understanding the service level agreements (SLAs) for each Azure service is important. SLAs provide essential information on the expected uptime of the service and any conditions you need to meet to be eligible for the SLA. For SLAs for each service, see <a href="https://www.microsoft.com/licensing/docs/view/Service-Level-Agreements-SLA-for-Online-Services" target="_blank" rel="noopener noreferrer">Service Level Agreements (SLA) for Online Services</a>.</p>
</blockquote>
<p>So, let's delve a little deeper into SLAs and how they relate to the criticality of your workload.</p>
<p>An SLA <em>(Service Level Agreement)</em> is a contract between you and the service provider that defines the level of service you can expect from the provider. It typically includes information on the availability of the service, the response time for support requests, and any penalties for not meeting the SLA. In the context of Azure resources, an SLA guarantees that the service will be available for a certain percentage of time over a given period. For example, an SLA of 99.9% means that the service is guaranteed to be available for 99.9% over a given period.</p>
<p><img decoding="async" loading="lazy" alt="Workload SLA" src="https://luke.geek.nz/assets/images/workload-sla-b375085133597c482cfa69968b58f837.JPG" width="1280" height="720" class="img_ev3q"></p>
<p>This means that the service can be down for a maximum of 43.2 minutes per month, or 8.76 hours per year. If the service is down for longer than this, you may be eligible for a credit on your bill.</p>
<p>There are some considerations however, and these are outlined in the SLA for each service. For example, if you are using a service that the SLA does not cover, or if you are not meeting the conditions of the SLA, you may not be eligible for a credit, and by meeting conditions, I mean the configuration of the resources that make up your workload - for example, if you are using a single instance of a service, and not Zone redundant, you may not be eligable for a credit, as the SLA may not match. There is a difference between an outage of one availability zone vs an entire region. Virtual Machines come to mind where the Disk type selected can impact the SLA of your resource.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-slo-and-sli-beyond-slas">üéØ SLO and SLI: Beyond SLAs<a href="https://luke.geek.nz/azure/business-critical-workloads/#-slo-and-sli-beyond-slas" class="hash-link" aria-label="Direct link to üéØ SLO and SLI: Beyond SLAs" title="Direct link to üéØ SLO and SLI: Beyond SLAs">‚Äã</a></h2>
<p>We won't go into detail about SLO (Service Level Objective) or SLI (Service Level Indicator) in this post, but they are important to understand when assessing the SLA of your workload.</p>
<p>An SLO is a target for the level of service you want to achieve, and an SLI measures the level of service you are achieving. The SLO and SLI can be used to measure the performance of your workload and help you identify areas for improvement, for Microsoft Azure cloud services, the SLO and SLIs are managed within Microsoft, however if you are looking at offering SLAs to your customers based on the services you are using, you will need to consider the SLO and SLI of the services you are using. How they relate to the SLA of your workload, the same is true in the context of OLAs <em>(Organisation Level Agreements)</em>.</p>
<p><img decoding="async" loading="lazy" alt="Workload SLO" src="https://luke.geek.nz/assets/images/workload-slaslo-bec35d48417f8c7a73760815ed3e0785.JPG" width="1280" height="720" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-composite-slas">üß© Composite SLAs<a href="https://luke.geek.nz/azure/business-critical-workloads/#-composite-slas" class="hash-link" aria-label="Direct link to üß© Composite SLAs" title="Direct link to üß© Composite SLAs">‚Äã</a></h2>
<p>What we will touch on is <a href="https://learn.microsoft.com/en-us/azure/well-architected/reliability/metrics?WT.mc_id=AZ-MVP-5004796#define-composite-slo-targets" target="_blank" rel="noopener noreferrer">Composite SLAs</a>, which are a combination of the SLAs of the individual resources that make up your workload. For example, if you have a web app that is using an SQL database, the SLA for the web app and the SLA for the SQL database will determine the overall SLA for your workload. The composite SLA is calculated by multiplying the individual SLAs together. For example, if the web app has an SLA of 99.95% and the SQL database has an SLA of 99.99%, the composite SLA for the workload would be 99.94% <em>(Maximum acceptable downtime /Year: 315m 33s)</em>.
That's lower than the individual SLAs, which isn't surprising because an application that relies on multiple services has more potential failure points.</p>
<p>A few resources that are useful for working out Composite SLA's are:</p>
<ul>
<li><a href="https://slaestimator.aztoso.com/" target="_blank" rel="noopener noreferrer">Azure Composite SLA Estimator</a></li>
<li><a href="https://wiki.unosd.com/slacalculator/" target="_blank" rel="noopener noreferrer">SLA Calculator</a></li>
</ul>
<p><img decoding="async" loading="lazy" alt="CLSA" src="https://luke.geek.nz/assets/images/csla-36b258dbf3e63c0e2c0aa510df38d5d3.jpg" width="3466" height="1621" class="img_ev3q"></p>
<p>For more Active/Active workloads, you can have a parallel SLA <em>(Parallel SLA = 100% - (ServiceA unavailability * ServiceB unavailability))</em>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-regions-and-availability-zones">üåê Regions and Availability Zones<a href="https://luke.geek.nz/azure/business-critical-workloads/#-regions-and-availability-zones" class="hash-link" aria-label="Direct link to üåê Regions and Availability Zones" title="Direct link to üåê Regions and Availability Zones">‚Äã</a></h2>
<p>I've alluded to it but not touched on it - let us discuss <a href="https://learn.microsoft.com/azure/reliability/regions-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Regions</a> and <a href="https://learn.microsoft.com/azure/reliability/availability-zones-overview?tabs=azure-cli&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Avaliability Zones</a>, which are key considerations when looking at how your Azure Cloud workloads are architected.</p>
<p><img decoding="async" loading="lazy" alt="Azure Region" src="https://luke.geek.nz/assets/images/workload-azregion-2c82ad4c18b843ce6e6220bf0077f923.JPG" width="1280" height="720" class="img_ev3q"></p>
<p>An Azure Region - such as <a href="https://datacenters.microsoft.com/globe/explore?info=region_newzealandnorth" target="_blank" rel="noopener noreferrer">New Zealand North</a> - is a set of datacenters <em>(3 or more)</em> deployed within a latency-defined perimeter and connected through a low-latency network, datacenters is a term I try to avoid when talking about the Microsoft Azure Cloud, as it is a little misleading, as the datacenters are not just a single building, but a collection of buildings and resources that make up the region, each called an Avaliability Zone, and each one designed to run independently of the others. This means that if one zone goes down, the other zones are still available, and your workload can continue to run. This is a key consideration when looking at the criticality of your workload, as it allows for a level of high availability and disaster recovery options to be built into the application architecture <em>(think Tier 4, from a datacenter tier/classification perspective)</em>.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>There isn't a 1:1 mapping of physical and logical <em>(ie, what you see in the Portal)</em> mapping to your availability zones; the mapping is generated at the time that the subscription gets created, so Availability Zone 1 in one subscription may not be Availability Zone 1 in another. Refer to a previous article of mine for more information: <a href="https://luke.geek.nz/azure/azure-availability-zone-peering/" target="_blank" rel="noopener noreferrer">Azure Availability Zone Peering</a>.</p></div></div>
<p>Whether you use Availability Zones or cross-regions can depend a lot on the criticality of your workload and the SLA of your workload with your customers. A lot of redundancy is built into multiple layers, from the selection of the location for the data centers to be built through the hardware in the racks to the Azure fabric itself. However, issues do happen, and you need to consider your risk profile.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>I suggest reading the Azure architecture center <a href="https://learn.microsoft.com/azure/architecture/patterns/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Cloud design patterns</a> for recommendations on how to design your workloads, with patterns like retry, sharding, and bulkhead. I also touched on some design patterns in a previous article <a href="https://luke.geek.nz/azure/cloud-design-patterns/" target="_blank" rel="noopener noreferrer">Cloud Design Patterns</a> and video <a href="https://youtu.be/nnuo_mxPcNw" target="_blank" rel="noopener noreferrer">Cloud Design Patterns</a>.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-risk-assessment">‚ö†Ô∏è Risk Assessment<a href="https://luke.geek.nz/azure/business-critical-workloads/#%EF%B8%8F-risk-assessment" class="hash-link" aria-label="Direct link to ‚ö†Ô∏è Risk Assessment" title="Direct link to ‚ö†Ô∏è Risk Assessment">‚Äã</a></h2>
<p><img decoding="async" loading="lazy" alt="Workload Disaster Scope" src="https://luke.geek.nz/assets/images/workload-disasterscope-a6d04896abff549670589e3b29a21671.JPG" width="1280" height="720" class="img_ev3q"></p>
<p>When considering the business criticality and plans, you need to consider the likelihood of an outage, and the impact and risk of that outage <em>(RISK = IMPACT x	PROBABILITY)</em>:</p>
<table><thead><tr><th>Risk</th><th>Example</th><th>Likelihood</th></tr></thead><tbody><tr><td><strong>Hardware outage</strong></td><td>Host reboot, node failure</td><td>üü†üü†üü†üü†üü† Very likely</td></tr><tr><td><strong>Datacentre outage</strong></td><td>Power, cooling or network failure</td><td>üü†üü† Unlikely</td></tr><tr><td><strong>Region outage</strong></td><td>Major natural disaster affecting wide area</td><td>üü† Very unlikely</td></tr></tbody></table>
<p>And then, compare those risks to the design and SLA of your workload in accordance with the <a href="https://learn.microsoft.com/azure/well-architected/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Well-Architected Framework</a> pillars for guidance, as there are tradeoffs between the pillars and the criticality of your workload:</p>
<table><thead><tr><th></th><th>Locally redundant</th><th>Zonal (pinned)</th><th>Zone-redundant</th><th>Multi-region</th></tr></thead><tbody><tr><td><strong>Reliability</strong></td><td>üî¥ Low</td><td>üîµ Depends</td><td>üü¢ High</td><td>üü¢ High</td></tr><tr><td><strong>Cost Optimization</strong></td><td>üü¢ Low</td><td>üîµ Depends</td><td>üü° Moderate</td><td>üî¥ High</td></tr><tr><td><strong>Performance Efficiency</strong> (for most workloads)</td><td>üü¢ Acceptable</td><td>üü¢ Good</td><td>üü¢ Acceptable</td><td>üîµ Depends</td></tr><tr><td><strong>Operational Excellence</strong></td><td>üü¢ Easy</td><td>üî¥ Complex</td><td>üü¢ Easy</td><td>üî¥ Complex</td></tr><tr><td><strong>Data Residency</strong></td><td>üü¢ Strong</td><td>üü¢ Strong</td><td>üü¢ Strong</td><td>üîµ Depends</td></tr></tbody></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-how-to-determine-workload-criticality">‚ùì How to Determine Workload Criticality<a href="https://luke.geek.nz/azure/business-critical-workloads/#-how-to-determine-workload-criticality" class="hash-link" aria-label="Direct link to ‚ùì How to Determine Workload Criticality" title="Direct link to ‚ùì How to Determine Workload Criticality">‚Äã</a></h2>
<p>So, we've discussed SLA, some of the technical considerations for your workloads - lets take a look at how do you know - that your workload is critical?</p>
<p>This is always a hard question to answer, and it is up to the business to determine‚Äîit's a risk/benefit analysis. For example, in Health, is there a Clinical Risk to patients? In finance, is there a financial risk to the business? In retail, is there a reputational risk to the business? The criticality of your workload can be determined by looking at the impact of an outage on the business and the cost of that outage.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-criticality-classification-framework">üèÜ Criticality Classification Framework<a href="https://luke.geek.nz/azure/business-critical-workloads/#-criticality-classification-framework" class="hash-link" aria-label="Direct link to üèÜ Criticality Classification Framework" title="Direct link to üèÜ Criticality Classification Framework">‚Äã</a></h2>
<p>However, for those starting out or don't know where to start with classifying your workload criticality, we can use the <a href="https://learn.microsoft.com/azure/cloud-adoption-framework/manage/protect?WT.mc_id=AZ-MVP-5004796#manage-reliability" target="_blank" rel="noopener noreferrer">Cloud Adoption Framework workload priority</a> as a base.</p>
<blockquote>
<p>Enterprise organizations typically have an extensive application portfolio, but not all applications are of equal importance. Applications can be classified based on a criticality scale. For example, business-critical applications are designed to prevent financial losses, and safety-critical applications are focused on costs associated with the loss of human life. Mission-critical applications cover both aspects that can be impacted by unavailability or underperformance. Criticality should be identified and classified to direct investment of business continuity, monitoring, support, and other resources appropriately. It should be noted that certain business functions within applications may also be more critical than others.</p>
</blockquote>
<table><thead><tr><th><strong>Tier</strong></th><th><strong>Criticality</strong></th><th><strong>Business View</strong></th><th><strong>Financial</strong></th><th><strong>Brand Reputation</strong></th><th><strong>Customer Trust</strong></th><th><strong>Customer Experience</strong></th><th><strong>Injury / Loss of Life</strong></th><th><strong>Employee Productivity</strong></th></tr></thead><tbody><tr><td><strong>Tier 1</strong></td><td>Mission Critical</td><td>Affects the company's mission and might noticeably affect corporate profit-and-loss statements.</td><td>n/a</td><td>Yes</td><td>Yes</td><td>Yes</td><td>No</td><td>Yes</td></tr><tr><td><strong>Tier 1</strong></td><td>Business Critical</td><td>Can lead to financial losses for the organization.</td><td>&gt; $250k</td><td>Yes</td><td>Yes</td><td>Yes</td><td>No</td><td>Yes</td></tr><tr><td><strong>Tier 1</strong></td><td>Compliance Critical</td><td>In heavily regulated industries, some applications might be critical as part of an effort to maintain compliance requirements.</td><td>n/a</td><td>Yes</td><td>Yes</td><td>Yes</td><td>No</td><td>Yes</td></tr><tr><td><strong>Tier 1</strong></td><td>Safety Critical</td><td>When the lives or physical safety of employees and customers is at risk during an outage, it can be wise to classify applications as safety-critical.</td><td>n/a</td><td>Yes</td><td>Yes</td><td>Yes</td><td>Yes</td><td>Yes</td></tr><tr><td><strong>Tier 1</strong></td><td>Security Critical</td><td>Some applications might not be mission critical, but outages could result in loss of data or unintended access to protected information.</td><td>n/a</td><td>Yes</td><td>Yes</td><td>Yes</td><td>No</td><td>Yes</td></tr><tr><td><strong>Tier 1</strong></td><td>Unit Critical</td><td>Affects the mission of a specific business unit and its profit-and-loss statements.</td><td>&gt; $250k</td><td>Yes</td><td>Yes</td><td>Yes</td><td>No</td><td>Yes</td></tr><tr><td><strong>Tier 2</strong></td><td>High</td><td>Might not hinder the mission, but affects high-importance processes. Measurable losses can be quantified in the case of outages.</td><td>&lt; $250k</td><td>Yes</td><td>Yes</td><td>Yes</td><td>No</td><td>Yes</td></tr><tr><td><strong>Tier 3</strong></td><td>Medium</td><td>Impact on processes is likely. Losses are low or immeasurable, but brand damage or upstream losses are likely.</td><td>&lt; $100k</td><td>No</td><td>Yes</td><td>Yes</td><td>No</td><td>Yes</td></tr><tr><td><strong>Tier 4</strong></td><td>Low</td><td>Impact on business processes isn't measurable. Neither brand damage nor upstream losses are likely. A localized impact on a single team is likely.</td><td>&lt; $50k</td><td>No</td><td>Yes</td><td>Yes</td><td>No</td><td>Yes</td></tr><tr><td><strong>Tier 5</strong></td><td>Unsupported</td><td>No business owner, team, or process that's associated with this application can justify any investment in the ongoing management of the application.</td><td>$0</td><td>No</td><td>No</td><td>No</td><td>No</td><td>No</td></tr></tbody></table>
<p>The most successfully organisations I have seen implement criticality assessments, have a clear understanding of the business impact of an outage - they also have a review process that takes into effect an unbiased view of the workload, and the impact of the workload on the business, and not just the technical impact of the workload.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>Ideally, the criticality of your workload should be assessed at the time of the design of the workload and not AFTER the system is in production or in use. The criticality SHOULD determine how the workload is designed and built, and not the other way around. However, in my career, I have found that this is not always the case. The criticality of the workload is assessed after the fact, and this can lead to issues down the line, as the workload may not be designed to be critical (or not), and this can lead to issues with availability and reliability and cost expenditure on the wrong workloads.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-key-criticality-assessment-considerations">üìã Key Criticality Assessment Considerations<a href="https://luke.geek.nz/azure/business-critical-workloads/#-key-criticality-assessment-considerations" class="hash-link" aria-label="Direct link to üìã Key Criticality Assessment Considerations" title="Direct link to üìã Key Criticality Assessment Considerations">‚Äã</a></h2>
<p>Areas to consider when looking at the criticality of your workload:</p>
<ul>
<li>Reputational damage</li>
<li>Industry regulations</li>
<li>Legal and compliance</li>
<li>Security</li>
<li>Customer satisfaction</li>
<li>Financial</li>
<li>Loss of life or injury.</li>
<li>Employee morale</li>
<li>Perceived outage acceptance <em>(ie, how long is acceptable for the workload to be down, are there any workarounds or manual processes)</em></li>
<li>Support hours and costs <em>(ie if the system is only a 9-5 system, then the support costs may be lower than a 24/7 system, and as such its a lower criticality if it goes down over the weekend)</em></li>
</ul>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>For more questions and considerations for architecting solutions on Azure‚Äîincluding business context questions that can help you with criticality‚Äîconsider the Solution Requirement Consideration Checklist I made a few years ago! It's open for Pull Requests, and you can read more here: <a href="https://luke.geek.nz/azure/azure-architecture-solution-requirement-consideration-checklist/" target="_blank" rel="noopener noreferrer">Azure Architecture - Solution Requirement Consideration Checklist</a>.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-conclusion">üí° Conclusion<a href="https://luke.geek.nz/azure/business-critical-workloads/#-conclusion" class="hash-link" aria-label="Direct link to üí° Conclusion" title="Direct link to üí° Conclusion">‚Äã</a></h2>
<p>Hopefully, that has given you a glimpse into the world of workload criticality and how it can impact your workloads in the Microsoft Azure Cloud. There is a lot to consider when looking at the criticality of your workload, and it is important to understand the implications of that criticality in terms of your architecture and design. The more critical the workload, the more you need to consider the implications of that criticality in terms of your architecture and design, cost, and complexity.</p>
<p><strong>The question I leave you is: Do you really need that second region?</strong></p>]]></content:encoded>
            <category>Azure</category>
            <category>Service Management</category>
            <category>Misc</category>
        </item>
        <item>
            <title><![CDATA[How to Use GitHub Codespaces with Azure DevOps Repositories]]></title>
            <link>https://luke.geek.nz/azure/github-codespaces-azure-devops-repo/</link>
            <guid>https://luke.geek.nz/azure/github-codespaces-azure-devops-repo/</guid>
            <pubDate>Fri, 07 Mar 2025 07:40:37 GMT</pubDate>
            <description><![CDATA[Learn how to connect GitHub Codespaces to external repositories in Azure DevOps using the external-repository feature and devcontainer configuration.]]></description>
            <content:encoded><![CDATA[<p>I've talked about <a href="https://luke.geek.nz/azure/Getting-Started-with-GitHub-Codespaces/" target="_blank" rel="noopener noreferrer">GitHub Codespaces</a> before, but what I haven't covered - is using a GitHub Codespace to connect to a repository in Azure DevOps. It's classed as 'Remote Repository' in the Codespace, however, it's something that can be done.</p>
<!-- -->
<p>To start with, we have a repository in Azure DevOps, and we want to connect to it using a GitHub Codespace. I've created a repository in Azure DevOps called 'CodespaceADORepo' for demo purposes. This repo contains two files <em>(README.md and a main.bicep file)</em> although it doesn't matter what the repository has.</p>
<p><img decoding="async" loading="lazy" alt="Azure DevOps Repo" src="https://luke.geek.nz/assets/images/Codespace_ADORepo-a6137611dadc807bc481d35da759b8a3.jpg" width="684" height="200" class="img_ev3q"></p>
<p>To make this work, we need to add the following feature to our Codespace: <a href="https://github.com/microsoft/codespace-features/pkgs/container/codespace-features%2Fexternal-repository" target="_blank" rel="noopener noreferrer">codespace-features/external-repository</a>. This feature allows you to connect to a repository that is not hosted in GitHub.</p>
<p>To add this feature, you need to create a <code>.devcontainer</code> folder in the root of your repository. Inside this folder, you need to create a <code>devcontainer.json</code> file. This file is used to configure the Codespace, and in this case, we are adding the feature to connect to an external repository.</p>
<p>First we need to grab the clone URL.</p>
<p><img decoding="async" loading="lazy" alt="Azure DevOps Clone URL" src="https://luke.geek.nz/assets/images/Codespace_ADO_CloneURL-728c52e00b2a75de71e2536963785a5a.gif" width="1642" height="903" class="img_ev3q"></p>
<p>Then we need to add the URL to the devcontainer.json</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token property">"features"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		</span><span class="token property">"ghcr.io/microsoft/codespace-features/external-repository:latest"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			</span><span class="token property">"cloneUrl"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"https://luke0153@dev.azure.com/luke0153/CodespaceDemo/_git/CodespaceADORepo"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			</span><span class="token property">"folder"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"/workspaces/ado-repos"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>You can add a PAT token to authenticate by adding: "cloneSecret": "ADO_PAT", to the feature settings, but storing your PAT token in plain text in a repo is not recommended.</p></div></div>
<p>And then add in:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token property">"initializeCommand"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"mkdir -p ${localWorkspaceFolder}/../ado-repos"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"postStartCommand"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"external-git clone"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"postAttachCommand"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"external-git config"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="Azure DevOps Clone URL" src="https://luke.geek.nz/assets/images/Codespace_ADO_AddExternalGitClone-5c4199f03786e618253d160fa94af7de.gif" width="1642" height="903" class="img_ev3q"></p>
<p>Once done, it's time to run your Codespace, as normal. It will ignore the GitHub repo that you are running it in, then clone the ADO repo, once authenticated - in this case, because I haven't specified a PAT token, it will prompt for user authentication, then mount the repo.</p>
<p><img decoding="async" loading="lazy" alt="Azure DevOps Clone URL" src="https://luke.geek.nz/assets/images/Codespace_ADO_RunExternalGit-5f48a10311c2859a654ae2cad1273b85.gif" width="1892" height="903" class="img_ev3q"></p>
<p>And the original git repo is ignored.</p>
<p>For full reference to the devcontainer.json I am using:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token property">"name"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Default Linux Universal"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token property">"image"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"mcr.microsoft.com/devcontainers/universal:2-linux"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token property">"features"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		</span><span class="token property">"ghcr.io/microsoft/codespace-features/external-repository:latest"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			</span><span class="token property">"cloneUrl"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"https://contoso@dev.azure.com/contosoOORG/CodespaceDemo/_git/CodespaceADORepo"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			</span><span class="token property">"folder"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"/workspaces/ado-repos"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		  </span><span class="token property">"ghcr.io/prulloac/devcontainer-features/pre-commit:1.0.3"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain">	</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token property">"workspaceFolder"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"/workspaces/ado-repos"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token property">"initializeCommand"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"mkdir -p ${localWorkspaceFolder}/../ado-repos"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"postStartCommand"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"external-git clone"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"postAttachCommand"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"external-git config"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token property">"customizations"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		</span><span class="token property">"vscode"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			</span><span class="token property">"extensions"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">				</span><span class="token string" style="color:rgb(255, 121, 198)">"GitHub.copilot"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">				</span><span class="token string" style="color:rgb(255, 121, 198)">"GitHub.copilot-chat"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre></div></div>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Deploying Azure Landing Zones with the Terraform Accelerator]]></title>
            <link>https://luke.geek.nz/azure/azure-landing-zone-accelerator/</link>
            <guid>https://luke.geek.nz/azure/azure-landing-zone-accelerator/</guid>
            <pubDate>Sat, 01 Mar 2025 07:41:23 GMT</pubDate>
            <description><![CDATA[Learn how to deploy Azure Platform Landing Zones using the Terraform Accelerator and Azure DevOps.]]></description>
            <content:encoded><![CDATA[<p>As part of the <a href="https://www.azurespringclean.com/" target="_blank" rel="noopener noreferrer">Azure Spring Clean 2025</a> event for 2025, we are here to take a look at <a href="https://learn.microsoft.com/azure/cloud-adoption-framework/ready/landing-zone/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Landing Zones</a>, specifically <a href="https://learn.microsoft.com/azure/cloud-adoption-framework/ready/landing-zone/?WT.mc_id=AZ-MVP-5004796#platform-landing-zones-vs-application-landing-zones" target="_blank" rel="noopener noreferrer">Platform Landing Zones</a>, and the deployment of the Platform Landing Zone, using an <a href="https://azure.github.io/Azure-Landing-Zones/accelerator/" target="_blank" rel="noopener noreferrer">accelerator</a> and Azure DevOps for the CI/CD.</p>
<p><a href="https://www.azurespringclean.com/" target="_blank" rel="noopener noreferrer"><img decoding="async" loading="lazy" alt="Azure Spring Clean 2025" src="https://luke.geek.nz/assets/images/AzureSpringClean25_Logo-a92ac1a62ff65fcddaaf2a0ef4c39dc9.png" width="2500" height="1400" class="img_ev3q"></a></p>
<!-- -->
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-introduction-to-azure-landing-zones">üèóÔ∏è Introduction to Azure Landing Zones<a href="https://luke.geek.nz/azure/azure-landing-zone-accelerator/#%EF%B8%8F-introduction-to-azure-landing-zones" class="hash-link" aria-label="Direct link to üèóÔ∏è Introduction to Azure Landing Zones" title="Direct link to üèóÔ∏è Introduction to Azure Landing Zones">‚Äã</a></h2>
<p><a href="https://learn.microsoft.com/azure/cloud-adoption-framework/ready/landing-zone/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Landing Zones</a> provide a structured approach for designing and implementing cloud environments in Azure. They are essential for organizations looking to migrate, modernize, and innovate their applications at scale, mainly because of the considerations you make in designing and implementing them, considerations such as how your workloads are going to connect to the internet, how each service connects, and importantly, how your organisation will use Cloud - I saw a comment from someone the other day <em>(Cloud is not WHERE you work, its HOW you work)</em>.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>An Azure landing zone is an environment that follows key design principles across eight design areas. These design principles accommodate all application portfolios and enable application migration, modernization, and innovation at scale. An Azure landing zone uses subscriptions to isolate and scale application and platform resources. Subscriptions for application resources are called application landing zones, and subscriptions for platform resources are called platform landing zones.</p><p>An Azure landing zone architecture is scalable and modular to meet various deployment needs. The repeatable infrastructure allows you to consistently apply configurations and controls to every subscription. Modules make deploying and modifying specific Azure landing zone architecture components easy as your requirements evolve.</p><p><img decoding="async" loading="lazy" alt="Azure Landing Zones" src="https://luke.geek.nz/assets/images/azure-landing-zone-architecture-diagram-hub-spoke-760034b8ea0ae977ac1aebbfcdd88b92.png" width="4759" height="2835" class="img_ev3q"></p></div></div>
<p>More information on Azure Landing Zones, can be found in the <a href="https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Microsoft Cloud Adoption Framework for Azure</a>, Landing Zones specifically sits under the Ready phase.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-understanding-azure-landing-zone-accelerators">üöÄ Understanding Azure Landing Zone Accelerators<a href="https://luke.geek.nz/azure/azure-landing-zone-accelerator/#-understanding-azure-landing-zone-accelerators" class="hash-link" aria-label="Direct link to üöÄ Understanding Azure Landing Zone Accelerators" title="Direct link to üöÄ Understanding Azure Landing Zone Accelerators">‚Äã</a></h2>
<p><a href="https://azure.github.io/Azure-Landing-Zones/accelerator/" target="_blank" rel="noopener noreferrer">Azure Landing Zone Accelerators</a> are automation frameworks designed to expedite the deployment of Azure Landing Zone architecture. They come in three flavors:</p>
<ul>
<li>Bicep Accelerator</li>
<li>Terraform Accelerator</li>
<li>Portal Accelerator</li>
</ul>
<p>These Accelerators, adopt a best-practice approach <em>(but also opinionated)</em> to deploy an Azure Landing Zone, from scratch, whether Brownfield <em>(already existing)</em> or Greenfield <em>(new)</em>, and they have been going through a transformation, from previous accelerators <em>(marked as vNext)</em> to adopt a more modular approach with both Bicep and Terraform deployments aligned to <a href="https://azure.github.io/Azure-Verified-Modules/" target="_blank" rel="noopener noreferrer">Azure Verified Modules</a>. These Accelerators are what Microsoft would run in a VBD workshop <em>(I believe they would use the Portal accelerator)</em>.</p>
<p>I want to make clear, these just like the Cloud Adoption Framework, are best practices but also generalized to support multiple types of organisations, so make sure you adjust them to suit your needs and organisations, or even mark it as a northstar to aim towards, but not necessary what you need in that moment, but also consider strategically where you want to go, ie platform engineering, de-centralized or centralized operations, all these decisions will determine how your Landing Zone structure is based and used <em>(ie if you don't like the word Online, change it to Public, your business needs to understand where to put workloads and how they will work <em>(not spending the time fighing over what something is named)</em>)</em>.</p>
<p>With Landing Zones, there's the Platform Landing Zone and the Application Landing Zone, the Platform Landing Zone is the shared services like identity, connectivity, and management, whereas the Application Landing Zone is specific environments for particular applications or workloads <em>(consider Arc, maybe APIM, anything generalized - this is really where your business logic and IP sits)</em>.</p>
<p><img decoding="async" loading="lazy" alt="Azure Landing Zones - Customer Journey" src="https://luke.geek.nz/assets/images/ALZAccelerator_CustomerJourney-914c88d575ebf22eb152962a5a286d48.JPG" width="4000" height="2250" class="img_ev3q"></p>
<p>For this article, we will be discussing the:</p>
<ul>
<li>Bootstrap of our environment (into Azure DevOps)</li>
<li>Deployment of Azure platform Landing Zone components using Terraform</li>
</ul>
<p><img decoding="async" loading="lazy" alt="Azure Landing Zones - Customer Journey" src="https://luke.geek.nz/assets/images/ALZAccelerator_SampleLandingZoneDeployment-636770bcbe9bd9b7cc2a69e9ed64aa24.JPG" width="4000" height="2250" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-deploying-azure-landing-zones-with-terraform">üîÑ Deploying Azure Landing Zones with Terraform<a href="https://luke.geek.nz/azure/azure-landing-zone-accelerator/#-deploying-azure-landing-zones-with-terraform" class="hash-link" aria-label="Direct link to üîÑ Deploying Azure Landing Zones with Terraform" title="Direct link to üîÑ Deploying Azure Landing Zones with Terraform">‚Äã</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-bootstrap">üõ†Ô∏è Bootstrap<a href="https://luke.geek.nz/azure/azure-landing-zone-accelerator/#%EF%B8%8F-bootstrap" class="hash-link" aria-label="Direct link to üõ†Ô∏è Bootstrap" title="Direct link to üõ†Ô∏è Bootstrap">‚Äã</a></h3>
<p>It begins with a Bootstrap process, which is the initial setup of the Azure DevOps environment, including creating a new project, repository, and service connection. This process is automated using a mix of PowerShell and Terraform.</p>
<p><img decoding="async" loading="lazy" alt="Azure Landing Zones - Customer Journey" src="https://luke.geek.nz/assets/images/ALZAccelerator_Components-5f01c0a4e3c0ecb3238c7df560f4fd79.JPG" width="4000" height="2250" class="img_ev3q"></p>
<p>To bootstrap, we will make use of the:<a href="https://github.com/Azure/ALZ-PowerShell-Module" target="_blank" rel="noopener noreferrer">ALZ-PowerShell-Module</a>, this script will help bring together the different dependencies and Terraform bootstrapping to setup our Azure DevOps environment, Terraform state storage account and bring in the necessary Platform Landing Zone library files for our deployment.</p>
<p><img decoding="async" loading="lazy" alt="Azure Landing Zones - Customer Journey" src="https://luke.geek.nz/assets/images/ALZAccelerator_CICDComponents-ea1fbf93870e1274232688bbf61c0361.JPG" width="4000" height="2250" class="img_ev3q"></p>
<p>The bootstrap for Azure DevOps includes <a href="https://learn.microsoft.com/azure/devops/pipelines/agents/agents?view=azure-devops&amp;tabs=yaml%2Cbrowser&amp;WT.mc_id=AZ-MVP-5004796#self-hosted-agents" target="_blank" rel="noopener noreferrer">self-hosted agents</a> <em>(<a href="https://learn.microsoft.com/azure/container-apps/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Container Apps</a> or <a href="https://learn.microsoft.com/azure/container-instances/container-instances-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Container Instances</a>)</em> as optional, and preconfigured pipelines, including validation and branch policies with approval steps, so a foundational platform to work towards.</p>
<table><thead><tr><th>Component</th><th>Description</th><th>Notes</th></tr></thead><tbody><tr><td><strong>Azure Resources</strong></td><td></td><td></td></tr><tr><td>Resource Group for State</td><td>Container for Terraform state storage resources</td><td>Terraform only</td></tr><tr><td>Storage Account and Container for State</td><td>Stores Terraform state files securely</td><td>Terraform only</td></tr><tr><td>Resource Group for Identity</td><td>Container for managed identity resources</td><td></td></tr><tr><td>User Assigned Managed Identities (UAMI) with Federated Credentials</td><td>Identities for secure pipeline execution</td><td>For Plan and Apply</td></tr><tr><td>Permissions for the UAMI</td><td>RBAC assignments needed for deployment</td><td>On state storage container, subscriptions, and management groups</td></tr><tr><td>[Optional] Container Registry for Azure DevOps Agent Image</td><td>Stores custom agent container images</td><td>For self-hosted agents</td></tr><tr><td>[Optional] Container Instances hosting Azure DevOps Agents</td><td>Runs pipeline jobs in your Azure environment</td><td>For self-hosted agents</td></tr><tr><td>[Optional] Virtual network, subnets, private DNS zone, and private endpoint</td><td>Network resources for private connectivity</td><td>For enhanced security</td></tr><tr><td><strong>Azure DevOps Resources</strong></td><td></td><td></td></tr><tr><td>Project (can be supplied or created)</td><td>Azure DevOps project for Landing Zone resources</td><td>Can use existing or create new</td></tr><tr><td>Repository for the Module</td><td>Stores Landing Zone Terraform code</td><td>Main implementation repository</td></tr><tr><td>Repository for the Pipeline Templates</td><td>Stores CI/CD pipeline definitions</td><td>Enables template reuse</td></tr><tr><td>Starter Terraform module with tfvars</td><td>Pre-configured Terraform configuration</td><td>Customizable baseline</td></tr><tr><td>Branch policy</td><td>Ensures code quality and reviews</td><td>Prevents direct main branch changes</td></tr><tr><td>Pipeline for Continuous Integration</td><td>Validates and plans Terraform changes</td><td>Non-destructive verification</td></tr><tr><td>Pipeline for Continuous Delivery</td><td>Implements Terraform changes in Azure</td><td>Creates/updates resources</td></tr><tr><td>Environment for Plan</td><td>Isolated context for planning stage</td><td>Separates planning permissions</td></tr><tr><td>Environment for Apply</td><td>Isolated context for apply stage</td><td>Separates deployment permissions</td></tr><tr><td>Variable Group for Backend</td><td>Stores Terraform backend configuration</td><td>Used across pipelines</td></tr><tr><td>Service Connections with Workload identity federation for Plan and Apply</td><td>Securely connects Azure DevOps to Azure</td><td>Uses OIDC for enhanced security</td></tr><tr><td>Service Connection Approvals, Template Validation, and Concurrency Control</td><td>Provides governance for deployments</td><td>Ensures controlled changes</td></tr><tr><td>Group and Members for Apply Approval</td><td>Team responsible for approving changes</td><td>Change control mechanism</td></tr><tr><td>[Optional] Agent Pool</td><td>Collection of build/release agents</td><td>For self-hosted agents</td></tr></tbody></table>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>Make sure you check out the following resources for more information on the Azure Landing Zone Accelerator and Azure Landing Zone Library, these are your sources of truth:</p><ul>
<li><a href="https://aka.ms/alz/acc" target="_blank" rel="noopener noreferrer">Azure Landing Zones Documentation</a></li>
<li><a href="https://azure.github.io/Azure-Landing-Zones-Library/" target="_blank" rel="noopener noreferrer">Azure Landing Zones Library</a></li>
</ul><p>If you have issues, you can also raise them on the <a href="https://github.com/Azure/ALZ-PowerShell-Module/issues" target="_blank" rel="noopener noreferrer">ALZ-PowerShell-Module</a> GitHub repository.</p></div></div>
<p>Before we get started, we need some pre-requisites</p>
<ul>
<li>
<p>3 Azure subscriptions <em>(1 for Connectivity, 1 for Identity, and 1 for Management) - (for this demo, I will be using a single subscription)</em> we will also need the bootstrap and Terraform deployment IDs.
Permissions Required for Management Group and Subscriptions:</p>
</li>
<li>
<p>Owner on your chosen parent management group:</p>
</li>
</ul>
<p>The owner account will grant permissions to the identities running the management group deployment. Owner on each of your 3 Azure landing zone subscriptions.</p>
<ul>
<li>A PAT token for the creation of a Service Connection in Azure DevOps <em>(Agent Pools (Read &amp; manage)</em>, Build <em>(Read &amp; execute)</em>, Code <em>(Full)</em>, Environment <em>(Read &amp; manage)</em>, Graph <em>(Read &amp; manage)</em>, Pipeline Resources <em>(Use &amp; manage)</em>, Project and Team <em>(Read, write &amp; manage)</em>, Service Connections <em>(Read, query &amp; manage)</em>, and Variable Groups <em>(Read, create &amp; manage)</em>.)_  This token is only needed for the duration required to bootstrap the environment and can be revoked after.</li>
</ul>
<p>Once we have those pre-requisites, we can proceed with the bootstrapping process.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>I recommend starting with the <a href="https://azure.github.io/Azure-Landing-Zones/examples/tf/accelerator/config/checklist.xlsx" target="_blank" rel="noopener noreferrer">Azure Landing Zone Accelerator Checklist</a>, this will help you understand the requirements and dependencies for the deployment, and ensure you have everything you need before you start the process.</p><p><img decoding="async" loading="lazy" alt="Azure Landing Zones - Customer Journey" src="https://luke.geek.nz/assets/images/ALZ_Bootstrap_Checklist-3bc4ebfe88a2536512d96b086caa6b82.jpg" width="1898" height="925" class="img_ev3q"></p></div></div>
<p>We will bootstrap the environment, to create our Azure DevOps environment, and then deploy the base components for a <a href="https://learn.microsoft.com/azure/cloud-adoption-framework/ready/landing-zone/?WT.mc_id=AZ-MVP-5004796#platform-landing-zones-vs-application-landing-zones" target="_blank" rel="noopener noreferrer">Platform Landing Zone</a> and the associated <a href="https://learn.microsoft.com/azure/cloud-adoption-framework/ready/landing-zone/tailoring-alz?WT.mc_id=AZ-MVP-5004796#what-is-a-landing-zone-archetype-in-azure-landing-zones" target="_blank" rel="noopener noreferrer">archetypes</a> for the fictional company of Contoso. To do this, we will be using the Terraform - Azure Verified Modules for <a href="https://azure.github.io/Azure-Landing-Zones/accelerator/startermodules/terraform-platform-landing-zone/" target="_blank" rel="noopener noreferrer">Platform Landing Zone (ALZ) starter modules</a> and configuration in the Australia East Azure region.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Before you start, make sure you request a parallelism grant for Azure DevOps, by default, Azure DevOps has a limit of 1 concurrent job, to request a free parallelism grant, please fill out the following form <a href="https://aka.ms/azpipelines-parallelism-request" target="_blank" rel="noopener noreferrer">https://aka.ms/azpipelines-parallelism-request</a></p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-bootstrap-process">üìã Bootstrap Process<a href="https://luke.geek.nz/azure/azure-landing-zone-accelerator/#-bootstrap-process" class="hash-link" aria-label="Direct link to üìã Bootstrap Process" title="Direct link to üìã Bootstrap Process">‚Äã</a></h3>
<ol>
<li>First login to Azure 'az login' and then run the following commands:</li>
<li>Next we need the ALZ PowerShell Module, so we will install that:</li>
</ol>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Check if the ALZ module is installed</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$module</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-InstalledModule</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name ALZ </span><span class="token operator">-</span><span class="token plain">ErrorAction SilentlyContinue</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$null</span><span class="token plain"> </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$module</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># If the module is not installed, install it</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Install-Module</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name ALZ </span><span class="token operator">-</span><span class="token plain">Force</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"ALZ module installed successfully."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># If the module is installed, update it</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Update-Module</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name ALZ</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"ALZ module updated successfully."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="Azure Landing Zones - Customer Journey" src="https://luke.geek.nz/assets/images/ALZ_InstallPshModule-3ff24a30b93f6bf60a46c6336ae95963.gif" width="930" height="429" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Three sets of configuration can be supplied to the accelerator to pre-configure it.</p><p>The available configuration inputs are:</p><ul>
<li><a href="https://azure.github.io/Azure-Landing-Zones/accelerator/userguide/2_start/#bootstrap-configuration-file" target="_blank" rel="noopener noreferrer">Bootstrap Configuration File</a></li>
<li><a href="https://azure.github.io/Azure-Landing-Zones/accelerator/userguide/2_start/#platform-landing-zone-configuration-file" target="_blank" rel="noopener noreferrer">Platform Landing Zone Configuration File</a></li>
<li><a href="https://azure.github.io/Azure-Landing-Zones/accelerator/userguide/2_start/#platform-landing-zone-library-lib-folder" target="_blank" rel="noopener noreferrer">Platform Landing Zone Library (lib) Folder</a></li>
</ul></div></div>
<p>We will start with th bootstrap configuration file, this will be used to create the Azure DevOps environment, and the Terraform state storage account and container, then we adjust the Platform Landing Zone configuration file to control what Azure resources we will need to deploy <em>(ie Hub and Spoke, or Virtual WAN, Bastion etc)</em> and the Platform Landing Zone library folder, which will contain the Archetype definitions and policy assignments for greater flexibility.</p>
<ol start="3">
<li>Let's create the local configuration files for the bootstrap and Platform Landing Zone deployment:</li>
</ol>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">New-Item</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ItemType </span><span class="token string" style="color:rgb(255, 121, 198)">"file"</span><span class="token plain"> c:\Code\accelerator\config\inputs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">yaml </span><span class="token operator">-</span><span class="token plain">Force</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">New-Item</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ItemType </span><span class="token string" style="color:rgb(255, 121, 198)">"file"</span><span class="token plain"> c:\Code\accelerator\config\platform-landing-zone</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">tfvars </span><span class="token operator">-</span><span class="token plain">Force  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Exclude this line if using FSI or SLZ starter modules</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">New-Item</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ItemType </span><span class="token string" style="color:rgb(255, 121, 198)">"directory"</span><span class="token plain"> c:\Code\accelerator\config\lib </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">New-Item</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ItemType </span><span class="token string" style="color:rgb(255, 121, 198)">"directory"</span><span class="token plain"> c:\Code\accelerator\output</span><br></span></code></pre></div></div>
<ol start="4">
<li>Now we need to open the inputs.yaml file and add the following configuration found here: <a href="https://raw.githubusercontent.com/Azure/alz-terraform-accelerator/refs/heads/main/templates/platform_landing_zone/examples/bootstrap/inputs-azure-devops.yaml" target="_blank" rel="noopener noreferrer">inputs-azure-devops.yaml</a>.</li>
</ol>
<p>It should look something like below:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># For detailed instructions on using this file, visit:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># https://aka.ms/alz/accelerator/docs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Basic Inputs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">iac_type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"terraform"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">bootstrap_module_name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"alz_azuredevops"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">starter_module_name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"platform_landing_zone"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Shared Interface Inputs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">bootstrap_location</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"australiaeast"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">starter_locations</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">"australiaeast"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">root_parent_management_group_id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Contoso"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">subscription_id_management</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"00000000-0000-4000-8000-000000000001"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">subscription_id_identity</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"00000000-0000-4000-8000-000000000002"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">subscription_id_connectivity</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"00000000-0000-4000-8000-000000000003"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Bootstrap Inputs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">azure_devops_personal_access_token</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># azure_devops_agents_personal_access_token: "&lt;token-2&gt;"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">azure_devops_organization_name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Contoso"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">use_separate_repository_for_templates</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">bootstrap_subscription_id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"00000000-0000-4000-8000-000000000004"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">service_name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"plz"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">environment_name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"mgmt"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">postfix_number</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">azure_devops_use_organisation_legacy_url</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">azure_devops_create_project</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">azure_devops_project_name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"ADO-PALZ"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">use_self_hosted_agents</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">use_private_networking</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">allow_storage_access_from_my_ip</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">apply_approvers</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">"luke@contoso.com"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">create_branch_policies</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Advanced Inputs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">bootstrap_module_version</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"latest"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">starter_module_version</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"latest"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">output_folder_path</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"c:/Code/accelerator/output"</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>For further customisation, make sure you take a look at the <a href="https://github.com/Azure/accelerator-bootstrap-modules/blob/main/alz/local/variables.tf" target="_blank" rel="noopener noreferrer">variables.tf</a> file directly in the accelerator bootstrap modules GitHub, it can show further options that you can add to the bootstrap, such as the storage account replication type for your Terraform state files, or additional custom roles and resource naming.</p></div></div>
<p>Now that we have configured the variables required for our bootstrap, let us define the Terraform variables for the Platform Landing Zone deployment, this will be used to determine the Azure resources we will deploy, such as the Hub and Spoke, Virtual WAN, Bastion, etc, and this is the platform-landing-zone.tfvars file. I recommend copying one from one of the <a href="https://azure.github.io/Azure-Landing-Zones/accelerator/startermodules/terraform-platform-landing-zone/scenarios/" target="_blank" rel="noopener noreferrer">already pre-existing Scenarios</a> and modifying to suit your needs. For my purposes, I will be going with a Single region hub and spoke VNET with <a href="https://azure.github.io/Azure-Landing-Zones/accelerator/startermodules/terraform-platform-landing-zone/scenarios/single-region-hub-and-spoke-vnet-with-azure-firewall/" target="_blank" rel="noopener noreferrer">Azure Firewall</a>.</p>
<ol start="5">
<li>Open the platform-landing-zone.tfvars file and add the configuration and modify for your needs, for my purposes, I will be using the following configuration: <a href="https://raw.githubusercontent.com/Azure/alz-terraform-accelerator/refs/heads/main/templates/platform_landing_zone/examples/full-single-region/hub-and-spoke-vnet.tfvars" target="_blank" rel="noopener noreferrer">platform_landing_zone/examples/full-single-region/hub-and-spoke-vnet.tfvars</a>.</li>
</ol>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>The <code>platform-landing-zone.tfvars</code> file is a crucial configuration for deploying an Azure Landing Zone using the Azure Landing Zones Accelerator with Terraform. This file defines the variables that customize your Azure foundation by your requirements, and this file will be your main configuration file for the deployment of the Platform Landing Zone.</p><p>Key Components of the File</p><p><strong>Built-in Replacements</strong></p><p>The file uses a templating system with <code>$${variable_name}</code> syntax to reference predefined values, such as:</p><ul>
<li>Azure locations (e.g., <code>$${starter_location_01}</code>)</li>
<li>Subscription IDs (e.g., <code>$${subscription_id_management}</code>)</li>
<li>Management group IDs</li>
</ul><p>These built-in replacements help maintain consistency throughout the configuration.</p><p><strong>Custom Replacements</strong></p><p>The configuration defines custom naming patterns and references for:</p><ol>
<li>
<p><strong>Resource Names</strong> - Standardizing naming conventions for:</p>
<ul>
<li>Resource groups</li>
<li>Virtual networks</li>
<li>Azure Firewall</li>
<li>Log Analytics workspace</li>
<li>And many other resources</li>
</ul>
</li>
<li>
<p><strong>IP Address Spaces</strong> - Defining network address spaces for the hub network:</p>
<ul>
<li>Virtual network address space</li>
<li>Subnet address prefixes</li>
<li>Firewall subnet</li>
</ul>
</li>
</ol><p><strong>Management Resources</strong></p><p>This section configures core management resources including:</p><ul>
<li>Log Analytics workspace</li>
<li>Automation account</li>
<li>Azure Monitor Agent settings</li>
<li>Data Collection Rules for monitoring</li>
</ul><p><strong>Management Groups and Policy</strong></p><p>The file configures:</p><ul>
<li>Management group hierarchy structure</li>
<li>Policy assignments and overrides, for example Defender for Cloud Settings</li>
<li>Subscription placement within management groups</li>
</ul><p><strong>Connectivity Resources</strong></p><p>The hub-and-spoke network topology is defined with:</p><ul>
<li>DDoS protection plan</li>
<li>Virtual network configuration</li>
<li>Azure Firewall and routing tables</li>
<li>Virtual network gateways (ExpressRoute and VPN)</li>
<li>Private DNS zones and resolver</li>
<li>Azure Bastion</li>
</ul><p><strong>How to Modify This File</strong></p><ol>
<li>Customize Basic Information</li>
</ol><ul>
<li><strong>Email Contacts</strong>: Update security contact email addresses</li>
<li><strong>Tags</strong>: Modify organization-specific tags</li>
</ul><div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token property">tags</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">deployed_by</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"terraform"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">technical_contact</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"your-email@company.com"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">environment</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"production"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">business_unit</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"finance"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre></div></div><ol start="2">
<li>Adjust Network Addressing</li>
</ol><p>Modify the IP address ranges to match your organization's network plan:</p><div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token property">primary_hub_address_space</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"10.100.0.0/16"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token property">primary_hub_virtual_network_address_space</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"10.100.0.0/22"</span><br></span></code></pre></div></div><ol start="3">
<li>Change Resource Naming</li>
</ol><p>Update naming conventions to align with your organization's standards:</p><div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token property">log_analytics_workspace_name</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"law-prod-eastus"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token property">automation_account_name</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"aa-prod-eastus"</span><br></span></code></pre></div></div><ol start="4">
<li>Modify Policy Settings</li>
</ol><p>Adjust policy enforcement levels for your compliance requirements:</p><div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token property">Enable-DDoS-VNET</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">enforcement_mode</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Default"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># or "DoNotEnforce"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre></div></div><ol start="5">
<li>Add or Remove Resources</li>
</ol><p>You can customize which components are deployed by adding or removing sections:</p><ul>
<li>Remove the VPN gateway if not needed</li>
<li>Add additional hub networks for multi-region deployments</li>
<li>Modify Azure Firewall SKU based on requirements</li>
</ul><p>Also make sure you run a <code>terraform validate</code> and <code>terraform fmt</code> to validate the configuration and the Terraform formatting is correct on the file.</p><p><strong>Make sure to check out the <a href="https://azure.github.io/Azure-Landing-Zones/accelerator/startermodules/terraform-platform-landing-zone/options/" target="_blank" rel="noopener noreferrer">Options</a> page for the Terraform Platform Landing Zone, as it will give you more information on the common scenarios, such as turning off DDOS protection plans, adding additional IP ranges etc.</strong></p></div></div>
<p>And don't worry if you don't get this right the first time, you can always adjust and redeploy, this is the beauty of Infrastructure as Code. I work in an iterative approach, so it's always good to get something working, then adjust and improve, rather than trying to get it perfect the first time, and the Terraform plan and validate pipelines help with this approach.</p>
<ol start="6">
<li>We are close, the last thing we will add is a custom library folder. This isn't required for base Platform Landing Zones, however, I recommend adding it in, for additional flexibility, especially as you start to deploy more complex environments and archetypes within your organization. You can refer to the <a href="https://azure.github.io/Azure-Landing-Zones-Library/" target="_blank" rel="noopener noreferrer">Azure Landing Zones Library</a> for more information on how to create your own custom library and additional information. Still, for now we are going to copy the alz folder from the <a href="https://github.com/Azure/Azure-Landing-Zones-Library/tree/main/platform" target="_blank" rel="noopener noreferrer">Azure Landing Zones Library</a> and place it in the lib folder in our config directory.</li>
</ol>
<p>By default, the architecture that will be deployed will be <em>(you can also refer to the README file in the lib folder for more information)</em>:</p>
<!-- -->
<p>You can adujust the Management Group names and parent/child relationships by editing the <code>alz.alz_architecture_definition.json</code> file in the lib\architecture_definitions folder, and th architectype definitions allow you to configure the type of policy definitions, role assignments that are deployed to specific Management Groups with a certain archetype, for example you could have workload Landing Zones of 'Workload' archetype with specific policy definitions and role assignments, that may be different from the root or Platform groups, and Management Groups could share this same archetype, so you can have a consistent policy and role assignment across your environment.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>Not required, but make the <a href="https://github.com/Azure/alzlib" target="_blank" rel="noopener noreferrer">alzlibtool</a> tool, this is a tool that can help you create and manage your own custom library for your Azure Landing Zones, and can be used to check policy and Azure Landing Zone architecture definition structure, and document your own custom library.</p></div></div>
<ol start="7">
<li>Now that the configuration files for the bootstrap, Terraform are in place, and the architectures, it's time to start the bootstrap. Run the following command to start the bootstrap process:</li>
</ol>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>If you need to make any last-minute changes, you can manually change the Terraform code after the Terraform plan and before the application. Check your local output folder. It is not something I would rely on - ideally the platform tfvars and yaml input file should be updated, but in a pinch, you can make manual changes. I had to do this recently, when deploying a Landing Zone into New Zealand North. I had to manually update the location of the Log Analytics workspace, as it has not been supported in that <a href="https://learn.microsoft.com/azure/reliability/availability-service-by-category?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">region yet</a>. However, for Platform resources, you can also make this change once the code is in the repository.</p></div></div>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Deploy-Accelerator `</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token operator">-</span><span class="token plain">inputs </span><span class="token string" style="color:rgb(255, 121, 198)">"C:\Code\accelerator\config\inputs.yaml"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"C:\Code\accelerator\config\platform-landing-zone.tfvars"</span><span class="token plain"> `</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token operator">-</span><span class="token plain">starterAdditionalFiles </span><span class="token string" style="color:rgb(255, 121, 198)">"C:\Code\accelerator\config\lib"</span><span class="token plain"> `</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token operator">-</span><span class="token plain">output </span><span class="token string" style="color:rgb(255, 121, 198)">"C:\Code\accelerator\output"</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="Azure Landing Zones - Customer Journey" src="https://luke.geek.nz/assets/images/ALZ_DeployBootstrap-5dfb106817ad002e393025a0361ee285.gif" width="930" height="429" class="img_ev3q"></p>
<p>Once completed, in Azure, you should have two resource groups - one for your Managed identities that will be linked to 2 Service Connections in Azure DevOps for Plan and Apply, and one for your Terraform state file.</p>
<p><img decoding="async" loading="lazy" alt="Azure Landing Zones - Customer Journey" src="https://luke.geek.nz/assets/images/ALZ_Bootstrap_Resource_Deployed-344f57a5209701cd629dffefd37f9591.png" width="1309" height="322" class="img_ev3q"></p>
<p>In Azure DevOps, you should have a new project, repository, and service connection, with the pipelines and environments set up for the Plan and Apply stages.</p>
<p><img decoding="async" loading="lazy" alt="AzureDevOps Azure Landin Zone Code" src="https://luke.geek.nz/assets/images/ALZ_Bootstrap_ADO_Deployed-31e1b69278f5fefc436d6759e2346b1b.png" width="1772" height="1038" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>The plz acronym I am using, is meant to indicate 'Platform Landing Zone'.</p></div></div>
<p>And Pipelines preconfigured - Continuous Integration <em>(ie Terraform Validate and Plan)</em> and Continuous Delivery <em>(ie Terraform Apply)</em> with the approvers and branch policies in place.</p>
<p><img decoding="async" loading="lazy" alt="Azure DevOps Azure Landing Zone Pipelines" src="https://luke.geek.nz/assets/images/ALZ_Bootstrap_ADOPipelines-60994147431a7299f86ea62caa6ff7bc.jpg" width="1059" height="375" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>I recommend renaming the pipelines, in Azure DevOps, so they are more descriptive, ie, 'Terraform Plan' and 'Terraform Apply' - pretty simplified, but can make more sense to people consuming the pipelines.</p><p><img decoding="async" loading="lazy" alt="Azure DevOps Azure Landing Zone Pipelines" src="https://luke.geek.nz/assets/images/ALZ_DeployBootstrap_RenameADOPipelines-4b45fe67ef66557f73987b55540bc0d5.gif" width="1642" height="608" class="img_ev3q"></p></div></div>
<p>Now, let's run the Continuous Integration pipeline to see what the Terraform plan looks like.</p>
<p><img decoding="async" loading="lazy" alt="Azure DevOps Azure Landing Zone Pipelines" src="https://luke.geek.nz/assets/images/ALZ_PLZ_ValidatePlan-a9d07fe6f4bc6b0981a49a751f4959a2.gif" width="1642" height="903" class="img_ev3q"></p>
<p>As we can see, it validates and will deploy our full hub and spoke <em>(both expressroute and VPN gateways)</em> so that would need tweaking for my environment, but this is the beauty of Infrastructure as Code, you can see what is going to be deployed before it is deployed, and make the necessary adjustments, by opening up a new branch and adjusting the the platform-landing-zone.auto.tfvars, and run validate and plan on that branch until correct.</p>
<p>So, now let's deploy. Once you are happy with the plan, you can run the Continuous Delivery pipeline to deploy the Platform Landing Zone.</p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>Be aware that the initial deployment could take a while, especially if deploying all the default policies, and DNS zones. As such, the entire deployment is not shown in the GIF below, but you can see the new Platform Management Groups and core hub resources that have started to be created.</p></div></div>
<p><img decoding="async" loading="lazy" alt="Azure DevOps Azure Landing Zone Pipelines" src="https://luke.geek.nz/assets/images/ALZ_PLZ_Apply-be626e5bc0f47e188f9dde4d43e62ee1.gif" width="1642" height="903" class="img_ev3q"></p>
<p>And once completed, you should have a full Platform Landing Zone deployed, with the Management Groups, Policies, and core resources in place.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>You can rerun the Continuous Delivery pipeline, and select Destroy if you want to remove all the platform resources and start your deployment from scratch, in a production scenario, I recommend removing that, but not the additional approval step so that you can have a manual check before the Apply stage. The approval is done in Azure DevOps at the Service Connection, under Approval and Checks.</p></div></div>
<p><img decoding="async" loading="lazy" alt="Azure DevOps Azure Landing Zone Pipelines" src="https://luke.geek.nz/assets/images/ALZAccelerator_DepoloyedLandingZoneDeployment-5b907c3c806757df461abf2b4f725488.JPG" width="1200" height="417" class="img_ev3q">
<img decoding="async" loading="lazy" alt="Azure DevOps Azure Landing Zone Pipelines" src="https://luke.geek.nz/assets/images/ALZAccelerator_DepoloyedLandingZoneDeploymentResources-d373792a651514613db7d992d10d489e.JPG" width="1780" height="936" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-conclusion">‚úÖ Conclusion<a href="https://luke.geek.nz/azure/azure-landing-zone-accelerator/#-conclusion" class="hash-link" aria-label="Direct link to ‚úÖ Conclusion" title="Direct link to ‚úÖ Conclusion">‚Äã</a></h2>
<p>The <a href="https://techcommunity.microsoft.com/blog/azuretoolsblog/azure-landing-zones-accelerators-for-bicep-and-terraform-announcing-general-avai/4029866?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Landing Zone Terraform Accelerator</a> offers a robust foundation for organizations looking to implement a well-architected Azure environment.</p>
<p>Through this article, we've explored how to:</p>
<ol>
<li>Bootstrap your environment with automation using the <a href="https://github.com/Azure/ALZ-PowerShell-Module" target="_blank" rel="noopener noreferrer">ALZ PowerShell module</a></li>
<li>Configure and deploy <a href="https://learn.microsoft.com/azure/cloud-adoption-framework/ready/landing-zone/?WT.mc_id=AZ-MVP-5004796#platform-landing-zones-vs-application-landing-zones" target="_blank" rel="noopener noreferrer">Platform Landing Zone components</a> using Infrastructure as Code <em>(<a href="https://www.terraform.io/" target="_blank" rel="noopener noreferrer">Terraform</a>)</em></li>
<li>Establish governance through management groups, policies, and controlled <a href="https://learn.microsoft.com/azure/devops/pipelines/get-started/what-is-azure-pipelines?view=azure-devops&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure DevOps pipelines</a>.</li>
</ol>
<p>Next Steps After Deployment</p>
<p>Once your Platform Landing Zone is established, consider these follow-up activities:</p>
<ul>
<li>Document your environment: Create detailed documentation explaining your Landing Zone design choices and customizations _(make sure to checkout <a href="https://github.com/Azure/alzlib/tree/main" target="_blank" rel="noopener noreferrer">alzlibtool</a>)</li>
<li>Establish operational procedures: Define processes for managing the environment, including approvals and adjustments to the platform</li>
<li>Plan your Application Landing Zones: Design the specific landing zones for your workloads based on your organization's needs and investigate <a href="https://learn.microsoft.com/azure/cloud-adoption-framework/ready/landing-zone/design-area/subscription-vending?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Subscription vending</a>.</li>
</ul>
<p>Resources for Continued Learning</p>
<ul>
<li><a href="http://aka.ms/AwesomeAzureArchitecture" target="_blank" rel="noopener noreferrer">AWESOME Azure Architecture</a></li>
<li><a href="https://azure.github.io/Azure-Landing-Zones-Library/" target="_blank" rel="noopener noreferrer">Azure Landing Zones Library</a></li>
<li><a href="https://learn.microsoft.com/azure/cloud-adoption-framework/ready/landing-zone/design-areas?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure landing zone design areas and conceptual architecture</a></li>
<li><a href="https://learn.microsoft.com/azure/cloud-adoption-framework/manage/azure-management-guide/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Management Guide</a></li>
<li><a href="https://azure.github.io/Azure-Verified-Modules/" target="_blank" rel="noopener noreferrer">Azure Verified Modules</a></li>
<li><a href="https://github.com/Azure/Enterprise-Scale" target="_blank" rel="noopener noreferrer">Enterprise-scale architecture GitHub repo</a></li>
</ul>
<p>For the GitHub repos, remember to view the Issues and Pull Requests, you can learn a lot from what other people have contributed to the initiatives, and the Issues being raised.</p>
<p>Remember, the Landing Zone is not a one-time deployment but an evolving foundation that grows with your organization's cloud journey. Regular reviews and updates will ensure it continues to support your changing business needs while maintaining security and governance standards, and how the business plans on consuming this - is not to be underestimated in the design and implementation of this.</p>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Getting Started with Azure Developer CLI (azd)]]></title>
            <link>https://luke.geek.nz/azure/azure-developer-cli/</link>
            <guid>https://luke.geek.nz/azure/azure-developer-cli/</guid>
            <pubDate>Wed, 19 Feb 2025 07:27:28 GMT</pubDate>
            <description><![CDATA[Learn how to use Azure Developer CLI (azd) to accelerate your Azure application development with templates, environment management, and CI/CD integration.]]></description>
            <content:encoded><![CDATA[<p>Today, we will touch on <a href="https://learn.microsoft.com/azure/developer/azure-developer-cli/overview?tabs=windows&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Developer CLI (azd)</a>.</p>
<p>So, let us take a closer look.</p>
<p><img decoding="async" loading="lazy" alt="azd" src="https://luke.geek.nz/assets/images/AZD-38353b129a17f94caad21a24602b1a8d.jpg" width="4000" height="1134" class="img_ev3q"></p>
<!-- -->
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-introduction">üåü Introduction<a href="https://luke.geek.nz/azure/azure-developer-cli/#-introduction" class="hash-link" aria-label="Direct link to üåü Introduction" title="Direct link to üåü Introduction">‚Äã</a></h2>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>The <a href="https://learn.microsoft.com/azure/developer/azure-developer-cli/overview?tabs=windows&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Developer CLI (azd)</a> is an open-source tool that accelerates provisioning and deploying app resources on Azure. azd provides best practice, developer-friendly commands that map to key stages in your development workflow, whether you're working in the terminal, an integrated development environment (IDE), or through CI/CD (continuous integration/continuous deployment) pipelines.</p><p>azd uses <a href="https://learn.microsoft.com/azure/developer/azure-developer-cli/azd-templates?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">extensible blueprint templates</a> that include everything you need to get an application up and running on Azure. These templates include:</p><ul>
<li>Reusable infrastructure as code assets to provision cloud resources services using Bicep or Terraform.</li>
<li>Proof-of-concept or starter app code that can be customized or replaced with your own app code.</li>
<li>Configuration files are needed to deploy your app to the provisioned resources.</li>
<li>Optionally, pipeline workflow files for GitHub Actions or Azure Pipelines to enable CI/CD integrations.</li>
</ul><p>You can also <a href="https://learn.microsoft.com/azure/developer/azure-developer-cli/make-azd-compatible?pivots=azd-create&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">create your own template</a> or find one to customize and expand on from the <a href="https://learn.microsoft.com/azure/developer/azure-developer-cli/make-azd-compatible?pivots=azd-convert&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Awesome AZD</a> gallery.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-what-is-azure-developer-cli-azd">ü§î What is Azure Developer CLI (azd)?<a href="https://luke.geek.nz/azure/azure-developer-cli/#-what-is-azure-developer-cli-azd" class="hash-link" aria-label="Direct link to ü§î What is Azure Developer CLI (azd)?" title="Direct link to ü§î What is Azure Developer CLI (azd)?">‚Äã</a></h3>
<p>The <a href="https://learn.microsoft.com/azure/developer/azure-developer-cli/overview?tabs=windows&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Developer CLI (azd)</a> is a developer-centric command-line interface (CLI) tool for deploying Azure applications, and their infrastructure components.</p>
<p>The goals of the CLI are to:</p>
<ul>
<li>reduce the time required for a developer to be productive</li>
<li>demonstrate opinionated best practices for Azure development</li>
<li>help developers understand core Azure development constructs</li>
</ul>
<p>To take full advantage of the CLI, code repositories need to conform to a well defined set of conventions that will be recognized by the tooling.</p>
<p>You can find more information on the <a href="https://github.com/Azure/azure-dev" target="_blank" rel="noopener noreferrer">Azure Developer CLI (azd) GitHub repository</a>, including installation instructions for Windows, Linux amd Mac.</p>
<p>A common misconception is that the Azure Developer CLI (azd) is a replacement for the Azure CLI. This is not the case. The Azure Developer CLI (azd) is a tool that is designed to help developers deploy Azure applications, ideal for rapid innovation and learning scenarios, and supports the deployment of infrastructure and application components.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>Make sure to check out <a href="https://azure.github.io/awesome-azd/" target="_blank" rel="noopener noreferrer"><strong>awesome-azd</strong></a>, a curated list of resources for the Azure Developer CLI (azd) community.! I have found this to be a great resource for finding templates and other resources to help me get started with the Azure Developer CLI (azd), and sometimes the exact scenario that you may need. And there is an active Pull Request to update alot of these examples to use <a href="https://azure.github.io/Azure-Verified-Modules/" target="_blank" rel="noopener noreferrer">Azure Verified Modules</a>.</p><p>For more AI-orientated workloads, refer to the <a href="https://azure.github.io/ai-app-templates/" target="_blank" rel="noopener noreferrer">**ai-app-template gallery</a>. This collection of templates can be used to deploy AI workloads to Azure, such as an Azure Agents Travel Assistant, Prompty and Semantic Kernel examples.</p></div></div>
<p>It is not a general-purpose tool for managing Azure resources.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-common-use-cases">üéØ Common use cases<a href="https://luke.geek.nz/azure/azure-developer-cli/#-common-use-cases" class="hash-link" aria-label="Direct link to üéØ Common use cases" title="Direct link to üéØ Common use cases">‚Äã</a></h3>
<p>I have found the Azure Developer CLI (azd) to be particularly useful in the following scenarios:</p>
<ul>
<li><strong>Learning Azure</strong>: The Azure Developer CLI (azd) is a great tool for learning Azure, as it provides a set of opinionated best practices for Azure development. This can help you understand core Azure development constructs and get up and running quickly with Azure without having to worry about whether a solution is deployed securely or how to architect or create each resource manually. AZD allows you to easily deploy and destroy the resources you need for learning, keeping your Azure subscription clean and tidy.</li>
<li><strong>Rapid Innovation</strong>: The Azure Developer CLI (azd) is also great for rapid innovation scenarios, where you need to quickly deploy a solution to Azure to test an idea or prototype or deploy in another environment in a once-off scenario.</li>
<li><strong>CI/CD Pipelines</strong>: The Azure Developer CLI (azd) can create CI/CD pipelines for your Azure applications. This can help you automate the deployment of your applications to Azure, and ensure that your applications are deployed consistently and securely.</li>
</ul>
<blockquote>
<p>I personally would fit Azure Developer CLI into the early lifecycle of a product - it's great to get going in your iterative phases <a href="https://luke.geek.nz/misc/product-development-lifecycle/" target="_blank" rel="noopener noreferrer">PoT/PoC/MVP</a>, AZD helps bootstrap and accelerate deployments into Azure from local development environments.</p>
</blockquote>
<p>For example, here is an example <a href="https://learn.microsoft.com/azure/developer/azure-developer-cli/azd-commands?WT.mc_id=AZ-MVP-5004796#compare-azure-developer-cli-commands" target="_blank" rel="noopener noreferrer">copied from the MS Learn</a> website that showcases it nicely:</p>
<table><thead><tr><th>Tool</th><th>Sample Command</th><th>Outcome</th></tr></thead><tbody><tr><td>Azure Developer CLI</td><td><code>azd provision</code></td><td>Provisions multiple Azure resources required for an app based on project resources and configurations, such as an Azure resource group, an Azure App Service web app, and app service plan, an Azure Storage account, and an Azure Key Vault.</td></tr><tr><td>Azure CLI</td><td><code>az webapp create --resource-group myResourceGroup --plan myAppServicePlan --name myWebApp</code></td><td>Provisions a new web app in the specified resource group and app service plan.</td></tr><tr><td>Azure PowerShell</td><td><code>New-AzWebApp -ResourceGroupName "myResourceGroup" -Name "myWebApp" -AppServicePlan "myAppServicePlan"</code></td><td>Provisions a new web app in the specified resource group and app service plan.</td></tr></tbody></table>
<p>At the time of writing, AZD can be used to deploy the infrastructure components and application components for the following services:</p>
<table><thead><tr><th>Service</th><th>Status</th></tr></thead><tbody><tr><td>Azure App Service</td><td>GA</td></tr><tr><td>Azure Static Web Apps</td><td>GA</td></tr><tr><td>Azure Container Apps</td><td>Beta</td></tr><tr><td>Azure Functions</td><td>GA</td></tr><tr><td>Azure Kubernetes Service</td><td>Beta*</td></tr><tr><td>Azure Spring Apps</td><td>Beta</td></tr></tbody></table>
<p><em>*KS support limited to projects deployable via kubectl apply -f</em></p>
<p>This covers the majority of scenarios, for example, a Static WebApp Frontend, an Azure Functions API backend, or a full-blown AKS cluster with a Spring App.</p>
<table><thead><tr><th>Category</th><th>Supported Technologies</th></tr></thead><tbody><tr><td>Programming Languages</td><td>Node.js, Python, .NET, Java</td></tr><tr><td>Infrastructure as Code</td><td>Bicep, Terraform</td></tr></tbody></table>
<p>Make sure to keep an eye on <a href="https://learn.microsoft.com/azure/developer/azure-developer-cli/supported-languages-environments?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Supported languages and environments</a> and <a href="https://github.com/Azure/azure-dev" target="_blank" rel="noopener noreferrer">Azure/azure-dev</a> for the most up to date information.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-getting-started">üöÄ Getting Started<a href="https://luke.geek.nz/azure/azure-developer-cli/#-getting-started" class="hash-link" aria-label="Direct link to üöÄ Getting Started" title="Direct link to üöÄ Getting Started">‚Äã</a></h2>
<p>Let's get started with the Azure Developer CLI (azd) by installing the CLI and creating a new project.</p>
<p>You can install it using tools <a href="https://learn.microsoft.com/en-us/azure/developer/azure-developer-cli/install-azd?tabs=choco-windows%2Cbrew-mac%2Cscript-linux&amp;pivots=os-windows&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">such as winget, straight curl sh script install, or homebrew</a>.</p>
<p>For me, I favor <a href="https://github.com/features/codespaces" target="_blank" rel="noopener noreferrer">GitHub Codespaces</a>, and using a GitHub Codespace I have preconfigured with AZD allows me to get started quickly.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>You can find my IaC Coding Codespace template here: <a href="https://github.com/lukemurraynz/Codespace_IaC_Coding" target="_blank" rel="noopener noreferrer">lukemurraynz/Codespace_IaC_Coding</a>.</p></div></div>
<p>If you want to add Azure CLI support to your own devcontainer/Codespace, then in the devcontainer.json under the features section, add:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token property">"features"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// Adds Azure Developer CLI (azd) support.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"ghcr.io/azure/azure-dev/azd:latest"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><br></span></code></pre></div></div>
<p>You can also add the Azure Developer CLI <a href="https://marketplace.visualstudio.com/items?itemName=ms-azuretools.azure-dev" target="_blank" rel="noopener noreferrer">Visual Studio Code extension</a> by:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token property">"extensions"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">"ms-azuretools.azure-dev"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>My demo environment that I will be using for this article is run from my <a href="https://github.com/lukemurraynz/Codespace_IaC_Coding" target="_blank" rel="noopener noreferrer">lukemurraynz/Codespace_IaC_Coding</a> GitHub Codespace template. This contains AZD, Terraform, Bicep, pretty much everything I need for any Infrastructure as Code work.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-project-initialization-azd-init">üìù Project initialization (azd init)<a href="https://luke.geek.nz/azure/azure-developer-cli/#-project-initialization-azd-init" class="hash-link" aria-label="Direct link to üìù Project initialization (azd init)" title="Direct link to üìù Project initialization (azd init)">‚Äã</a></h3>
<p>To create a new project using the Azure Developer CLI <em>(azd)</em>, you can use the <code>azd init</code> command. This command will create a new project in the current directory or will prompt you to select a template to use for the project from the awesome-and templates list.</p>
<p>For our demo, we will select a template already preconfigured.</p>
<p>We will select the <a href="https://github.com/Azure-Samples/dream-team" target="_blank" rel="noopener noreferrer">dreamteam</a> <em>(Autogen application, hosted in Azure Container App, with a Streamlit front end with Azure OpenAI)</em> template. We can use the up and down arrows and type if we know what template we want to easily search.</p>
<p>This template contains <a href="https://learn.microsoft.com/azure/container-apps/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Container Apps</a>, <a href="https://learn.microsoft.com/azure/azure-monitor/app/app-insights-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Application Insights</a>, <a href="https://learn.microsoft.com/azure/key-vault/general/basic-concepts?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Key Vault</a>, <a href="https://learn.microsoft.com/azure/azure-monitor/logs/log-analytics-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Log Analytics</a>, <a href="https://learn.microsoft.com/entra/identity/managed-identities-azure-resources/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Managed identities</a> and <a href="https://learn.microsoft.com/azure/ai-services/openai/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure OpenAI service</a>.</p>
<p><img decoding="async" loading="lazy" alt="azd init" src="https://luke.geek.nz/assets/images/demo-azdinit-template-6dc54970143e75ec919d0fa7adda083e.gif" width="1903" height="966" class="img_ev3q"></p>
<p>We could have also typed <code>azd init -t dream-team</code> to select the dream-team template if we knew what it was.</p>
<ul>
<li>An infra folder was added that includes Bicep files to create Azure resources (it could easily be Terraform).</li>
<li>An azure.yaml configuration file was added to map the app code in the src directory to the provision of Azure resources.</li>
</ul>
<p><img decoding="async" loading="lazy" alt="azd init" src="https://luke.geek.nz/assets/images/AZD_Base-FilesFolders-5ec1a3d6ea6cd4199e46ffe477aa4be4.jpg" width="4000" height="2250" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-deployment-azd-up">‚¨ÜÔ∏è Deployment (azd up)<a href="https://luke.geek.nz/azure/azure-developer-cli/#%EF%B8%8F-deployment-azd-up" class="hash-link" aria-label="Direct link to ‚¨ÜÔ∏è Deployment (azd up)" title="Direct link to ‚¨ÜÔ∏è Deployment (azd up)">‚Äã</a></h3>
<p>Now that we have the AZD project initialized, we can deploy the resources to Azure using the <code>azd up</code> command.</p>
<p>But first, we need to authenticate to Azure by running <code>and auth login</code> and following the instructions to select the appropriate tenancy and subscription.</p>
<p><img decoding="async" loading="lazy" alt="azd up" src="https://luke.geek.nz/assets/images/demo-azdauth-c13fe7eee60044f54826f88c471cdbf0.gif" width="1903" height="966" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>If you have tags or compliance reasons why resources need to be named something specific, now is the time to amend the infrastructure as code, in most projects, the name is made up of a resourcetoken generated by a unique token based on the subscription ID, environment name, and location + a resource suffix, for example, if it you were deploying API Management, the name could look something like: apim-nepvrtdddlfbu, but the names can be overwritten in the Bicep files like you would any other Bicep deployment - in fact, you can adjust the IaC as best to suit your environment, ie add in Private Endpoints, or adjust the SKU of a resource.</p></div></div>
<p>Now we can run <code>azd up</code> to deploy the resources to Azure.</p>
<p><img decoding="async" loading="lazy" alt="azd up" src="https://luke.geek.nz/assets/images/demo-azddeploy-28a27b8fc780ca93bee5ece54dc5d091.gif" width="1903" height="947" class="img_ev3q"></p>
<p>And if we click on the supplied endpoint, we can access our Streamlit application that is running in Azure Container Apps.</p>
<p><img decoding="async" loading="lazy" alt="azd up" src="https://luke.geek.nz/assets/images/demo-azd-deploy-streamlit-e80ce5aaf3c9e6505211bd6a94939088.jpg" width="1904" height="852" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>You can track the deployment in the Deployment blade of the created Resource Group as well.</p></div></div>
<p>As you can see, AZD went through a build phase to package and build the docker container from the src directory before proceeding with the infrastructure deployment and application deployment <em>(this behavior can be controlled by editing the azure.yaml file, but following this pattern is the default, build project, build infrastructure, then deploy project)</em>. No point in deploying the infrastructure if the build fails, and talking about failure, you may have issues deploying or building your service and not quite know where the problem is - one of the things you can do is enable <a href="https://learn.microsoft.com/azure/developer/azure-developer-cli/troubleshoot?tabs=Browser&amp;WT.mc_id=AZ-MVP-5004796#using-the---debug-switch" target="_blank" rel="noopener noreferrer">debug</a> to have more verbose output, ie <code>azd up --debug</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-environment-management-azd-env">üåç Environment management (azd env)<a href="https://luke.geek.nz/azure/azure-developer-cli/#-environment-management-azd-env" class="hash-link" aria-label="Direct link to üåç Environment management (azd env)" title="Direct link to üåç Environment management (azd env)">‚Äã</a></h3>
<p>Now we have a fully deployed application using <code>and up</code> let's discuss environment management.</p>
<p><code>azd env</code> is a command that allows you to manage your environments. You can create, list, delete, and switch between environments using this command, so you can easily manage different environments, such as development, staging, and production, without affecting each one.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Manage your application environments. With this command group, you can create a new environment or get, set, and list your application environments.</p><p>‚Ä¢ An Application can have multiple environments (ex: dev, test, prod).
‚Ä¢ Each environment may have a different configuration (that is, connectivity information) for accessing Azure resources.
‚Ä¢ You can find all environment configurations under the <code>.azure/&lt;environment-name&gt;</code> folder.
‚Ä¢ The environment name is stored as the AZURE_ENV_NAME environment variable in the <code>.azure/&lt;environment-name&gt;/.env</code> file.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Usage</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  azd env [command]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Available Commands</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  get-value     : Get specific environment value.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  get-values    : Get all environment values.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  list          : List environments.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  new           : Create a new environment and set it as the default.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  refresh       : Refresh environment settings by using information from a previous infrastructure provision.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  select        : Set the default environment.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  set           : Manage your environment settings.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  set-secret    : Set a &lt;name&gt; as a reference to a Key Vault secret in the environment.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Global Flags</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    -C, --cwd string    : Sets the current working directory.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        --debug         : Enables debugging and diagnostics logging.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        --docs          : Opens the documentation for azd env in your web browser.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    -h, --help          : Gets help for env.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        --no-prompt     : Accepts the default value instead of prompting, or it fails if there is no default.</span><br></span></code></pre></div></div></div></div>
<p>The first thing we can do is the environment variables of our environments by running <code>azd env get-values</code>.</p>
<p>This will output the environment variables; each solution may be different, but common values are AZURE_ENV_NAME and AZURE_LOCATION.</p>
<p><img decoding="async" loading="lazy" alt="azd env get-values" src="https://luke.geek.nz/assets/images/demo-azdgetenvvalues-ebbafef556f277b4056b0951be140065.gif" width="1903" height="947" class="img_ev3q"></p>
<p>These values are also stored in the <code>.azure/&lt;environment-name&gt;/.env</code> file.</p>
<p>So we have an environment named: testdeploy, lets see if we can create a new environment, and switch to it.</p>
<p><img decoding="async" loading="lazy" alt="azd env new" src="https://luke.geek.nz/assets/images/demo-azdcreateenv-8bf0f434b75d1ffd20c64652ace59085.gif" width="1903" height="947" class="img_ev3q"></p>
<p>Now you can manage multiple environments of your application and switch between them easily, each one treated separately in terms of the values that are set, so dev could be in another region, or you could do something like this:</p>
<p><img decoding="async" loading="lazy" alt="azd env select" src="https://luke.geek.nz/assets/images/demo-azdcreateenvvalues-f1be26ba342283d4ae929e24557c802d.gif" width="1903" height="947" class="img_ev3q"></p>
<p>It's pretty basic, and the TagENV variable, you could just pull out by using the environmentName variable in Bicep <em>(take a look at the main.parameters.json)</em>, but it shows you how you can manage different environments, and the values that are set for them.</p>
<p>Multiple environments can be useful for testing, for different regions, or for different stages of the development lifecycle, particularly when looking at having multiple environments for a CI/CD pipeline, so dev, test, staging, production, and and up can be used to deploy to these environments. I have run into scenarios where I have deployed something with an old configuration that started to get used by a team while I continued to work on new configuration and settings - having multiple environments allowed me to leave the old one untouched while I worked on a new environment</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-monitoring-azd-monitor">üìä Monitoring (azd monitor)<a href="https://luke.geek.nz/azure/azure-developer-cli/#-monitoring-azd-monitor" class="hash-link" aria-label="Direct link to üìä Monitoring (azd monitor)" title="Direct link to üìä Monitoring (azd monitor)">‚Äã</a></h3>
<p>To be fair - this isn't one I've used much, but it is a useful command to know about.</p>
<p><code>azd monitor</code> is a command that allows you to monitor your application. You can view logs, metrics, and other monitoring data using this command, so you can easily monitor the health and performance of your application by utilizing <a href="https://learn.microsoft.com/en-us/azure/azure-monitor/app/overview-dashboard?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Application Insights dashboards</a>.</p>
<table><thead><tr><th>Dashboard Type</th><th>Command</th></tr></thead><tbody><tr><td>Main dashboard</td><td><code>azd monitor --overview</code></td></tr><tr><td>Live metrics</td><td><code>azd monitor --live</code></td></tr><tr><td>Logs dashboard</td><td><code>azd monitor --logs</code></td></tr></tbody></table>
<p>These commands will open the respective dashboards in your default web browser, making it easy to monitor your application's performance and health.</p>
<p>Let us take a brief look after I switched back to my testdeploy environment:</p>
<p><img decoding="async" loading="lazy" alt="azd monitor" src="https://luke.geek.nz/assets/images/demo-azdmonitor-6228fa10500517ed6579e6734f441dee.gif" width="1903" height="947" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-destroying-resources-azd-down">‚¨áÔ∏è Destroying resources (azd down)<a href="https://luke.geek.nz/azure/azure-developer-cli/#%EF%B8%8F-destroying-resources-azd-down" class="hash-link" aria-label="Direct link to ‚¨áÔ∏è Destroying resources (azd down)" title="Direct link to ‚¨áÔ∏è Destroying resources (azd down)">‚Äã</a></h3>
<p>Now that we have deployed and monitored our application, we can destroy the resources using the <code>azd down</code> command.</p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>Before using the azd down command, make sure you have backed up any data or config that you need, as this command will delete all resources deployed with AZD and anything inside of the Resource Group that was deployed by AZD initially.</p></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>A few Azure resources, such as Azure OpenAI, Azure API Management, and Key Vault, are not entirely deleted when you run <code>azd down</code>. You can delete these resources by running `azd down --purge to remove purge them from a soft-delete state altogether; you may want to do this if you are recreating the same resources with the same names consistently and don't want to have Bicep reinstate these resources for you.</p></div></div>
<p><img decoding="async" loading="lazy" alt="azd down" src="https://luke.geek.nz/assets/images/demo-azddown-2d5ebed692ae1f7bae2c2bf55538c1ef.gif" width="1903" height="947" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-cicd-integration">üîÑ CI/CD Integration<a href="https://luke.geek.nz/azure/azure-developer-cli/#-cicd-integration" class="hash-link" aria-label="Direct link to üîÑ CI/CD Integration" title="Direct link to üîÑ CI/CD Integration">‚Äã</a></h2>
<p>Now, you might have a scenario where you want to integrate the Azure Developer CLI <em>(azd)</em> into your CI/CD pipeline so you can automate the deployment of your applications to Azure, especially in a team or collaborative environment.</p>
<p>And its doable, there are a few ways to do this, and I will cover the out of the box one first, this will work for both Azure DevOps pipelines or GitHub Actions.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Manage integrating your application with deployment pipelines. (Beta)</p><p>‚Ä¢ azd commands (e.g., provision, deploy) can be used within GitHub Actions and Azure Pipelines to test your code against real Azure resources and facilitate deployments.
‚Ä¢ After creating a pipeline definition file, running pipeline config will help configure your deployment pipeline to connect securely to Azure.
‚Ä¢ For more information on how to use azd in your pipeline, go to: <a href="https://aka.ms/azure-dev/pipeline" target="_blank" rel="noopener noreferrer">https://aka.ms/azure-dev/pipeline</a>.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Usage</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  azd pipeline [command]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Available Commands</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  config        : Configure your deployment pipeline to connect securely to Azure. (Beta)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Global Flags</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    -C, --cwd string    : Sets the current working directory.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        --debug         : Enables debugging and diagnostics logging.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        --docs          : Opens the documentation for azd pipeline in your web browser.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    -h, --help          : Gets help for pipeline.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        --no-prompt     : Accepts the default value instead of prompting, or it fails if there is no default.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Use azd pipeline [command] --help to view examples and more information about a specific command.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Examples</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  Walk through the steps required to set up your deployment pipeline.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    azd pipeline config</span><br></span></code></pre></div></div></div></div>
<p><img decoding="async" loading="lazy" alt="azd pipeline config" src="https://luke.geek.nz/assets/images/demo-pipelineconfig-01e5bbfda3147d3ab18b84b4fed589b7.gif" width="1903" height="947" class="img_ev3q"></p>
<p>Forgive the stop; my pre-commit file prevented it from actually committing the code, but hopefully, it was enough to show you how to configure the pipeline and link it directly into GitHub with Azure Developer CLI doing a lot of the heavy lifting for you.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>When working with multiple environments, it requires some tweaking to the GitHub Actions.</p><p>I am not going to re-invent the wheel here; there is some great documentation by <a href="https://www.linkedin.com/in/jasontaylordev/" target="_blank" rel="noopener noreferrer">Jason Taylor</a>, Microsoft Azure MVP from Australia, that I have personally used to deploy to multiple environments, and it is a great resource to get started with: <a href="https://github.com/jasontaylordev/todo-aspnetcore-csharp-sqlite/blob/main/OPTIONAL_FEATURES.md" target="_blank" rel="noopener noreferrer">Support multiple environments</a>. Jason also recently did a video to the Microsoft Azure Cloud Commanders Learning Room: <a href="https://youtu.be/e6K2EuVfgWE" target="_blank" rel="noopener noreferrer">Speedrunning Code to Cloud with the Azure Developer CLI (azd) with Jason Taylor</a>.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-tips-and-tricks">üí° Tips and Tricks<a href="https://luke.geek.nz/azure/azure-developer-cli/#-tips-and-tricks" class="hash-link" aria-label="Direct link to üí° Tips and Tricks" title="Direct link to üí° Tips and Tricks">‚Äã</a></h2>
<p>Just finishing off with some tips and tricks:</p>
<ul>
<li>Make use of the <a href="https://learn.microsoft.com/azure/developer/azure-developer-cli/azd-extensibility?WT.mc_id=AZ-MVP-5004796#available-hooks" target="_blank" rel="noopener noreferrer">azuredeveloper cli hooks</a>, to run scripts and custom actions on post, predeploy. Refer to my article <a href="https://luke.geek.nz/azure/staticwebapp-azd-environment-variables/" target="_blank" rel="noopener noreferrer">Managing Environment Variables in Azure Static Web Apps with Azure Developer CLI</a> for some guidance on how I have used this.</li>
<li>Use Templates, as mentioned earlier, the <a href="https://azure.github.io/awesome-azd/" target="_blank" rel="noopener noreferrer">Awesome AZD</a> gallery is a great resource to find templates to get you started and AI orientated workloads, you can also refer to the <a href="https://azure.github.io/ai-app-templates/" target="_blank" rel="noopener noreferrer">ai-app-template gallery</a>.</li>
<li>There is a issue and PR being worked on, to update alot of the templates with <a href="https://azure.github.io/Azure-Verified-Modules/" target="_blank" rel="noopener noreferrer">AVM <em>(Azure Verified Module)</em></a> templates, but it hasn't been completed yet, so feel free to replace or add in your own modules and create your own AZD template! Start from your application code and build it out from there by testing the deployment with AZD to an Azure Function or Container App.</li>
<li>Keep an eye on the Pull Requests and <a href="https://github.com/Azure/azure-dev/" target="_blank" rel="noopener noreferrer">GitHub repo</a> for the latest updates and changes, and join in on the latest <a href="https://github.com/Azure/azure-dev/discussions" target="_blank" rel="noopener noreferrer">discussions and community calls</a>.</li>
</ul>
<p>Hopefully, this has given you enough of a view of some of the great functionality of Azure Developer CLI (azd) and how you can use it to deploy your applications to Azure and innovate and learn quickly.</p>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[How Microsoft Releases Changes to Azure - Safe Deployment]]></title>
            <link>https://luke.geek.nz/azure/azure-platform-release-process/</link>
            <guid>https://luke.geek.nz/azure/azure-platform-release-process/</guid>
            <pubDate>Tue, 28 Jan 2025 06:32:57 GMT</pubDate>
            <description><![CDATA[Learn how Microsoft implements changes daily across Azure using safe deployment practices, quality gates, and automated processes.]]></description>
            <content:encoded><![CDATA[<p>Today, we will touch on how Microsoft releases changes globally across the Microsoft Azure ecosystem. It always amazes me how Microsoft can release changes daily across Azure without customers noticing <em>(the majority of the time)</em>, yet they benefit from new capabilities swiftly.</p>
<p>Microsoft has implemented several quality stages for Azure, and they are continuously enhancing platform automation and processes to ensure Azure service changes have zero impact on customer workloads. Let's take a look at how Microsoft is achieving this.</p>
<blockquote>
<p>Would you like to know how Azure releases changes to Production while maintaining high Quality and Agility? Azure implements hundreds of changes daily without customers noticing, yet they benefit from new capabilities swiftly. You can learn about the quality stages for Azure and how they are learning to help ensure Microsoft continuously enhances platform automation and processes to ensure Azure service changes have zero impact on customer workloads.</p>
</blockquote>
<!-- -->
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-azure-well-architected-framework-integration">üéØ Azure Well-Architected Framework Integration<a href="https://luke.geek.nz/azure/azure-platform-release-process/#-azure-well-architected-framework-integration" class="hash-link" aria-label="Direct link to üéØ Azure Well-Architected Framework Integration" title="Direct link to üéØ Azure Well-Architected Framework Integration">‚Äã</a></h2>
<p>The Well-Architected Framework has an entire pillar dedicated to <a href="https://learn.microsoft.com/azure/well-architected/reliability/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Reliability</a> and <a href="https://learn.microsoft.com/azure/well-architected/operational-excellence/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Operational excellence</a>, so let us take a look at how these pillars are adapted to work with the deployment of core Azure platform and service deployments, along with elements of <a href="https://learn.microsoft.com/devops/operate/safe-deployment-practices?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">safe deployment practices</a> that are used to deploy Azure services/payloads at a global scale.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-azure-investment-pillars">üèóÔ∏è Azure Investment Pillars<a href="https://luke.geek.nz/azure/azure-platform-release-process/#%EF%B8%8F-azure-investment-pillars" class="hash-link" aria-label="Direct link to üèóÔ∏è Azure Investment Pillars" title="Direct link to üèóÔ∏è Azure Investment Pillars">‚Äã</a></h2>
<p><img decoding="async" loading="lazy" alt="Azure Investments" src="https://luke.geek.nz/assets/images/Azure_SDPInvestment-952dcf94477a589a4bb62026a985d887.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Let's take a look at the aspiration that Microsoft has with the Azure ecosystem and how they are working to ensure that they can deliver changes to the platform without impacting customers, with the aspiration of '0 changes impact production, and they cause 0 outages' as a north star.</p>
<p>To get there, Microsoft is working on a number of key areas, including the following investment pillars:</p>
<ul>
<li>Secure platform</li>
<li>Service health</li>
<li>Change management</li>
<li>Incident management</li>
<li>Supportability</li>
<li>Customer resiliency</li>
<li>Platform resiliency</li>
<li>Capacity management</li>
</ul>
<p><img decoding="async" loading="lazy" alt="Azure Investments" src="https://luke.geek.nz/assets/images/Azure_SDPQualitryPillars-814a549cc6da3a93412115f96488d7ba.PNG" width="4000" height="2250" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-safe-deployment-practices">üõ°Ô∏è Safe Deployment Practices<a href="https://luke.geek.nz/azure/azure-platform-release-process/#%EF%B8%8F-safe-deployment-practices" class="hash-link" aria-label="Direct link to üõ°Ô∏è Safe Deployment Practices" title="Direct link to üõ°Ô∏è Safe Deployment Practices">‚Äã</a></h2>
<p>Lets take a look at how the <a href="https://learn.microsoft.com/devops/operate/safe-deployment-practices?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">safe deployment practices</a> work in the context of the Azure platform, and how they are used to ensure that changes are deployed safely and securely, with 3 key areas of focus:</p>
<ul>
<li>Prevention</li>
<li>Protection</li>
<li>Learn and refine</li>
</ul>
<p><img decoding="async" loading="lazy" alt="Azure Investments" src="https://luke.geek.nz/assets/images/Azure_SDP-64627798b54725fb6834f269919f44da.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Prevention is about:</p>
<ul>
<li>Testing in Production in isolation, with continuous representative workloads and scenarios.&nbsp;</li>
<li>Having Additional Health gates, pre-deployment reviews, and a Bill of Quality.</li>
<li>Utilising Canary regions for at-scale pre-prod full E2E validations.</li>
<li>Having increased scenario coverage through health integrated synthetics and representative workloads.</li>
</ul>
<p>Protection is about:</p>
<ul>
<li>Progressive deployments orchestrated by standard tools with adaptable policies and multilayer gating.</li>
<li>Speed of deployment gated (speed, stops) by risk and health signals.</li>
<li>Multilayer health monitoring integrated for real-time stops and rollbacks.</li>
<li>Central correlation and analysis of aggregated health signals.</li>
<li>Short- and long-range anomaly detection that leverages ML models.</li>
<li>Real-time impact monitoring.</li>
</ul>
<p>Learn and refine is about:</p>
<ul>
<li>Continuous refinement and additions of <a href="https://learn.microsoft.com/azure/well-architected/design-guides/health-modeling?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">health signals/SLIs/SLOs</a>.</li>
<li>Learnings from the smallest outages drive repairs towards minimizing the time for self-detection in pre-prod.</li>
<li>Enrichment of synthetics shared tests. Injection of gating signals from synthetics and customers.</li>
<li>Ongoing ML refinements with increased cross-service signals.</li>
</ul>
<p>These areas of focus help to define rollout systems and processes that are used to ensure that changes are deployed safely and securely, with the ability to roll back changes if they are not successful, emphasizing quality and ready-to-deploy validation steps.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-quality-gates-and-release-process">üéØ Quality Gates and Release Process<a href="https://luke.geek.nz/azure/azure-platform-release-process/#-quality-gates-and-release-process" class="hash-link" aria-label="Direct link to üéØ Quality Gates and Release Process" title="Direct link to üéØ Quality Gates and Release Process">‚Äã</a></h2>
<p><img decoding="async" loading="lazy" alt="Azure Release quality gates" src="https://luke.geek.nz/assets/images/Azure_SDPQualityGates-634e3f439e553e996779cee8c43757a6.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Once the quality gates and processes, the rollout of the payload occurs across Canary <em>(no Production workloads)</em>, Pilot regions, Medium and large before being deployed further to the rest of the areas, with 24-hour 'bake time' before each deployment, with the ability to rollback changes if they are not successful, and the processes and quality gates are started again.</p>
<p><img decoding="async" loading="lazy" alt="Azure Release stages" src="https://luke.geek.nz/assets/images/Azure_SDPQualityGatesRelease-5478538a6300f62e47b6f5ce628b100e.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="Azure Release triggers" src="https://luke.geek.nz/assets/images/AzureSDP_Triggers-7913446967d75c1fbbbefaea2e043606.png" width="1504" height="1627" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-references">üìö References<a href="https://luke.geek.nz/azure/azure-platform-release-process/#-references" class="hash-link" aria-label="Direct link to üìö References" title="Direct link to üìö References">‚Äã</a></h2>
<ul>
<li><a href="https://devblogs.microsoft.com/devops/configuring-your-release-pipelines-for-safe-deployments/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Configuring your release pipelines for safe deployments</a></li>
<li><a href="https://ignite.microsoft.com/en-US/sessions/BRK243" target="_blank" rel="noopener noreferrer">How Microsoft Azure ensures high-Quality releases with Agility</a></li>
<li><a href="https://learn.microsoft.com/azure/architecture/reference-architectures/containers/aks-mission-critical/mission-critical-deploy-test?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Deployment and testing for mission-critical workloads on Azure</a></li>
<li><a href="https://azure.microsoft.com/blog/advancing-safe-deployment-practices/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Advancing safe deployment practices</a></li>
</ul>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Managing Environment Variables in Azure Static Web Apps with Azure Developer CLI]]></title>
            <link>https://luke.geek.nz/azure/staticwebapp-azd-environment-variables/</link>
            <guid>https://luke.geek.nz/azure/staticwebapp-azd-environment-variables/</guid>
            <pubDate>Wed, 22 Jan 2025 05:02:57 GMT</pubDate>
            <description><![CDATA[Managing Environment Variables in Azure Static Web Apps with Azure Developer CLI]]></description>
            <content:encoded><![CDATA[<p>The <a href="https://learn.microsoft.com/azure/developer/azure-developer-cli/overview?tabs=windows&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Developer CLI (azd)</a> is an open-source tool that accelerates provisioning and deploying app resources on Azure, it is great for deploying resources quickly and easily - especially in a proof of concept, or rapid innovation scenario.</p>
<p>One of the resources you can deploy <em>(both Infrastructure and Application)</em> is a <a href="https://learn.microsoft.com/azure/static-web-apps/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Static Web App</a> recently, I ran into an issue where I was deploying a backend <a href="https://learn.microsoft.com/azure/azure-functions/functions-overview?pivots=programming-language-python&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Function</a>, and I needed a react web application front end hosted on the Azure Static WebApp to pull the function app URL and function key from the runtime environment variables, and quickly realized that React does not support runtime environment variables - only build-time environment variables.</p>
<!-- -->
<p>It makes a bit of sense when you step back - React is a front-end framework, and the environment variables are injected at build time, so the front end can be built with the correct values, especially for a static web app - that isn't dynamically generated at runtime.</p>
<blockquote>
<p><a href="https://create-react-app.dev/docs/adding-custom-environment-variables/" target="_blank" rel="noopener noreferrer">Adding Custom Environment Variables</a>. The environment variables are embedded during the build time. Since Create React App produces a static HTML/CSS/JS bundle, it can‚Äôt possibly read them at runtime. To read them at runtime, you would need to load HTML into memory on the server and replace placeholders in runtime, as <a href="https://create-react-app.dev/docs/title-and-meta-tags#injecting-data-from-the-server-into-the-page" target="_blank" rel="noopener noreferrer">described here</a>. Alternatively you can rebuild the app on the server anytime you change them.</p>
</blockquote>
<p>So, if that is the case, how can I get the Azure Function URL and Function Key into the React front end? When the name of the function app, and the Static WebApp are dynamically created each time I deploy?</p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>The method below leaves the endpoint and key in the source code, which is not recommended for production applications. Please look at other forms of authentication to a backend API service, such as the built-in <a href="https://learn.microsoft.com/azure/static-web-apps/apis-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Static API support</a>.</p></div></div>
<p>To get around the limitation of the dynamic variables, I made use of the <a href="https://learn.microsoft.com/azure/developer/azure-developer-cli/overview?tabs=windows&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Developer CLI (azd)</a> postdeploy feature, which allows you to run a script after a deployment has completed.</p>
<p>My setup looks like this:</p>
<!-- -->
<p>Essentially, once the API <em>(Python)</em> has been deployed, Azure Developer CLI will run an update_env.sh script, which will update the React <code>.env.production</code> file with the correct values for the Azure Function URL and Function Key.</p>
<p>So my azure.yaml file looks like this:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token key atrule">services</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">api</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">project</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ./src/api</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">language</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> python</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">host</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> function</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">hooks</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">postdeploy</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">posix</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">shell</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> sh</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">run</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ../../hooks/update_env.sh</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">interactive</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">continueOnError</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">false</span><br></span></code></pre></div></div>
<p>And inside my update_env.sh script, I have the following:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token shebang important">#!/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">set</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-e</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Fetch the Function App name and Resource Group from azd environment</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">AZD_VALUES</span><span class="token operator">=</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">azd </span><span class="token variable function" style="color:rgb(80, 250, 123);font-style:italic">env</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> get-values </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--output</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> json</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"AZD_VALUES: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$AZD_VALUES</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">FUNCTION_APP_NAME</span><span class="token operator">=</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token variable builtin class-name" style="color:rgb(189, 147, 249);font-style:italic">echo</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> $AZD_VALUES </span><span class="token variable operator" style="color:rgb(189, 147, 249);font-style:italic">|</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> jq </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-r</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">'.AZURE_FUNCTION_NAME'</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">RESOURCE_GROUP</span><span class="token operator">=</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token variable builtin class-name" style="color:rgb(189, 147, 249);font-style:italic">echo</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> $AZD_VALUES </span><span class="token variable operator" style="color:rgb(189, 147, 249);font-style:italic">|</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> jq </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-r</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">'.AZURE_RESOURCE_GROUP'</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">FUNCTION_APP_URL</span><span class="token operator">=</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token variable builtin class-name" style="color:rgb(189, 147, 249);font-style:italic">echo</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> $AZD_VALUES </span><span class="token variable operator" style="color:rgb(189, 147, 249);font-style:italic">|</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> jq </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-r</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">'.AZURE_FUNCTION_URI'</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Function App Name: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$FUNCTION_APP_NAME</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Resource Group: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$RESOURCE_GROUP</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Get the Function App URL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Function App URL: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$FUNCTION_APP_URL</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Get the Function App key</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">FUNCTION_APP_KEY</span><span class="token operator">=</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">az functionapp keys list </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--name</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> $FUNCTION_APP_NAME --resource-group $RESOURCE_GROUP </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--query</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> functionKeys.default </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-o</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> tsv</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Function App Key: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$FUNCTION_APP_KEY</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Update the .env.production file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">sed</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-i</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"s|^REACT_APP_API_URL=.*|REACT_APP_API_URL=</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$FUNCTION_APP_URL</span><span class="token string" style="color:rgb(255, 121, 198)">/api|"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">/web/.env.production</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Function App Name: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$FUNCTION_APP_NAME</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Resource Group: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$RESOURCE_GROUP</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Function App URL: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$FUNCTION_APP_URL</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><br></span></code></pre></div></div>
<p>To utilize the script, I need to make sure I am authenticated to Azure <em>(az login)</em> and the script runs as part of my deployment.</p>
<p>I also made sure I was outputting the Resource Group, FunctionApp name etc as part of my main.bicep file, so it was able to be picked up by the Azure Developer CLI variables.</p>
<p>Then, after the script ran and the <code>.env.production</code> file updated, Azure Developer CLI was able to continue on to the second part of my deployment - building the React website and then deploying it to the Azure Static WebApp.</p>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[PowerShell based Terraform Bootstrap Script]]></title>
            <link>https://luke.geek.nz/azure/powershell-terraform-bootstrap/</link>
            <guid>https://luke.geek.nz/azure/powershell-terraform-bootstrap/</guid>
            <pubDate>Mon, 13 Jan 2025 07:44:51 GMT</pubDate>
            <description><![CDATA[Create a PowerShell script to bootstrap Terraform, handle installation, create project directories, and automate deployments across Windows, Mac, and Linux.]]></description>
            <content:encoded><![CDATA[<p>Today, we will implement a Terraform bootstrap script that will install Terraform and create directories where we can place our Terraform project, which will then run a plan against and deploy. This script will be written in PowerShell to bootstrap a new Terraform project.</p>
<blockquote>
<p>"Bootstrapping usually refers to a self-starting process that is supposed to continue or grow without external input. Many analytical techniques are often called bootstrap methods in reference to their self-starting or self-supporting implementation" ~ Wikipedia.</p>
</blockquote>
<!-- -->
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-script-overview">üìú Script Overview<a href="https://luke.geek.nz/azure/powershell-terraform-bootstrap/#-script-overview" class="hash-link" aria-label="Direct link to üìú Script Overview" title="Direct link to üìú Script Overview">‚Äã</a></h2>
<p>Inspired by the <a href="https://github.com/Azure/ALZ-PowerShell-Module" target="_blank" rel="noopener noreferrer">ALZ Accelerator</a> bootstrap script, this script will:</p>
<ol>
<li>Install-Terraform</li>
</ol>
<ul>
<li>Downloads and installs Terraform if not present</li>
<li>Handles version management</li>
<li>Supports Windows/Mac/Linux detection</li>
<li>Adds Terraform to PATH</li>
</ul>
<ol start="2">
<li>Creates required directories (config and output)</li>
</ol>
<ul>
<li>Copies *.tf and *.tfvars files from config to output</li>
<li>Validate file contents and paths</li>
</ul>
<ol start="3">
<li>Invoke-Terraform</li>
</ol>
<ul>
<li>Initializes Terraform</li>
<li>Creates execution plan</li>
<li>Handles apply/destroy with optional auto-approve</li>
<li>Manages working directory context</li>
</ul>
<p>And I've tested it on my Windows 11 machine and a Linux Codespace. In my examples, I am using it to run some base Terraform to deploy a new Resource Group and Storage Account in the New Zealand North Azure region.</p>
<p><img decoding="async" loading="lazy" alt="Run Terraform Bootstrap" src="https://luke.geek.nz/assets/images/RunTerraformBootstrap-57814cc7df3c255170503607d3efea0f.gif" width="1276" height="1014" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>You could also look at turning it into an executable using something like <a href="https://github.com/MScholtes/PS2EXE" target="_blank" rel="noopener noreferrer">PS2EXE</a>, and then you can run it like any other executable, as below:</p><p><img decoding="async" loading="lazy" alt="Run Terraform Bootstrap Executable" src="https://luke.geek.nz/assets/images/TerraformBootstrapExecutable-118418eb84a2c4e5b59ac51750d41789.gif" width="1354" height="749" class="img_ev3q"></p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-prerequisites">üìã Prerequisites<a href="https://luke.geek.nz/azure/powershell-terraform-bootstrap/#-prerequisites" class="hash-link" aria-label="Direct link to üìã Prerequisites" title="Direct link to üìã Prerequisites">‚Äã</a></h2>
<ul>
<li><a href="https://learn.microsoft.com/powershell/scripting/install/installing-powershell?view=powershell-7.4&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">PowerShell</a> 5.1 or PowerShell Core 6.0+</li>
<li>Internet connectivity for downloading <a href="https://www.terraform.io/" target="_blank" rel="noopener noreferrer">Terraform</a></li>
<li><a href="https://learn.microsoft.com/cli/azure/install-azure-cli?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure CLI</a> is installed and logged in (<code>az login</code>). It is only required if deploying to <a href="https://learn.microsoft.com/azure/developer/terraform/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Microsoft Azure</a>.</li>
<li>Write permissions to the directory where you'll run the script</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-usage-examples">üéØ Usage Examples<a href="https://luke.geek.nz/azure/powershell-terraform-bootstrap/#-usage-examples" class="hash-link" aria-label="Direct link to üéØ Usage Examples" title="Direct link to üéØ Usage Examples">‚Äã</a></h2>
<p>Basic usage with default parameters:</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">\Terraform-Bootstrap</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ps1</span><br></span></code></pre></div></div>
<p>Custom paths and auto-approved apply:</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">\Terraform-Bootstrap</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ps1 </span><span class="token operator">-</span><span class="token plain">terraformPath </span><span class="token string" style="color:rgb(255, 121, 198)">"C:\terraform"</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">configPath </span><span class="token string" style="color:rgb(255, 121, 198)">"C:\tf-configs"</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">outputPath </span><span class="token string" style="color:rgb(255, 121, 198)">"C:\tf-output"</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">autoApprove</span><br></span></code></pre></div></div>
<p>Using a specific Terraform version:</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">\Terraform-Bootstrap</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ps1 </span><span class="token operator">-</span><span class="token plain">terraformPath </span><span class="token string" style="color:rgb(255, 121, 198)">"C:\terraform"</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">configPath </span><span class="token string" style="color:rgb(255, 121, 198)">"C:\tf-configs"</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">outputPath </span><span class="token string" style="color:rgb(255, 121, 198)">"C:\tf-output"</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-powershell-script">üíª PowerShell Script<a href="https://luke.geek.nz/azure/powershell-terraform-bootstrap/#-powershell-script" class="hash-link" aria-label="Direct link to üíª PowerShell Script" title="Direct link to üíª PowerShell Script">‚Äã</a></h2>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_OeMC">Terraform-Bootstrap.ps1</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">&lt;#</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    .SYNOPSIS</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    Bootstraps Terraform environment and runs specified Terraform commands.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    .DESCRIPTION</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    This script ensures Terraform is installed, sets up the Terraform workspace, and runs specified Terraform commands.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    It supports downloading the latest version of Terraform, creating necessary directories, and copying configuration files.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    The script is intended to be used to bootstrap Terraform environments for testing and development purposes and once-off deployments of any code in the Config directory.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    .NOTES</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    Version:        1.0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    Author:         luke.geek.nz</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    Creation Date:  10/01/25</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    Purpose/Change: </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    14/05/17 - Initial script creation</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    .PARAMETER terraformPath</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    The path where Terraform will be installed.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    .PARAMETER terraformVersion</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    The version of Terraform to install. Defaults to "latest".</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    .PARAMETER configPath</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    The path to the directory containing Terraform configuration files.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    .PARAMETER outputPath</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    The path to the directory where Terraform will be executed.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    .PARAMETER autoApprove</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    Automatically approve Terraform apply and destroy actions.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    .EXAMPLE</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    .\Terraform-Bootstrap.ps1 -terraformPath ".\terraform" -terraformVersion "latest" -configPath ".\config" -outputPath ".\output"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">#&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token namespace">[CmdletBinding()]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token namespace">[Parameter(Mandatory = $false)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token namespace">[string]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$terraformPath</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">".\terraform"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token namespace">[Parameter(Mandatory = $false)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token namespace">[string]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$terraformVersion</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"latest"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token namespace">[Parameter(Mandatory = $false)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token namespace">[string]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$configPath</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">".\config"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token namespace">[Parameter(Mandatory = $false)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token namespace">[string]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$outputPath</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">".\output"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token namespace">[Parameter(Mandatory = $false)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token namespace">[switch]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$autoApprove</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Function to ensure Terraform is installed</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Install-Terraform</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[string]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$version</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[string]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$path</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Get latest version if not specified</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$version</span><span class="token plain"> </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"latest"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$versionResponse</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Invoke-WebRequest</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Uri </span><span class="token string" style="color:rgb(255, 121, 198)">"https://checkpoint-api.hashicorp.com/v1/check/terraform"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$version</span><span class="token plain"> = </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$versionResponse</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Content </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">ConvertFrom-Json</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Select-Object</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ExpandProperty current_version</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Check if Terraform is already installed</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$tfCommand</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-Command</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name terraform </span><span class="token operator">-</span><span class="token plain">ErrorAction SilentlyContinue</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$tfCommand</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Verbose</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Terraform already installed at </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$tfCommand</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Path</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Create tools directory</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">!</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token function" style="color:rgb(80, 250, 123)">Test-Path</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$path</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">New-Item</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ItemType Directory </span><span class="token operator">-</span><span class="token plain">Path </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$path</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Out-Null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Download and extract Terraform</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$os</span><span class="token plain"> = </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$IsWindows</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"windows"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$IsMacOS</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"darwin"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"linux"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$arch</span><span class="token plain"> = </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token namespace">[System.Environment]</span><span class="token plain">::Is64BitOperatingSystem</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"amd64"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"386"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$url</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"https://releases.hashicorp.com/terraform/</span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$version</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">/terraform_</span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$version</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">_${os}_${arch}.zip"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$zipFile</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Join-Path</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$path</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"terraform.zip"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$extractPath</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Join-Path</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$path</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"terraform_</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$version</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Verbose</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Downloading Terraform from </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$url</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Invoke-WebRequest</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Uri </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$url</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">OutFile </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$zipFile</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Verbose</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Extracting Terraform to </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$extractPath</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Expand-Archive</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Path </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$zipFile</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">DestinationPath </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$extractPath</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Force</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Remove-Item</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$zipFile</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Add to PATH</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$env</span><span class="token plain">:PATH = </span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$extractPath</span><span class="token string" style="color:rgb(255, 121, 198)">;</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$env</span><span class="token string" style="color:rgb(255, 121, 198)">:PATH"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Function to run Terraform commands</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Invoke-Terraform</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[string]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$workingDirectory</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[string]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$command</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[switch]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$autoApprove</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Push-Location</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$workingDirectory</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">try</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Initialize</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Initializing Terraform..."</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ForegroundColor Green</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        terraform init</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Run specified command</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Running terraform </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$command</span><span class="token string" style="color:rgb(255, 121, 198)">..."</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ForegroundColor Green</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$command</span><span class="token plain"> </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"apply"</span><span class="token plain"> </span><span class="token operator">-or</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$command</span><span class="token plain"> </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"destroy"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            terraform plan </span><span class="token operator">-</span><span class="token plain">out=tfplan</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">!</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$autoApprove</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$confirmation</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Read-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Do you want to proceed with terraform </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$command</span><span class="token string" style="color:rgb(255, 121, 198)">? (y/n)"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$confirmation</span><span class="token plain"> </span><span class="token operator">-ne</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'y'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Operation cancelled"</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ForegroundColor Yellow</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$command</span><span class="token plain"> </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"apply"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                terraform apply </span><span class="token operator">-</span><span class="token plain">auto-approve tfplan</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                terraform destroy </span><span class="token operator">-</span><span class="token plain">auto-approve</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            terraform </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$command</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">finally</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Pop-Location</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Main script</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">try</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Create required directories</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">!</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token function" style="color:rgb(80, 250, 123)">Test-Path</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$configPath</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">New-Item</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ItemType Directory </span><span class="token operator">-</span><span class="token plain">Path </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$configPath</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Force </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Out-Null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Config directory created at </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$configPath</span><span class="token string" style="color:rgb(255, 121, 198)">. Please place Terraform files into this directory and press any key to continue..."</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ForegroundColor Yellow</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Read-Host</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">!</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token function" style="color:rgb(80, 250, 123)">Test-Path</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$outputPath</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">New-Item</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ItemType Directory </span><span class="token operator">-</span><span class="token plain">Path </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$outputPath</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Force </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Out-Null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Install Terraform</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Ensuring Terraform is installed..."</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ForegroundColor Green</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Install-Terraform</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">version </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$terraformVersion</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">path </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$terraformPath</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Copy Terraform files from config to output directory</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Setting up Terraform workspace..."</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ForegroundColor Green</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Convert to absolute paths</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$configPathFull</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Resolve-Path</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$configPath</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ErrorAction Stop</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$outputPathFull</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Resolve-Path</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$outputPath</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ErrorAction Stop</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Verbose</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Config Path: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$configPathFull</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Verbose</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Output Path: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$outputPathFull</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$configFiles</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-ChildItem</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Path </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$configPathFull</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Recurse </span><span class="token operator">-</span><span class="token plain">File </span><span class="token operator">-</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">Filter</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"*.tf"</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ErrorAction Stop</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$varFiles</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-ChildItem</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Path </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$configPathFull</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Recurse </span><span class="token operator">-</span><span class="token plain">File </span><span class="token operator">-</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">Filter</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"*.tfvars"</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ErrorAction Stop</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Verbose</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Found </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$configFiles</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Count</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)"> .tf files"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">foreach</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$file</span><span class="token plain"> in </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$configFiles</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Verbose</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Processing file: </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$file</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">FullName</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Verify source file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">!</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token function" style="color:rgb(80, 250, 123)">Test-Path</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$file</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">FullName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Error</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Source file not found: </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$file</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">FullName</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">continue</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Check file content</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$content</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-Content</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$file</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">FullName </span><span class="token operator">-</span><span class="token plain">Raw</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token namespace">[string]</span><span class="token plain">::IsNullOrWhiteSpace</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$content</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Warning</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"File is empty: </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$file</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">FullName</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">continue</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Copying </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$file</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Name</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)"> to </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$outputPathFull</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ForegroundColor Green</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Copy-Item</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Path </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$file</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">FullName </span><span class="token operator">-</span><span class="token plain">Destination </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$outputPathFull</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Force</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Verify copy succeeded</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$destFile</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Join-Path</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$outputPathFull</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$file</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">!</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token function" style="color:rgb(80, 250, 123)">Test-Path</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$destFile</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Error</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Failed to copy file to: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$destFile</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">foreach</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$file</span><span class="token plain"> in </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$varFiles</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Verbose</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Processing var file: </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$file</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">FullName</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Copying </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$file</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Name</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)"> to </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$outputPathFull</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ForegroundColor Green</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Copy-Item</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Path </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$file</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">FullName </span><span class="token operator">-</span><span class="token plain">Destination </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$outputPathFull</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Force</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Run Terraform</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Running Terraform..."</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ForegroundColor Green</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Invoke-Terraform</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">workingDirectory </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$outputPath</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">command </span><span class="token string" style="color:rgb(255, 121, 198)">"apply"</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">autoApprove:</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$autoApprove</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Error</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Error occurred: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">exit</span><span class="token plain"> 1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre></div></div>
<p>This script can also be found on GitHub <a href="https://github.com/lukemurraynz/PowerOfTheShell/blob/master/Other/Terraform-Bootstrap.ps1" target="_blank" rel="noopener noreferrer">here</a>, if you wanted to fork, or open up a Pull Request with changes.</p>
<p>Hopefully this is useful for you, having a script like this means I can quickly deploy resources that are coded in Terraform <em>(HCL)</em>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-example-terraform-files">üìÇ Example Terraform Files<a href="https://luke.geek.nz/azure/powershell-terraform-bootstrap/#-example-terraform-files" class="hash-link" aria-label="Direct link to üìÇ Example Terraform Files" title="Direct link to üìÇ Example Terraform Files">‚Äã</a></h2>
<p>For those interested, here is the base Terraform code I am using in my example:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_OeMC">config/main.tf</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource </span><span class="token keyword type variable" style="color:rgb(189, 147, 249);font-style:italic">"azurerm_resource_group"</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"example"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token plain">     </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"example-stgaccount-rg"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">location</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"New Zealand North"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource </span><span class="token keyword type variable" style="color:rgb(189, 147, 249);font-style:italic">"azurerm_storage_account"</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"example"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token plain">                     </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"stgacctfboot1"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">resource_group_name</span><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> azurerm_resource_group.example.name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">location</span><span class="token plain">                 </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> azurerm_resource_group.example.location</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">account_tier</span><span class="token plain">             </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Standard"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">account_replication_type</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"LRS"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">tags</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">environment</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"staging"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre></div></div>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_OeMC">config/providers.tf</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">terraform</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">required_providers</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">azurerm</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">source</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"hashicorp/azurerm"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">version</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"4.15.0"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">provider</span><span class="token keyword type variable" style="color:rgb(189, 147, 249);font-style:italic"> "azurerm" </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">subscription_id</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"9dc6cc8c-5b10-403b-9a2f-5192497ca1ed"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">features</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre></div></div>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Product Development lifecycle]]></title>
            <link>https://luke.geek.nz/misc/product-development-lifecycle/</link>
            <guid>https://luke.geek.nz/misc/product-development-lifecycle/</guid>
            <pubDate>Fri, 10 Jan 2025 09:54:15 GMT</pubDate>
            <description><![CDATA[Learn about the stages of product development PoC, PoT, Prototype, MVP, and Pilot, and how to progress through the lifecycle gates.]]></description>
            <content:encoded><![CDATA[<p>PoC, PoT, Prototype, MVP, Pilot - what do they all mean? What is the difference between them, and when should you use them?</p>
<p>Today, we are going to take a look at a technical Cloud Product Development lifecycle - in my eyes, understanding these terminologies is key to determining:</p>
<ul>
<li>What kind of resources <em>(i.e., both technological and human)</em> do you need to dedicate to a product?</li>
<li>Where should you align lifecycle management with your application or service?</li>
<li>How likely is it that the the product makes a good market fit or solves an issue?</li>
<li>Keep your product lean to avoid wasting the wrong resources at the wrong time</li>
<li>Shift to a product-based mindset</li>
<li>Focus on innovation and early feedback loops</li>
</ul>
<p>And, of course - what to expect when people start using these words, often thrown together in a conversation and sometimes even put in writing in Statement of Works and Requests for Proposals.</p>
<!-- -->
<h1>üé® Design Thinking and Agile</h1>
<p>Using Design Thinking - <em>(Empathize, Define, Ideate, Prototype, Test, Implement)</em> as a base - a Product needs to align with actual customer needs; it's an iterative process, as a Product or service itself isn't static. We live in a VUCA (Volatile, Uncertain, Complex, Ambiguous) world, where customers expect more from their technology <em>(as they should)</em> to help empower their own needs securely and reliably.</p>
<p>Agile is about the speed to adapt, not the velocity to deliver, so if we take in Agile delivery and design thinking methodologies, it is no surprise that we need to break the product lifecycle into specific stages to get faster, more immediate feedback and make sure we are concentrating on the right success metrics for our product at the right time.</p>
<p><img decoding="async" loading="lazy" alt="Product Development Lifecycle" src="https://luke.geek.nz/assets/images/ProductDevelopmentLifecycle-7044f9dafc006db527e6e07d524f0b71.png" width="4000" height="2250" class="img_ev3q"></p>
<h1>üõ†Ô∏è Stages of Product Development Lifecycle</h1>
<p>If we break down these stages, we have:</p>
<table><thead><tr><th><strong>Stage</strong></th><th><strong>Description</strong></th><th><strong>Benefits</strong></th><th><strong>Acceptance Criteria</strong></th><th><strong>Resources Needed</strong></th><th><strong>Where Used</strong></th></tr></thead><tbody><tr><td>Ideate</td><td>Generate and prioritize potential solutions for the identified problem based on insights and feasibility.</td><td>Fosters creativity and provides a clear roadmap for experimentation and development.</td><td>Clear problem definition, prioritized ideas based on feasibility, impact, and alignment with user needs.</td><td>Innovation workshops, user interviews, brainstorming tools, and cross-functional collaboration.</td><td>At the beginning of any product development or improvement process.</td></tr><tr><td>PoT (Proof of Technology)</td><td>Validate the technical feasibility of a specific technology or approach without focusing on user needs or business value.</td><td>Establishes whether the technology is feasible and provides initial direction for further exploration.</td><td>Demonstrates core technical capabilities and resolves major uncertainties regarding technology.</td><td>Technical experts, test environments, access to research, and innovation workshops.</td><td>When exploring unproven or novel technologies before deeper investment in development.</td></tr><tr><td>PoC (Proof of Concept)</td><td>Proves that the proposed solution can solve a specific problem, aligning technology with business and user needs.</td><td>Validates alignment of the technology with the desired outcomes and de-risks the solution.</td><td>Demonstrates that the solution addresses the problem effectively under controlled conditions; stakeholder approval is achieved.</td><td>Business analysts, developers, user research teams, and small-scale testing environments.</td><td>Before seeking stakeholder buy-in or funding for further development.</td></tr><tr><td>MVP (Minimum Viable Product)</td><td>The product's first version with enough functionality to address core user needs and gather feedback.</td><td>Accelerates market entry, reduces time-to-value, and collects feedback to prioritize future improvements.</td><td>Achieves user adoption and gathers user engagement, satisfaction, and performance metrics.</td><td>Development teams, product managers, QA testers, analytics tools, and customer success teams.</td><td>To test market fit, validate assumptions, and inform scaling decisions.</td></tr><tr><td>Pilot</td><td>A limited-scale deployment in a controlled environment to test end-to-end viability and gather comprehensive feedback.</td><td>Identifies risks, operational issues, and unforeseen challenges before scaling to production.</td><td>Demonstrates success in a real-world environment; collects data to refine for production readiness.</td><td>End users, operational teams, real-world testing environments, customer support, and analytics tools.</td><td>When preparing for scaling and addressing operational risks.</td></tr><tr><td>Production</td><td>The full-scale product deployment with all necessary features, reliability, and support for end users.</td><td>Delivers the finalized solution to users while ensuring scalability, reliability, and operational efficiency.</td><td>Meets key performance indicators (KPIs), user satisfaction benchmarks, and operational SLAs (Service Level Agreements).</td><td>Development, operations, customer support, monitoring tools, and continuous improvement processes.</td><td>To deliver the product to users at scale with ongoing support and updates.</td></tr><tr><td>Continuous Improvement</td><td>Ongoing enhancement and optimization of the product based on user feedback, performance metrics, and market needs.</td><td>Ensures the product remains competitive, relevant, and user-friendly over time.</td><td>Demonstrates improvement in key metrics (e.g., adoption, satisfaction, performance); regular delivery of enhancements with minimal disruptions.</td><td>DevOps teams, user research, monitoring tools, and agile sprint cycles for regular updates.</td><td>Post-production phase to address evolving requirements and maintain product excellence.</td></tr><tr><td>Sunset</td><td>The planned decommissioning or replacement of the product when it no longer provides value or becomes obsolete.</td><td>Frees up resources for other priorities while ensuring users transition smoothly to alternatives.</td><td>Completion of decommissioning plan, including user migration, data archiving, and system shutdown with minimal disruption.</td><td>Project managers, operations teams, user communication channels, and migration tools.</td><td>When the product reaches end-of-life, either due to replacement or diminished relevance.</td></tr></tbody></table>
<h1>üìã Detailed Stage Descriptions</h1>
<ul>
<li>
<p><strong>Ideate</strong>
Generates and prioritizes ideas, ensuring a user-centered approach from the outset. Benefits include a clear focus on feasible and impactful solutions.</p>
</li>
<li>
<p><strong>PoT (Proof of Technology)</strong>
Focused on assessing the technical feasibility of a solution, ensuring it is viable for solving the identified problem. Benefits include reducing technical risk early in the process and clarifying technological possibilities.</p>
</li>
<li>
<p><strong>PoC (Proof of Concept)</strong>
Aligns technical feasibility with business objectives, showing stakeholders how the solution addresses the problem. Benefits include stakeholder buy-in and a clearer understanding of the project‚Äôs potential impact.</p>
</li>
<li>
<p><strong>MVP (Minimum Viable Product)</strong>
A functional product with core features deployed to early adopters for real-world usage and feedback. Prioritizes speed-to-market and core functionality. Benefits include reduced time-to-market and insights into user needs for prioritizing future features.</p>
</li>
<li>
<p><strong>Pilot</strong>
A controlled, real-world deployment of the MVP to test the product‚Äôs operational viability in a controlled, real-world environment, focusing on end-to-end testing. Benefits include reduced risks and a more straightforward path to production readiness.</p>
</li>
<li>
<p><strong>Production</strong>
In the final stage, the product is fully deployed, supported, and scaled for end users. Benefits include delivering business value, achieving scalability, and operational efficiency.</p>
</li>
<li>
<p><strong>Continuous Improvement</strong>
Ensures the product evolves based on user feedback and performance metrics. Benefits include staying competitive and maintaining user satisfaction through regular updates.</p>
</li>
<li>
<p><strong>Sunset</strong>
A planned retirement phase that ensures a smooth transition for users while freeing up resources for other priorities. Benefits include minimizing disruptions and maintaining organizational focus.</p>
</li>
</ul>
<h1>‚ùì Key Questions for Each Stage</h1>
<p>One of the key reasons to break down the Product Lifecycle into these stages is to focus on the right needs of your product or service at the right times; examples of questions you should be asking at each phase are:</p>
<table><thead><tr><th><strong>Stage</strong></th><th><strong>Key Questions</strong></th></tr></thead><tbody><tr><td>PoT (Proof of Technology)</td><td>- What unknowns about the technology must be validated?  \n- Are the tools or platforms feasible for this use case?  \n- What are the technical risks, and how can they be mitigated?  \n- Is this the best technology stack for long-term scalability?</td></tr><tr><td>PoC (Proof of Concept)</td><td>- Does the solution align with business goals?  \n- Can it solve the problem in a controlled, small-scale test?  \n- What are the critical assumptions being validated?  \n- How will stakeholders measure success?  \n- What constraints or dependencies could limit progress?</td></tr><tr><td>Prototype</td><td>- Does the design meet usability and functionality needs?  \n- What feedback can be gathered on the proposed solution?  \n- Are there any technical barriers to implementing the design?  \n- How well does the prototype align with user personas or scenarios?</td></tr><tr><td>MVP (Minimum Viable Product)</td><td>- What core functionality is essential to meet user needs?  \n- Can this be delivered with minimal effort for testing adoption?  \n- How will user feedback be collected and prioritized?  \n- Are the team and infrastructure ready to iterate quickly based on feedback?</td></tr><tr><td>Pilot</td><td>- What operational or real-world risks must be addressed before scaling?  \n- How will success in the pilot phase be measured?  \n- Are there additional training or support requirements for users?  \n- How will pilot learnings be incorporated into scaling plans?</td></tr><tr><td>Production</td><td>- Is the solution robust and scalable?  \n- Are operational processes in place for monitoring, support, and continuous improvement?  \n- What KPIs or metrics indicate product success?  \n- Are end users satisfied with performance and usability?  \n- How will updates or fixes be managed post-launch?</td></tr><tr><td>Continuous Development</td><td>- What feedback from users or metrics indicates areas for improvement?  \n- How can automation enhance development or deployment processes?  \n- Are there new features or updates that align with market trends?  \n- How can emerging technologies be leveraged to improve the product?  \n- Is there a roadmap for ongoing enhancements?</td></tr><tr><td>Sunset</td><td>- What is the timeline and plan for decommissioning?  \n- How will users transition to alternatives?  \n- How will data and systems be archived or disposed of?  \n- Are there plans to communicate changes effectively to all stakeholders?  \n- What metrics indicate it is the right time to sunset the product?</td></tr></tbody></table>
<h1>üö™ Product Lifecycle Gates</h1>
<p>So let us dig a bit deeper into some of the gates to consider when shifting a product through this lifecycle before you reach the next stage <em>(for example, from MVP to Pilot)</em>:</p>
<p><img decoding="async" loading="lazy" alt="Product Development Lifecycle Gates" src="https://luke.geek.nz/assets/images/ProductDevelopmentLifecycleGates-19ffe92493631d8c9725e19c384e805e.png" width="4000" height="2250" class="img_ev3q"></p>
<ol>
<li><strong>Problem Definition and Technical Feasibility</strong>
(Helps determine if you're at the PoT or PoC stage)</li>
</ol>
<ul>
<li>What is the primary problem this application/workload/service is trying to solve?</li>
<li>Do we have enough technical understanding to validate whether this can be built?</li>
<li>Are there specific technical risks or uncertainties that need validation before proceeding further?</li>
<li>Is there an existing technology or approach that can achieve the desired outcome, or does this require exploration?</li>
<li>Are stakeholders aligned on the goals of the solution at this stage?</li>
</ul>
<ol start="2">
<li><strong>User and Business Alignment</strong>
(Determines if you're ready for PoC, Prototype, or MVP stages)</li>
</ol>
<ul>
<li>Who are the target users or audiences for this application/workload/service?</li>
<li>What are the critical business outcomes or objectives tied to this solution?</li>
<li>Do we have user personas or initial feedback to validate assumptions?</li>
<li>Is there clarity on how this solution will fit into existing business processes or workflows?</li>
<li>Are there measurable KPIs or success criteria defined for the next stage?</li>
</ul>
<ol start="3">
<li><strong>Functionality and Design</strong>
(Helps decide if Prototype or MVP is needed)</li>
</ol>
<ul>
<li>Do we have clear requirements and design principles for the application?</li>
<li>What specific features or functionality are critical to test user engagement?</li>
<li>Is the goal to explore design and usability (Prototype) or to deliver something functional for user adoption (MVP)?</li>
<li>How much feedback or iteration is needed to validate user needs or business value?</li>
<li>Are there competing priorities (e.g., time-to-market vs. feature completeness) that influence this stage?</li>
</ul>
<ol start="4">
<li><strong>Real-World Validation</strong>
(Clarifies readiness for Pilot stage)</li>
</ol>
<ul>
<li>Has the application/workload/service undergone sufficient technical, functional, and usability testing?</li>
<li>Are there operational risks or challenges that require validation in a controlled environment?</li>
<li>Do we have a defined test group or environment to deploy the solution and gather feedback?</li>
<li>What are the success metrics for the pilot phase (e.g., adoption rate, performance, operational readiness)?</li>
<li>What‚Äôs the contingency plan if the pilot reveals significant issues?</li>
</ul>
<ol start="5">
<li><strong>Scalability and Operational Readiness</strong>
(Determines readiness for Production)</li>
</ol>
<ul>
<li>Has the solution demonstrated scalability under expected workloads?</li>
<li>Are there any technical, security, or compliance gaps preventing full-scale deployment?</li>
<li>Is the team equipped with monitoring, support, and incident response processes?</li>
<li>What are the ongoing maintenance and operational requirements?</li>
<li>Is there a plan for onboarding users or customers at scale?</li>
</ul>
<ol start="6">
<li><strong>Post-Launch Evolution and Sunset Planning</strong>
(Addresses long-term product lifecycle considerations)</li>
</ol>
<ul>
<li>What is the plan for iterating and improving the product post-launch?</li>
<li>How will we track performance, gather feedback, and prioritize enhancements?</li>
<li>Is there a decommissioning or migration plan in case of obsolescence or replacement?</li>
<li>What‚Äôs the budget and resource allocation for ongoing updates?</li>
<li>What external factors (e.g., market changes and technology updates) could impact the solution's longevity?</li>
</ul>
<h1>üìö Scenarios</h1>
<p>Let's look at two scenarios to see how these stages can be applied. Scenario #1 is the development of an Azure Landing Zone <em>(yes, it doesn't have to be specifically a product - this is a way of thinking, more of a guideline/framework than a rule)</em> and Scenario #2 is the creation of an eCommerce website.</p>
<p>Here is the updated table with the sunset row added at the bottom:</p>
<table><thead><tr><th><strong>Gate</strong></th><th><strong>Scenario #1. Azure Landing Zone Implementation</strong></th><th><strong>Scenario #2. E-Commerce Website</strong></th></tr></thead><tbody><tr><td>Gate 1: <strong>Technical Feasibility Validated</strong></td><td>- All resource types required for the landing zone deployment are provisioned successfully using IaC (Infrastructure as Code).  \n- A network topology supporting hybrid cloud connectivity is deployed and passes end-to-end connectivity tests.</td><td>- The website backend can retrieve product data from a database within 50ms under test conditions.  \n- A sandbox environment successfully processes simulated payments through the payment gateway.</td></tr><tr><td>Gate 2: <strong>Stakeholder Approval</strong></td><td>- Stakeholders review and sign off governance policies for tagging, cost management, and resource compliance.  \n- Cloud adoption teams approve the initial subscription and resource group hierarchy structure.</td><td>- Stakeholders approve a product backlog containing prioritized features for the MVP based on user stories.  \n- Design mockups of key pages (e.g., homepage, product page, checkout page) are reviewed and signed off by business stakeholders.</td></tr><tr><td>Gate 3: <strong>MVP Adoption Metrics Met</strong></td><td>- The MVP landing zone enables three application teams to deploy workloads without manual intervention.  \n- Monitoring and logging solutions for the MVP environment are active and provide actionable insights within 5 minutes of an incident.</td><td>- The MVP site achieves at least 100 daily active users within 2 weeks of launch.  \n- Basic checkout functionality works end-to-end, including order placement and confirmation email delivery.</td></tr><tr><td>Gate 4: <strong>Pilot Success Criteria Achieved</strong></td><td>- The pilot environment supports the deployment of workloads across all required regions with no SLA violations over 4 weeks.  \n- All critical governance, security, and operational policies pass compliance testing in the pilot.</td><td>- During a limited launch, 1,000 transactions are processed with less than 1% failure rate.  \n- Pilot users provide a Net Promoter Score (NPS) of 7 or higher for their experience on the site.</td></tr><tr><td>Gate 5: <strong>Go-Live Decision</strong></td><td>- All key stakeholders approve readiness for production based on agreed KPIs (e.g., uptime, cost optimization, and security).  \n- Documentation for deployment, governance, and user onboarding is complete and validated by end users.</td><td>- The e-commerce platform handles a load test of 20,000 concurrent users with a 99.9% success rate in order processing.  \n- Critical user journeys (search, add to cart, checkout) are tested with zero critical defects reported in production-readiness testing.</td></tr><tr><td>Gate 6:<strong>Sunset</strong></td><td>- All resources associated with the landing zone are decommissioned safely and cost-effectively, with no unexpected impact on remaining environments.  \n- Final cost and usage reports for the project are reviewed and shared with stakeholders.</td><td>- All user data is successfully migrated or anonymized according to privacy policies.  \n- All legal and financial obligations are met for the e-commerce platform, and any necessary shutdown or scaling activities are completed without affecting the remaining infrastructure.</td></tr></tbody></table>
<h1>üèÅ Conclusion</h1>
<p>Hopefully, this article gives you more clarity about the product design lifecycle, how to apply it to your own projects, and how to use it to your advantage to make sure you are focusing on the right things at the right time and not wasting resources on the wrong things.</p>]]></content:encoded>
            <category>Misc</category>
            <category>Service Management</category>
        </item>
        <item>
            <title><![CDATA[Pre-commit Hooks in GitHub Codespaces for Terraform IaC]]></title>
            <link>https://luke.geek.nz/misc/precommit-hooks-codespaces-terraform-iac/</link>
            <guid>https://luke.geek.nz/misc/precommit-hooks-codespaces-terraform-iac/</guid>
            <pubDate>Tue, 07 Jan 2025 08:06:54 GMT</pubDate>
            <description><![CDATA[Learn how to set up pre-commit hooks in GitHub Codespaces for Terraform Infrastructure as Code (IaC) development.]]></description>
            <content:encoded><![CDATA[<p>Pre-commit hooks are automated scripts or checks running before developers commit code to a repository. They are particularly useful in the context of infrastructure, such as code <em>(IaC)</em> development, when working with Terraform.</p>
<p>These hooks serve as an early defense against common issues, ensuring code quality and consistency before changes are committed to version control.</p>
<p>Today, we are going to discuss precommit with GitHub Codespaces.</p>
<!-- -->
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p><a href="https://pre-commit.com/" target="_blank" rel="noopener noreferrer">Pre-commit hooks</a> offer several advantages in the IaC development lifecycle:</p><ul>
<li>Early Error Detection: They catch syntax errors, formatting issues, and potential security vulnerabilities before code is committed.</li>
<li>Consistency: Hooks enforces coding standards and best practices across the development team.</li>
<li>Time-saving: By automating routine checks, pre-commit hooks reduce the need for manual review and minimize the likelihood of failed CI/CD pipelines.</li>
<li>Security: They can identify potential security risks in infrastructure code early in the development process.</li>
</ul><p><img decoding="async" loading="lazy" alt="Pre-commit hooks" src="https://luke.geek.nz/assets/images/pre-commit-hook-flow-7e60248cd1d61f0724b7554c8336e15e.png" width="720" height="321" class="img_ev3q"></p><p><em>(Image from <a href="https://azure.github.io/AKS-DevSecOps-Workshop/" target="_blank" rel="noopener noreferrer">AKS DevSecOps Workshop</a>)</em></p><p>Pre-commits work well in the Inner Loop of the Developer/Cloud Engineer workflow <em>(for the duration of this article when I use the word developer, I am meaning anyone who writes IaC code)</em>. They can be lightweight and run quickly, providing immediate feedback to developers as they work on their code. This feedback loop helps developers address issues early, leading to higher-quality code and faster development cycles, before the code hits any peer review or remote code source system (such as DevOps or GitHub repositories)_.</p><p><img decoding="async" loading="lazy" alt="Inner Loop of Developer Workflow" src="https://luke.geek.nz/assets/images/devinnerouterloop-b08a99eb9b7df562d4c631e2244a1a8c.png" width="1984" height="794" class="img_ev3q"></p></div></div>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>While pre-commit hooks can be valuable tools for maintaining code quality, there are several concerns and potential drawbacks to be aware of when implementing them. The use of GitHub Codespaces can help with some of the drawbacks, especially around consistency and setup, however consider the tradeoffs of what pre-commit hooks you want and how they may impact your development workflow.</p><p>Some potential drawbacks include:</p><ul>
<li>Pre-commit hooks can significantly slow down the development process, especially if they run extensive checks or tests</li>
<li>Frequent, time-consuming checks can break a developer's focus and impede productivity</li>
<li>Overly restrictive pre-commit hooks may be seen as a lack of trust in developers' abilities and judgment</li>
<li>Strict pre-commit checks might discourage developers from experimenting or pushing work-in-progress code to their branches</li>
<li>Developers might be tempted to bypass hooks using git commit flags, defeating the purpose of the checks</li>
</ul><p>There's a delicate balance between comprehensive checks and maintaining a fast, frictionless commit process. Not all checks need to be in pre-commit hooks; some can be deferred to CI/CD pipelines or pre-push hooks, and because of the individual nature of having the pre-commit setup for each developer and the developer able to force the commit <em>(ignoring the pre-commit checks)</em> it is important to have a good culture around the use of pre-commit hooks, and any important checks need to be implemented in a CI/CD pipeline, for consistency.</p></div></div>
<p>So, let us get started with setting up pre-commit hooks in GitHub Codespaces. The same premise can also be applied outside of a Codespace, but for this article, we will focus on a Codespace.</p>
<p>The guts of this is the <a href="https://pre-commit.com/" target="_blank" rel="noopener noreferrer">pre-commit framework</a>, a Python package that manages pre-commit hooks for you. It is a framework for managing and maintaining multi-language pre-commit hooks. The pre-commit hooks are run against the files that are staged for commit, and if any of the hooks fail, the commit is rejected.</p>
<blockquote>
<p>Git hook scripts are useful for identifying simple issues before submission to code review. We run our hooks on every commit to automatically point out issues in code, such as missing semicolons, trailing whitespace, and debug statements. Pointing these issues out before code review allows a code reviewer to focus on the architecture of a change while not wasting time with trivial style nitpicks.</p>
</blockquote>
<p>For the Codespace, we will add the pre-commit framework to the Codespace, then add a script to initialize the pre-commit hooks, then configure the pre-commit hooks to run the checks we want.</p>
<p>Let's add the pre-commit framework to the Codespace devcontainer.json.</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token property">"features"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">//Add pre-commit</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"ghcr.io/prulloac/devcontainer-features/pre-commit:1.0.3"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><br></span></code></pre></div></div>
<p>Once added, we need to add a postCreateCommand to initialize the pre-commit framework, like so:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token property">"postCreateCommand"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"pre-commit install"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><br></span></code></pre></div></div>
<p>This will run after the GitHub Codespace has been created and running.</p>
<p>So, an example for our Terraform IaC would look like this:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_OeMC">.devcontainer/devcontainer.json</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// "features" section allows adding and configuring predefined features or tools in the development container.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"features"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// Adds and configures the Azure CLI with Bicep and Python installation options.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"ghcr.io/devcontainers/features/azure-cli:latest"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"installBicep"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">//  Bicep installation.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"installUsingPython"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Installs using Python.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"version"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"latest"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Specifies the version of the Azure CLI to install.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// Adds PowerShell to the container.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"ghcr.io/devcontainers/features/powershell:latest"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"version"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"latest"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Specifies the version of PowerShell to install.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     </span><span class="token comment" style="color:rgb(98, 114, 164)">//Add pre-commit</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"ghcr.io/prulloac/devcontainer-features/pre-commit:1.0.3"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// Adds and configures Terraform with specific version, TFLint, and Terragrunt.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"ghcr.io/devcontainers/features/terraform:1"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"version"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"latest"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Specifies the version of Terraform to install.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"tflint"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"latest"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Specifies the version of TFLint to install.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"terragrunt"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"latest"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Specifies the version of Terragrunt to install.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"postCreateCommand"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"pre-commit install"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>You can view a version of the devcontainer.json file <a href="https://github.com/lukemurraynz/Codespace_IaC_Coding/blob/main/.devcontainer/devcontainer.json" target="_blank" rel="noopener noreferrer">here</a>. My <a href="https://github.com/lukemurraynz/Codespace_IaC_Coding" target="_blank" rel="noopener noreferrer">lmurraynz/Codespace_IaC_Coding</a> repository has a devcontainer.json file that has the pre-commit framework added in. The intention is that you can take this repository as a template and then modify and remove it as you need to.</p></div></div>
<p>Once the Codespace has been created, you can then add a .pre-commit-config.yaml file to the root of your repository. This file will contain the configuration for the pre-commit hooks you want to run.</p>
<p>An example of a .pre-commit-config.yaml file for Terraform would look like this:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_OeMC">.pre-commit-config.yaml</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token key atrule">default_stages</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">pre</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">commit</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">repos</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">repo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> https</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">//github.com/pre</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">commit/pre</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">commit</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">hooks</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">rev</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> v5.0.0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">hooks</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> trailing</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">whitespace</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> end</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">of</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">file</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">fixer</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> check</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">yaml</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> check</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">added</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">large</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">files</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> check</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">case</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">conflict</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> check</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">merge</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">conflict</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">repo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> https</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">//github.com/antonbabenko/pre</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">commit</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">terraform</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">rev</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> v1.96.3</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">hooks</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> terraform_fmt</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">args</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">args=</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">recursive</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">exclude</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'.*/\.terragrunt-cache'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> terraform_validate</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> terraform_tflint</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> terraform_trivy</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> terraform_docs</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">args</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">hook</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">config=</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">add</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">to</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">existing</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">file=true     </span><span class="token comment" style="color:rgb(98, 114, 164)"># Boolean. true or false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">hook</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">config=</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">create</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">file</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">if</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">not</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">exist=true </span><span class="token comment" style="color:rgb(98, 114, 164)"># Boolean. true or false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">args=</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">output</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">mode=replace</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> tfupdate</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Autoupdate Terraform versions</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">args</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">args=provider azurerm </span><span class="token comment" style="color:rgb(98, 114, 164)"># Will be pined to latest version</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">repo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> https</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">//github.com/bridgecrewio/checkov.git</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">rev</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'3.2.346'</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># change to tag or sha</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">hooks</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> checkov</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">verbose</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">args</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">'--quiet'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'--compact'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'--soft-fail'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><br></span></code></pre></div></div>
<p>Here's a breakdown of what each part does:</p>
<ol>
<li>
<p><strong><code>default_stages: [pre-commit]</code></strong>: Specifies that the hooks should run at the <code>pre-commit</code> stage.</p>
</li>
<li>
<p><strong><code>repos</code></strong>: Lists repositories containing pre-commit hooks to be used.</p>
</li>
<li>
<p><strong>First repository</strong> (<code>https://github.com/pre-commit/pre-commit-hooks</code>):</p>
<ul>
<li><strong><code>rev: v5.0.0</code></strong>: Specifies the version of the repository.</li>
<li><strong><code>hooks</code></strong>: Lists the hooks to be used from this repository:<!-- -->
<ul>
<li><code>trailing-whitespace</code>: Removes trailing whitespace.</li>
<li><code>end-of-file-fixer</code>: Ensures files end with a newline.</li>
<li><code>check-yaml</code>: Checks YAML files for syntax errors.</li>
<li><code>check-added-large-files</code>: Prevents large files from being added.</li>
<li><code>check-case-conflict</code>: Checks for case conflicts in filenames.</li>
<li><code>check-merge-conflict</code>: Checks for unresolved merge conflicts.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Second repository</strong> (<code>https://github.com/antonbabenko/pre-commit-terraform</code>):</p>
<ul>
<li><strong><code>rev: v1.96.3</code></strong>: Specifies the version of the repository.</li>
<li><strong><code>hooks</code></strong>: Lists the hooks to be used from this repository:<!-- -->
<ul>
<li><code>terraform_fmt</code>: Formats Terraform files.<!-- -->
<ul>
<li><code>args</code>: Specifies arguments for the hook.</li>
<li><code>exclude</code>: Excludes certain files from the hook.</li>
</ul>
</li>
<li><code>terraform_validate</code>: Validates Terraform files.</li>
<li><code>terraform_tflint</code>: Lints Terraform files.</li>
<li><code>terraform_trivy</code>: Scans Terraform files for vulnerabilities.</li>
<li><code>terraform_docs</code>: Generates documentation for Terraform files.<!-- -->
<ul>
<li><code>args</code>: Specifies arguments for the hook.</li>
</ul>
</li>
<li><code>tfupdate</code>: Updates Terraform provider versions.<!-- -->
<ul>
<li><code>name</code>: Provides a name for the hook.</li>
<li><code>args</code>: Specifies arguments for the hook.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Third repository</strong> (<code>https://github.com/bridgecrewio/checkov.git</code>):</p>
<ul>
<li><strong><code>rev: '3.2.346'</code></strong>: Specifies the version of the repository.</li>
<li><strong><code>hooks</code></strong>: Lists the hooks to be used from this repository:<!-- -->
<ul>
<li><code>checkov</code>: Runs Checkov to scan for security issues in infrastructure as code.<!-- -->
<ul>
<li><code>verbose</code>: Enables verbose output.</li>
<li><code>args</code>: Specifies arguments for the hook.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ol>
<p>This configuration ensures that various checks and fixes are automatically applied to the codebase before commits are made, helping to maintain code quality and security.</p>
<p>So, let's spin up our Codespace and see the pre-commit hooks in action.</p>
<p>The first time you run this, it will take a while as it will download the pre-commit hooks and install them. Be mindful of this if you are running this in a new Codespace environment.</p>
<p><img decoding="async" loading="lazy" alt="Pre-commit install" src="https://luke.geek.nz/assets/images/Precommit_Codespace_Terraform_Run-96daf6e0895ddb3c87b20c0fbd5b5ac5.gif" width="1901" height="1032" class="img_ev3q"></p>
<p>As you can see from the pre-commit output, I am missing some dependencies installed, i.e., Terraform docs, but we can see Terraform format ran, the trailing whitespace check ran and fixed the issue, and tflint ran and came back with some issues, such as missing provider versions, and checkov ran a security check, which came back with some failed checks, such as Public access enabled and latest TLS version not set.</p>
<p>Hopefully, you can see the power of the pre-commit, and as these failed, nothing was committed to the repository, so I can fix these issues before I commit the code.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>If needed, we can skip the pre-commit checks and force-push the changes through with the following command:</p><p>git push --no-verify</p><p>This will bypass the pre-commit checks and force the commit through. There is a <a href="https://marketplace.visualstudio.com/items?itemName=DevEscalus.git-push-no-verify" target="_blank" rel="noopener noreferrer">Visual Studio Code extension - Git push(no verify)
</a> as well, which adds a noverify button to the commit dialog, so you can bypass the pre-commit checks if needed.</p></div></div>
<p>Hopefully, this will give you a great starting block for adding pre-commit hooks to your Codespace and workflow and help with secure and reliable IaC development. You can find a list of common prehooks here: <a href="https://pre-commit.com/hooks.html" target="_blank" rel="noopener noreferrer">featured hooks
</a>, and if your game - you can create your own and find other hooks people have created - such as this Azure Bicep <a href="https://github.com/Azure4DevOps/check-azure-bicep" target="_blank" rel="noopener noreferrer">Azure4DevOps/check-azure-bicep</a> one.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>You can run  <code>pre-commit autoupdate</code> to update all the pre-commit hook versions. For example, when I ran it, I got:</p><ul>
<li>[<a href="https://github.com/bridgecrewio/checkov.git" target="_blank" rel="noopener noreferrer">https://github.com/bridgecrewio/checkov.git</a>]<!-- --> updating 3.2.346 -&gt; 3.2.350</li>
</ul><p>Which updated my <code>.pre-commit-config.yaml</code> file with the latest version without having to go and check each one manually.</p></div></div>]]></content:encoded>
            <category>Azure</category>
        </item>
        <item>
            <title><![CDATA[Deploying Azure Managed Redis with Bicep]]></title>
            <link>https://luke.geek.nz/azure/deploying-azure-managed-redis-with-bicep/</link>
            <guid>https://luke.geek.nz/azure/deploying-azure-managed-redis-with-bicep/</guid>
            <pubDate>Thu, 02 Jan 2025 08:45:51 GMT</pubDate>
            <description><![CDATA[Learn how to deploy Azure Managed Redis using Bicep with code examples.]]></description>
            <content:encoded><![CDATA[<p><a href="https://learn.microsoft.com/azure/azure-cache-for-redis/managed-redis/managed-redis-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Managed Redis</a> announced during <a href="https://techcommunity.microsoft.com/blog/AppsonAzureBlog/introducing-azure-managed-redis-cost-effective-caching-for-your-ai-apps/4299104?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Microsoft Ignite 2024</a> in Public Preview.</p>
<p>This is a new, fully-managed, first-party Redis offering in Microsoft Azure. Azure Managed Redis is available today in public preview. Microsoft Azure is the first major cloud service provider to offer customers a licensed, multi-tiered Redis service.</p>
<p>This article will show you how to deploy an Azure Managed Redis instance using <a href="https://learn.microsoft.com/azure/azure-resource-manager/bicep/overview?tabs=bicep&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Bicep</a>. Bicep is a Domain Specific Language (DSL) for deploying Azure resources declaratively. It aims to drastically simplify the authoring experience with a cleaner syntax and better support for modularity and code reuse.</p>
<!-- -->
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Every customer that migrates from any Azure Cache for Redis tier to Azure Managed Redis will gain access to years of Redis innovation. This builds on our existing integration with Microsoft Azure on the Enterprise and Enterprise Flash tiers for Azure Cache for Redis. With the introduction of Azure Managed Redis, users on Azure Cache for Redis can now access features that were previously found only on the Azure Cache for Redis Enterprise and Enterprise Flash tiers.</p><p>Azure Managed Redis delivers on the best scale and SLA in the industry, building on the advancements first introduced by the Azure Cache for the Redis Enterprise tier. Users can now experience up to 99.999% availability when leveraging multi-region Active-Active, the highest availability offered in the market, powered by CRDT. Apps built with Azure Managed Redis can deliver down to sub-millisecond local latency to users globally and simultaneously, no matter which continent or region they‚Äôre located on.</p></div></div>
<p>In this example, I have deployed Azure Managed Redis using Bicep, with bonus code snippets for connecting <a href="https://learn.microsoft.com/azure/api-management/api-management-key-concepts?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">API Management</a> to the <a href="https://learn.microsoft.com/azure/azure-cache-for-redis/managed-redis/managed-redis-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Managed Redis</a>.</p>
<p>The Bicep file creates a new Azure Managed Redis instance.</p>
<p>Redis Enterprise Cache Setup</p>
<ul>
<li>Resource Type: Microsoft.Cache/redisEnterprise</li>
<li>API Version: 2024-09-01-preview</li>
<li>Name: redisEnterprise</li>
<li>Location: Uses a variable location</li>
<li>Tags: Uses a variable tags</li>
<li>SKU: Specifies the SKU as MemoryOptimized_M10</li>
<li>Properties: Sets the minimum TLS version to 1.2</li>
</ul>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// Redis Enterprise Cache setup</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> redisEnterprise </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.Cache/redisEnterprise@2024-09-01-preview'</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'redisEnterprise'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">location</span><span class="token operator">:</span><span class="token plain"> location</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">tags</span><span class="token operator">:</span><span class="token plain"> tags</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">sku</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'MemoryOptimized_M10'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">minimumTlsVersion</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'1.2'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">output</span><span class="token plain"> redisEnterpriseName </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> redisEnterprise</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">name</span><br></span></code></pre></div></div>
<p>This part of the Bicep file sets up a Redis Enterprise Cache instance with specific configurations such as location, tags, SKU, and minimum TLS version.</p>
<p>Redis Cache Database Setup</p>
<ul>
<li>Resource Type: Microsoft.Cache/redisEnterprise/databases</li>
<li>API Version: 2024-09-01-preview</li>
<li>Name: default</li>
<li>Parent: Links to the redisEnterprise resource defined earlier
Properties:</li>
<li>Access Keys Authentication: Disabled</li>
<li>Eviction Policy: No eviction</li>
<li>Clustering Policy: Enterprise cluster</li>
<li>Modules: Includes the RediSearch module</li>
<li>Port: Sets the port to 10000</li>
</ul>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> redisCache </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.Cache/redisEnterprise/databases@2024-09-01-preview'</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'default'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">parent</span><span class="token operator">:</span><span class="token plain"> redisEnterprise</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">accessKeysAuthentication</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Disabled'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">evictionPolicy</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'NoEviction'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">clusteringPolicy</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'EnterpriseCluster'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">modules</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'RediSearch'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">port</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">10000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre></div></div>
<p>This part sets up a Redis Cache Database within the Redis Enterprise Cache instance. It configures properties such as access key authentication, eviction policy, clustering policy, modules, and port.</p>
<p>You can also link API Management to the Azure Managed Redis resource as a bonus. This is a small snippet of the Connection string for API Management:</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">redisCacheConnectionString</span><span class="token operator">:</span><span class="token plain"> </span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">'</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">redisEnterprise</span><span class="token interpolated-string interpolation expression punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token interpolated-string interpolation expression">properties</span><span class="token interpolated-string interpolation expression punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token interpolated-string interpolation expression">hostName</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">:</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression number">10000</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">,ssl=True,abortConnect=False'</span><br></span></code></pre></div></div>
<p>This is using Entra ID authentication to connect to the Redis Cache using the following role assignment to the API System Managed Identity:</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// Redis Access Policy Assignment</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> redisAccessPolicyAssignmentName </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.Cache/redisEnterprise/databases/accessPolicyAssignments@2024-09-01-preview'</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">take</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">'cachecontributor</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression function" style="color:rgb(80, 250, 123)">uniqueString</span><span class="token interpolated-string interpolation expression punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token interpolated-string interpolation expression function" style="color:rgb(80, 250, 123)">resourceGroup</span><span class="token interpolated-string interpolation expression punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token interpolated-string interpolation expression punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token interpolated-string interpolation expression punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token interpolated-string interpolation expression">id</span><span class="token interpolated-string interpolation expression punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">24</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">parent</span><span class="token operator">:</span><span class="token plain"> redisCache</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">accessPolicyName</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'default'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">user</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">objectId</span><span class="token operator">:</span><span class="token plain"> apim</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">outputs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">apimPrincipalId</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre></div></div>]]></content:encoded>
            <category>Azure</category>
        </item>
    </channel>
</rss>