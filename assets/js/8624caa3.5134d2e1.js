"use strict";(self.webpackChunklukemurraynz=self.webpackChunklukemurraynz||[]).push([[51454],{45348:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>d,frontMatter:()=>r,metadata:()=>a,toc:()=>c});var o=n(85893),i=n(11151);const r={title:"Azure Policy Inheritance",authors:["Luke"],tags:["Azure"],description:"Look into Azure Policy inheritance and how it works.",header:{teaser:"/images/posts/AzurePolicy_Effects.png"},date:new Date("2023-05-16T12:00:00.000Z"),slug:"azure/Demystifying-Azure-Policy-Inheritance-Understanding-the-Hierarchy-of-Control"},s=void 0,a={permalink:"/azure/Demystifying-Azure-Policy-Inheritance-Understanding-the-Hierarchy-of-Control",source:"@site/blog/2023-05-17-Demystifying-Azure-Policy-Inheritance-Understanding-the-Hierarchy-of-Control.md",title:"Azure Policy Inheritance",description:"Look into Azure Policy inheritance and how it works.",date:"2023-05-16T12:00:00.000Z",formattedDate:"May 16, 2023",tags:[{label:"Azure",permalink:"/tags/azure"}],readingTime:3.975,hasTruncateMarker:!1,authors:[{name:"Luke Murray",title:"Author",url:"https://luke.geek.nz",imageURL:"https://luke.geek.nz/img/logo.png",key:"Luke"}],frontMatter:{title:"Azure Policy Inheritance",authors:["Luke"],tags:["Azure"],description:"Look into Azure Policy inheritance and how it works.",header:{teaser:"/images/posts/AzurePolicy_Effects.png"},date:"2023-05-16T12:00:00.000Z",slug:"azure/Demystifying-Azure-Policy-Inheritance-Understanding-the-Hierarchy-of-Control"},unlisted:!1,prevItem:{title:"Getting Started with Azure Elastic SAN",permalink:"/azure/Bytes-Blocks-and-Elasticity-Getting-Started-with-Azure-Elastic-SAN"},nextItem:{title:"Web Content Not Found on Azure Storage Account",permalink:"/azure/Web-Content-Not-Found-error-on-Azure-Storage-Account-static-website"}},l={authorsImageUrls:[void 0]},c=[{value:"<strong>Scenario #1 \u2013 Policy assigned to the subscription with Allow Australia East ONLY</strong>",id:"scenario-1--policy-assigned-to-the-subscription-with-allow-australia-east-only",level:5},{value:"<strong>Scenario #2 \u2013 Policy assigned to the subscription with Allow Australia East but another policy with Allow UK South only on the Resource Group</strong>",id:"scenario-2--policy-assigned-to-the-subscription-with-allow-australia-east-but-another-policy-with-allow-uk-south-only-on-the-resource-group",level:5},{value:"<strong>Review</strong>",id:"review",level:5}];function h(e){const t={a:"a",em:"em",h5:"h5",img:"img",li:"li",ol:"ol",p:"p",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.a)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(t.p,{children:"Today, we are going to look into demystifying Azure Policy inheritance and how it works, so let\u2019s do some testing."}),"\n",(0,o.jsx)(t.p,{children:"In my tests \u2013 I have a single resource group named: AzPolicy-Test. This resource group has been placed in the Australia East region."}),"\n",(0,o.jsxs)(t.p,{children:["Now that we have a Resource Group to use in our testing, I need a policy \u2013 to keep things simple, I am going use the built-in policy of: ",(0,o.jsx)(t.a,{href:"https://www.azadvertizer.net/azpolicyadvertizer/e56962a6-4747-49cd-b67b-bf8b01975c4c.html",children:"AllowedLocations"}),". This policy will allow us to control which region we can deploy our Azure resources into."]}),"\n",(0,o.jsx)(t.h5,{id:"scenario-1--policy-assigned-to-the-subscription-with-allow-australia-east-only",children:(0,o.jsx)(t.strong,{children:"Scenario #1 \u2013 Policy assigned to the subscription with Allow Australia East ONLY"})}),"\n",(0,o.jsx)(t.p,{children:"I have assigned my Azure Policy to a Subscription, that contains my AzPolicy-Test Resource Group. I have set the Allowed Locations to: Australia East."}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.img,{alt:"Azure Policy - Allowed locations",src:n(80437).Z+"",title:"Azure Policy - Allowed locations",width:"774",height:"511"})}),"\n",(0,o.jsxs)(t.p,{children:["Let us do some testing, and try to deploy an Azure Resource ",(0,o.jsx)(t.em,{children:"(in my example, an Azure Storage account)"})," into my Resource Group:"]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,o.jsxs)(t.table,{children:[(0,o.jsx)(t.thead,{children:(0,o.jsxs)(t.tr,{children:[(0,o.jsx)(t.th,{children:"Can I deploy to Australia East?"}),(0,o.jsx)(t.th,{children:"Yes"})]})}),(0,o.jsx)(t.tbody,{children:(0,o.jsxs)(t.tr,{children:[(0,o.jsx)(t.td,{children:"Can I deploy to UK South?"}),(0,o.jsx)(t.td,{children:"No"})]})})]}),"\n",(0,o.jsx)(t.p,{children:"As you can see my storage account deployed into Australia East successfully\u2026 as expected!"}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.img,{alt:"Azure Portal - filtered by location",src:n(8788).Z+"",title:"Azure Portal - filtered by location",width:"1308",height:"230"})}),"\n",(0,o.jsx)(t.p,{children:"Now, lets try and deploy a Storage account into the same Resource Group, but in the UK South region."}),"\n",(0,o.jsx)(t.p,{children:"As Azure Resource Manager is analysing and verifying the inputs give it \u2013 it now knows there is an Azure Policy \u2013 enforcing specific locations and preventing my deployment into the UK South."}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.img,{alt:"Azure Storage Account - Deny UK South deployment",src:n(84045).Z+"",title:"Azure Storage Account - Deny UK South deployment",width:"742",height:"259"})}),"\n",(0,o.jsx)(t.p,{children:"This is as expected, and even if I were to use another resource group \u2013 I still won\u2019t be able to create resources in other regions."}),"\n",(0,o.jsx)(t.h5,{id:"scenario-2--policy-assigned-to-the-subscription-with-allow-australia-east-but-another-policy-with-allow-uk-south-only-on-the-resource-group",children:(0,o.jsx)(t.strong,{children:"Scenario #2 \u2013 Policy assigned to the subscription with Allow Australia East but another policy with Allow UK South only on the Resource Group"})}),"\n",(0,o.jsx)(t.p,{children:"Now that we know, we can create resources in Australia East \u2013 lets assign the same \u2018Allowed Locations\u2019 policy to the Resource Group, but Denying Australia East, and Allowing UK South. The policy allowing Australia East will still remain assigned to the subscription."}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.img,{alt:"Azure Policy - Allowed locations - UK South",src:n(75146).Z+"",title:"Azure Policy - Allowed locations - UK South",width:"788",height:"323"})}),"\n",(0,o.jsx)(t.p,{children:"Let us do some testing, and try to deploy an Azure Resource (in my example, an Azure Storage account) into my Resource Group:"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,o.jsxs)(t.table,{children:[(0,o.jsx)(t.thead,{children:(0,o.jsxs)(t.tr,{children:[(0,o.jsx)(t.th,{children:"Can I deploy to Australia East?"}),(0,o.jsx)(t.th,{children:"No"})]})}),(0,o.jsx)(t.tbody,{children:(0,o.jsxs)(t.tr,{children:[(0,o.jsx)(t.td,{children:"Can I deploy to UK South?"}),(0,o.jsx)(t.td,{children:"No"})]})})]}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.img,{alt:"Azure Storage account deployment - Policy validation error",src:n(50096).Z+"",title:"Azure Storage account deployment - Policy validation error",width:"754",height:"222"})}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.img,{alt:"Azure Storage account deployment - Policy validation error",src:n(65330).Z+"",title:"Azure Storage account deployment - Policy validation error",width:"772",height:"229"})}),"\n",(0,o.jsxs)(t.p,{children:["I can\u2019t deploy to either UK South or Australia East, even though I have 2 separate policies, one policy allowing Australia East (deployed at the subscription) and one policy allowing UK South ",(0,o.jsx)(t.em,{children:"(deployed at the Resource Group)"}),"."]}),"\n",(0,o.jsx)(t.p,{children:"In this case, the policies have worked together, with the most restrictive of them both in effect \u2013 which is Deny."}),"\n",(0,o.jsx)(t.h5,{id:"review",children:(0,o.jsx)(t.strong,{children:"Review"})}),"\n",(0,o.jsx)(t.p,{children:"So lets review, originally you might think that like Group Policy \u2013 the last policy wins \u2013 this is not always the case, when conflicting policies are assigned at different levels, the policy at the highest level in the hierarchy takes precedence over policies at lower levels. When preforming a Modify or Create on a resource \u2013 the Azure resource provider checks with the Azure Policy engine.. When deciding what policy to take the Azure Policy engine, will analyze all policies together (like the above scenarius, where both deployment to UK South and Australia East were in effect - however the most restrictive won)."}),"\n",(0,o.jsx)(t.p,{children:"There are, however, various effects which are analysed first."}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.img,{alt:"Azure Policy Effects",src:n(53405).Z+"",title:"Azure Policy Effects",width:"500",height:"383"})}),"\n",(0,o.jsxs)(t.ol,{children:["\n",(0,o.jsxs)(t.li,{children:[(0,o.jsx)(t.strong,{children:"Disabled"})," is checked first to determine whether the policy rule should be evaluated."]}),"\n",(0,o.jsxs)(t.li,{children:[(0,o.jsx)(t.strong,{children:"Append"})," and ",(0,o.jsx)(t.strong,{children:"Modify"})," are then evaluated. Since either could alter the request, a change made may prevent an audit or deny effect from triggering. These effects are only available with a Resource Manager mode."]}),"\n",(0,o.jsxs)(t.li,{children:[(0,o.jsx)(t.strong,{children:"Deny"})," is then evaluated. By evaluating deny before audit, double logging of an undesired resource is prevented."]}),"\n",(0,o.jsxs)(t.li,{children:[(0,o.jsx)(t.strong,{children:"Audit"})," is evaluated."]}),"\n",(0,o.jsxs)(t.li,{children:[(0,o.jsx)(t.strong,{children:"Manual"})," is evaluated."]}),"\n"]}),"\n",(0,o.jsx)(t.p,{children:"After the Resource Provider returns a success code on a Resource Manager mode request, AuditIfNotExists and DeployIfNotExists evaluate to determine whether additional compliance logging or action is required."}),"\n",(0,o.jsx)(t.p,{children:"Remember that policy enforcement occurs during resource deployment or updates. Existing resources are not retroactively affected unless a manual remediation is performed."}),"\n",(0,o.jsx)(t.p,{children:"The following Microsoft Learn documents are worth a read, if interested further."}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsx)(t.li,{children:(0,o.jsx)(t.a,{href:"https://learn.microsoft.com/azure/governance/policy/concepts/scope?WT.mc_id=AZ-MVP-5004796",children:"Understand scope in Azure Policy"})}),"\n",(0,o.jsx)(t.li,{children:(0,o.jsx)(t.a,{href:"https://learn.microsoft.com/azure/governance/policy/concepts/effects?WT.mc_id=AZ-MVP-5004796#order-of-evaluation",children:"Order of evaluation"})}),"\n"]})]})}function d(e={}){const{wrapper:t}={...(0,i.a)(),...e.components};return t?(0,o.jsx)(t,{...e,children:(0,o.jsx)(h,{...e})}):h(e)}},75146:(e,t,n)=>{n.d(t,{Z:()=>o});const o=n.p+"assets/images/AzurePolicy-AllowedLocation_UkSouth-1112a443a6a8de138925cd3335dc853c.png"},80437:(e,t,n)=>{n.d(t,{Z:()=>o});const o=n.p+"assets/images/AzurePolicy-AllowedLocations-DenyAllAustraliaE-91b88792e69b73456ec8866d476b862b.png"},65330:(e,t,n)=>{n.d(t,{Z:()=>o});const o=n.p+"assets/images/AzurePolicy-DisableAustraliaEastDeployment-e98b9b0f0e7a624a4eb63021cf89e902.png"},50096:(e,t,n)=>{n.d(t,{Z:()=>o});const o=n.p+"assets/images/AzurePolicy-DisableUKSouthDeployment-61b58dac429d6a660e2a47c16d692141.png"},8788:(e,t,n)=>{n.d(t,{Z:()=>o});const o=n.p+"assets/images/AzurePolicy-FilterLocations_AustraliaEast-92152ec4251bdba5bd792482115b4c6e.png"},84045:(e,t,n)=>{n.d(t,{Z:()=>o});const o=n.p+"assets/images/AzurePolicy_DenyUKSouth-8df8ea02e64a27502a7a213737b15f6c.png"},53405:(e,t,n)=>{n.d(t,{Z:()=>o});const o=n.p+"assets/images/AzurePolicy_Effects-868238028466ef59ff5f30b9eb3b41c7.png"},11151:(e,t,n)=>{n.d(t,{Z:()=>a,a:()=>s});var o=n(67294);const i={},r=o.createContext(i);function s(e){const t=o.useContext(r);return o.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),o.createElement(r.Provider,{value:t},e.children)}}}]);