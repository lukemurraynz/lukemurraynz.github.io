"use strict";(self.webpackChunklukemurraynz=self.webpackChunklukemurraynz||[]).push([[67447],{5061:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>o,contentTitle:()=>s,default:()=>h,frontMatter:()=>a,metadata:()=>l,toc:()=>c});var t=i(85893),r=i(11151);const a={date:"2022-02-05 00:00:00 +1300",title:"Datto Remote Management Azure VM Application Deployment",authors:["Luke"],tags:["Azure"],toc:!0,header:{teaser:"images/iazure-marketplace-banner.png"}},s=void 0,l={permalink:"/2022/02/05/azure-vm-application-deployment",source:"@site/blog/2022-02-05-azure-vm-application-deployment.md",title:"Datto Remote Management Azure VM Application Deployment",description:"The Azure Compute Gallery (superseded the Shared Image Gallery) offers more than just Azure Image management and replication, and you can deploy Applications to your Virtual Machines.",date:"2022-02-05T00:00:00.000Z",formattedDate:"February 5, 2022",tags:[{label:"Azure",permalink:"/tags/azure"}],readingTime:13.165,hasTruncateMarker:!1,authors:[{name:"Luke Murray",title:"Author",url:"https://luke.geek.nz",imageURL:"https://luke.geek.nz/img/logo.png",key:"Luke"}],frontMatter:{date:"2022-02-05 00:00:00 +1300",title:"Datto Remote Management Azure VM Application Deployment",authors:["Luke"],tags:["Azure"],toc:!0,header:{teaser:"images/iazure-marketplace-banner.png"}},unlisted:!1,prevItem:{title:"AzureFeeds",permalink:"/2022/02/11/azurefeeds"},nextItem:{title:"Just in Time access to Azure Virtual Machines",permalink:"/2022/01/29/just-in-time-access-to-azure-virtual-machines"}},o={authorsImageUrls:[void 0]},c=[{value:"Overview",id:"overview",level:3},{value:"Setup Azure VM Application Deployment",id:"setup-azure-vm-application-deployment",level:3},{value:"Prerequisites",id:"prerequisites",level:4},{value:"Setup Storage Account",id:"setup-storage-account",level:4},{value:"Setup Azure Compute Gallery",id:"setup-azure-compute-gallery",level:4},{value:"Create Application Definition",id:"create-application-definition",level:4},{value:"Create Application version",id:"create-application-version",level:4},{value:"Deploy Azure VM Application",id:"deploy-azure-vm-application",level:3},{value:"Deploy Azure VM Application to Virtual Machines using the Azure Portal",id:"deploy-azure-vm-application-to-virtual-machines-using-the-azure-portal",level:4},{value:"Deploy Azure VM Application to Multiple Virtual Machines using PowerShell",id:"deploy-azure-vm-application-to-multiple-virtual-machines-using-powershell",level:4},{value:"Troubleshooting VM Application",id:"troubleshooting-vm-application",level:3},{value:"Package Location",id:"package-location",level:4},{value:"Logs",id:"logs",level:4},{value:"Troubleshooting during preview",id:"troubleshooting-during-preview",level:4}];function d(e){const n={a:"a",blockquote:"blockquote",code:"code",em:"em",h3:"h3",h4:"h4",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.a)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(n.p,{children:["The Azure Compute Gallery ",(0,t.jsx)(n.em,{children:"(superseded the Shared Image Gallery)"})," offers more than just Azure Image management and replication, and you can deploy Applications to your Virtual Machines."]}),"\n",(0,t.jsx)(n.h3,{id:"overview",children:"Overview"}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsxs)(n.p,{children:["An Azure Compute Gallery helps you build structure and organization around your Azure resources, like images and ",(0,t.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/azure/virtual-machines/vm-applications?WT.mc_id=AZ-MVP-5004796",children:"applications"}),". An Azure Compute Gallery provides:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Global replication."}),"\n",(0,t.jsx)(n.li,{children:"Versioning and grouping of resources for easier management."}),"\n",(0,t.jsxs)(n.li,{children:["Highly available resources with Zone Redundant Storage ",(0,t.jsx)(n.em,{children:"(ZRS)"})," accounts in regions that support Availability Zones. ZRS offers better resilience against zonal failures."]}),"\n",(0,t.jsxs)(n.li,{children:["Premium storage support ",(0,t.jsx)(n.em,{children:"(Premium_LRS)"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["Sharing across subscriptions, and even between Active Directory ",(0,t.jsx)(n.em,{children:"(AD)"})," tenants, using Azure RBAC."]}),"\n",(0,t.jsx)(n.li,{children:"Scaling your deployments with resource replicas in each region."}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"With images, Azure VM applications that support both Linux and Windows operating systems get these benefits."}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:"While you can create an image of a VM with apps pre-installed, you would need to update your image each time you have application changes. Separating your application installation from your VM images means there\u2019s no need to publish a new image for every line of code change."}),"\n",(0,t.jsx)(n.p,{children:"Application packages provide benefits over other deployment and packaging methods:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Grouping and versioning of your packages"}),"\n",(0,t.jsx)(n.li,{children:"VM applications can be globally replicated to be closer to your infrastructure, so you don\u2019t need to use AzCopy or other storage copy mechanisms to copy the bits across Azure regions."}),"\n",(0,t.jsx)(n.li,{children:"Sharing with other users through Azure Role Based Access Control (RBAC)"}),"\n",(0,t.jsx)(n.li,{children:"Support for virtual machines, and both flexible and uniform scale sets"}),"\n",(0,t.jsx)(n.li,{children:"If you have Network Security Group (NSG) rules applied on your VM or scale set, downloading the packages from an internet repository might not be possible. And with storage accounts, downloading packages onto locked-down VMs would require setting up private links."}),"\n",(0,t.jsxs)(n.li,{children:["VM applications can be used with the ",(0,t.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/azure/governance/policy/concepts/effects?WT.mc_id=AZ-MVP-5004796",children:"DeployIfNotExists"})," policy."]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["Azure VM Application packages ",(0,t.jsx)(n.em,{children:"(stored in an Azure Storage account)"})," uses multiple resources, as below:"]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Resource"}),(0,t.jsx)(n.th,{children:"Description"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Azure compute gallery"}),(0,t.jsx)(n.td,{children:"A gallery is a repository for managing and sharing application packages. Users can share the gallery resource and all the child resources will be shared automatically. The gallery name must be unique per subscription. For example, you may have one gallery to store all your OS images and another gallery to store all your VM applications."})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"VM application"}),(0,t.jsx)(n.td,{children:"This is the\xa0definition of your VM application. This is a\xa0logical\xa0resource that stores the common metadata for all the versions under it. For example, you may have an application definition for Apache Tomcat and have multiple versions within it."})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"VM Application version"}),(0,t.jsx)(n.td,{children:"This is the deployable resource. You can globally replicate your VM application versions to target regions closer to your VM infrastructure. The VM Application Version must be replicated to a region before it may be deployed on a VM in that region."})]})]})]}),"\n",(0,t.jsx)(n.p,{children:"There is no extra charge for using VM Application Packages, but you will be charged for the following resources:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Storage costs of storing each package and any replicas."}),"\n",(0,t.jsx)(n.li,{children:"Network egress charges for replication of the first image version from the source region to the replicated regions. Subsequent replicas are handled within the region, so there are no additional charges."}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Before we deploy our first VM application, there are a few things we need to be aware of:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"VM Application requires an Azure Compute Gallery"}),"\n",(0,t.jsx)(n.li,{children:"VM Application requires an Azure storage account to store your applications"}),"\n",(0,t.jsxs)(n.li,{children:["The VM Application gets downloaded to the VM using the name of the VM application ",(0,t.jsx)(n.em,{children:"(not the actual name and Extension of your file in the storage account)"})]}),"\n",(0,t.jsx)(n.li,{children:"Currently, in order to retry a failed installation, you need to remove the application from the profile and add it back"}),"\n",(0,t.jsx)(n.li,{children:"No more than five applications per Virtual Machine deployed at a time"}),"\n",(0,t.jsx)(n.li,{children:"The maximum size of the application is 1 GB"}),"\n",(0,t.jsx)(n.li,{children:"You can't have multiple versions of the same application installed on a Virtual Machine, and a newer version will supersede an older version either via an upgrade command or complete reinstall."}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["In this article, we are going to deploy the Datto Remote Management & Monitoring Agent to a Windows Server 2022 Virtual Machine; this agent is a simple executable that installs on a virtual machine and allows remote access and management of a virtual machine, without requiring any other form of connectivity ",(0,t.jsx)(n.em,{children:"(Azure Bastion, RDP via Public IP, Site to Site VPN etc.)"})," for an MSP ",(0,t.jsx)(n.em,{children:"(Managed Service Provider)"})," using the Datto toolset, the same concept can be applied to any application ",(0,t.jsx)(n.em,{children:"(theoretically you can also use this to run PowerShell installs or chocolatey installs)"}),"."]}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:"It's worth noting the VM Applications are currently in Public Preview, there is a good chance there will be changes in the way these operate and are configured when it becomes Generally Available."}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"setup-azure-vm-application-deployment",children:"Setup Azure VM Application Deployment"}),"\n",(0,t.jsx)(n.h4,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,t.jsx)(n.p,{children:"In order to use VM Applications, we need:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"A storage account"}),"\n",(0,t.jsx)(n.li,{children:"Azure Compute gallery"}),"\n",(0,t.jsxs)(n.li,{children:["VM application definition and version ",(0,t.jsx)(n.em,{children:"(in my example: the Datto RMM agent)"})]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["Following the guide, we will run through the creation of everything from scratch; I am, however, assuming you already have the executable or application package and know the instructions to install/uninstall it - as each application is different. The Microsoft",(0,t.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/azure/virtual-machines/vm-applications?WT.mc_id=AZ-MVP-5004796#exe-installer",title:"VM Applications overview",children:"VM Applications docs"})," give a few good examples for getting started with various applications."]}),"\n",(0,t.jsx)(n.h4,{id:"setup-storage-account",children:"Setup Storage Account"}),"\n",(0,t.jsx)(n.p,{children:"The Storage account is where your application will be placed; it uses blobs; depending on the importance of your application deployments, you may want to go for geo-replication etc., but in this example, I will be going with a locally redundant, StorageV2 general-purpose account."}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["Open the ",(0,t.jsx)(n.a,{href:"https://portal.azure.com/#home",title:"Microsoft Azure Portal",children:(0,t.jsx)(n.strong,{children:"Azure Portal"})})]}),"\n",(0,t.jsxs)(n.li,{children:["Click on ",(0,t.jsx)(n.strong,{children:"+ Create a Resource"})]}),"\n",(0,t.jsxs)(n.li,{children:["Search for: ",(0,t.jsx)(n.strong,{children:"Storage account"}),", and ",(0,t.jsx)(n.strong,{children:"select"})," it"]}),"\n",(0,t.jsxs)(n.li,{children:["Click ",(0,t.jsx)(n.a,{href:"https://portal.azure.com/#create/Microsoft.StorageAccount-ARM",title:"Create a storage account",children:(0,t.jsx)(n.strong,{children:"Create"})})]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Select"})," your ",(0,t.jsx)(n.strong,{children:"subscription"})]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Select"})," a ",(0,t.jsx)(n.strong,{children:"Resource Group"})," for your storage account, ",(0,t.jsx)(n.strong,{children:"or create"})," a new ",(0,t.jsx)(n.strong,{children:"one"})]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Enter"})," your storage account ",(0,t.jsx)(n.strong,{children:"name"})," ",(0,t.jsx)(n.em,{children:"(this needs to be globally unique)"})]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Select"})," your ",(0,t.jsx)(n.strong,{children:"region"})," that your application will be in; although the application can be replicated to other regions, it's better to select your primary region here."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Select"})," the ",(0,t.jsx)(n.strong,{children:"performance"})," and ",(0,t.jsx)(n.strong,{children:"redundancy"})," to match your requirements and click ",(0,t.jsx)(n.strong,{children:"Next: Advanced"})]}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.img,{alt:"Azure Portal - Create Storage Account",src:i(59774).Z+"",width:"910",height:"937"})}),"\n",(0,t.jsxs)(n.li,{children:["You can ",(0,t.jsx)(n.strong,{children:"leave"})," most ",(0,t.jsx)(n.strong,{children:"settings"})," here as ",(0,t.jsx)(n.strong,{children:"default"}),", the application executable will need to be able to be accessed directly; make sure the ",(0,t.jsx)(n.strong,{children:"Minimum TLS"})," is at least ",(0,t.jsx)(n.strong,{children:"1.2"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["You don't need hierarchical namespace etc.; unselect '",(0,t.jsx)(n.em,{children:"Allow cross-tenant replication'"})," unless this is a feature you use."]}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.img,{alt:"Azure Portal - Create Storage Account",src:i(12579).Z+"",width:"1035",height:"1183"})}),"\n",(0,t.jsxs)(n.li,{children:["Click ",(0,t.jsx)(n.strong,{children:"Review + Create"})," to skip to the last blade; most defaults are fine, but if you want to adjust the blob retainment and soft delete settings, go to the Data Protection tab, set them, then review your Configuration and select ",(0,t.jsx)(n.strong,{children:"Create"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["Go back to your storage account and click ",(0,t.jsx)(n.strong,{children:"Configuration"})]}),"\n",(0,t.jsxs)(n.li,{children:["Make sure: Allow storage account key access is: ",(0,t.jsx)(n.strong,{children:"Enabled"}),"; if it is not, select Enabled and click ",(0,t.jsx)(n.strong,{children:"Save"}),"."]}),"\n"]}),"\n",(0,t.jsx)(n.h4,{id:"setup-azure-compute-gallery",children:"Setup Azure Compute Gallery"}),"\n",(0,t.jsxs)(n.p,{children:["Now that we have the Storage account to store your application binaries, we now need an Azure Compute Gallery ",(0,t.jsx)(n.em,{children:"(previously the Shared Image Gallery)"})," to keep your application definition and version metadata."]}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["Open the ",(0,t.jsx)(n.a,{href:"https://portal.azure.com/#home",title:"Microsoft Azure Portal",children:(0,t.jsx)(n.strong,{children:"Azure Portal"})})]}),"\n",(0,t.jsxs)(n.li,{children:["Click on ",(0,t.jsx)(n.strong,{children:"+ Create a Resource"})]}),"\n",(0,t.jsxs)(n.li,{children:["Search for: ",(0,t.jsx)(n.strong,{children:"Azure Compute Gallery"})," and ",(0,t.jsx)(n.strong,{children:"select"})," it"]}),"\n",(0,t.jsxs)(n.li,{children:["Click ",(0,t.jsx)(n.a,{href:"https://portal.azure.com/#create/microsoft.sharedImageGallery",title:"Create Azure compute gallery",children:(0,t.jsx)(n.strong,{children:"Create"})})]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Select"})," your ",(0,t.jsx)(n.strong,{children:"subscription"})," and ",(0,t.jsx)(n.strong,{children:"resource group"})," ",(0,t.jsx)(n.em,{children:"(in this case, I am going to use the same resource group as the Storage account I created earlier)"})]}),"\n",(0,t.jsxs)(n.li,{children:["Type in a ",(0,t.jsx)(n.strong,{children:"name"}),", and ",(0,t.jsx)(n.strong,{children:"select"})," your ",(0,t.jsx)(n.strong,{children:"region"})]}),"\n",(0,t.jsx)(n.li,{children:"Although not mandatory, use the opportunity to fill in a description for the purpose of the Compute Gallery for future reference"}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.img,{alt:"Azure Portal - Create Storage Account",src:i(37176).Z+"",width:"796",height:"605"})}),"\n",(0,t.jsxs)(n.li,{children:["Select ",(0,t.jsx)(n.strong,{children:"Review + Create"})]}),"\n",(0,t.jsxs)(n.li,{children:["Verify everything is correct and click on: ",(0,t.jsx)(n.strong,{children:"Create"})]}),"\n"]}),"\n",(0,t.jsx)(n.h4,{id:"create-application-definition",children:"Create Application Definition"}),"\n",(0,t.jsx)(n.p,{children:"VM application definitions are created within a gallery and carry information about the application and requirements for using it internally. This includes the operating system type for the VM application versions contained within the application definition. The name of your Application definition defines the name of the file that will be downloaded to your virtual machines."}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["Open the ",(0,t.jsx)(n.a,{href:"https://portal.azure.com/#home",title:"Microsoft Azure Portal",children:(0,t.jsx)(n.strong,{children:"Azure Portal"})})]}),"\n",(0,t.jsxs)(n.li,{children:["Navigate to '",(0,t.jsx)(n.strong,{children:"All Resources'"})]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Find and click on"})," your ",(0,t.jsx)(n.strong,{children:"Azure Compute Gallery"})," you created earlier"]}),"\n",(0,t.jsxs)(n.li,{children:["On the overview pane, select ",(0,t.jsx)(n.strong,{children:"+ Add"})]}),"\n",(0,t.jsxs)(n.li,{children:["Click on +",(0,t.jsx)(n.strong,{children:"VM application definition"})]}),"\n",(0,t.jsxs)(n.li,{children:["Your subscription and resource group should be automatically selected to the location of the Compute Gallery, type in the ",(0,t.jsx)(n.strong,{children:"name of"})," your ",(0,t.jsx)(n.strong,{children:"applicatio.n"})]}),"\n",(0,t.jsxs)(n.li,{children:["Select your ",(0,t.jsx)(n.strong,{children:"region"})]}),"\n",(0,t.jsxs)(n.li,{children:["Select the ",(0,t.jsx)(n.strong,{children:"OS type"})," - in my case, and I select ",(0,t.jsx)(n.strong,{children:"Windows"})]}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.img,{alt:"Azure Portal - Create Application Definition",src:i(5796).Z+"",width:"773",height:"878"})}),"\n",(0,t.jsxs)(n.li,{children:["Click ",(0,t.jsx)(n.strong,{children:"Next: Publishing Options"})]}),"\n",(0,t.jsxs)(n.li,{children:["The following fields are not mandatory, but I recommend filling in areas to help report on and manage your applications.\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Description"}),"\n",(0,t.jsx)(n.li,{children:"End of life date"}),"\n",(0,t.jsx)(n.li,{children:"Eula link"}),"\n",(0,t.jsx)(n.li,{children:"Privacy URI"}),"\n",(0,t.jsx)(n.li,{children:"Release notes URI"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.img,{alt:"Azure Portal - Create Metadata",src:i(59856).Z+"",width:"751",height:"511"})}),"\n",(0,t.jsxs)(n.li,{children:["Click ",(0,t.jsx)(n.strong,{children:"Review + create"})]}),"\n",(0,t.jsxs)(n.li,{children:["Verify your Configuration and select ",(0,t.jsx)(n.strong,{children:"Create"})]}),"\n"]}),"\n",(0,t.jsx)(n.h4,{id:"create-application-version",children:"Create Application version"}),"\n",(0,t.jsx)(n.p,{children:"Now that we have the application definition setup, it's time to set up the version and upload our binary file.+"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Open the ",(0,t.jsx)(n.a,{href:"https://portal.azure.com/#home",title:"Microsoft Azure Portal",children:(0,t.jsx)(n.strong,{children:"Azure Portal"})})]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Navigate to '",(0,t.jsx)(n.strong,{children:"All Resources'"})]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Find and click on"})," your ",(0,t.jsx)(n.strong,{children:"Azure Compute Gallery"})," you created earlier"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Click on ",(0,t.jsx)(n.strong,{children:"Definitions"}),(0,t.jsx)(n.em,{children:"(besides the Get Started link)"})]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Select"})," your Application ",(0,t.jsx)(n.strong,{children:"definition"})]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Click on: ",(0,t.jsx)(n.strong,{children:"+Add"})]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Enter"})," in your ",(0,t.jsx)(n.strong,{children:"version number"}),", and this will increment and grow as you adjust and troubleshoot your application; I recommend starting with 0.0.1 then working your way up, with 1.0.0 being potentially your final/production-ready releast."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Select your ",(0,t.jsx)(n.strong,{children:"Region"})]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Now we need to select our source application package ",(0,t.jsx)(n.em,{children:"(you can enter in your blob URL if you know it)"}),"; we haven't uploaded it to our storage account yet, so we will select ",(0,t.jsx)(n.strong,{children:"Browse"})]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Select"})," your ",(0,t.jsx)(n.strong,{children:"Storage account"})]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Press ",(0,t.jsx)(n.strong,{children:"+ Container"})]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Enter"})," in the ",(0,t.jsx)(n.strong,{children:"name"})," of your ",(0,t.jsx)(n.strong,{children:"container"})," ",(0,t.jsx)(n.em,{children:"( it has to be in lowercase)"}),", such as the application name ",(0,t.jsx)(n.em,{children:"(to keep things separate, consider a container per application)"})]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Press ",(0,t.jsx)(n.strong,{children:"Upload"})]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Browse"})," to your ",(0,t.jsx)(n.strong,{children:"file"})," and select it"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Expand ",(0,t.jsx)(n.strong,{children:"Advanced"})]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Make sure that Blob type is: ",(0,t.jsx)(n.strong,{children:"Blob"})]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"Azure Portal - Azure Blob",src:i(25190).Z+"",width:"1417",height:"1072"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Click ",(0,t.jsx)(n.strong,{children:"Upload"})]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Select"})," your newly uploaded file and click ",(0,t.jsx)(n.strong,{children:"Select"})]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.em,{children:"Note: You can only upload one file as part of your package, you can upload a ZIP file and have your Install script extract it"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.strong,{children:"Install script"})," is the command to install to your application, by default windows applications are set to install cmd. This already knows the directory your files are in because the file will be uploaded as the application name (i.e. DattoRMM), it needs to be renamed to include .exe and then ran, I will switch to PowerShell for the Install script, so will enter:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"powershell.exe -command \"Rename-Item '.\\DattoRMM' -NewName 'DattoRMM.exe'; Start-Process '.\\DattoRMM.exe'\"\n"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["If you have a script to uninstall the application, enter it ",(0,t.jsx)(n.em,{children:"(in my case, I am just going to put a '.' to skip this, as I don't currently have an uninstall script developed)"})]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"The rest of the Configuration isn't mandatory; the Update script is used by Azure when a new version of an application is created; by default, the Azure VM extension will treat an upgrade like a completely new install and run the install steps unless an update script is defined."}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"Azure Portal - Application Version",src:i(97294).Z+"",width:"865",height:"1062"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Click ",(0,t.jsx)(n.strong,{children:"Next: Replication"})]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Like Azure Compute Images, you can replicate your Azure VM applications across multiple regions ",(0,t.jsx)(n.em,{children:"(depending on where your workloads are)"}),", such as Australia East to West Europe, and store it then Zone Redundant or Local storage. In my example, I am going to leave mine as one replica in Australia East on locally-redundant storage and click ",(0,t.jsx)(n.strong,{children:"Review + create"})]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Verify everything looks ok and click ",(0,t.jsx)(n.strong,{children:"Create"})," to create your application version! This may take a few minutes to create, depending on your configuration and replication."]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"deploy-azure-vm-application",children:"Deploy Azure VM Application"}),"\n",(0,t.jsx)(n.h4,{id:"deploy-azure-vm-application-to-virtual-machines-using-the-azure-portal",children:"Deploy Azure VM Application to Virtual Machines using the Azure Portal"}),"\n",(0,t.jsx)(n.p,{children:"Now that your Azure VM Application has been created, it is now time to deploy to a Virtual Machine. I have a Windows Server 2022 Datacenter Azure Gen 2 VM running as a Standard_B2ms as my test machine, and because I am going to use the Datto RMM agent to connect to the machine, I don't need any RDP ports open etc."}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["Open the ",(0,t.jsx)(n.a,{href:"https://portal.azure.com/#home",title:"Microsoft Azure Portal",children:(0,t.jsx)(n.strong,{children:"Azure Portal"})})]}),"\n",(0,t.jsxs)(n.li,{children:["Navigate to ",(0,t.jsx)(n.strong,{children:"Virtual Machines"})]}),"\n",(0,t.jsx)(n.li,{children:"Click on your Virtual Machine"}),"\n",(0,t.jsxs)(n.li,{children:["Under Settings, click ",(0,t.jsx)(n.strong,{children:"Extensions + Applications"})]}),"\n",(0,t.jsxs)(n.li,{children:["Click ",(0,t.jsx)(n.strong,{children:"VM Applications"})]}),"\n",(0,t.jsxs)(n.li,{children:["Click ",(0,t.jsx)(n.strong,{children:"+ Add application"})]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Select"})," your ",(0,t.jsx)(n.strong,{children:"application"})," ",(0,t.jsx)(n.em,{children:"(note you can select a particular version, by default, it is the latest)"})]}),"\n",(0,t.jsxs)(n.li,{children:["Click ",(0,t.jsx)(n.strong,{children:"Ok"})]}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.img,{alt:"Azure Portal - VM-P01",src:i(4909).Z+"",width:"1427",height:"675"})}),"\n",(0,t.jsxs)(n.li,{children:["You can select your Install Order ",(0,t.jsx)(n.em,{children:"(i.e. if you had multiple applications, you can select which one installs 1st, 2nd, third and so on)"}),"; I will select No Reference and click Save to start the deployment."]}),"\n",(0,t.jsx)(n.li,{children:'If you click Extensions, you should see that a: VMAppExtension has started to be installed; click on Refresh to update the status and click on the Extension to a more detailed status message, hopefully you see ":Operational Install is SUCCESS"'}),"\n",(0,t.jsx)(n.li,{children:"My Virtual Machine has now had the Datto Remote Management agent installed successfully and has appeared in the portal for me to connect to!"}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.img,{alt:"Azure - Datto RMM",src:i(81123).Z+"",width:"601",height:"254"})}),"\n"]}),"\n",(0,t.jsx)(n.h4,{id:"deploy-azure-vm-application-to-multiple-virtual-machines-using-powershell",children:"Deploy Azure VM Application to Multiple Virtual Machines using PowerShell"}),"\n",(0,t.jsx)(n.p,{children:"I've created the PowerShell script below to deploy an application to multiple Virtual Machines at once, it can easily be adjusted for a PowerShell Runbook that runs periodically to install software on machines it may be missing. As usual, please make sure you test and run any PowerShell scripts first in a demo environment."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"$allvms = Get-AzVM\n$applicationname = 'DattoRMM'\n$galleryname = 'AzComputeGallery'\n$galleryrg = 'vmapps-prod-rg'\n$appversion = '0.0.1'\n\n  \ntry\n{\n  ForEach ($vm in $allvms)\n\n  {\n    $AzVM = Get-AzVM -ResourceGroupName $vm.ResourceGroupName -Name $vm.Name\n    $appversion = Get-AzGalleryApplicationVersion `\n    -GalleryApplicationName $applicationname `\n    -GalleryName $galleryname `\n    -Name $appversion `\n    -ResourceGroupName $galleryrg\n    $packageid = $appversion.Id\n    $app = New-AzVmGalleryApplication -PackageReferenceId $packageid\n    Add-AzVmGalleryApplication -VM $AzVM -GalleryApplication $app\n    Update-AzVM -ResourceGroupName $vm.ResourceGroupName -VM $AzVM -ErrorAction Stop\n  }\n}\n\ncatch [Microsoft.Azure.Commands.Compute.Common.ComputeCloudException]\n{\n  #Most likely failed due to duplicate package ID/identical version\n  [Management.Automation.ErrorRecord]$e = $_\n\n  $info = [PSCustomObject]@{\n    Exception = $e.Exception.Message\n    Reason    = $e.CategoryInfo.Reason\n    Target    = $e.CategoryInfo.TargetName\n  }\n\n  $info\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"troubleshooting-vm-application",children:"Troubleshooting VM Application"}),"\n",(0,t.jsx)(n.p,{children:"If you have problems installing a package, just a reminder that the VM Application, uploads your file based on the name of the Application, to the server and needs to be renamed with a valid extension as part of the install script."}),"\n",(0,t.jsx)(n.h4,{id:"package-location",children:"Package Location"}),"\n",(0,t.jsx)(n.p,{children:"The package/extension location is here:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"C:\\Packages\\Plugins\\Microsoft.CPlat.Core.VMApplicationManagerWindows\\{VERSION#}\\"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"You will find your Application binary under Downloads."}),"\n",(0,t.jsx)(n.h4,{id:"logs",children:"Logs"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"For the extension status logs, navigate to:"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"C:\\Packages\\Plugins\\Microsoft.CPlat.Core.VMApplicationManagerWindows\\{VERSION#}\\Status"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"You should see files such as:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"0.status"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"You can right-click these and open them in Notepad, and you should have the timestamp and the last status message, this should be identical to what you see in the Azure Portal."}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"For the application install logs, navigate to:"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"C:\\Packages\\Plugins\\Microsoft.CPlat.Core.VMApplicationManagerWindows\\{VERSION#}\\Downloads\\{APPNAME}\\{APPVERSION}\\"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"You may see files such as:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"stderr"}),"\n",(0,t.jsx)(n.li,{children:"stdout"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"You can right-click these and open them in Notepad, any errors will be noted in these."}),"\n",(0,t.jsx)(n.h4,{id:"troubleshooting-during-preview",children:"Troubleshooting during preview"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/azure/virtual-machines/vm-applications?WT.mc_id=AZ-MVP-5004796#troubleshooting-during-preview",title:"Troubleshooting during preview",children:"Troubleshooting during preview"})}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,r.a)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},12579:(e,n,i)=>{i.d(n,{Z:()=>t});const t=i.p+"assets/images/create-a-storage-account-advanced-microsoft-azure-619d94a152780cdca4cf6f5c9cd69060.png"},59774:(e,n,i)=>{i.d(n,{Z:()=>t});const t=i.p+"assets/images/create-a-storage-account-microsoft-azure-6c3cf423d43d18281bf042d6325ffbe7.png"},59856:(e,n,i)=>{i.d(n,{Z:()=>t});const t=i.p+"assets/images/create-a-vm-application-definition-metadata-microsoft-azure-648f195d72135cdf78547179db26f318.png"},5796:(e,n,i)=>{i.d(n,{Z:()=>t});const t=i.p+"assets/images/create-a-vm-application-definition-microsoft-azure-65e5e7ef47340d1255b43581f5a68fa4.png"},97294:(e,n,i)=>{i.d(n,{Z:()=>t});const t=i.p+"assets/images/create-a-vm-application-version-microsoft-azure-0df2a1f5e8b68233635efdfb6ac2cf7a.png"},37176:(e,n,i)=>{i.d(n,{Z:()=>t});const t=i.p+"assets/images/create-azure-compute-gallery-microsoft-azure-f60d33dd4dbe9c6ff1e16d399b8efb54.png"},25190:(e,n,i)=>{i.d(n,{Z:()=>t});const t=i.p+"assets/images/upload-blob-microsoft-azure-ab68e0f8c8521e5d1d61497f6b09f0ec.png"},81123:(e,n,i)=>{i.d(n,{Z:()=>t});const t=i.p+"assets/images/vm-p01-datto-rmm-034de4021906de33a95bec0d37a9a146.png"},4909:(e,n,i)=>{i.d(n,{Z:()=>t});const t=i.p+"assets/images/vm-p01-microsoft-azure-be4a29adee4d86ddd404d9ac2a5da96d.png"},11151:(e,n,i)=>{i.d(n,{Z:()=>l,a:()=>s});var t=i(67294);const r={},a=t.createContext(r);function s(e){const n=t.useContext(a);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:s(e.components),t.createElement(a.Provider,{value:n},e.children)}}}]);