"use strict";(self.webpackChunklukemurraynz=self.webpackChunklukemurraynz||[]).push([[56910],{36344:(e,s,t)=>{t.r(s),t.d(s,{assets:()=>a,contentTitle:()=>o,default:()=>h,frontMatter:()=>l,metadata:()=>r,toc:()=>c});var i=t(74848),n=t(28453);const l={title:"AVD-Collect - Azure Virtual Desktop Diagnostics and Logging",authors:["Luke"],tags:["PowerShell"],date:"2021-08-08 00:00:00 +1300",toc:!0,header:{teaser:"/uploads/avd-collect-diagreport.png"},slug:"powershell/avd-collect"},o=void 0,r={permalink:"/powershell/avd-collect",source:"@site/blog/2021-08-08-avd-collect.md",title:"AVD-Collect - Azure Virtual Desktop Diagnostics and Logging",description:"AVD-Collect is a handy PowerShell script created by Microsoft Customer Support Services to assist with troubleshooting and resolving issues with Azure Virtual Desktop (and Windows 365), by capturing Logs for analysis (which could then be passed to Microsoft or allow you to delve deeper) and running basic Diagnostics against some common known issues.",date:"2021-08-08T00:00:00.000Z",tags:[{inline:!0,label:"PowerShell",permalink:"/tags/power-shell"}],readingTime:6.015,hasTruncateMarker:!1,authors:[{name:"Luke Murray",title:"Author",url:"https://luke.geek.nz",imageURL:"https://luke.geek.nz/img/logo.png",key:"Luke",page:null}],frontMatter:{title:"AVD-Collect - Azure Virtual Desktop Diagnostics and Logging",authors:["Luke"],tags:["PowerShell"],date:"2021-08-08 00:00:00 +1300",toc:!0,header:{teaser:"/uploads/avd-collect-diagreport.png"},slug:"powershell/avd-collect"},unlisted:!1,prevItem:{title:"Update-AdmPwdAdSchema - The requested attribute does not exist",permalink:"/2021/08/21/update-admpwdadschema-the-requested-attribute-does-not-exist"},nextItem:{title:"Implement WebJEA for self-service Start/Stop of Azure Virtual Machines",permalink:"/2021/07/18/implement-webjea-for-self-service-azure-resource-creation-with-powershell"}},a={authorsImageUrls:[void 0]},c=[{value:"Script pre-requisites",id:"script-pre-requisites",level:3},{value:"Script scenarios",id:"script-scenarios",level:3},{value:"Core - suitable for troubleshooting issues that do not involve Profiles or Teams or MSIX App Attach",id:"core---suitable-for-troubleshooting-issues-that-do-not-involve-profiles-or-teams-or-msix-app-attach",level:4},{value:"Core + Profiles - suitable for troubleshooting Profiles issues",id:"core--profiles---suitable-for-troubleshooting-profiles-issues",level:4},{value:"Core + Teams - suitable for troubleshooting Teams issues",id:"core--teams---suitable-for-troubleshooting-teams-issues",level:4},{value:"Core + MSIX App Attach - suitable for troubleshooting MSIX App Attach issues",id:"core--msix-app-attach---suitable-for-troubleshooting-msix-app-attach-issues",level:4},{value:"Core + MSRA - suitable for troubleshooting Remote Assistance issues",id:"core--msra---suitable-for-troubleshooting-remote-assistance-issues",level:4},{value:"Extended (all) - suitable for troubleshooting most issues, including Profiles/FSLogix/OneDrive, Teams and MSIX App Attach",id:"extended-all---suitable-for-troubleshooting-most-issues-including-profilesfslogixonedrive-teams-and-msix-app-attach",level:4},{value:"DiagOnly",id:"diagonly",level:4},{value:"Available command line parameters (to preselect the desired scenario)",id:"available-command-line-parameters-to-preselect-the-desired-scenario",level:4},{value:"Usage example with parameters",id:"usage-example-with-parameters",level:3},{value:"Execute the script",id:"execute-the-script",level:3}];function d(e){const s={a:"a",blockquote:"blockquote",code:"code",em:"em",h3:"h3",h4:"h4",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,n.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(s.p,{children:["AVD-Collect is a handy PowerShell script created by Microsoft Customer Support Services to assist with troubleshooting and resolving issues with Azure Virtual Desktop (and Windows 365), by capturing Logs for analysis ",(0,i.jsx)(s.em,{children:"(which could then be passed to Microsoft or allow you to delve deeper)"})," and running basic Diagnostics against some common known issues."]}),"\n",(0,i.jsxs)(s.p,{children:["You can download this script from: ",(0,i.jsx)(s.a,{href:"https://aka.ms/avd-collect",title:"https://aka.ms/avd-collect?WT.mc_id=AZ-MVP-5004796",children:"https://aka.ms/avd-collect"})]}),"\n",(0,i.jsxs)(s.blockquote,{children:["\n",(0,i.jsx)(s.p,{children:"There is no publically avaliable github repository for it currently, Microsoft will retain the latest version of the script at this link."}),"\n",(0,i.jsx)(s.p,{children:"This script was NOT created by me and comes 'As/Is', this article is merely intended to share the script to assit others in their AVD troubleshooting."}),"\n",(0,i.jsx)(s.p,{children:"This script is intended to help support Microsoft Customer Support with assisting customers, but was made publically accessible to assist with MS Support cases and Azure Virtual Desktop diagnostics. No data is automatically uploaded to Microsoft."}),"\n",(0,i.jsx)(s.p,{children:"Please be aware that the script may change and include new functionality not part of this article, please review the Changelog and Readme of the script directly."}),"\n"]}),"\n",(0,i.jsxs)(s.p,{children:["A lot of the information below is contained in the script readme ",(0,i.jsx)(s.em,{children:"(including a list of the extensive diagnostics and log locations)"})," and changelog; however, I am supplying this article for reference and to help share this nifty tool."]}),"\n",(0,i.jsx)(s.h3,{id:"script-pre-requisites",children:"Script pre-requisites"}),"\n",(0,i.jsxs)(s.ol,{children:["\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsx)(s.p,{children:"The script must be run with elevated permissions to collect all required data."}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsx)(s.p,{children:"All collected data will be archived into a .zip file located in the same folder as the script itself."}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsx)(s.p,{children:"As needed, run the script on AVD host VMs and/or Windows-based devices from where you connect to the AVD hosts."}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsx)(s.p,{children:"When launched, the script will present the Microsoft Diagnostic Tools End User License Agreement (EULA). You need to accept the EULA before you can continue using the script."}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsx)(s.p,{children:"If the script does not start, complaining about execution restrictions, then in an elevated PowerShell console run:"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{children:"\tSet-ExecutionPolicy -ExecutionPolicy RemoteSigned -Force -Scope Process\n"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.em,{children:"Acceptance of the EULA will be stored in the registry under HKCU\\Software\\Microsoft\\CESDiagnosticTools, and you will not be prompted again to accept it as long as the registry key is in place."})," ",(0,i.jsx)(s.em,{children:'You can also use the "-AcceptEula" command line parameter to accept the EULA silently.'})," ",(0,i.jsx)(s.em,{children:"This is a per-user setting, so each user running the script will accept the EULA once."})]}),"\n",(0,i.jsx)(s.h3,{id:"script-scenarios",children:"Script scenarios"}),"\n",(0,i.jsx)(s.h4,{id:"core---suitable-for-troubleshooting-issues-that-do-not-involve-profiles-or-teams-or-msix-app-attach",children:"Core - suitable for troubleshooting issues that do not involve Profiles or Teams or MSIX App Attach"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Collects core troubleshooting data without including Profiles/FSLogix/OneDrive or Teams or MSIXAA related data"}),"\n",(0,i.jsx)(s.li,{children:"Runs Diagnostics."}),"\n"]}),"\n",(0,i.jsx)(s.h4,{id:"core--profiles---suitable-for-troubleshooting-profiles-issues",children:"Core + Profiles - suitable for troubleshooting Profiles issues"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Collects all Core data"}),"\n",(0,i.jsx)(s.li,{children:"Collects Profiles/FSLogix/OneDrive related information, as available"}),"\n",(0,i.jsx)(s.li,{children:"Runs Diagnostics."}),"\n"]}),"\n",(0,i.jsx)(s.h4,{id:"core--teams---suitable-for-troubleshooting-teams-issues",children:"Core + Teams - suitable for troubleshooting Teams issues"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Collects all Core data"}),"\n",(0,i.jsx)(s.li,{children:"Collects Teams related information, as available"}),"\n",(0,i.jsx)(s.li,{children:"Runs Diagnostics."}),"\n"]}),"\n",(0,i.jsx)(s.h4,{id:"core--msix-app-attach---suitable-for-troubleshooting-msix-app-attach-issues",children:"Core + MSIX App Attach - suitable for troubleshooting MSIX App Attach issues"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Collects all Core data"}),"\n",(0,i.jsx)(s.li,{children:"Collects MSIX App Attach related information, as available"}),"\n",(0,i.jsx)(s.li,{children:"Runs Diagnostics."}),"\n"]}),"\n",(0,i.jsx)(s.h4,{id:"core--msra---suitable-for-troubleshooting-remote-assistance-issues",children:"Core + MSRA - suitable for troubleshooting Remote Assistance issues"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Collects all Core data"}),"\n",(0,i.jsx)(s.li,{children:"Collects Remote Assistance related information, as available"}),"\n",(0,i.jsx)(s.li,{children:"Runs Diagnostics."}),"\n"]}),"\n",(0,i.jsx)(s.h4,{id:"extended-all---suitable-for-troubleshooting-most-issues-including-profilesfslogixonedrive-teams-and-msix-app-attach",children:"Extended (all) - suitable for troubleshooting most issues, including Profiles/FSLogix/OneDrive, Teams and MSIX App Attach"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Collects all Core data"}),"\n",(0,i.jsx)(s.li,{children:"Collects Profiles/FSLogix/OneDrive related information, as available"}),"\n",(0,i.jsx)(s.li,{children:"Collects Microsoft Teams related information, as available"}),"\n",(0,i.jsx)(s.li,{children:"Collects MSIX App Attach related information, as available"}),"\n",(0,i.jsx)(s.li,{children:"Runs Diagnostics."}),"\n"]}),"\n",(0,i.jsx)(s.h4,{id:"diagonly",children:"DiagOnly"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Skips all Core/Extended data collection and runs Diagnostics only ",(0,i.jsx)(s.em,{children:"(regardless of any other parameters that have been specified)"}),"."]}),"\n"]}),"\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.strong,{children:'The default scenario is "Core".\u200b\u200b\u200b\u200b\u200b\u200b\u200b'})}),"\n",(0,i.jsx)(s.h4,{id:"available-command-line-parameters-to-preselect-the-desired-scenario",children:"Available command line parameters (to preselect the desired scenario)"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Core - Collects Core data + Runs Diagnostics"}),"\n",(0,i.jsxs)(s.li,{children:["Extended - Collects all Core data + Extended ",(0,i.jsx)(s.em,{children:"(Profiles/FSLogix/OneDrive, Teams, MSIX App Attach)"})," data + Runs Diagnostics"]}),"\n",(0,i.jsx)(s.li,{children:"Profiles - Collects all Core data + Profiles/FSLogix/OneDrive data + Runs Diagnostics"}),"\n",(0,i.jsx)(s.li,{children:"Teams - Collects all Core data + Teams data + Runs Diagnostics"}),"\n",(0,i.jsx)(s.li,{children:"MSIXAA - Collects all Core data + MSIX App Attach data + Runs Diagnostics"}),"\n",(0,i.jsx)(s.li,{children:"MSRA - Collects all Core data + Remote Assistance data + Runs Diagnostics"}),"\n",(0,i.jsxs)(s.li,{children:["DiagOnly - The script will skip all data collection and will only run the diagnostics part ",(0,i.jsx)(s.em,{children:"(even if other parameters have been included)"}),"."]}),"\n",(0,i.jsx)(s.li,{children:"AcceptEula - Silently accepts the Microsoft Diagnostic Tools End User License Agreement."}),"\n"]}),"\n",(0,i.jsx)(s.h3,{id:"usage-example-with-parameters",children:"Usage example with parameters"}),"\n",(0,i.jsx)(s.p,{children:"To collect only Core data (excluding Profiles/FSLogix/OneDrive, Teams, MSIX App Attach):"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{children:"\t.\\AVD-Collect.ps1 -Core\n"})}),"\n",(0,i.jsx)(s.p,{children:"To collect Core + Extended data (incl. Profiles/FSLogix/OneDrive, Teams, MSIX App Attach):"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{children:"\t.\\AVD-Collect.ps1 -Extended\n"})}),"\n",(0,i.jsx)(s.p,{children:"To collect Core + Profiles + MSIX App Attach data"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{children:"\t.\\AVD-Collect.ps1 -Profiles -MSIXAA\n"})}),"\n",(0,i.jsx)(s.p,{children:"To collect Core + Profiles data"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{children:"\t.\\AVD-Collect.ps1 -Profiles\n"})}),"\n",(0,i.jsx)(s.p,{children:'\u200b\u200b\u200b\u200b\u200b\u200b\u200bIf you are missing any of the data that the script should normally collect, check the content of the "__AVD-Collect-Log.txt" and "__AVD-Collect-Errors.txt" files for more information. Some data may not be present during data collection and thus not picked up by the script.'}),"\n",(0,i.jsx)(s.h3,{id:"execute-the-script",children:"Execute the script"}),"\n",(0,i.jsxs)(s.ol,{children:["\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Download"})," the AVD-Collect ",(0,i.jsx)(s.strong,{children:"script"})," to the session host you need to collect the logs from, if you haven't already."]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Extract"})," the ",(0,i.jsx)(s.strong,{children:"script"})," to a folder ",(0,i.jsx)(s.em,{children:"(i.e. C:\\Users\\%username&\\Downloads\\AVD-Collect)"})]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsx)(s.p,{children:"Right-click on: AVD-Collect.ps1, select Properties"}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsxs)(s.p,{children:["Because this file has been downloaded from the Internet, it may be in a protected/block status - select ",(0,i.jsx)(s.strong,{children:"Unblock"})," and click ",(0,i.jsx)(s.strong,{children:"Apply"})]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsx)(s.p,{children:"Open Windows Powershell as Administrator"}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsxs)(s.p,{children:["Now we need to ",(0,i.jsx)(s.strong,{children:"change"})," the ",(0,i.jsx)(s.strong,{children:"directory"})," for where the script is located; in my example, the command I use is:"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{children:"cd 'C:\\Users\\Luke\\Downloads\\AVD-Collect'\n"})}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsxs)(s.p,{children:["By default, the script will run as 'Core', and I want to include everything, profiles, Teams etc., so ",(0,i.jsx)(s.strong,{children:"run"})," Extended:"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{children:".\\AVD-Collect.ps1 -Extended -AcceptEula\n"})}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Read"})," the notice from the Microsoft Customer Support centre and press '",(0,i.jsx)(s.strong,{children:"Y"}),"' if you ",(0,i.jsx)(s.strong,{children:"accept"})," to move onto the next steps."]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsxs)(s.p,{children:["The ",(0,i.jsx)(s.strong,{children:"script"})," will now ",(0,i.jsx)(s.strong,{children:"run"}),":"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.img,{alt:"AVD- Script Running",src:t(4134).A+"",title:"AVD- Script Running",width:"855",height:"237"})}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsx)(s.p,{children:"You will start to see new folders get created in the directory that the script is running from with the extracted log files. The script will take a few minutes to complete as it extracts the logs and then zips them."}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsxs)(s.p,{children:["Once the script has ran, there will now be a ",(0,i.jsx)(s.strong,{children:"ZIP file"})," of all the Logs collected by the script. In my example, the ",(0,i.jsx)(s.strong,{children:"logs"})," consisted of:"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Certificates"}),"\n",(0,i.jsx)(s.li,{children:"Recent Event Log"}),"\n",(0,i.jsx)(s.li,{children:"FSLogix logs"}),"\n",(0,i.jsx)(s.li,{children:"Networking"}),"\n",(0,i.jsx)(s.li,{children:"Registry Keys"}),"\n",(0,i.jsx)(s.li,{children:"Teams information"}),"\n",(0,i.jsx)(s.li,{children:"System information"}),"\n",(0,i.jsx)(s.li,{children:"Networking and Firewall information"}),"\n"]}),"\n",(0,i.jsxs)(s.ol,{start:"13",children:["\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.img,{alt:"AVD-Collect Logs",src:t(29812).A+"",title:"AVD-Collect Logs",width:"495",height:"342"})}),"\n",(0,i.jsxs)(s.li,{children:["If needed, you can now ",(0,i.jsx)(s.strong,{children:"send"})," or upload the ",(0,i.jsx)(s.strong,{children:"ZIP"})," file to Microsoft ",(0,i.jsx)(s.strong,{children:"support"}),". If you are troubleshooting yourself, you can navigate to the folders to look at the specific logs you want, all in one place!"]}),"\n",(0,i.jsxs)(s.li,{children:["To ",(0,i.jsx)(s.strong,{children:"look"})," at ",(0,i.jsx)(s.strong,{children:"Diagnostic"})," information, open the: ",(0,i.jsx)(s.strong,{children:"AVD-Diag.html"})," file."]}),"\n",(0,i.jsxs)(s.li,{children:["You can now see a list of common issues, what the script is looking for, and whether the host has passed or failed these scripts ",(0,i.jsx)(s.em,{children:"(this can be very useful for Azure Virtual Desktop hosts, to make sure all the standard configuration is done or being applied, including making sure that the session host has access to all the external resources it needs"}),"):"]}),"\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.img,{alt:"AVD-Collect Diagnostics",src:t(6598).A+"",title:"AVD-Collect Diagnostics",width:"1487",height:"929"})}),"\n"]})]})}function h(e={}){const{wrapper:s}={...(0,n.R)(),...e.components};return s?(0,i.jsx)(s,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},6598:(e,s,t)=>{t.d(s,{A:()=>i});const i=t.p+"assets/images/avd-collect-diagreport-ea0ec39061efa2d1606d30a8271d4a15.png"},29812:(e,s,t)=>{t.d(s,{A:()=>i});const i=t.p+"assets/images/avd-collect-postrun-58e7188011316714735af65e00f442e0.png"},4134:(e,s,t)=>{t.d(s,{A:()=>i});const i=t.p+"assets/images/avd-collect_running-b41bcdee269b2479cb7fac5270563bf7.png"},28453:(e,s,t)=>{t.d(s,{R:()=>o,x:()=>r});var i=t(96540);const n={},l=i.createContext(n);function o(e){const s=i.useContext(l);return i.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function r(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:o(e.components),i.createElement(l.Provider,{value:s},e.children)}}}]);