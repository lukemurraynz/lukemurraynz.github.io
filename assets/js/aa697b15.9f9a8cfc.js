"use strict";(self.webpackChunklukemurraynz=self.webpackChunklukemurraynz||[]).push([[28675],{61610:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>u,contentTitle:()=>s,default:()=>h,frontMatter:()=>i,metadata:()=>a,toc:()=>c});var r=n(74848),o=n(28453);const i={title:"Access denied on Azure VM when using aztfexport",authors:["Luke"],tags:["Azure"],toc:!1,header:{teaser:"/images/posts/aztfexport_access_denied.png"},date:"2023-07-10 00:00:00 +1300",slug:"azure/Access-denied-aztfexport"},s=void 0,a={permalink:"/azure/Access-denied-aztfexport",source:"@site/blog/2023-07-10-Access-denied-aztfexport.md",title:"Access denied on Azure VM when using aztfexport",description:"When attempting to use aztfexport, a tool designed to export currently deployed Azure resources into HashiCorp Configuration Language (HCL) for use with Terraform, you may get: Access denied.",date:"2023-07-10T00:00:00.000Z",tags:[{label:"Azure",permalink:"/tags/azure"}],readingTime:1.54,hasTruncateMarker:!1,authors:[{name:"Luke Murray",title:"Author",url:"https://luke.geek.nz",imageURL:"https://luke.geek.nz/img/logo.png",key:"Luke"}],frontMatter:{title:"Access denied on Azure VM when using aztfexport",authors:["Luke"],tags:["Azure"],toc:!1,header:{teaser:"/images/posts/aztfexport_access_denied.png"},date:"2023-07-10 00:00:00 +1300",slug:"azure/Access-denied-aztfexport"},unlisted:!1,prevItem:{title:"Changing the default Management Group in Azure",permalink:"/azure/Changing-default-management-group-for-azure"},nextItem:{title:"Azure OpenAI error log summarization with completion",permalink:"/azure/Azure-OpenAI-error-log-summarization"}},u={authorsImageUrls:[void 0]},c=[];function d(e){const t={a:"a",code:"code",img:"img",p:"p",pre:"pre",strong:"strong",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(t.p,{children:["When attempting to use ",(0,r.jsx)(t.a,{href:"https://github.com/Azure/aztfexport",children:"aztfexport"}),", a tool designed to export currently deployed Azure resources into HashiCorp Configuration Language (HCL) for use with Terraform, you may get: Access denied."]}),"\n",(0,r.jsxs)(t.p,{children:["When using aztfexport, the first thing you need to do is make sure you have the ",(0,r.jsx)(t.a,{href:"https://learn.microsoft.com/cli/azure/install-azure-cli?WT.mc_id=AZ-MVP-5004796",children:"Azure CLI"})," installed, and run an:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"az login\n"})}),"\n",(0,r.jsx)(t.p,{children:"After logging in, you need to verify you are on the right subscription, by running:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"az account show\n"})}),"\n",(0,r.jsx)(t.p,{children:"If you are on the right subscription, you don't need to do anything. If you are in the wrong subscription then run:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"az account list\n"})}),"\n",(0,r.jsx)(t.p,{children:"Find the susbcription ID then use:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"az account set --subscription <name or id>\n"})}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.strong,{children:"You only need Reader rights to be able to export the Terraform configuration."})}),"\n",(0,r.jsx)(t.p,{children:"If you find you are still running into access denied issues, such as below:"}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.img,{alt:"aztfexport - Access denied",src:n(37918).A+"",title:"aztfexport - Access denied",width:"1172",height:"458"})}),"\n",(0,r.jsxs)(t.p,{children:["And you are running the aztfexport program on an Azure Virtual Machine, such as Azure Virtual Desktop or Devbox, what is happening is the ",(0,r.jsx)(t.a,{href:"https://learn.microsoft.com/azure/active-directory/managed-identities-azure-resources/overview?WT.mc_id=AZ-MVP-5004796",children:"Managed Identity"})," permissions of your Azure Virtual Machine is overriding your own permissions you used to login to Azure using the CLI."]}),"\n",(0,r.jsx)(t.p,{children:"To get around this, you either have to run aztfexport locally, on a device thats not an Azure Virtual Machine, or supply the Managed Identity of the Virtual Machine, Reader rights to the subscription you wish to do the export from."}),"\n",(0,r.jsx)(t.p,{children:"You can do this, by navigating to your Azure Virtual Machine, in the Azure Portal, click on the Virtual Machine, select Identity, select Azure role assignments and grant it Reader rights to the Resource Group or Subscription you are targeting."}),"\n",(0,r.jsx)(t.p,{children:"You could try Disabling the System Assigned Managed Identity as well, which appeared to work for me."}),"\n",(0,r.jsxs)(t.p,{children:["For more information about this error, please refer to the following Github issue: ",(0,r.jsx)(t.a,{href:"https://github.com/Azure/aztfexport/issues/380",children:"Access Denied during xport on Azure Virtual Desktop"}),"."]})]})}function h(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},37918:(e,t,n)=>{n.d(t,{A:()=>r});const r=n.p+"assets/images/aztfexport_access_denied-8ef0fba28e1aa69827b029bd565978e3.png"},28453:(e,t,n)=>{n.d(t,{R:()=>s,x:()=>a});var r=n(96540);const o={},i=r.createContext(o);function s(e){const t=r.useContext(i);return r.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:s(e.components),r.createElement(i.Provider,{value:t},e.children)}}}]);