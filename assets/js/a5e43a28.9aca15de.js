"use strict";(self.webpackChunklukemurraynz=self.webpackChunklukemurraynz||[]).push([[27881],{95994:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>n,metadata:()=>i,toc:()=>c});var r=a(85893),s=a(11151);const n={date:"2023-04-07 00:00:00 +1200",title:"Failed to persist Terraform state using an Azure Blob Storage account",authors:["Luke"],tags:["Azure"],toc:!1,header:{teaser:"/uploads/terraform_savestate.PNG"},slug:"azure/failed-to-persist-terraform-state-using-an-azure-blob-storage-account"},o=void 0,i={permalink:"/azure/failed-to-persist-terraform-state-using-an-azure-blob-storage-account",source:"@site/blog/2023-04-07-failed-to-persist-terraform-state-using-an-azure-blob-storage-account.md",title:"Failed to persist Terraform state using an Azure Blob Storage account",description:"When attempting to make changes with Terraform, and the state changes are in an Azure storage account, you may come across: Failed to save state.",date:"2023-04-07T00:00:00.000Z",formattedDate:"April 7, 2023",tags:[{label:"Azure",permalink:"/tags/azure"}],readingTime:1.47,hasTruncateMarker:!1,authors:[{name:"Luke Murray",title:"Author",url:"https://luke.geek.nz",imageURL:"https://luke.geek.nz/img/logo.png",key:"Luke"}],frontMatter:{date:"2023-04-07 00:00:00 +1200",title:"Failed to persist Terraform state using an Azure Blob Storage account",authors:["Luke"],tags:["Azure"],toc:!1,header:{teaser:"/uploads/terraform_savestate.PNG"},slug:"azure/failed-to-persist-terraform-state-using-an-azure-blob-storage-account"},unlisted:!1,prevItem:{title:"Open multiple Microsoft Teams instances using PowerShell",permalink:"/2023/05/03/Open-multiple-Microsoft-Teams-instances-using-PowerShell"},nextItem:{title:"Azure Quick Review",permalink:"/azure/azure-quick-review"}},l={authorsImageUrls:[void 0]},c=[];function u(e){const t={a:"a",blockquote:"blockquote",img:"img",li:"li",ol:"ol",p:"p",strong:"strong",...(0,s.a)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(t.p,{children:["When attempting to make changes with Terraform, and the ",(0,r.jsx)(t.a,{href:"https://learn.microsoft.com/azure/developer/terraform/store-state-in-azure-storage?tabs=azure-cli&WT.mc_id=AZ-MVP-5004796",title:"Store Terraform state in Azure Storage",children:"state changes are in an Azure storage account"}),", you may come across: Failed to save state."]}),"\n",(0,r.jsxs)(t.blockquote,{children:["\n",(0,r.jsx)(t.p,{children:"Error: Failed to save state"}),"\n",(0,r.jsx)(t.p,{children:"Error saving state: blobs:Clien#GetProperties: Failure responding to request: StatusCode=403 -- Original Error: autorest/azure: error response cannot be parsed: {\"\" '\\x00' '\\x00'} error: EOF"}),"\n"]}),"\n",(0,r.jsx)(t.p,{children:"And: Error: Failed to persist state to backend."}),"\n",(0,r.jsx)(t.p,{children:"Or Error: Error releasing the state lock."}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.img,{alt:"Terraform - Failed to save state",src:a(12541).Z+"",title:"Terraform - Failed to save state",width:"569",height:"586"})}),"\n",(0,r.jsx)(t.p,{children:"Recently, encountered this issue when attempting a Terraform deployment; the state file kept locking midway through a deployment, this was traced to the Terraform storage account being in the Terraform code itself - with Public access set to Deny."}),"\n",(0,r.jsx)(t.p,{children:"So the flow was looking like this: Script ran to allow Azure DevOps IP to the Storage account Firewall, then Terraform would start deploying and Deny access - preventing the state file from saving."}),"\n",(0,r.jsx)(t.p,{children:"The first thing you need to do is break the lease on the state file."}),"\n",(0,r.jsxs)(t.ol,{children:["\n",(0,r.jsxs)(t.li,{children:["Navigate to your ",(0,r.jsx)(t.strong,{children:"Azure Storage"})," account that contains the state file"]}),"\n",(0,r.jsxs)(t.li,{children:["Navigate to the ",(0,r.jsx)(t.strong,{children:"Container"})," that contains the state file"]}),"\n",(0,r.jsxs)(t.li,{children:["Click on your state file and select ",(0,r.jsx)(t.strong,{children:"Break lease"})]}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.img,{alt:"Azure Storage account - break lease",src:a(64245).Z+"",title:"Azure Storage account - break lease",width:"1441",height:"379"})}),"\n",(0,r.jsx)(t.li,{children:"Once the lease is broken - make sure that your state file is 'Available' and not 'Leased'"}),"\n",(0,r.jsx)(t.li,{children:"Then check your Terraform to make sure that it wasn't changing your Storage account that contained the Terraform state file in any way, then re-run your deployment."}),"\n"]}),"\n",(0,r.jsx)(t.p,{children:"Note: It may be wise, to make sure that the Azure storage account containing your state file is not managed by Terraform, to avoid unintentional mishaps."})]})}function h(e={}){const{wrapper:t}={...(0,s.a)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(u,{...e})}):u(e)}},64245:(e,t,a)=>{a.d(t,{Z:()=>r});const r=a.p+"assets/images/azure_storageaccount_breaklease-4efd6d8414a7824d404be53467861853.png"},12541:(e,t,a)=>{a.d(t,{Z:()=>r});const r=a.p+"assets/images/terraform_savestate-1240532c490aa54ba068178f32ea3d43.PNG"},11151:(e,t,a)=>{a.d(t,{Z:()=>i,a:()=>o});var r=a(67294);const s={},n=r.createContext(s);function o(e){const t=r.useContext(n);return r.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function i(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),r.createElement(n.Provider,{value:t},e.children)}}}]);