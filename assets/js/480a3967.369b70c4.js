"use strict";(self.webpackChunklukemurraynz=self.webpackChunklukemurraynz||[]).push([[5299],{36265:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>s,default:()=>l,frontMatter:()=>o,metadata:()=>i,toc:()=>u});var i=t(29178),r=t(74848),a=t(28453);const o={title:"Authenticating Azure OpenAI with Managed Identity",metaDescription:"Learn how to authenticate with Azure OpenAI using an API key for local development and Managed Identities for production in Python.",date:new Date("2024-12-08T19:31:27.637Z"),tags:["Azure"],categories:["Azure"],authors:["Luke"],slug:"azure/authenticating-azureopenai-python",keywords:["azure","Python","Authentication","API Key","Managed Identities","OpenAI","ContainerApps"],description:"Learn how to authenticate with Azure OpenAI using an API key for local development and Managed Identities for production in Python."},s=void 0,d={authorsImageUrls:[void 0]},u=[];function c(e){const n={a:"a",admonition:"admonition",code:"code",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,a.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(n.p,{children:["When developing a Python application that interacts with ",(0,r.jsx)(n.a,{href:"https://learn.microsoft.com/azure/ai-services/openai/overview?WT.mc_id=AZ-MVP-5004796",children:"Azure OpenAI"}),", you may want to authenticate with an API key for testing, however in Production, you should use Managed Identities within Microsoft Azure."]}),"\n",(0,r.jsxs)(n.p,{children:["In this article, we will look at how to authenticate with ",(0,r.jsx)(n.a,{href:"https://learn.microsoft.com/azure/ai-services/openai/overview?WT.mc_id=AZ-MVP-5004796",children:"Azure OpenAI"})," using an API key in Python for local development, then using an environment variable switch to authenticating using ",(0,r.jsx)(n.a,{href:"https://learn.microsoft.com/entra/identity/managed-identities-azure-resources/overview?WT.mc_id=AZ-MVP-5004796",children:"managed Identities"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:["The true hero for Azure authentication is the ",(0,r.jsx)(n.a,{href:"https://learn.microsoft.com/python/api/azure-identity/azure.identity.defaultazurecredential?view=azure-python&WT.mc_id=AZ-MVP-5004796",children:"DefaultAzureCredential"})," class from the Azure Identity library. This class can authenticate with Azure services using various methods, including Managed Identity, Shared Token Cache, and environment variables."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"DefaultAzureCredential",src:t(53418).A+"",width:"1480",height:"861"})}),"\n",(0,r.jsxs)(n.admonition,{type:"info",children:[(0,r.jsx)(n.p,{children:"This code snippet demonstrates how to load and validate environment variables needed to connect to Azure OpenAI services. Here's a step-by-step breakdown:"}),(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Load Environment Variables"}),": The code first attempts to load environment variables from the operating system. If any of the required variables are missing, it then tries to load them from a ",(0,r.jsx)(n.code,{children:".env"})," file named ",(0,r.jsx)(n.code,{children:"azureopenai.env"}),"."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Check for Missing Variables"}),": This function defines a list of required environment variables and checks for missing ones. If any required variables are not found, an error indicates which variables are missing."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Authentication Setup"}),": The code checks if the ",(0,r.jsx)(n.code,{children:"AUTHENTICATION"})," environment variable is set to ",(0,r.jsx)(n.code,{children:"AZURE"}),". If it is, it uses Azure's DefaultAzureCredential to get a bearer token for authentication. Otherwise, it uses an API key."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Initialize AzureOpenAI Client"}),": Finally, it initializes the ",(0,r.jsx)(n.code,{children:"AzureOpenAI"})," client with the appropriate authentication method (either bearer token or API key) and the necessary API version and endpoint."]}),"\n"]}),"\n"]})]}),"\n",(0,r.jsx)(n.p,{children:"The Python code is as follows:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'from azure.identity import DefaultAzureCredential, get_bearer_token_provider\n# Load environment variables from OS and .env file\nENV = {var: os.getenv(var) for var in ["AZURE_OPENAI_ENDPOINT", "AZURE_OPENAI_KEY", "AZURE_OPENAI_API_VERSION", "AZURE_OPENAI_CHATGPT_DEPLOYMENT"]}\nif any(value is None for value in ENV.values()):\n    ENV.update({k: v for k, v in dotenv.dotenv_values("azureopenai.env").items() if k not in ENV or ENV[k] is None})\n\nrequired_env_vars = ["AZURE_OPENAI_ENDPOINT", "AZURE_OPENAI_KEY", "AZURE_OPENAI_API_VERSION", "AZURE_OPENAI_CHATGPT_DEPLOYMENT"]\nmissing_vars = [var for var in required_env_vars if not ENV.get(var)]\nif missing_vars:\n    raise KeyError(f"Missing required environment variables: {\', \'.join(missing_vars)}")\n\n# Check if the Authentication environment variable is set to Azure\nif os.getenv("AUTHENTICATION") == "AZURE":\n    token_provider = get_bearer_token_provider(DefaultAzureCredential(), "https://cognitiveservices.azure.com/.default")\n    client = AzureOpenAI(\n        api_version=ENV["AZURE_OPENAI_API_VERSION"],\n        azure_endpoint=ENV["AZURE_OPENAI_ENDPOINT"],\n        azure_ad_token_provider=token_provider\n    )\nelse:\n    client = AzureOpenAI(\n        api_version=ENV["AZURE_OPENAI_API_VERSION"],\n        azure_endpoint=ENV["AZURE_OPENAI_ENDPOINT"],\n        api_key=ENV["AZURE_OPENAI_KEY"]\n    )\n'})}),"\n",(0,r.jsx)(n.admonition,{type:"tip",children:(0,r.jsxs)(n.p,{children:["This is assuming you are using the System Managed identity; however, if you want to run with a User Assigned Managed identity. Make sure you have an environment variable of ",(0,r.jsx)(n.strong,{children:"AZURE_CLIENT_ID"})," to the value of the CLIENT ID of the User Assigned managed identity."]})}),"\n",(0,r.jsxs)(n.p,{children:["When deployed to an ",(0,r.jsx)(n.a,{href:"https://learn.microsoft.com/azure/container-apps/overview?WT.mc_id=AZ-MVP-5004796",children:"Azure Container Apps"})," environment, I have set the operating system environment variables set to use Managed Identities. This is done by setting the ",(0,r.jsx)(n.code,{children:"AUTHENTICATION"})," environment variable to ",(0,r.jsx)(n.code,{children:"AZURE"})," and using the ",(0,r.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/python/api/azure-identity/azure.identity.defaultazurecredential?view=azure-python&WT.mc_id=AZ-MVP-5004796",children:"DefaultAzureCredential"})," class to authenticate with Azure services."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"Container Apps - Environment variables",src:t(40682).A+"",width:"2152",height:"1103"})})]})}function l(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},40682:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/ContainerApps_AzureOpenAIEnvVariables-650eb1d409e0b93874b81dca4ea1adb9.png"},53418:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/DefaultAzureCredential-78d99839c796bbb8199cd607725fdde4.png"},28453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>s});var i=t(96540);const r={},a=i.createContext(r);function o(e){const n=i.useContext(a);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),i.createElement(a.Provider,{value:n},e.children)}},29178:e=>{e.exports=JSON.parse('{"permalink":"/azure/authenticating-azureopenai-python","source":"@site/blog/2024-12-09-azureopenaientraauthpython/index.mdx","title":"Authenticating Azure OpenAI with Managed Identity","description":"Learn how to authenticate with Azure OpenAI using an API key for local development and Managed Identities for production in Python.","date":"2024-12-08T19:31:27.637Z","tags":[{"inline":true,"label":"Azure","permalink":"/tags/azure"}],"readingTime":2.33,"hasTruncateMarker":true,"authors":[{"name":"Luke Murray","title":"Author","url":"https://luke.geek.nz","imageURL":"https://luke.geek.nz/img/logo.png","key":"Luke","page":null}],"frontMatter":{"title":"Authenticating Azure OpenAI with Managed Identity","metaDescription":"Learn how to authenticate with Azure OpenAI using an API key for local development and Managed Identities for production in Python.","date":"2024-12-08T19:31:27.637Z","tags":["Azure"],"categories":["Azure"],"authors":["Luke"],"slug":"azure/authenticating-azureopenai-python","keywords":["azure","Python","Authentication","API Key","Managed Identities","OpenAI","ContainerApps"],"description":"Learn how to authenticate with Azure OpenAI using an API key for local development and Managed Identities for production in Python."},"unlisted":false,"prevItem":{"title":"Using Azure Communication Services and UMI PowerShell to Send Emails","permalink":"/azure/using-communication-services-and-umi-powershell-to-send-emails"},"nextItem":{"title":"Azure Region Provider Comparison","permalink":"/azure/azure-region-provider-comparison"}}')}}]);