"use strict";(self.webpackChunklukemurraynz=self.webpackChunklukemurraynz||[]).push([[15638],{35522:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>r,default:()=>u,frontMatter:()=>o,metadata:()=>i,toc:()=>l});var i=t(59588),s=t(74848),a=t(28453);const o={title:"MCP Server with Azure Functions & Communication Services",metaDescription:"Deploy an MCP server on Azure Functions with Azure Communication Services Email, supporting direct and Entra ID-secured connections",tags:["Azure"],categories:["Azure"],authors:["Luke"],slug:"azure/communication-services-mcp-email-server",keywords:["Azure","Azure Communication Services Email","MCP server Azure","Azure Functions MCP","API Management Entra ID"],description:"Deploy an MCP server on Azure Functions with Azure Communication Services Email, supporting direct and Entra ID-secured connections",date:new Date("2025-08-27T22:31:25.412Z")},r=void 0,c={authorsImageUrls:[void 0]},l=[];function d(e){const n={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",em:"em",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.a,{href:"https://learn.microsoft.com/azure/communication-services/overview?WT.mc_id=AZ-MVP-5004796",children:"Azure Communication Services"})," can be used to add voice, video, chat, and SMS and email capabilities to applications. It is a fully managed communication platform that enables developers to build rich communication experiences. Today, we will explore the email capability through an MCP (Model Context Protocol) server hosted on Azure Functions, enabling us to send emails from any MCP client."]}),"\n","\n",(0,s.jsx)(n.p,{children:"We will go through 2 scenarios:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Direct MCP Connection to the Function App using the FunctionApp key in our client"}),"\n",(0,s.jsx)(n.li,{children:"MCP connection through Azure API Management, authenticating with Entra ID."}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"ACS",src:t(1156).A+"",width:"1400",height:"964"})}),"\n",(0,s.jsx)(n.p,{children:"The Azure resources used for this are:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://learn.microsoft.com/azure/azure-functions/functions-overview?WT.mc_id=AZ-MVP-5004796",children:"Azure Functions (.NET)"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://learn.microsoft.com/azure/communication-services/overview?WT.mc_id=AZ-MVP-5004796",children:"Azure Communication Services"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://learn.microsoft.com/azure/communication-services/concepts/email/email-overview?WT.mc_id=AZ-MVP-5004796",children:"Email Communication Service"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://learn.microsoft.com/azure/communication-services/concepts/email/email-domain-and-sender-authentication?WT.mc_id=AZ-MVP-5004796",children:"Email Communication Services Domain"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://learn.microsoft.com/entra/identity/managed-identities-azure-resources/how-manage-user-assigned-managed-identities?pivots=identity-mi-methods-azp&WT.mc_id=AZ-MVP-5004796",children:"User-assigned managed identity"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://learn.microsoft.com/azure/api-management/api-management-key-concepts?WT.mc_id=AZ-MVP-5004796",children:"Azure API Management"})}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"ACS Architecture",src:t(76433).A+"",width:"1383",height:"929"})}),"\n",(0,s.jsx)(n.p,{children:"The Function App is a C# .NET 8 MCP (Model Context Protocol) server; it provides advanced email automation tools using Azure Communication Services (ACS), with support for templates, attachments, and robust error handling."}),"\n",(0,s.jsxs)(n.admonition,{type:"info",children:[(0,s.jsxs)(n.p,{children:["I based the Function App on the ",(0,s.jsx)(n.a,{href:"https://github.com/Azure-Samples/mcp-sdk-functions-hosting-dotnet",children:"Azure-Samples/mcp-sdk-functions-hosting-dotnet"})," sample."]}),(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"Functions MCP extension",src:t(11222).A+"",width:"1554",height:"782"})}),(0,s.jsx)(n.p,{children:"This sample runs the MCP tools by utilising a custom handler."})]}),"\n",(0,s.jsx)(n.p,{children:"5 tools can be accessed from this server:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"SendEmail: Send an email with options (HTML/plain text, attachments, sender/recipient names)."}),"\n",(0,s.jsx)(n.li,{children:"SendSimpleEmail: Send a plain-text email with minimal parameters."}),"\n",(0,s.jsx)(n.li,{children:"SendEmailWithMultipleAttachments: Send an email with multiple attachments."}),"\n",(0,s.jsx)(n.li,{children:"SendIncidentEmail: Use a predefined incident template for outage notifications."}),"\n",(0,s.jsx)(n.li,{children:"ListEmailTemplates: List available templates and required variables."}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["To deploy this, we will use ",(0,s.jsx)(n.a,{href:"https://learn.microsoft.com/azure/developer/azure-developer-cli/overview?tabs=windows&WT.mc_id=AZ-MVP-5004796",children:"Azure Developer CLI"})," to deploy the Azure resources and the function app code directly to our Azure environment."]}),"\n",(0,s.jsxs)(n.admonition,{type:"note",children:[(0,s.jsxs)(n.p,{children:["You can find the code here: ",(0,s.jsx)(n.a,{href:"https://github.com/lukemurraynz/acs-email-mcp-server",children:"lukemurraynz/acs-email-mcp-server"}),"."]}),(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"I will be running this from the devcontainer, which contains the Azure Developer CLI that I will use to deploy."}),"\n"]})]}),"\n",(0,s.jsxs)(n.p,{children:["First, we will ",(0,s.jsx)(n.code,{children:"azd auth login"})," to log in to Azure with credentials that can\nThen ",(0,s.jsx)(n.code,{children:"azd up"})," to start the deployment."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"Azure Communication Services",src:t(19475).A+"",width:"1474",height:"786"})}),"\n",(0,s.jsx)(n.p,{children:"Once up and running, it's time to test. To do this, we will test the two scenarios (direct MCP to Function App and MCP with Entra ID through APIM) using two different MCP clients:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://lmstudio.ai/",children:"LM Studio"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://code.visualstudio.com?WT.mc_id=AZ-MVP-5004796",children:"Visual Studio Code"})}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["Direct MCP to Function App will work on the majority of your MCP clients, as long as you can add in the header API key ",(0,s.jsxs)(n.em,{children:["(easily done in the ",(0,s.jsx)(n.code,{children:"mcp.json"})," file I will show you shortly)"]}),", however, not all clients support Entra ID authentication - but Visual Studio Code with GitHub Copilot does."]}),"\n",(0,s.jsx)(n.p,{children:"In LLM studio, using gpt-oss-20b hosted locally on my computer - I will  add the following to my mcp.json file:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "mcpServers": {\n    "acsemail": {\n      "url": "https://func-acsemailmcpsrv-fje7uzz7l2rbc.azurewebsites.net/mcp",\n      "headers": {\n        "x-functions-key": "Hbuo_sQ-tXt3MobsOGkYDm1G8zVL4Ar2R6vhhJhzkxgTAzFuzpNj0Q=="\n      },\n      "timeout": 30000\n    }\n  }\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"This is the Function App endpoint and the function key, which you can retrieve from the Azure portal by navigating to Function App > Functions > Your Function > Function Keys."}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"LLM Studio add MCP Server",src:t(32789).A+"",width:"1576",height:"1048"})}),"\n",(0,s.jsxs)(n.p,{children:["Once that is done, we can do some testing. Here I am using the ",(0,s.jsx)(n.code,{children:"SendEmail"})," tool to send an email."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"Test Send Email",src:t(40407).A+"",width:"1576",height:"1048"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"LMStudio Test Email received",src:t(28408).A+"",width:"1215",height:"530"})}),"\n",(0,s.jsx)(n.p,{children:"Now, let's test the second scenario, using Visual Studio Code with GitHub Copilot with Entra ID authentication through Azure API Management."}),"\n",(0,s.jsx)(n.p,{children:"Using Visual Studio Code, I will add the following to my mcp.json file:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "servers": {\n    "acs": {\n      "type": "http",\n      "url": "https://https://apim-zhk2vuoady55m.azure-api.net/mcp"\n    }\n  },\n  "inputs": []\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"As you can see, there is no API key, as we will be using Entra ID authentication. Once started, it should prompt you to log in to Entra ID."}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"VS Code setup MCP APIM",src:t(64762).A+"",width:"1583",height:"1001"})}),"\n",(0,s.jsx)(n.p,{children:"The initial login may fail, and the MCP server will stop. This is because we haven't been able to authorize your account to access the Azure API Management endpoints for the Azure Communication Services MCP function app server."}),"\n",(0,s.jsx)(n.p,{children:"What we need to do is to assign your user account access to the Application Registration, which will allow you to authenticate and use the MCP server. To find this, navigate to the API Management service, navigate to Named Values, and find the McpClientId value, copy the value - this is the ID of the Application Registration, now navigate to Entra ID > Application Registrations, and search for this ID, select it, then select Managed application (on ther Overview pane - right hand side), this will take you to the Enterprise Application for this App Registration, then click on Users and groups, then Add users/groups, select your user account, then click Assign."}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"ACS VS Code Test",src:t(74708).A+"",width:"1252",height:"974"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"ACS MCP Email Test",src:t(36729).A+"",width:"1221",height:"476"})}),"\n",(0,s.jsx)(n.p,{children:"If I wanted to, I could test with a prompt like this:"}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:["send #selection as attachment to ",(0,s.jsx)(n.a,{href:"mailto:luke@luke.geek.nz",children:"luke@luke.geek.nz"})]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"ACS MCP Email Test - attachment",src:t(81170).A+"",width:"1252",height:"974"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"ACS MCP Email Test - attachment",src:t(11653).A+"",width:"425",height:"449"})}),"\n",(0,s.jsx)(n.p,{children:"Finally, we will use the ListEmailTemplates tool to view the available templates and send an IT System Outage email using the SendIncidentEmail tool."}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"Send test Incident email",src:t(4987).A+"",width:"674",height:"701"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"Test Incident",src:t(10673).A+"",width:"1222",height:"875"})})]})}function u(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},28408:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/LLMStudioTestEmailReceived-aba74e932f51a88d4f74e1629275d314.jpg"},32789:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/LMStudio_AddMCPServer-987891f3b674eddeda4f15818bcd838f.gif"},40407:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/LMStudio_TestSendEmail-4a1fc473cf1db2ff8bd7b7e52f56eeaa.gif"},36729:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/VSCodeTestEmailReceived-0385d7b297a8d6893fe75a2eb6c06f18.jpg"},11653:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/VSCodeTestEmailReceivedSelectedAttachment-884305159caff58565427a351a97b6a0.jpg"},10673:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/VSCodeTestEmailReceivedTemplateIncident-83b2c448ebf93baa54e2f66e9418cb6b.jpg"},64762:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/VSCode_SetupAPIMMCP-918a7f54cce2ab89e9c646bab5cb8f14.gif"},74708:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/VSCode_SetupAPIMMCPAuthTest-c99eb1f409fb9fa16f5a6361c1108faa.gif"},81170:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/VSCode_TestSelectionAttachment-f9f41aed1ca8b23853f4895f6b5789e1.gif"},4987:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/VSCode_TestTemplatesIncident-88315061b863d1e06ec3283e42739326.gif"},19475:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/mcp-acs-azd-deploy-80069015e7b89ecd5617c89d385b0a8d.gif"},76433:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/mcp-acs-email-architecture-c692ea283a86eb1ce0801459f30765d0.jpg"},1156:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/mcp-acs-scenarios-e6c7a465da81958ecd0f45108b029778.jpg"},11222:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/mcp-functionapp-architecture-diagram-9d4eee988bb3c044a5df1162ce4dc7d9.png"},28453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>r});var i=t(96540);const s={},a=i.createContext(s);function o(e){const n=i.useContext(a);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),i.createElement(a.Provider,{value:n},e.children)}},59588:e=>{e.exports=JSON.parse('{"permalink":"/azure/communication-services-mcp-email-server","source":"@site/blog/2025-08-28-acsemailmcp/index.mdx","title":"MCP Server with Azure Functions & Communication Services","description":"Deploy an MCP server on Azure Functions with Azure Communication Services Email, supporting direct and Entra ID-secured connections","date":"2025-08-27T22:31:25.412Z","tags":[{"inline":true,"label":"Azure","permalink":"/tags/azure"}],"readingTime":4.89,"hasTruncateMarker":true,"authors":[{"name":"Luke Murray","title":"Author","url":"https://luke.geek.nz","imageURL":"https://luke.geek.nz/img/logo.png","key":"Luke","page":null}],"frontMatter":{"title":"MCP Server with Azure Functions & Communication Services","metaDescription":"Deploy an MCP server on Azure Functions with Azure Communication Services Email, supporting direct and Entra ID-secured connections","tags":["Azure"],"categories":["Azure"],"authors":["Luke"],"slug":"azure/communication-services-mcp-email-server","keywords":["Azure","Azure Communication Services Email","MCP server Azure","Azure Functions MCP","API Management Entra ID"],"description":"Deploy an MCP server on Azure Functions with Azure Communication Services Email, supporting direct and Entra ID-secured connections","date":"2025-08-27T22:31:25.412Z"},"unlisted":false,"nextItem":{"title":"Azure Function App Host Runtime Error","permalink":"/azure/function-app-host-runtime"}}')}}]);