"use strict";(self.webpackChunklukemurraynz=self.webpackChunklukemurraynz||[]).push([[1359],{22781:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>s,metadata:()=>i,toc:()=>c});var a=r(74848),n=r(28453);const s={date:"2023-04-07 00:00:00 +1200",title:"Failed to persist Terraform state using an Azure Blob Storage account",authors:["Luke"],tags:["Azure"],toc:!1,header:{teaser:"/uploads/terraform_savestate.PNG"},slug:"azure/failed-to-persist-terraform-state-using-an-azure-blob-storage-account"},o=void 0,i={permalink:"/azure/failed-to-persist-terraform-state-using-an-azure-blob-storage-account",source:"@site/blog/2023-04-07-failed-to-persist-terraform-state-using-an-azure-blob-storage-account.md",title:"Failed to persist Terraform state using an Azure Blob Storage account",description:"When attempting to make changes with Terraform, and the state changes are in an Azure storage account, you may come across: Failed to save state.",date:"2023-04-07T00:00:00.000Z",tags:[{inline:!0,label:"Azure",permalink:"/tags/azure"}],readingTime:1.47,hasTruncateMarker:!1,authors:[{name:"Luke Murray",title:"Author",url:"https://luke.geek.nz",imageURL:"https://luke.geek.nz/img/logo.png",key:"Luke",page:null}],frontMatter:{date:"2023-04-07 00:00:00 +1200",title:"Failed to persist Terraform state using an Azure Blob Storage account",authors:["Luke"],tags:["Azure"],toc:!1,header:{teaser:"/uploads/terraform_savestate.PNG"},slug:"azure/failed-to-persist-terraform-state-using-an-azure-blob-storage-account"},unlisted:!1,prevItem:{title:"Open multiple Microsoft Teams instances using PowerShell",permalink:"/2023/05/03/Open-multiple-Microsoft-Teams-instances-using-PowerShell"},nextItem:{title:"Azure Quick Review",permalink:"/azure/azure-quick-review"}},l={authorsImageUrls:[void 0]},c=[];function u(e){const t={a:"a",blockquote:"blockquote",img:"img",li:"li",ol:"ol",p:"p",strong:"strong",...(0,n.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(t.p,{children:["When attempting to make changes with Terraform, and the ",(0,a.jsx)(t.a,{href:"https://learn.microsoft.com/azure/developer/terraform/store-state-in-azure-storage?tabs=azure-cli&WT.mc_id=AZ-MVP-5004796",title:"Store Terraform state in Azure Storage",children:"state changes are in an Azure storage account"}),", you may come across: Failed to save state."]}),"\n",(0,a.jsxs)(t.blockquote,{children:["\n",(0,a.jsx)(t.p,{children:"Error: Failed to save state"}),"\n",(0,a.jsx)(t.p,{children:"Error saving state: blobs:Clien#GetProperties: Failure responding to request: StatusCode=403 -- Original Error: autorest/azure: error response cannot be parsed: {\"\" '\\x00' '\\x00'} error: EOF"}),"\n"]}),"\n",(0,a.jsx)(t.p,{children:"And: Error: Failed to persist state to backend."}),"\n",(0,a.jsx)(t.p,{children:"Or Error: Error releasing the state lock."}),"\n",(0,a.jsx)(t.p,{children:(0,a.jsx)(t.img,{alt:"Terraform - Failed to save state",src:r(75839).A+"",title:"Terraform - Failed to save state",width:"569",height:"586"})}),"\n",(0,a.jsx)(t.p,{children:"Recently, encountered this issue when attempting a Terraform deployment; the state file kept locking midway through a deployment, this was traced to the Terraform storage account being in the Terraform code itself - with Public access set to Deny."}),"\n",(0,a.jsx)(t.p,{children:"So the flow was looking like this: Script ran to allow Azure DevOps IP to the Storage account Firewall, then Terraform would start deploying and Deny access - preventing the state file from saving."}),"\n",(0,a.jsx)(t.p,{children:"The first thing you need to do is break the lease on the state file."}),"\n",(0,a.jsxs)(t.ol,{children:["\n",(0,a.jsxs)(t.li,{children:["Navigate to your ",(0,a.jsx)(t.strong,{children:"Azure Storage"})," account that contains the state file"]}),"\n",(0,a.jsxs)(t.li,{children:["Navigate to the ",(0,a.jsx)(t.strong,{children:"Container"})," that contains the state file"]}),"\n",(0,a.jsxs)(t.li,{children:["Click on your state file and select ",(0,a.jsx)(t.strong,{children:"Break lease"})]}),"\n",(0,a.jsx)(t.li,{children:(0,a.jsx)(t.img,{alt:"Azure Storage account - break lease",src:r(33838).A+"",title:"Azure Storage account - break lease",width:"1441",height:"379"})}),"\n",(0,a.jsx)(t.li,{children:"Once the lease is broken - make sure that your state file is 'Available' and not 'Leased'"}),"\n",(0,a.jsx)(t.li,{children:"Then check your Terraform to make sure that it wasn't changing your Storage account that contained the Terraform state file in any way, then re-run your deployment."}),"\n"]}),"\n",(0,a.jsx)(t.p,{children:"Note: It may be wise, to make sure that the Azure storage account containing your state file is not managed by Terraform, to avoid unintentional mishaps."})]})}function h(e={}){const{wrapper:t}={...(0,n.R)(),...e.components};return t?(0,a.jsx)(t,{...e,children:(0,a.jsx)(u,{...e})}):u(e)}},33838:(e,t,r)=>{r.d(t,{A:()=>a});const a=r.p+"assets/images/azure_storageaccount_breaklease-4efd6d8414a7824d404be53467861853.png"},75839:(e,t,r)=>{r.d(t,{A:()=>a});const a=r.p+"assets/images/terraform_savestate-1240532c490aa54ba068178f32ea3d43.PNG"},28453:(e,t,r)=>{r.d(t,{R:()=>o,x:()=>i});var a=r(96540);const n={},s=a.createContext(n);function o(e){const t=a.useContext(s);return a.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function i(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:o(e.components),a.createElement(s.Provider,{value:t},e.children)}}}]);