"use strict";(self.webpackChunklukemurraynz=self.webpackChunklukemurraynz||[]).push([[65683],{62451:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>r,default:()=>u,frontMatter:()=>s,metadata:()=>a,toc:()=>d});var i=n(85893),o=n(11151);const s={title:"Unable to start Windows Azure Guest Agent (it's in a disabled state)",authors:["Luke"],tags:["Azure"],date:"2021-03-25 00:00:00 +1300",toc:!0,header:{teaser:"images/iazure-marketplace-banner.png"}},r=void 0,a={permalink:"/2021/03/25/unable-to-start-windows-azure-guest-agent-it-s-in-a-disabled-state.",source:"@site/blog/2021-03-25-unable-to-start-windows-azure-guest-agent-it-s-in-a-disabled-state..md",title:"Unable to start Windows Azure Guest Agent (it's in a disabled state)",description:"Azure Backup Overview",date:"2021-03-25T00:00:00.000Z",formattedDate:"March 25, 2021",tags:[{label:"Azure",permalink:"/tags/azure"}],readingTime:1.93,hasTruncateMarker:!1,authors:[{name:"Luke Murray",title:"Author",url:"https://luke.geek.nz",imageURL:"../img/logo.png",key:"Luke"}],frontMatter:{title:"Unable to start Windows Azure Guest Agent (it's in a disabled state)",authors:["Luke"],tags:["Azure"],date:"2021-03-25 00:00:00 +1300",toc:!0,header:{teaser:"images/iazure-marketplace-banner.png"}},unlisted:!1,prevItem:{title:"Installing RSAT Tools with PowerShell",permalink:"/2021/03/25/installing-the-rsat-remote-server-administration-tools-for-windows-10-tools-using-powershell"},nextItem:{title:"First look at Universal Automation Desktop",permalink:"/2020/02/29/First look at Universal Automation Desktop"}},l={authorsImageUrls:[void 0]},d=[{value:"Issue Description",id:"issue-description",level:2},{value:"Root Cause",id:"root-cause",level:2},{value:"Resolution #1",id:"resolution-1",level:2},{value:"Resolution #2",id:"resolution-2",level:2},{value:"Resolution #3",id:"resolution-3",level:2},{value:"Resolution #4",id:"resolution-4",level:2}];function c(e){const t={a:"a",br:"br",code:"code",h2:"h2",img:"img",p:"p",pre:"pre",...(0,o.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{src:"https://csharpcorner.azureedge.net/article/an-overview-of-azure-backup/Images/An%20Overview%20Of%20Azure%20Backup01.png",alt:"Azure Backup Overview"})}),"\n",(0,i.jsx)(t.h2,{id:"issue-description",children:"Issue Description"}),"\n",(0,i.jsx)(t.p,{children:"Unable to start Windows Azure Guest Agent (it's in a disabled state). When trying and set the service to auto the following error occurs 'The specified service has been marked for deletion.'"}),"\n",(0,i.jsx)(t.p,{children:"VM Agent is unable to communicate with the Azure Backup service."}),"\n",(0,i.jsx)(t.h2,{id:"root-cause",children:"Root Cause"}),"\n",(0,i.jsx)(t.p,{children:"This may occur if Windows Communication Framework (WCF) profiling is enabled. WCF profiling should only be enabled while debugging a WCF issue. It should not be left enabled while running a production workload."}),"\n",(0,i.jsx)(t.h2,{id:"resolution-1",children:"Resolution #1"}),"\n",(0,i.jsx)(t.p,{children:"1. Restart your workload, I would recommend to Stop (deallocate first) to make sure that the workload starts correctly on a new hypervisor, the Azure Backup agent starts and checks for agent updates during the boot process."}),"\n",(0,i.jsx)(t.h2,{id:"resolution-2",children:"Resolution #2"}),"\n",(0,i.jsx)(t.p,{children:"Disable WCF profiling:"}),"\n",(0,i.jsx)(t.p,{children:"1. Launch an elevated CMD prompt.\n2. Run the following commands to back up the existing: C:\\Windows\\Microsoft.NET\\Framework\\v4.0.30319\\Config\\machine.config file:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"   cd C:\\Windows\\Microsoft.NET\\Framework\\v4.0.30319\\Config\n\n   copy machine.config machine.config.bak\n"})}),"\n",(0,i.jsx)(t.p,{children:"3. Run notepad machine.config to edit the file in Notepad."}),"\n",(0,i.jsx)(t.p,{children:"Remove this text, being careful not to also remove any additional text that may be on the same line:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:'<add name="Microsoft.VisualStudio.Diagnostics.ServiceModelSink.Behavior" type="Microsoft.VisualStudio.Diagnostics.ServiceModelSink.Behavior, Microsoft.VisualStudio.Diagnostics.ServiceModelSink, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a"/>\n'})}),"\n",(0,i.jsx)(t.p,{children:"Also remove this text, being careful not to also remove any additional text that may be on the same line:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"<commonBehaviors><endpointBehaviors><Microsoft.VisualStudio.Diagnostics.ServiceModelSink.Behavior/></endpointBehaviors><serviceBehaviors><Microsoft.VisualStudio.Diagnostics.ServiceModelSink.Behavior/></serviceBehaviors></commonBehaviors>\n"})}),"\n",(0,i.jsx)(t.p,{children:"4. Save and close the file.\n5. Restart the guest agent services:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"net stop Rdagent\n\nnet stop WindowsAzureGuestAgent\n\nnet stop WindowsAzureTelemetryService\n\nnet start Rdagent\n"})}),"\n",(0,i.jsx)(t.p,{children:"6. In some cases the VM may need to be restarted for the WCF disablement to take effect."}),"\n",(0,i.jsx)(t.h2,{id:"resolution-3",children:"Resolution #3"}),"\n",(0,i.jsx)(t.p,{children:"From time to time the Azure backup agent may fail. Sometimes this will self-resolve but on the odd occasion, additional steps may be needed."}),"\n",(0,i.jsx)(t.p,{children:"1. Uninstall the agent via the Control Panel.\n2. Open CMD as Admin.\n3. Stop the following services:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"net stop rdagent\n\nnet stop WindowsAzureGuestAgent\n\nnet stop WindowsAzureTelemetryService \n"})}),"\n",(0,i.jsx)(t.p,{children:"4. Delete all the services of the agent:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"sc delete rdagent\n\nsc delete WindowsAzureGuestAgent\n\nsc delete WindowsAzureTelemetryService \n"})}),"\n",(0,i.jsxs)(t.p,{children:['5. Create a folder called OLD in "C:\\ WindowsAzure" and move the old version of the agent to it and the folders that say Packages.\n6. Install the service again using the link: ',(0,i.jsx)(t.a,{href:"https://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409?WT.mc_id=AZ-MVP-5004796",title:"https://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409",children:"https://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409"})," or the latest agent available.",(0,i.jsx)(t.br,{}),"\n7. Restart the server."]}),"\n",(0,i.jsx)(t.h2,{id:"resolution-4",children:"Resolution #4"}),"\n",(0,i.jsx)(t.p,{children:"1. Migrate the Pagefile to a new disk\n2. Set a limit on the pagefile"})]})}function u(e={}){const{wrapper:t}={...(0,o.a)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},11151:(e,t,n)=>{n.d(t,{Z:()=>a,a:()=>r});var i=n(67294);const o={},s=i.createContext(o);function r(e){const t=i.useContext(s);return i.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:r(e.components),i.createElement(s.Provider,{value:t},e.children)}}}]);