"use strict";(self.webpackChunklukemurraynz=self.webpackChunklukemurraynz||[]).push([[6343],{50581:(e,t,s)=>{s.r(t),s.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>h,frontMatter:()=>n,metadata:()=>o,toc:()=>u});var r=s(85893),a=s(11151);const n={title:"Accessing KeyVault from Azure DevOps",metaDescription:"Access an Azure Key vault from a Microsoft-hosted agent in Azure DevOps",date:new Date("2024-02-03T10:56:08.514Z"),tags:["Azure"],categories:["Azure"],authors:["Luke"],header:{teaser:"BlogHeadingAccessingKeyVaultfromAzureDevOps.gif"},slug:"azure/accessing-keyvault-azure-devops",keywords:["azure","cloudnative","keyvault","security","devops"],description:"Access an Azure Key vault from a Microsoft-hosted agent in Azure DevOps"},i="Add Agent IP to KeyVault Firewall",o={permalink:"/azure/accessing-keyvault-azure-devops",source:"@site/blog/2024-02-04-azure-devops-keyvault/index.mdx",title:"Accessing KeyVault from Azure DevOps",description:"Access an Azure Key vault from a Microsoft-hosted agent in Azure DevOps",date:"2024-02-03T10:56:08.514Z",tags:[{label:"Azure",permalink:"/tags/azure"}],readingTime:5.225,hasTruncateMarker:!0,authors:[{name:"Luke Murray",title:"Author",url:"https://luke.geek.nz",imageURL:"https://luke.geek.nz/img/logo.png",key:"Luke"}],frontMatter:{title:"Accessing KeyVault from Azure DevOps",metaDescription:"Access an Azure Key vault from a Microsoft-hosted agent in Azure DevOps",date:"2024-02-03T10:56:08.514Z",tags:["Azure"],categories:["Azure"],authors:["Luke"],header:{teaser:"BlogHeadingAccessingKeyVaultfromAzureDevOps.gif"},slug:"azure/accessing-keyvault-azure-devops",keywords:["azure","cloudnative","keyvault","security","devops"],description:"Access an Azure Key vault from a Microsoft-hosted agent in Azure DevOps"},unlisted:!1,prevItem:{title:"Enterprise Policy as Code with Azure DevOps",permalink:"/azure/enterprise-policy-code-azure-devops"},nextItem:{title:"Using the Azure Naming Tool API to name your Bicep resources",permalink:"/azure/azure-naming-tool-api-bicep-resources"}},l={authorsImageUrls:[void 0]},u=[];function c(e){const t={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.a)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(t.p,{children:["If you are running a ",(0,r.jsx)(t.a,{href:"https://learn.microsoft.com/azure/devops/pipelines/agents/agents?view=azure-devops&tabs=yaml%2Cbrowser&WT.mc_id=AZ-MVP-5004796#microsoft-hosted-agents",children:"Microsoft-hosted Azure DevOps agent"}),", you may need to access a ",(0,r.jsx)(t.a,{href:"https://azure.microsoft.com/products/key-vault?WT.mc_id=AZ-MVP-5004796",children:"KeyVault"})," to retrieve secrets. This is a common scenario when deploying resources to Azure."]}),"\n",(0,r.jsx)(t.p,{children:"In this post, I will show you how to access a KeyVault from an Azure DevOps pipeline by adding the IP of the Azure DevOps agent directly into your Azure Keyvault and removing it after it retrieves the secrets."}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.img,{alt:"Accessing KeyVault from a Azurne DevOps\xa0Microsoft\xa0Hosted\xa0Agent",src:s(89146).Z+"",title:"Accessing KeyVault from a Azurne DevOps\xa0Microsoft\xa0Hosted\xa0Agent",width:"1200",height:"628"})}),"\n","\n",(0,r.jsx)(t.p,{children:"When attempting to retrieve secrets from a KeyVault using Azure DevOps, you may get an error such as:"}),"\n",(0,r.jsx)(t.admonition,{type:"warning",children:(0,r.jsx)(t.p,{children:"##[error]Get secrets failed. Error: Client address is not authorized and caller is not a trusted service."})}),"\n",(0,r.jsx)(t.p,{children:"This is due to the Firewall of the Keyvault being enabled, which is best practice."}),"\n",(0,r.jsx)(t.p,{children:"You have a few options here:"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:["Option 1: Enable private endpoint for the KeyVault and use a ",(0,r.jsx)(t.a,{href:"https://learn.microsoft.com/azure/devops/pipelines/agents/agents?view=azure-devops&tabs=yaml%2Cbrowser&WT.mc_id=AZ-MVP-5004796#self-hosted-agents",children:"self-hosted agent"}),". This is the most secure option, but it requires more setup and configuration, and a self-hosted agent, running on a Virtual Machine or ",(0,r.jsx)(t.a,{href:"https://luke.geek.nz/azure/hosted-agents-container-apps-job/",children:"Container Apps"}),"."]}),"\n",(0,r.jsxs)(t.li,{children:["Option 2: Add the IP of the Azure DevOps agent to the KeyVault firewall rules. This is the easiest option, but it's not the most secure, as the IP address of the Microsoft hosted agents can change ",(0,r.jsx)(t.em,{children:"(the Microsoft hosted agents have a dynamic IP address)"}),"."]}),"\n"]}),"\n",(0,r.jsx)(t.p,{children:"Not all organisations have the resources to support a self-hosted agent, so we will look at Option 2."}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.img,{alt:"Azure KeyVault - Networking Blade (Azure Portal)",src:s(56921).Z+"",title:"Azure KeyVault - Networking Blade (Azure Portal)",width:"1681",height:"830"})}),"\n",(0,r.jsxs)(t.p,{children:["As a status, the Microsoft Hosted agents can come from any number of ",(0,r.jsx)(t.a,{href:"https://www.microsoft.com/en-us/download/details.aspx?id=56519?WT.mc_id=AZ-MVP-5004796",children:"Microsoft-owned IP addresses"})," from the region, that your Azure DevOps organisation is hosted."]}),"\n",(0,r.jsxs)(t.p,{children:["You may immediately want to check the ",(0,r.jsx)(t.strong,{children:"Allow trusted Microsoft services to bypass this firewall"})," as an instant thought, but ",(0,r.jsx)(t.a,{href:"https://learn.microsoft.com/en-us/azure/key-vault/general/network-security?WT.mc_id=AZ-MVP-5004796#key-vault-firewall-enabled-trusted-services-only",children:" Azure DevOps"})," is not an assumed trusted Microsoft service, and its not hosted within your subscription boundary."]}),"\n",(0,r.jsx)(t.p,{children:"So, that leaves us with enabling public access to the key vault, right? Because the IP will be different each time? Not quite! What we can do is:"}),"\n",(0,r.jsxs)(t.ol,{children:["\n",(0,r.jsx)(t.li,{children:"Add the IP of the Azure DevOps agent to the KeyVault firewall rules."}),"\n",(0,r.jsx)(t.li,{children:"Do the task, required from Azure DevOps (i.e. retrieve the secrets)"}),"\n",(0,r.jsx)(t.li,{children:"Remove the IP of the Azure DevOps agent from the KeyVault firewall rules."}),"\n"]}),"\n",(0,r.jsx)(t.p,{children:"So, let's take a look at the Tasks you can use in your Azure DevOps pipelines to achieve this."}),"\n",(0,r.jsx)(t.p,{children:"The following tasks use an Azure CLI command to grab the IP address of the Azure DevOps agent and then add it to the KeyVault firewall rules, and then remove it after the secrets have been retrieved, tasks below. References to the KeyVaultArmSvcConnectionName is the Service Connection that is used to authenticate to the Azure Subscription, so make sure this is adjusted for your environment.\nThe keyVaultName is the name of the keyVault you want to access."}),"\n",(0,r.jsx)(t.p,{children:"Note: The condition criteria is set to succeed or fail so that the task will run regardless of whether previous tasks have succeeded or failed."}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-yaml",metastring:'title="AzureCLI@2.yml"',children:'# This task uses Azure CLI to add the IP address of the Azure DevOps agent to the firewall of an Azure Key Vault.\n- task: AzureCLI@2  # Specifies the task to use Azure CLI version 2.\n  displayName: Add Agent IP From Key Vault  # The name displayed for this task in the Azure DevOps pipeline.\n  condition: succeededOrFailed()  # This task will run regardless of whether previous tasks have succeeded or failed.\n  inputs:  # The section where you specify input parameters for the task.\n    azureSubscription: ${{ parameters.keyVaultArmSvcConnectionName }}  # The Azure subscription that the task should use. The value is taken from the keyVaultArmSvcConnectionName parameter.\n    scriptType: bash  # Specifies that the script to be run is a Bash script.\n    scriptLocation: inlineScript  # Specifies that the script will be provided directly in the pipeline file, rather than being located in an external file.\n    inlineScript: |  # Begins the section where the actual script is provided. The | character indicates that a multi-line string will follow.\n      agentIP=$(curl -s https://checkip.amazonaws.com)  # Uses the curl command to get the public IP address of the Azure DevOps agent and stores it in the agentIP variable.\n      echo "Agent IP: $agentIP"  # Prints the IP address to the console.\n      az keyvault network-rule add --name "${{ parameters.keyVaultName }}" --ip-address "$agentIP" --only-show-errors  # Uses the Azure CLI to add the IP address of the Azure DevOps agent to the firewall of the Azure Key Vault specified by the keyVaultName parameter. The --only-show-errors option means that the command will only output information if an error occurs.\n'})}),"\n",(0,r.jsx)(t.h1,{id:"remove-agent-ip-to-keyvault-firewall-after-your-other-tasks",children:"Remove Agent IP to KeyVault Firewall after your other tasks"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-yaml",metastring:'title="AzureCLI@2.yml"',children:'# This task uses Azure CLI to remove the IP address of the Azure DevOps agent from the firewall of an Azure Key Vault.\n- task: AzureCLI@2  # Specifies the task to use Azure CLI version 2.\n  displayName: Remove Agent IP From Key Vault  # The name displayed for this task in the Azure DevOps pipeline.\n  condition: succeededOrFailed()  # This task will run regardless of whether previous tasks have succeeded or failed.\n  inputs:  # The section where you specify input parameters for the task.\n    azureSubscription: ${{ parameters.keyVaultArmSvcConnectionName }}  # The Azure subscription that the task should use. The value is taken from the keyVaultArmSvcConnectionName parameter.\n    scriptType: bash  # Specifies that the script to be run is a Bash script.\n    scriptLocation: inlineScript  # Specifies that the script will be provided directly in the pipeline file, rather than being located in an external file.\n    inlineScript: |  # Begins the section where the actual script is provided. The | character indicates that a multi-line string will follow.\n      agentIP=$(curl -s https://checkip.amazonaws.com)  # Uses the curl command to get the public IP address of the Azure DevOps agent and stores it in the agentIP variable.\n      echo "Agent IP: $agentIP"  # Prints the IP address to the console.\n      az keyvault network-rule remove --name "${{ parameters.keyVaultName }}" --ip-address "$agentIP" --only-show-errors  # Uses the Azure CLI to remove the IP address of the Azure DevOps agent from the firewall of the Azure Key Vault specified by the keyVaultName parameter. The --only-show-errors option means that the command will only output information if an error occurs.\n'})})]})}function h(e={}){const{wrapper:t}={...(0,a.a)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},56921:(e,t,s)=>{s.d(t,{Z:()=>r});const r=s.p+"assets/images/Azure_KeyVault_NetworkingPane-05c5e2d8f1cd5c4f5bebd7206b9ea4e4.png"},89146:(e,t,s)=>{s.d(t,{Z:()=>r});const r=s.p+"assets/images/BlogHeadingAccessingKeyVaultfromAzureDevOps-544d1dbdffe23f468b00b7e0022bd75d.gif"},11151:(e,t,s)=>{s.d(t,{Z:()=>o,a:()=>i});var r=s(67294);const a={},n=r.createContext(a);function i(e){const t=r.useContext(n);return r.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:i(e.components),r.createElement(n.Provider,{value:t},e.children)}}}]);