"use strict";(self.webpackChunklukemurraynz=self.webpackChunklukemurraynz||[]).push([[41976],{97918:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>c,contentTitle:()=>o,default:()=>p,frontMatter:()=>a,metadata:()=>s,toc:()=>l});var n=r(74848),i=r(28453);const a={title:"Private Endpoint traffic not appearing in Azure Firewall",authors:["Luke"],tags:["Azure"],toc:!1,header:{teaser:"/images/posts/BlobHeading_PrivateEndpointtrafficnotappearing.gif"},date:"2023-10-03 00:00:00 +1300",keywords:["azure","firewall","private endpoint"],slug:"azure/private-endpoint-traffic-not-appearing-azure-firewall",description:"Private Endpoint traffic can take a different route than your standard traffic and cause some confusion and dropped packets."},o=void 0,s={permalink:"/azure/private-endpoint-traffic-not-appearing-azure-firewall",source:"@site/blog/2023-10-03-Private-Endpoint-Traffic-Not-Appearing-Firewall.md",title:"Private Endpoint traffic not appearing in Azure Firewall",description:"Private Endpoint traffic can take a different route than your standard traffic and cause some confusion and dropped packets.",date:"2023-10-03T00:00:00.000Z",tags:[{label:"Azure",permalink:"/tags/azure"}],readingTime:2.03,hasTruncateMarker:!1,authors:[{name:"Luke Murray",title:"Author",url:"https://luke.geek.nz",imageURL:"https://luke.geek.nz/img/logo.png",key:"Luke"}],frontMatter:{title:"Private Endpoint traffic not appearing in Azure Firewall",authors:["Luke"],tags:["Azure"],toc:!1,header:{teaser:"/images/posts/BlobHeading_PrivateEndpointtrafficnotappearing.gif"},date:"2023-10-03 00:00:00 +1300",keywords:["azure","firewall","private endpoint"],slug:"azure/private-endpoint-traffic-not-appearing-azure-firewall",description:"Private Endpoint traffic can take a different route than your standard traffic and cause some confusion and dropped packets."},unlisted:!1,prevItem:{title:"Monitor your Azure Landing Zone with Baseline Alerts",permalink:"/azure/Monitor-Azure-LandingZones-with-AMBA"},nextItem:{title:"Empowering Resilience with Azure backup services",permalink:"/azure/Empowering-Resilience-with-Azure-backup-services"}},c={authorsImageUrls:[void 0]},l=[];function d(e){const t={a:"a",blockquote:"blockquote",em:"em",img:"img",li:"li",p:"p",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(t.p,{children:["You may have a situation where you have implemented ",(0,n.jsx)(t.a,{href:"https://learn.microsoft.com/azure/private-link/private-endpoint-overview?WT.mc_id=AZ-MVP-5004796",children:"Private endpoints"})," and the traffic from on-premises to those Private Endpoints, either doesn't work, even though on-premises firewalls say otherwise, or is working, but doesn't appear in the Azure Firewall."]}),"\n",(0,n.jsxs)(t.p,{children:["I had this recently with ",(0,n.jsx)(t.a,{href:"https://learn.microsoft.com/azure/azure-arc/overview?WT.mc_id=AZ-MVP-5004796",children:"Azure Arc"}),", where the endpoints failed to connect once a site-to-site VPN connection ",(0,n.jsx)(t.em,{children:"(which was working)"})," was replaced with an expressroute connection, but going through the Azure Firewall logs, was unable to see any 443 traffic for Arc, hitting the Firewall even when the connection was working."]}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.img,{alt:"Private Endpoint traffic not appearing in Azure Firewall",src:r(57500).A+"",width:"1200",height:"628"})}),"\n",(0,n.jsxs)(t.blockquote,{children:["\n",(0,n.jsx)(t.p,{children:"Traffic flow: Onpremises -- (ER Circuit) -- ER gateway -- Secured hub Azure Firewall -- (Vnet Connection) -- PE (Private Endpoint)"}),"\n"]}),"\n",(0,n.jsx)(t.p,{children:"The issue was related to how private endpoint traffic is routed differently."}),"\n",(0,n.jsx)(t.p,{children:"If the traffic has reached the Expressroute gateway from on-premises, with routing intent, normal traffic will be forced to the AzFW first before reaching its destination, as you would think and expect."}),"\n",(0,n.jsxs)(t.blockquote,{children:["\n",(0,n.jsx)(t.p,{children:"However, for the private endpoint scenario, once a Private Endpoint is deployed to any VNET, there will be an automatic system route with the PE IP and prefix /32 installed on all of the linked NICs.\nThe next hop for this route will be InterfaceEndpoint.\nThis route will allow the traffic to go directly to the PE, bypassing the routing intent and other user-defined routes that are larger than /32. The /32 route propagates to these areas: Any VPN or ExpressRoute connection to an on-premises system."}),"\n"]}),"\n",(0,n.jsxs)(t.p,{children:["See: ",(0,n.jsx)(t.a,{href:"https://learn.microsoft.com/en-us/azure/architecture/guide/networking/private-link-hub-spoke-network?WT.mc_id=AZ-MVP-5004796#considerations",children:"Considerations for Hub and Spoke topology"}),"."]}),"\n",(0,n.jsxs)(t.p,{children:["In an Azure Virtual Wide Area Network (VWAN), you could see this route in the virtual hub ",(0,n.jsx)(t.a,{href:"https://learn.microsoft.com/azure/virtual-wan/effective-routes-virtual-hub?WT.mc_id=AZ-MVP-5004796",children:"effective routes"})," and which gets propagated to the expressroute gateway."]}),"\n",(0,n.jsxs)(t.p,{children:["My traffic from on-premises to the Azure Arc went directly to the private endpoints (bypassing the Azure Firewall). Still, the route back via the Azure Firewall was completely different, leading to asymmetric routing ",(0,n.jsx)(t.em,{children:"(a packet traverses from a source to a destination in one path and takes a different path when it returns to the source)"}),"."]}),"\n",(0,n.jsxs)(t.p,{children:[(0,n.jsx)(t.strong,{children:"To resolve this"}),", we need to enable network security policies for User-Defined Routes on the subnet of the private endpoint(s):"]}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.img,{alt:"Azure Portal - Private Endpoint - Routes",src:r(53037).A+"",width:"1816",height:"708"})}),"\n",(0,n.jsx)(t.p,{children:"Once enabled, you should see the traffic connect and flow through your Azure Firewall almost immediately."}),"\n",(0,n.jsx)(t.p,{children:"Reference:"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.a,{href:"https://learn.microsoft.com/azure/private-link/disable-private-endpoint-network-policy?tabs=network-policy-portal&WT.mc_id=AZ-MVP-5004796",children:"Manage network policies for private endpoints"})}),"\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.a,{href:"https://learn.microsoft.com/azure/firewall-manager/private-link-inspection-secure-virtual-hub?WT.mc_id=AZ-MVP-5004796",children:"Secure traffic destined to private endpoints in Azure Virtual WAN"})}),"\n"]})]})}function p(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,n.jsx)(t,{...e,children:(0,n.jsx)(d,{...e})}):d(e)}},53037:(e,t,r)=>{r.d(t,{A:()=>n});const n=r.p+"assets/images/AzurePortal_RouteTables_PrivateEndpoint-036eb8b544141f79ad204b3acd2aeb93.png"},57500:(e,t,r)=>{r.d(t,{A:()=>n});const n=r.p+"assets/images/BlobHeading_PrivateEndpointtrafficnotappearing-46abd44f0fd04636f0a349e00b724711.gif"},28453:(e,t,r)=>{r.d(t,{R:()=>o,x:()=>s});var n=r(96540);const i={},a=n.createContext(i);function o(e){const t=n.useContext(a);return n.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function s(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),n.createElement(a.Provider,{value:t},e.children)}}}]);