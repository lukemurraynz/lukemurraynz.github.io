"use strict";(self.webpackChunklukemurraynz=self.webpackChunklukemurraynz||[]).push([[33904],{38099:(e,t,i)=>{i.r(t),i.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>s,metadata:()=>n,toc:()=>c});var n=i(84850),a=i(74848),r=i(28453);const s={title:"Implementing Correlation ID for API Management requests",metaDescription:"This article provides a comprehensive guide on implementing correlation IDs in API management systems, enhancing traceability and debugging capabilities.",date:new Date("2024-08-16T10:21:21.789Z"),tags:["Azure"],categories:["Azure"],authors:["Luke"],slug:"azure/implementing-correlation-id-in-api-management",keywords:["azure","apim","AzureOpenAI","AIGateway","API Management","Correlation ID","Traceability","Debugging","Microservices","Distributed Systems"],description:"This article provides a comprehensive guide on implementing correlation IDs in API management systems, enhancing traceability and debugging capabilities."},o=void 0,l={authorsImageUrls:[void 0]},c=[];function d(e){const t={a:"a",code:"code",em:"em",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(t.p,{children:["When working with ",(0,a.jsx)(t.a,{href:"https://learn.microsoft.com/azure/api-management/api-management-key-concepts?WT.mc_id=AZ-MVP-5004796",children:"Azure API Management"}),", you may want to enable traceability and correlation of requests across different services. This is where the Correlation ID comes in."]}),"\n",(0,a.jsxs)(t.p,{children:["Similar to ",(0,a.jsx)(t.a,{href:"https://www.w3.org/TR/trace-context/#traceparent-header-field-values",children:"traceparent"}),", the Correlation ID is a unique identifier passed along with the request and response headers. It allows you to track a request's flow as it moves through different services and systems."]}),"\n",(0,a.jsxs)(t.p,{children:["In this article, we will explore how to generate a new correlation ID through API Management Inbound policies and pass it back to the Client through an outbound policy, which then is used to help troubleshoot specific calls with ",(0,a.jsx)(t.a,{href:"https://learn.microsoft.com/azure/azure-monitor/app/app-insights-overview?WT.mc_id=AZ-MVP-5004796",children:"Application Insights"}),"."]}),"\n","\n",(0,a.jsx)(t.p,{children:"So, if you want an experience like the following to help pass the Correlation ID back to the client, then look up the transaction in Application Insights, then let us take a look:"}),"\n",(0,a.jsx)(t.p,{children:(0,a.jsx)(t.img,{alt:"Correlation ID",src:i(181).A+"",width:"1614",height:"1197"})}),"\n",(0,a.jsxs)(t.p,{children:["To start with, make sure that the API ",(0,a.jsx)(t.em,{children:"(Global or specific API)"})," has the following settings enabled:"]}),"\n",(0,a.jsx)(t.p,{children:(0,a.jsx)(t.img,{alt:"Correlation protocol",src:i(34935).A+"",width:"1992",height:"1123"})}),"\n",(0,a.jsx)(t.p,{children:"Now, we need to set an Inbound Policy to create the Correlation ID (if it's not already passed in the request) as a variable and assign that variable to an inbound header."}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-xml",children:'<inbound>\n  <set-variable name="correlation-id" value="@(context.Request.Headers.GetValueOrDefault(\'x-correlation-id\', Guid.NewGuid().ToString()))" />\n  <set-header name="x-correlation-id" exists-action="override">\n    <value>@((string)context.Variables["correlation-id"])</value>\n  </set-header>\n</inbound>\n'})}),"\n",(0,a.jsxs)(t.table,{children:[(0,a.jsx)(t.thead,{children:(0,a.jsxs)(t.tr,{children:[(0,a.jsx)(t.th,{children:(0,a.jsx)(t.strong,{children:"Line"})}),(0,a.jsx)(t.th,{children:(0,a.jsx)(t.strong,{children:"Explanation"})})]})}),(0,a.jsxs)(t.tbody,{children:[(0,a.jsxs)(t.tr,{children:[(0,a.jsx)(t.td,{children:(0,a.jsx)(t.code,{children:'<set-variable name="correlation-id" value="@(context.Request.Headers.GetValueOrDefault("x-correlation-id", Guid.NewGuid().ToString()))" />'})}),(0,a.jsxs)(t.td,{children:['This line is setting a variable named "correlation-id". It\'s getting the value from the request headers. If a header with the name "x-correlation-id" exists, it uses that value. If not, it generates a new unique ID using ',(0,a.jsx)(t.code,{children:"Guid.NewGuid().ToString()"}),"."]})]}),(0,a.jsxs)(t.tr,{children:[(0,a.jsx)(t.td,{children:(0,a.jsx)(t.code,{children:'<set-header name="x-correlation-id" exists-action="override">'})}),(0,a.jsx)(t.td,{children:'This line is setting a header named "x-correlation-id". If a header with this name already exists, it will be overridden.'})]}),(0,a.jsxs)(t.tr,{children:[(0,a.jsx)(t.td,{children:(0,a.jsx)(t.code,{children:'<value>@((string)context.Variables["correlation-id"])</value>'})}),(0,a.jsx)(t.td,{children:'This line sets the value of the "x-correlation-id" header to the value of the "correlation-id" variable.'})]}),(0,a.jsxs)(t.tr,{children:[(0,a.jsx)(t.td,{children:(0,a.jsx)(t.code,{children:"</set-header>"})}),(0,a.jsxs)(t.td,{children:["This line is closing the ",(0,a.jsx)(t.code,{children:"<set-header>"})," tag."]})]})]})]}),"\n",(0,a.jsx)(t.p,{children:"Once that added, we need to add another inbound policy:"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-xml",children:'<inbound>\n<trace source="Global APIM Policy" severity="information">\n    <message>@(String.Format("API: {0}, Operation: {1}", context.Api.Name, context.Operation.Name))</message>\n    <metadata name="correlation-id" value="@((string)context.Variables["correlation-id"])" />\n</trace>\n</inbound>\n'})}),"\n",(0,a.jsxs)(t.table,{children:[(0,a.jsx)(t.thead,{children:(0,a.jsxs)(t.tr,{children:[(0,a.jsx)(t.th,{children:(0,a.jsx)(t.strong,{children:"Element"})}),(0,a.jsx)(t.th,{children:(0,a.jsx)(t.strong,{children:"Description"})})]})}),(0,a.jsxs)(t.tbody,{children:[(0,a.jsxs)(t.tr,{children:[(0,a.jsx)(t.td,{children:(0,a.jsx)(t.code,{children:'<trace source="Global APIM Policy" severity="information">'})}),(0,a.jsx)(t.td,{children:'This is the start of a trace element. The\xa0source\xa0attribute is set to "Global APIM Policy" and the\xa0severity\xa0attribute is set to "information".'})]}),(0,a.jsxs)(t.tr,{children:[(0,a.jsx)(t.td,{children:(0,a.jsx)(t.code,{children:'<message>@(String.Format("API: {0}, Operation: {1}", context.Api.Name, context.Operation.Name))</message>'})}),(0,a.jsx)(t.td,{children:"This is a message element. It uses\xa0String.Format\xa0to create a string that includes the name of the API and the operation from the context."})]}),(0,a.jsxs)(t.tr,{children:[(0,a.jsx)(t.td,{children:(0,a.jsx)(t.code,{children:'<metadata name="correlation-id" value=\'@((string)context.Variables["correlation-id"])\' />'})}),(0,a.jsx)(t.td,{children:'This is a metadata element. It has a\xa0name\xa0attribute set to "correlation-id" and a\xa0value\xa0attribute that retrieves the "correlation-id" from the context variables and casts it to a string.'})]}),(0,a.jsxs)(t.tr,{children:[(0,a.jsx)(t.td,{children:(0,a.jsx)(t.code,{children:"</trace>"})}),(0,a.jsx)(t.td,{children:"This is the end of the trace element."})]})]})]}),"\n",(0,a.jsx)(t.p,{children:(0,a.jsx)(t.img,{alt:"Inbound Policy",src:i(87681).A+"",width:"2095",height:"1134"})}),"\n",(0,a.jsx)(t.p,{children:"This will help you track the Correlation ID in the logs and troubleshoot any issues that may arise."}),"\n",(0,a.jsx)(t.p,{children:"Once that has been added, it's time to return it to the client. This can be done with the following Outbound policy:"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-xml",children:'<outbound>\n  <set-header name="x-correlation-id" exists-action="override">\n    <value>@((string)context.Variables["correlation-id"])</value>\n  </set-header>\n</outbound>\n'})}),"\n",(0,a.jsxs)(t.table,{children:[(0,a.jsx)(t.thead,{children:(0,a.jsxs)(t.tr,{children:[(0,a.jsx)(t.th,{children:(0,a.jsx)(t.strong,{children:"Element"})}),(0,a.jsx)(t.th,{children:(0,a.jsx)(t.strong,{children:"Description"})})]})}),(0,a.jsxs)(t.tbody,{children:[(0,a.jsxs)(t.tr,{children:[(0,a.jsx)(t.td,{children:(0,a.jsx)(t.code,{children:"<outbound>"})}),(0,a.jsx)(t.td,{children:"This tag defines the outbound section of the policy. The operations inside this tag are applied to the response before it's sent back to the client."})]}),(0,a.jsxs)(t.tr,{children:[(0,a.jsx)(t.td,{children:(0,a.jsx)(t.code,{children:'<set-header name="x-correlation-id" exists-action="override">'})}),(0,a.jsxs)(t.td,{children:["This tag sets an HTTP header in the outbound response. The\xa0",(0,a.jsx)(t.code,{children:"name"}),"\xa0attribute specifies the name of the header, in this case\xa0",(0,a.jsx)(t.code,{children:"x-correlation-id"}),". The\xa0",(0,a.jsx)(t.code,{children:"exists-action"}),"\xa0attribute specifies what to do if the header already exists, in this case it's set to\xa0",(0,a.jsx)(t.code,{children:"override"}),", meaning the existing header will be replaced."]})]}),(0,a.jsxs)(t.tr,{children:[(0,a.jsx)(t.td,{children:(0,a.jsx)(t.code,{children:'<value>@((string)context.Variables["correlation-id"])</value>'})}),(0,a.jsxs)(t.td,{children:["This tag sets the value of the header. It's using a variable from the context named\xa0",(0,a.jsx)(t.code,{children:"correlation-id"}),". The\xa0",(0,a.jsx)(t.code,{children:"@"}),"\xa0symbol is used to denote an expression in Azure API Management policies."]})]})]})]}),"\n",(0,a.jsx)(t.p,{children:(0,a.jsx)(t.img,{alt:"Outbound Policy",src:i(34620).A+"",width:"2113",height:"1135"})}),"\n",(0,a.jsx)(t.p,{children:"Reference:"}),"\n",(0,a.jsxs)(t.ul,{children:["\n",(0,a.jsx)(t.li,{children:(0,a.jsx)(t.a,{href:"https://yourazurecoach.com/2021/01/22/optimizing-api-traceability-in-azure-api-management/",children:"Optimizing traceability in Azure API Management"})}),"\n"]})]})}function h(e={}){const{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,a.jsx)(t,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},87681:(e,t,i)=>{i.d(t,{A:()=>n});const n=i.p+"assets/images/apim-appin-trace_inboundpolicy-29950dbb1ce2ffd7c7a0598c0636f3fa.jpg"},34620:(e,t,i)=>{i.d(t,{A:()=>n});const n=i.p+"assets/images/apim-appin-trace_outboundpolicy-87a73d904abbaa9e23010ecdf2426867.jpg"},34935:(e,t,i)=>{i.d(t,{A:()=>n});const n=i.p+"assets/images/apim-appin-trace_verbosity-cf0f09eef2ceb0682a50c1564b2044b7.jpg"},181:(e,t,i)=>{i.d(t,{A:()=>n});const n=i.p+"assets/images/apim_appin_requesttrace-7f84df8f428f2b3c298d8550ae1af671.gif"},28453:(e,t,i)=>{i.d(t,{R:()=>s,x:()=>o});var n=i(96540);const a={},r=n.createContext(a);function s(e){const t=n.useContext(r);return n.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:s(e.components),n.createElement(r.Provider,{value:t},e.children)}},84850:e=>{e.exports=JSON.parse('{"permalink":"/azure/implementing-correlation-id-in-api-management","source":"@site/blog/2024-08-16-apim-appin-trace/index.mdx","title":"Implementing Correlation ID for API Management requests","description":"This article provides a comprehensive guide on implementing correlation IDs in API management systems, enhancing traceability and debugging capabilities.","date":"2024-08-16T10:21:21.789Z","tags":[{"inline":true,"label":"Azure","permalink":"/tags/azure"}],"readingTime":3.81,"hasTruncateMarker":true,"authors":[{"name":"Luke Murray","title":"Author","url":"https://luke.geek.nz","imageURL":"https://luke.geek.nz/img/logo.png","key":"Luke","page":null}],"frontMatter":{"title":"Implementing Correlation ID for API Management requests","metaDescription":"This article provides a comprehensive guide on implementing correlation IDs in API management systems, enhancing traceability and debugging capabilities.","date":"2024-08-16T10:21:21.789Z","tags":["Azure"],"categories":["Azure"],"authors":["Luke"],"slug":"azure/implementing-correlation-id-in-api-management","keywords":["azure","apim","AzureOpenAI","AIGateway","API Management","Correlation ID","Traceability","Debugging","Microservices","Distributed Systems"],"description":"This article provides a comprehensive guide on implementing correlation IDs in API management systems, enhancing traceability and debugging capabilities."},"unlisted":false,"prevItem":{"title":"Azure Communication Services and PowerShell for Email","permalink":"/azure/using-communication-services-and-powershell-to-send-emails"},"nextItem":{"title":"Implementing AI Gateway capabilities in API Management","permalink":"/azure/implementing-ai-gateway-in-api-management"}}')}}]);