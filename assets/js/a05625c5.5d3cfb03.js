"use strict";(self.webpackChunklukemurraynz=self.webpackChunklukemurraynz||[]).push([[65418],{93624:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>d,frontMatter:()=>o,metadata:()=>i,toc:()=>l});var i=t(71875),s=t(74848),r=t(28453);const o={title:"Processing SFTP Events with Azure Function and Event Hub",metaDescription:"Learn how to use Azure Storage SFTP functionality with Event Hub to trigger Azure Functions for processing file uploads",date:new Date("2025-04-18T02:13:25.749Z"),tags:["Azure"],categories:["Azure"],authors:["Luke"],slug:"azure/sftp-event-hub-function",keywords:["Azure","SFTP","Event Hub","Azure Functions","PowerShell","Serverless","File Transfer","Event-driven","Storage Account","Integration","Monitoring","Data Processing","Blob Storage","Cloud Functions"],description:"A practical guide to setting up Azure Storage SFTP with Event Hub and Azure Functions to monitor and process file uploads"},a="\ud83d\ude80 Processing SFTP Events with Azure Functions and Event Hub",c={authorsImageUrls:[void 0]},l=[{value:"\ud83c\udfd7\ufe0f Environment Overview",id:"\ufe0f-environment-overview",level:2},{value:"\ud83d\udce6 Storage Account Configuration",id:"-storage-account-configuration",level:2},{value:"\ud83d\udce1 Event Hub Namespace Configuration",id:"-event-hub-namespace-configuration",level:2},{value:"\u2699\ufe0f Function App Configuration",id:"\ufe0f-function-app-configuration",level:2},{value:"\ud83d\udd12 Authentication Setup",id:"-authentication-setup",level:2},{value:"\ud83d\udee0\ufe0f Function App Settings",id:"\ufe0f-function-app-settings",level:2},{value:"\ud83d\udccb Function Configuration File",id:"-function-configuration-file",level:2},{value:"\ud83d\udcbb PowerShell Code",id:"-powershell-code",level:2},{value:"\ud83d\udd0d See it in Action!",id:"-see-it-in-action",level:2},{value:"\u23f1\ufe0f Performance Considerations",id:"\ufe0f-performance-considerations",level:2},{value:"\ud83d\ude80 Next Steps and Extensions",id:"-next-steps-and-extensions",level:2}];function u(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",img:"img",li:"li",mermaid:"mermaid",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(n.p,{children:["Today, we are going to use the ",(0,s.jsx)(n.a,{href:"https://learn.microsoft.com/azure/storage/blobs/secure-file-transfer-protocol-support?WT.mc_id=AZ-MVP-5004796",children:"Azure Storage SFTP functionality"})," and an ",(0,s.jsx)(n.a,{href:"https://learn.microsoft.com/azure/event-hubs/event-hubs-about?WT.mc_id=AZ-MVP-5004796",children:"Event Hub"})," to trigger an ",(0,s.jsx)(n.a,{href:"https://learn.microsoft.com/azure/azure-functions/functions-overview?WT.mc_id=AZ-MVP-5004796",children:"Azure Function"}),". The Azure Function will then process the Write Logs, and output the File name, SFTP Local User name, Agent header and the SFTP Client IP address to the host, from there you can do whatever you want with the data."]}),"\n","\n",(0,s.jsx)(n.h2,{id:"\ufe0f-environment-overview",children:"\ud83c\udfd7\ufe0f Environment Overview"}),"\n",(0,s.jsx)(n.p,{children:"So for my environment, I have a:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"A SFTP Hierarchical namespace-enabled storage account"}),"\n",(0,s.jsx)(n.li,{children:"A Flex Consumption Azure Function App"}),"\n",(0,s.jsx)(n.li,{children:"A Standard Event Hub Namespace with an event hub instance with 1 partition and 1 consumer group"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"These resources are hosted in the New Zealand North Azure region."}),"\n",(0,s.jsx)(n.mermaid,{value:"flowchart LR\n    User[SFTP Client]--\x3e|Uploads File|Storage[(Azure Storage SFTP)]\n    Storage--\x3e|Sends Event|EventHubNS[Event Hub Namespace]\n    subgraph EventHubNS[Event Hub Namespace]\n        EventHub[Event Hub]\n        ConsumerGroup[Consumer Group]\n    end\n    EventHub--\x3eConsumerGroup\n    ConsumerGroup--\x3e|Triggers|Function[Azure Function]\n    Function--\x3e|Processes|Output[File Details Output]\n\n    classDef azure fill:#0072C6,stroke:#0072C6,color:white;\n    classDef client fill:#5C2D91,stroke:#5C2D91,color:white;\n\n    class Storage,EventHubNS,EventHub,EventHub,ConsumerGroup,Function azure;\n    class User client;"}),"\n",(0,s.jsx)(n.p,{children:"So I've already pre-created these resources, but is there some more information about the resource configuration that you can follow along with?"}),"\n",(0,s.jsx)(n.h2,{id:"-storage-account-configuration",children:"\ud83d\udce6 Storage Account Configuration"}),"\n",(0,s.jsx)(n.p,{children:"For the Azure Storage account with SFTP enabled, I'm using the following configuration:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Name"}),": sftptestluketest"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Location"}),": New Zealand North"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Performance"}),": Standard"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Redundancy"}),": Locally-redundant storage (LRS)"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Account kind"}),": StorageV2 (general purpose v2)"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Access tier"}),": Hot"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Key features enabled"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Hierarchical namespace (HNS) \u2705"}),"\n",(0,s.jsx)(n.li,{children:"SFTP support \u2705"}),"\n",(0,s.jsx)(n.li,{children:"Local user authentication \u2705"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Security settings"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Minimum TLS version: 1.2"}),"\n",(0,s.jsx)(n.li,{children:"Public blob access: Disabled"}),"\n",(0,s.jsx)(n.li,{children:"Network access: Public (default action: Allow)"}),"\n",(0,s.jsx)(n.li,{children:"HTTPS only: Enabled"}),"\n",(0,s.jsx)(n.li,{children:"Azure services bypass: Enabled"}),"\n",(0,s.jsx)(n.li,{children:"Shared key access: Enabled"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Diagnostic settings"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"StorageWrite logs sent to Event Hub Namespace"}),"\n",(0,s.jsx)(n.li,{children:"Configured to capture StorageWrite logs for all blob operations"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"Azure Storage SFTP Blob Diagnostic",src:t(13129).A+"",width:"1150",height:"847"})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"The hierarchical namespace (HNS) is a prerequisite for SFTP support in Azure Storage. This enables the directory and subdirectory structure that SFTP clients expect when connecting."}),"\n",(0,s.jsx)(n.p,{children:"With SFTP and local users enabled, you can create local SFTP users that can authenticate with password and/or SSH key authentication, and assign them permissions to specific containers and directories within your storage account."}),"\n",(0,s.jsx)(n.h2,{id:"-event-hub-namespace-configuration",children:"\ud83d\udce1 Event Hub Namespace Configuration"}),"\n",(0,s.jsx)(n.p,{children:"For receiving and processing the Azure Storage SFTP events, I've set up an Event Hub Namespace with the following configuration:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Name"}),": sftpeventhub"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Location"}),": New Zealand North"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Pricing tier"}),": Standard"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Throughput capacity"}),": 1 throughput unit (base capacity)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Key features"}),":","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Auto-inflate enabled \u2705"}),"\n",(0,s.jsx)(n.li,{children:"Maximum throughput units: 5 (scales automatically as needed)"}),"\n",(0,s.jsx)(n.li,{children:"Zone redundant \u2705"}),"\n",(0,s.jsx)(n.li,{children:"Kafka support enabled \u2705"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Security settings"}),":","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Minimum TLS version: 1.2"}),"\n",(0,s.jsx)(n.li,{children:"Network access: Public"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Within this namespace, I've created an Event Hub instance with a single partition and a dedicated consumer group that will be used by the Azure Function to process SFTP events."}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"Event Hub Namespace Configuration",src:t(1224).A+"",width:"1979",height:"938"})}),"\n",(0,s.jsx)(n.h2,{id:"\ufe0f-function-app-configuration",children:"\u2699\ufe0f Function App Configuration"}),"\n",(0,s.jsx)(n.p,{children:"For processing the SFTP events from the Event Hub, I've set up an Azure Function App with the following configuration:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Name"}),": sftptest"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Location"}),": Australia East (Different from Storage and Event Hub to demonstrate cross-region capability)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Hosting plan"}),": FlexConsumption (serverless)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Runtime stack"}),": PowerShell 7.4"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Operating system"}),": Linux"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Key features"}),":","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Application Insights enabled \u2705"}),"\n",(0,s.jsx)(n.li,{children:"HTTPS only \u2705"}),"\n",(0,s.jsx)(n.li,{children:"System-assigned managed identity \u2705"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Scaling configuration"}),":","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Maximum instance count: 100"}),"\n",(0,s.jsx)(n.li,{children:"Instance memory: 2048 MB"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Security settings"}),":","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Public network access: Enabled"}),"\n",(0,s.jsx)(n.li,{children:"Client certificate mode: Required"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"-authentication-setup",children:"\ud83d\udd12 Authentication Setup"}),"\n",(0,s.jsxs)(n.p,{children:["The Function App connects to the Event Hub namespace using the System Managed Identity of the Function App, which is granted the ",(0,s.jsx)(n.code,{children:"Azure Event Hubs Data Receiver"})," role on the Event Hub namespace."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"Function App Configuration",src:t(53549).A+"",width:"1727",height:"319"})}),"\n",(0,s.jsx)(n.h2,{id:"\ufe0f-function-app-settings",children:"\ud83d\udee0\ufe0f Function App Settings"}),"\n",(0,s.jsx)(n.p,{children:"To use the Event Hub trigger in the Azure Function with Managed Identity authentication, you need to add the following settings to the Function App settings :"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "EventHubConnection__credential": managedIdentity\n  "EventHubConnection__fullyQualifiedNamespace": "<Your Event Hub Namespace>.servicebus.windows.net"\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"Event Hub App setting",src:t(84044).A+"",width:"1975",height:"562"})}),"\n",(0,s.jsx)(n.h2,{id:"-function-configuration-file",children:"\ud83d\udccb Function Configuration File"}),"\n",(0,s.jsx)(n.p,{children:"The namespace, Consumer Group, and identity type will need to be updated in the function.json file."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "bindings": [\n    {\n      "type": "eventHubTrigger",\n      "name": "eventHubMessages",\n      "direction": "in",\n      "eventHubName": "sftp",\n      "connection": "EventHubConnection",\n      "cardinality": "many",\n      "consumerGroup": "$Default",\n      "identity": "SystemAssigned",\n      "fullyQualifiedNamespace": "sftpeventhub.servicebus.windows.net"\n    }\n  ]\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"-powershell-code",children:"\ud83d\udcbb PowerShell Code"}),"\n",(0,s.jsx)(n.p,{children:"Here is my run.ps1 file for the Azure Function:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-powershell",children:'param($eventHubMessages, $TriggerMetadata)\n\nWrite-Host "PowerShell SFTP event hub trigger function called"\n\n# Process each message\n$eventHubMessages | ForEach-Object {\n    # Get the records array from the message\n    if ($_ -is [System.Management.Automation.OrderedHashtable] -or $_ -is [hashtable]) {\n        if ($_.ContainsKey(\'records\')) {\n            Write-Host "Processing SFTP Storage events..."\n\n            # Filter for StorageWrite operations with status code 200\n            $filteredRecords = $_.records | Where-Object {\n                $_.category -eq "StorageWrite" -and $_.statusCode -eq 200 -and $_.operationName -eq "SftpCreate"\n            }\n\n            Write-Host "Found $($filteredRecords.Count) StorageWrite 200 operations"\n\n            # Display only the requested information\n            foreach ($record in $filteredRecords) {\n                $output = [ordered]@{\n                    \'Operation\'     = $record.operationName\n                    \'FileName\'      = if ($record.properties.objectKey -match \'^(?:[^/]*/){3}(.*)$\') { $matches[1] } else { $record.properties.objectKey }\n                    \'UserID\'        = $record.identity.requester.objectId\n                    \'UserIPAddress\' = $record.callerIpAddress\n                    \'UserAgent\'     = $record.properties.userAgentHeader\n                    \'Time\'          = $record.time\n                }\n\n                # Output in a clean table format\n                Write-Host "----------------------------------------"\n                foreach ($key in $output.Keys) {\n                    Write-Host "$($key.PadRight(12)): $($output[$key])"\n                }\n            }\n\n            if ($filteredRecords.Count -gt 0) {\n                Write-Host "----------------------------------------"\n            }\n        }\n    }\n    else {\n        Write-Host "Message wasn\'t in the expected format"\n    }\n}\n'})}),"\n",(0,s.jsx)(n.admonition,{type:"info",children:(0,s.jsxs)(n.p,{children:["You can find the Function App code in the ",(0,s.jsx)(n.a,{href:"https://github.com/lukemurraynz/SFTPEventHubFunction",children:"GitHub repository - lukemurraynz/SFTPEventHubFunction"})," for this blog post."]})}),"\n",(0,s.jsx)(n.h2,{id:"-see-it-in-action",children:"\ud83d\udd0d See it in Action!"}),"\n",(0,s.jsx)(n.p,{children:"So let us take a look at it in action!"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"Azure SFTP Blob Write Run",src:t(88678).A+"",width:"1904",height:"852"})}),"\n",(0,s.jsx)(n.h2,{id:"\ufe0f-performance-considerations",children:"\u23f1\ufe0f Performance Considerations"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.em,{children:"(On average, I have seen this take about 2 minutes, from the initial file upload, to the Function execution)"}),"."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"SFTP Function execution",src:t(32002).A+"",width:"823",height:"313"})}),"\n",(0,s.jsx)(n.h2,{id:"-next-steps-and-extensions",children:"\ud83d\ude80 Next Steps and Extensions"}),"\n",(0,s.jsx)(n.p,{children:"Hopefully, that's given you the base to work from; you could potentially add logic around if a file from x user, do this, or notify the user of receipt based on a map lookup, etc."})]})}function d(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(u,{...e})}):u(e)}},13129:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/AzureSFTPBlogStorageDiagEH-87de513a67721d5d1b696b6fe014a737.jpg"},1224:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/EventHubNSConfig-4c3ef7400af9ff54c1f0e16917092a12.jpg"},84044:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/Function_AppSetting-79719db595e3bd486e82dfb4df1d02dd.jpg"},53549:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/Function_SMI_EventHubDataReceiver-d0fdd7c8fa804fe6271f264284f38341.jpg"},88678:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/SFTPEventHubFunctionRun-d4f4fc4c01b6f2f8f6a9fa6dbc4367c1.gif"},32002:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/SFTPFuncExecuteTime-09cc1f865276c6fa785435c065263aa8.jpg"},28453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>a});var i=t(96540);const s={},r=i.createContext(s);function o(e){const n=i.useContext(r);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),i.createElement(r.Provider,{value:n},e.children)}},71875:e=>{e.exports=JSON.parse('{"permalink":"/azure/sftp-event-hub-function","source":"@site/blog/2025-04-18-sftpeventhubfunction/index.mdx","title":"Processing SFTP Events with Azure Function and Event Hub","description":"A practical guide to setting up Azure Storage SFTP with Event Hub and Azure Functions to monitor and process file uploads","date":"2025-04-18T02:13:25.749Z","tags":[{"inline":true,"label":"Azure","permalink":"/tags/azure"}],"readingTime":5.025,"hasTruncateMarker":true,"authors":[{"name":"Luke Murray","title":"Author","url":"https://luke.geek.nz","imageURL":"https://luke.geek.nz/img/logo.png","key":"Luke","page":null}],"frontMatter":{"title":"Processing SFTP Events with Azure Function and Event Hub","metaDescription":"Learn how to use Azure Storage SFTP functionality with Event Hub to trigger Azure Functions for processing file uploads","date":"2025-04-18T02:13:25.749Z","tags":["Azure"],"categories":["Azure"],"authors":["Luke"],"slug":"azure/sftp-event-hub-function","keywords":["Azure","SFTP","Event Hub","Azure Functions","PowerShell","Serverless","File Transfer","Event-driven","Storage Account","Integration","Monitoring","Data Processing","Blob Storage","Cloud Functions"],"description":"A practical guide to setting up Azure Storage SFTP with Event Hub and Azure Functions to monitor and process file uploads"},"unlisted":false,"nextItem":{"title":"Sending Emails with MCP and Azure Communication Services","permalink":"/azure/mcp-acs-email-integration"}}')}}]);