"use strict";(self.webpackChunklukemurraynz=self.webpackChunklukemurraynz||[]).push([[6732],{76842:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>d,frontMatter:()=>o,metadata:()=>s,toc:()=>u});var a=n(74848),r=n(28453);const o={date:new Date("2019-09-08T00:00:00.000Z"),title:"Update your Azure Local Network Gateway IP with PowerShell",authors:["Luke"],tags:["Azure","PowerShell"],header:{teaser:"images/iazure-marketplace-banner.png"}},i=void 0,s={permalink:"/2019/09/08/Update your Azure Local Network Gateway IP with PowerShell",source:"@site/blog/2019-09-08-Update your Azure Local Network Gateway IP with PowerShell.md",title:"Update your Azure Local Network Gateway IP with PowerShell",description:"One of the issues you face with setting up an Azure Site to Site VPN is making sure that your Azure Local Network Gateway always has your Public/On-premises IP.",date:"2019-09-08T00:00:00.000Z",tags:[{inline:!0,label:"Azure",permalink:"/tags/azure"},{inline:!0,label:"PowerShell",permalink:"/tags/power-shell"}],readingTime:2.215,hasTruncateMarker:!1,authors:[{name:"Luke Murray",title:"Author",url:"https://luke.geek.nz",imageURL:"https://luke.geek.nz/img/logo.png",key:"Luke",page:null}],frontMatter:{date:"2019-09-08T00:00:00.000Z",title:"Update your Azure Local Network Gateway IP with PowerShell",authors:["Luke"],tags:["Azure","PowerShell"],header:{teaser:"images/iazure-marketplace-banner.png"}},unlisted:!1,prevItem:{title:"First look at Universal Automation Desktop",permalink:"/2020/02/29/First look at Universal Automation Desktop"},nextItem:{title:"How to manage cost in Microsoft Azure",permalink:"/2018/12/19/How to manage cost in Microsoft Azure"}},l={authorsImageUrls:[void 0]},u=[];function c(e){const t={a:"a",code:"code",em:"em",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(t.p,{children:["One of the issues you face with setting up an Azure ",(0,a.jsx)(t.a,{href:"https://learn.microsoft.com/en-us/azure/vpn-gateway/tutorial-site-to-site-portal?WT.mc_id=AZ-MVP-5004796",children:"Site to Site VPN"})," is making sure that your Azure Local Network Gateway always has your Public/On-premises IP."]}),"\n",(0,a.jsx)(t.p,{children:"This setup is fine when used in environments that have Static IPs (and yes if setting this up for a Business or Production, it is highly recommended to have a static IP!)."}),"\n",(0,a.jsx)(t.p,{children:"However, when used in environments like my home network or lab environments - which has a Dynamic IP that could change at any time it will cause connectivity issues if your IP changes and the Local Network Gateway is not updated."}),"\n",(0,a.jsx)(t.p,{children:"The script below \u2013 intended to be run on as a Daily scheduled task, will find\nyour Public IP and connect to Azure and if needed \u2013 will update the IP of your\nLocal Network Gateway."}),"\n",(0,a.jsx)(t.p,{children:"Prerequisites:"}),"\n",(0,a.jsxs)(t.ul,{children:["\n",(0,a.jsx)(t.li,{children:(0,a.jsx)(t.a,{href:"https://learn.microsoft.com/en-us/powershell/azure/install-az-ps?view=azps-7.5.0&WT.mc_id=AZ-MVP-5004796",children:"Az PowerShell Module"})}),"\n",(0,a.jsxs)(t.li,{children:[(0,a.jsx)(t.a,{href:"https://learn.microsoft.com/en-us/azure/active-directory/develop/howto-create-service-principal-portal?WT.mc_id=AZ-MVP-5004796",children:"Azure Service Principal"})," (with Contributor rights to the Azure Local Network Gateway)"]}),"\n"]}),"\n",(0,a.jsx)(t.p,{children:"Once you have the Azure Service Principal and Az Module installed, you need to\nedit the following variables to suit your environment:"}),"\n",(0,a.jsxs)(t.ul,{children:["\n",(0,a.jsx)(t.li,{children:"$ResourceGroup = 'RESOURCE GROUP OF LOCAL NETWORK GATEWAY'"}),"\n",(0,a.jsx)(t.li,{children:"$LocalNetworkGateway = \u2018NAME OF AZURE LOCAL NETWORK GATEWAY\u2019"}),"\n",(0,a.jsx)(t.li,{children:"$azureAplicationId =\u2019AZURE AD APPLICATION ID\u2019"}),"\n",(0,a.jsx)(t.li,{children:"$azureTenantId= \u2018AZURE AD TENANCY/DIRECTORY ID\u2019"}),"\n",(0,a.jsx)(t.li,{children:"$azureAPI = \u2018AZURE AD APPLICATION API/CLIENT SECRET\u2019"}),"\n"]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-powershell",metastring:'title="Update-LocalNetGatewayIP.ps1"',children:"\n#requires -Version 3.0 -Modules Az.Network\n<#\n      .SYNOPSIS\n      Custom script to update your Azure Local Network Gateway with your Public IP\n      .DESCRIPTION\n      Updates the Azure Local Network Gateway with your Public IP\n      Version: 1.0\n      Author:  Luke Murray (Luke.Geek.NZ)\n      If no Public IP parameter is set, it will automatically grab the Public IP of the computer running it and set it.\n      The intention of this script is to run as as a scheduled task on your network, which connects to Azure and updates. Intended for Homelabs and scenarios which have Dynamic IPs.\n\n  #>\n#---------------------------------------------------------[Initialisations]--------------------------------------------------------\n  \n$ErrorActionPreference = 'Stop'\n\n[Object]$PublicIP = (Invoke-WebRequest -Uri 'http://ifconfig.me/ip').Content \n[string]$ResourceGroup = 'z_Network'\n[string]$LocalNetworkGateway = 'Prod-SiteToSite-VLAN-LNGateway'\n\n# Use the application ID as the username, and the secret as password\n$azureAplicationId =\"Azure AD Application Id\"\n$azureTenantId= \"Your Tenant Id\"\n$azureAPI = \"Your API Key\"\n$azurePassword = ConvertTo-SecureString \"$azureAPI\" -AsPlainText -Force\n$psCred = New-Object System.Management.Automation.PSCredential($azureAplicationId , $azurePassword)\nConnect-AzAccount -Credential $psCred -TenantId $azureTenantId  -ServicePrincipal \n\n<#\n\nBefore adding the Azure Service Principal in and testing as a Scheduled Task, it is recommended that you just test the script first by connecting manually using:\n\nConnect-AzAccount\n\n #>\n  \n#-----------------------------------------------------------[Execution]------------------------------------------------------------  \n\n \n  \n$a = Get-AzLocalNetworkGateway -ResourceGroupName $ResourceGroup -Name $LocalNetworkGateway\n$GatewayIP = $a.GatewayIpAddress\n \n\nIf ($PublicIP -ne $GatewayIP) {\n\n    $a.GatewayIpAddress = $PublicIP\n    Set-AzLocalNetworkGateway -LocalNetworkGateway $a\n\n}\n  \nElse {\n\n   $null\n    \n}\n\n"})}),"\n",(0,a.jsx)(t.p,{children:(0,a.jsx)(t.em,{children:"Note: Script is also hosted on my Github repository. Feel free to clone/recommend improvements or fork."})})]})}function d(e={}){const{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,a.jsx)(t,{...e,children:(0,a.jsx)(c,{...e})}):c(e)}},28453:(e,t,n)=>{n.d(t,{R:()=>i,x:()=>s});var a=n(96540);const r={},o=a.createContext(r);function i(e){const t=a.useContext(o);return a.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function s(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),a.createElement(o.Provider,{value:t},e.children)}}}]);