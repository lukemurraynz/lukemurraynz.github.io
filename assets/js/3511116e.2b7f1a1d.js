"use strict";(self.webpackChunklukemurraynz=self.webpackChunklukemurraynz||[]).push([[25808],{36177:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>a,contentTitle:()=>i,default:()=>h,frontMatter:()=>s,metadata:()=>l,toc:()=>c});var r=n(85893),o=n(11151);const s={date:"2021-08-25 00:00:00 +1200",title:"Always on VPN - Error 809 The network connection between your computer and the VPN server could not be established ",authors:["Luke"],tags:["Windows"],toc:!0,header:{teaser:"/uploads/windows-server.jpg"}},i=void 0,l={permalink:"/2021/08/25/always-on-vpn-error-809-the-network-connection-between-your-computer-and-the-vpn-server-could-not-be-established",source:"@site/blog/2021-08-25-always-on-vpn-error-809-the-network-connection-between-your-computer-and-the-vpn-server-could-not-be-established.md",title:"Always on VPN - Error 809 The network connection between your computer and the VPN server could not be established ",description:"I ran into a weird issue, troubleshooting an 'Always On VPN' installation running off Windows Server 2019, the clients were getting the following error in the Application event log:",date:"2021-08-25T00:00:00.000Z",formattedDate:"August 25, 2021",tags:[{label:"Windows",permalink:"/tags/windows"}],readingTime:2.57,hasTruncateMarker:!1,authors:[{name:"Luke Murray",title:"Author",url:"https://luke.geek.nz",imageURL:"https://luke.geek.nz/img/logo.png",key:"Luke"}],frontMatter:{date:"2021-08-25 00:00:00 +1200",title:"Always on VPN - Error 809 The network connection between your computer and the VPN server could not be established ",authors:["Luke"],tags:["Windows"],toc:!0,header:{teaser:"/uploads/windows-server.jpg"}},unlisted:!1,prevItem:{title:"Benefits to using the Microsoft Azure Cloud to host your Infrastructure",permalink:"/2021/10/28/benefits-to-using-the-microsoft-azure-cloud-to-host-your-infrastructure"},nextItem:{title:"Update-AdmPwdAdSchema - The requested attribute does not exist",permalink:"/2021/08/21/update-admpwdadschema-the-requested-attribute-does-not-exist"}},a={authorsImageUrls:[void 0]},c=[{value:"Increase Ports",id:"increase-ports",level:3},{value:"Enable TLS 1.1",id:"enable-tls-11",level:3},{value:"Enable TLS 1.1",id:"enable-tls-11-1",level:4},{value:"Disable TLS 1.1",id:"disable-tls-11",level:4}];function d(e){const t={a:"a",blockquote:"blockquote",code:"code",em:"em",h3:"h3",h4:"h4",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.a)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.p,{children:"I ran into a weird issue, troubleshooting an 'Always On VPN' installation running off Windows Server 2019, the clients were getting the following error in the Application event log:"}),"\n",(0,r.jsxs)(t.blockquote,{children:["\n",(0,r.jsx)(t.p,{children:"Error 809 The network connection between your computer and the VPN server could not be established"}),"\n"]}),"\n",(0,r.jsxs)(t.p,{children:["In my case, the issue wasn't due to ",(0,r.jsx)(t.a,{href:"https://directaccess.richardhicks.com/2019/02/14/troubleshooting-always-on-vpn-error-code-809/",title:"Troubleshooting Always On VPN Error Code 809",children:"IKEv2 Fragmentation"})," or anything to do with ",(0,r.jsx)(t.a,{href:"https://directaccess.richardhicks.com/2020/04/13/always-on-vpn-ikev2-load-balancing-and-nat/",title:"Always On VPN IKEv2 Load Balancing and NAT",children:"NAT"})," to allow the origin IP to flow to the Always-on VPN server. It was due to the ports being limited to: '2'. I found an old post regarding Windows Server 2008 R2:"]}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://support.microsoft.com/en-us/topic/the-maximum-number-of-wan-miniport-ikev2-ports-changes-from-128-to-two-after-you-install-windows-server-2008-r2-sp1-15aeb929-abe9-ece0-5d71-d2223d6a94d0",title:" The maximum number of WAN Miniport (IKEv2) ports changes from 128 to two after you install Windows Server 2008 R2 SP1",children:"The maximum number of WAN Miniport (IKEv2) ports changes from 128 to two after you install Windows Server 2008 R2 SP1"})}),"\n"]}),"\n",(0,r.jsxs)(t.blockquote,{children:["\n",(0,r.jsx)(t.p,{children:'"If more than two clients try to connect to the server at the same time, the Routing and Remote Access service rejects the IKEv2 connection requests. Additionally, the following message is logged in the Rastapi.log file:"'}),"\n"]}),"\n",(0,r.jsx)(t.p,{children:"This matched my issue; I had never seen more than 2 connections at once."}),"\n",(0,r.jsx)(t.h3,{id:"increase-ports",children:"Increase Ports"}),"\n",(0,r.jsxs)(t.ol,{children:["\n",(0,r.jsxs)(t.li,{children:["Open ",(0,r.jsx)(t.strong,{children:"Routing and Remote Access"})]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"Click"})," on your Routing and ",(0,r.jsx)(t.strong,{children:"Remote Access server"})]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"Right"}),"-",(0,r.jsx)(t.strong,{children:"click"})," on ",(0,r.jsx)(t.strong,{children:"Ports"})]}),"\n",(0,r.jsxs)(t.li,{children:["Click on: ",(0,r.jsx)(t.strong,{children:"WAN Miniport (IKEv2)"})]}),"\n",(0,r.jsxs)(t.li,{children:["Click ",(0,r.jsx)(t.strong,{children:"Configure"})]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"Ensure"})," that: To ",(0,r.jsx)(t.strong,{children:"enable remote access"}),", select Remote access ",(0,r.jsx)(t.strong,{children:"connections"})," (inbound only) is ",(0,r.jsx)(t.strong,{children:"checked."})]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"Change Maximum ports"})," from 2 ",(0,r.jsx)(t.em,{children:"(as an example)"})," to a number that matches how many connections you want - I went with ",(0,r.jsx)(t.strong,{children:"128"})]}),"\n",(0,r.jsxs)(t.li,{children:["Click ",(0,r.jsx)(t.strong,{children:"Ok"})]}),"\n",(0,r.jsxs)(t.li,{children:["Click ",(0,r.jsx)(t.strong,{children:"Apply"})]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"Restart"})," the Routing and Remote Access ",(0,r.jsx)(t.strong,{children:"server. You"})," should now see more ports listed 'as inactive' until a new session comes along and uses it."]}),"\n"]}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.img,{alt:"Routing and Remote Access",src:n(67070).Z+"",title:"Routing and Remote Access",width:"407",height:"343"})}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.img,{alt:"Routing and Remote Access",src:n(8311).Z+"",title:"Routing and Remote Access",width:"396",height:"301"})}),"\n",(0,r.jsx)(t.h3,{id:"enable-tls-11",children:"Enable TLS 1.1"}),"\n",(0,r.jsxs)(t.p,{children:["Although this wasn't my initial fix, I had a Microsoft Support call opened regarding this issue; after analysing the logs, they recommended enabling TLS 1.1 ",(0,r.jsx)(t.em,{children:"(which was disabled by default on a Windows Server 2019 server)"}),". I would only do this as a last resort - if required."]}),"\n",(0,r.jsx)(t.p,{children:"Run the PowerShell script below (as Administrator) to Enable; you can always rerun the Disable script to remove the changes."}),"\n",(0,r.jsx)(t.h4,{id:"enable-tls-11-1",children:"Enable TLS 1.1"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"function enable-tls-1.1\n{\n    New-Item 'HKLM:\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.1\\Server' -Force\n    New-Item 'HKLM:\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.1\\Client' -Force\n    New-ItemProperty -Path 'HKLM:\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.1\\Server' -name 'Enabled' -value '1' \u2013PropertyType 'DWORD'\n    New-ItemProperty -Path 'HKLM:\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.1\\Server' -name 'DisabledByDefault' -value '0' \u2013PropertyType 'DWORD'\n    New-ItemProperty -Path 'HKLM:\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.1\\Client' -name 'Enabled' -value '1' \u2013PropertyType 'DWORD'\n    New-ItemProperty -Path 'HKLM:\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.1\\Client' -name 'DisabledByDefault' -value '0' \u2013PropertyType 'DWORD'\n    Write-Host 'Enabling TLSv1.1'\n}\nenable-tls-1.1\n"})}),"\n",(0,r.jsx)(t.h4,{id:"disable-tls-11",children:"Disable TLS 1.1"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"function disable-tls-1.1\n{\n    New-Item 'HKLM:\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.1\\Server' -Force\n    New-Item 'HKLM:\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.1\\Client' -Force\n    New-ItemProperty -Path 'HKLM:\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.1\\Server' -name 'Enabled' -value '0' \u2013PropertyType 'DWORD'\n    New-ItemProperty -Path 'HKLM:\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.1\\Server' -name 'DisabledByDefault' -value '1' \u2013PropertyType 'DWORD'\n    New-ItemProperty -Path 'HKLM:\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.1\\Client' -name 'Enabled' -value '0' \u2013PropertyType 'DWORD'\n    New-ItemProperty -Path 'HKLM:\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.1\\Client' -name 'DisabledByDefault' -value '1' \u2013PropertyType 'DWORD'\n    Write-Host 'Disabling TLSv1.1'\n}\ndisable-tls-1.1\n"})})]})}function h(e={}){const{wrapper:t}={...(0,o.a)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},67070:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/wan_miniport_ikev2-508265e55ade0da0ddcb5a62869efeb3.png"},8311:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/wan_miniport_ports-e49748c1ad5e7590899a3cb0d1989eb4.png"},11151:(e,t,n)=>{n.d(t,{Z:()=>l,a:()=>i});var r=n(67294);const o={},s=r.createContext(o);function i(e){const t=r.useContext(s);return r.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function l(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:i(e.components),r.createElement(s.Provider,{value:t},e.children)}}}]);