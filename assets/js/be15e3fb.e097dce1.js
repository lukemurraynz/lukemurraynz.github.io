"use strict";(self.webpackChunklukemurraynz=self.webpackChunklukemurraynz||[]).push([[28430],{76728:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>u,contentTitle:()=>i,default:()=>d,frontMatter:()=>s,metadata:()=>a,toc:()=>c});var r=n(74848),o=n(28453);const s={title:"System Managed Identity in Storage Queue PowerShell Azure Functions",metaDescription:"Learn how to create and configure a storage queue trigger using PowerShell in Azure Functions to automate your workflows.",date:new Date("2024-09-02T03:14:00.526Z"),tags:["Azure"],categories:["Azure"],authors:["Luke"],slug:"azure/storage-queue-triggers-system-managed-identity-powershell",keywords:["azure","storage queue","azure functions","system managed identity","powershell"],description:"Learn how to create and configure a storage queue trigger using PowerShell in Azure Functions to automate your workflows."},i=void 0,a={permalink:"/azure/storage-queue-triggers-system-managed-identity-powershell",source:"@site/blog/2024-09-02-pwsh-azfunction-mi/index.mdx",title:"System Managed Identity in Storage Queue PowerShell Azure Functions",description:"Learn how to create and configure a storage queue trigger using PowerShell in Azure Functions to automate your workflows.",date:"2024-09-02T03:14:00.526Z",tags:[{label:"Azure",permalink:"/tags/azure"}],readingTime:3.205,hasTruncateMarker:!0,authors:[{name:"Luke Murray",title:"Author",url:"https://luke.geek.nz",imageURL:"https://luke.geek.nz/img/logo.png",key:"Luke"}],frontMatter:{title:"System Managed Identity in Storage Queue PowerShell Azure Functions",metaDescription:"Learn how to create and configure a storage queue trigger using PowerShell in Azure Functions to automate your workflows.",date:"2024-09-02T03:14:00.526Z",tags:["Azure"],categories:["Azure"],authors:["Luke"],slug:"azure/storage-queue-triggers-system-managed-identity-powershell",keywords:["azure","storage queue","azure functions","system managed identity","powershell"],description:"Learn how to create and configure a storage queue trigger using PowerShell in Azure Functions to automate your workflows."},unlisted:!1,nextItem:{title:"Azure Communication Services and PowerShell for Email",permalink:"/azure/using-communication-services-and-powershell-to-send-emails"}},u={authorsImageUrls:[void 0]},c=[];function l(e){const t={a:"a",admonition:"admonition",code:"code",em:"em",img:"img",li:"li",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.a,{href:"https://learn.microsoft.com/azure/azure-functions/functions-overview?pivots=programming-language-powershell&WT.mc_id=AZ-MVP-5004796",children:"Azure Functions"})," is a serverless compute service that enables you to run event-driven code without having to manage infrastructure. You can use Azure Functions to run small pieces of code in response to events, such as HTTP requests, messages in a queue, or changes in data in a storage account. In this article, I will show you how to use Azure Functions with a storage queue trigger using the System Managed Identity of the Function Application ",(0,r.jsx)(t.em,{children:"(instead of a Connection String)"}),"."]}),"\n","\n",(0,r.jsx)(t.p,{children:"When you create an Azure Function, you can use a storage queue trigger to execute the function when a message is added to a storage queue. This is useful when you want to process messages in a queue asynchronously. In this article, I will show you how to use an Azure Function with a storage queue by using the System Managed Identity of the Function Application to authenticate with the storage account."}),"\n",(0,r.jsxs)(t.admonition,{type:"info",children:[(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.a,{href:"https://learn.microsoft.com/azure/azure-functions/functions-bindings-storage-queue-trigger?tabs=python-v2%2Cisolated-process%2Cnodejs-v4%2Cextensionv5&pivots=programming-language-powershell&WT.mc_id=AZ-MVP-5004796",children:"Azure Queue storage trigger for Azure Functions"}),". The queue storage trigger runs a function as messages are added to Azure Queue storage."]}),(0,r.jsx)(t.p,{children:"The Azure Functions runtime supports triggers and bindings for Azure Queue storage. The Azure Queue storage trigger lets you respond to new messages in a queue. When a message is added to the queue, the runtime invokes your function."})]}),"\n",(0,r.jsx)(t.p,{children:"First thing you will need to do, is enable the System Managed Identity of the Azure Function."}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.img,{alt:"Enable System Managed Identity",src:n(24920).A+"",width:"1739",height:"867"})}),"\n",(0,r.jsx)(t.p,{children:"Once that has been completed, we can assign the required roles to the Storage account that contains the queue."}),"\n",(0,r.jsxs)(t.p,{children:["What level of permissions you need to assign to the Function App's System Managed Identity depends on what you want to do with the queue. In this example, I will be using the ",(0,r.jsx)(t.code,{children:"Storage Queue Data Contributor"})," role."]}),"\n",(0,r.jsxs)(t.table,{children:[(0,r.jsx)(t.thead,{children:(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.th,{children:"Binding type"}),(0,r.jsx)(t.th,{children:"Example built-in roles"})]})}),(0,r.jsxs)(t.tbody,{children:[(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:"Trigger"}),(0,r.jsxs)(t.td,{children:[(0,r.jsx)(t.a,{href:"https://learn.microsoft.com/azure/role-based-access-control/built-in-roles/storage?WT.mc_id=AZ-MVP-5004796#storage-queue-data-reader",children:"Storage Queue Data Reader"}),", ",(0,r.jsx)(t.a,{href:"https://learn.microsoft.com/azure/role-based-access-control/built-in-roles/storage?WT.mc_id=AZ-MVP-5004796#storage-queue-data-message-processor",children:"Storage Queue Data Message Processor"})]})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:"Output binding"}),(0,r.jsxs)(t.td,{children:[(0,r.jsx)(t.a,{href:"https://learn.microsoft.com/azure/role-based-access-control/built-in-roles/storage?WT.mc_id=AZ-MVP-5004796#storage-queue-data-contributor",children:"Storage Queue Data Contributor"}),", ",(0,r.jsx)(t.a,{href:"https://learn.microsoft.com/azure/role-based-access-control/built-in-roles/storage?WT.mc_id=AZ-MVP-5004796#storage-queue-data-message-sender",children:"Storage Queue Data Message Sender"})]})]})]})]}),"\n",(0,r.jsx)(t.p,{children:"Because we are going to assigning the permissions to a Storage account, we can do this directly through the Azure Portal at the Function App System Managed identity location."}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.img,{alt:"Assign Role to Storage Account",src:n(18100).A+"",width:"1753",height:"947"})}),"\n",(0,r.jsx)(t.p,{children:"Once permissions, have been granted, in our Azure Function App, we will need to create some Connection variables, which will be used by our Function App."}),"\n",(0,r.jsx)(t.p,{children:"In the Function App, under Settings, go to Environment variables."}),"\n",(0,r.jsxs)(t.p,{children:["We will need to determine a Connection name, which will be used by our Azure Function. In this example, I will be using ",(0,r.jsx)(t.code,{children:"StgQueueAccount"}),". This will be used as a prefix for additional variables, for example:"]}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.code,{children:"StgQueueAccount__queueServiceUri"})}),"\n"]}),"\n",(0,r.jsx)(t.admonition,{type:"info",children:(0,r.jsxs)(t.p,{children:["Note that the variable has x2 underscores ",(0,r.jsx)(t.code,{children:"__"})," between the Connection name and the variable name."]})}),"\n",(0,r.jsxs)(t.p,{children:["This variable will be used to store the ",(0,r.jsx)(t.a,{href:"https://learn.microsoft.com/azure/azure-functions/functions-bindings-storage-queue-trigger?tabs=python-v2%2Cin-process%2Cnodejs-v4%2Cextensionv5&pivots=programming-language-powershell&WT.mc_id=AZ-MVP-5004796#identity-based-connections",children:"URI of the Storage Account Queue"}),"."]}),"\n",(0,r.jsx)(t.p,{children:"For the valuiie of the StgQueueAccount__queueServiceUri, you can get this from the Azure Portal, by going to the Storage Account, and then to the Queue Service, to find the endpoint uri."}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.img,{alt:"Queue Service URI",src:n(84623).A+"",width:"1564",height:"525"})}),"\n",(0,r.jsx)(t.p,{children:"Once we have retrieved it, we can navigate back to the Environment variables and add in the Key Value pair."}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.img,{alt:"Environment Variables",src:n(91200).A+"",width:"1533",height:"779"})}),"\n",(0,r.jsx)(t.p,{children:"Make sure to click Apply, and Apply."}),"\n",(0,r.jsx)(t.p,{children:"Once completed, the default profile.ps1 file will run to authenticate using the Managed Identity of the Function App."}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-powershell",metastring:'title="profile.ps1"',children:"if ($env:MSI_SECRET) {\n    Disable-AzContextAutosave -Scope Process | Out-Null\n    Connect-AzAccount -Identity\n}\n"})}),"\n",(0,r.jsx)(t.p,{children:"Your actual function, will need to have the binding updated, with the name of the Connection prefix determined earlier, and include the queue name, for example:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-json",metastring:'title="function.json"',children:'{\n  "bindings": [\n    {\n      "name": "QueueItem",\n      "type": "queueTrigger",\n      "direction": "in",\n      "queueName": "rg-queue-create",\n      "connection": "StgQueueAccount"\n    }\n  ]\n}\n'})}),"\n",(0,r.jsx)(t.p,{children:"You should now be able to read the messages from the queue, and process them as required, using the System Managed Identity of the Azure Function account."})]})}function d(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(l,{...e})}):l(e)}},91200:(e,t,n)=>{n.d(t,{A:()=>r});const r=n.p+"assets/images/AzurePortal_AzureFunction_EnvironmentVariables_queueuri-318c6e94becefce1c858583cb30376b0.jpg"},84623:(e,t,n)=>{n.d(t,{A:()=>r});const r=n.p+"assets/images/AzurePortal_AzureFunction_StorageAccountQueueenebdpoint-6b33ebf7ccb56d12490c735b84f10fd0.jpg"},24920:(e,t,n)=>{n.d(t,{A:()=>r});const r=n.p+"assets/images/AzurePortal_AzureFunction_SystemManagedIdentity-6a63314cdd46f2733b0b0f8a69dc2cbc.jpg"},18100:(e,t,n)=>{n.d(t,{A:()=>r});const r=n.p+"assets/images/AzurePortal_AzureFunction_SystemManagedIdentityAssignRole-feb74c8f71f57ab22488ef90b8d5799b.gif"},28453:(e,t,n)=>{n.d(t,{R:()=>i,x:()=>a});var r=n(96540);const o={},s=r.createContext(o);function i(e){const t=r.useContext(s);return r.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:i(e.components),r.createElement(s.Provider,{value:t},e.children)}}}]);