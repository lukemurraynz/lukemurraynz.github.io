"use strict";(self.webpackChunklukemurraynz=self.webpackChunklukemurraynz||[]).push([[23272],{91505:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>a,contentTitle:()=>o,default:()=>h,frontMatter:()=>s,metadata:()=>l,toc:()=>c});var r=n(74848),i=n(28453);const s={date:"2022-05-12 00:00:00 +1200",title:"Deallocate 'Stopped' Virtual Machines using Azure Automation",authors:["Luke"],tags:["Azure"],toc:!0,header:{teaser:"images/iazure-marketplace-banner.png"}},o=void 0,l={permalink:"/2022/05/12/deallocate-stopped-virtual-machines-using-azure-automation",source:"@site/blog/2022-05-12-deallocate-stopped-virtual-machines-using-azure-automation.md",title:"Deallocate 'Stopped' Virtual Machines using Azure Automation",description:'Virtual Machines?") in Microsoft Azure have different states and, depending on what state the Virtual Machine is in, will determine whether you get billed or not (for the Compute, storage and network adapters are still billed)_.',date:"2022-05-12T00:00:00.000Z",tags:[{label:"Azure",permalink:"/tags/azure"}],readingTime:12.81,hasTruncateMarker:!1,authors:[{name:"Luke Murray",title:"Author",url:"https://luke.geek.nz",imageURL:"https://luke.geek.nz/img/logo.png",key:"Luke"}],frontMatter:{date:"2022-05-12 00:00:00 +1200",title:"Deallocate 'Stopped' Virtual Machines using Azure Automation",authors:["Luke"],tags:["Azure"],toc:!0,header:{teaser:"images/iazure-marketplace-banner.png"}},unlisted:!1,prevItem:{title:"How to contribute to Microsoft documentation",permalink:"/2022/05/27/how-to-contribute-to-microsoft-documentation"},nextItem:{title:"Hidden Tags in Azure",permalink:"/azure/hidden-tags-in-azure"}},a={authorsImageUrls:[void 0]},c=[{value:"Overview",id:"overview",level:3},{value:"Deploy Deallocate Solution",id:"deploy-deallocate-solution",level:3},{value:"Setup Azure Automation Account",id:"setup-azure-automation-account",level:4},{value:"Create Azure Automation Account",id:"create-azure-automation-account",level:5},{value:"Configure System Identity",id:"configure-system-identity",level:5},{value:"Import Modules",id:"import-modules",level:5},{value:"Import Runbook",id:"import-runbook",level:5},{value:"Setup Webhook",id:"setup-webhook",level:5},{value:"Setup Alert &amp; Action Group",id:"setup-alert--action-group",level:4},{value:"Test Deallocate Solution",id:"test-deallocate-solution",level:3}];function d(e){const t={a:"a",code:"code",em:"em",h3:"h3",h4:"h4",h5:"h5",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.a,{href:"https://azure.microsoft.com/en-us/overview/what-is-a-virtual-machine/?WT.mc_id=AZ-MVP-5004796#overview",title:" What is a virtual machine (VM)?",children:"Virtual Machines"})," in Microsoft Azure have different states and, depending on what state the Virtual Machine is in, will determine whether you get billed or not ",(0,r.jsx)(t.em,{children:"(for the Compute, storage and network adapters are still billed)"}),"."]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(t.table,{children:[(0,r.jsx)(t.thead,{children:(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.th,{children:"Power state"}),(0,r.jsx)(t.th,{children:"Description"}),(0,r.jsx)(t.th,{children:"Billing"})]})}),(0,r.jsxs)(t.tbody,{children:[(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:"Starting"}),(0,r.jsx)(t.td,{children:"Virtual Machine is powering up."}),(0,r.jsx)(t.td,{children:"Billed"})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:"Running"}),(0,r.jsx)(t.td,{children:"Virtual Machine is fully up. This is the standard working state."}),(0,r.jsx)(t.td,{children:"Billed"})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:"Stopping"}),(0,r.jsx)(t.td,{children:"This is a transitional state between running and stopped."}),(0,r.jsx)(t.td,{children:"Billed"})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:"Stopped"}),(0,r.jsx)(t.td,{children:"The Virtual Machine is allocated on a host but not running. Also called PoweredOff state or Stopped (Allocated). This can be result of invoking the PowerOff API operation or invoking shutdown from within the guest OS. The Stopped state may also be observed briefly during VM creation or while starting a VM from Deallocated state."}),(0,r.jsx)(t.td,{children:"Billed"})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:"Deallocating"}),(0,r.jsx)(t.td,{children:"This is the transitional state between running and deallocated."}),(0,r.jsx)(t.td,{children:"Not billed"})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:"Deallocated"}),(0,r.jsx)(t.td,{children:"The Virtual Machine has released the lease on the underlying hardware and is completely powered off. This state is also referred to as Stopped (Deallocated)."}),(0,r.jsx)(t.td,{children:"Not billed"})]})]})]}),"\n",(0,r.jsxs)(t.p,{children:["Suppose a Virtual Machine is not being used. In that case, turning off a Virtual Machine from the Microsoft Azure Portal ",(0,r.jsx)(t.em,{children:"(or programmatically via"})," ",(0,r.jsx)(t.a,{href:"https://learn.microsoft.com/en-us/powershell/azure/?WT.mc_id=AZ-MVP-5004796",title:"Azure PowerShell Documentation",children:(0,r.jsx)(t.em,{children:"PowerShell"})}),(0,r.jsx)(t.em,{children:"/"}),(0,r.jsx)(t.a,{href:"https://learn.microsoft.com/en-us/cli/azure/install-azure-cli?WT.mc_id=AZ-MVP-5004796",title:"How to install the Azure CLI",children:(0,r.jsx)(t.em,{children:"Azure CLI"})}),(0,r.jsx)(t.em,{children:")"})," is recommended to ensure that the Virtual Machine is deallocated and its affinity on the host has been released."]}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.img,{alt:"Microsoft Azure - Virtual Machine Power States",src:n(24125).A+"",title:"Microsoft Azure - Virtual Machine Power States",width:"1212",height:"416"})}),"\n",(0,r.jsxs)(t.p,{children:["However, you need to know this, and those new to Microsoft Azure, or users who don't have ",(0,r.jsx)(t.a,{href:"https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles?WT.mc_id=AZ-MVP-5004796",title:"Azure built-in roles",children:"Virtual Machine Administrator"})," rights to deallocate a Virtual Machine, may simply shut down the operating system, leaving the Virtual Machine in a 'Stopped' state, but still tied to an underlying Azure host and incurring cost."]}),"\n",(0,r.jsxs)(t.p,{children:["Our solution can help; by triggering an Alert when a Virtual Machine becomes unavailable due to a user-initiated shutdown, we can then start an ",(0,r.jsx)(t.a,{href:"https://learn.microsoft.com/en-us/azure/automation/overview?WT.mc_id=AZ-MVP-5004796",children:"Azure Automation"})," runbook to deallocate the Virtual Machine."]}),"\n",(0,r.jsx)(t.h3,{id:"overview",children:"Overview"}),"\n",(0,r.jsx)(t.p,{children:"Today, we are going to set up an Azure Automation runbook, triggered by a Resource Health alert that will go through the following steps:"}),"\n",(0,r.jsxs)(t.ol,{children:["\n",(0,r.jsx)(t.li,{children:"User shutdowns Virtual Machine from within the Operating System"}),"\n",(0,r.jsx)(t.li,{children:"The Virtual Machine enters an unavailable state"}),"\n",(0,r.jsx)(t.li,{children:"A Resource Alert is triggered when the Virtual Machine becomes unavailable (after being available) by a user initiated event"}),"\n",(0,r.jsx)(t.li,{children:"The Alert triggers a Webhook to an Azure Automation runbook"}),"\n",(0,r.jsx)(t.li,{children:"Using permissions assigned to the Azure Automation account through a System Managed Identity connects to Microsoft Azure and checks the VM state; if the Virtual Machine state is still 'Stopped', then deallocate the virtual machine."}),"\n",(0,r.jsx)(t.li,{children:"Then finally, resolve the triggered alert."}),"\n"]}),"\n",(0,r.jsx)(t.p,{children:"To do this, we need a few resources."}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:"Azure Automation Account"}),"\n",(0,r.jsx)(t.li,{children:"Az.AlertsManagement module in the Azure Automation account"}),"\n",(0,r.jsxs)(t.li,{children:["Az.Accounts module ",(0,r.jsx)(t.em,{children:"(updated in the Azure Automation account)"})]}),"\n",(0,r.jsxs)(t.li,{children:["Azure Automation runbook ",(0,r.jsx)(t.em,{children:"(I will supply this below)"})]}),"\n",(0,r.jsx)(t.li,{children:"Resource Health Alert"}),"\n",(0,r.jsxs)(t.li,{children:["Webhook ",(0,r.jsx)(t.em,{children:"(to trigger to the runbook and pass the JSON from the alert)"})]}),"\n"]}),"\n",(0,r.jsx)(t.p,{children:"And, of course, 'Contributor' rights to the Microsoft Azure subscription to provide the resources and the alerts and resources and set up the system managed identity."}),"\n",(0,r.jsx)(t.p,{children:"We will set up this from scratch using the Azure Portal and an already created PowerShell Azure Automation runbook."}),"\n",(0,r.jsx)(t.h3,{id:"deploy-deallocate-solution",children:"Deploy Deallocate Solution"}),"\n",(0,r.jsx)(t.h4,{id:"setup-azure-automation-account",children:"Setup Azure Automation Account"}),"\n",(0,r.jsx)(t.h5,{id:"create-azure-automation-account",children:"Create Azure Automation Account"}),"\n",(0,r.jsxs)(t.p,{children:["First, we need an ",(0,r.jsx)(t.a,{href:"https://learn.microsoft.com/en-us/azure/automation/automation-create-standalone-account?tabs=azureportal&WT.mc_id=AZ-MVP-5004796",title:"Create a standalone Azure Automation account",children:"Azure Automation"})," resource."]}),"\n",(0,r.jsxs)(t.ol,{children:["\n",(0,r.jsxs)(t.li,{children:["Log into the ",(0,r.jsx)(t.a,{href:"https://portal.azure.com/#home",title:"Microsoft Azure Portal",children:(0,r.jsx)(t.strong,{children:"Microsoft Azure Portal"})}),"."]}),"\n",(0,r.jsxs)(t.li,{children:["Click ",(0,r.jsx)(t.strong,{children:"+ Create a resource."})]}),"\n",(0,r.jsxs)(t.li,{children:["Type in ",(0,r.jsx)(t.strong,{children:"automation"})]}),"\n",(0,r.jsxs)(t.li,{children:["Select ",(0,r.jsx)(t.strong,{children:"Create"})," under Automation, and select ",(0,r.jsx)(t.strong,{children:"Automation."})]}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.img,{alt:"Create Azure Automation Account",src:n(83996).A+"",title:"Create Azure Automation Account",width:"426",height:"573"})}),"\n",(0,r.jsxs)(t.li,{children:["Select your ",(0,r.jsx)(t.strong,{children:"subscription"})]}),"\n",(0,r.jsxs)(t.li,{children:["Select your ",(0,r.jsx)(t.strong,{children:"Resource Group"})," or Create one if you don't already have one ",(0,r.jsx)(t.em,{children:"(I recommend placing your automation resources in an Azure Management or Automation resource group, this will also contain your Runbooks)"})]}),"\n",(0,r.jsxs)(t.li,{children:["Select your ",(0,r.jsx)(t.strong,{children:"region"})]}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.img,{alt:"Create Azure Automation Account",src:n(94004).A+"",title:"Create Azure Automation Account",width:"749",height:"479"})}),"\n",(0,r.jsxs)(t.li,{children:["Select ",(0,r.jsx)(t.strong,{children:"Next"})]}),"\n",(0,r.jsxs)(t.li,{children:["Make sure: ",(0,r.jsx)(t.strong,{children:"System assigned"})," is selected for Managed identities ",(0,r.jsx)(t.em,{children:"(this will be required for giving your automation account permissions to deallocate your Virtual Machine, but it can be enabled later if you already have an Azure Automation account)"}),"."]}),"\n",(0,r.jsxs)(t.li,{children:["Click ",(0,r.jsx)(t.strong,{children:"Next"})]}),"\n",(0,r.jsxs)(t.li,{children:["Leave Network connectivity as default (",(0,r.jsx)(t.strong,{children:"Public access"}),")"]}),"\n",(0,r.jsxs)(t.li,{children:["Click ",(0,r.jsx)(t.strong,{children:"Next"})]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"Enter"})," in appropriate ",(0,r.jsx)(t.strong,{children:"tags"})]}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.img,{alt:"Create Azure Automation Account",src:n(58438).A+"",title:"Create Azure Automation Account",width:"753",height:"524"})}),"\n",(0,r.jsxs)(t.li,{children:["Click ",(0,r.jsx)(t.strong,{children:"Review + Create"})]}),"\n",(0,r.jsxs)(t.li,{children:["After validation has passed, select ",(0,r.jsx)(t.strong,{children:"Create"})]}),"\n"]}),"\n",(0,r.jsx)(t.h5,{id:"configure-system-identity",children:"Configure System Identity"}),"\n",(0,r.jsx)(t.p,{children:"Now that we have our Azure Automation account, its time to set up the System Managed Identity and grant it the following roles:"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:["Virtual Machine Contributor ",(0,r.jsx)(t.em,{children:"(to deallocate the Virtual Machine)"})]}),"\n",(0,r.jsxs)(t.li,{children:["Monitoring Contributor ",(0,r.jsx)(t.em,{children:"(to close the Azure Alert)"})]}),"\n"]}),"\n",(0,r.jsx)(t.p,{children:"You can set up a custom role to be least privileged and use that instead. But in this article, we will stick to the built-in roles."}),"\n",(0,r.jsxs)(t.ol,{children:["\n",(0,r.jsxs)(t.li,{children:["Log into the ",(0,r.jsx)(t.a,{href:"https://portal.azure.com/#home",title:"Microsoft Azure Portal",children:(0,r.jsx)(t.strong,{children:"Microsoft Azure Portal"})}),"."]}),"\n",(0,r.jsxs)(t.li,{children:["Navigate to your Azure ",(0,r.jsx)(t.strong,{children:"Automation account"})]}),"\n",(0,r.jsxs)(t.li,{children:["Click on: ",(0,r.jsx)(t.strong,{children:"Identity"})]}),"\n",(0,r.jsxs)(t.li,{children:["Make sure that the ",(0,r.jsx)(t.strong,{children:"System assigned"})," toggle is: ",(0,r.jsx)(t.strong,{children:"On"})," and click ",(0,r.jsx)(t.strong,{children:"Azure role assignments."})]}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.img,{alt:"Azure Automation Account managed identity",src:n(6735).A+"",title:"Azure Automation Account managed identity",width:"773",height:"706"})}),"\n",(0,r.jsxs)(t.li,{children:["Click ",(0,r.jsx)(t.strong,{children:"+ Add role assignments"})]}),"\n",(0,r.jsxs)(t.li,{children:["Select the ",(0,r.jsx)(t.strong,{children:"Subscription"})," ",(0,r.jsx)(t.em,{children:"(make sure this subscription matches the same subscription your Virtual Machines are in)"})]}),"\n",(0,r.jsxs)(t.li,{children:["Select Role: ",(0,r.jsx)(t.strong,{children:"Virtual Machine Contributor"})]}),"\n",(0,r.jsxs)(t.li,{children:["Click ",(0,r.jsx)(t.strong,{children:"Save"})]}),"\n",(0,r.jsxs)(t.li,{children:["Now we repeat the same process for ",(0,r.jsx)(t.strong,{children:"Monitoring Contributor"})]}),"\n",(0,r.jsxs)(t.li,{children:["lick ",(0,r.jsx)(t.strong,{children:"+ Add role assignments"})]}),"\n",(0,r.jsxs)(t.li,{children:["Select the ",(0,r.jsx)(t.strong,{children:"Subscription"})," ",(0,r.jsx)(t.em,{children:"(make sure this subscription matches the same subscription your Virtual Machines are in)"})]}),"\n",(0,r.jsxs)(t.li,{children:["Select Role: ",(0,r.jsx)(t.strong,{children:"Monitoring Contributor"})]}),"\n",(0,r.jsxs)(t.li,{children:["Click ",(0,r.jsx)(t.strong,{children:"Save"})]}),"\n",(0,r.jsxs)(t.li,{children:["Click ",(0,r.jsx)(t.strong,{children:"Refresh"})," ",(0,r.jsx)(t.em,{children:"(it may take a few seconds to update the Portal, so if it is blank - give it 10 seconds and try again)"}),"."]}),"\n",(0,r.jsx)(t.li,{children:"You have now set up the System Managed identity and granted it the roles necessary to execute the automation."}),"\n"]}),"\n",(0,r.jsx)(t.h5,{id:"import-modules",children:"Import Modules"}),"\n",(0,r.jsxs)(t.p,{children:["We will use the Azure Runbook and use a few Azure PowerShell Modules; by default, Azure Automation has the base Azure PowerShell modules, but we will need to add ",(0,r.jsx)(t.a,{href:"https://learn.microsoft.com/en-us/powershell/module/az.alertsmanagement/?WT.mc_id=AZ-MVP-5004796",title:"Az.AlertsManagement",children:"Az.AlertsManagement"}),", and update the Az.Accounts as required as a pre-requisite for Az.AlertsManagement."]}),"\n",(0,r.jsxs)(t.ol,{children:["\n",(0,r.jsxs)(t.li,{children:["Log into the ",(0,r.jsx)(t.a,{href:"https://portal.azure.com/#home",title:"Microsoft Azure Portal",children:(0,r.jsx)(t.strong,{children:"Microsoft Azure Portal"})}),"."]}),"\n",(0,r.jsxs)(t.li,{children:["Navigate to your Azure ",(0,r.jsx)(t.strong,{children:"Automation account"})]}),"\n",(0,r.jsxs)(t.li,{children:["Click on ",(0,r.jsx)(t.strong,{children:"Modules"})]}),"\n",(0,r.jsxs)(t.li,{children:["Click on ",(0,r.jsx)(t.strong,{children:"+ Add a module"})]}),"\n",(0,r.jsxs)(t.li,{children:["Click on ",(0,r.jsx)(t.strong,{children:"Browse from Gallery"})]}),"\n",(0,r.jsxs)(t.li,{children:["Click: ",(0,r.jsx)(t.strong,{children:"Click here to browse from the gallery"})]}),"\n",(0,r.jsxs)(t.li,{children:["Type in: ",(0,r.jsx)(t.strong,{children:"Az.Accounts"})]}),"\n",(0,r.jsxs)(t.li,{children:["Press ",(0,r.jsx)(t.strong,{children:"Enter"})]}),"\n",(0,r.jsxs)(t.li,{children:["Click on ",(0,r.jsx)(t.strong,{children:"Az.Accounts"})]}),"\n",(0,r.jsxs)(t.li,{children:["Click ",(0,r.jsx)(t.strong,{children:"Select"})]}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.img,{alt:"Import Az.Accounts module",src:n(45830).A+"",title:"Import Az.Accounts module",width:"738",height:"417"})}),"\n",(0,r.jsxs)(t.li,{children:["Make sure that the Runtime version is: ",(0,r.jsx)(t.strong,{children:"5.1"})]}),"\n",(0,r.jsxs)(t.li,{children:["Click ",(0,r.jsx)(t.strong,{children:"Import"})]}),"\n",(0,r.jsx)(t.li,{children:"Now that the Az.Accounts have been updated, and it's time to import Az.AlertsManagement!"}),"\n",(0,r.jsxs)(t.li,{children:["Click on ",(0,r.jsx)(t.strong,{children:"Modules"})]}),"\n",(0,r.jsxs)(t.li,{children:["Click on ",(0,r.jsx)(t.strong,{children:"+ Add a module"})]}),"\n",(0,r.jsxs)(t.li,{children:["Click on ",(0,r.jsx)(t.strong,{children:"Browse from Gallery"})]}),"\n",(0,r.jsxs)(t.li,{children:["Click: ",(0,r.jsx)(t.strong,{children:"Click here to browse from the gallery"})]}),"\n",(0,r.jsxs)(t.li,{children:["Type in: ",(0,r.jsx)(t.strong,{children:"Az.AlertsManagement"})," ",(0,r.jsxs)(t.em,{children:["(note its Alert",(0,r.jsx)(t.strong,{children:"s)"})]})]}),"\n",(0,r.jsxs)(t.li,{children:["Click ",(0,r.jsx)(t.strong,{children:"Az.AlertsManagement"})]}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.img,{alt:"Az.AlertsManagement module",src:n(53582).A+"",title:"Az.AlertsManagement module",width:"1319",height:"1019"})}),"\n",(0,r.jsxs)(t.li,{children:["Click ",(0,r.jsx)(t.strong,{children:"Select"})]}),"\n",(0,r.jsxs)(t.li,{children:["Make sure that the Runtime version is: ",(0,r.jsx)(t.strong,{children:"5.1"})]}),"\n",(0,r.jsxs)(t.li,{children:["Click ",(0,r.jsx)(t.strong,{children:"Import"})," ",(0,r.jsx)(t.em,{children:"(if you get an error, make sure that Az.Accounts has been updated, through the Gallery import as above)"})]}),"\n",(0,r.jsx)(t.li,{children:"Now you have successfully added the dependent modules!"}),"\n"]}),"\n",(0,r.jsx)(t.h5,{id:"import-runbook",children:"Import Runbook"}),"\n",(0,r.jsx)(t.p,{children:"Now that the modules have been imported into your Azure Automation account, it is time to import the Azure Automation runbook."}),"\n",(0,r.jsxs)(t.ol,{children:["\n",(0,r.jsxs)(t.li,{children:["Log into the ",(0,r.jsx)(t.a,{href:"https://portal.azure.com/#home",title:"Microsoft Azure Portal",children:(0,r.jsx)(t.strong,{children:"Microsoft Azure Portal"})}),"."]}),"\n",(0,r.jsxs)(t.li,{children:["Navigate to your Azure ",(0,r.jsx)(t.strong,{children:"Automation account"})]}),"\n",(0,r.jsxs)(t.li,{children:["Click on ",(0,r.jsx)(t.strong,{children:"Runbooks"})]}),"\n",(0,r.jsxs)(t.li,{children:["Click ",(0,r.jsx)(t.strong,{children:"+ Create a runbook"})]}),"\n",(0,r.jsxs)(t.li,{children:["Specify a ",(0,r.jsx)(t.strong,{children:"name"})," ",(0,r.jsx)(t.em,{children:"(i.e. Deallocate-AzureVirtualMachine)"})]}),"\n",(0,r.jsxs)(t.li,{children:["Select Runbook type of: ",(0,r.jsx)(t.strong,{children:"PowerShell"})]}),"\n",(0,r.jsxs)(t.li,{children:["Select Runtime version of: ",(0,r.jsx)(t.strong,{children:"5.1"})]}),"\n",(0,r.jsxs)(t.li,{children:["Type in a ",(0,r.jsx)(t.strong,{children:"Description"})," that explains the runbook ",(0,r.jsx)(t.em,{children:"(this isn't mandatory, but like Tags is recommended, this is an opportunity to indicate to others what it is for and who set it up)"})]}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.img,{alt:"Create Azure Runbook",src:n(19103).A+"",title:"Create Azure Runbook",width:"735",height:"467"})}),"\n",(0,r.jsxs)(t.li,{children:["Click ",(0,r.jsx)(t.strong,{children:"Create"})]}),"\n",(0,r.jsx)(t.li,{children:"Now you will be greeted with a blank edit pane; paste in the Runbook from below:"}),"\n"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-powershell",metastring:'title="Deallocate-AzureVirtualMachine.ps1"',children:"#requires -Version 3.0 -Modules Az.Accounts, Az.AlertsManagement\n<#\n    .SYNOPSIS\n    PowerShell Azure Automation Runbook for Stopping Virtual Machines, that have been Shutdown within the Windows Operating System (Stopped and not Deallocated). \n    .AUTHOR\n    Luke Murray (https://github.com/lukemurraynz/)\n#>\n\n[OutputType('PSAzureOperationResponse')]\nparam ( \n    [Parameter(Mandatory = $true, HelpMessage = 'Data from the WebHook/Azure Alert')][Object]$WebhookData\n)\n\nImport-Module Az.AlertsManagement\n$ErrorActionPreference = 'stop'\n\n# Get the data object from WebhookData\n$WebhookData = $WebhookData.RequestBody\nWrite-Output -InputObject $WebhookData \n$Schema = $WebhookData | ConvertFrom-Json\n\n#Sets the Webhook data into object\n$Essentials = [object] ($Schema.data).essentials\nWrite-Output -InputObject $Essentials \n\n# Get the first target only as this script doesn't handle multiple and and export variables for the resource.\n$alertIdArray = (($Essentials.alertId)).Split('/')\n$alertTargetIdArray = (($Essentials.alertTargetIds)[0]).Split('/')\n$alertid =  ($alertIdArray)[6]\n$SubId = ($alertTargetIdArray)[2]\n$ResourceGroupName = ($alertTargetIdArray)[4]\n$ResourceType = ($alertTargetIdArray)[6] + '/' + ($alertTargetIdArray)[7]\n$ResourceName = ($alertTargetIdArray)[-1]\n$status = $Essentials.monitorCondition\nWrite-Output -InputObject $alertTargetIdArray\nWrite-Output  -InputObject \"status: $status\" -Verbose\n\n#Sets VM shutdown\nif (($status -eq 'Activated') -or ($status -eq 'Fired')) {\n    $status = $Essentials.monitorCondition\n    Write-Output -InputObject \"resourceType: $ResourceType\" -Verbose\n    Write-Output  -InputObject \"resourceName: $ResourceName\" -Verbose\n    Write-Output  -InputObject \"resourceGroupName: $ResourceGroupName\" -Verbose\n    Write-Output  -InputObject \"subscriptionId: $SubId\" -Verbose\n\n    # Determine code path depending on the resourceType\n    if ($ResourceType -eq 'Microsoft.Compute/virtualMachines') {\n        # This is an Resource Manager VM\n        Write-Output  -InputObject 'This is an Resource Manager VM.' -Verbose\n\n        # Ensures you do not inherit an AzContext in your runbook\n        Disable-AzContextAutosave -Scope Process\n\n        # Connect to Azure with system-assigned managed identity\n        $AzureContext = (Connect-AzAccount -Identity).context\n\n        # set and store context\n        $AzureContext = Set-AzContext -SubscriptionName $AzureContext.Subscription -DefaultProfile $AzureContext\n        Write-Output   -InputObject $AzureContext \n        #Checks Azure VM status\n        $VMStatus = Get-AzVM -ResourceGroupName $ResourceGroupName -Name $ResourceName -Status\n\n        Write-Output  -InputObject $VMStatus\n        If ($VMStatus.Statuses[1].Code -eq 'PowerState/stopped') {\n            Write-Output  -InputObject \"Stopping the VM, it was Shutdown without being Deallocated - $ResourceName - in resource group - $ResourceGroupName\" -Verbose\n            Stop-AzVM -Name $ResourceName -ResourceGroupName $ResourceGroupName -DefaultProfile $AzureContext -Force -Verbose\n      \n            #Check VM Status after deallocation\n            $VMStatus = Get-AzVM -ResourceGroupName $ResourceGroupName -Name $ResourceName -Status -Verbose\n            \n            Write-Output  -InputObject $VMStatus\n\n            If ($VMStatus.Statuses[1].Code -eq 'PowerState/deallocated') {\n                #Closes Alert\n                Write-Output  -InputObject $VMStatus.Statuses[1].Code\n                Write-Output  -InputObject $alertid \n                Get-AzAlert -AlertId $alertid  -verbose -DefaultProfile $AzureContext\n                Get-AzAlert -AlertId $alertid  -verbose -DefaultProfile $AzureContext | Update-AzAlertState -State 'Closed' -Verbose -DefaultProfile $AzureContext\n            }\n        }\n             \n        Elseif ($VMStatus.Statuses[1].Code -eq 'PowerState/deallocated') {\n            Write-Output  -InputObject 'Already deallocated' -Verbose\n        }\n\n        Elseif ($VMStatus.Statuses[1].Code -eq 'PowerState/running') {\n            Write-Output  -InputObject 'VM running. No further actions' -Verbose\n        }\n\n        # [OutputType(PSAzureOperationResponse\")]\n    }\n}\nelse {\n    # The alert status was not 'Activated' or 'Fired' so no action taken\n    Write-Output  -InputObject ('No action taken. Alert status: ' + $status) -Verbose\n}\n"})}),"\n",(0,r.jsxs)(t.ol,{start:"13",children:["\n",(0,r.jsxs)(t.li,{children:["Click ",(0,r.jsx)(t.strong,{children:"Save"})]}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.img,{alt:"Azure Automation runbook",src:n(46608).A+"",title:"Azure Automation runbook",width:"1160",height:"993"})}),"\n",(0,r.jsxs)(t.li,{children:["Click ",(0,r.jsx)(t.strong,{children:"Publish"})," ",(0,r.jsx)(t.em,{children:"(so the runbook is actually in production and can be used)"})]}),"\n",(0,r.jsx)(t.li,{children:"You can select View or Edit at any stage, but you have now imported the Azure Automation runbook!"}),"\n"]}),"\n",(0,r.jsx)(t.h5,{id:"setup-webhook",children:"Setup Webhook"}),"\n",(0,r.jsx)(t.p,{children:"Now that the Azure runbook has been imported, we need to set up a Webhook for the Alert to trigger and start the runbook."}),"\n",(0,r.jsxs)(t.ol,{children:["\n",(0,r.jsxs)(t.li,{children:["Log into the ",(0,r.jsx)(t.a,{href:"https://portal.azure.com/#home",title:"Microsoft Azure Portal",children:(0,r.jsx)(t.strong,{children:"Microsoft Azure Portal"})}),"."]}),"\n",(0,r.jsxs)(t.li,{children:["Navigate to your Azure ",(0,r.jsx)(t.strong,{children:"Automation account"})]}),"\n",(0,r.jsxs)(t.li,{children:["Click on ",(0,r.jsx)(t.strong,{children:"Runbooks"})]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"Click"})," on the ",(0,r.jsx)(t.strong,{children:"runbook"})," you just imported ",(0,r.jsx)(t.em,{children:"(i.e. Deallocate-AzureVirtualMachine)"})]}),"\n",(0,r.jsxs)(t.li,{children:["Click on ",(0,r.jsx)(t.strong,{children:"Add webhook"})]}),"\n",(0,r.jsxs)(t.li,{children:["Click ",(0,r.jsx)(t.strong,{children:"Create a new webhook"})]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"Enter"})," a ",(0,r.jsx)(t.strong,{children:"name"})," for the webhook"]}),"\n",(0,r.jsxs)(t.li,{children:["Make sure it is ",(0,r.jsx)(t.strong,{children:"Enabled"})]}),"\n",(0,r.jsxs)(t.li,{children:["You can edit the expiry date to match your security requirements; make sure you ",(0,r.jsx)(t.strong,{children:"record"})," the expiry date, as it will need to be renewed before it expires."]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"Copy"})," the ",(0,r.jsx)(t.strong,{children:"URL"})," and paste it somewhere safe ",(0,r.jsx)(t.em,{children:"(you won't see this again! and you need it for the next steps)"})]}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.img,{alt:"Create Azure webhook",src:n(36242).A+"",title:"Create Azure webhook",width:"345",height:"503"})}),"\n",(0,r.jsxs)(t.li,{children:["Click ",(0,r.jsx)(t.strong,{children:"Ok"})]}),"\n",(0,r.jsxs)(t.li,{children:["Click on ",(0,r.jsx)(t.strong,{children:"Configure parameters and run settings."})]}),"\n",(0,r.jsxs)(t.li,{children:["Because we will be taking in dynamic data from an Azure Alert, enter in: ",(0,r.jsx)(t.strong,{children:"[EmptyString]"})]}),"\n",(0,r.jsxs)(t.li,{children:["Click ",(0,r.jsx)(t.strong,{children:"Ok"})]}),"\n",(0,r.jsxs)(t.li,{children:["Click ",(0,r.jsx)(t.strong,{children:"Create"})]}),"\n",(0,r.jsxs)(t.li,{children:["You have now set up the webhook ",(0,r.jsx)(t.em,{children:"(make sure you have saved the URL from the earlier step as you will need it in the following steps)!"})]}),"\n"]}),"\n",(0,r.jsx)(t.h4,{id:"setup-alert--action-group",children:"Setup Alert & Action Group"}),"\n",(0,r.jsx)(t.p,{children:"Now that the Automation framework has been created with the Azure Automation account, runbook and webhook, we now need a way to detect if a Virtual Machine has been Stopped; this is where a Resource Health alert will come in."}),"\n",(0,r.jsxs)(t.ol,{children:["\n",(0,r.jsxs)(t.li,{children:["Log into the ",(0,r.jsx)(t.a,{href:"https://portal.azure.com/#home",title:"Microsoft Azure Portal",children:(0,r.jsx)(t.strong,{children:"Microsoft Azure Portal"})}),"."]}),"\n",(0,r.jsxs)(t.li,{children:["Navigate to: ",(0,r.jsx)(t.a,{href:"https://portal.azure.com/#blade/Microsoft_Azure_Monitoring/AzureMonitoringBrowseBlade/overview",children:(0,r.jsx)(t.strong,{children:"Monitor"})})]}),"\n",(0,r.jsxs)(t.li,{children:["Click on ",(0,r.jsx)(t.strong,{children:"Service Health"})]}),"\n",(0,r.jsxs)(t.li,{children:["Select ",(0,r.jsx)(t.strong,{children:"Resource Health"})]}),"\n",(0,r.jsxs)(t.li,{children:["Select ",(0,r.jsx)(t.strong,{children:"+ Add resource health alert"})]}),"\n",(0,r.jsxs)(t.li,{children:["Select your ",(0,r.jsx)(t.strong,{children:"subscription"})]}),"\n",(0,r.jsxs)(t.li,{children:["Select ",(0,r.jsx)(t.strong,{children:"Virtual machine"})," for Resource Type"]}),"\n",(0,r.jsxs)(t.li,{children:["You can target specific Resource Groups for your alert ",(0,r.jsx)(t.em,{children:"(and, as such, your automation)"})," or ",(0,r.jsx)(t.strong,{children:"select all."})]}),"\n",(0,r.jsxs)(t.li,{children:["Check ",(0,r.jsx)(t.strong,{children:"Include all future resource groups"})]}),"\n",(0,r.jsxs)(t.li,{children:["Check ",(0,r.jsx)(t.strong,{children:"include all future resources"})]}),"\n",(0,r.jsxs)(t.li,{children:["Under the Alert conditions, make sure ",(0,r.jsx)(t.strong,{children:"Event Status"})," is: ",(0,r.jsx)(t.strong,{children:"All selected"})]}),"\n",(0,r.jsxs)(t.li,{children:["Set Current resource status to ",(0,r.jsx)(t.strong,{children:"Unavailable"})]}),"\n",(0,r.jsxs)(t.li,{children:["Set Previous resource status to ",(0,r.jsx)(t.strong,{children:"All selected"})]}),"\n",(0,r.jsxs)(t.li,{children:["For reason type, select: ",(0,r.jsx)(t.strong,{children:"User initiated"})," and ",(0,r.jsx)(t.strong,{children:"unknown"})]}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.img,{alt:"Create Azure Resource Health Alert",src:n(44145).A+"",title:"Create Azure Resource Health Alert",width:"877",height:"956"})}),"\n",(0,r.jsx)(t.li,{children:"Now that we have the Alert rule configured, we need to set up an Action group. That will get triggered when the alert gets fired."}),"\n",(0,r.jsxs)(t.li,{children:["Click ",(0,r.jsx)(t.strong,{children:"Select Action groups."})]}),"\n",(0,r.jsxs)(t.li,{children:["Click ",(0,r.jsx)(t.strong,{children:"+ Create action group"})]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"Select"})," your subscription and ",(0,r.jsx)(t.strong,{children:"resource group"})," ",(0,r.jsx)(t.em,{children:"(this is where the Action alert will go, I recommend your Azure Management/Monitoring resource group that may have a Log Analytics workspace as an example)"}),"."]}),"\n",(0,r.jsxs)(t.li,{children:["Give your Action Group a ",(0,r.jsx)(t.strong,{children:"name"}),", i.e. AzureAutomateActionGroup"]}),"\n",(0,r.jsx)(t.li,{children:"The display name will be automatically generated, but feel free to adjust it to suit your naming convention"}),"\n",(0,r.jsxs)(t.li,{children:["Click ",(0,r.jsx)(t.strong,{children:"Next: Notifications"})]}),"\n",(0,r.jsxs)(t.li,{children:["Under ",(0,r.jsx)(t.strong,{children:"Notifications"}),", you can trigger an ",(0,r.jsx)(t.strong,{children:"email alert"}),", which can be handy in determining how often the runbook runs. This can be modified and removed if it is running, especially during testing."]}),"\n",(0,r.jsxs)(t.li,{children:["Click ",(0,r.jsx)(t.strong,{children:"Next: Actions"})]}),"\n",(0,r.jsxs)(t.li,{children:["Under Action Type, select ",(0,r.jsx)(t.strong,{children:"Webhook"})]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"Paste"})," in the ",(0,r.jsx)(t.strong,{children:"URI"})," created earlier when setting up the Webhook"]}),"\n",(0,r.jsxs)(t.li,{children:["Select ",(0,r.jsx)(t.strong,{children:"Yes"})," to enable the ",(0,r.jsx)(t.strong,{children:"common alert schema"})," (",(0,r.jsx)(t.em,{children:"this is required as the JSON that the runbook is parsing is expecting it to the in the schema, if it isn't the runbook will fail)"})]}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.img,{alt:"Create Azure Action Group",src:n(73567).A+"",title:"Create Azure Action Group",width:"1552",height:"425"})}),"\n",(0,r.jsxs)(t.li,{children:["Click ",(0,r.jsx)(t.strong,{children:"Ok"})]}),"\n",(0,r.jsxs)(t.li,{children:["Give the ",(0,r.jsx)(t.strong,{children:"webhook"})," a ",(0,r.jsx)(t.strong,{children:"name"}),"."]}),"\n",(0,r.jsxs)(t.li,{children:["Click ",(0,r.jsx)(t.strong,{children:"Review + create"})]}),"\n",(0,r.jsxs)(t.li,{children:["Click ",(0,r.jsx)(t.strong,{children:"Create"})]}),"\n",(0,r.jsxs)(t.li,{children:["Finally, enter in an Alert ",(0,r.jsx)(t.strong,{children:"name"})," and ",(0,r.jsx)(t.strong,{children:"description"}),", specify the resource group for the Alert to go into and click ",(0,r.jsx)(t.strong,{children:"Save."})]}),"\n"]}),"\n",(0,r.jsx)(t.h3,{id:"test-deallocate-solution",children:"Test Deallocate Solution"}),"\n",(0,r.jsx)(t.p,{children:"So now we have stood up our:"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:"Azure automation account"}),"\n",(0,r.jsx)(t.li,{children:"Alert"}),"\n",(0,r.jsx)(t.li,{children:"Action Group"}),"\n",(0,r.jsx)(t.li,{children:"Azure automation runbook"}),"\n",(0,r.jsx)(t.li,{children:"Webhook"}),"\n"]}),"\n",(0,r.jsxs)(t.p,{children:["It is time to test! I have a VM called: VM-D01, running Windows ",(0,r.jsx)(t.em,{children:"(theoretically, this runbook will also run against Linux workloads, as its relying on the Azure agent to send the correct status to the Azure Logs, but in my testing, it was against Windows workloads)"})," in the same subscription that the alert has been deployed against."]}),"\n",(0,r.jsxs)(t.p,{children:["As you can see below, I shut down the Virtual Machine. After a few minutes ",(0,r.jsx)(t.em,{children:"(be patient, Azure needs to wait for the status of the VM to be triggered)"}),", an Azure Alert was fired into Azure Monitor, which triggered the webhook and runbook, and the Virtual Machine was deallocated, and the Azure Alert was closed."]}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.img,{alt:"Azure deallocate testing",src:n(19634).A+"",title:"Azure deallocate testing",width:"1449",height:"647"})})]})}function h(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},73567:(e,t,n)=>{n.d(t,{A:()=>r});const r=n.p+"assets/images/azureportal-actiongroup-webhook-0c15f37f442496a15c8840646f976dab.jpg"},44145:(e,t,n)=>{n.d(t,{A:()=>r});const r=n.p+"assets/images/azureportal-alert-create-525afa13de376a81109f6c9693561cd1.jpg"},6735:(e,t,n)=>{n.d(t,{A:()=>r});const r=n.p+"assets/images/azureportal-automation_managedidentity-46173e0eb415b07c841cfd616266eb7c.jpg"},45830:(e,t,n)=>{n.d(t,{A:()=>r});const r=n.p+"assets/images/azureportal-automation_modules_az-accounts-6b84545ff7cf24ce120cd93e0c255a97.jpg"},53582:(e,t,n)=>{n.d(t,{A:()=>r});const r=n.p+"assets/images/azureportal-automation_modules_az-alertsmanagement-3e56fcc89310e58f9e631b4e713107b3.jpg"},83996:(e,t,n)=>{n.d(t,{A:()=>r});const r=n.p+"assets/images/azureportal-create-automation-f17fe5866b2554fab2016911fdae4250.jpg"},94004:(e,t,n)=>{n.d(t,{A:()=>r});const r=n.p+"assets/images/azureportal-create-automation_basics-1389cb6873b6fc1b5c884f01279f38c4.jpg"},58438:(e,t,n)=>{n.d(t,{A:()=>r});const r=n.p+"assets/images/azureportal-create-automation_tags-cf8d12ea6a602ac7d4d3019f34458da0.jpg"},19103:(e,t,n)=>{n.d(t,{A:()=>r});const r=n.p+"assets/images/azureportal-runbook-create-3d404335d690517ee5dd2ccad6d62a58.jpg"},46608:(e,t,n)=>{n.d(t,{A:()=>r});const r=n.p+"assets/images/azureportal-runbook-import-9ad03aed284d9f134d6f103fbbaf3703.jpg"},36242:(e,t,n)=>{n.d(t,{A:()=>r});const r=n.p+"assets/images/azureportal-webhook-create-6623ef89825a6c0a1f726b79b468ef97.jpg"},24125:(e,t,n)=>{n.d(t,{A:()=>r});const r=n.p+"assets/images/azvm-power-states-c67f8a6c163301a9851ce1e794a9cb8a.png"},19634:(e,t,n)=>{n.d(t,{A:()=>r});const r=n.p+"assets/images/deallocatevm-d03b67f813b3eeb276033ac07d8636a5.gif"},28453:(e,t,n)=>{n.d(t,{R:()=>o,x:()=>l});var r=n(96540);const i={},s=r.createContext(i);function o(e){const t=r.useContext(s);return r.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function l(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),r.createElement(s.Provider,{value:t},e.children)}}}]);