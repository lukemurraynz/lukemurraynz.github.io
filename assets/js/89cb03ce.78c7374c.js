"use strict";(self.webpackChunklukemurraynz=self.webpackChunklukemurraynz||[]).push([[79514],{35966:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>d,contentTitle:()=>a,default:()=>h,frontMatter:()=>r,metadata:()=>o,toc:()=>c});var i=n(74848),s=n(28453);const r={title:"Federated Credentials to AKS Managed Identity",metaDescription:"Learn how to add federated credentials to a user-assigned managed identity in Azure Kubernetes Service (AKS) to access protected resources.",Description:"Explore configuring federated credentials for a user-assigned managed identity in AKS, enabling secure access to Microsoft Entra-protected resources such as Azure Key Vault and Microsoft Graph.",date:new Date("2024-05-05T08:39:07.238Z"),tags:["Azure"],categories:["Azure"],authors:["Luke"],header:"aks-workload-identity-model.png",slug:"azure/federated-credentials-aks",keywords:["azure","portal","Adding Federated Credentials to AKS Managed Identity","AKS","Azure Kubernetes Service","federated credentials","user-assigned managed identity","Microsoft Entra","Azure Key Vault","Microsoft Graph"]},a=void 0,o={permalink:"/azure/federated-credentials-aks",source:"@site/blog/2024-05-05-aks-federatedidentity/index.mdx",title:"Federated Credentials to AKS Managed Identity",description:"Workloads deployed on an Azure Kubernetes Services (AKS) cluster require Microsoft Entra application credentials or managed identities to access Microsoft Entra-protected resources, such as Azure Key Vault and Microsoft Graph. Microsoft Entra Workload ID integrates with the capabilities native to Kubernetes to federate with external identity providers.",date:"2024-05-05T08:39:07.238Z",tags:[{inline:!0,label:"Azure",permalink:"/tags/azure"}],readingTime:5.295,hasTruncateMarker:!0,authors:[{name:"Luke Murray",title:"Author",url:"https://luke.geek.nz",imageURL:"https://luke.geek.nz/img/logo.png",key:"Luke",page:null}],frontMatter:{title:"Federated Credentials to AKS Managed Identity",metaDescription:"Learn how to add federated credentials to a user-assigned managed identity in Azure Kubernetes Service (AKS) to access protected resources.",Description:"Explore configuring federated credentials for a user-assigned managed identity in AKS, enabling secure access to Microsoft Entra-protected resources such as Azure Key Vault and Microsoft Graph.",date:"2024-05-05T08:39:07.238Z",tags:["Azure"],categories:["Azure"],authors:["Luke"],header:"aks-workload-identity-model.png",slug:"azure/federated-credentials-aks",keywords:["azure","portal","Adding Federated Credentials to AKS Managed Identity","AKS","Azure Kubernetes Service","federated credentials","user-assigned managed identity","Microsoft Entra","Azure Key Vault","Microsoft Graph"]},unlisted:!1,prevItem:{title:"Authorization Permission Mismatch error with Azure Storage",permalink:"/azure/authorization-permission-mismatch-error-azure-storage"},nextItem:{title:"Uncollapsing the Azure Portal Blade Menu",permalink:"/azure/uncollapsing-azure-portal-blade-menu"}},d={authorsImageUrls:[void 0]},c=[];function l(e){const t={a:"a",admonition:"admonition",code:"code",em:"em",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.p,{children:"Workloads deployed on an Azure Kubernetes Services (AKS) cluster require Microsoft Entra application credentials or managed identities to access Microsoft Entra-protected resources, such as Azure Key Vault and Microsoft Graph. Microsoft Entra Workload ID integrates with the capabilities native to Kubernetes to federate with external identity providers."}),"\n",(0,i.jsx)(t.p,{children:"Let's look at how that might be set up for Managed Identity for AKS (Azure Kubernetes Service) in Azure."}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"AKS Workload Identity",src:n(34187).A+"",width:"1070",height:"614"})}),"\n",(0,i.jsxs)(t.admonition,{type:"tip",children:[(0,i.jsx)(t.p,{children:"There is a lot of detail around identity, federated identity, and workload identity that I won't be going into today."}),(0,i.jsx)(t.p,{children:"If this is something you want to dig into, I recommend the following:"}),(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.a,{href:"https://learn.microsoft.com/en-us/azure/aks/workload-identity-overview?tabs=dotnet&WT.mc_id=AZ-MVP-5004796",children:"Use Microsoft Entra Workload ID with Azure Kubernetes Service (AKS)"})}),"\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.a,{href:"https://learn.microsoft.com/azure/aks/use-oidc-issuer?WT.mc_id=AZ-MVP-5004796",children:"Create an OpenID Connect provider on Azure Kubernetes Service (AKS)"})}),"\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.a,{href:"https://www.youtube.com/watch?v=i2GobU0Wg48",children:"AKS Workload Identity - Quick Tutorial"})}),"\n"]})]}),"\n",(0,i.jsx)(t.p,{children:"So, let us look at adding a Federated Credential to a User Assigned Managed identity."}),"\n",(0,i.jsxs)(t.p,{children:["Click on ",(0,i.jsx)(t.strong,{children:"Settings"})," and ",(0,i.jsx)(t.strong,{children:"Federated credentials"})]}),"\n",(0,i.jsx)(t.p,{children:"We will look at one I set up earlier. How this is used is application-specific, but in this example, the Federated credentials are used by an AI Service running on an AKS cluster to talk to an Azure OpenAI instance that the User Assigned Managed identity has access to."}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"Federated Credentials",src:n(21959).A+"",width:"1861",height:"981"})}),"\n",(0,i.jsx)(t.admonition,{type:"warning",children:(0,i.jsxs)(t.p,{children:["It is worth knowing that to use Federated Credentials and open the OIC APIs on your cluster, you will need to either create a new cluster or update it. The OIC APIs are not open by default on the cluster. See ",(0,i.jsx)(t.a,{href:"https://learn.microsoft.com/en-us/azure/aks/use-oidc-issuer?WT.mc_id=AZ-MVP-5004796",children:"Create an OpenID Connect provider on Azure Kubernetes Service (AKS)"})," for more information."]})}),"\n",(0,i.jsx)(t.p,{children:"First up is:"}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.strong,{children:"Cluster Issue URL"}),", in my example, I have:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-plaintext",children:"https://australiaeast.oic.prod-aks.azure.com/00000000-0000-0000-0000-000000000000/00000000-0000-0000-0000-000000000000/\n"})}),"\n",(0,i.jsx)(t.p,{children:"So what is this? This is the URL of the OpenID Connect provider with which the AKS cluster is federating. It is also the URL that the AKS cluster will use to authenticate the User Assigned Managed identity."}),"\n",(0,i.jsx)(t.p,{children:"To get the URL, you can use the Azure CLI and run the following query:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-bash",children:'az aks show -n myAKScluster -g myResourceGroup --query "oidcIssuerProfile.issuerUrl" -otsv\n'})}),"\n",(0,i.jsx)(t.p,{children:"To test that it is responding and open, you can navigate to the URL discovery endpoint '/openid/v1/jwks', for example:"}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.a,{href:"https://australiaeast.oic.prod-aks.azure.com/00000000-0000-0000-0000-000000000000/00000000-0000-0000-0000-000000000000/openid/v1/jwks",children:"https://australiaeast.oic.prod-aks.azure.com/00000000-0000-0000-0000-000000000000/00000000-0000-0000-0000-000000000000/openid/v1/jwks"})}),"\n",(0,i.jsx)(t.p,{children:"You will get an HTTP response back similar to the following:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-plaintext",children:'{\n"keys": [\n  {\n    "use": "sig",\n    "kty": "RSA",\n    "kid": "4gZVAbix5cXrHnMF9D6rp-EOpB92gfamRWVG873e9s5",\n    "alg": "RS256",\n    "n": "wCZChNTi7ymXkmLeMP95PUl-9b2Fnzm1xLlslLw4Cc_1oMVbvNUbJS6r4_bgylTYSowUCqQLZUPH_DClav4aJC-G3OYlCkQrG3wFnB7b70Q8qJrwsVr2XaYh8lwfah_BceiDEJNc2yjjEBQoHs3zbi3qOVhYp3_BYHVoXuBJnhEgMb5bpxzgN-ZrM2QwmLzLSv9BB_iq034B3P0Exn8n0yWvXPFe_pWPzwyC_l4dgMN_TpNMLjaBYoJ-wdfim7eEJuOgVfuV1O8smMeXhUNUoRKOvFNw9H2qjZM243JhVBnLX1C7Oj_8L2AW7wSptuThl-gIqy9nrcSPT_oHhVUwAgO-gwFCRSgilFiBhsG9-wkflSdELeJCRpLi1j_8OOON0LTX6vZrHjwGzGa0bC5zgouKCFE1iNtVc3HoNKczZL-wiERUIgo8YKey_uOdeOtdBPOLVO0igfN4xtDZnxb_CzSUJ3fJHGAg03k3MBEpr0KAMmhsTSo-KUqfcgnclHkOywGdwnX-oT43SvcItEDbUiKyFV-i0CabAVebzF4O6r_ovpK4N2QJ-4s8_bHx4d3RMstML1D_yEpy40PeFjQq5ZPQQt1AUfkT1jP5-siCdJgm8HTc0zIPwfZfwKdKefYMRmamNHwk3TNV9gdOX0fnKP07R9FBKCgypqeDcLYZYgMt",\n    "e": "AQAB"\n  },\n  {\n    "use": "sig",\n    "kty": "RSA",\n    "kid": "wQ4TGh1obxJ6l8nxEiV-hf-lccLnJwXxx7Rw8E-UDBo",\n    "alg": "RS256",\n    "n": "ydxfJlP6Qmh_dfkhWkrGQrrad-o0ShvZCShIUz4-k8bhH98xAhSgC52EmXnbCvkbDxHpwQIZ8GQHFGjbFC-Z-ZbdIpETd-MVwp70HXyoejuFNmdghTeLZaN5Q-lf1U8gjnxfzUo5tL_Vwcd1RhGi3YXwQmiEGJoZ5ZWhQs75O8iAnvyOzDqWt0CxraIAVPoY9aJ1IBTPlA0bIdDtuCTiynCMQiozO4dx72BDMjJ3ZcEwKrFZBFAu71SPr4xs7ErUYqZFtZxmcDxKkhTNCPd9dUkmo6uknMuVSHj5OqeXexDdKhZKcJhTFBGF89oWtIjx0ix9G8VTqTJsDZp3_LBcs6Ob0hpfyaGePhibZTqhDXD_Nr3p-yw78lXO0ceD1xz8ZJyY4EzxtY2yobAGGNsg_wU23XJsIkJLOGiCAjRg81PxbtlEPzClXkxbrZTjKI9OVJxujGxt01PmgiLN38piThL3zsvGF_4N-ApX1fpdKH9Owl2xsmVd-zzzoJ1l8y9FKZpgnJKQ-VECIbVNwzO6KEm2f7O6MKpqB5hLi-QPH-ZLk3zbi_55zb8h1PZxmuam4rS3MHi98IxxmVz8fbMVirosQhzP7oYuM-L1ZgZLzwKvDenmoUYIfzwUl6QCsM3DxZs_07sxUrZk0isNvBHU3wXKsCtSXJyf0CJyq6TAYCD1",\n    "e": "AQAB"\n  }\n]\n}\n'})}),"\n",(0,i.jsxs)(t.p,{children:["However, for the Federated credential configuration for AKS, the OIC URL from the Azure CLI ",(0,i.jsx)(t.code,{children:"az aks show"})," command is enough."]}),"\n",(0,i.jsxs)(t.p,{children:["Second is the ",(0,i.jsx)(t.strong,{children:"Namespace"}),". This is the Namespace in which the User Assigned Managed identity will be used. In my example, I have 'pets' as this is my Application namespace. Be as specific as you can."]}),"\n",(0,i.jsx)(t.p,{children:"In Kubernetes, a namespace organizes and isolates resources within a cluster. It acts as a virtual cluster within the main cluster. Namespaces allow you to group related objects (such as pods, services, and deployments) together and provide a scope for resource names."}),"\n",(0,i.jsxs)(t.p,{children:["Third is the ",(0,i.jsx)(t.strong,{children:"Service Account"}),". This Service Account will be linked to the Federated credential inside of AKS."]}),"\n",(0,i.jsx)(t.p,{children:"A service account is an identity used by pods (containers) running within a namespace to authenticate with other services or APIs. Each namespace can have multiple service accounts, and they are associated with specific permissions. When a pod is created, it can be assigned a service account. The pod then uses the credentials associated with that service account to access other resources (e.g., secrets, APIs). Service accounts are useful for controlling access and ensuring that pods have the appropriate permissions."}),"\n",(0,i.jsxs)(t.p,{children:["That leaves the ",(0,i.jsx)(t.strong,{children:"Subject identifier"}),". This is the Subject identifier."]}),"\n",(0,i.jsx)(t.p,{children:"In AKS Federated credentials, the subject identifier refers to the identity the managed identity will trust. When using workload identity, the subject identifier is typically the service account associated with a pod. The subject identifier establishes trust between the managed identity (related to the AKS cluster) and the service account (associated with the pod). Once this trust is established, the managed identity can securely use the service account\u2019s credentials to access other Azure services."}),"\n",(0,i.jsx)(t.p,{children:"Namespaces provide isolation, service accounts represent identities for pods, and subject identifiers (usually service accounts) are used in federated credentials to establish trust between the managed identity and Kubernetes workloads."}),"\n",(0,i.jsxs)(t.p,{children:["Under the Credentials details, we have ",(0,i.jsx)(t.strong,{children:"Name"})," and ",(0,i.jsx)(t.strong,{children:"Audience"}),"."]}),"\n",(0,i.jsxs)(t.p,{children:["The ",(0,i.jsx)(t.strong,{children:"name"})," refers to the identifier associated with a managed identity or service principal in Azure. In AKS (Azure Kubernetes Service), when configuring federated credentials using managed identities, you create a managed identity (or use an existing one) to represent your AKS cluster. This managed identity is assigned a unique name, which is used to identify it within Entra ID. For example, creating a managed identity named \u201cmy-aks-cluster-identity\u201d becomes the name associated with the identity."]}),"\n",(0,i.jsxs)(t.p,{children:["The ",(0,i.jsx)(t.strong,{children:"audience"})," (also known as the \u201caud\u201d claim) is a critical part of security tokens (such as JWTs) issued by Azure AD. In the context of AKS federated credentials, the audience represents the intended recipient of the token. When a pod in AKS requests an access token (e.g., to access Azure Key Vault secrets), the audience is set to the specific Azure resource (e.g., Key Vault) the pod wants to access. The audience ensures that the token is valid only for the specified resource. For example, if a pod seeks to access a secret stored in Azure Key Vault, the audience in the token will be set to the Key Vault\u2019s endpoint."]}),"\n",(0,i.jsxs)(t.p,{children:["The ",(0,i.jsx)(t.code,{children:"api://AzureADTokenExchange"})," audience is typically used when a service needs to obtain a token to act on behalf of a user or another service. For example:"]}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["A user logs in to a web application (front-end), and the application needs to call an API (back-end) on behalf of the user. The front-end application requests an on-behalf-of token with the ",(0,i.jsx)(t.code,{children:"api://AzureADTokenExchange"})," audience."]}),"\n",(0,i.jsx)(t.li,{children:"A service (acting as a middle-tier) receives an access token from a client and needs to call another downstream service."}),"\n"]}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.em,{children:"(e.g., a database or an API)"}),". It exchanges the token for an on-behalf-of token using the same audience."]}),"\n",(0,i.jsx)(t.p,{children:"The api://AzureADTokenExchange audience is used explicitly for token exchange scenarios, allowing services to obtain tokens on behalf of users or other services."}),"\n",(0,i.jsx)(t.p,{children:"Name: The unique identifier for a managed identity or service principal.\nAudience: The intended recipient (Azure resource) for the security token."})]})}function h(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}},21959:(e,t,n)=>{n.d(t,{A:()=>i});const i=n.p+"assets/images/UserManagedIdentityEditFederatedCredential-351518c0ea04428d7606d78007c82f43.gif"},34187:(e,t,n)=>{n.d(t,{A:()=>i});const i=n.p+"assets/images/aks-workload-identity-model-e921e08544288984f5cc6c418a26f595.png"},28453:(e,t,n)=>{n.d(t,{R:()=>a,x:()=>o});var i=n(96540);const s={},r=i.createContext(s);function a(e){const t=i.useContext(r);return i.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),i.createElement(r.Provider,{value:t},e.children)}}}]);