<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://luke.geek.nz/</id>
    <title>luke.geek.nz Blog</title>
    <updated>2024-04-14T00:26:42.797Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://luke.geek.nz/"/>
    <subtitle>luke.geek.nz Blog</subtitle>
    <icon>https://luke.geek.nz/img/favicon.ico</icon>
    <rights>Copyright ¬© 2024 luke.geek.nz.</rights>
    <entry>
        <title type="html"><![CDATA[Implementing a Sandbox Environment in Microsoft Azure]]></title>
        <id>https://luke.geek.nz/azure/implementing-sandbox-vending/</id>
        <link href="https://luke.geek.nz/azure/implementing-sandbox-vending/"/>
        <updated>2024-04-14T00:26:42.797Z</updated>
        <summary type="html"><![CDATA[This article highlights reference implementation considerations for implementing a Sandbox environment in Microsoft Azure.]]></summary>
        <content type="html"><![CDATA[<p>When working with Microsoft Azure, you may want an environment for learning, whether for an individual or a team.</p>
<p>This article aims to highlight some reference implementation considerations for implementing a Sandbox environment within the Microsoft Azure platform.</p>
<p><img decoding="async" loading="lazy" alt="Azure Environment Concepts" src="https://luke.geek.nz/assets/images/Azure_Environment_Concepts-8a14a53df5888d03491157996cdd2a2c.png" width="4000" height="2250" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-overview">üìù Overview<a href="https://luke.geek.nz/azure/implementing-sandbox-vending/#-overview" class="hash-link" aria-label="Direct link to üìù Overview" title="Direct link to üìù Overview">‚Äã</a></h2>
<p>When working with Microsoft Azure, you may want an environment for learning, whether for an individual or a team.</p>
<p>Cloud Sandboxes are contained, isolated environments that allow the evaluation of new Cloud services and features (without impacting production environments).</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>This follows from a previous article about <a href="https://luke.geek.nz/azure/microsoft-azure-sandbox-design-considerations/" target="_blank" rel="noopener noreferrer">Sandbox Design</a> considerations but focuses on the implementation elements. This article aims to give you some ideas on how you can achieve Sandbox vending and is opinionated based on my experience. However, it's purely intended to show one (of many) possible ways. Just make sure you understand the business requirements and what you need to achieve.</p></div></div>
<p>A design area of the Ready phase of the <a href="https://learn.microsoft.com/azure/cloud-adoption-framework/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Cloud Adoption Framework</a> is the design and implementation of the <a href="https://learn.microsoft.com/azure/cloud-adoption-framework/ready/landing-zone/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Landing Zone</a>, it would be asmiss of me not to bring up <a href="https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/landing-zone/design-area/subscription-vending?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Subscription vending</a>.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>"Subscription vending provides a platform mechanism for programmatically issuing subscriptions to application teams that need to deploy workloads."</p></div></div>
<p>Subscription Vending is the foundation of what we will discuss today: Sandbox vending.</p>
<p>I will base this article on Unmanaged Sandboxes <em>(Subscription-scoped Sandboxes)</em>; however, much of the same information can be used across all Sandbox types.</p>
<p><img decoding="async" loading="lazy" alt="Sandbox Types" src="https://luke.geek.nz/assets/images/Azure_Sandbox_Types-3ca36f3329a48acbf215c3222a060d86.png" width="4000" height="2250" class="img_ev3q"></p>
<!-- -->
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-scenario">üé¨ Scenario<a href="https://luke.geek.nz/azure/implementing-sandbox-vending/#-scenario" class="hash-link" aria-label="Direct link to üé¨ Scenario" title="Direct link to üé¨ Scenario">‚Äã</a></h2>
<p>The scenario we are going to run through today involves creating an <a href="https://luke.geek.nz/azure/microsoft-azure-sandbox-design-considerations/" target="_blank" rel="noopener noreferrer">Unmanaged</a> <em>(i.e., subscription-scoped)</em> Sandbox <em>(Sandbox vending)</em> per user or team, which could be a method of implementing it.</p>
<p>To go through this scenario, we will use the following Disciplines of <a href="https://learn.microsoft.com/azure/cloud-adoption-framework/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Cloud Adoption</a> to help separate elements.</p>
<p><img decoding="async" loading="lazy" alt="Disciplines of Cloud Governance" src="https://luke.geek.nz/assets/images/Azure_Sandbox_CloudGovernance_Disciplines-e9552882c6984c5635c744a8e1361221.png" width="4000" height="2250" class="img_ev3q"></p>
<table><thead><tr><th>Discipline</th><th>Description</th></tr></thead><tbody><tr><td>Cost Management</td><td>Cost is a primary concern for cloud users. Develop policies for cost control for all cloud platforms.</td></tr><tr><td>Security Baseline</td><td>Policies and enforcement apply those requirements across network, data, and asset configurations.</td></tr><tr><td>Resource Consistency</td><td>Resources can be configured consistently to manage risks related to onboarding, drift, discoverability, and recovery.</td></tr><tr><td>Identity Baseline</td><td>Identity Baseline discipline focuses on ensuring that identity is consistently applied across cloud adoption efforts.</td></tr><tr><td>Deployment Acceleration</td><td>Centralization, standardization, and consistency in approaches to deployment and configuration improve governance practices.</td></tr></tbody></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-cost-management">üí∞ Cost Management<a href="https://luke.geek.nz/azure/implementing-sandbox-vending/#-cost-management" class="hash-link" aria-label="Direct link to üí∞ Cost Management" title="Direct link to üí∞ Cost Management">‚Äã</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-finops">üí∞ FinOps<a href="https://luke.geek.nz/azure/implementing-sandbox-vending/#-finops" class="hash-link" aria-label="Direct link to üí∞ FinOps" title="Direct link to üí∞ FinOps">‚Äã</a></h3>
<p>When working with a Sandbox environment, you need to be aware of the costs associated with it. <a href="https://www.finops.org/framework/principles/" target="_blank" rel="noopener noreferrer">FinOps principles</a> can be key.</p>
<p><a href="https://learn.microsoft.com/azure/azure-resource-manager/management/tag-resources?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Tags</a> can be key to help you showback/chargeback costs and help you assign resource owners.</p>
<p>Recommended Tags for a Sandbox environment could be:</p>
<ul>
<li>"costCenter": "sandbox"</li>
<li>"costModel": "show-back"</li>
<li>"environment": "sandbox"</li>
<li>"resourceowner": "your_name"</li>
<li>"project": "sandbox_project"</li>
</ul>
<p>Although the Sandbox environment is for learning, you still need to be aware of its associated costs and keep these as lean as possible.</p>
<p>You can also implement Cost Management and Governance workbooks that allow Sandbox users access to interactive dashboards to help them understand their costs and usage.</p>
<ul>
<li><a href="https://microsoft.github.io/finops-toolkit/governance-workbook" target="_blank" rel="noopener noreferrer">Governance workbook</a> - Monitor the governance posture of your Azure environment. Leverage recommendations to address compliance issues.</li>
<li><a href="https://microsoft.github.io/finops-toolkit/optimization-workbook" target="_blank" rel="noopener noreferrer">Cost optimization workbook</a> - Give your engineers a single pane of glass for cost optimization with this handy Azure Monitor workbook.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-budgets">üí∞ Budgets<a href="https://luke.geek.nz/azure/implementing-sandbox-vending/#-budgets" class="hash-link" aria-label="Direct link to üí∞ Budgets" title="Direct link to üí∞ Budgets">‚Äã</a></h3>
<p>Implement <a href="https://learn.microsoft.com/azure/cost-management-billing/costs/tutorial-acm-create-budgets?tabs=psbudget&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Budgets</a> for each Sandbox, assigned to the Sandbox owner.</p>
<p>Monthly resource spending should be forecast initially and amended as the footprint changes.</p>
<p>Budget alerts are set up to highlight unplanned spending, not to prevent it <em>(i.e., they are alerting thresholds, not limits)</em>.</p>
<p>Each Sandbox environment could start with a consistent Budget and can be adjusted IF required as an exception.
Budgets are intended to drive Sandbox owners to keep their costs under control by having the information on hand.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-security-baseline">üîí Security Baseline<a href="https://luke.geek.nz/azure/implementing-sandbox-vending/#-security-baseline" class="hash-link" aria-label="Direct link to üîí Security Baseline" title="Direct link to üîí Security Baseline">‚Äã</a></h2>
<p>Security is a key concern for any environment, and the Sandbox environment is no different; however, there are some tradeoffs. The key to a successful Sandbox environment is that it's an environment for learning, so the level of security you would adopt should be less. However, there are some stop gaps that should be implemented.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-defender-for-cloud">üõ°Ô∏è Defender for Cloud<a href="https://luke.geek.nz/azure/implementing-sandbox-vending/#%EF%B8%8F-defender-for-cloud" class="hash-link" aria-label="Direct link to üõ°Ô∏è Defender for Cloud" title="Direct link to üõ°Ô∏è Defender for Cloud">‚Äã</a></h3>
<p><a href="https://learn.microsoft.com/azure/defender-for-cloud/defender-for-cloud-introduction?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Defender for Cloud</a> is a cloud-native application protection platform (CNAPP) that consists of security measures and practices designed to protect cloud-based applications from various cyber threats and vulnerabilities.</p>
<p><img decoding="async" loading="lazy" alt="Defender for Cloud" src="https://luke.geek.nz/assets/images/defender-for-cloud-pillars-ebd2a2d6c79e8ec18c23f41f291634d9.png" width="1207" height="448" class="img_ev3q"></p>
<p>Defender for Cloud should be enabled on all Sandboxes to help protect against threats and increase visibility. It is a great learning tool.</p>
<p>As people learn how to use Azure technologies, they may not necessarily know how to secure them or how their services might be adapted for a more secure environment. Defender for Cloud helps increase the knowledge around resources in alignment with <a href="https://learn.microsoft.com/azure/defender-for-cloud/alerts-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">current security best practices</a>.</p>
<blockquote>
<p>"While the security team is responsible for improving the security posture, team members might not actually implement security recommendations.
Using governance rules driven by the security team helps you to drive accountability and an SLA around the remediation process."</p>
</blockquote>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p><a href="https://learn.microsoft.com/en-us/azure/defender-for-cloud/governance-rules?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Governance rules</a> are key.</p></div></div>
<p>For example, using Tags, you could assign resource owners to resources and help drive accountability, alerts, and remediation. Defender for Cloud can be a great learning tool by informing your Sandbox users of potential security issues.</p>
<p>You should also consider possible scenarios, such as the Sandbox environment being one method to exfiltrate data, so make sure you look at <a href="https://learn.microsoft.com/purview/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Purview</a> and <a href="https://learn.microsoft.com/en-us/azure/defender-for-cloud/defender-for-storage-data-sensitivity?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">data sensativity</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-azure-policy">üìú Azure Policy<a href="https://luke.geek.nz/azure/implementing-sandbox-vending/#-azure-policy" class="hash-link" aria-label="Direct link to üìú Azure Policy" title="Direct link to üìú Azure Policy">‚Äã</a></h3>
<p><a href="https://learn.microsoft.com/azure/governance/policy/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Policy</a> is a service in Azure that you use to create, assign, and manage policies. These policies enforce different rules and effects over your resources so those resources stay compliant with your corporate standards and service level agreements.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>I highly recommend that you deploy your policies and initiatives using <a href="https://azure.github.io/enterprise-azure-policy-as-code/" target="_blank" rel="noopener noreferrer">Azure Enterprise Policy as Code</a>.</p></div></div>
<p>There are tradeoffs with the type of Azure policies you deploy in a Sandbox environment vs what you would deploy in your Production or even Dev/Test environment; recommended policies as a base I would recommend are:</p>
<p>Reference: <a href="https://github.com/Azure/Enterprise-Scale/blob/main/docs/wiki/ALZ-Policies.md" target="_blank" rel="noopener noreferrer">ALZ policies</a></p>
<table><thead><tr><th>Assignment Name</th><th>Definition Name</th><th>Policy Type</th><th>Description</th><th>Effect(s)</th></tr></thead><tbody><tr><td><strong>Enforce ALZ Sandbox Guardrails</strong></td><td><strong>Enforce policies in the Sandbox Landing Zone</strong></td><td><code>Policy Definition Set,</code> <strong>Custom</strong></td><td>This initiative will help enforce and govern subscriptions that are placed within the Sandbox Management Group. Policies included: <ul><li>Deny vNET peering across subscriptions</li><li>Deny the deployment of vWAN/ER/VPN gateways.</li></ul></td><td>Enforce</td></tr></tbody></table>
<table><thead><tr><th>Assignment Name</th><th>Definition Name</th><th>Policy Type</th><th>Description</th><th>Effect(s)</th></tr></thead><tbody><tr><td><strong>Enforce ALZ Decommissioned Guardrails</strong></td><td><strong>Enforce policies in the Decommissioned Landing Zone</strong></td><td><code>Policy Definition Set,</code> <strong>Custom</strong></td><td>This initiative will help enforce and govern subscriptions that are placed within the decommissioned Management Group as part of your Subscription decommissioning process. Policies included: <ul><li>Deny the deployment of new resources</li><li>Deploy an auto VM shutdown policy at UTC 00:00</li></ul></td><td>Enforce</td></tr></tbody></table>
<p>The Decommissioned Management group is where you would move your Sandbox subscriptions once they are no longer required and you want to decommission them.</p>
<p><img decoding="async" loading="lazy" alt="Azure Policy - Azure Landing Zones - Initiative" src="https://luke.geek.nz/assets/images/AzurePolicy_ALZSandboxIniiative-8d8de7a7effabe552851d520910029d8.png" width="1166" height="498" class="img_ev3q"></p>
<p>Key policies are part of the ALZ Sandbox Guardrails, which are essentially the policies to restrict the deployment of network resources. These policies would allow you to link virtual networks to on-premises, peer-to-peer virtual networks and allow Sandbox users to connect to production virtual networks or virtual networks outside your organization's control.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-terms-of-use">üìú Terms of use<a href="https://luke.geek.nz/azure/implementing-sandbox-vending/#-terms-of-use" class="hash-link" aria-label="Direct link to üìú Terms of use" title="Direct link to üìú Terms of use">‚Äã</a></h3>
<p>Make sure you don't forget about the People/Processes of your sandbox. You should implement Terms of Use for the Sandbox environment so that users understand the rules and regulations of the environment, such as 'Do not store Production data'.</p>
<p>You can combine this directly into the Azure Portal login experience by using <a href="https://learn.microsoft.com/en-us/entra/identity/conditional-access/terms-of-use?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Microsoft Entra terms of use</a>.</p>
<p><img decoding="async" loading="lazy" alt="Microsoft Entra - Terms of use" src="https://luke.geek.nz/assets/images/user-tou-0335508519c8d3feed95ed2401942df4.png" width="1372" height="838" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-resource-consistency">üîÑ Resource Consistency<a href="https://luke.geek.nz/azure/implementing-sandbox-vending/#-resource-consistency" class="hash-link" aria-label="Direct link to üîÑ Resource Consistency" title="Direct link to üîÑ Resource Consistency">‚Äã</a></h2>
<p>Resource Consistency is key. It ensures that resources are configured consistently to manage onboarding, drift, discoverability, and recovery risks.</p>
<p>This is where a lot of automation comes into play to prevent drift and inconsistencies in creating (and decommissioning) a Sandbox environment.</p>
<p><img decoding="async" loading="lazy" alt="Azure DevOps Pipeline - Sandbox" src="https://luke.geek.nz/assets/images/ResourceConsistency_SBX_ADOPipelines-e66d08ed0d8ae21e1e243967604f23be.png" width="4000" height="2250" class="img_ev3q"></p>
<p>Ideally, you would have a user interface where a user could request a Sandbox environment <em>(I will talk more about this in the deployment acceleration section)</em>, which would trigger an Azure DevOps pipeline or GitHub action, as an example, to create the environment.</p>
<p>Using Infrastructure as Code <em>(IaC)</em>, you can ensure that the environment is consistent and repeatable and can be provisioned and decommissioned.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-enterprise-policy-as-code">üìö Enterprise Policy as Code<a href="https://luke.geek.nz/azure/implementing-sandbox-vending/#-enterprise-policy-as-code" class="hash-link" aria-label="Direct link to üìö Enterprise Policy as Code" title="Direct link to üìö Enterprise Policy as Code">‚Äã</a></h3>
<p><a href="https://learn.microsoft.com/azure/cloud-adoption-framework/ready/policy-management/enterprise-policy-as-code?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Enterprise Policy as Code or EPAC</a> for short comprises a number of scripts which can be used in CI/CD based system or a semi-automated use to deploy Policies, Policy Sets, Assignments, Policy Exemptions and Role Assignments.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>This is a solution created by Microsoft employees but without Microsoft's official support as an open-source initiative.</p></div></div>
<p>EPAC is designed for organizations with a large number of Policies, Policy Sets, and Assignments. It is also designed for organizations with multiple tenants and/or environments. The solution primarily consists of PowerShell scripts intended to run operations such as policy planning, deployment, and sync of external policies, such as Enterprise Landing Zone policies, into the EPAC repo.</p>
<p>Enterprise Policy as Code can also be used to control exemptions. An example is running this nightly; any policies or exemptions not in the repository are removed.</p>
<p>Enterprise Policy as Code could be used for Sandbox environments, providing an opportunity to clean up outdated policies, assignments, and exemptions and maintain consistency.</p>
<p><img decoding="async" loading="lazy" alt="Enterprise Policy as Code - Sandbox" src="https://luke.geek.nz/assets/images/SandboxPolicy_EPAC-ed7330acd413862edc53f896f17f3cff.gif" width="1685" height="741" class="img_ev3q"></p>
<p>Feel free to refer a blog post, I did previously on <a href="https://luke.geek.nz/azure/enterprise-policy-code-azure-devops/" target="_blank" rel="noopener noreferrer">Enterprise Policy as Code, with Azure DevOps</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-azure-devopsgithub">üõ†Ô∏è Azure DevOps/GitHub<a href="https://luke.geek.nz/azure/implementing-sandbox-vending/#%EF%B8%8F-azure-devopsgithub" class="hash-link" aria-label="Direct link to üõ†Ô∏è Azure DevOps/GitHub" title="Direct link to üõ†Ô∏è Azure DevOps/GitHub">‚Äã</a></h3>
<p><a href="https://azure.microsoft.com/products/devops?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure DevOps</a> or <a href="https://github.com/" target="_blank" rel="noopener noreferrer">GitHub</a>, both offer features, such as Boards/Discussions, Code Repos, Pipelines <em>(or Actions)</em> which can be used as a platform, for IaC <em>(Infrastructure as Code)</em> and CI/CD <em>(Continous Integration and Continous Deployment)</em>, and is definitely recommended to be factored in your Sandbox design, when it comes to automation and desired state of your Sandbox environment.</p>
<p>The following automation recommendations assume you have access to Azure DevOps or GitHub <em>(or similar)</em>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-symphony">üéº Symphony<a href="https://luke.geek.nz/azure/implementing-sandbox-vending/#-symphony" class="hash-link" aria-label="Direct link to üéº Symphony" title="Direct link to üéº Symphony">‚Äã</a></h3>
<p>A large part of the Sandbox vending is a DevOps pipeline and connectivity to Azure that allows Terraform and the pipeline in Azure DevOps to connect to make changes in Azure. Terraform is the car, and Symphony is the road that it travels on.</p>
<p><a href="https://github.com/microsoft/symphony" target="_blank" rel="noopener noreferrer">Symphony</a> is a framework and set of patterns and best practices for developing, testing, and deploying infrastructure on Azure using Infrastructure as Code <em>(IAC)</em> It includes modern DevOps practices for IAC such as Main and Pull Request workflows, IaC Code Validation &amp; Linting, Automated Testing, Security Scanning, Multi-environment deployments, modules dependencies and more. A mature workflow for IAC not only automates the deployment of the IAC resources but also incorporates engineering fundamentals, resource validation, dependency management, test execution, security scanning, and more.</p>
<p>The Symphony pipelines for Azure DevOps and Terraform, for example, are:</p>
<table><thead><tr><th>Pipeline Name</th><th>Comments</th></tr></thead><tbody><tr><td>pipeline.ci.terraform.yml</td><td>This YAML file defines a Continuous Integration (CI) pipeline for Azure DevOps, which triggers changes to the main branch, sets up certain variables, and executes several stages, including validation of configuration and preview deployment using Terraform templates. This file is the command file, triggering the other pipelines.</td></tr><tr><td>pipeline.destroy.terraform.yml</td><td>This YAML file defines a pipeline in Azure DevOps that uses a specific agent image to run a job based on a template for destroying a Terraform environment, with the environment details and key vault information passed as parameters. The pipeline does not trigger automatically on any branch or pull request changes.</td></tr><tr><td>template.terraform.previewdeploy.yml</td><td>This YAML file defines a job in an Azure DevOps pipeline that sets up a clean workspace, installs Terraform and Go, retrieves secrets from an Azure Key Vault, updates network rules and storage account settings, and executes a Terraform plan and apply operation. It also cleans up by removing the agent IP from the Key Vault and denying public access to the Terraform DevOps Storage after the job is done.</td></tr><tr><td>template.terraform.report.yml</td><td>This YAML file defines a job in an Azure DevOps pipeline that, depending on a condition, cleans the workspace, retrieves secrets from an Azure Key Vault, and executes a bash script to backup the state files of a specified environment using Terraform.</td></tr><tr><td>template.terraform.test.yml</td><td>This YAML file defines an end-to-end test job in an Azure DevOps pipeline that sets up a clean workspace, installs Terraform and Go, retrieves secrets from an Azure Key Vault, adds the agent IP to the Key Vault and storage account, runs tests, publishes the test results, and finally removes the agent IP from the Key Vault and storage account.</td></tr><tr><td>template.terraform.validate.yml</td><td>This YAML file defines a validation job in an Azure DevOps pipeline that sets up a clean workspace, installs necessary tools, runs GitLeaks for code analysis, adds the agent IP to a Key Vault, runs Terraform lint and validate, optionally runs layer tests, publishes test results, and finally removes the agent IP from the Key Vault and denies public access to the Terraform DevOps Storage.</td></tr></tbody></table>
<p>Using a framework such as Symphony gives you a good starting point for your deployments.</p>
<p><img decoding="async" loading="lazy" alt="Symphony - Prestep" src="https://luke.geek.nz/assets/images/Azure_Sandbox_Symphony_Prestep-a29849b2b838befc80dbd28876732690.png" width="1002" height="190" class="img_ev3q">
<img decoding="async" loading="lazy" alt="Symphony - Preview &amp;amp; Deploy" src="https://luke.geek.nz/assets/images/Azure_Sandbox_Symphony_PreviewandDeploy-6946810c4b662519f60539042cf8284b.png" width="1721" height="227" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-terraform">üèóÔ∏è Terraform<a href="https://luke.geek.nz/azure/implementing-sandbox-vending/#%EF%B8%8F-terraform" class="hash-link" aria-label="Direct link to üèóÔ∏è Terraform" title="Direct link to üèóÔ∏è Terraform">‚Äã</a></h3>
<p><a href="https://learn.microsoft.com/azure/azure-resource-manager/bicep/overview?tabs=bicep&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Bicep</a> and <a href="https://www.terraform.io/" target="_blank" rel="noopener noreferrer">Terraform</a> are both tools used for infrastructure-as-code (IaC), which means they allow you to define and manage your cloud infrastructure using code. Both are declarative, meaning you define the desired state of your infrastructure and the tool figures out how to make it so. Bicep is more focused on Microsoft Azure, while Terraform is more focused on multi-cloud.</p>
<p>For this article, I will focus on Terraform, based purely on work done with it around Sandbox provisioning and decommissioning. The Terraform state file helps with a lot of the Sandbox decommissioning aspect.</p>
<p>Terraform modules that can be used during Sandbox provisioning are:</p>
<table><thead><tr><th>Name</th><th>Link</th></tr></thead><tbody><tr><td>azuread</td><td><a href="https://registry.terraform.io/providers/hashicorp/azuread/latest" target="_blank" rel="noopener noreferrer">https://registry.terraform.io/providers/hashicorp/azuread/latest</a></td></tr><tr><td>azurerm</td><td><a href="https://registry.terraform.io/providers/hashicorp/azurerm/latest" target="_blank" rel="noopener noreferrer">https://registry.terraform.io/providers/hashicorp/azurerm/latest</a></td></tr><tr><td>random</td><td><a href="https://registry.terraform.io/providers/hashicorp/random/latest" target="_blank" rel="noopener noreferrer">https://registry.terraform.io/providers/hashicorp/random/latest</a></td></tr><tr><td>time</td><td><a href="https://registry.terraform.io/providers/hashicorp/time/latest" target="_blank" rel="noopener noreferrer">https://registry.terraform.io/providers/hashicorp/time/latest</a></td></tr><tr><td>Azure/lz-vending/azurerm</td><td><a href="https://registry.terraform.io/modules/Azure/lz-vending/azurerm/latest" target="_blank" rel="noopener noreferrer">https://registry.terraform.io/modules/Azure/lz-vending/azurerm/latest</a></td></tr></tbody></table>
<p>The real foundation of Sandbox vending is the <a href="https://github.com/Azure/terraform-azurerm-lz-vending" target="_blank" rel="noopener noreferrer">Azure/terraform-azurerm-lz-vending</a> Terraform module.</p>
<p>It can be used to create Azure resources according to the landing zone <em>(Sandbox)</em> vending pattern. It can be used to provision resources such as subscriptions, management group associations, role assignments, and virtual networks.</p>
<p>Here is an example <em>(partial snippet of an overall solution)</em> of how you COULD use the module by having multiple YAML files per Sandbox and using a for_each loop to create each Sandbox environment:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># This module is used to create resources in Azure according to the landing zone vending pattern.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">module</span><span class="token keyword type variable" style="color:rgb(189, 147, 249);font-style:italic"> "lz_vending" </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The source and version of the module.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">source</span><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Azure/lz-vending/azurerm"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">version</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"4.0.2"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The for_each loop allows us to create multiple instances of this module, one for each item in the landing_zone_data_map.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">for_each</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> local.landing_zone_data_map</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The location where the resources will be created.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">location</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> var.location</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Subscription variables.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Enables the resource provider creation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">subscription_register_resource_providers_enabled</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The map of resource providers to register.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">subscription_register_resource_providers_and_features</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> var.subscription_register_resource_providers_and_features</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Enables the creation of a subscription alias.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">subscription_alias_enabled</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The billing scope for the subscription.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">subscription_billing_scope</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"/providers/Microsoft.Billing/billingAccounts/0000000/enrollmentAccounts/</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">$</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string interpolation" style="color:rgb(255, 121, 198)">each</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation" style="color:rgb(255, 121, 198)">value</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation" style="color:rgb(255, 121, 198)">billing_enrollment_account</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The display name for the subscription. It is converted to lowercase to maintain consistency.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">subscription_display_name</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> (</span><span class="token string" style="color:rgb(255, 121, 198)">"SUB-Contoso-</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">$</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string interpolation" style="color:rgb(255, 121, 198)">each</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation" style="color:rgb(255, 121, 198)">value</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation" style="color:rgb(255, 121, 198)">name</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string" style="color:rgb(255, 121, 198)">_</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">$</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string interpolation keyword" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation type variable" style="color:rgb(189, 147, 249);font-style:italic">env</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string" style="color:rgb(255, 121, 198)">-001"</span><span class="token plain">)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The alias name for the subscription. It is also converted to lowercase.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">subscription_alias_name</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> (</span><span class="token string" style="color:rgb(255, 121, 198)">"SUB-Contoso</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">$</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string interpolation" style="color:rgb(255, 121, 198)">each</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation" style="color:rgb(255, 121, 198)">value</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation" style="color:rgb(255, 121, 198)">name</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string" style="color:rgb(255, 121, 198)">_</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">$</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string interpolation keyword" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation type variable" style="color:rgb(189, 147, 249);font-style:italic">env</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string" style="color:rgb(255, 121, 198)">-001"</span><span class="token plain">)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The workload type for the subscription.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">subscription_workload</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> each.value.workload</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Management group association variables.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Enables the association of the subscription with a management group.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">subscription_management_group_association_enabled</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The ID of the management group to associate with the subscription.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">subscription_management_group_id</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> each.value.management_group_id</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Tags to apply to the subscription. The Owner tags are set to the owner of the workload.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">subscription_tags</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> merge(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    var.tags,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"resource-owner"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> each.value.owner,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"expiry_date"</span><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> each.value.expiry_date</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Role assignment variables.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">role_assignment_enabled</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">role_assignments</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># using role definition name, created at subscription scope</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">contrib_user_sub</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">principal_id</span><span class="token plain">   </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> azuread_group.contributor</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">each.key</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">.id</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">definition</span><span class="token plain">     </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Contributor"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">relative_scope</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">""</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Virtual network variables.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Enables the creation of a virtual network.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">virtual_network_enabled</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Enables the creation of a network watcher resource group.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">network_watcher_resource_group_enabled</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The details of the virtual network to create.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">virtual_networks</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">one</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)"># The name of the virtual network. It is converted to lowercase.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">name</span><span class="token plain">                        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> lower(</span><span class="token string" style="color:rgb(255, 121, 198)">"vnet-</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">$</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string interpolation keyword" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation type variable" style="color:rgb(189, 147, 249);font-style:italic">env</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string" style="color:rgb(255, 121, 198)">-</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">$</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string interpolation" style="color:rgb(255, 121, 198)">each</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation" style="color:rgb(255, 121, 198)">value</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation" style="color:rgb(255, 121, 198)">name</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain">)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">resource_group_lock_enabled</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)"># The address space for the virtual network.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">address_space</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">"192.168.1.0/24"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)"># The name of the resource group where the virtual network will be created. It is converted to lowercase.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">resource_group_name</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> lower(</span><span class="token string" style="color:rgb(255, 121, 198)">"rg-contoso-networks-</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">$</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string interpolation keyword" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation type variable" style="color:rgb(189, 147, 249);font-style:italic">env</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string" style="color:rgb(255, 121, 198)">-aue-001"</span><span class="token plain">)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)"># The location where the virtual network will be created.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">location</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> var.location</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This will create a Subscription, Resource Group, and define Contributor access, based on data from a data map, that looks at each YAML file in a folder.</p>
<p>"for_each = local.landing_zone_data_map" - This is the key part, as it allows you to create multiple instances of the module, one for each item in the landing_zone_data_map.</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">locals</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># landing_zone_data_dir is the directory containing the YAML files for the landing zones.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># It is set to the root directory of the current Terraform project.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">landing_zone_data_dir</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> path.root</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># landing_zone_data_map is a map that stores the decoded YAML data from each landing zone file.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># It uses a for loop to iterate over each file in the landing_zone_files list.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># For each file, it reads the contents of the file using the file function and decodes the YAML data using the yamldecode function.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The file path is constructed by concatenating the landing_zone_data_dir and the file name.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The decoded YAML data is then stored in the landing_zone_data_map with the file name as the key.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">landing_zone_data_map</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    for f in local.landing_zone_files :</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">f</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain">&gt; yamldecode(file(</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">$</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string interpolation keyword" style="color:rgb(189, 147, 249);font-style:italic">local</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation type variable" style="color:rgb(189, 147, 249);font-style:italic">landing_zone_data_dir</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string" style="color:rgb(255, 121, 198)">/</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">$</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string interpolation" style="color:rgb(255, 121, 198)">f</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain">))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># landing_zone_files is the list of landing zone YAML files to be processed.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># It uses the fileset function to find all files in the landing_zone_data_dir that match the pattern "landing_zone_*.yaml".</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">landing_zone_files</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> fileset(local.landing_zone_data_dir, </span><span class="token string" style="color:rgb(255, 121, 198)">"sbx_landing_zone_*.yaml"</span><span class="token plain">)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Here is an example YAML file:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> SandboxOwner1 </span><span class="token comment" style="color:rgb(98, 114, 164)"># Name of the landing zone. No spaces.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">workload</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> DevTest </span><span class="token comment" style="color:rgb(98, 114, 164)"># Type of subscription for the landing zone (DevTest vs Production (PAY AS YOU GO)). Most Sandboxes will be Production (Pay As You Go), unless all users have a Visual Studio Enterprise subscription.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">owner</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> admin@contoso.com </span><span class="token comment" style="color:rgb(98, 114, 164)"># Owner of the landing zone</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">billing_enrollment_account</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">123456</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Billing enrollment account for the landing zone. Limit of 5000 API requests for new subscriptions. Later Subscriptions may need a new billing enrollment.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">management_group_id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Unmanaged</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">Sandbox </span><span class="token comment" style="color:rgb(98, 114, 164)"># Management group ID for the landing zone</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">budget_amount</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">1000</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Budget amount for the landing zone, numerical value</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">expiry_date</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token datetime number">2024-10-16</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># The date when the landing zone will expire, the default should be 3 months from the date of provisioning. After this date, resources may be automatically cleaned up.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">cost-centre</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Contoso (Cloud) </span><span class="token comment" style="color:rgb(98, 114, 164)"># Cost center for the landing zone</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">cost-model</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> show</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">back </span><span class="token comment" style="color:rgb(98, 114, 164)"># Cost model for the landing zone</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This is a very basic example, but it gives you an idea of how you could use the module to create a Subscription and Resource Group and define Contributor access based on data from a data map that looks at each YAML file in a folder. The Expiry date is used as part of the Sandbox decommissioning process and also added as a Tag to the Subscription, along with the Owner, which can also be used as an email recipient of a Budget.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>There is a <a href="https://learn.microsoft.com/azure/cost-management-billing/manage/programmatically-create-subscription-enterprise-agreement?tabs=rest&amp;WT.mc_id=AZ-MVP-5004796#limitations-of-azure-enterprise-subscription-creation-api" target="_blank" rel="noopener noreferrer">limit</a> to the number of API requests you can make to create a new subscription, so you may need to create a new billing enrollment account if you hit this limit, which is why its included in the yaml.</p></div></div>
<p>Using this method, you can create a new Sandbox environment by creating a new YAML file, running the Terraform apply command, and decommissioning the environment by removing the YAML file and running the Terraform apply command again.</p>
<p>For the decommissioning, you can run a separate pipeline to check the expiry of the YAML file, then delete it if it's past its due date, which could then trigger the removal.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-identity-baseline">üë§ Identity Baseline<a href="https://luke.geek.nz/azure/implementing-sandbox-vending/#-identity-baseline" class="hash-link" aria-label="Direct link to üë§ Identity Baseline" title="Direct link to üë§ Identity Baseline">‚Äã</a></h2>
<p>To connect to your Sandbox environment, you need to ensure that you have the correct Identity Baseline in place.</p>
<p>I recommend you merge your Sandbox identity access, i.e. Entra ID Groups, Access packages, etc., into your IaC pipelines so that access is granted automatically when a new Sandbox environment is created and removed when no longer required.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-entitlement-management">üë• Entitlement Management<a href="https://luke.geek.nz/azure/implementing-sandbox-vending/#-entitlement-management" class="hash-link" aria-label="Direct link to üë• Entitlement Management" title="Direct link to üë• Entitlement Management">‚Äã</a></h3>
<p><a href="https://learn.microsoft.com/en-us/entra/id-governance/entitlement-management-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Entitlement management</a> is an identity governance feature that enables organizations to manage identity and access lifecycle at scale, by automating access request workflows, access assignments, reviews, and expiration.</p>
<p><img decoding="async" loading="lazy" alt="Entitlement Management" src="https://luke.geek.nz/assets/images/Azure_Sandbox_IAM_EntitlementManagement-3a3fbc032980fedbf153fe5d90324647.png" width="4000" height="2250" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-access-packages">üì¶ Access packages<a href="https://luke.geek.nz/azure/implementing-sandbox-vending/#-access-packages" class="hash-link" aria-label="Direct link to üì¶ Access packages" title="Direct link to üì¶ Access packages">‚Äã</a></h3>
<p>With an access package, an administrator or delegated access package manager lists the resources (groups, apps, and sites), and the roles the users need for those resources.
Access packages also include one or more policies. A policy defines the rules or guardrails for assigning access to an access package. Each policy can be used to ensure that only the appropriate users can have access to assignments. Access is time-limited and will expire if not renewed.</p>
<p><img decoding="async" loading="lazy" alt="Access Packages" src="https://luke.geek.nz/assets/images/Azure_Sandbox_IAM_AccessPackages-58def0c07c76fe116fd7faea813d5c17.png" width="4000" height="2250" class="img_ev3q"></p>
<p>You can use Access packages to grant access to your Sandbox environment and then remove access when the environment is no longer required.</p>
<p>Access Packages can be used to delegate access to each Sandbox environment to its owner. This allows Sandbox owners, who may have financial delegation, to control who has access to their environment and remove that access when no longer required.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-conditional-access">üîí Conditional Access<a href="https://luke.geek.nz/azure/implementing-sandbox-vending/#-conditional-access" class="hash-link" aria-label="Direct link to üîí Conditional Access" title="Direct link to üîí Conditional Access">‚Äã</a></h3>
<p>Make sure you factor Conditional Access into your Sandbox design by making sure that only the users who may be using compliant devices or from trusted networks can access the environment.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-deployment-acceleration">üöÄ Deployment Acceleration<a href="https://luke.geek.nz/azure/implementing-sandbox-vending/#-deployment-acceleration" class="hash-link" aria-label="Direct link to üöÄ Deployment Acceleration" title="Direct link to üöÄ Deployment Acceleration">‚Äã</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-onboarding-self-service">üñ•Ô∏è Onboarding self-service<a href="https://luke.geek.nz/azure/implementing-sandbox-vending/#%EF%B8%8F-onboarding-self-service" class="hash-link" aria-label="Direct link to üñ•Ô∏è Onboarding self-service" title="Direct link to üñ•Ô∏è Onboarding self-service">‚Äã</a></h3>
<p>Onboarding of a new Sandbox environment could be automated from start to end, using a self-service portal. An example is:</p>
<p>A <a href="https://learn.microsoft.com/power-apps/powerapps-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">PowerApp</a> that allows a user to request a new Sandbox environment, by filling in a form, that then triggers a <a href="https://learn.microsoft.com/power-automate/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">PowerAutomate</a> flow, to gain approval, and then creates a new YAML file, in a folder, that then triggers a Terraform apply command, to create the new Sandbox environment.</p>
<p><img decoding="async" loading="lazy" alt="Cloud Landing Zone Request - PowerApp" src="https://luke.geek.nz/assets/images/Azure_SandboxPowerApps-03eff2da8da6f063c4081fc6b8660235.png" width="1765" height="992" class="img_ev3q"></p>]]></content>
        <author>
            <name>Luke Murray</name>
            <uri>https://luke.geek.nz</uri>
        </author>
        <category label="Azure" term="Azure"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Change the Timezone of your Azure Container App]]></title>
        <id>https://luke.geek.nz/azure/change-timezone-azure-container-app/</id>
        <link href="https://luke.geek.nz/azure/change-timezone-azure-container-app/"/>
        <updated>2024-04-06T08:52:05.548Z</updated>
        <summary type="html"><![CDATA[This article provides a guide on how to change the timezone of your Azure Container App. It includes reasons why you might need to do this, a step-by-step process, and references for further reading.]]></summary>
        <content type="html"><![CDATA[<p>Updating the timezone of your Azure Container Apps containers might not be a common operation, but there are scenarios where it could be necessary.</p>
<p>Example scenarios on why you may want to update the Timezone (from UTC) to another timezone may be because of the following:</p>
<ul>
<li>Application requirements</li>
<li>Logging and debugging concerns</li>
<li>Compliance and regulations
Or general application testing and development</li>
</ul>
<p>You could have this built into the container itself, which would be preferred to keep a consistent experience and to work with any time offset that may be needed (daylight savings, etc), but you can update the container environment.</p>
<p>üì∫ To demo this, I am using a Container App Environment and a Container App using the 'Simple hello world container' quickstart image.</p>
<p>My revision mode is set to Single; however, the same steps can be applied with multiple revision modes. Just ensure you test and update the right revision or the date change may not be applied.</p>
<p>To update the timezone, we will be the 'TZ' Environment variable, and this change will trigger a new Revision.</p>
<p>First, let us check the current timezone of the container app by running the following command <em>(on a running Container App)</em> from the Console:</p>
<div class="language-PowerShell language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">    date</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Check Time/date" src="https://luke.geek.nz/assets/images/Update_AzContainerAppTimeZone-Before-95e71d7e58d2ecfc9f2acce713268128.gif" width="1820" height="964" class="img_ev3q"></p>
<p>This will return the current date and time in UTC.</p>
<p>Now, let us update the Timezone. To do that, we need to specify the timezone in the TZ database format; to find this format, we can use sites like <a href="https://en.wikipedia.org/wiki/List_of_tz_database_time_zones" target="_blank" rel="noopener noreferrer">Wikipedia</a> or <a href="https://timezone.mariushosting.com/" target="_blank" rel="noopener noreferrer">mariushosting Docker Time Zone (TZ)</a>, as I am based in New Zealand, I will be using: Pacific/Auckland.</p>
<p><img decoding="async" loading="lazy" alt="Timezone - Pacific/Auckland" src="https://luke.geek.nz/assets/images/mariushostingDockerTimeZoneNZ-1d69b9f5b7a40c3e28c103d7470619c0.png" width="1371" height="742" class="img_ev3q"></p>
<p>To do this:</p>
<div class="theme-admonition theme-admonition-danger admonition_xJq3 alert alert--danger"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>danger</div><div class="admonitionContent_BuS1"><p>‚ö†Ô∏è If you're using Single Revision mode: This may trigger an outage, during the creation of a new revision, make sure you test this in a safe environment.</p></div></div>
<ol>
<li><strong>Navigate</strong> to your <strong>Container App</strong> in the Azure Portal</li>
<li>Click on <strong>Containers</strong></li>
<li>Click <strong>Edit and Deploy</strong></li>
<li>Click your <strong>Container image</strong></li>
<li>Navigate down to <strong>Environment variables</strong></li>
<li><strong>Add</strong>: <strong>TZ</strong> with the value of your <strong>timezone</strong> <em>(Manual Entry, although you could also have this as a Secret in a KeyVault)</em>.</li>
<li>Click <strong>Save</strong></li>
<li>Click <strong>Create</strong> to create your Revision</li>
<li>You can then navigate back to the Console and type in Date to confirm the timezone has been updated.</li>
</ol>
<p><img decoding="async" loading="lazy" alt="Update Azure Container Apps - Timezone" src="https://luke.geek.nz/assets/images/Update_AzContainerAppTimeZone-a07fc34a0c2548c427afa0fcc0212b69.gif" width="1820" height="964" class="img_ev3q"></p>
<p>üìñ References:</p>
<ul>
<li><a href="https://support.circleci.com/hc/en-us/articles/115015771347-How-do-I-set-the-timezones-in-Docker-images" target="_blank" rel="noopener noreferrer">Default timezone in Docker containers</a></li>
<li><a href="https://stackoverflow.com/questions/57607381/how-do-i-change-timezone-in-a-docker-container" target="_blank" rel="noopener noreferrer">How do I change timezone in a docker container?</a></li>
</ul>]]></content>
        <author>
            <name>Luke Murray</name>
            <uri>https://luke.geek.nz</uri>
        </author>
        <category label="Azure" term="Azure"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Azure Container Apps - Overview]]></title>
        <id>https://luke.geek.nz/azure/azure-container-apps-overview/</id>
        <link href="https://luke.geek.nz/azure/azure-container-apps-overview/"/>
        <updated>2024-04-02T09:15:09.104Z</updated>
        <summary type="html"><![CDATA[Overview of Azure Container Apps and some of the Cloud Native ecosystem.]]></summary>
        <content type="html"><![CDATA[<p><a href="https://learn.microsoft.com/azure/container-apps/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Container Apps</a>, <a href="https://keda.sh/" target="_blank" rel="noopener noreferrer">KEDA</a>, and <a href="https://dapr.io/" target="_blank" rel="noopener noreferrer">Dapr</a> ‚Äî what are these, and how do they work together? This article aims to give a high-level insight into Azure Container Apps and some of the <a href="https://landscape.cncf.io/" target="_blank" rel="noopener noreferrer">Cloud Native ecosystem</a> that surrounds this container orchestrator.</p>
<p><img decoding="async" loading="lazy" alt="Azure Container Apps - Overview" src="https://luke.geek.nz/assets/images/ACA_BlogHeading_Overview-fb813fccf27d0516ff4e0a6463e03073.png" width="1280" height="720" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>‚Äú<a href="https://learn.microsoft.com/azure/container-apps/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Container Apps</a> is a fully managed <a href="https://kubernetes.io/" target="_blank" rel="noopener noreferrer">Kubernetes-based</a> application platform that helps you deploy apps from code or containers without orchestrating complex infrastructure.‚Äù</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-understanding-azure-container-apps">‚òÅÔ∏è Understanding Azure Container Apps<a href="https://luke.geek.nz/azure/azure-container-apps-overview/#%EF%B8%8F-understanding-azure-container-apps" class="hash-link" aria-label="Direct link to ‚òÅÔ∏è Understanding Azure Container Apps" title="Direct link to ‚òÅÔ∏è Understanding Azure Container Apps">‚Äã</a></h2>
<p>In this section, we will take a look at the following:</p>
<ul>
<li>Overview of Microservices</li>
<li>Getting started with Container APPS</li>
<li>Differences between ACA and other Azure container solutions</li>
</ul>
<p><img decoding="async" loading="lazy" alt="Understanding Azure Container Apps" src="https://luke.geek.nz/assets/images/ACA_Overview_UnderstandingAzContainerApps-205fbccd7ac73366d5a31d296332d0ad.png" width="1280" height="720" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p><a href="https://learn.microsoft.com/azure/container-apps/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Container Apps</a> is a fully managed serverless container service for building and deploying modern apps at scale&nbsp;- without managing infrastructure. It is built on top of Kubernetes and provides a simple, fully managed experience for deploying containerized applications.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-monoliths-microservices-and-containers-huh">ü§î Monoliths, Microservices and Containers? Huh?<a href="https://luke.geek.nz/azure/azure-container-apps-overview/#-monoliths-microservices-and-containers-huh" class="hash-link" aria-label="Direct link to ü§î Monoliths, Microservices and Containers? Huh?" title="Direct link to ü§î Monoliths, Microservices and Containers? Huh?">‚Äã</a></h3>
<p>To understand why we might need Container Apps, we need to go back to some of the elements of software development.</p>
<p>Containers can be a valuable tool for deploying and managing microservices, but they are not always necessary. Let's explore why you may not need containers for microservices and how they can generally help.</p>
<p>Microservices architecture is a software development approach where an application is built as a collection of small, loosely coupled services that can be developed, deployed, and scaled independently. Each microservice focuses on a specific business capability and communicates with other microservices through well-defined APIs.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>While containers are not always necessary for deploying microservices, they offer benefits such as isolation, portability, scalability, and deployment consistency. Evaluating your specific requirements, existing infrastructure, and resource constraints will help determine whether containers are the right choice for your microservices architecture, and is intended to help you understand how it could be used, especially around some of the Cloud Native integration components.</p></div></div>
<p><strong>Why you may not need containers for microservices:</strong></p>
<ul>
<li>Simplicity: If your microservices are developed using a single programming language or framework and can be easily deployed on traditional servers or virtual machines, containers may not be necessary. In such cases, deploying microservices directly on servers or virtual machines can be simpler and more straightforward.</li>
<li>Existing Infrastructure: If you already have a well-established infrastructure with efficient deployment processes and tools in place, containers may not be required. Leveraging your existing infrastructure can save time and effort in adopting and managing container technologies.</li>
<li>Resource Constraints: Containers introduce additional overhead in terms of resource utilization. If you have limited resources or strict resource constraints, deploying microservices directly on servers or virtual machines may be more efficient.</li>
</ul>
<p><strong>However, how containers can generally help with microservices:</strong></p>
<ul>
<li>Isolation: Containers provide a lightweight and isolated runtime environment for each microservice. This isolation ensures that changes or issues in one microservice do not affect others, improving overall system stability.</li>
<li>Portability: Containers encapsulate the dependencies and runtime environment required by a microservice, making it highly portable. Microservices packaged as containers can be easily deployed and run on different platforms, such as local development machines, cloud environments, or on-premises servers.</li>
<li>Scalability: Containers enable easy scaling of microservices. With container orchestration platforms like Kubernetes, you can dynamically scale the number of containers running a specific microservice based on demand, ensuring optimal resource utilization.</li>
<li>Deployment Consistency: Containers provide a consistent deployment model, ensuring that the microservice runs the same way across different environments. This consistency simplifies the deployment process and reduces the chances of configuration-related issues.</li>
</ul>
<p>First, let's take a look at Monoliths.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-monoliths">üè¢ Monoliths<a href="https://luke.geek.nz/azure/azure-container-apps-overview/#-monoliths" class="hash-link" aria-label="Direct link to üè¢ Monoliths" title="Direct link to üè¢ Monoliths">‚Äã</a></h4>
<p><img decoding="async" loading="lazy" alt="Azure Container Apps - What is a Monolith?" src="https://luke.geek.nz/assets/images/ACA_Overview_UnderstandingWhatIsAMonolith-1793a09d888a656f65fcd3415ca5f140.PNG" width="1280" height="720" class="img_ev3q"></p>
<p>"In software engineering, a monolithic application is a single unified software application that is self-contained and independent from other applications but typically lacks flexibility"‚ÄîWikipedia.</p>
<p><img decoding="async" loading="lazy" alt="Monolith shortcomings" src="https://luke.geek.nz/assets/images/ACA_Overview_Monolith_Shortcomings-0852c45a008051947c103f82e9761333.PNG" width="1280" height="720" class="img_ev3q"></p>
<p>Generally, monolithic architectures suffer from drawbacks that can delay application development and deployment. These drawbacks become especially significant when the product's complexity increases or when the development team grows in size.</p>
<p>The codebase of monolithic applications can be difficult to understand because it may be extensive. This can make it difficult for new developers to modify the code to meet changing business or technical requirements.</p>
<p>As requirements evolve or become more complex, it becomes difficult to correctly implement changes without hampering the code's quality and affecting the application's overall operation.</p>
<p>üìñ References:</p>
<ul>
<li><a href="https://www.techtarget.com/whatis/definition/monolithic-architecture" target="_blank" rel="noopener noreferrer">monolithic architecture</a></li>
<li><a href="https://developer.ibm.com/articles/challenges-and-patterns-for-modernizing-a-monolithic-application-into-microservices/" target="_blank" rel="noopener noreferrer">Challenges and patterns for modernizing a monolithic application into microservices</a></li>
<li><a href="https://learn.microsoft.com/azure/container-apps/microservices?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Microservices with Azure Container Apps</a></li>
</ul>
<p>Next up is Microservices, a more modular approach to software development.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-microservices">üèóÔ∏è Microservices<a href="https://luke.geek.nz/azure/azure-container-apps-overview/#%EF%B8%8F-microservices" class="hash-link" aria-label="Direct link to üèóÔ∏è Microservices" title="Direct link to üèóÔ∏è Microservices">‚Äã</a></h4>
<p>At its core, the concept of the microservices architecture is an approach to application development in which a large application is built as a collection of modular and cooperating services.</p>
<p>However, in order to successfully achieve a robust microservices architecture, the underlying infrastructure must also be correctly designed. In fact, due to the distributed nature of the microservices architecture, the line between what used to be separate application details and implementation details grows blurrier.</p>
<p>Containers simplify the continuous deployment of microservices.</p>
<p><img decoding="async" loading="lazy" alt="What are Microservices" src="https://luke.geek.nz/assets/images/ACA_Overview_UnderstandingWhatIsMicroservices-c649f3bd42065f6d2439d34cbb23d463.PNG" width="1280" height="720" class="img_ev3q"></p>
<p>üìñ References:</p>
<ul>
<li><a href="https://hackernoon.com/https-medium-com-spruha-pandya-of-microservices-containers-6f0ea25dac3" target="_blank" rel="noopener noreferrer">Of Microservices &amp; Containers</a></li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-deployment-modes">üöÄ Deployment modes<a href="https://luke.geek.nz/azure/azure-container-apps-overview/#-deployment-modes" class="hash-link" aria-label="Direct link to üöÄ Deployment modes" title="Direct link to üöÄ Deployment modes">‚Äã</a></h4>
<p>The deployment of microservices and traditional monolith applications is usually done separately, which is an oversimplification.</p>
<p><img decoding="async" loading="lazy" alt="Monolith shortcomings" src="https://luke.geek.nz/assets/images/ACA_Overview_UnderstandingMonolithMicroservices-5f33f10c9f723eff8a5c2bef55f67e93.gif" width="1905" height="964" class="img_ev3q"></p>
<table><thead><tr><th>Aspect</th><th>Microservices</th><th>Monolith Application</th></tr></thead><tbody><tr><td>Service instantiation</td><td>Instantiate services instead of spinning up new machines =&gt; faster</td><td>Spinning up new machines for each instance =&gt; slower</td></tr><tr><td>Hardware utilization</td><td>Better utilization of hardware</td><td>Less efficient utilization of hardware</td></tr><tr><td>Cost</td><td>Optimized cost due to efficient resource usage</td><td>Potentially higher cost due to inefficient resource usage</td></tr><tr><td>Time to market</td><td>Lower time to market: more confident when it comes to upgrading a service</td><td>Higher time to market: less confident when it comes to upgrading a service</td></tr><tr><td>Independence</td><td>Services are independently implemented, deployed, scaled, and versioned</td><td>All components are tightly coupled and scaled together</td></tr></tbody></table>
<p><strong>So, let's take a look at how Microservices and Containers can work together.</strong></p>
<p>Let‚Äôs delve into the differences between&nbsp;microservices&nbsp;and&nbsp;containers:</p>
<table><thead><tr><th>Aspect</th><th>Microservices</th><th>Containers</th></tr></thead><tbody><tr><td>Definition</td><td>Microservices are an architectural style that breaks down an application into small, autonomous services. These services communicate via well-defined interfaces using lightweight APIs.</td><td>A container is a technology that bundles an application along with all its dependencies into a package. This package allows the application to be deployed consistently across different environments, abstracting away differences in operating systems and underlying infrastructure.</td></tr><tr><td>Structure</td><td>Microservices are self-contained and encapsulate their logic. They interact through well-defined interfaces, allowing independent development and deployment.</td><td>Containers ride on a host operating system, similar to virtual machines (VMs), but they share the OS kernel. This makes them lighter and faster to boot than VMs. Containers are hosted on a container runtime, which enables multiple containers (each several megabytes in size) to run on a single server.</td></tr><tr><td>Popular Tools</td><td>Microservices can be developed with various programming languages and frameworks.</td><td>Docker is a well-known commercial container management solution, while Kubernetes (often referred to as K8s) is a widely used free and open-source container management system.</td></tr><tr><td>Pros</td><td>Enhance maintainability, testability, and scalability. Organized around business capabilities and are typically owned by small teams.</td><td>Excellent for packaging and deploying applications consistently, regardless of the environment. More lightweight and faster to boot than VMs.</td></tr><tr><td>Cons</td><td>Complexity in managing multiple services. Need for coordination and communication between services.</td><td>Requires knowledge of container management and orchestration tools. Potential security risks if not properly isolated.</td></tr><tr><td>Use Case</td><td>Suitable for building modular, scalable applications.</td><td>Provides the infrastructure for running microservices, ensuring consistent deployment and management across different environments.</td></tr></tbody></table>
<p><img decoding="async" loading="lazy" alt="microservices&nbsp;and&nbsp;containers" src="https://luke.geek.nz/assets/images/ACA_Overview_UnderstandingMicroservicesandContainers-67eb803db2d2e482c2f45d0b80ded74d.PNG" width="1280" height="720" class="img_ev3q"></p>
<p>Containers provide the infrastructure for running microservices, ensuring consistent deployment and management across different environments.&nbsp;Microservices, on the other hand, define the architectural approach for building modular, scalable applications.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-container-orchestration">üéõÔ∏è Container orchestration<a href="https://luke.geek.nz/azure/azure-container-apps-overview/#%EF%B8%8F-container-orchestration" class="hash-link" aria-label="Direct link to üéõÔ∏è Container orchestration" title="Direct link to üéõÔ∏è Container orchestration">‚Äã</a></h3>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Container orchestration is required to transition from deploying containers individually on a single host, to deploying complex multi-container apps on many machines. It requires a distributed platform, independent from infrastructure, that stays online through the entire lifetime of your application, surviving hardware failure and software updates.</p></div></div>
<p><img decoding="async" loading="lazy" alt="Container orchastration" src="https://luke.geek.nz/assets/images/ACA_Overview_UnderstandingContainerOrchastration-77949c4d372a4784d69f5e041c8b6e84.PNG" width="1280" height="720" class="img_ev3q"></p>
<p>Existing Container orchestration solutions include the following:</p>
<table><thead><tr><th>Solution</th><th>Description</th><th>Pros</th><th>Cons</th></tr></thead><tbody><tr><td>Kubernetes</td><td>An open-source platform designed to automate deploying, scaling, and operating application containers.</td><td>Highly flexible and customizable. Large community support.</td><td>Complexity in setup and management.</td></tr><tr><td>Docker Swarm</td><td>Docker's own native container orchestration.</td><td>Easy to set up. Integrated into Docker CLI.</td><td>Limited functionality compared to Kubernetes.</td></tr><tr><td>Amazon ECS</td><td>A highly scalable, high-performance container orchestration service that supports Docker containers.</td><td>Deep integration with AWS services.</td><td>Only available on AWS.</td></tr><tr><td>Azure Kubernetes Service (AKS)</td><td>Managed Kubernetes service provided by Azure.</td><td>Deep integration with Azure services. Managed Kubernetes with less operational complexity.</td><td>Only available on Azure.</td></tr><tr><td>Azure Container Apps</td><td>A serverless container service that enables you to run containerized applications at scale.</td><td>Serverless, event-driven, and supports Linux containers. Deep integration with Azure services.</td><td>Only available on Azure.</td></tr></tbody></table>
<p><strong>So, what is Container orchestration?</strong></p>
<p><img decoding="async" loading="lazy" alt="Container orchastration" src="https://luke.geek.nz/assets/images/ACA_Overview_WhatisContainerOrchastration-963aa3154bb30dbbd3198166a652e57e.gif" width="1905" height="964" class="img_ev3q"></p>
<p>Container orchestration&nbsp;plays a crucial role in managing and scaling containerized applications. Here are some reasons why it‚Äôs essential:</p>
<table><thead><tr><th>Feature</th><th>Description</th></tr></thead><tbody><tr><td>Scaling and Load Balancing</td><td>Container orchestration tools like Kubernetes allow you to dynamically scale your application by adding or removing containers based on demand. Load balancing ensures that incoming requests are distributed evenly across containers, preventing overload on any single instance.</td></tr><tr><td>High Availability</td><td>Orchestration ensures that your application remains available even if individual containers fail. It automatically restarts failed containers or replaces them with healthy ones.</td></tr><tr><td>Service Discovery and DNS</td><td>Containers come and go, making it challenging to keep track of their IP addresses. Orchestration tools provide service discovery and DNS resolution, allowing containers to find each other by name.</td></tr><tr><td>Rolling Updates and Rollbacks</td><td>When deploying new versions of your application, orchestration allows for rolling updates. You can gradually replace old containers with new ones, minimizing downtime. In case of issues, you can easily roll back to a previous version.</td></tr><tr><td>Configuration Management</td><td>Orchestration tools manage environment variables, secrets, and other configuration settings for containers. This centralizes configuration management and ensures consistency.</td></tr><tr><td>Resource Optimization</td><td>Orchestration optimizes resource utilization by scheduling containers efficiently across nodes. It balances CPU, memory, and storage requirements.</td></tr><tr><td>Networking and Security</td><td>Orchestration handles networking, including creating virtual networks for communication between containers. It also manages security policies, access controls, and network segmentation.</td></tr><tr><td>Monitoring and Logging</td><td>Container orchestration platforms provide monitoring dashboards and logs. You can track performance, troubleshoot issues, and gain insights into your application.</td></tr></tbody></table>
<p>Container orchestration simplifies deployment, enhances reliability, and ensures efficient management of containerized applications.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-container-apps">üëë Container Apps<a href="https://luke.geek.nz/azure/azure-container-apps-overview/#-container-apps" class="hash-link" aria-label="Direct link to üëë Container Apps" title="Direct link to üëë Container Apps">‚Äã</a></h2>
<p><a href="https://learn.microsoft.com/azure/container-apps/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Container Apps</a>&nbsp;is a&nbsp;serverless platform&nbsp;that simplifies running containerized applications</p>
<ol>
<li>Azure Container Apps allows you to focus on your application logic without worrying about server configuration, container orchestration, or deployment details.</li>
<li>It reduces operational complexity and saves costs by providing up-to-date server resources.</li>
<li>Common use cases include deploying API endpoints, handling background processing jobs, event-driven processing, and running microservices.</li>
</ol>
<p><img decoding="async" loading="lazy" alt="Azure Container Apps" src="https://luke.geek.nz/assets/images/ACA_Overview_AzContainerApps-a3e602470b025818a294eafad1517428.gif" width="1905" height="964" class="img_ev3q"></p>
<p><strong>You may be wondering what sort of applications you can build with Azure Container Apps.</strong></p>
<p>Here are some common ones including:</p>
<ul>
<li>Deploying API endpoints</li>
<li>Hosting background processing applications</li>
<li>Handling event-driven processing</li>
<li>Running microservices</li>
</ul>
<p>With each of those applications, you can dynamically scale based on:</p>
<ul>
<li>HTTP traffic</li>
<li>Event-driven processing</li>
<li>CPU or memory load</li>
<li>Any&nbsp;KEDA-supported scaler</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-what-are-the-differences-between-azure-container-apps-and-other-container-solutions">ü§î What are the differences between Azure Container Apps and other Container solutions?<a href="https://luke.geek.nz/azure/azure-container-apps-overview/#-what-are-the-differences-between-azure-container-apps-and-other-container-solutions" class="hash-link" aria-label="Direct link to ü§î What are the differences between Azure Container Apps and other Container solutions?" title="Direct link to ü§î What are the differences between Azure Container Apps and other Container solutions?">‚Äã</a></h3>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Azure customers can easily deploy microservices using either Azure Kubernetes Service for flexible customized container solutions or Azure Container Apps for productivity-optimized, fully-managed serverless container solutions. Azure delivers app portability to support business growth powered by open source in the Kubernetes ecosystem.</p></div></div>
<p>Azure Container Apps is built on a foundation of powerful open-source technology to deliver the same microservices benefits as Kubernetes as a fully managed and serverless app hosting option. Behind the scenes, every container app runs on Azure Kubernetes Service, with Kubernetes Event Driven Autoscaling (KEDA), Distributed Application Runtime (Dapr), and Envoy deeply integrated in the hosting service. However, developers and operators are not exposed to this underlying Kubernetes infrastructure. The open-source-centric approach enables a path for teams to build microservices without having to overcome the concept and operational overhead of working with Kubernetes directly and enables continued app portability by leveraging open standards and APIs</p>
<p><img decoding="async" loading="lazy" alt="Azure Conter Apps and AKS" src="https://luke.geek.nz/assets/images/ACA_Overview_UnderstandingAKSACA-d685034136047b286b4be51d6fc65761.PNG" width="1280" height="720" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="Azure Conter Apps and AKS" src="https://luke.geek.nz/assets/images/ACA_Overview_UnderstandingAKS-282ccb1a916c18f70a5c7eb248f62f89.PNG" width="1280" height="720" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="Azure Conter Apps and AKS" src="https://luke.geek.nz/assets/images/ACA_Overview_UnderstandingAKSCompareACA-07ff2cbab2f5c7dd977e7a3afbf00510.PNG" width="1280" height="720" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="building-azure-container-apps">‚ö°Building Azure Container Apps<a href="https://luke.geek.nz/azure/azure-container-apps-overview/#building-azure-container-apps" class="hash-link" aria-label="Direct link to ‚ö°Building Azure Container Apps" title="Direct link to ‚ö°Building Azure Container Apps">‚Äã</a></h2>
<p>Now that we know where Azure Container Apps fits in the Cloud Native ecosystem let's take a look at potential tools for building Azure Container Apps.</p>
<p><img decoding="async" loading="lazy" alt="Building Azure Container Apps" src="https://luke.geek.nz/assets/images/ACA_Overview_BuildingContainerAppsApps-18270a1aa314452d6520950c24fbc954.PNG" width="1280" height="720" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-azure-container-app-deployment-options">üöÄ Azure Container App Deployment options<a href="https://luke.geek.nz/azure/azure-container-apps-overview/#-azure-container-app-deployment-options" class="hash-link" aria-label="Direct link to üöÄ Azure Container App Deployment options" title="Direct link to üöÄ Azure Container App Deployment options">‚Äã</a></h3>
<p>Although anything that can connect to the Azure APIs can essentially create a <a href="https://learn.microsoft.com/azure/container-apps/environment?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Container App Environment</a>, common tools are:</p>
<ul>
<li><a href="https://learn.microsoft.com/azure/container-apps/quickstart-portal?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Portal Deployment</a></li>
<li><a href="https://learn.microsoft.com/azure/container-apps/containerapp-up?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure CLI deployment</a></li>
<li><a href="https://learn.microsoft.com/azure/container-apps/azure-resource-manager-api-spec?tabs=arm-template&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">ARM template deployment</a></li>
<li><a href="https://learn.microsoft.com/azure/templates/microsoft.app/containerapps?pivots=deployment-language-bicep&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Bicep template deployment</a></li>
<li><a href="https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/container_app" target="_blank" rel="noopener noreferrer">Terraform template deployment</a></li>
<li><a href="https://www.pulumi.com/registry/packages/azure-native/api-docs/app/containerapp/" target="_blank" rel="noopener noreferrer">Pulumi</a> or other API tools</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-container-app-environments">üåê Container App environments<a href="https://luke.geek.nz/azure/azure-container-apps-overview/#-container-app-environments" class="hash-link" aria-label="Direct link to üåê Container App environments" title="Direct link to üåê Container App environments">‚Äã</a></h3>
<p>But before you jump into the tools to create, you need to understand what you will be deploying and building, so let us take a look at <a href="https://learn.microsoft.com/azure/container-apps/environment?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Container App Environments</a>.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>A Container app environment is a secure boundary around groups of container apps that share the same virtual network and write logs to the same logging destination.</p><p>Container app environments are fully managed, where Azure handles OS upgrades, scale operations, failover procedures, and resource balancing.</p></div></div>
<table><thead><tr><th>Reasons to deploy container apps to the same environment</th><th>Reasons to deploy container apps to different environments</th></tr></thead><tbody><tr><td>Manage related services</td><td>Two applications never share the same compute resources</td></tr><tr><td>Deploy different applications to the same virtual network</td><td>Two Dapr applications can't communicate via the Dapr service invocation API</td></tr><tr><td>Instrument Dapr applications that communicate via the Dapr service invocation API</td><td></td></tr><tr><td>Have applications to share the same Dapr configuration</td><td></td></tr><tr><td>Have applications share the same log analytics workspace</td><td></td></tr><tr><td>Provide an existing virtual network when you create an environment</td><td></td></tr></tbody></table>
<p><img decoding="async" loading="lazy" alt="Container App Environment" src="https://luke.geek.nz/assets/images/ACA_Overview_ContainerAppEnvironments-79a5150c878526f386f697edcc9080c0.gif" width="1892" height="964" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-container-types">üì¶ Container Types<a href="https://luke.geek.nz/azure/azure-container-apps-overview/#-container-types" class="hash-link" aria-label="Direct link to üì¶ Container Types" title="Direct link to üì¶ Container Types">‚Äã</a></h4>
<p>Azure Container Apps supports two types of Containers.</p>
<p>App Container <em>(Sidecar)</em> - The container that runs your application code
Init Containers - Containers that run before the app container starts</p>
<p><img decoding="async" loading="lazy" alt="Azure Container Apps - Container Types" src="https://luke.geek.nz/assets/images/ACA_Overview_BuildingContainerAppContainerTypes-a73e87e6c2c991b81ae6a5b89667a676.PNG" width="1280" height="720" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-container-registry">üì¶ Container registry<a href="https://luke.geek.nz/azure/azure-container-apps-overview/#-container-registry" class="hash-link" aria-label="Direct link to üì¶ Container registry" title="Direct link to üì¶ Container registry">‚Äã</a></h4>
<p>Azure Container Apps supports multiple container registries, including:</p>
<ul>
<li><a href="https://azure.microsoft.com/products/container-registry?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Container Registry</a></li>
<li><a href="https://hub.docker.com/" target="_blank" rel="noopener noreferrer">Docker Hub</a> and other registries.</li>
</ul>
<p>Public and private registries, i.e., Azure Container Registry, are on a private endpoint.</p>
<p><img decoding="async" loading="lazy" alt="Azure Container Apps - Container Registries" src="https://luke.geek.nz/assets/images/ACA_Overview_BuildingContainerAppContainerRegistry-ad0e16d654fac9164f55ce87fbf12d42.PNG" width="1280" height="720" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-container-revisions">üîÑ Container Revisions<a href="https://luke.geek.nz/azure/azure-container-apps-overview/#-container-revisions" class="hash-link" aria-label="Direct link to üîÑ Container Revisions" title="Direct link to üîÑ Container Revisions">‚Äã</a></h4>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Azure Container Apps implements container app versioning by creating <a href="https://learn.microsoft.com/azure/container-apps/revisions?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">revisions</a>. A revision is an immutable snapshot of a container app version.</p></div></div>
<p>The first revision is automatically provisioned when you deploy your container app.
New revisions are automatically provisioned when you make a&nbsp;revision-scope&nbsp;change to your container app.
While revisions are immutable, they're affected by&nbsp;application-scope&nbsp;changes, which apply to all revisions.
You can create new revisions by updating a previous revision.
You can retain up to 100 revisions, giving you a historical record of your container app updates.
You can run multiple revisions concurrently.
You can split external HTTP traffic between active revisions.</p>
<p><img decoding="async" loading="lazy" alt="Container App Revisions" src="https://luke.geek.nz/assets/images/ACA_Overview_BuildingContainerAppRevisions-b2412f888e36fbff019990168ac180ba.PNG" width="1280" height="720" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="Container App Revisions" src="https://luke.geek.nz/assets/images/ACA_Overview_ContainerAppRevisions-c45d1218ba550ac15ace569db3a2a05b.gif" width="1892" height="964" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-container-shutdowns">‚èπÔ∏è Container shutdowns<a href="https://luke.geek.nz/azure/azure-container-apps-overview/#%EF%B8%8F-container-shutdowns" class="hash-link" aria-label="Direct link to ‚èπÔ∏è Container shutdowns" title="Direct link to ‚èπÔ∏è Container shutdowns">‚Äã</a></h4>
<p>It's worth noting how your Containers will shut down as Azure Container Apps scales your Apps or you deactivate a revision, as this can affect your application.</p>
<p>The containers are shut down in the following situations:</p>
<ul>
<li>As a container app scales in</li>
<li>As a container app is being deleted</li>
<li>As a revision is being deactivated</li>
</ul>
<p>When a shutdown is initiated, the container host sends a SIGTERM message to your container. The code implemented in the container can respond to this operating system-level message to handle termination.</p>
<p>If your application doesn't respond within 30 seconds to the SIGTERM message, then SIGKILL terminates your container.</p>
<p>Additionally, make sure your application can gracefully handle shutdowns. Containers restart regularly, so don't expect the state to persist inside a container. Instead, use external caches for expensive in-memory cache requirements.</p>
<p>üìñ References:</p>
<ul>
<li><a href="https://learn.microsoft.com/azure/container-apps/application-lifecycle-management?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Application lifecycle management in Azure Container Apps</a></li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-secret-management">üîí Secret Management<a href="https://luke.geek.nz/azure/azure-container-apps-overview/#-secret-management" class="hash-link" aria-label="Direct link to üîí Secret Management" title="Direct link to üîí Secret Management">‚Äã</a></h4>
<p>Securely store sensitive configuration elements that are then available to containers through environment variables, scale rules, and Dapr.</p>
<p><img decoding="async" loading="lazy" alt="Azure Container Apps - Secret Management" src="https://luke.geek.nz/assets/images/ACA_Overview_BuildingContainerAppSecretManagement-1d4e811be73673cdc3a3b152bd05c134.PNG" width="1280" height="720" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="Azure Container Apps - Secrets" src="https://luke.geek.nz/assets/images/ACA_Overview_Secrets-776fffb4f69c745c60f6d447a87bd07e.gif" width="1892" height="964" class="img_ev3q"></p>
<p>Those environment variables can also reference an <a href="https://azure.microsoft.com/products/key-vault?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Key Vault</a>. For further information, refer to the following Microsoft documentation: <a href="https://learn.microsoft.com/azure/container-apps/manage-secrets?tabs=azure-portal&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Manage secrets in Azure Container Apps</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-cloud-native-ecosystem">‚òÅÔ∏è Cloud Native Ecosystem<a href="https://luke.geek.nz/azure/azure-container-apps-overview/#%EF%B8%8F-cloud-native-ecosystem" class="hash-link" aria-label="Direct link to ‚òÅÔ∏è Cloud Native Ecosystem" title="Direct link to ‚òÅÔ∏è Cloud Native Ecosystem">‚Äã</a></h2>
<p>Azure Container Apps integrates several Cloud Native technologies, including <a href="https://keda.sh/" target="_blank" rel="noopener noreferrer">KEDA</a> and <a href="https://dapr.io/" target="_blank" rel="noopener noreferrer">Dapr</a>, to provide a fully managed serverless container service.</p>
<p>These technologies are part of the <a href="https://www.cncf.io/" target="_blank" rel="noopener noreferrer">Cloud Native Computing Foundation</a> and designed to help developers build and deploy modern applications at scale.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-dapr">üëï Dapr<a href="https://luke.geek.nz/azure/azure-container-apps-overview/#-dapr" class="hash-link" aria-label="Direct link to üëï Dapr" title="Direct link to üëï Dapr">‚Äã</a></h3>
<p><a href="https://dapr.io/" target="_blank" rel="noopener noreferrer">Dapr (Distributed Application Runtime)</a> is a portable, event-driven runtime for building distributed applications across the cloud and edge.</p>
<p><img decoding="async" loading="lazy" alt="Azure Container Apps - Dapr" src="https://luke.geek.nz/assets/images/ACA_Overview_UnderstandingDaprIntegration-51d3b98ecf5eb8623bbf378b1e4496f9.PNG" width="1280" height="720" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p><a href="https://techcommunity.microsoft.com/t5/microsoft-developer-community/open-at-microsoft-dapr/ba-p/3857064?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Dapr</a> is a new way to build modern distributed applications. Born at Microsoft in 2019 as an incubation project, it was donated to the Cloud Native Computing Foundation in 2021 and is now a highly successful open-source project. Dapr helps you write flexible and secure microservices that leverage industry-proven best practices to build connected distributed applications faster. By letting Dapr‚Äôs sidecar take care of the complex challenges such as service discovery, message broker integration, encryption, observability, and secret management, you can focus on business logic and keep your code simple.</p></div></div>
<p>Dapr is a set of integrated APIs with built-in best practices and patterns to build distributed applications. Dapr increases your developer productivity by 20-40% with out-of-the-box features such as workflow, pub/sub, state management, secret stores, external configuration, bindings, actors, distributed lock, and cryptography. You benefit from the built-in security, reliability, and observability capabilities, so you don't need to write boilerplate code to achieve production-ready applications.
Dapr's component model decouples the integrated API with the underlying resources. For instance, when you're using the Dapr publish-subscribe API, you can change the message broker by swapping out a yaml component file to switch from RabbitMQ to Kafka (or any other supported broker) without changing your application code.</p>
<p><img decoding="async" loading="lazy" alt="Dapr High-level" src="https://luke.geek.nz/assets/images/ACA_Overview_UnderstandingDaprIntegrationHigh_Level-8874086ad4f069eb6cc5093d1edf7288.PNG" width="1280" height="720" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="Dapr Building Blocks" src="https://luke.geek.nz/assets/images/ACA_Overview_UnderstandingDaprIntegrationBuildingBlocks-4b37cc5f906373111cdd120ddff5bb8d.PNG" width="1280" height="720" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="Dapr Sidecar architecture" src="https://luke.geek.nz/assets/images/ACA_Overview_UnderstandingDaprIntegrationSidecar-3b89ef6c3cfb222f075e6a3491542592.PNG" width="1280" height="720" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="Dapr Sidecar architecture - Container Apps" src="https://luke.geek.nz/assets/images/ACA_Overview_UnderstandingDaprIntegrationSidecarContainerApps-045b1c3c8af04737d3eddee7004ef906.PNG" width="1280" height="720" class="img_ev3q"></p>
<p>Dapr integration is built into Azure Container Apps, so you can focus on building your application without worrying about the underlying infrastructure. Dapr operates as a sidecar alongside your application, providing features only where needed.</p>
<p>Dapr integration is available straight from the Azure Portal for both the Envirionment and Container App itself.</p>
<p><img decoding="async" loading="lazy" alt="Azure Container Apps - Dapr Portal Integration" src="https://luke.geek.nz/assets/images/ACA_Overview_UnderstandingDaprIntegrationContainerAppPortalIntegration-7a2e6a382c9f8feebae438ce3ef9446f.gif" width="1892" height="964" class="img_ev3q"></p>
<p>Also, make sure to check out <a href="https://learn.microsoft.com/azure/container-apps/dapr-component-resiliency?tabs=bicep&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Dapr component resiliency</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-keda">üìö KEDA<a href="https://luke.geek.nz/azure/azure-container-apps-overview/#-keda" class="hash-link" aria-label="Direct link to üìö KEDA" title="Direct link to üìö KEDA">‚Äã</a></h3>
<p><a href="https://keda.sh/" target="_blank" rel="noopener noreferrer">KEDA (Kubernetes-based Event-Driven Autoscaling)</a> is a Kubernetes-based event-driven autoscaling component.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>KEDA is a Kubernetes-based Event Driven Autoscaler. With KEDA, you can drive the scaling of any container in Kubernetes based on the number of events needing to be processed.</p></div></div>
<p><img decoding="async" loading="lazy" alt="Azure Container Apps - KEDA" src="https://luke.geek.nz/assets/images/ACA_Overview_UnderstandingKEDAlntegration-23b4683fba11a70182de2748395659b0.png" width="1427" height="936" class="img_ev3q"></p>
<p>KEDA (Kubernetes-based Event Driven Autoscaling) is an open-source project that provides event-driven autoscaling for Kubernetes workloads. KEDA can scale any container in response to events from various sources such as Azure Service Bus, Azure Event Hubs, Azure Storage Queues, Azure Storage Blobs, RabbitMQ, Kafka, and more.</p>
<p>An example of KEDA event scaling is being able to scale your Containers based on KEDA scalers, such as Azure DevOps pipelines. You can refer to a previous blog post I did on leveraging KEDA scalers with <a href="https://luke.geek.nz/azure/hosted-agents-container-apps-job/" target="_blank" rel="noopener noreferrer">Container App Jobs to create Self-Hosted Azure DevOps Agents</a>.</p>
<p>KEDA really opens up the possibilities of scaling your Containers, based on events, and is a great addition to Azure Container Apps, and like DAPR KEDA is built-in to Azure Container Apps and managed by Microsoft.</p>
<p><img decoding="async" loading="lazy" alt="KEDA" src="https://luke.geek.nz/assets/images/ACA_Overview_KEDA-5791552cd0c716630523e3eaf7f28104.gif" width="1892" height="964" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-azure-container-apps-networking--storage">üíª Azure Container Apps Networking &amp; Storage<a href="https://luke.geek.nz/azure/azure-container-apps-overview/#-azure-container-apps-networking--storage" class="hash-link" aria-label="Direct link to üíª Azure Container Apps Networking &amp; Storage" title="Direct link to üíª Azure Container Apps Networking &amp; Storage">‚Äã</a></h2>
<p>Now, let us talk about Networking and Storage.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-networking">üåê Networking<a href="https://luke.geek.nz/azure/azure-container-apps-overview/#-networking" class="hash-link" aria-label="Direct link to üåê Networking" title="Direct link to üåê Networking">‚Äã</a></h3>
<p><img decoding="async" loading="lazy" alt="Azure Container Apps - Networking Overview" src="https://luke.geek.nz/assets/images/ACA_Overview_NetworkArchitecture_HighLevel-7aadcc2f1d5c36baa4bb333702bb2c44.PNG" width="1280" height="720" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p><a href="https://learn.microsoft.com/azure/container-apps/networking?tabs=workload-profiles-env%2Cazure-cli&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Container Apps run in the context of an environment</a>, which is supported by a virtual network (VNET).</p><p>When you create an environment, you can provide a custom VNET, otherwise a VNET is automatically generated for you. Generated VNETs are inaccessible to you as they're created in Microsoft's tenant.</p><p>To take full control over your VNET, provide an existing VNET to Container Apps as you create your environment.</p></div></div>
<p><img decoding="async" loading="lazy" alt="Azure Container Apps - Networking Overview" src="https://luke.geek.nz/assets/images/ACA_Overview_NetworkArchitecture_HighLevel2-00aaf617bfe6da080d8856ca330f58ec.PNG" width="1280" height="720" class="img_ev3q"></p>
<p><strong>Accessibility levels</strong></p>
<p>Using internal and external accessibility levels, you can configure whether your container app allows public ingress or ingress only from within your VNet at the environment level.</p>
<p><img decoding="async" loading="lazy" alt="Azure Container Apps - Accessibility levels" src="https://luke.geek.nz/assets/images/ACA_Overview_NetworkAccessibilitylevels-7f9007f566651c94cb6c726b80fa90c9.PNG" width="1280" height="720" class="img_ev3q"></p>
<p>Custom VNET (Virtual Network) integration</p>
<p>If you want your container app to restrict all outside access, create an&nbsp;internal Container app environment.</p>
<p>When you provide your own VNet, you need to provide a subnet that is dedicated to the Container App environment you deploy. This subnet isn't available to other services.</p>
<p>Network addresses are assigned from a subnet range you define as the environment is created.</p>
<p>You can define the subnet range used by the Container Apps environment.</p>
<p>You can restrict inbound requests to the environment exclusively to the VNet by deploying the environment internally.</p>
<p><strong>User-defined routes</strong></p>
<p>User-defined routes (UDR) and controlled egress through NAT Gateway are supported in the workload profiles environment. These features aren't supported in the consumption-only environment.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>When using UDR with Azure Firewall in Azure Container Apps, you need to add certain FQDNs and service tags to the firewall's allowlist. To learn more, see <a href="https://learn.microsoft.com/azure/container-apps/networking?WT.mc_id=AZ-MVP-5004796#configuring-udr-with-azure-firewall" target="_blank" rel="noopener noreferrer">configuring UDR with Azure Firewall</a>.</p></div></div>
<p><strong>Envoy</strong></p>
<p>Azure Container Apps uses <a href="https://www.envoyproxy.io/" target="_blank" rel="noopener noreferrer">Envoy proxy</a> <em>(also part of the Cloud Native Computing Foundation)</em> as an edge HTTP proxy. TLS is terminated on the edge, and requests are routed based on their traffic splitting rules, which route traffic to the correct application.</p>
<p>Azure Container Apps uses Envoy as a network proxy for all HTTP requests. Envoy provides some capabilities such as:</p>
<ul>
<li>Scaling to zero: Envoy allows your container apps to scale to zero instances when there is no traffic and scale up when there is demand. Envoy acts as a buffer between the clients and the container apps and handles the cold start latency.</li>
<li>HTTPS redirection: Envoy automatically redirects all HTTP requests to HTTPS, ensuring secure communication between the clients and the container apps.</li>
<li>TLS termination: Envoy terminates the transport layer security (TLS) at the edge of the container app environment and forwards the requests to the container apps over plain HTTP. This reduces the overhead of encryption and decryption for the container apps.</li>
<li>Mutual TLS: Envoy supports mutual TLS (mTLS) when you use Dapr as a sidecar for your container apps. mTLS provides an additional layer of security by requiring both the client and the server to present valid certificates for authentication.</li>
<li>Ingress controls: Envoy allows you to configure some ingress controls for your container apps, such as IP restrictions, CORS, WAF, etc.</li>
</ul>
<p><img decoding="async" loading="lazy" alt="Azure Container Apps - Envoy" src="https://luke.geek.nz/assets/images/ACA_Overview_NetworkEnvoy-d7ffd0c40db8ff122a3dbc2f9ba8e54d.gif" width="1892" height="964" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="Azure Container Apps - Network Lockdown" src="https://luke.geek.nz/assets/images/ACA_Overview_Networklockdown-35aa92cc1fb855c18cabfacd07f80a33.PNG" width="1280" height="720" class="img_ev3q"></p>
<p>üìñ References:</p>
<ul>
<li><a href="https://learn.microsoft.com/azure/container-apps/networking?tabs=workload-profiles-env%2Cazure-cli&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Networking in Azure Container Apps environment</a></li>
<li><a href="https://techcommunity.microsoft.com/t5/startups-at-microsoft/from-chaos-to-clarity-simplifying-your-networking-with-azure/ba-p/4034625?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">From Chaos to Clarity: Simplifying Your Networking with Azure Container Apps</a></li>
<li><a href="https://learn.microsoft.com/azure/container-apps/networking?tabs=consumption-only-env%2Cazure-cli&amp;WT.mc_id=AZ-MVP-5004796#user-defined-routes-udr" target="_blank" rel="noopener noreferrer">User defined routes (UDR)</a></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-storage">üíæ Storage<a href="https://luke.geek.nz/azure/azure-container-apps-overview/#-storage" class="hash-link" aria-label="Direct link to üíæ Storage" title="Direct link to üíæ Storage">‚Äã</a></h3>
<p>A container app has access to different types of storage. A single app can take advantage of more than one type of storage if necessary.</p>
<p><img decoding="async" loading="lazy" alt="Azure Container Apps - Storage" src="https://luke.geek.nz/assets/images/ACA_Overview_Storage-807107196bc8e44a8ce8602ebfae8cb3.gif" width="1892" height="964" class="img_ev3q"></p>
<p>üìñ References:</p>
<ul>
<li><a href="https://learn.microsoft.com/azure/container-apps/storage-mounts?pivots=azure-cli&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Use storage mounts in Azure Container Apps</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-observability">üëÄ Observability<a href="https://luke.geek.nz/azure/azure-container-apps-overview/#-observability" class="hash-link" aria-label="Direct link to üëÄ Observability" title="Direct link to üëÄ Observability">‚Äã</a></h2>
<p>Azure Container Apps provides several built-in observability features that together give you a holistic view of your container app‚Äôs health throughout its application lifecycle</p>
<p>These features help in monitoring and diagnosing the state of the application to improve performance and respond to trends and critical problems.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-application-lifecycle-observability">üëÅÔ∏è Application lifecycle observability<a href="https://luke.geek.nz/azure/azure-container-apps-overview/#%EF%B8%8F-application-lifecycle-observability" class="hash-link" aria-label="Direct link to üëÅÔ∏è Application lifecycle observability" title="Direct link to üëÅÔ∏è Application lifecycle observability">‚Äã</a></h3>
<table><thead><tr><th>Phase</th><th>Features</th><th>Description</th></tr></thead><tbody><tr><td>Development and Test</td><td>Log streaming, Container console</td><td>Real-time access to containers' application logs and console for debugging issues</td></tr><tr><td>Deployment</td><td>Azure Monitor metrics, Azure Monitor alerts, Azure Monitor Log Analytics</td><td>Continuous monitoring after deployment for identifying problems around error rates, performance, and resource consumption</td></tr><tr><td>Maintenance</td><td>Azure Monitor metrics, Azure Monitor alerts, Azure Monitor Log Analytics</td><td>Manages updates to your container app by creating revisions. Allows running multiple revisions concurrently for blue green deployments or A/B testing. Helps in monitoring applications across revisions</td></tr></tbody></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-azure-landing-zone-for-container-apps">üè° Azure Landing Zone for Container Apps<a href="https://luke.geek.nz/azure/azure-container-apps-overview/#-azure-landing-zone-for-container-apps" class="hash-link" aria-label="Direct link to üè° Azure Landing Zone for Container Apps" title="Direct link to üè° Azure Landing Zone for Container Apps">‚Äã</a></h2>
<p>Last but not least, now that we have investigated and examined some of the finer points of Azure Container Apps, we need somewhere to put it. Following the Enterprise Scale landing zone approach, the Well-architected and Ready phase of the Cloud Adoption Framework has an Application Landing zone reference architecture for Azure Container Apps.</p>
<p>Azure landing zone accelerators provide architectural guidance, reference architectures, reference implementations, and automation to deploy workload platforms on Azure at scale. They are aligned with industry proven practices, such as those presented in <a href="https://learn.microsoft.com/azure/cloud-adoption-framework/ready/landing-zone/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure landing zones guidance</a> in the Cloud Adoption Framework.</p>
<p><img decoding="async" loading="lazy" alt="Azure Container Apps - Landing Zone" src="https://luke.geek.nz/assets/images/ACA_Overview_LandingZoneContainerApps-5d2b35f1512e2637b221e554cac58504.gif" width="1892" height="964" class="img_ev3q"></p>
<p>This reference architecture can be found on GitHub directly: <a href="https://aka.ms/aca-lza" target="_blank" rel="noopener noreferrer">Azure/aca-landing-zone-accelerator</a>.</p>
<p>Thank you for sticking with me until the end! I hope you found this article useful. As usual, feel free to reach out to me on social media if there's anything you want covered that I may have missed, if you have any queries, or if you want me to cover anything else.</p>
<p><strong><a href="https://learn.microsoft.com/azure/container-apps/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Get started with Azure Container Apps today</a>!</strong></p>]]></content>
        <author>
            <name>Luke Murray</name>
            <uri>https://luke.geek.nz</uri>
        </author>
        <category label="Azure" term="Azure"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Book Review Cloud Solution Architects Career Master Plan]]></title>
        <id>https://luke.geek.nz/azure/book-review-cloud-solution-architects-career-master-plan/</id>
        <link href="https://luke.geek.nz/azure/book-review-cloud-solution-architects-career-master-plan/"/>
        <updated>2024-03-22T05:40:29.756Z</updated>
        <summary type="html"><![CDATA[This is a review of the book 'Cloud Solution Architect's Career Master Plan'. The book provides valuable insights for aspiring Cloud Solution Architects.]]></summary>
        <content type="html"><![CDATA[<p>Book review of <a href="https://www.amazon.com/Cloud-Solution-Architects-Career-Master/dp/1805129716" target="_blank" rel="noopener noreferrer">Cloud Solution Architect's Career Master Plan: Proven techniques and practical tips to help you become a successful solution architect</a></p>
<p><img decoding="async" loading="lazy" alt="Cloud Solution Architect&amp;#39;s Career Master Plan" src="https://luke.geek.nz/assets/images/csa-career-master-plan-kindle-book-d5513446900fd6bb274f15f793a7eb76.jpg" width="4080" height="3072" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Although this book was given to me to review <em>(for free, I have no formal relationship with either Packt Publishing or the authors, although I thank them for allowing me to review this book (Early Access), I am reviewing this book from an entirely independent view)</em>, as someone who architects and builds Azure solutions, this is the type of book, I usually would read, based on the title and synopsis, so let us open the page...</p></div></div>
<p>Book synopsis:</p>
<blockquote>
<p>Proven techniques and effective tips to help you become a successful solution architect.</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a href="https://luke.geek.nz/azure/book-review-cloud-solution-architects-career-master-plan/#introduction" class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction">‚Äã</a></h2>
<p><a href="https://www.amazon.com/Cloud-Solution-Architects-Career-Master/dp/1805129716" target="_blank" rel="noopener noreferrer">Cloud Solution Architect's Career Master Plan</a> is a Packtpub published (in March 2024) book written by the following authors:</p>
<ul>
<li><a href="https://www.linkedin.com/in/rickweyenberg/" target="_blank" rel="noopener noreferrer">Rick Weyenberg</a></li>
<li><a href="https://www.linkedin.com/in/kylemburns/" target="_blank" rel="noopener noreferrer">Kyle Burns</a></li>
</ul>
<p>First up - let's take a look at who this book is for. According to the authors, this book is for aspiring Cloud Solution Architects:</p>
<blockquote>
<p>If you are a self-motivated IT professional and would like to pursue a career as a solution architect, then
this book is for you. You should have a solid base of traditional software architecture understanding, but not in-depth cloud concepts and design considerations.
This book will also be valuable for anyone who is considering a solution architect role as a potential career field but doesn‚Äôt know where to get started. No experience in the cloud architect role is needed to get started.</p>
</blockquote>
<p>In order to set the context of my review, I need to give a brief blurb about my own IT Career to give the context of what lense I am reviewing from and what I am looking for in a book like this, my background is Systems/Infrastructure Engineer, then moving into Cloud-based roles, from project delivery/implementation to technical assurance roles, working with third-party service partners to deliver services, and now as a Senior Consultant/Architect <em>(the New Zealand IT industry, is very much generalised, one day you will be architecting strategic solutions, the next you will be doing infrastructure as code, as an engineer, we need to adapt to fit what needs doing at the time)</em>, so I am looking for a book that can help me in my career and  role, and also help me to mentor and guide others in their career.</p>
<p>There are 8 Chapters in this book, covering Introduction to the Cloud Solution Architect Role, Pursuing the Cloud Architect Role, Preparing for and after the Offer, and is 124 pages long.</p>
<p>I am going to break my review into several areas and look at answering questions such as:</p>
<ol>
<li>Does the book provide a clear understanding of the CSA‚Äôs role? How well does it explain the evolution of cloud computing?</li>
<li>Are the educational recommendations practical and accessible? Does the book cover a range of certifications?</li>
<li>Does the book offer actionable advice for gaining experience? Are the examples and suggestions relevant to current industry standards?</li>
<li>Is the book offer advice that is up-to-date and industry-specific? How helpful are the resume and interview tips?</li>
</ol>
<p>So lets take a look and see if the book answers these questions. I don't want to give away too much of the book, but hopefully, this review will give you a good idea of what to expect from the book.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="role-overview">Role overview<a href="https://luke.geek.nz/azure/book-review-cloud-solution-architects-career-master-plan/#role-overview" class="hash-link" aria-label="Direct link to Role overview" title="Direct link to Role overview">‚Äã</a></h2>
<p>For the role Overview section, we are going to take a look at the book and see whether it discusses the responsibilities and evolution of a Cloud Solution Architect (CSA).</p>
<blockquote>
<p>Question: Does the book provide a clear understanding of the CSA‚Äôs role? How well does it explain the evolution of cloud computing?</p>
</blockquote>
<p>Chapters 1 and 2, are dedicated to answering this very question, with Chapter 1: understanding the responsibilities of a Cloud Solution Architect, and Chapter 2: Types of Cloud Solution Architect roles.</p>
<p>Chapter 1 outlines the evolution of Cloud computing, from the first concepts of what became the internet in the 1960s to the modern-day Cloud within the 2000s. The authors do a very good job of being concise on these details - and vendor agnostic, which is clear throughout the entire book. It's worth noting that although the authors have ties to Microsoft as part of their day-to-day roles, they cover Azure, AWS, and Google concepts as well. Cloud Solution Architect is not specific to one Cloud or hyper scaler, and in my opinion, the authors concentrate on that very view - it's purely about being able to fill the gap that Cloud architecture has as an Architect.</p>
<p>Not only does the Chapter outline the history, but gives insights into core Cloud concepts as well, along with high-level points around the <a href="https://learn.microsoft.com/azure/cloud-adoption-framework/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Microsoft Cloud Adoption</a> and <a href="https://learn.microsoft.com/azure/well-architected/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Well-Architected Framework</a>.</p>
<p>Regarding a CSA (Cloud Solution Architect) role, the book outlines the upsides and downsides of the role and some of the responsibilities that come with it, across elements from on-premises, IaaS <em>(Infrastructure as a Service)</em>, PaaS <em>(Platform as a Service)</em> and SaaS <em>(Software as a Service)</em>, including various architectural patterns that CSAs need to know.</p>
<p>One of the highlights of the role overview Chapter is that the authors have distilled the role of 'Cloud Solution Architect', which could mean different things to different people - a very open-ended job title, into the various sub-categories that exist for CSAs and organisations such as Microsoft adhere to, such as Cloud Solution Architect (Infrastructure), Cloud Solution Architect (Applications), Cloud Solution Architect (Data and AI), and Cloud Solution Architect (Security) etc., highlighting the differences in these particular roles, including tools and relevant certifications for each Architect function.</p>
<p><strong>Overall, these Chapters do a good job of setting the scene for the rest of the book, give a good overview of the role and the responsibilities that come with it, and, in my opinion, clearly answer the question of What a CSA is, and what they do, and even covers industry-specific <em>(such as Healthcare or Utilities)</em>.</strong></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="educational-pathways">Educational Pathways<a href="https://luke.geek.nz/azure/book-review-cloud-solution-architects-career-master-plan/#educational-pathways" class="hash-link" aria-label="Direct link to Educational Pathways" title="Direct link to Educational Pathways">‚Äã</a></h2>
<p>For this section, we will examine the various educational paths and certifications available for aspiring CSAs by answering the following question:</p>
<blockquote>
<p>Question: Are the educational recommendations practical and accessible? Does the book cover a range of certifications?</p>
</blockquote>
<p><img decoding="async" loading="lazy" alt="Cloud Architect" src="https://luke.geek.nz/assets/images/Cloud_Architect_MSDesigner-58f091de3210d35a0b86d0aa491a1657.jpeg" width="1024" height="1024" class="img_ev3q"></p>
<p><strong>I alluded to this in the previous section (Role overview); the book authors have included a list of relevant certifications for each CSA (Cloud Solution Architect) function, ie AWS Certified Machine Learning, AI Engineer Associate, for AI/ML CSAs (Artificial Intelligence/Machine Learning Cloud Solution Architects), including a draft of fundamentals certifications across multiple platforms. It is my opinion, that the book covers educational pathways pretty well, with a vendor-neutral focus, from technical certification recommendations to even soft-skills and growth-mindset recommended reading, some great content and pathways to get started on your journey as a Cloud Solution Architect.</strong></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="real-world-application">Real-World Application<a href="https://luke.geek.nz/azure/book-review-cloud-solution-architects-career-master-plan/#real-world-application" class="hash-link" aria-label="Direct link to Real-World Application" title="Direct link to Real-World Application">‚Äã</a></h2>
<p>In this section, we will evaluate the book's practical advice for gaining experience and industry-specific knowledge - outside of the book.</p>
<p>We will consider how the book addresses gaining real experience through side projects, open-source contributions, and hackathons.</p>
<p><img decoding="async" loading="lazy" alt="Cloud Architect" src="https://luke.geek.nz/assets/images/Cloud_Architect_MSDesigner1-9462ef8d5fd0b5be14bbd76d47f2eb3a.jpeg" width="1024" height="1024" class="img_ev3q"></p>
<blockquote>
<p>Question: Does the book offer actionable advice for gaining experience? Are the examples and suggestions relevant to current industry standards?</p>
</blockquote>
<p><strong>When looking at a role, such as a Cloud Solution Architect, gaining experience is key, and the book does a good job of outlining the various ways to gain experience, from side projects, to open source contributions, to hackathons, and even to the importance of networking, and building relationships with other professionals in the industry, and the importance of mentorship, and how to find a mentor.</strong>
<strong>As a community advocate and someone who has learned by helping the community <em>(outside of my day-to-day role)</em>, by contributing to open-source projects, Microsoft Learn documentation editing and writing, and helping on Microsoft Q&amp;A etc., public speaking, etc. - the guidance this book offers is key and even touches on the high-level roadmap of, being a consumer of an open-source project and moving to more of a Contributor role. The path to a Cloud Solution Architect is not always a straight line, and the book does a good job of outlining this: the importance of gaining experience and the various ways to do so, which are not necessarily your traditional, become an engineer, then either go into architecture or management.</strong></p>
<p>To quote from the book itself:</p>
<blockquote>
<p>"In 1975, Steve Wozniak started working on a side project to design a general-purpose computing device suitable for hobbyist use. This device became the Apple I and helped start Apple Computer down the path toward becoming a household name. In May 2023, Apple announced a revenue of $94.8 billion for the second quarter of 2023."</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="job-pursuit-strategy">Job Pursuit Strategy<a href="https://luke.geek.nz/azure/book-review-cloud-solution-architects-career-master-plan/#job-pursuit-strategy" class="hash-link" aria-label="Direct link to Job Pursuit Strategy" title="Direct link to Job Pursuit Strategy">‚Äã</a></h2>
<p>In this section, we will review the guidance provided for pursuing a job, crafting a resume, and preparing for interviews.</p>
<blockquote>
<p>Question: Is the job pursuit advice up-to-date and industry-specific? How helpful are the resume and interview tips?</p>
</blockquote>
<p>Now that the book has covered alot of theory about what a CSA (Cloud Solution Architect) is and how to get experience and education <em>(in my opinion, covered successfully)</em>, now lets see how whether the guidance can help us with the next step, of preparing for interviews, and crafting a resume.</p>
<p><img decoding="async" loading="lazy" alt="Cloud Architect" src="https://luke.geek.nz/assets/images/Cloud_Architect_MSDesigner2-59348657cd37f4c6266471a5e7b84002.jpeg" width="1024" height="1024" class="img_ev3q"></p>
<p>First, we need to keep in mind that this book came out in March 2024, around the same time as this review. So, the information on hand is relevant and up-to-date at the time of this review, and the job pursuit advice is relevant for the current job market. However, different industries, companies, and geographical locations may have different requirements for an Architect, so make sure to read the fine print of that role.</p>
<p><strong>Going back to the book - the book has already touched on a Cloud Solution Architect, what that is, and how to get experience and industry-specific concerns, but what the book hasn't touched on YET - is the different levels, for example, Junior, Senior, Principal Cloud Solution Architect, I question I had before reading this book was:</strong></p>
<p><strong>What was the difference between a Senior Cloud Solution Architect and a Principal Architect? This book answered that.</strong></p>
<p><strong>The book also covered, average salary <em>(again company, geographical specific)</em>,  and recommendations on resume tips and skills. These sections were very high-level but straight to the point - the authors allowed room for you to adjust and make their recommendations your own and adjustable for the actual role you are applying for. I took the recommendations as a way to structure the sentences and my achievements on my resume, and skills (both technical and soft skills) that I may need or didn't think to add.</strong></p>
<p><strong>Alongside the resume tips are tips about leveraging Social Media and also some relevant interview questions.</strong></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="authors-expertise">Author's Expertise<a href="https://luke.geek.nz/azure/book-review-cloud-solution-architects-career-master-plan/#authors-expertise" class="hash-link" aria-label="Direct link to Author's Expertise" title="Direct link to Author's Expertise">‚Äã</a></h2>
<p>I believe the authors have the correct expertise to make this book viable <em>(and based on my own knowledge, reading this book)</em> and accurate.</p>
<ul>
<li><a href="https://www.linkedin.com/in/kylemburns/" target="_blank" rel="noopener noreferrer">Kyle Burns</a> is a Microsoft Principal Cloud Solution Architect - concentrating on Azure App Dev.</li>
<li><a href="https://www.linkedin.com/in/rickweyenberg/" target="_blank" rel="noopener noreferrer">Rick Weyenberg</a> is a Microsoft Principal Azure Cloud Solution Architect with an industry focus for automotive.</li>
</ul>
<p><strong>It is my opinion that this duo is indeed suited to write this type of book, and this can be seen from the actionable and valid output of the book itself.</strong></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://luke.geek.nz/azure/book-review-cloud-solution-architects-career-master-plan/#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">‚Äã</a></h2>
<p><strong>Cloud Solution Architect's Career Master Plan (1st Edition) is a book containing 124 pages of actionable and useful content for those interested in what a Cloud Solution Architect is and how to start your journey to becoming one. Key traits needed, in my opinion, for a Cloud Solution Architect are a desire to learn and stay up to date with emerging technologies; this is reflected in the guidance of the book. Overall, I had no pre-conceptions when I was asked to review this book, but it was very timely for me personally, where I am in my own career, and the questions that I had.</strong></p>
<p><strong>I would like to point out that this book goes beyond by dedicating a section to giving back to the Community and the importance of mentorship, networking, soft skills and a growth mindset, which are key to being a successful Cloud Solution Architect and highly recommend picking up to read. The only issue I had was that there was missing an 's' to an image for on-premises! My OCD kicked in! But it was a privilege to review, definitely one I will refer to!</strong></p>
<p>If interested, feel free to checkout another Book review I did on <a href="https://luke.geek.nz/azure/misc/Book-Review-Azure-architecture-explained/" target="_blank" rel="noopener noreferrer">Book Review Azure Architecture Explained</a>, another great book on the more technical and governance aspects of architecting solutions in Azure.</p>]]></content>
        <author>
            <name>Luke Murray</name>
            <uri>https://luke.geek.nz</uri>
        </author>
        <category label="Azure" term="Azure"/>
        <category label="Misc" term="Misc"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Microsoft Azure - Sandbox Design Considerations]]></title>
        <id>https://luke.geek.nz/azure/microsoft-azure-sandbox-design-considerations/</id>
        <link href="https://luke.geek.nz/azure/microsoft-azure-sandbox-design-considerations/"/>
        <updated>2024-03-21T04:40:28.030Z</updated>
        <summary type="html"><![CDATA[Sandbox Design Considerations for Microsoft Azure]]></summary>
        <content type="html"><![CDATA[<p>When working with Microsoft Azure, you may want an environment for learning, whether for an individual or a team. This article aims to highlight some architectural considerations when implementing a Sandbox environment within the Microsoft Azure platform.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>Your Sandbox isn‚Äôt a pathway to production; it‚Äôs a pathway to ‚ÄúCLICK, CLICK, OOPS.‚Äù</p></div></div>
<p><img decoding="async" loading="lazy" alt="Microsoft Azure - Sandbox Design Considerations" src="https://luke.geek.nz/assets/images/BlogHeading_MicrosoftAzure_SandboxDesignConsiderations-ada674642f7ef4887f0bf67997d4e069.png" width="901" height="481" class="img_ev3q"></p>
<!-- -->
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-what-is-a-cloud-sandbox-environment">‚òÅÔ∏è What is a Cloud Sandbox environment?<a href="https://luke.geek.nz/azure/microsoft-azure-sandbox-design-considerations/#%EF%B8%8F-what-is-a-cloud-sandbox-environment" class="hash-link" aria-label="Direct link to ‚òÅÔ∏è What is a Cloud Sandbox environment?" title="Direct link to ‚òÅÔ∏è What is a Cloud Sandbox environment?">‚Äã</a></h2>
<p>What am I talking about when talking about a Sandbox environment?</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Cloud Sandboxes are contained, isolated environments that allow the evaluation of new Cloud services and features <em>(without impacting production environments)</em>.</p><ul>
<li>Sandbox is a pathway to learning, not to development</li>
<li>Build and experiment with capabilities with an open platform</li>
<li>Co-innovate with trust and safeguards</li>
</ul><p>The general principles for a Sandbox environment are:</p><ul>
<li>Cannot store Production data</li>
<li>Secure identity with production controls</li>
<li>Environment for learning, not production</li>
</ul></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="why-would-i-want-a-sandbox-environment">‚ùîWhy would I want a Sandbox environment?<a href="https://luke.geek.nz/azure/microsoft-azure-sandbox-design-considerations/#why-would-i-want-a-sandbox-environment" class="hash-link" aria-label="Direct link to ‚ùîWhy would I want a Sandbox environment?" title="Direct link to ‚ùîWhy would I want a Sandbox environment?">‚Äã</a></h2>
<p>Having an environment for learning is key to driving the adoption of Cloud technologies by giving consumers the ability to leverage and test Azure resources in an isolated environment from Production; users using the Sandbox could be users new to Microsoft Azure or those who may already have Azure knowledge but want to trial and test preview features, that may not be compliant with Production controls.</p>
<p><img decoding="async" loading="lazy" alt="Gartner Top 10 - Strategic Technology Trends for 2024" src="https://luke.geek.nz/assets/images/Gartner_Top_10_StrategicTechTrends_2024-1bf229c397604392905a94f689431837.png" width="1914" height="750" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Platform Engineering is the discipline of building and operating self-service internal platforms ‚Äî each platform is a layer created and maintained by a dedicated product team, designed to support the needs of its users by interfacing with tools and processes.</p></div></div>
<p>According to the Gartner Top 10 technology trends for 2024, Platform Engineering is a key element to enabling developers and application teams to remain competitive, not only from a business standpoint but also from talent retention, empowering employees to do more, the premise of Platform Engineering is for a 'Platform Team' to manage the governance of the Cloud platforms <em>(following key well-architected framework guidelines, such as Operational Excellence, Security, Performance and Reliability)</em> and also allowing the Application owners to deploy and manage their applications, without having to worry about the necessary organisational guardrails.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-are-the-antipatterns-to-avoid">üò∑What are the antipatterns to avoid?<a href="https://luke.geek.nz/azure/microsoft-azure-sandbox-design-considerations/#what-are-the-antipatterns-to-avoid" class="hash-link" aria-label="Direct link to üò∑What are the antipatterns to avoid?" title="Direct link to üò∑What are the antipatterns to avoid?">‚Äã</a></h2>
<p>The word 'anti-patterns' can be quite negative terminology to use. However, it's really a trade-off between having an environment protected, i.e., with regulatory requirements, etc., like you would in Production, which in most cases prevents your Sandbox consumers from being able to learn without running into the various guardrails and having an environment on the opposite end of the scale, where there are no guardrails in place.</p>
<p>When we look at anti-patterns, we need to remember what we are trying to achieve with the Cloud Sandboxes, i.e. give Sandbox consumers an environment for learning Cloud technologies.</p>
<p>So, let us take a look at some patterns and areas to avoid.</p>
<ul>
<li>Regional restrictions - the reason why you might want to restrict Regional Restrictions is due to the fact that not all Azure services are available in all regions.</li>
<li>Over extensive blocklists</li>
<li>Trying to build the entire platform at once</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="sandbox-patterns">üìãSandbox Patterns<a href="https://luke.geek.nz/azure/microsoft-azure-sandbox-design-considerations/#sandbox-patterns" class="hash-link" aria-label="Direct link to üìãSandbox Patterns" title="Direct link to üìãSandbox Patterns">‚Äã</a></h2>
<p>Ok, let's talk Patterns! Every organisation may have a different Sandbox requirement, but before we discuss the particular of patterns, let's first talk about Platform Landing Zones at a high level so I can make sure we are all talking the same language.</p>
<p>In the context of Platform Landing Zones, I am referring to an Azure environment setup like the Enterprise Scale Landing Zone Reference architecture (ESLZ), where the Landing Zone features common components for the Platform, such as Security and Connectivity, and is usually the base of your networking infrastructure, such as Virtual WAN (Wide Area Network) connecting to your on-premises environment or a Virtual Network connecting different Applications and dependencies together.</p>
<p>The Platform Landing Zone design aims to keep Platform management consistent, centralised, and secure, allowing your application teams to leverage the shared services supplied by the Platform Landing Zone design. An organisation may have requirements to move from this reference pattern - and that is ok - but the premise here is that the Platform Landing Zone is looked after by a Platform or Infrastructure team <em>(in most cases)</em> and the environment is architected in a way that does not impede application teams, to deliver business value, while making sure that their solutions are secure and where necessary, consistent.</p>
<p><img decoding="async" loading="lazy" alt="Azure Landing Zone - Sandbox - Reference Architecture" src="https://luke.geek.nz/assets/images/Azure_Landing_Zone-Sandbox-ReferenceArchitecture-1fcbfd121ee389dfd62133124d618eb2.png" width="1330" height="1066" class="img_ev3q"></p>
<p>A sandbox usually contains:</p>
<ul>
<li>Data isolation</li>
<li>Network security (segregated)</li>
<li>Identity and access controls</li>
<li>Compliance and regulatory considerations</li>
</ul>
<p>So, let us discuss Sandbox Types.</p>
<p><img decoding="async" loading="lazy" alt="Azure Sandbox Types" src="https://luke.geek.nz/assets/images/Azure_Sandbox_Types-cde8ffbf467e4e3cc94ae61b2e7b82d5.png" width="929" height="528" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="Azure Sandbox Types" src="https://luke.geek.nz/assets/images/Azure_Sandbox_Types2-675c09308c8dd8798a1c0d7bebeb5b96.png" width="1062" height="646" class="img_ev3q"></p>
<p>The term: Managed, below - is in the context of the Azure Cloud Adoption Framework, where the environment is managed by the organisation and is part of the organisation's governance, identity and compliance controls, and Platform team managed.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="sandbox-type---personal">Sandbox Type - Personal<a href="https://luke.geek.nz/azure/microsoft-azure-sandbox-design-considerations/#sandbox-type---personal" class="hash-link" aria-label="Direct link to Sandbox Type - Personal" title="Direct link to Sandbox Type - Personal">‚Äã</a></h3>
<p>When referring to a Personal Sandbox, I am referring to a Free, Pay As You Go, or Azure Sponsorship, <a href="https://visualstudio.microsoft.com/subscriptions/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Visual Studio Enterprise subscription(s)</a> that are used by an individual, an example is a Cloud Engineer, who has access to a Visual Studio Enterprise subscription and then uses the free credit, to spin up an Azure subscription - that is unmanaged and not part of the organisation's network, identity or compliance controls. These subscriptions usually have a hard limit on the type of resources you can deploy or Budget.</p>
<p>Personal subscriptions are outside of the organisation's control and are not managed by the organisation. They are usually used for learning and not for production workloads. For individuals with these licenses, these subscriptions can be key to preparing for certification or individual upskilling.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="sandbox-type---unmanaged">Sandbox Type - Unmanaged<a href="https://luke.geek.nz/azure/microsoft-azure-sandbox-design-considerations/#sandbox-type---unmanaged" class="hash-link" aria-label="Direct link to Sandbox Type - Unmanaged" title="Direct link to Sandbox Type - Unmanaged">‚Äã</a></h3>
<p>When I refer to an Unmanaged Sandbox, I am referring to an Azure subscription that is managed by the organisation but is not part of the organisation's network, identity, or production compliance controls (although it would be auditable).
These subscriptions are usually used for learning, not for production workloads. For individuals or teams, these subscriptions can be key to preparing for certification or team upskilling with Cloud technologies and preview features.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="sandbox-type---lightly-managed">Sandbox Type - Lightly Managed<a href="https://luke.geek.nz/azure/microsoft-azure-sandbox-design-considerations/#sandbox-type---lightly-managed" class="hash-link" aria-label="Direct link to Sandbox Type - Lightly Managed" title="Direct link to Sandbox Type - Lightly Managed">‚Äã</a></h3>
<p>When referring to Lightly Managed Sandboxes, these are more managed than an Unmanaged subscription because they are Resource Group limited; for example, a team of 10 may have access to a Lightly Managed Sandbox, where they can deploy resources into a specific Resource Group, or Resource Groups that they have access to, however, the overall governance of the Subscription is done by the Platform team. This is useful when you have a lot of individuals wanting a specific regulated Resource Group to stand up resources into, vs giving them a Subscription each.</p>
<p>Resource Group tags can be key to <a href="https://techcommunity.microsoft.com/t5/fasttrack-for-azure/the-azure-finops-guide/ba-p/3704132?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">FinOps</a> cost management and tracking.</p>
<p>Lightly Managed sandboxes can be useful for smaller organisations that do not want Subscription sprawl.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="sandbox-type---highly-managed">Sandbox Type - Highly Managed<a href="https://luke.geek.nz/azure/microsoft-azure-sandbox-design-considerations/#sandbox-type---highly-managed" class="hash-link" aria-label="Direct link to Sandbox Type - Highly Managed" title="Direct link to Sandbox Type - Highly Managed">‚Äã</a></h3>
<p>Highly Managed Sandboxes are usually used for testing the same set of services repeatedly, where the users (particularly Developers) don't necessarily care about the underly Azure platform and resources and are more focussed on the application and services they are deploying, for example, a developer may want to test a new version of a service, and they can deploy the service into a Highly Managed Sandbox, and then run their tests, and then destroy the environment.
Highly Managed Sandboxes are useful for standing up consistant infrastructure, such as an Azure Kubernetes Service or App Service, that is used every single time.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>The main difference is that managed sandboxes have pre-determined services that can be deployed as needed, which is useful for testing the same set of services repeatedly.
Lightly managed sandboxes are useful when many individuals want a specific regulated Resource Group to allocate resources to.</p><p>In contrast, the unmanaged sandbox is more open and less restrictive, which makes it ideal for learning and trying new technologies for a small to large team.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="sandbox-type-decisions">Sandbox Type decisions<a href="https://luke.geek.nz/azure/microsoft-azure-sandbox-design-considerations/#sandbox-type-decisions" class="hash-link" aria-label="Direct link to Sandbox Type decisions" title="Direct link to Sandbox Type decisions">‚Äã</a></h3>
<p>When deciding on the type of Sandbox, you need to consider the following:</p>
<ul>
<li><strong>The purpose of the Sandbox</strong>. What are you trying to achieve with the Sandbox? Are you trying to give users an environment to learn, or are you trying to give users an environment to test a specific set of services?</li>
<li><strong>The scope of the Sandbox</strong>. Are you trying to give users an environment to learn, or are you trying to give users an environment to test a specific set of services?</li>
<li><strong>The lifecycle of the Sandbox</strong>. How long do you want it to be available? Do you want it to be available for a specific period of time?</li>
<li><strong>The Cost of the Sandbox</strong>. How much are you willing to spend on it? Who has the financial authority to approve Cloud spending?</li>
<li><strong>Access to the Sandbox</strong>. Who has access to the Sandbox, and how do you manage access to the Sandbox?</li>
<li><strong>Management of the Sandbox</strong>. Who is responsible for managing the Sandbox? How do you manage the lifecycle of the Sandbox?</li>
<li><strong>Governance of the Sandbox</strong>. How do you manage the governance of the Sandbox? How do you manage the compliance of the Sandbox?</li>
<li><strong>Migration of the Sandbox</strong>. How do you migrate the Sandbox to a different environment? How do you migrate the Sandbox to a different subscription? ie what would migration of a proof of technology from a Sandbox environment into Dev/Test or Production look like?</li>
<li><strong>Security of the Sandbox</strong>. How do you manage the security of the Sandbox? How do you manage the identity and access to a Sandbox? How do you manage the compliance of the Sandbox?</li>
<li><strong>Monitoring of the Sandbox</strong> How do you monitor the Sandbox? How do you manage the cost of the Sandbox? How do you manage the performance of resources in the Sandbox (and do you need to)?</li>
<li><strong>Integration of the Sandbox</strong>. How do you integrate the Sandbox with other environments? How do you integrate the Sandbox with other subscriptions? How do you integrate the Sandbox with other services?</li>
</ul>
<p>Consideration of all of the above will help you decide on the type of Sandbox that is right for your organisation.</p>
<p><img decoding="async" loading="lazy" alt="Azure Sandbox Decisions" src="https://luke.geek.nz/assets/images/Azure_Sandbox_TypeDecisions-b186854a710240c85b32fd01003a7c7c.png" width="1955" height="707" class="img_ev3q"></p>
<table><thead><tr><th>Criteria</th><th>Personal</th><th>Unmanaged</th><th>Lightly Managed</th><th>Highly Managed</th></tr></thead><tbody><tr><td>Purpose</td><td>Learning, individual upskilling</td><td>Learning, team upskilling</td><td>Regulated resource group for team</td><td>Testing specific services repeatedly</td></tr><tr><td>Scope</td><td>Individual</td><td>Small to large team</td><td>Specific team</td><td>Specific services</td></tr><tr><td>Lifecycle</td><td>Determined by individual</td><td>Determined by team</td><td>Managed by platform team</td><td>Managed by platform team</td></tr><tr><td>Cost</td><td>Limited by subscription type</td><td>Auditable, managed by organisation</td><td>Managed by platform team</td><td>Managed by platform team</td></tr><tr><td>Access</td><td>Individual</td><td>Team</td><td>Regulated by platform team</td><td>Regulated by platform team</td></tr><tr><td>Management</td><td>Individual</td><td>Team</td><td>Platform team</td><td>Platform team</td></tr><tr><td>Governance</td><td>Individual</td><td>Auditable, managed by organisation</td><td>Managed by platform team</td><td>Managed by platform team</td></tr><tr><td>Migration</td><td>Individual responsibility</td><td>Team responsibility</td><td>Managed by platform team</td><td>Managed by platform team</td></tr><tr><td>Security</td><td>Individual responsibility</td><td>Auditable, managed by organisation</td><td>Managed by platform team</td><td>Managed by platform team</td></tr><tr><td>Monitoring</td><td>Individual responsibility</td><td>Team responsibility</td><td>Managed by platform team</td><td>Managed by platform team</td></tr><tr><td>Integration</td><td>Individual responsibility</td><td>Team responsibility</td><td>Managed by platform team</td><td>Managed by platform team</td></tr></tbody></table>
<p>Let's look at a scenario:</p>
<p>We have a Data Scientist named Samuel.</p>
<p><img decoding="async" loading="lazy" alt="Samuel - Data Scientist" src="https://luke.geek.nz/assets/images/Azure_Sandbox_Scenario_Samuel-b0c9876207b7160c4c4ac62467344cd6.png" width="1820" height="868" class="img_ev3q"></p>
<p>Samuel's goals are to:</p>
<ol>
<li><strong>Deliver high-quality and robust machine learning solutions that can enhance customer satisfaction and loyalty</strong>x, as well as increase the revenue and profitability of the company.</li>
<li><strong>Learn the latest and most advanced techniques and methods in the field of artificial intelligence, such as natural language processing</strong>, computer vision, and deep learning, to create innovative and cutting-edge models.</li>
<li>To <strong>collaborate and learn from other data scientists and experts in the field, both within and outside his company</strong>, to improve his knowledge.</li>
<li><strong>Self-management and accountability of cost management</strong> and access to the environment for Data/AI projects across multiple responsible team members**.</li>
</ol>
<p>If we also take a look at the <a href="https://learn.microsoft.com/azure/security/fundamentals/shared-responsibility-ai?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Microsoft AI Shared responsibility model</a>, we can see that the Data Scientist, is responsible for the Data, the AI model, and the AI application, and the Platform team is responsible for the underlying infrastructure, and the AI platform.</p>
<p><img decoding="async" loading="lazy" alt="Microsoft AI Shared Responsibility Model" src="https://luke.geek.nz/assets/images/Azure_Sandbox_Scenario_Samuel_AI_SharedResponsibility-af413845edd8fcdabfe075a907a2cfe4.png" width="953" height="607" class="img_ev3q"></p>
<p>Because of Samuel's requirements and the shared responsibility model, we can see that Samuel would benefit from an Unmanaged Sandbox, where he can deploy resources into a specific Subscription he has access to, alongside members of his team and approved external identities, while also being isolated from Production. He has also accepted responsibility for Cost.</p>
<p>The reference architecture of Samuel's Sandbox could look like the following:</p>
<p><img decoding="async" loading="lazy" alt="Azure Sandbox - Reference Architecture - Samuel" src="https://luke.geek.nz/assets/images/Sandbox_Reference_Architecture-e35333694d33cb2d60dc914d30879f73.png" width="1775" height="981" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="pathway-to-production">üöôPathway to Production<a href="https://luke.geek.nz/azure/microsoft-azure-sandbox-design-considerations/#pathway-to-production" class="hash-link" aria-label="Direct link to üöôPathway to Production" title="Direct link to üöôPathway to Production">‚Äã</a></h2>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Remember: The Sandbox is not a pathway to production; it is a pathway to "CLICK, CLICK, OOPS".</p></div></div>
<p><strong>However</strong>, there will be times when users have learnt something in the Sandbox, and they want to move their solution into a Dev/Test or Production environment, and this is where the <a href="https://learn.microsoft.com/azure/cloud-adoption-framework/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Cloud Adoption Framework</a> comes into play, and the <a href="https://learn.microsoft.com/azure/well-architected/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Well-Architected Framework</a> can be used to help guide the migration of the solution from the Sandbox into a Dev/Test or Production environment.</p>
<p>Make sure to consider the following:</p>
<ol>
<li><strong>Identify and document the requirements and specifications of the product after your learning</strong>: After experimenting and learning in the Sandbox, it's crucial to identify and document the requirements and specifications of the product. This includes understanding the technical requirements, the business needs, and the user expectations. This step is in line with the Strategy phase of the Cloud Adoption Framework.</li>
<li><strong>Security considerations (RBAC, Access, CISO review)</strong>: Security is a paramount concern when moving from a Sandbox to a Production environment. Considerations should include Role-Based Access Control (RBAC) to ensure only authorized individuals have access, a thorough review of access permissions, and a review by the Chief Information Security Officer (CISO) or equivalent. This aligns with the Well-Architected Framework's security pillar.</li>
<li><strong>Ensure that the data, code, models, and outputs are suitable for Production; change</strong>: Before moving to Production, ensure that all data, code, models, and outputs are production-ready. This means they should be thoroughly tested, reliable, and meet all necessary regulations and standards. This is part of the Plan and Ready phases of the Cloud Adoption Framework.</li>
<li><strong>Deploy the production using CI/CD where possible</strong>: Continuous Integration/Continuous Deployment (CI/CD) is a best practice for deploying applications. It allows for frequent code changes, automated testing, and quick deployment to production. This is part of the Migrate and Innovate phases of the Cloud Adoption Framework.</li>
<li><strong>Test and debug</strong>: Rigorous testing and debugging are essential to ensure the product works as expected and any issues are identified and fixed before going live. This aligns with the Well-Architected Framework's reliability pillar.</li>
<li><strong>Monitor and manage</strong>: Once in production, the application should be continuously monitored and managed to ensure it remains secure, performs well, and meets user needs. This includes monitoring for any issues, managing updates and changes, and regularly reviewing performance. This is part of the Govern and Manage phases of the Cloud Adoption Framework.</li>
</ol>
<p>Also, make sure you make sure of Cloud Adoption Framework Landing Zone guidance, such as <a href="https://learn.microsoft.com/en-gb/azure/cloud-adoption-framework/ready/enterprise-scale/testing-approach?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Dev/Test Management Group and subscription Landing Zone guidance, such as a Canary Management Group structure</a>.</p>
<p>Although not mandatory, the canary environment management group hierarchy can be used to simplify testing of the following resource types without ending up with a range of exemptions and overprivileged access to Production resources, where it is not required:</p>
<ul>
<li><strong>Management groups</strong>: Management groups in Azure provide a level of scope above subscriptions. They give you enterprise-grade management at a large scale no matter what type of subscriptions you might have. All subscriptions within a management group automatically inherit the conditions applied at the management group level.</li>
<li><strong>Subscription placement</strong>: The placement of subscriptions within the management group hierarchy is crucial. It allows for the application of governance conditions at different levels, providing flexibility and control over the environment.</li>
<li><strong>Roles (built-in and custom)</strong>: Azure provides several built-in roles that you can assign to users, groups, and services. You can also create custom roles if the built-in roles don't meet your specific needs.</li>
<li><strong>Assignments</strong>: Assignments in Azure RBAC are the links between roles and security principals (user, group, service principal, or managed identity). They define the access a security principal has.</li>
<li><strong>Azure Policy</strong>: Azure Policy is a service in Azure that you use to create, assign, and manage policies. These policies enforce different rules and effects over your resources, helping to ensure your resources stay compliant with your corporate standards and service level agreements.</li>
<li><strong>Definitions (built-in and custom)</strong>: Azure Policy uses policy definitions to express what to evaluate and what action to take. There are built-in definitions provided by Azure and you can also create custom definitions.</li>
<li><strong>Initiatives, also known as set definitions</strong>: An initiative definition is a set or group of policy definitions to help track your compliance state for a larger goal. Initiatives bring together one or more policies as a group to accomplish things like enabling real-time policy enforcement and more comprehensive coverage.</li>
</ul>
<p>The Canary Landing Zone architecture is useful as it provides a controlled environment for testing changes and updates before they are applied to the production resources.</p>
<p><img decoding="async" loading="lazy" alt="Azure Landing Zones - Canary" src="https://luke.geek.nz/assets/images/canary-mgmt-groups-97d6d855227f32f80a5e08731d991498.png" width="1407" height="542" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="products-and-tools">üö¢Products and tools<a href="https://luke.geek.nz/azure/microsoft-azure-sandbox-design-considerations/#products-and-tools" class="hash-link" aria-label="Direct link to üö¢Products and tools" title="Direct link to üö¢Products and tools">‚Äã</a></h2>
<p>When considering a Sandbox environment, you may want to consider the following products and tools to assist.</p>
<ul>
<li><a href="https://learn.microsoft.com/azure/deployment-environments/overview-what-is-azure-deployment-environments?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Deployment Environments</a> - useful for 'Highly Managed Sandboxes', Azure Deployment Environments, allows you to pre-define a set of services through infrastructure as code, and offer it up to developers or Sandbox consumers, as a Service, that they can then deploy and tear down as required.</li>
<li><a href="https://learn.microsoft.com/azure/devtest-labs/devtest-lab-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Dev/Test Labs</a> - Azure DevTest Labs is a service for easily creating, using, and managing infrastructure-as-a-service (IaaS) virtual machines (VMs) and platform-as-a-service (PaaS) environments in labs. Labs offer preconfigured bases and artifacts for creating VMs, and Azure Resource Manager (ARM) templates for creating environments like Azure Web Apps or SharePoint farms. Azure DevTest Labs is useful for Lightly Managed Sandboxes, where you want to give a team access to a specific Resource Group.</li>
<li><a href="https://learn.microsoft.com/entra/id-governance/entitlement-management-access-package-create?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Entra ID Access Packages</a> - Access packages are great for giving delegated access to a specific set of resources, for a specific period of time, and can be useful for Lightly and Unmanaged  Sandboxes, where you want to give a team access to a specific Resource Group or Subscription.</li>
<li><a href="https://learn.microsoft.com/purview/purview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Microsoft Purview</a> - Microsoft Purview is a unified data governance service that helps you manage and govern your on-premises, multi-cloud, and software-as-a-service (SaaS) data. You can use Purview to understand your data, manage data policies, and ensure data privacy and compliance. Microsoft Purview is useful for understanding the data that is being used in the Sandbox.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="reference-links">üìñReference Links<a href="https://luke.geek.nz/azure/microsoft-azure-sandbox-design-considerations/#reference-links" class="hash-link" aria-label="Direct link to üìñReference Links" title="Direct link to üìñReference Links">‚Äã</a></h2>
<ol>
<li><a href="https://youtu.be/WR9zRbzYfTQ" target="_blank" rel="noopener noreferrer">Festive Tech Calender - 2023 - Azure Sandbox Design</a></li>
<li><a href="https://www.gartner.com/en/articles/gartner-top-10-strategic-technology-trends-for-2024" target="_blank" rel="noopener noreferrer">Gartner Top 10 Strategic Technology Trends for 2024</a></li>
<li><a href="https://learn.microsoft.com/en-us/azure/architecture/guide/azure-sandbox/azure-sandbox?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Sandbox (Azure Architecture Center)</a></li>
<li><a href="https://azure.microsoft.com/en-us/solutions/cloud-enablement/cloud-adoption-framework?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Microsoft Azure Cloud Adoption Framework</a></li>
<li><a href="https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/azure-subscription-service-limits?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure subscription and service limits, quotas and constraints</a></li>
<li><a href="https://github.com/BevanSin/AzureSandbox" target="_blank" rel="noopener noreferrer">BevanSin/AzureSandbox</a></li>
<li><a href="https://github.com/dazzlejim/AzureSandbox" target="_blank" rel="noopener noreferrer">dazzlejim/AzureSandbox</a></li>
</ol>]]></content>
        <author>
            <name>Luke Murray</name>
            <uri>https://luke.geek.nz</uri>
        </author>
        <category label="Azure" term="Azure"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Tag Azure Resources with Owner using Azure Automation]]></title>
        <id>https://luke.geek.nz/azure/tag-azure-resources-owner-azure-automation-runbook/</id>
        <link href="https://luke.geek.nz/azure/tag-azure-resources-owner-azure-automation-runbook/"/>
        <updated>2024-03-07T07:10:25.200Z</updated>
        <summary type="html"><![CDATA[Tag Azure Resources with Owner using Azure Automation runbook]]></summary>
        <content type="html"><![CDATA[<p>Inspired by <a href="https://techcommunity.microsoft.com/t5/core-infrastructure-and-security/tagging-azure-resources-with-a-creator/ba-p/1479819?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Tagging Azure Resources with a Creator</a> an Azure function + event grid solution, that will tag resources with the creator of the resource. I wanted to see if I could do the same thing using Azure Automation runbooks, instead of using event grid but a schedule instead, to make use of an already existing <a href="https://learn.microsoft.com/azure/automation/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Automation</a> account.</p>
<p>It turns out you can, so let's take a look.</p>
<p><img decoding="async" loading="lazy" alt="Blog Heading - Tag Azure Resources with Owner using Azure Automation runbook" src="https://luke.geek.nz/assets/images/BlogHeading_TagAzureResourceswithOwnerAzureAutomation-55e6ea6bd6488ab6d0b4a8794fd4696e.png" width="1200" height="627" class="img_ev3q"></p>
<!-- -->
<p>Make sure to change the ManagementGroupID variable to match your own environment.</p>
<p>This runbook uses a System Managed Identity from the Azure Automation account, so make sure this has Contributor rights to the subscription or management group you want to tag resources in.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>This PowerShell script is designed to tag Azure resources with the user's email address who last modified them. It's particularly useful for tracking who is responsible for each resource in your Azure environment. Here's a step-by-step breakdown of what the script does:</p><ol>
<li><strong>Disable AzContext Autosave</strong>: The script starts by disabling the autosave feature for the Azure context. This ensures the script doesn't inherit any Azure context from previous sessions.</li>
<li><strong>Suppress Warnings</strong>: The script suppresses warnings related to breaking changes in Azure PowerShell. This is to prevent these warnings from cluttering the output.</li>
<li><strong>Import Modules</strong>: The script imports the Az.Accounts and Az.Resources modules, which provide the cmdlets needed to interact with Azure.</li>
<li><strong>Define Variables</strong>: The script defines a variable for the tag name (<code>$tagName</code>) and the management group ID (<code>$ManagementGroupID</code>).</li>
<li><strong>Connect to Azure</strong>: The script uses a Managed Service Identity.</li>
<li><strong>Get Subscriptions</strong>: The script defines a function (<code>Get-AzSubscriptionsFromManagementGroup</code>) that retrieves all the subscription IDs under a specified management group, including subscriptions under child management groups. It then calls this function to get the subscription IDs under the management group specified by <code>$ManagementGroupID</code>.</li>
<li><strong>Process Each Subscription</strong>: For each subscription ID retrieved, the script sets the Azure context to that subscription and retrieves all resources in the subscription.</li>
<li><strong>Process Each Resource</strong>: For each resource in the subscription, the script checks if the resource has a tag with the name specified by <code>$tagName</code>.</li>
<li><strong>Add Tag If Not Present</strong>: If the resource does not have a tag with the name specified by <code>$tagName</code>, the script retrieves the Azure activity logs for the resource for the past seven days and finds the user's email address who last modified the resource. It then adds a tag to the resource with the name specified by <code>$tagName</code> and the value set to the user's email address.
This script is designed to be run on a schedule, such as once a day, to ensure that all resources are tagged with the user's email address who last modified them.</li>
</ol></div></div>
<p><img decoding="async" loading="lazy" alt="Tag Azure Resources with Owner" src="https://luke.geek.nz/assets/images/Tag_Owner-RunbookRun-97574d5317f6c9877723c2255265e661.gif" width="1905" height="964" class="img_ev3q"></p>
<p>The Runbook is as follows:</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">&lt;# Ensures you do not inherit an AzContext in your runbook #&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Disable-AzContextAutosave</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Scope </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">Process</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Out-Null</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">#Toggle to stop warnings with regard to Breaking Changes in Azure PowerShell</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Set-Item</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Path Env:\SuppressAzurePowerShellBreakingChangeWarnings </span><span class="token operator">-</span><span class="token plain">Value </span><span class="token boolean">$true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Import the required modules</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Import-Module</span><span class="token plain"> Az</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Accounts</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Import-Module</span><span class="token plain"> Az</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Resources</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Define the tag name as a variable</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$tagName</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"Createdby"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">#Adjust to suit your management group; this is the top scope that the Script will run under</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ManagementGroupID</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">'mg-landingzones'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">&lt;# Connect using a Managed Service Identity #&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Connect-AzAccount</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Identity</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Get the subscription IDs under the specified management group AND child management groups</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzSubscriptionsFromManagementGroup</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ManagementGroupName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$mg</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzManagementGroup</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">GroupId </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ManagementGroupName</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Expand</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">foreach</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$child</span><span class="token plain"> in </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$mg</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Children</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$child</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Type</span><span class="token plain"> </span><span class="token operator">-match</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'/managementGroups$'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzSubscriptionsFromManagementGroup</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ManagementGroupName </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$child</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$child</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Select-Object</span><span class="token plain"> @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">N = </span><span class="token string" style="color:rgb(255, 121, 198)">'Name'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> E = </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">DisplayName </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">N = </span><span class="token string" style="color:rgb(255, 121, 198)">'Id'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> E = </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Name </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Setting ManagementGroupID to </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$mgid</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">DisplayName</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">'..."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Retrieving management group with ID '</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$ManagementGroupID</span><span class="token string" style="color:rgb(255, 121, 198)">'..."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$mgid</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzManagementGroup</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">GroupId </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ManagementGroupID</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Expand</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Successfully retrieved management group with ID '</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$ManagementGroupID</span><span class="token string" style="color:rgb(255, 121, 198)">'."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Retrieving subscription IDs from management group '</span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$mgid</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">DisplayName</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">'..."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$subIds</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzSubscriptionsFromManagementGroup</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ManagementGroupName </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ManagementGroupID</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">foreach</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$subId</span><span class="token plain"> in </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$subIds</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Setting subscription context for subscription </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$subId</span><span class="token string" style="color:rgb(255, 121, 198)">..."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Set-AzContext</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Subscription </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$subId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Id</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resources</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzResource</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Found resources in subscription </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$subId</span><span class="token string" style="color:rgb(255, 121, 198)">."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">foreach</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resource</span><span class="token plain"> in </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resources</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Processing resource </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$resource</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Name</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">..."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$tags</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resource</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Tags</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$null</span><span class="token plain"> </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$tags</span><span class="token plain"> </span><span class="token operator">-or</span><span class="token plain"> </span><span class="token operator">-not</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$tags</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ContainsKey</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$tagName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Resource </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$resource</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Name</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)"> does not have 'resource-owner' and  tags. Adding tags..."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$endTime</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-Date</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$startTime</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$endTime</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">AddDays</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">-</span><span class="token plain">7</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$owners</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzLog</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ResourceId </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resource</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ResourceId </span><span class="token operator">-</span><span class="token plain">StartTime </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$startTime</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">EndTime </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$endTime</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Where-Object</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Authorization</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Action </span><span class="token operator">-like</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"*/write*"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Select-Object</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ExpandProperty Caller </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$owner</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$owners</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Where-Object</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token plain"> </span><span class="token operator">-match</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Select-Object</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">First 1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token comment" style="color:rgb(98, 114, 164)">#Objects created by a Service Principal will tag the objects with a GUID instead of a name by default. You can fix this behavior by giving the Managed Identity the Application Developer role in Entra ID. </span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token comment" style="color:rgb(98, 114, 164)"># If owner is null, stop the script</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$null</span><span class="token plain"> </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$owner</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"No owner found that matches an email address."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token comment" style="color:rgb(98, 114, 164)"># Output owners</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Owners: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$owners</span><span class="token string" style="color:rgb(255, 121, 198)">, selected owner: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$owner</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$existingTags</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resource</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Tags</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$modifiedTags</span><span class="token plain"> = @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$tagName</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$owner</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token comment" style="color:rgb(98, 114, 164)"># Merge existing tags with new tags</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$allTags</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$existingTags</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$modifiedTags</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resource</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Set-AzResource</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Tag </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$allTags</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Force</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>The script is also held on <a href="https://github.com/lukemurraynz/Azure/blob/main/Azure%20Automation/Tag-ResourceOwner.ps1" target="_blank" rel="noopener noreferrer">GitHub</a>, so feel free to raise an Issue or Pull Request if you have any improvements.
If there are no logged users due to the resource being written to or created outside of the Log retention, the resource will be skipped.</p></div></div>
<p>This script could be extended with the <a href="https://techcommunity.microsoft.com/t5/azure-governance-and-management/announcing-the-public-preview-of-change-actor/ba-p/4076626?WT.mc_id=AZ-MVP-5004796#:~:text=Identifying%20who%20made%20a%20change,all%20your%20tenants%20and%20subscriptions" target="_blank" rel="noopener noreferrer">Change Actor feed</a> to determine who made a recent change to the resource.</p>]]></content>
        <author>
            <name>Luke Murray</name>
            <uri>https://luke.geek.nz</uri>
        </author>
        <category label="Azure" term="Azure"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Enterprise Policy as Code with Azure DevOps]]></title>
        <id>https://luke.geek.nz/azure/enterprise-policy-code-azure-devops/</id>
        <link href="https://luke.geek.nz/azure/enterprise-policy-code-azure-devops/"/>
        <updated>2024-02-18T23:25:11.692Z</updated>
        <summary type="html"><![CDATA[Enterprise Azure Policy as Code, or EPAC for short, comprises a number of scripts which can be used in a CI/CD-based system or a semi-automated use to deploy Policies, Policy Sets, Assignments, Policy Exemptions and Role Assignments. Let us take a look at its use.]]></summary>
        <content type="html"><![CDATA[<p>Enterprise Azure Policy as Code (EPAC) comprises a number of scripts which can be used in a CI/CD-based system or a semi-automated use to deploy Azure Policies, Policy Sets, Assignments, Policy Exemptions and Role Assignments! This is a great way to ensure that your Azure environment complies with your company's policies and standards, so let us look at it!</p>
<p><img decoding="async" loading="lazy" alt="Blog Heading - EPAC ADO" src="https://luke.geek.nz/assets/images/BlogHeading_EPAC_ADO-a41d97fd00f51d878eaeb05f1062f2f0.png" width="1200" height="628" class="img_ev3q"></p>
<!-- -->
<p><a href="https://azure.github.io/enterprise-azure-policy-as-code/" target="_blank" rel="noopener noreferrer">Enterprise Azure Policy as Code (EPAC)</a> allows you to define and deploy your Azure policies and exemptions as code. This is a great way to ensure consistency of one or more Azure environments, including managing your exemptions in a way that is auditable and a way that can be integrated into CI/CD pull request approval processes.</p>
<p>So, let's delve a little further into it.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-enterprise-azure-policy-as-code">What is Enterprise Azure Policy as Code?<a href="https://luke.geek.nz/azure/enterprise-policy-code-azure-devops/#what-is-enterprise-azure-policy-as-code" class="hash-link" aria-label="Direct link to What is Enterprise Azure Policy as Code?" title="Direct link to What is Enterprise Azure Policy as Code?">‚Äã</a></h2>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Enterprise Azure Policy as Code, or EPAC for short, comprises a number of scripts which can be used in a CI/CD-based system or a semi-automated use to deploy Policies, Policy Sets, Assignments, Policy Exceptions and Role Assignments.</p><p>Main features include:</p><ul>
<li>Multi-tenant/environment policy deployment</li>
<li>Easy CI/CD Integration</li>
<li>Extract existing policy objects from an environment</li>
<li>Support JSON and CSV inputs for large, complex policies</li>
<li>PowerShell Module</li>
<li>Integration with Azure Landing Zone recommended policies</li>
<li>Starter Kit with examples</li>
<li>Schema to provide Intellisense for VS Code development</li>
</ul></div></div>
<p>Enterprise Policy as Code, runs primarily on PowerShell scripts, at the time of writing, there is 114 PowerShell scripts that make up this solution <em>(not all are in use for day-to-day operations)</em>, from the actual deployment to the plan, importing existing policies and initiatives, creating GitHub or Azure DevOps issues, for policy remediation tasks and even importing Azure Landing Zone policies into the solution, this solution is jam-packed with an ever-expanding toolset.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>It is worth noting that although this solution was designed and implemented by Microsoft employees, this is an <a href="https://opensource.microsoft.com/codeofconduct/" target="_blank" rel="noopener noreferrer">Open Source initiative</a> and is not officially supported by Microsoft, but the community is very active, and the solution is constantly being updated and improved upon. All <a href="https://github.com/Azure/enterprise-azure-policy-as-code/issues" target="_blank" rel="noopener noreferrer">Issues</a> can be raised directly on GitHub, and if you have any queries, concerns or issues, I suggest you look here first.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="why-would-you-use-enterprise-azure-policy-as-code">Why would you use Enterprise Azure Policy as Code?<a href="https://luke.geek.nz/azure/enterprise-policy-code-azure-devops/#why-would-you-use-enterprise-azure-policy-as-code" class="hash-link" aria-label="Direct link to Why would you use Enterprise Azure Policy as Code?" title="Direct link to Why would you use Enterprise Azure Policy as Code?">‚Äã</a></h2>
<p>So, why would you use EPAC? Before we go into that - let's go back to basics - Azure Policy.</p>
<p><img decoding="async" loading="lazy" alt="What is Azure Policy" src="https://luke.geek.nz/assets/images/WhatIsAzurePolicy-b02306db2a09442ad39eab10756720af.png" width="1680" height="945" class="img_ev3q"></p>
<p><a href="https://learn.microsoft.com/azure/governance/policy/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure policies</a> are essential to Azure governance; they are the 'make it so' of the Azure environment <em>(and beyond)</em>.</p>
<p>The policies exist to help across areas such as:</p>
<ul>
<li>Maintain regulatory compliance with industry standards</li>
<li>Security and performance consistencies</li>
<li>Enterprise-wide design principles</li>
<li>Controlling cost</li>
</ul>
<p>But how do they do that? Let us take a look at the definitions that make them sing!</p>
<p>For this, we are to look at some of the key components of a definition for the 'Function apps should authenticate to Azure Container Registry using a managed identity' policy.</p>
<p><img decoding="async" loading="lazy" alt="Azure Policy definition" src="https://luke.geek.nz/assets/images/PolicyDefinition-abd0e9ab78b3adc92f5a82019c89215b.png" width="1680" height="945" class="img_ev3q"></p>
<ul>
<li>Metadata</li>
<li>Parameters</li>
<li>Rules</li>
</ul>
<p>Metadata includes items such as: DisplayName, Mode <em>(Indexed vs All)</em>, version and categories.
Parameters give you the flexibility to adjust your policy to your environment, in this case, the policy is looking for a specific Azure Container Registry, but you could have a parameter for the resource group, the subscription, or even the identity that it uses, which can be adjusted to be unique between environments.
Rules are the actual policy; in this case, the policy is looking for a specific identity to be used to authenticate to the Azure Container Registry but will contain the type of resources that the policy will affect, the aliases or resource properties that it needs to look for to evaluate against, and even change.</p>
<p>So, why would you use EPAC? Imagine you have a large number of policies, a large number of environments, or even a large number of policy exemptions, managing your policies as code is a great way to manage them all in a consistent and auditable way, especially when you are working with different versions of policies, and policies deployed to different scopes as well.</p>
<p><img decoding="async" loading="lazy" alt="Azure Policy Scopes" src="https://luke.geek.nz/assets/images/EnterprisePolicyAsCode_PolicyAssignmentScope-7d18c856613c5eb49fafde315dae583b.png" width="1680" height="945" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-do-you-use-enterprise-azure-policy-as-code">How do you use Enterprise Azure Policy as Code?<a href="https://luke.geek.nz/azure/enterprise-policy-code-azure-devops/#how-do-you-use-enterprise-azure-policy-as-code" class="hash-link" aria-label="Direct link to How do you use Enterprise Azure Policy as Code?" title="Direct link to How do you use Enterprise Azure Policy as Code?">‚Äã</a></h2>
<p>Now that we have looked into some of the complexity of Azure policies, especially at scale. Let us take a look into how we can get going with <a href="https://azure.github.io/enterprise-azure-policy-as-code/" target="_blank" rel="noopener noreferrer">Enterprise Policy as Code</a>.</p>
<p>In this article, I am going to assume a few things:</p>
<ol>
<li>You have permission to deploy policies and policy assignments in your Azure environment</li>
<li>You have an Azure DevOps environment (we will use Azure DevOps pipelines in this article, however there is also GitHub action workflows that can be used if you are using GitHub as well) and <a href="https://azure.github.io/enterprise-azure-policy-as-code/ci-cd-app-registrations/" target="_blank" rel="noopener noreferrer">Service Connection configured</a>.</li>
</ol>
<p>We are going to leverage the EPAC <a href="https://github.com/Azure/enterprise-azure-policy-as-code/tree/main/StarterKit" target="_blank" rel="noopener noreferrer">StarterKit</a>, for the pipelines and scripts.</p>
<p>Before we get CI/CD pipelines set up, we need to do a few things locally first.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-1-import-existing-policies">Step 1: Import existing policies<a href="https://luke.geek.nz/azure/enterprise-policy-code-azure-devops/#step-1-import-existing-policies" class="hash-link" aria-label="Direct link to Step 1: Import existing policies" title="Direct link to Step 1: Import existing policies">‚Äã</a></h3>
<p>So, let's import our existing policies and set up our environment! I highly recommend importing your existing environment first, as this will give you a good starting point for your policies, policy sets and exemptions.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>This requires a computer running: <a href="https://learn.microsoft.com/powershell/scripting/install/installing-powershell-on-windows?view=powershell-7.4&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">PowerShell</a> 7.3.1 or later, 7.3.4 <em>(latest)</em> recommended, and the <a href="https://learn.microsoft.com/powershell/azure/install-azure-powershell?view=azps-11.3.0&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure PowerShell</a> module installed (Az required 9.3.0 or later).</p></div></div>
<p>In my environment, I have a range of Custom and Builtin policies and initiatives, that are mostly deployed to at the top level, including Sandbox policies, and am I also running an NZISM 3.5 initiative, which is a builtin iniative but not the most up-to-date, so as part of the EPAC implementation, I want to replace the policy assignment with 3.6 custom and assign my Sandbox policies to the Sandbox Management Group.</p>
<p>So let us get cracking!</p>
<ol>
<li>First, we need to install the EPAC PowerShell module and the Az module and connect to our Azure environment.</li>
</ol>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Install-Module</span><span class="token plain"> EnterprisePolicyAsCode </span><span class="token operator">-</span><span class="token plain">Scope CurrentUser</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Install-Module</span><span class="token plain"> Az </span><span class="token operator">-</span><span class="token plain">Scope CurrentUser</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Connect-AzAccount</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Install PowerShell modules" src="https://luke.geek.nz/assets/images/EPAC_InstallPowerShellModules-254029f276bc1c4a575625334538f865.gif" width="1427" height="430" class="img_ev3q"></p>
<ol start="2">
<li>Once that's installed and you are connected to the Azure environment that you want to export your policies from, now we can do the export. To do the export, you have to generate a BuildDefinition folder to contain your policies, assignments and exemptions.</li>
</ol>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">New-EPACDefinitionFolder</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">DefinitionsRootFolder Definitions</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Create Definitions folder" src="https://luke.geek.nz/assets/images/EPAC_CreateDefinitionsFolder-0c8ac69994b2446e31f8d70ee41b5b70.gif" width="1427" height="430" class="img_ev3q"></p>
<p>That will create the following folders and files, giving us the base scaffolding for Enterprise Policy as Code:</p>
<table><thead><tr><th>Folder &amp; Files</th><th>Type</th><th>Notes</th></tr></thead><tbody><tr><td>policyAssignments</td><td>Folder</td><td>Contains your Assignments (for both Policy and Initiatives)</td></tr><tr><td>policyDefinitions</td><td>Folder</td><td>Contains your Policy Definitions</td></tr><tr><td>policyDocumentations</td><td>Folder</td><td>Contains documentation about your policies</td></tr><tr><td>policySetDefinitions</td><td>Folder</td><td>Contains the definitions for your initiatives (or PolicySets)</td></tr><tr><td>global-settings.jsonc</td><td>File</td><td>Main configuration file, containing your environments and deployment paths</td></tr></tbody></table>
<ol start="3">
<li>Now that we have our base, scaffold - before we can import our existing Definitions and Assignments, we need to edit the 'global-settings.jsonc' file, to add in environment context.</li>
</ol>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>The file is a JSONC file, which is a JSON file with comments, so you can add comments to the file, which is great for documentation. The same jsonc format is also used for PolicyDefinitions and assignments, allowing you to add more context and notes to your policies and assignments! I encourage you to use this functionality to add notes and comments to your assignments!</p></div></div>
<p>So open the global-settings.jsonc file, and paste the following example:</p>
<div class="language-jsonc codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsonc codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        "$schema": "https://raw.githubusercontent.com/Azure/enterprise-azure-policy-as-code/main/Schemas/global-settings-schema.json",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        "pacOwnerId": "f2ce1aea-944e-4517-94fb-edada00633ae", // Generate a guid using New-Guid and place it here</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        "managedIdentityLocations": {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            "*": "australiaeast" // Update the default location for managed identities</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        "globalNotScopes": {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            "*": [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                "/resourceGroupPatterns/excluded-rg*"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            ]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        "pacEnvironments": [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                "pacSelector": "quick-start",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                "cloud": "AzureCloud",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                "tenantId": "bdb8ea1c-17da-4423-8895-6b79af002b4e", // Replace this with your tenant Id</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                "deploymentRootScope": "/providers/Microsoft.Management/managementGroups/root" // Replace this with a management group that represents the functional root in your environment. </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Create global-settings.jsconc" src="https://luke.geek.nz/assets/images/EPAC_Create-global-settings.jsconc-112062cb27d7038ca537f96c06032d52.gif" width="1651" height="912" class="img_ev3q"></p>
<p><strong>Reference: <a href="https://azure.github.io/enterprise-azure-policy-as-code/quick-start/" target="_blank" rel="noopener noreferrer">EPAC Quick Start</a></strong></p>
<p>We now need to define our overall environment, and we can start by using PowerShell to generate our own unique pacOwnerId.</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">New-Guid</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The pacOwner helps to identify who or what owns an Assignment or Policy definition deployment and needs to be unique to your EPAC environment. The pacOwnerId is used to identity policy resources that are deployed by your EPAC repository, or another EPAC isntance, legacy or another solution entirely.</p>
<p>Another thing you may need to adjust is the managedIdentityLocations, this is the default location for managed identities that are used for policies that are DeployIfNotExist and Modify. This is the location that the managed identity will be created in, if it does not exist. I will keep this as the example, AustraliaEast which is the primary region that my resources are deployed into.</p>
<p>If you run multiple regions, you can remove the wildcard and replace it with the pacEnvironments name that represents your other regions.</p>
<p>Although you can add exclusions to your individual Policy and PolicySetAssignments, the globalNotScopes is a way to exclude resources from all Policy and PolicySetAssignments, without having to add it to every single assignment, in this case, the example excludes all resources that are in a resource group that starts with 'excluded-rg'. You can exclude resources at different scopes, ie Resource Group, Subscriptions, Resouce Groups.</p>
<p>Now, lets take a look at pacEnvironments. pacEnvironments is a way to define your environments, and the deploymentRootScope is the scope that represents the functional root in your environment. This is the top scope that all your Policy and PolicySetAssignments will be deployed to, and is the scope that you will be deploying your policies definitions to.</p>
<p>The pacSelector will be used in your assignments to select what environment and scope you are deploying to, as you can have multiple environments, so give it a name that you can understand - ie 'epac-prod', 'epac-dev', 'epac-qa' etc. This will be reused in your assignments and pipelines.</p>
<p>Make sure the tenantId matches your Entra ID and the deploymentRootScope is the top-level scope that you want to deploy your policies to.</p>
<p>Save the file.</p>
<ol start="4">
<li>The next step is to import your existing policies and assignments, the commands will use the information you just defined in the 'global-settings.jsonc' file, to review of the scope and the environment of the export.</li>
</ol>
<p>To do that, we will go back to PowerShell:</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token function" style="color:rgb(80, 250, 123)">Export-AzPolicyResources</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">DefinitionsRootFolder </span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">\Definitions </span><span class="token operator">-</span><span class="token plain">OutputFolder Output</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Export-AzPolicyResources.gif" src="https://luke.geek.nz/assets/images/Export-AzPolicyResources-274a0a1cef4a119017c2e35e0303f775.gif" width="1425" height="442" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>If you want to target a specific environment, ie you have a Management Group, where you want to deploy your policies and test using the Azure Portal first <strong>(this can be useful for quickly importing assignments and policies in a format that's ready to go by EPAC)</strong>, then you can add the '-InputPacSelector' parameter and target a specific environment for export, else it will do all environments listed in the global-settings.</p></div></div>
<p>Depending on the complexity of your environment, it could take a while, but once it is done, you will have a new folder called 'Output', which will contain an export of your policy-ownerships, definitions, assignments and exemptions in an Enterprise Policy as Code useable format <em>(JSON)</em>.</p>
<p>Your Output folder will contain the policy exemptions, assignments, and definitions of your existing environment.</p>
<p>You can copy the files and folders from the Output folder, into the original Definitions folder, originally created, to bring in your existing policies and assignments into your EPAC environment.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>Now is a great time to look at those exemptions and policy assignments and see if they are still relevant, and if they are, add comments to the files to give context to the assignments and exemptions and to help with the deployment of the policies and assignments in the future.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-2-configure-azure-devops">Step 2: Configure Azure DevOps<a href="https://luke.geek.nz/azure/enterprise-policy-code-azure-devops/#step-2-configure-azure-devops" class="hash-link" aria-label="Direct link to Step 2: Configure Azure DevOps" title="Direct link to Step 2: Configure Azure DevOps">‚Äã</a></h3>
<p>Now that we have our policies and assignments imported, we can now configure our Azure DevOps environment, to automatically deploy them. I am going to go through the process from the beginning but feel free to skip to the relevant sections if you already have a project and repository setup.</p>
<ol>
<li>Login to Azure DevOps</li>
<li>Create a new project</li>
<li>Give the project a name, and a description, and select the visibility of the project <strong>(ie Private)</strong></li>
<li>Click 'Create'</li>
<li>Navigate to Repos</li>
<li>Click on Files</li>
<li>Initialize the repository with a README or add a new file</li>
</ol>
<p><img decoding="async" loading="lazy" alt="Create EPAC ADO Project" src="https://luke.geek.nz/assets/images/Create-ADO_EPACProject-35acaa80d23ed95c3393478b99d48bc6.gif" width="1905" height="964" class="img_ev3q"></p>
<p>Now that the repository has been initialized. We can now add the files from the EPAC StarterKit to the repository.</p>
<p>Clone the repository to your local computer copy the Definitions folder to the repository and commit.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>You can Clone the Git repository using <a href="https://azuredevopslabs.com/labs/azuredevops/git/?T.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Visual Studio Code</a>, or Git CLI or even <a href="https://luke.geek.nz/2021/12/30/git-using-github-desktop-on-windows-for-sysadmins/" target="_blank" rel="noopener noreferrer">GitHub Desktop</a>.</p></div></div>
<p>Once cloned, copy the Definitions folder from the Output folder, into the repository, and commit the changes.</p>
<p>Now that we have our repository setup, we can now create a pipeline to deploy our policies and assignments, to get started we will grab the Azure Pipelines from the <a href="https://github.com/Azure/enterprise-azure-policy-as-code/tree/main/StarterKit/Pipelines" target="_blank" rel="noopener noreferrer">StarterKit</a> folder, and copy them into the repository, along with the Scripts folder.</p>
<p>For this article, we will use the single-tenant-pipeline.yml file, as we are only deploying to a single environment, but if you are deploying to multiple environments, you can use the multi-tenant-pipeline.yml file.</p>
<p><img decoding="async" loading="lazy" alt="Create ADO Pipeline" src="https://luke.geek.nz/assets/images/Create_ADO-PipelineTemplate-131d7d4064333057e45023afd10bc612.gif" width="1905" height="964" class="img_ev3q"></p>
<p>Once downloaded, make sure you commit it to your repository. We will have to edit the pipeline, but before we do that - we need a Service Connection for Azure DevOps to connect to Azure to deploy the policies and assignments.</p>
<ol>
<li>Open your EPAC Azure DevOps project</li>
<li>Click on Project Settings</li>
<li>Select Service Connections</li>
<li>Click on Create Service Connection</li>
<li>Click Azure Resource Manager</li>
<li>Click Next</li>
<li>Select Workload Identity Federation (Automatic) and click Next</li>
<li>Select Management Group</li>
<li>Select your top-level management group, that matches your Enterprise Policy as Code environment (ie where the definitions will be deployed to)</li>
<li>Type in a name and description and click Save <strong>(make sure this is a name that is easy to understand, and what its function is, we will reuse the name in our pipelines)</strong></li>
</ol>
<p><img decoding="async" loading="lazy" alt="Create Service Principal" src="https://luke.geek.nz/assets/images/Create_ADO-SPN-7c51a1d317687cbfca9f09efa4646cce.gif" width="1905" height="964" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Enterprise Policy as Code (EPAC) suggests the least privileged and just enough permissions to deploy the policies, assignment and RBAC <strong>(Role Based Access Control)</strong> where they need to.</p><p>The pipeline itself will look for the following separate Service Connections:</p><ul>
<li>devServiceConnection - This service connection is used for development purposes, allowing the pipeline to connect to the development environment and deploy policies and assignments.</li>
<li>tenantPlanServiceConnection - This service connection is used for managing the policy plan, which includes creating and updating policy definitions, policy sets, and policy initiatives.</li>
<li>tenantDeployServiceConnection - This service connection is used for deploying policy assignments and exemptions to the target environment.</li>
<li>tenantRolesServiceConnection - This service connection is used for managing RBAC (Role-Based Access Control) roles and permissions in the target environment.</li>
</ul><p>So consider whether you have separate scopes and service principals for your environments.</p></div></div>
<p>For the purposes of this article, I am going to use the same service principal to deploy all the EPAC functions, so let's edit the pipeline to use it.</p>
<ol>
<li>You can edit the Pipeline, either locally with Visual Studio Code and recommit it, or edit it directly in Azure DevOps, update the following variables with the relevant service connection names:</li>
</ol>
<ul>
<li>devServiceConnection</li>
<li>tenantPlanServiceConnection</li>
<li>tenantDeployServiceConnection</li>
<li>tenantRolesServiceConnection</li>
</ul>
<p><img decoding="async" loading="lazy" alt="Edit ADO Pipeline" src="https://luke.geek.nz/assets/images/Edit_ADO-Pipeline_SPN-59f9f6285d55fdebcd41ddf30877575d.gif" width="1905" height="964" class="img_ev3q"></p>
<p>The single-tenant Azure DevOps pipeline has 5 stages:</p>
<table><thead><tr><th>Stage</th><th>Notes</th></tr></thead><tbody><tr><td>devStage</td><td>This stage is used for planning, deploying, and assigning roles in the development environment. It uses the&nbsp;devServiceConnection&nbsp;to connect to Azure. The stage is only executed if the build reason is 'Manual', 'IndividualCI', or 'BatchedCI' and the source branch is not 'main'.</td></tr><tr><td>tenantPlanFeatureStage</td><td>This stage is used for planning feature branches in the tenant environment. It uses the tenantPlanServiceConnection to connect to Azure. This stage depends on the devStage and is only executed if the devStage has not failed or been canceled, the build reason is 'Manual', 'IndividualCI', or 'BatchedCI', and the source branch is not 'main'.</td></tr><tr><td>tenantPlanMainStage</td><td>This stage is used for planning the main branch in the tenant environment. It uses the tenantPlanServiceConnection to connect to Azure. This stage depends on the tenantPlanFeatureStage and is only executed if the tenantPlanFeatureStage has not failed or been canceled, the build reason is 'Manual', 'IndividualCI', or 'BatchedCI', and the source branch is 'main'.</td></tr><tr><td>tenantDeployPolicyStage</td><td>This stage is used for deploying policies in the tenant environment. It uses the tenantDeployServiceConnection to connect to Azure. This stage depends on the tenantPlanMainStage and is only executed if the tenantPlanMainStage has not failed or been canceled, the tenantPlanMainStage has policy changes to deploy, the build reason is 'Manual', 'IndividualCI', or 'BatchedCI', and the source branch is 'main'.</td></tr><tr><td>tenantRolesStage</td><td>This stage is used for deploying role assignments in the tenant environment. It uses the tenantRolesServiceConnection to connect to Azure. This stage depends on the tenantDeployPolicyStage and is only executed if the tenantDeployPolicyStage has not failed or been canceled, the tenantPlanMainStage has role changes to deploy, the build reason is 'Manual', 'IndividualCI', or 'BatchedCI', and the source branch is 'main'.</td></tr></tbody></table>
<p>The name 'Tenant' is used to represent the environment that the policies and assignments are being deployed to. Tenant is the default name of the EPAC environment, so we will need to change this, to reflect our own environments. This is the pacSelector name, in the global-settings.jsonc file, that we created earlier.</p>
<p>I will go back and add a new Service Connection, for Development, and add another development environment to the global-settings.jsonc. You don't need to do this, but it does give you the option to test your policies and assignments before deploying them to your main environment.</p>
<p>Now we need to edit the pipeline again, to align to our pacEnvironments.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>You could do a a full Find and Replace, of the Word Tenant on the pipeline and replace it with your Production pacEnvironment name, just be wary that the stage name is used as a depedency for other steps, so you will need to make sure all references have been updated.</p></div></div>
<p>Once you have made the changes, commit the pipeline to your repository.</p>
<p><img decoding="async" loading="lazy" alt="Edit ADO Pipeline - pacEnvironment" src="https://luke.geek.nz/assets/images/Edit_ADO-Pipeline_pacEnvironments-07b7d7bbe8d09e9716bb05d15ea2c305.gif" width="1905" height="964" class="img_ev3q"></p>
<p>Before we look at actually running the pipeline and redeploying the policies under Enterprise Policy as Code, we need to be aware of another environment option - and that is desiredState.</p>
<p>desiredState allows you to control, how much control EPAC has over your environment, ie how much of a 'make it so'.</p>
<p>desiredState options are:</p>
<ul>
<li>full</li>
<li>ownedOnly</li>
</ul>
<p>If the desired state strategy is 'Full', then EPAC will manage all the policies and assignments in the environment and will remove any policies and assignments that are not in the EPAC repository.
If the desiredState strategy is 'ownedOnly', then EPAC will only manage the policies and assignments that are in the EPAC repository, and will not remove any policies and assignments that are not in the EPAC repository.</p>
<p>Full is the default desiredState, so if you want to use ownedOnly, you will need to add the desiredState to the global-settings.jsonc file for the environment.</p>
<div class="language-jsonc codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsonc codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">// desiredState is an optional object that specifies the desired state of the environment.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          "desiredState": { // [optional]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              // strategy specifies the strategy to achieve the desired state. The default is "full".</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              "ownedOnly": "full" // default full</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Another environment option is related to Defender for Cloud. <a href="https://learn.microsoft.com/azure/defender-for-cloud/policy-reference?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Defender for Cloud</a> uses Azure Policy Assignments to enable and configure the various capabilities.
Enterprise Policy as Code could remove the Defender for Cloud assignments if they are not in the EPAC repository, so you can add the following to the global-settings.jsonc file to prevent this from happening.</p>
<div class="language-jsonc codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsonc codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain"> "desiredState": { // [optional]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              // strategy specifies the strategy to achieve the desired state. The default is "full".</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              "strategy": "full" ,// default full</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              "keepDfcSecurityAssignments": true // default false</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If set to true or strategy is ownedOnly, EPAC will not remove Security Policy assignments created by Defender for Cloud.
If omitted or set to false and strategy is full, EPAC will remove Security Policy Set Assignments created by Defender for Cloud.</p>
<p>Even though these settings are managed by the default behaviour of Enterprise Policy as Code, I prefer to make sure they are added in the configuration for awareness. Security Policies should be managed by EPAC at the Management Group level; this is the recommended approach for managing Security Policies instead of relying on the auto-assignments, but as usual, it comes down to business requirements.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-3-run-the-pipeline">Step 3: Run the Pipeline<a href="https://luke.geek.nz/azure/enterprise-policy-code-azure-devops/#step-3-run-the-pipeline" class="hash-link" aria-label="Direct link to Step 3: Run the Pipeline" title="Direct link to Step 3: Run the Pipeline">‚Äã</a></h3>
<div class="theme-admonition theme-admonition-danger admonition_xJq3 alert alert--danger"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>danger</div><div class="admonitionContent_BuS1"><p>Make sure you test your deployment in a development environment before deploying to your main environment, especially if you are using the 'full' desiredState strategy.</p></div></div>
<p>Now it's time to import the pipeline.</p>
<ol>
<li>Login to Azure DevOps</li>
<li>Navigate to your EPAC project</li>
<li>Navigate to Pipelines</li>
<li>Click on Create Pipeline</li>
<li>Click on Azure Repos Git</li>
<li>Select your repository</li>
<li>Select Existing Azure pipelines YAML file</li>
<li>Under path, select single-tenant-pipeline.yml</li>
<li>Click Save</li>
</ol>
<p><img decoding="async" loading="lazy" alt="Import ADO Pipeline" src="https://luke.geek.nz/assets/images/Import_ADO-Pipeline-c0c611311aca5b5fff308746e277797d.gif" width="1905" height="964" class="img_ev3q"></p>
<p>Now that it's imported, we can run the pipeline. The first pipeline deployment is aimed at making the state of Azure match the EPAC environment and also giving access to the pipelines to the Service Connections.</p>
<p><img decoding="async" loading="lazy" alt="Run ADO Pipeline" src="https://luke.geek.nz/assets/images/Run_ADO-Pipeline-72afa5d25f14d97a32c20e47e2a72943.gif" width="1905" height="964" class="img_ev3q"></p>
<p>If this is the first time the pipeline has been run, there may be delays, as you need to approve the pipeline to be able to use the Service Connections.</p>
<p>Congratulations! You have deployed your Azure Policy as Code!</p>
<p>If you login to the Azure Portal and navigate to your <a href="https://portal.azure.com/#view/Microsoft_Azure_Policy/PolicyMenuBlade/~/Assignments" target="_blank" rel="noopener noreferrer">Policies and assignments</a>, they should match.</p>
<p><img decoding="async" loading="lazy" alt="Azure Policy Assignments" src="https://luke.geek.nz/assets/images/AzurePortal_PolicyAssignments-d9665ddff7687b4d9ee52c07d99066ca.png" width="1860" height="630" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="policy-configuration">Policy configuration<a href="https://luke.geek.nz/azure/enterprise-policy-code-azure-devops/#policy-configuration" class="hash-link" aria-label="Direct link to Policy configuration" title="Direct link to Policy configuration">‚Äã</a></h2>
<p>Now that the policies and assignments are deployed, you can start to configure your policies and assignments to match your environment.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="change-assignment-scope">Change assignment scope<a href="https://luke.geek.nz/azure/enterprise-policy-code-azure-devops/#change-assignment-scope" class="hash-link" aria-label="Direct link to Change assignment scope" title="Direct link to Change assignment scope">‚Äã</a></h3>
<p>In my scenario, my Sandbox policies are assigned to my Lukegeeknz Management Group, and I want them to be assigned to my Sandbox Management Group, so I will need to update the policy assignments to reflect this.</p>
<p>I will test this by deploying it into a New Branch, which will trigger the dev Plan.</p>
<p><img decoding="async" loading="lazy" alt="Change assignment scope" src="https://luke.geek.nz/assets/images/Change_EPAC-AssignmentScopeSandbox-b20af13b32d9f00de96df5bbc45c6289.gif" width="1905" height="964" class="img_ev3q"></p>
<p>And we can see in the plan that the assignment will change successfully.</p>
<p><img decoding="async" loading="lazy" alt="Azure DevOps epac-dev plan" src="https://luke.geek.nz/assets/images/Run_ADO-Pipeline_Dev_Plan-592f4f43bc055370866dba7cec16af03.png" width="1110" height="747" class="img_ev3q"></p>
<p>Now, let's merge or change into Production by opening up a Pull Request; once approved and merged, the Sandbox assignment will be updated in Production.</p>
<p><img decoding="async" loading="lazy" alt="EPAC Pull Request" src="https://luke.geek.nz/assets/images/Change_EPAC-AssignmentScopeSandboxPR-603ce031e8264642485384496e822f89.gif" width="1905" height="964" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="Azure Policy Assignment" src="https://luke.geek.nz/assets/images/AzurePortal_PolicyAssignments.pngAfterChange-07735dd82cf91181554af7de91fca2c3.png" width="1630" height="634" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="reference">Reference<a href="https://luke.geek.nz/azure/enterprise-policy-code-azure-devops/#reference" class="hash-link" aria-label="Direct link to Reference" title="Direct link to Reference">‚Äã</a></h2>
<p>You can view my EPAC code for reference directly on GitHub: <a href="https://github.com/lukemurraynz/EPAC_ADO" target="_blank" rel="noopener noreferrer">lukemurraynz/EPAC_ADO</a>.</p>]]></content>
        <author>
            <name>Luke Murray</name>
            <uri>https://luke.geek.nz</uri>
        </author>
        <category label="Azure" term="Azure"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Accessing KeyVault from Azure DevOps]]></title>
        <id>https://luke.geek.nz/azure/accessing-keyvault-azure-devops/</id>
        <link href="https://luke.geek.nz/azure/accessing-keyvault-azure-devops/"/>
        <updated>2024-02-03T10:56:08.514Z</updated>
        <summary type="html"><![CDATA[Access an Azure Key vault from a Microsoft-hosted agent in Azure DevOps]]></summary>
        <content type="html"><![CDATA[<p>If you are running a <a href="https://learn.microsoft.com/azure/devops/pipelines/agents/agents?view=azure-devops&amp;tabs=yaml%2Cbrowser&amp;WT.mc_id=AZ-MVP-5004796#microsoft-hosted-agents" target="_blank" rel="noopener noreferrer">Microsoft-hosted Azure DevOps agent</a>, you may need to access a <a href="https://azure.microsoft.com/products/key-vault?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">KeyVault</a> to retrieve secrets. This is a common scenario when deploying resources to Azure.</p>
<p>In this post, I will show you how to access a KeyVault from an Azure DevOps pipeline by adding the IP of the Azure DevOps agent directly into your Azure Keyvault and removing it after it retrieves the secrets.</p>
<p><img decoding="async" loading="lazy" alt="Accessing KeyVault from a Azurne DevOps&nbsp;Microsoft&nbsp;Hosted&nbsp;Agent" src="https://luke.geek.nz/assets/images/BlogHeadingAccessingKeyVaultfromAzureDevOps-544d1dbdffe23f468b00b7e0022bd75d.gif" title="Accessing KeyVault from a Azurne DevOps&nbsp;Microsoft&nbsp;Hosted&nbsp;Agent" width="1200" height="628" class="img_ev3q"></p>
<!-- -->
<p>When attempting to retrieve secrets from a KeyVault using Azure DevOps, you may get an error such as:</p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>##[error]Get secrets failed. Error: Client address is not authorized and caller is not a trusted service.</p></div></div>
<p>This is due to the Firewall of the Keyvault being enabled, which is best practice.</p>
<p>You have a few options here:</p>
<ul>
<li>Option 1: Enable private endpoint for the KeyVault and use a <a href="https://learn.microsoft.com/azure/devops/pipelines/agents/agents?view=azure-devops&amp;tabs=yaml%2Cbrowser&amp;WT.mc_id=AZ-MVP-5004796#self-hosted-agents" target="_blank" rel="noopener noreferrer">self-hosted agent</a>. This is the most secure option, but it requires more setup and configuration, and a self-hosted agent, running on a Virtual Machine or <a href="https://luke.geek.nz/azure/hosted-agents-container-apps-job/" target="_blank" rel="noopener noreferrer">Container Apps</a>.</li>
<li>Option 2: Add the IP of the Azure DevOps agent to the KeyVault firewall rules. This is the easiest option, but it's not the most secure, as the IP address of the Microsoft hosted agents can change <em>(the Microsoft hosted agents have a dynamic IP address)</em>.</li>
</ul>
<p>Not all organisations have the resources to support a self-hosted agent, so we will look at Option 2.</p>
<p><img decoding="async" loading="lazy" alt="Azure KeyVault - Networking Blade (Azure Portal)" src="https://luke.geek.nz/assets/images/Azure_KeyVault_NetworkingPane-05c5e2d8f1cd5c4f5bebd7206b9ea4e4.png" title="Azure KeyVault - Networking Blade (Azure Portal)" width="1681" height="830" class="img_ev3q"></p>
<p>As a status, the Microsoft Hosted agents can come from any number of <a href="https://www.microsoft.com/en-us/download/details.aspx?id=56519?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Microsoft-owned IP addresses</a> from the region, that your Azure DevOps organisation is hosted.</p>
<p>You may immediately want to check the <strong>Allow trusted Microsoft services to bypass this firewall</strong> as an instant thought, but <a href="https://learn.microsoft.com/en-us/azure/key-vault/general/network-security?WT.mc_id=AZ-MVP-5004796#key-vault-firewall-enabled-trusted-services-only" target="_blank" rel="noopener noreferrer"> Azure DevOps</a> is not an assumed trusted Microsoft service, and its not hosted within your subscription boundary.</p>
<p>So, that leaves us with enabling public access to the key vault, right? Because the IP will be different each time? Not quite! What we can do is:</p>
<ol>
<li>Add the IP of the Azure DevOps agent to the KeyVault firewall rules.</li>
<li>Do the task, required from Azure DevOps (i.e. retrieve the secrets)</li>
<li>Remove the IP of the Azure DevOps agent from the KeyVault firewall rules.</li>
</ol>
<p>So, let's take a look at the Tasks you can use in your Azure DevOps pipelines to achieve this.</p>
<p>The following tasks use an Azure CLI command to grab the IP address of the Azure DevOps agent and then add it to the KeyVault firewall rules, and then remove it after the secrets have been retrieved, tasks below. References to the KeyVaultArmSvcConnectionName is the Service Connection that is used to authenticate to the Azure Subscription, so make sure this is adjusted for your environment.
The keyVaultName is the name of the keyVault you want to access.</p>
<p>Note: The condition criteria is set to succeed or fail so that the task will run regardless of whether previous tasks have succeeded or failed.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">AzureCLI@2.yml</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># This task uses Azure CLI to add the IP address of the Azure DevOps agent to the firewall of an Azure Key Vault.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> AzureCLI@2  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Specifies the task to use Azure CLI version 2.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Add Agent IP From Key Vault  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The name displayed for this task in the Azure DevOps pipeline.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">condition</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> succeededOrFailed()  </span><span class="token comment" style="color:rgb(98, 114, 164)"># This task will run regardless of whether previous tasks have succeeded or failed.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The section where you specify input parameters for the task.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">azureSubscription</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> parameters.keyVaultArmSvcConnectionName </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The Azure subscription that the task should use. The value is taken from the keyVaultArmSvcConnectionName parameter.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">scriptType</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> bash  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Specifies that the script to be run is a Bash script.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">scriptLocation</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> inlineScript  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Specifies that the script will be provided directly in the pipeline file, rather than being located in an external file.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Begins the section where the actual script is provided. The | character indicates that a multi-line string will follow.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      agentIP=$(curl </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">s https</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">//checkip.amazonaws.com)  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Uses the curl command to get the public IP address of the Azure DevOps agent and stores it in the agentIP variable.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">echo "Agent IP</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> $agentIP"  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Prints the IP address to the console.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      az keyvault network</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">rule add </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">name "$</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> parameters.keyVaultName </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">" </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">ip</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">address "$agentIP" </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">only</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">show</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">errors  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Uses the Azure CLI to add the IP address of the Azure DevOps agent to the firewall of the Azure Key Vault specified by the keyVaultName parameter. The --only-show-errors option means that the command will only output information if an error occurs.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h1>Remove Agent IP to KeyVault Firewall after your other tasks</h1>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">AzureCLI@2.yml</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># This task uses Azure CLI to remove the IP address of the Azure DevOps agent from the firewall of an Azure Key Vault.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> AzureCLI@2  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Specifies the task to use Azure CLI version 2.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Remove Agent IP From Key Vault  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The name displayed for this task in the Azure DevOps pipeline.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">condition</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> succeededOrFailed()  </span><span class="token comment" style="color:rgb(98, 114, 164)"># This task will run regardless of whether previous tasks have succeeded or failed.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The section where you specify input parameters for the task.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">azureSubscription</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> parameters.keyVaultArmSvcConnectionName </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The Azure subscription that the task should use. The value is taken from the keyVaultArmSvcConnectionName parameter.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">scriptType</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> bash  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Specifies that the script to be run is a Bash script.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">scriptLocation</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> inlineScript  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Specifies that the script will be provided directly in the pipeline file, rather than being located in an external file.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Begins the section where the actual script is provided. The | character indicates that a multi-line string will follow.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      agentIP=$(curl </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">s https</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">//checkip.amazonaws.com)  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Uses the curl command to get the public IP address of the Azure DevOps agent and stores it in the agentIP variable.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">echo "Agent IP</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> $agentIP"  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Prints the IP address to the console.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      az keyvault network</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">rule remove </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">name "$</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> parameters.keyVaultName </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">" </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">ip</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">address "$agentIP" </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">only</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">show</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">errors  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Uses the Azure CLI to remove the IP address of the Azure DevOps agent from the firewall of the Azure Key Vault specified by the keyVaultName parameter. The --only-show-errors option means that the command will only output information if an error occurs.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content>
        <author>
            <name>Luke Murray</name>
            <uri>https://luke.geek.nz</uri>
        </author>
        <category label="Azure" term="Azure"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Using the Azure Naming Tool API to name your Bicep resources]]></title>
        <id>https://luke.geek.nz/azure/azure-naming-tool-api-bicep-resources/</id>
        <link href="https://luke.geek.nz/azure/azure-naming-tool-api-bicep-resources/"/>
        <updated>2024-01-16T03:44:02.021Z</updated>
        <summary type="html"><![CDATA[Deployment of Azure Naming Tool into an Azure WebApp and testing the API.]]></summary>
        <content type="html"><![CDATA[<p>The <a href="https://github.com/mspnp/AzureNamingTool" target="_blank" rel="noopener noreferrer">Azure Naming Tool</a> was created to help administrators define and manage their naming conventions for Azure resources while providing a simple interface for users to generate a compliant name.
The tool was developed using a naming pattern based on <a href="https://learn.microsoft.com/azure/cloud-adoption-framework/ready/azure-best-practices/naming-and-tagging?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Microsoft's best practices</a>. Once an administrator has defined the organizational components, users can use the tool to generate a name for the desired Azure resource.</p>
<p>Today, we will use the Azure Naming Tool API to generate a name for our storage account bicep resource.</p>
<p><img decoding="async" loading="lazy" alt="Azure Naming Tool Logo" src="https://luke.geek.nz/assets/images/azurenamingtoollogo-988ade636a1de804bd46948462c4e980.png" title="Azure Naming Tool Logo" width="750" height="450" class="img_ev3q"></p>
<!-- -->
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="https://luke.geek.nz/azure/azure-naming-tool-api-bicep-resources/#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">‚Äã</a></h2>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>I had a previous Blog article for <a href="https://luke.geek.nz/2022/07/11/deploy-azure-naming-tool-into-an-azure-webapp-as-a-container/" target="_blank" rel="noopener noreferrer">Deploying Azure Naming Tool into an Azure WebApp as a container</a> this was a previous version, as of June 2022, but check it out, if you run into issues with your deployment. Today, we will deploy the latest version at the time of this article straight to a WebApp.</p></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>The process is reasonably well documented directly on <a href="https://github.com/mspnp/AzureNamingTool/wiki" target="_blank" rel="noopener noreferrer">Wiki of GitHub repository</a> for Azure Naming Tool, and it is what I followed, but to trigger the Publishing Profile button (if it greyed out) in the Azure Portal, for a brand new web app, I was able to go into Configuration/General Settings and Turn Basic Auth Publishing Off, Save, then back on, Save, and the button was enabled.</p></div></div>
<p>So, now we have our Azure Naming Tool set up and deployed; we can test it out by using the API to generate a name for our storage account bicep resource.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="scripts">Scripts<a href="https://luke.geek.nz/azure/azure-naming-tool-api-bicep-resources/#scripts" class="hash-link" aria-label="Direct link to Scripts" title="Direct link to Scripts">‚Äã</a></h2>
<blockquote>
<p>To do this, we will have three scripts:</p>
</blockquote>
<ul>
<li><strong>main.bicep</strong> - This is our main bicep file, which will deploy our storage account and use the Azure Naming Tool API to generate a name for it.</li>
<li><strong>command.ps1</strong> - This will be our PowerShell script, which will call the Azure Naming Tool API, generate a name for our storage account, and then trigger the Bicep deployment.</li>
<li><strong>Request-ResourceName.ps1</strong> - This is our PowerShell function that will call the Azure Naming Tool API and return the generated name value.</li>
</ul>
<p>Command.ps1 will call the other scripts.</p>
<p>So let us take a look at those:</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">command.ps1</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Check if the Az.Accounts module is installed</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$module</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-Module</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ListAvailable </span><span class="token operator">-</span><span class="token plain">Name Az</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Accounts</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># If the module is not installed, install it</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$null</span><span class="token plain"> </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$module</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Install-Module</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name Az</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Accounts </span><span class="token operator">-</span><span class="token plain">Scope CurrentUser </span><span class="token operator">-</span><span class="token plain">Force</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Check if the Az.Resources module is installed</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$module</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-Module</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ListAvailable </span><span class="token operator">-</span><span class="token plain">Name Az</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Resources</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># If the module is not installed, install it</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$null</span><span class="token plain"> </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$module</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Install-Module</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name Az</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Resources </span><span class="token operator">-</span><span class="token plain">Scope CurrentUser </span><span class="token operator">-</span><span class="token plain">Force</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Connect-AzAccount -UseDeviceAuthentication</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Import the Request-ResourceName function</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">\</span><span class="token function" style="color:rgb(80, 250, 123)">Request-ResourceName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ps1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Define the API key and the Azure Naming Tool site name</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$API</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">''</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$AzNamingToolSiteName</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">''</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Call the function with some example parameters</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$storageAccountName</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Request-ResourceName</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">API </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$API</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">AzNamingToolSiteName </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$AzNamingToolSiteName</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">resourceEnvironment </span><span class="token string" style="color:rgb(255, 121, 198)">'dev'</span><span class="token plain">  </span><span class="token operator">-</span><span class="token plain">resourceInstance </span><span class="token string" style="color:rgb(255, 121, 198)">'1'</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">resourceLocation </span><span class="token string" style="color:rgb(255, 121, 198)">'aue'</span><span class="token plain">  </span><span class="token operator">-</span><span class="token plain">resourceType </span><span class="token string" style="color:rgb(255, 121, 198)">'st'</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">createdBy </span><span class="token string" style="color:rgb(255, 121, 198)">'me'</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">resourceProjAppSvc </span><span class="token string" style="color:rgb(255, 121, 198)">'spa'</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Select-Object</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ExpandProperty resourceName</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Define the resource group and location</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceGroupName</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">'stgaccount_rg'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Create the resource group if it doesn't exist</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceGroup</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzResourceGroup</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceGroupName</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ErrorAction SilentlyContinue</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$null</span><span class="token plain"> </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceGroup</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">New-AzResourceGroup</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceGroupName</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Location </span><span class="token string" style="color:rgb(255, 121, 198)">'australiaeast'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Deploy the Bicep file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">New-AzResourceGroupDeployment</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ResourceGroupName </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceGroupName</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">TemplateFile </span><span class="token string" style="color:rgb(255, 121, 198)">'./main.bicep'</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">storageAccountName </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$storageAccountName</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">main.bicep</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> storageAccountName </span><span class="token datatype class-name">string</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> location </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">resourceGroup</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">location</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> storageacc </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.Storage/storageAccounts@2023-01-01'</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> storageAccountName</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">location</span><span class="token operator">:</span><span class="token plain"> location</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">accessTier</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Hot'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">sku</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain">  </span><span class="token string" style="color:rgb(255, 121, 198)">'Standard_LRS'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">kind</span><span class="token operator">:</span><span class="token plain">  </span><span class="token string" style="color:rgb(255, 121, 198)">'BlobStorage'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">Request-ResourceName.ps1</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Define the function that requests a resource name</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Request-ResourceName</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Define the parameters that the function accepts</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[Parameter(Mandatory=$true)]</span><span class="token plain"> </span><span class="token namespace">[string]</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$API</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The API key</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[Parameter(Mandatory=$true)]</span><span class="token plain"> </span><span class="token namespace">[string]</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$AzNamingToolSiteName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The Azure Naming Tool site name</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[Parameter(Mandatory=$true)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">ValidateSet</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'dev'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'prd'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'sbx'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'shd'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'stg'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'tst'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'uat'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[ValidateLength(1,5)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[string]</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceEnvironment</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The environment of the resource</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[Parameter(Mandatory=$false)]</span><span class="token plain"> </span><span class="token namespace">[string]</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceFunction</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The function of the resource</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[Parameter(Mandatory=$true)]</span><span class="token plain"> </span><span class="token namespace">[string]</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceInstance</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The instance of the resource</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[Parameter(Mandatory=$true)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">ValidateSet</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'aue'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'aus'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'nzn'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'	usw'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[ValidateLength(1,10)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[string]</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceLocation</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The location of the resource</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[Parameter(Mandatory=$false)]</span><span class="token plain"> </span><span class="token namespace">[string]</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceOrg</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The organization of the resource</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">Parameter</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">Mandatory=</span><span class="token boolean">$false</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> HelpMessage=</span><span class="token string" style="color:rgb(255, 121, 198)">"The shortcode of the project. This needs to match an existing Project in Azure Naming Tool."</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[ValidateLength(1,3)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[string]</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceProjAppSvc</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The project or application service of the resource</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[Parameter(Mandatory=$true)]</span><span class="token plain"> </span><span class="token namespace">[string]</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceType</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The type of the resource</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[Parameter(Mandatory=$false)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[ValidateLength(1,5)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[string]</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceUnitDept</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The unit or department of the resource</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[Parameter(Mandatory=$false)]</span><span class="token plain"> </span><span class="token namespace">[Hashtable]</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$customComponents</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Any custom components for the resource</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[Parameter(Mandatory=$false)]</span><span class="token plain"> </span><span class="token namespace">[string]</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$createdBy</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The creator of the resource</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Define the headers for the API request</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$headers</span><span class="token plain"> = @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">'accept'</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">'*/*'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">'APIKey'</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$API</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">'Content-Type'</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">'application/json'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Define the body of the API request</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$body</span><span class="token plain"> = @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">'resourceEnvironment'</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceEnvironment</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">'resourceFunction'</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceFunction</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">'resourceInstance'</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceInstance</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">'resourceLocation'</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceLocation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">'resourceOrg'</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceOrg</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">'resourceProjAppSvc'</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceProjAppSvc</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">'resourceType'</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceType</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">'resourceUnitDept'</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceUnitDept</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">'customComponents'</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$customComponents</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">'createdBy'</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$createdBy</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">ConvertTo-Json</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Depth 6  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Convert the body to JSON format</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Send the API request and store the response</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">try</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$response</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Invoke-RestMethod</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Uri </span><span class="token string" style="color:rgb(255, 121, 198)">"https://</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$AzNamingToolSiteName</span><span class="token string" style="color:rgb(255, 121, 198)">.azurewebsites.net/api/ResourceNamingRequests/RequestName"</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Method Post </span><span class="token operator">-</span><span class="token plain">Headers </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$headers</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Body </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$body</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$null</span><span class="token plain"> </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$response</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"The API returned a successful response with no body."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"The API returned a successful response, with the name generated as: </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$response</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">resourceName</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"An error occurred: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Return the response</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$response</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="deployment">Deployment<a href="https://luke.geek.nz/azure/azure-naming-tool-api-bicep-resources/#deployment" class="hash-link" aria-label="Direct link to Deployment" title="Direct link to Deployment">‚Äã</a></h2>
<p>Now that we have the scripts, it's time to run it. I am going to run this from a GitHub Codespace that already has the latest version of PowerShell and Bicep installed. I have whitelisted the IP of the Codespace to allow it to access the Azure Naming Tool WebApp.</p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>Your Azure Naming Tool configuration is key! It needs to align with your organisational needs, naming conventions, projects and departments where necessary. Different resource types, will require different configurations, so make sure you plan this out, the Azure Naming Tool reference page can be key to review for successful name generation.</p></div></div>
<p>First, we will need the API Key, so within the Azure Naming Tool, click on Admin, enter your password and Copy the Full Access API Key. This key is needed as the generated API resource name is a POST operation.</p>
<p><img decoding="async" loading="lazy" alt="Copy Azure Naming Tool API" src="https://luke.geek.nz/assets/images/AzureNamingTool_CopyAPIKey-b49125659c11a5b15d570d61c92f364a.gif" title="Azure Naming Tool API Key" width="1969" height="944" class="img_ev3q"></p>
<p>You will also need the name of your Azure Naming Tool WebApp, the Request-ResourceName script does make an assumption that this is an Azure hosted website <em>(ie <a href="https://aznamingtoolgeeknz.azurewebsites.net/" target="_blank" rel="noopener noreferrer">https://aznamingtoolgeeknz.azurewebsites.net/</a>)</em>. If you are hosting it elsewhere, you will need to update the script to reflect the domain name.</p>
<p>Enter the API and WebApp name into the command.ps1 script, these are parameters for the script, along with resourceType, resourceInstance, resourceLocation, etc. Different resource types and configurations will require different parameters.</p>
<p>Now it's time to create our Storage Account using a Name generated from the Azure Naming Tool.</p>
<p>The command script will trigger a REST API call to Azure Naming Tool to generate a name for our storage account. Then we will use that name as a parameter for the storageAccountName Bicep deployment.</p>
<p><img decoding="async" loading="lazy" alt="Generate Name using Azure Naming Tool API" src="https://luke.geek.nz/assets/images/AzureNamingTool_RunAPIGenerateName-b607292f529c299be8d77ac10e3db4bd.gif" title="Azure Naming Tool generate name" width="1903" height="944" class="img_ev3q"></p>
<p>Our Storage account is now created:</p>
<p><img decoding="async" loading="lazy" alt="Azure Storage account created" src="https://luke.geek.nz/assets/images/Created_StorageAccount-909a11e3549734d09f4b34dc798ff8c5.png" title="Created Azure Storage account" width="1883" height="453" class="img_ev3q"></p>]]></content>
        <author>
            <name>Luke Murray</name>
            <uri>https://luke.geek.nz</uri>
        </author>
        <category label="Azure" term="Azure"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Add existing Azure resource to a Deployment Stack]]></title>
        <id>https://luke.geek.nz/azure/existing-resource-deploymentstack/</id>
        <link href="https://luke.geek.nz/azure/existing-resource-deploymentstack/"/>
        <updated>2024-01-09T06:05:43.214Z</updated>
        <summary type="html"><![CDATA[Add existing Azure resources to a Deployment Stack using Bicep.]]></summary>
        <content type="html"><![CDATA[<p>An Azure <a href="https://learn.microsoft.com/azure/azure-resource-manager/bicep/deployment-stacks?tabs=azure-powershell&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">deployment stack</a> is a type of Azure resource that enables the management of a group of Azure resources as an atomic unit.</p>
<p>If you deploy a new Deployment Stack, all resources in your ARM/Bicep template will be included as Managed resources, but what if you want to include a resource deployed outside of Bicep into your Deployment Stack?</p>
<p><img decoding="async" loading="lazy" alt="Blog Heading " src="https://luke.geek.nz/assets/images/BlogHeading_DeploymentStackMissingResource-392444bd56f4fa1fc9df54f4b2ad10fb.gif" width="1200" height="628" class="img_ev3q"></p>
<p>A community member approached me to ask how they could do this, so let us take a look.</p>
<!-- -->
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>An Azure deployment stack is a type of Azure resource that enables the management of a group of Azure resources as an atomic unit. When a Bicep file or an ARM JSON template is submitted to a deployment stack, it defines the resources that are managed by the stack. If a resource that was previously included in the template is removed, it will either be detached or deleted based on the specified actionOnUnmanage behaviour of the deployment stack. Similar to other Azure resources, access to the deployment stack can be restricted using Azure role-based access control (Azure RBAC). To create and update a deployment stack, you can utilize Azure CLI, Azure PowerShell, or the Azure portal, along with Bicep files. These Bicep files are compiled into ARM JSON templates, which are then deployed as a deployment object by the stack.</p></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>Check out a previous post I did on <a href="https://luke.geek.nz/azure/Azure-Bicep-Deployment-with-Deployment-Stacks/" target="_blank" rel="noopener noreferrer">Deployment Stacks</a> for a bit more detail on how they can be used and setup.</p></div></div>
<p>In our demo, we will have a Resource Group, with an existing Storage account already pre created <em>(using the Azure Portal)</em> and a Deployment Stack, consisting of an Azure KeyVault deployed using Bicep.</p>
<p>The PowerShell command used to deploy the Bicep is:</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">New-AzResourceGroupDeploymentStack</span><span class="token plain"> `</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token operator">-</span><span class="token plain">Name </span><span class="token string" style="color:rgb(255, 121, 198)">"MyDeploymentStack"</span><span class="token plain"> `</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token operator">-</span><span class="token plain">ResourceGroupName </span><span class="token string" style="color:rgb(255, 121, 198)">"deploymentstacks-rg"</span><span class="token plain"> `</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token operator">-</span><span class="token plain">TemplateFile </span><span class="token string" style="color:rgb(255, 121, 198)">"main.bicep"</span><span class="token plain"> `</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token operator">-</span><span class="token plain">DenySettingsMode </span><span class="token string" style="color:rgb(255, 121, 198)">"none"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>And the Bicep we initially deployed <em>(where the Storage account isn't part of the Deployment Stack, and the KeyVault is a dummy resource for something to deploy)</em> is:</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> storage </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.Storage/storageAccounts@2023-01-01'</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">existing</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'stfacc1337'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> keyvault </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.KeyVault/vaults@2023-07-01'</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'keyvaulstest13345'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">location</span><span class="token operator">:</span><span class="token plain">  </span><span class="token function" style="color:rgb(80, 250, 123)">resourceGroup</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">location</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">accessPolicies</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">tenantId</span><span class="token operator">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">subscription</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">tenantId</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">objectId</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'00000000-0000-0000-0000-000000000000'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">permissions</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">keys</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">'all'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">secrets</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">'all'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">certificates</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">'all'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">sku</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">family</span><span class="token operator">:</span><span class="token plain">   </span><span class="token string" style="color:rgb(255, 121, 198)">'A'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain">  </span><span class="token string" style="color:rgb(255, 121, 198)">'standard'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token property">tenantId</span><span class="token operator">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">subscription</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">tenantId</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Deployment Stack - Missing Storage account" src="https://luke.geek.nz/assets/images/DeploymentStack_LackingStgAccount-7c4805869587d85f1bbce1218c144e86.png" width="1886" height="684" class="img_ev3q"></p>
<p>As you can see, even though the 'stfacc1337' storage account is tested as a referenceable object in Bicep by using the <a href="https://learn.microsoft.com/azure/azure-resource-manager/bicep/existing-resource?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">existing</a> flag, it hasn't been brought into the Deployment Stack.</p>
<p>Being able to reference the module in Bicep isn't enough to bring it into the Deployment Stack, and this is by design <em>(<a href="https://github.com/Azure/deployment-stacks/issues/146" target="_blank" rel="noopener noreferrer">Issue #146</a>)</em>.</p>
<blockquote>
<p>So, if you can't reference an existing resource, how can you bring it into the deployment stack?</p>
</blockquote>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>Answer!</div><div class="admonitionContent_BuS1"><p><strong>The answer is: You need to import it into the Bicep!</strong>
From this moment forward, it would be wise to manage that imported resource in Bicep. Any changes to that resource outside of the Bicep will conflict with the code and state, and you may find your changes being reversed on the next deployment.</p></div></div>
<p>A resource needs to exist in Infrastructure as Code, in order to be added to a Deployment Stack, the easiest way is to import it.</p>
<p>I did a separate <a href="https://luke.geek.nz/azure/azure-bicep-and-insert-resource/" target="_blank" rel="noopener noreferrer">blog article</a> on using the Bicep Visual Studio extension to import an existing resource, so refer to that, but in essence, it can import the resource from ARM, and compile it into an identical resource into Bicep, matching what you have deployed.</p>
<p>The Bicep now looks like this:</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token decorator">@description</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'Generated from /subscriptions/a42e282a-c1e4-4abc-9fa1-1dd1ecbd6bf9/resourceGroups/deploymentstacks-rg/providers/Microsoft.Storage/storageAccounts/stfacc1337'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> stfacc </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.Storage/storageAccounts@2023-01-01'</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">sku</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Standard_RAGRS'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">kind</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'StorageV2'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'stfacc1337'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">location</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'australiaeast'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">tags</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">dnsEndpointType</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Standard'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">defaultToOAuthAuthentication</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">publicNetworkAccess</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Enabled'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">allowCrossTenantReplication</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">minimumTlsVersion</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'TLS1_2'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">allowBlobPublicAccess</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">allowSharedKeyAccess</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">networkAcls</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">ipv6Rules</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">bypass</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'AzureServices'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">virtualNetworkRules</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">ipRules</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">defaultAction</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Allow'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">supportsHttpsTrafficOnly</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">encryption</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">requireInfrastructureEncryption</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">services</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">file</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">keyType</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Account'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">enabled</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">blob</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">keyType</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Account'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">enabled</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">keySource</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.Storage'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">accessTier</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Hot'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> keyvault </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.KeyVault/vaults@2023-07-01'</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'keyvaulstest13345'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">location</span><span class="token operator">:</span><span class="token plain">  </span><span class="token function" style="color:rgb(80, 250, 123)">resourceGroup</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">location</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">accessPolicies</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">tenantId</span><span class="token operator">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">subscription</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">tenantId</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">objectId</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'00000000-0000-0000-0000-000000000000'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">permissions</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">keys</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">'all'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">secrets</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">'all'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">certificates</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">'all'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">sku</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">family</span><span class="token operator">:</span><span class="token plain">   </span><span class="token string" style="color:rgb(255, 121, 198)">'A'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain">  </span><span class="token string" style="color:rgb(255, 121, 198)">'standard'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token property">tenantId</span><span class="token operator">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">subscription</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">tenantId</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now redeploy the Deployment Stack.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>The create-stack commands can also be used to update deployment stacks!</p></div></div>
<blockquote>
<p>Once your Deployment Stack has been deployed, your resource is now imported.</p>
</blockquote>
<p><img decoding="async" loading="lazy" alt="Deployment Stacks - Including Storage account" src="https://luke.geek.nz/assets/images/DeploymentStack_IncludingStgAccount-970c80f71959bcfe9eaf91669fcedf88.png" width="1904" height="691" class="img_ev3q"></p>]]></content>
        <author>
            <name>Luke Murray</name>
            <uri>https://luke.geek.nz</uri>
        </author>
        <category label="Azure" term="Azure"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[The specified service namespace is invalid EventHub]]></title>
        <id>https://luke.geek.nz/azure/service-namespace-invalid-eventhub/</id>
        <link href="https://luke.geek.nz/azure/service-namespace-invalid-eventhub/"/>
        <updated>2024-01-05T07:52:10.785Z</updated>
        <summary type="html"><![CDATA[The specified service namespace is invalid when attempting to deploy an Azure EventHub using Bicep]]></summary>
        <content type="html"><![CDATA[<p>When deploying an Event Hub using Azure Bicep, you may get the following error:</p>
<p>"code": "BadRequest",
"message": "The specified service namespace is invalid. CorrelationId: 652cc73c-1fa7-450a-9788-b73ad6a818df"</p>
<p><img decoding="async" loading="lazy" alt="The specified service namespace is invalid" src="https://luke.geek.nz/assets/images/EventHub_ServiceNamespaceisInvalid-9eeab3667abb3efbbf089a2d33e530d0.png" width="779" height="305" class="img_ev3q"></p>
<p>This could be caused by the name of your namespace needing to meet the naming requirements.</p>
<!-- -->
<p>For example:</p>
<p>The namespace identifier should adhere to the following naming conventions:</p>
<ul>
<li>The name must be unique across Azure. The system immediately checks to see if the name is available.</li>
<li>The name length is at least 6 and at most 50 characters.</li>
<li>The name can contain only letters, numbers, and hyphens ‚Äú-‚Äú.</li>
<li>The name must start with a letter and end with a letter or number.</li>
<li>The name doesn't end with ‚Äú-sb‚Äú or ‚Äú-mgmt‚Äú.</li>
</ul>
<p>Reference:</p>
<ul>
<li><a href="https://learn.microsoft.com/rest/api/servicebus/create-namespace?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Create Namespace</a>, even though this article dates back to an API from 2021, the naming standards are still valid in the API for 2023-01-01-preview.</li>
<li><a href="https://learn.microsoft.com/en-us/azure/service-bus-messaging/service-bus-quickstart-portal#:~:text=Enter%20a%20name,sb%E2%80%9C%20or%20%E2%80%9C-mgmt?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Create Service Bus Namespace in Portal</a></li>
</ul>]]></content>
        <author>
            <name>Luke Murray</name>
            <uri>https://luke.geek.nz</uri>
        </author>
        <category label="Azure" term="Azure"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Deploying and Testing Azure Email Communication Services]]></title>
        <id>https://luke.geek.nz/azure/azure-email-communication-services/</id>
        <link href="https://luke.geek.nz/azure/azure-email-communication-services/"/>
        <updated>2024-01-02T06:54:06.568Z</updated>
        <summary type="html"><![CDATA[Use Azure Bicep to create Email Communication Services, then REST API to send an email.]]></summary>
        <content type="html"><![CDATA[<p><a href="https://learn.microsoft.com/azure/communication-services/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Communication Services</a> brings rich communication APIs to all of your apps across any device on any platform, using the same reliable and secure infrastructure that powers Microsoft Teams.</p>
<p>Today, we will look into using Email as part of Azure Communication Services using the REST API and PowerShell to send an email.</p>
<p><img decoding="async" loading="lazy" alt="Azure Communication Services" src="https://luke.geek.nz/assets/images/BlogHeading_DeployandTestACSE-f9838a4feb1c05d77481cc14d4141606.gif" width="1200" height="628" class="img_ev3q"></p>
<!-- -->
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="https://luke.geek.nz/azure/azure-email-communication-services/#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">‚Äã</a></h2>
<p>Azure Communication Services is a platform of products and services that enable you to create custom communication applications and solutions. Microsoft has taken the same technologies that power Skype and Microsoft Teams and made it available to developers as an Azure product, allowing easy integration with other Microsoft developer services for additional functionality.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Azure Communication Services supports various communication formats:</p><ul>
<li><a href="https://learn.microsoft.com/en-us/azure/communication-services/concepts/voice-video-calling/calling-sdk-features?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Voice and Video Calling</a></li>
<li><a href="https://learn.microsoft.com/azure/communication-services/concepts/chat/concepts?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Rich Text Chat</a></li>
<li><a href="https://learn.microsoft.com/en-us/azure/communication-services/concepts/sms/concepts?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">SMS</a></li>
<li><a href="https://learn.microsoft.com/en-us/azure/communication-services/concepts/email/email-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Email</a></li>
</ul></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p><a href="https://learn.microsoft.com/en-us/azure/communication-services/concepts/sms/concepts?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">SMS</a> services are not available on Azure Sponsorship or Visual Studio Enterprise subscriptions.</p></div></div>
<p>Today we will be looking at the <strong><a href="https://learn.microsoft.com/azure/communication-services/concepts/email/email-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Email Communication Service</a> by deploying Email and Azure Communication Services with <a href="https://learn.microsoft.com/azure/azure-resource-manager/bicep/overview?tabs=bicep&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Bicep</a>, and Send a test email using the API and PowerShell RestMethod</strong>.</p>
<!-- -->
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="deployment">Deployment<a href="https://luke.geek.nz/azure/azure-email-communication-services/#deployment" class="hash-link" aria-label="Direct link to Deployment" title="Direct link to Deployment">‚Äã</a></h3>
<p>I am going to make some assumptions here that you know how to deploy with <a href="https://learn.microsoft.com/azure/azure-resource-manager/bicep/overview?tabs=bicep&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Bicep</a>, and have it <a href="https://learn.microsoft.com/azure/azure-resource-manager/bicep/install?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">installed</a>, and that you have an Azure subscription and the ability to create new resources.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>If you are doing Bicep deployment, I do recommend looking at the <a href="https://luke.geek.nz/azure/Azure-Bicep-Deploy-Pane/" target="_blank" rel="noopener noreferrer">Azure Bicep Deploy Pane Visual Studio Code extension</a>.</p></div></div>
<p>In order to use the Email Communication Service, we need to create it and then create Azure Communication Services, whose endpoint we will then use to send an email.
To authenticate with Azure Communication Services, we will use a Service Principal, which we will create, then use that Service Principal with a custom role to send an email using PowerShell and the Azure APIs.</p>
<p>For email services, you can use your own <a href="https://learn.microsoft.com/azure/communication-services/quickstarts/email/add-custom-verified-domains?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Custom Domain</a>, and in most Production based scenarios you would, this requires some records being added to your DNS server, for domain ownership and to configure the DKIM/SFP records, but for the purposes of this article, we will use an Azure Managed <em>(and autogenerated domain)</em>.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="bicep-deployment">Bicep Deployment<a href="https://luke.geek.nz/azure/azure-email-communication-services/#bicep-deployment" class="hash-link" aria-label="Direct link to Bicep Deployment" title="Direct link to Bicep Deployment">‚Äã</a></h4>
<p>Deployment of Azure Communication Services via Bicep can be done using the <a href="https://learn.microsoft.com/en-us/azure/azure-resource-manager/bicep/deploy-cli?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">PowerShell cmdlet or the Azure CLI</a>. Still, today I will use the Deployment Pane and deploy from Visual Studio Code for my demo.</p>
<p>The Azure Bicep will deploy:</p>
<ul>
<li>Azure Communication services</li>
<li>Email Communication Services</li>
</ul>
<p>And configure 2 FROM email addresses:</p>
<ul>
<li>DoNotReply</li>
<li>itservicedesk</li>
</ul>
<p>However, you can modify this to your requirements; I put these in a variable array to make it easier to add and remove sender addresses.</p>
<p>Default tags have been added. However, these can easily be modified or removed if needed.</p>
<p>3 Parameter values will need to be defined:</p>
<table><thead><tr><th>Parameters</th><th>Notes</th></tr></thead><tbody><tr><td>emailServicesName</td><td>Azure Communication Services Email resource name.</td></tr><tr><td>communicationServicesName</td><td>Azure Communication Services Email name.</td></tr><tr><td>emailServicesLocation</td><td>This is a global service; however, the data at rest (Data Location) needs to be specified.</td></tr></tbody></table>
<p>I am based in New Zealand, so my Region and Data location is Australia and Australia East.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>The Azure Communication Service is a global resource and will need a unique name. You can only have 1 Azure managed domain per Email Communication Service, but you can also add a Custom Domain.</p></div></div>
<p>Let us deploy and configure Azure Communication Services to talk to the Email service!</p>
<p><img decoding="async" loading="lazy" alt="Azure Communication Services - Bicep Deployment" src="https://luke.geek.nz/assets/images/ACS_ProvisionEmailService-d47027e90cb1a26c1f41438edf6826a0.gif" width="1911" height="944" class="img_ev3q"></p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">main.bicep</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// Scope</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">targetScope</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'resourceGroup'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Parameters &amp; Variables</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> emailServicesName </span><span class="token datatype class-name">string</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> communicationServicesName </span><span class="token datatype class-name">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token decorator">@description</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'The location where the email service stores its data at rest.'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> emailServicesLocation </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Australia'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="token plain"> emailServicesTags </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">environment</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'production'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">department</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'IT'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">project</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'emailServices'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="token plain"> senderUsernames </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'donotreply'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">username</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'DoNotReply'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">displayName</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'DoNotReply'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'itservicedesk'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">username</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'itservicedesk'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">displayName</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'itservicedesk'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// Add more sender usernames here</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Bicep</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> emailServices </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.Communication/emailServices@2023-04-01-preview'</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> emailServicesName</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">location</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'global'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">tags</span><span class="token operator">:</span><span class="token plain"> emailServicesTags</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">dataLocation</span><span class="token operator">:</span><span class="token plain"> emailServicesLocation</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> emailServicesAzureDomain </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.Communication/emailServices/domains@2023-06-01-preview'</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'AzureManagedDomain'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">parent</span><span class="token operator">:</span><span class="token plain"> emailServices</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">location</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'global'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">domainManagement</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'AzureManaged'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">userEngagementTracking</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Disabled'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> emailServicesSendAddresses </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.Communication/emailServices/domains/senderUsernames@2023-06-01-preview'</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> senderUsername </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">in</span><span class="token plain"> senderUsernames</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">parent</span><span class="token operator">:</span><span class="token plain"> emailServicesAzureDomain</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> senderUsername</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">username</span><span class="token operator">:</span><span class="token plain"> senderUsername</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">username</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">displayName</span><span class="token operator">:</span><span class="token plain"> senderUsername</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">displayName</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> communicationServices </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.Communication/communicationServices@2023-06-01-preview'</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> communicationServicesName</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">location</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'global'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">tags</span><span class="token operator">:</span><span class="token plain"> emailServicesTags</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">dataLocation</span><span class="token operator">:</span><span class="token plain"> emailServicesLocation</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">linkedDomains</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    emailServicesAzureDomain</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">id</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">output</span><span class="token plain"> emailAddresses </span><span class="token datatype class-name">array</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> senderUsername </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">in</span><span class="token plain"> senderUsernames</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">email</span><span class="token operator">:</span><span class="token plain"> </span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">'</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">senderUsername</span><span class="token interpolated-string interpolation expression punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token interpolated-string interpolation expression">username</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">@</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">emailServicesAzureDomain</span><span class="token interpolated-string interpolation expression punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token interpolated-string interpolation expression">name</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">output</span><span class="token plain"> domainName </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> emailServicesAzureDomain</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">properties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">mailFromSenderDomain</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">output</span><span class="token plain"> communicationServicesuri </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> communicationServices</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">properties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">hostName</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="setup-and-configure-authentication">Setup and configure Authentication<a href="https://luke.geek.nz/azure/azure-email-communication-services/#setup-and-configure-authentication" class="hash-link" aria-label="Direct link to Setup and configure Authentication" title="Direct link to Setup and configure Authentication">‚Äã</a></h4>
<p>Now, that we have our Azure Communications Service and Email Communication service, next we need to create a Service Principal and Custom Role that we will use in the script.</p>
<p>To do that, we will, set up a new Service Principal and then add a custom role, which has the least amount of privileges to send an email, then add it to our Resource Group, containing the Azure Communication Services resources.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Use this opportunity to copy your Application ID and generate and copy a new Secret; these will be used by the test PowerShell script in the next step, along with your Entra ID tenant ID. In a Production scenario, the secret should be stored in an <a href="https://azure.microsoft.com/products/key-vault?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Key Vault</a> as a Secret and not referenced as plain text anywhere.</p></div></div>
<p><img decoding="async" loading="lazy" alt="Azure Communication Services - Create SPN and assign custom role" src="https://luke.geek.nz/assets/images/ACS_ProvisionEmailService_SPN-61494cb2d982f03ed4272c27eafa9525.gif" width="1911" height="944" class="img_ev3q"></p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">CommunicationServiceMailSender.json</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"properties"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"roleName"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Communication Service Mail Sender"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"description"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Minimal set of permissions required to send mail with Azure Communication Service."</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"assignableScopes"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token string" style="color:rgb(255, 121, 198)">""</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"permissions"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"actions"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token string" style="color:rgb(255, 121, 198)">"Microsoft.Communication/CommunicationServices/Write"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token string" style="color:rgb(255, 121, 198)">"Microsoft.Communication/CommunicationServices/Read"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token string" style="color:rgb(255, 121, 198)">"Microsoft.Communication/EmailServices/read"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"notActions"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"dataActions"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"notDataActions"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="test-outgoing-email-using-api">Test outgoing email using API<a href="https://luke.geek.nz/azure/azure-email-communication-services/#test-outgoing-email-using-api" class="hash-link" aria-label="Direct link to Test outgoing email using API" title="Direct link to Test outgoing email using API">‚Äã</a></h3>
<p>Now that we have our Communication Services and email Services and configured our Service Principal, it is time to run our test.</p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>The script I will run below was written purely for my testing purposes and stores credentials as plain text; when looking to do this in Production, make sure these credentials are protected and the Service Principal is locked down from accepting requests outside of approved networks.</p></div></div>
<p>To do our test, we need to update a few variables.</p>
<table><thead><tr><th>Parameters</th><th>Notes</th></tr></thead><tbody><tr><td>SPNAppId</td><td>Your Service Principal Application ID</td></tr><tr><td>SPNSecretValue</td><td>Your Service Principal Client Secret</td></tr><tr><td>SPNTenantId</td><td>Your Entra ID Tenant ID</td></tr><tr><td>senderAddress</td><td>The email address Azure Communication Services is sending FROM</td></tr><tr><td>recipientAddress</td><td>The email address you re sending TO</td></tr><tr><td>communicationendpointurl</td><td>The endpoint of your Azure Communication Services (not Email Service). Https will be added further in the script.</td></tr></tbody></table>
<p>The senderAddress must match a valid email address configured in Azure Email Communication Service. I also added in some random Contoso email addresses into the recipient's body for testing, the idea is to give you a scaffold to adjust as needed; feel free to amend and remove what you don't need.</p>
<p><img decoding="async" loading="lazy" alt="Azure Communication Services - Test sending an email" src="https://luke.geek.nz/assets/images/ACS_ProvisionEmailService_Test-379c9bea955e294573d9e71f9a7bb056.gif" width="1911" height="944" class="img_ev3q"></p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">AzureEmailCommunicationSend.ps1</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Define the Service Principal credentials and email addresses</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># The Service Principal's Application (client) ID</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># This is a unique identifier for the app, assigned by Entra ID. Replace to match your environment.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$SPNAppId</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">'069893df-a389-4a2a-99aa-d035265cfbb7'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># The Service Principal's secret</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># This is like a password for the app, used for authentication. Replace to match your environment.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$SPNSecretValue</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">'fc6652c483d4475a9c59cc1d81b6d45a'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># The Entra ID tenant ID</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># This is the unique identifier for the Entra ID tenancy instance where the app is registered. Replace to match your environment.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$SPNTenantId</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">'49e37426-fba3-4995-b563-0355b5d6fc60'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># The sender's email address</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># This is the email address that will appear in the "From" field of the email</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$senderAddress</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">'itservicedesk@959df321-6092-41e7-8414-e7b4ea05da2b.azurecomm.net'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># The recipient's email address</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># This is the email address where the email will be sent</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$recipientAddress</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">'recipientemail@test.com'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># The URI for the Azure Communication Services API</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$communicationendpointurl</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"azcommservices1.australia.communication.azure.com"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Function to get the access token from Entra ID</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Get-AccessToken</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Define the parameters for the REST API call</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$params</span><span class="token plain"> = @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Uri    = </span><span class="token string" style="color:rgb(255, 121, 198)">"https://login.microsoftonline.com/</span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$SPNTenantId</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">/oauth2/v2.0/token"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Method = </span><span class="token string" style="color:rgb(255, 121, 198)">"POST"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Body   = @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            client_id     = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$SPNAppId</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            client_secret = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$SPNSecretValue</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            grant_type    = </span><span class="token string" style="color:rgb(255, 121, 198)">"client_credentials"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            scope         = </span><span class="token string" style="color:rgb(255, 121, 198)">"https://communication.azure.com/.default"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Call the REST API and get the access token</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$token</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Invoke-RestMethod</span><span class="token plain"> @params</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$token</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">access_token</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Define the URI for the Azure Communication Services API</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$uri</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"https://</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$communicationendpointurl</span><span class="token string" style="color:rgb(255, 121, 198)">/emails:send?api-version=2023-03-31"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Define the headers for the REST API call</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$headers</span><span class="token plain"> = @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">"Content-Type"</span><span class="token plain">  = </span><span class="token string" style="color:rgb(255, 121, 198)">"application/json"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">"Authorization"</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"Bearer </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function" style="color:rgb(80, 250, 123)">Get-AccessToken</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Define the body for the REST API call</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Define the body for the REST API call</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># This includes the email headers, sender address, content, recipients, attachments, reply-to addresses, and tracking settings</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$apiResponse</span><span class="token plain"> = @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># The headers of the email, including a unique ID generated by New-Guid</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    headers                        = @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        id = </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token function" style="color:rgb(80, 250, 123)">New-Guid</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Guid</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># The sender's email address</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    senderAddress                  = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$senderAddress</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># The content of the email, including the subject, plain text body, and HTML body</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    content                        = @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        subject   = </span><span class="token string" style="color:rgb(255, 121, 198)">"Contoso Email Test"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        plainText = </span><span class="token string" style="color:rgb(255, 121, 198)">"This is a test email from Contoso. If you received this, our test was successful."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        html      = </span><span class="token string" style="color:rgb(255, 121, 198)">"&lt;html&gt;&lt;head&gt;&lt;title&gt;Contoso Email Test&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;This is a test email from Contoso.&lt;/h1&gt;&lt;p&gt;If you received this, our test was successful.&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># The recipients of the email, including the "to", "cc", and "bcc" addresses</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    recipients                     = @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        to  = @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                address     = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$recipientAddress</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                displayName = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$recipientAddress</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                address     = </span><span class="token string" style="color:rgb(255, 121, 198)">"Jane.Doe@contoso.com"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                displayName = </span><span class="token string" style="color:rgb(255, 121, 198)">"Jane Doe"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        cc  = @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                address     = </span><span class="token string" style="color:rgb(255, 121, 198)">'wendy.smith@contoso.com'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                displayName = </span><span class="token string" style="color:rgb(255, 121, 198)">'Wendy Smith'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                address     = </span><span class="token string" style="color:rgb(255, 121, 198)">"jimmy.johns@contoso.com"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                displayName = </span><span class="token string" style="color:rgb(255, 121, 198)">"Jimmy Johns"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        bcc = @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                address     = </span><span class="token string" style="color:rgb(255, 121, 198)">"bob.jones@contoso.com"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                displayName = </span><span class="token string" style="color:rgb(255, 121, 198)">"Bob Jones"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                address     = </span><span class="token string" style="color:rgb(255, 121, 198)">"alice.johnson@contoso.com"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                displayName = </span><span class="token string" style="color:rgb(255, 121, 198)">"Alice Johnson"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># The attachments to the email, including the name, content type, and content in Base64</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    attachments                    = @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            name            = </span><span class="token string" style="color:rgb(255, 121, 198)">"Attachment.txt"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            contentType     = </span><span class="token string" style="color:rgb(255, 121, 198)">"application/txt"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            contentInBase64 = </span><span class="token string" style="color:rgb(255, 121, 198)">"TG9yZW0gaXBzdW0gZG9sb3Igc2l0IGFtZXQ="</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># The reply-to addresses for the email</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    replyTo                        = @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            address     = </span><span class="token string" style="color:rgb(255, 121, 198)">"contoso-support@contoso.com"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            displayName = </span><span class="token string" style="color:rgb(255, 121, 198)">"Contoso Support"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># A flag to disable user engagement tracking</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    userEngagementTrackingDisabled = </span><span class="token boolean">$true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Convert the PowerShell object to JSON</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># The -Depth parameter is set to 10 to ensure all levels of the object are converted</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$body</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$apiResponse</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">ConvertTo-Json</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Depth 10</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Send the email</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">try</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$response</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Invoke-RestMethod</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Uri </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$uri</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Method Post </span><span class="token operator">-</span><span class="token plain">Headers </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$headers</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Body </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$body</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">UseBasicParsing</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$response</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Error</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Exception</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Message</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>Congratulations, you have now stood up Azure Communications Services and successfully sent and received an email using the Azure Communication Service API.</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="additional-reading">Additional Reading<a href="https://luke.geek.nz/azure/azure-email-communication-services/#additional-reading" class="hash-link" aria-label="Direct link to Additional Reading" title="Direct link to Additional Reading">‚Äã</a></h2>
<ul>
<li><a href="https://azure.microsoft.com/contact/pricing/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Communication Services pricing</a></li>
<li><a href="https://learn.microsoft.com/en-us/training/modules/intro-azure-communication-services/?source=recommendations&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Introduction to Azure Communication Services</a></li>
<li><a href="https://learn.microsoft.com/en-us/azure/communication-services/quickstarts/email/handle-email-events?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Quick-start: Handle Email events</a></li>
</ul>]]></content>
        <author>
            <name>Luke Murray</name>
            <uri>https://luke.geek.nz</uri>
        </author>
        <category label="Azure" term="Azure"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Microsoft Copilot for Azure - Preview]]></title>
        <id>https://luke.geek.nz/azure/microsoft-copilot-azure-preview/</id>
        <link href="https://luke.geek.nz/azure/microsoft-copilot-azure-preview/"/>
        <updated>2023-12-26T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Microsoft Copilot for Azure is designed to generate the best possible responses within the context it can access. Lets take a look at the Public Preview.]]></summary>
        <content type="html"><![CDATA[<p><a href="https://azure.microsoft.com/en-us/products/copilot?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Copilot for Azure</a> is an AI companion that simplifies how you design, operate, optimize, and troubleshoot apps and infrastructure from cloud to edge.</p>
<p>With Copilot, gain new insights, discover more benefits of the cloud, and orchestrate data across both the cloud and the edge. Copilot AI assistance <strong>utilizes language models</strong>, the <strong>Azure control plane</strong>, and <strong>insights</strong> about <strong>your</strong> <strong>Azure</strong> and <strong>Arc‚Äìenabled</strong> assets.</p>
<p>This is carried out within Azure's steadfast commitment to safeguarding your data security and privacy.</p>
<blockquote>
<p>This article contains my own personal thoughts and experiences; make sure you approach this capability with an open eye; my views may not necessarily be your own.</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="https://luke.geek.nz/azure/microsoft-copilot-azure-preview/#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">‚Äã</a></h2>
<p>Microsoft Copilot for Azure is designed to generate the best possible responses within the context it can access.</p>
<p><strong>However, like any AI system, Microsoft Copilot for Azure's responses will not always be perfect. All of Microsoft Copilot for Azure's responses should be carefully tested, reviewed, and vetted before making changes to your Azure environment.</strong></p>
<blockquote>
<p>Microsoft Copilot for Azure <em>(preview)</em> requires registration and is only available to approved enterprise customers and partners. Customers who wish to use Microsoft Copilot for Azure <em>(preview)</em> must submit a&nbsp;registration form.
Access to Microsoft Copilot for Azure <em>(preview)</em> is subject to Microsoft's sole discretion based on eligibility criteria and a vetting process, and customers must acknowledge that they have read and understand the Azure terms of service for Microsoft Copilot for Azure <em>(preview)</em>.</p>
</blockquote>
<p><img decoding="async" loading="lazy" alt="Microsoft Copilot for Azure - Mission Statement" src="https://luke.geek.nz/assets/images/MicrosoftCopilotForAzure_MissionStatement-f8609fe34a6b20f7d7c7235a16866abd.PNG" width="1680" height="945" class="img_ev3q"></p>
<p>Copilot for Azure can be accessed directly in the Azure Portal.</p>
<p><img decoding="async" loading="lazy" alt="Microsoft Copilot for Azure" src="https://luke.geek.nz/assets/images/MicrosoftCopilotForAzure_PortalView-174fecdc0dc3af43ea7b340b7c00ab69.png" width="1680" height="945" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="limitations">Limitations<a href="https://luke.geek.nz/azure/microsoft-copilot-azure-preview/#limitations" class="hash-link" aria-label="Direct link to Limitations" title="Direct link to Limitations">‚Äã</a></h3>
<blockquote>
<p>It is in preview! But there are some <a href="https://learn.microsoft.com/azure/copilot/capabilities?WT.mc_id=AZ-MVP-5004796#current-limitations" target="_blank" rel="noopener noreferrer">limitations</a>, to be aware of.</p>
</blockquote>

































<table><thead><tr><th><strong>Limitation</strong></th><th><strong>Notes</strong></th></tr></thead><tbody><tr><td>10 questions per conversation (5 convos per day)</td><td>Essentially, 10 prompts (and competitions) per memory-aware conversation and 5 conversations. Reducing potential hallucinations and API exhaustion.</td></tr><tr><td>Responses that use lists are limited to the top 5</td><td>When requesting a list of resources, the completions will be restricted to 5. The token length for hundreds of resources can be very slow</td></tr><tr><td>Some tasks won't accept Resource Names; resource ID required</td><td>Resource ID of the resources may need to be specified when referencing a resource.</td></tr><tr><td>Available in English only</td><td>English only</td></tr><tr><td>Cost management scope at Subscription (not Management Group)</td><td>Able to reference Cost analysis against Subscription and Resource Groups but not across multiple subscriptions across Management Groups</td></tr><tr><td>Limited number of skills</td><td>Can only complete a certain amount of tasks; no doubt more will be added over time due to increasing capabilities and user feedback.</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="copilot-stack">Copilot Stack<a href="https://luke.geek.nz/azure/microsoft-copilot-azure-preview/#copilot-stack" class="hash-link" aria-label="Direct link to Copilot Stack" title="Direct link to Copilot Stack">‚Äã</a></h3>
<p>So, how does Microsoft Copilot for Azure work? Let us take a closer look:</p>
<p><img decoding="async" loading="lazy" alt="Microsoft Copilot for Azure" src="https://luke.geek.nz/assets/images/MicrosoftCopilotforAzure_CopilotStack-d8813f3b2e7d48c7052dbfb977c6a43d.gif" width="1894" height="1053" class="img_ev3q"></p>























































<table><thead><tr><th><strong>Step</strong></th><th><strong>Stack</strong></th><th><strong>Action</strong></th></tr></thead><tbody><tr><td>1</td><td>Apps</td><td>User enters prompt in portal web interface</td></tr><tr><td>2</td><td>Apps</td><td>Microsoft Bot Framework takes the prompt and sends it to AI orchestration</td></tr><tr><td>3</td><td>AI orchestration</td><td>Does prompt filtering (i.e. Content Safety)</td></tr><tr><td>4</td><td>AI orchestration</td><td>Brings in context (i.e. Azure resource/blade that is opened)</td></tr><tr><td>5</td><td>AI orchestration</td><td>RAG (Retrieval Augmented generation), brings in Microsoft Learn documentation, Azure Resource Graph, Cost Management, Skills, Guardrials (i.e. Azure policy, RBAC (Role Based Access Control), Budgets</td></tr><tr><td>6</td><td>AI orchestration</td><td>Added additional context to Prompt (i.e. metapromot) and ground the data</td></tr><tr><td>7</td><td>Foundational Model</td><td>Metaprompt, supplied to foundational model.</td></tr><tr><td>8</td><td>Foundational Model</td><td>Competition prompt response from foundational model (based on Copilot system prompt and context)</td></tr><tr><td>9</td><td>Apps</td><td>Competition prompt, supplied to user</td></tr></tbody></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="functionality">Functionality<a href="https://luke.geek.nz/azure/microsoft-copilot-azure-preview/#functionality" class="hash-link" aria-label="Direct link to Functionality" title="Direct link to Functionality">‚Äã</a></h2>
<p>Microsoft Copilot for Azure is designed to help with the following:</p>
<ul>
<li>Design</li>
<li>Operate</li>
<li>Optimize</li>
<li>Troubleshoot</li>
</ul>
<p><img decoding="async" loading="lazy" alt="Microsoft Copilot for Azure" src="https://luke.geek.nz/assets/images/MicrosoftCopilotforAzure_Circle-2bb2fa719e3f09268a99ba4f269a1ded.PNG" width="1680" height="945" class="img_ev3q"></p>
<p>So let us go through trialling this! All tests below will be done with an account with Owner permissions across Azure.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="design">Design<a href="https://luke.geek.nz/azure/microsoft-copilot-azure-preview/#design" class="hash-link" aria-label="Direct link to Design" title="Direct link to Design">‚Äã</a></h3>
<blockquote>
<p><strong>Design</strong> - Configure and create the right services.</p>
</blockquote>
<p>To test the design pillar of Microsoft Copilot for Azure, I will be using the following prompts to ease in and look at my design elements:</p>
<ul>
<li>I want to set up a new web application for Internet shopping; what infrastructure should I use?</li>
<li>When setting up a new web service that allows people to purchase my products using Azure services, what infrastructure should I use?</li>
<li>List all suggested Azure services for my internet shopping service and how they could connect together, including considerations.</li>
<li>Create these services</li>
<li>Are there any services I am missing? Also, list all the suggested services in a table, including a column on what each service could be used for when looking at my internet shopping application</li>
<li>What are the recommended requirements that I need to gather to create my scalable and secure Internet shopping application? List requirements, as a list</li>
<li>Give me examples of security requirement questions.</li>
</ul>
<p>Although these prompts are very high-level and not as specific as they could be, I approached this as someone who was new to Azure design, with a specific outcome I wanted, with one prompt building on the next.</p>
<p><img decoding="async" loading="lazy" alt="Microsoft Copilot for Azure - Design" src="https://luke.geek.nz/assets/images/MicrosoftCopilotforAzure_PillarTest_Design-ab68d192751a14f4094311564e171fa0.gif" width="1905" height="983" class="img_ev3q"></p>
<blockquote>
<p>Overall, Copilot for Azure responded to each prompt, and starting off with a generic prompt, I was able to use the completition prompts, supplied back to me. I did like how most prompts included links to additional Microsoft Learn documentation <em>(including Azure architecture centre references)</em> based on the subjects at the time. I did ask Microsoft Copilot for Azure to create a range of Cloud-native services, and it failed, so from my perspective, it is missing either additional error handling or the Skills/Tasks to complete the creation of these services <em>(which would have been my ideal state)</em>.</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="operate">Operate<a href="https://luke.geek.nz/azure/microsoft-copilot-azure-preview/#operate" class="hash-link" aria-label="Direct link to Operate" title="Direct link to Operate">‚Äã</a></h3>
<blockquote>
<p><strong>Operate</strong> - Answer questions, author complex commands, and manage resources.</p>
</blockquote>
<p>To test the Operate pillar of Microsoft Copilot for Azure, I will be using the following prompts to ease in and look at the Operate elements:</p>
<ul>
<li>Take me to view all resources</li>
<li>Change portal theme to light</li>
<li>Change back</li>
<li>Create a table of all resources and their region?</li>
<li>Give me a list of the top resource types?</li>
<li>List all virtual machines and their power state?</li>
<li>Shutdown all virtual machines currently running</li>
<li>Start all virtual machines currently stopped</li>
</ul>
<p><img decoding="async" loading="lazy" alt="Microsoft Copilot for Azure - Operate" src="https://luke.geek.nz/assets/images/MicrosoftCopilotforAzure_PillarTest_Operate-bb30d59919e4768156c980e9664f8c5a.gif" width="1905" height="983" class="img_ev3q"></p>
<blockquote>
<p>Copilot for Azure responded to each prompt; it did a great job of taking us to the resources within the Azure Portal when prompted <em>(i.e. take me to view all resources)</em>; it even successfully changed our portal theme and reverted the change. However, I ran into a bug when attempting to shut down and start running Virtual Machines, where the selection prompt wasn't fully loaded, and I had to reset the selection to get it to display. Multiple times, I ran into issues with Azure Resource Graph, not being fully capable of creating and running queries, such as listing all resources and their regions, which I know is accessible by a Resource Graph query. However, Copilot, for Microsoft Azure, was able to successfully stop and start my virtual machines in bulk, making it a lot easier to make adjustments at scale; overall, I believe there are some improvements needed in this area to make it more functional.</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="optimize">Optimize<a href="https://luke.geek.nz/azure/microsoft-copilot-azure-preview/#optimize" class="hash-link" aria-label="Direct link to Optimize" title="Direct link to Optimize">‚Äã</a></h3>
<blockquote>
<p><strong>Optimize</strong> - Improve costs, scalability, and reliability through recommendations for your environment.</p>
</blockquote>
<p>To test the Optimize pillar of Microsoft Copilot for Azure, I will be using the following prompts to ease in and look at the Optimize elements:</p>
<ul>
<li>List all recommendations from Azure Advisor?</li>
<li>Show me the highest resource costs for the past 12 months?</li>
<li>How can I optimize my environment?</li>
<li>Create a naming convention for SQL databases?</li>
<li>How can I protect my storage accounts?</li>
</ul>
<blockquote>
<p>Copilot for Azure responded to each prompt, and it was able to achieve and display the highest resource costs for the past 12 months; once my scope was set <em>(as per current limitations)</em>, it gave me recommendations on how I could generally optimize my environment, Copilot was also able to give recommendations on <em>(non-Azure)</em> SQL Database naming standards and implementations. Being able to review and recommend security recommendations is an enhanced Azure Copilot skill; so glad to know this worked and came back with valid recommendations for my test storage account; the automated implementation of security recommendations, however, isn't currently implemented.</p>
</blockquote>
<p><img decoding="async" loading="lazy" alt="Microsoft Copilot for Azure - Optimize" src="https://luke.geek.nz/assets/images/MicrosoftCopilotforAzure_PillarTest_Optimize-82074dcd1b4c816d6af571c4dc0a5c97.gif" width="1905" height="983" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="troubleshoot">Troubleshoot<a href="https://luke.geek.nz/azure/microsoft-copilot-azure-preview/#troubleshoot" class="hash-link" aria-label="Direct link to Troubleshoot" title="Direct link to Troubleshoot">‚Äã</a></h3>
<blockquote>
<p><strong>Troubleshoot</strong> - Orchestrate across Azure services for insights to summarize issues, identify causes and suggest solutions.</p>
</blockquote>
<p>In this section, one of my Virtual Machines <em>(VM-1)</em> is turned off, so I am unable to RDP to it; let us see if we can use Microsoft Copilot for Azure to troubleshoot this.</p>
<p>To test the Troubleshoot pillar of Microsoft Copilot for Azure, I will be using the following prompts to ease in and look at the Troubleshoot elements:</p>
<ul>
<li>How can I troubleshoot not being able to RDP to VM-1?</li>
<li>Check if port 3390 is open on VM-1?</li>
<li>What are the security implications of opening port 3389?</li>
<li>Create a PowerShell script to test 3389 is opened on VM-1</li>
<li>Adjust the script to use its public IP instead</li>
<li>Take me to VM-1</li>
<li>What is the Public IP of VM-1?</li>
<li>What is this resource?</li>
<li>What are the open alerts?</li>
</ul>
<blockquote>
<p>Overall, using Microsoft Copilot for Azure to Troubleshoot RDP to connectivity to 'VM-1' would have helped, though the scenario that Copilot had come back with was due to being unable to RDP due to a potential brute force attack, had I followed the recommendations, it would have directed me to the appropriate blades, where I saw that the Virtual Machine was turned off. However, Copilot itself didn't have a status check that the Virtual Machine was even started or triggered any alerts that the Virtual Machine was deallocated. There was a delay, when I first prompted for how I troubleshoot, enough of a delay that I cancelled it and then reprompted again, which returned a result resulting in 2 of my 10 requests being used up. It was able to supply information on what resource I had opened in the portal and any active alerts on that resource <em>(Had I been at the All Resources blade; it would have viewed all alerts)</em>.</p>
</blockquote>
<p><img decoding="async" loading="lazy" alt="Microsoft Copilot for Azure - Troubleshoot" src="https://luke.geek.nz/assets/images/MicrosoftCopilotforAzure_PillarTest_Troubleshoot-ae412b8e15ea12ba2193b542ac5c86e0.gif" width="1842" height="945" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://luke.geek.nz/azure/microsoft-copilot-azure-preview/#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">‚Äã</a></h2>
<p>Overall, I feel Copilot for Microsoft Azure is a suitable companion to working with Microsoft Azure as a <em>copilot</em> in the Azure Portal. However, it is clear that this is very much in Preview, and I would argue, unfortunately, not for Commercial or Generally available functionality yet, although I could have high standards on what this could be capable of, so make sure you draw your own conclusions and run your own tests.</p>
<p>As with any prompt, working with LLM <em>(Large Language Models)</em>, context is key - and having a curious mindset in your questioning can help draw out more information.</p>
<p>If you are a beginner user of Azure, I feel that Microsoft Copilot for Azure can help point you in the right direction and to the right information.</p>
<p>Context is key ‚Äì the service takes context on what resource you are at in the Azure Portal, so the more context it has on the resource, the better outputs you will get.</p>
<p>As with all generative AI services, clear prompts are key and don‚Äôt trust the outputs; not all Graph queries are right.</p>
<p>In terms of more intermediate and advanced services, it won‚Äôt replace full-on Azure management capabilities and troubleshooting yet, remember this is a copilot, an assistant.</p>
<blockquote>
<p>The more feedback can be offered using the built-in feedback buttons as part of the user interface, as part of its use ‚Äì the better it will be, and the more skills and tasks it will be able to complete.</p>
</blockquote>
<p>Remember that users can only use Microsoft Copilot for Azure to view resource data and make changes to areas they already have the privilege to do! So as you prepare to roll this out, use it as an opportunity to increase your security and apply just in time and with just enough practice. If you using Infrastructure as Code, then your users may only need Reader access to view data regardless, then Copilot cannot make any changes outside of the toolsets like Terraform you may be deploying.</p>
<p>Overall, this is a product I will be following and cannot wait to see what it becomes; where this product shines at the moment is really in the Enhanced Skills and being able to bring the correct Microsoft Learn documentation straight to you while you are in the Azure Portal, making your learning and engagement a lot more streamlined!</p>
<p><img decoding="async" loading="lazy" alt="Microsoft Copilot for Azure - Enchanced SKills" src="https://luke.geek.nz/assets/images/MicrosoftCopilotforAzure_CopilotEnchancedSkills-b3c321b1a0f32547637997e7a442fa74.png" width="1680" height="945" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="reference">Reference<a href="https://luke.geek.nz/azure/microsoft-copilot-azure-preview/#reference" class="hash-link" aria-label="Direct link to Reference" title="Direct link to Reference">‚Äã</a></h2>
<p>The links below are some relevant reference material for further reading.</p>
<ul>
<li><a href="https://learn.microsoft.com/azure/copilot/overview?wt.mc_id=copilot_1a_webpage_gdc&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">What is Microsoft Copilot for Azure?</a></li>
<li><a href="https://learn.microsoft.com/azure/copilot/overview?wt.mc_id=copilot_1a_webpage_gdc&amp;WT.mc_id=AZ-MVP-5004796#join-the-preview" target="_blank" rel="noopener noreferrer">Join the Preview</a></li>
<li><a href="https://learn.microsoft.com/azure/copilot/get-information-resource-graph?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Enchanced Scenarios</a></li>
<li><a href="https://techcommunity.microsoft.com/t5/azure-infrastructure-blog/simplify-it-management-with-microsoft-copilot-for-azure-save/ba-p/3981106?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Simplify IT management with Microsoft Copilot for Azure ‚Äì save time and get answers fast</a></li>
</ul>]]></content>
        <author>
            <name>Luke Murray</name>
            <uri>https://luke.geek.nz</uri>
        </author>
        <category label="Azure" term="Azure"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Azure Dev/Test Subscription considerations]]></title>
        <id>https://luke.geek.nz/azure/Azure-DevTest-Subscription-Considerations/</id>
        <link href="https://luke.geek.nz/azure/Azure-DevTest-Subscription-Considerations/"/>
        <updated>2023-12-21T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[When looking at your Dev/Test workloads in Azure, you may be considering the Azure Plan for Dev/Test Enterprise subscription type, available on both the Microsoft Customer Agreement (MCA) and Enterprise Agreement (EA) billing account types.]]></summary>
        <content type="html"><![CDATA[<p>When looking at your Dev/Test workloads in Azure, you may be considering the <a href="https://azure.microsoft.com/en-us/pricing/offers/ms-azr-0148p?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Plan for Dev/Test Enterprise</a> subscription type, available on both the <a href="https://learn.microsoft.com/azure/cost-management-billing/understand/mca-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Microsoft Customer Agreement (MCA)</a> and <a href="https://www.microsoft.com/en-us/licensing/licensing-programs/enterprise?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Enterprise Agreement (EA)</a> billing account types.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="https://luke.geek.nz/azure/Azure-DevTest-Subscription-Considerations/#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">‚Äã</a></h2>
<p>So, let us look at what this entails...</p>
<blockquote>
<p>You get <strong>Azure Plan for DevTest</strong> when you sign the <strong>Microsoft Customer Agreement</strong>. The <strong>Enterprise DevTest</strong> offer is available only to <strong>Enterprise Agreement</strong> customers, but they are <em>essentially</em> the <strong>same plan</strong>. The SKU value for Enterprise Dev/Test is: <a href="https://azure.microsoft.com/en-in/pricing/offers/ms-azr-0148p?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">ms-azr-0148p</a> and Azure Plan for Dev/Test Enterprise is: <a href="https://azure.microsoft.com/pricing/offers/ms-azr-0148g?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">ms-azr-0148g</a>, but as usual <strong>make sure you clarify and confirm with your direct Microsoft licensing/customer success manager, as these could change</strong>.</p>
</blockquote>
<p>There are a few gotchas to using the Dev/Test Enterprise Azure Plan that you need to be aware of, but before we go into that - let us take a look at some of the benefits:</p>
<p>Run your development and testing workloads on Azure by using the Azure Plan for DevTest, which includes:</p>
<ul>
<li>Access to exclusive DevTest images in the gallery, including Windows 8.1 and Windows 10/11 images.</li>
<li>Lower DevTest rates running Windows on Azure Virtual Machines, Azure App Service, Azure Cloud Services, Azure HDInsight, Azure Logic Apps, and Azure SQL Database.</li>
<li>Centralized management via the Azure portal.</li>
<li>The ability to create multiple subscriptions makes the plan ideal for development teams.</li>
</ul>
<p>When looking at the DevTest plan, this particular one will catch your eye:</p>
<blockquote>
<p><strong>Lower DevTest rates</strong> running Windows on Azure Virtual Machines, Azure App Service, Azure Cloud Services, Azure HDInsight, Azure Logic Apps, and Azure SQL Database. You can save even more with reservations.</p>
</blockquote>
<p>What this means is that for items like Azure Virtual Machines running Windows as an example, you won't be charged the OS <em>(Operating System)</em> license costs, so essentially the same cost as if you were running a Linux workload, the same for the SQL services. However, this is a small number of resources <em>(in comparison to the entire set of services offered by Microsoft Azure)</em>, which covers standard services that over time can make a huge difference to the cost of running these services.</p>
<blockquote>
<p>Provision fast, lean, and highly secure dev/test workloads on Azure‚Äîand realize substantial cost savings compared to your production workloads. Your dev/test discounted rates continue as long as you maintain your Visual Studio subscription.</p>
</blockquote>
<p>It is worth noting that although the intended readers of this are those with MCA or Enterprise Agreements with Microsoft, for those Visual Studio subscribers, you can go down the Dev/Test subscription route with <a href="https://azure.microsoft.com/en-gb/pricing/offers/ms-azr-0023p/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">PayAsYouGo/DevTest</a> with a credit card as well, keep in mind the considerations below.</p>
<p>CSP <em>(Cloud Solution Provider)</em> doesn't currently have a DevTest offer, but you could fall back to the Pay As You Go route.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="considerations">Considerations<a href="https://luke.geek.nz/azure/Azure-DevTest-Subscription-Considerations/#considerations" class="hash-link" aria-label="Direct link to Considerations" title="Direct link to Considerations">‚Äã</a></h2>
<p>Now that we know some of the benefits of the DevTest plans, there are a few things to keep in mind that I have found a few people either didn't know *(and these subscriptions were deployed like candy at Halloween across organisations)*or were confused about, so let us cover it here.</p>
<p><img decoding="async" loading="lazy" alt="VisualStudio Subscription Types" src="https://luke.geek.nz/assets/images/BlobHeading_Azure-DevTest-Considerations-194ee71309647c901bde4b80dc797b53.gif" width="1200" height="628" class="img_ev3q"></p>
<p>I want it to be perfectly clear: if you meet the criteria to use the DevTest subscriptions, you should! But you might find you will end up with a mix of Pay As You Go and DevTest subscriptions, depending on your requirements <em>(and that's ok!)</em>.</p>
<blockquote>
<p>Remember: The Dev/Test plan is exclusively intended for developing and testing your applications.</p>
</blockquote>
<p>The considerations that you need to consider when selecting a Dev/Test subscription type over a Pay As You Go are as follows:</p>
<ul>
<li>The Dev/Test Azure Plan doesn't contain a financially backed service-level agreement <em>(SLA)</em>. The only exceptions are Azure DevOps, Azure Monitor and Visual Studio App Center. The entire purpose of this subscription is to give you the ability to trial and test services - and NOT run production workloads or services. This makes sense.</li>
<li>Only active Visual Studio subscribers with standard subscriptions can use the Azure resources running within an Enterprise Dev/Test subscription (yes, that's right, everyone who has access to modify/create/delete resources needs to be a Visual Studio subscriber). This is the one that usually catches people out; although there are no technical guardrails preventing subscription use by unlicensed users, you still need to comply with the license agreement. Although it's worth pointing out, end users can also access the applications you build on top of the platform to provide feedback or perform acceptance tests without requiring a license.</li>
<li>DevTest subscriptions are also compute quota limited, ie the compute quota restrictions are more restrictive (ie 10 cores on DevTest subscriptions vs 350 quota limit on non-devtest subscriptions).</li>
</ul>
<blockquote>
<p>Even though there is no SLA for any resources deployed in the subscription, Support is still available <em>(i.e. open support tickets for resources)</em> if a suitable support plan exists as part of your MCA or Enterprise Agreement or is purchased for that subscription.</p>
</blockquote>
<p>Those are the two primary considerations that you need to consider when deciding on what subscription type to use; you will find for some teams that have relevant Visual Studio subscriptions, DevTest will work fine, but for others, Pay As You Go will be the right choice - your environment, may end up with a mix of both subscription types - make sure its clear what subscription license type it is, an example is I usually encourage subscriptions to be standing by pre-created ready to go and named something like 'PLACEHOLDER-PAYASYOUGO' or 'PLACEHOLDER-DEVTEST', although you can use Tags for this as well - the Overview pane of the Subscription resource also indicates the Subscription type.</p>
<p>The last thing I will cover is what <em>Visual Studio subscribers</em> actually mean. To do that, we will take a look at the <a href="https://visualstudio.microsoft.com/subscriptions?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Visual Studio subscriptions</a>.</p>
<p>If you navigate down the page, you will see a dropdown list with all the Visual Studio subscription types.</p>
<p><img decoding="async" loading="lazy" alt="VisualStudio Subscription Types" src="https://luke.geek.nz/assets/images/VisualStudio_Subscription-Types-9cb7d1b6168c55f6baa12f9ae4d87846.png" width="1153" height="469" class="img_ev3q"></p>
<p>If you click on the Azure tab, you will see the Azure credit <em>(for their own non-EA or MCA subscription)</em> and whether they are eligible as a valid Azure Dev/Test subscription user. To make it easier, here is a current table:</p>


















































<table><thead><tr><th><strong>Visual Studio Subscription Type</strong></th><th><strong>Azure Personal Credit</strong></th><th><strong>Valid Azure Dev/Test user</strong></th></tr></thead><tbody><tr><td>Visual Studio Enterprise monthly subscriptions</td><td>$0</td><td>No</td></tr><tr><td>Visual Studio Enterprise subscription</td><td>$150</td><td>Yes</td></tr><tr><td>Visual Studio subscriptions with GitHub Enterprise</td><td>$150</td><td>Yes</td></tr><tr><td>Visual Studio Professional monthly subscriptions</td><td>$0</td><td>No</td></tr><tr><td>Visual Studio Professional</td><td>$50</td><td>Yes</td></tr><tr><td>Visual Studio Professional subscriptions with GitHub Enterprise</td><td>$50</td><td>Yes</td></tr><tr><td>Visual Studio Test Professional subscription</td><td>$50</td><td>Yes</td></tr><tr><td>MSDN Platforms</td><td>$100</td><td>Yes</td></tr></tbody></table>
<p><em>Azure personal credit is in USD.</em></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="reference">Reference<a href="https://luke.geek.nz/azure/Azure-DevTest-Subscription-Considerations/#reference" class="hash-link" aria-label="Direct link to Reference" title="Direct link to Reference">‚Äã</a></h2>
<p>The links below are some relevant reference material for further reading.</p>
<ul>
<li><a href="https://azure.microsoft.com/en-us/pricing/offers/ms-azr-0148p?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Enterprise Dev/Test</a></li>
<li><a href="https://azure.microsoft.com/pricing/offers/ms-azr-0148g?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Plan for DevTest</a></li>
<li><a href="https://learn.microsoft.com/azure/cost-management-billing/manage/create-enterprise-subscription?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Create an Enterprise Agreement subscription</a></li>
<li><a href="https://learn.microsoft.com/en-us/azure/cost-management-billing/manage/create-subscription?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Create a Microsoft Customer Agreement subscription</a></li>
<li><a href="https://visualstudio.microsoft.com/subscriptions?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Visual Studio subscriptions</a></li>
</ul>]]></content>
        <author>
            <name>Luke Murray</name>
            <uri>https://luke.geek.nz</uri>
        </author>
        <category label="Azure" term="Azure"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Azure Image Builder Image Build with Bicep and Azure DevOps]]></title>
        <id>https://luke.geek.nz/azure/Azure-Image-Builder-Build-Pipeline-with-Azure-DevOps/</id>
        <link href="https://luke.geek.nz/azure/Azure-Image-Builder-Build-Pipeline-with-Azure-DevOps/"/>
        <updated>2023-11-22T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Azure Image Builder is an Azure managed service (running Packer underneath) that allows you to create customised Virtual Machine images.]]></summary>
        <content type="html"><![CDATA[<p><a href="https://learn.microsoft.com/azure/virtual-machines/image-builder-overview?tabs=azure-powershell&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Image Builder</a> is an Azure managed service <em>(running <a href="https://www.packer.io/" target="_blank" rel="noopener noreferrer">Packer</a> underneath)</em> that allows you to create customised Virtual Machine images.</p>
<blockquote>
<p>By using standardized virtual machine (VM) images, your organization can more easily migrate to the cloud and help ensure consistency in your deployments. Images ordinarily include predefined security, configuration settings, and any necessary software. Setting up your own imaging pipeline requires time, infrastructure, and many other details. With Azure VM Image Builder, you only need to create a configuration that describes your image and submit it to the service where it is built and distributed.
With VM Image Builder, you can migrate your image customization pipeline to Azure as you continue using existing scripts, commands, and processes. You can integrate your core applications into a VM image so that your VMs can take on workloads after the images are created. You can even add configurations to build images for Azure Virtual Desktop as virtual hard discs (VHDs) for use in Azure Stack or for ease of exporting.</p>
</blockquote>
<p><img decoding="async" loading="lazy" alt="Azure Image Builder Image Build with Bicep and Azure DevOps" src="https://luke.geek.nz/assets/images/BlobHeading_Azure-Image-Builder-Image-Build-Bicep-Azure-DevOps-e125d198e1649cad7773d7316963e11c.png" width="1200" height="628" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="https://luke.geek.nz/azure/Azure-Image-Builder-Build-Pipeline-with-Azure-DevOps/#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">‚Äã</a></h2>
<p>With the AIB (Azure Image Builder) service, you can quickly and easily create machine images for Azure environments using standardized virtual machine (VM) images, create a configuration that describes your image and submit it to the service for building and distribution.</p>
<blockquote>
<p>When you submit the configuration to the service, Azure creates an image template resource. When the image template resource is made, a staging resource group is created in your Azure subscription in the following format: IT_DestinationResourceGroupTemplateName(GUID). The staging resource group contains files and scripts, which are referenced in the File, Shell, and PowerShell customization in the ScriptURI property.</p>
</blockquote>
<p>To run the build, you invoke Run on the VM Image Builder template resource. The service then deploys additional resources for the build, such as a VM, network, disk, and network adapter. If you build an image without using an existing virtual network, VM Image Builder also deploys a public IP and network security group, and it connects to the build VM using Secure Shell (SSH) or Windows Remote Management (WinRM) protocol. If you select an existing virtual network, the service is deployed via Azure Private Link, and a public IP address isn't required.</p>
<p>When the build finishes, all resources are deleted except for the staging resource group and the storage account. You can remove them by deleting the image template resource or leaving them in place to run the build again.</p>
<p>To use Azure Image Builder, you need to create a configuration that describes your image and submit it to the service where it is built and distributed. A high-level workflow is illustrated in the following diagram:</p>
<p><img decoding="async" loading="lazy" alt="Azure Image Builder Flow" src="https://luke.geek.nz/assets/images/image-builder-flow-848f04a2c5e7a1057278b1a6cca1ca91.png" width="2110" height="790" class="img_ev3q"></p>
<p>Today, we will be using Azure Bicep to create the following:</p>
<ul>
<li>Azure Compute Gallery <em>(this will be used to hold our Image Template, so we can build our Virtual Machines from it)</em></li>
<li>Image definition <em>(for the purpose, we will using a Windows Server 2022 Marketplace image, with additional customisations)</em></li>
<li>Image Template <em>(this will include our customisations)</em></li>
<li>User Assigned Managed Identity <em>(the user assigned managed identity will be used to build the image and read the blobs from the Azure storage account)</em></li>
<li>Azure Storage account <em>(the Azure storage account, will hold our Application install files)</em></li>
</ul>
<p><img decoding="async" loading="lazy" alt="Azure Image Builder - Bicep" src="https://luke.geek.nz/assets/images/AIB_Bicep-dba9b93c7d3d7a985d84304e79e5c8bd.png" width="1311" height="543" class="img_ev3q"></p>
<p>And then an Azure DevOps pipeline to deploy and build our template, including an application install of <a href="https://azure.microsoft.com/products/storage/storage-explorer?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Storage Explorer</a> and <a href="https://learn.microsoft.com/sysinternals/downloads/bginfo?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">bginfo</a>.</p>
<p>All the code can be found on my public GitHub repository here: <a href="https://github.com/lukemurraynz/AzureImageBuilder" target="_blank" rel="noopener noreferrer">lukemurraynz/AzureImageBuilder</a></p>
<p>The Azure DevOps pipeline will complete the following steps:</p>
<ol>
<li>Create a new Azure Resource Group <em>(if required)</em></li>
<li>Create an Azure storage account <em>(with public access enabled, and anonymous blob access)</em></li>
<li>Copy the app install files in the /apps/ directory in git to the Azure storage account <em>(if they don't already exist)</em></li>
<li>Deploy the Azure Image Builder infrastructure and Template</li>
<li>Trigger an Azure CLI command to run the template build</li>
<li>Adjust public access to the Azure storage account to disable.</li>
</ol>
<p>The git repository is laid out like so:</p>

























<table><thead><tr><th>Folder</th><th>Description</th></tr></thead><tbody><tr><td>.pipelines</td><td>Contains CI/CD pipeline configurations and scripts.</td></tr><tr><td>apps</td><td>Houses application code and related resources.</td></tr><tr><td>iac</td><td>Stores Infrastructure as Code (IaC) configurations.</td></tr><tr><td>scripts</td><td>Contains utility scripts and other automation tools.</td></tr></tbody></table>
<p>Within the iac folder is a customizations.bicep file. This file is intended for your image customisations; I intended to keep this separate from the infrastructure for easy modification without impacting any other file.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="azure-devops-configuration">Azure DevOps Configuration<a href="https://luke.geek.nz/azure/Azure-Image-Builder-Build-Pipeline-with-Azure-DevOps/#azure-devops-configuration" class="hash-link" aria-label="Direct link to Azure DevOps Configuration" title="Direct link to Azure DevOps Configuration">‚Äã</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-project">Create Project<a href="https://luke.geek.nz/azure/Azure-Image-Builder-Build-Pipeline-with-Azure-DevOps/#create-project" class="hash-link" aria-label="Direct link to Create Project" title="Direct link to Create Project">‚Äã</a></h3>
<p>Before we can build an image using Bicep and Azure DevOps, we need to create a project to hold our code.</p>
<ol>
<li>Login to your <strong><a href="https://dev.azure.com/" target="_blank" rel="noopener noreferrer">Azure DevOps</a></strong> instance</li>
<li>Click <strong>+ New Project</strong></li>
<li>Type in a <strong>name for the project</strong> <em>(ie AIB (short for Azure Image Builder))</em></li>
<li>Click <strong>Create</strong></li>
</ol>
<p><img decoding="async" loading="lazy" alt="Azure DevOps - Create Project" src="https://luke.geek.nz/assets/images/CreateADOAIBProject-06e65288801480aec1de66e1c4a4db1d.gif" width="1904" height="955" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="initialize-repo">Initialize Repo<a href="https://luke.geek.nz/azure/Azure-Image-Builder-Build-Pipeline-with-Azure-DevOps/#initialize-repo" class="hash-link" aria-label="Direct link to Initialize Repo" title="Direct link to Initialize Repo">‚Äã</a></h3>
<p>Now that we have our project, we can initialize the repository by cloning the <a href="https://github.com/lukemurraynz/AzureImageBuilder" target="_blank" rel="noopener noreferrer">lukemurraynz/AzureImageBuilder</a> repository, containing all the code we need.</p>
<p><em>Note: Due to git limitations, the Azure Storage Explorer install file is unable to be stored in the GitHub repository, for my demo. I will upload it to Azure DevOps after the clone. It's not recommended to store the binary files for large installs in Git directly for production and to store them in an Azure storage account. This process can be modified to skip the copy application step and install existing files from the Azure storage account.</em></p>
<ol>
<li>Login to your <strong><a href="https://dev.azure.com/" target="_blank" rel="noopener noreferrer">Azure DevOps</a></strong> instance</li>
<li><strong>Navigate</strong> to your <strong>AIB</strong> project</li>
<li>Click <strong>Repos</strong></li>
<li>Click <strong>Import</strong></li>
<li>Make sure the repository type is: <strong>Git</strong> and clone <strong>URL</strong> is: <a href="https://github.com/lukemurraynz/AzureImageBuilder" target="_blank" rel="noopener noreferrer">https://github.com/lukemurraynz/AzureImageBuilder</a></li>
<li>Click <strong>Import</strong></li>
</ol>
<p><img decoding="async" loading="lazy" alt="Azure DevOps - Create Project" src="https://luke.geek.nz/assets/images/ImportADOAIBProject-3270a96f5d33d3133ee07848017f4104.gif" width="1904" height="974" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-azure-service-connection">Create Azure Service Connection<a href="https://luke.geek.nz/azure/Azure-Image-Builder-Build-Pipeline-with-Azure-DevOps/#create-azure-service-connection" class="hash-link" aria-label="Direct link to Create Azure Service Connection" title="Direct link to Create Azure Service Connection">‚Äã</a></h3>
<p>Now that we have our repository and the base code - we need a service connection. This connection will allow our Azure DevOps pipeline authorization to our Microsoft Azure subscription. To do this, we will use, the new <a href="https://learn.microsoft.com/entra/workload-id/workload-identity-federation?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Workload Identity Federation</a>, which allows us to authenticate to Azure, without worrying about secret management.</p>
<ol>
<li>Login to your <strong><a href="https://dev.azure.com/" target="_blank" rel="noopener noreferrer">Azure DevOps</a></strong> instance</li>
<li><strong>Navigate</strong> to your <strong>AIB</strong> project</li>
<li>Click on <strong>Project Settings</strong></li>
<li>Click on <strong>Service connections</strong></li>
<li>Click on <strong>Create service connection</strong></li>
<li>Select <strong>Azure Resource Manager</strong></li>
<li>Click <strong>Next</strong></li>
<li>Click <strong>Workload Identity federation (automatic)</strong></li>
<li>Click <strong>Next</strong></li>
<li>Select your <strong>Subscription</strong> <em>(after authenticating to Azure)</em>, and give it a <strong>name</strong> <em>(you will need the name for the Pipeline)</em>.</li>
<li>Click <strong>Save</strong></li>
</ol>
<p>Note: Consider scoping your Service Connection to the individual Image Builder Resource Group for the least permissions.</p>
<p><img decoding="async" loading="lazy" alt="Azure DevOps - Create Service Connection" src="https://luke.geek.nz/assets/images/CreateAzureServiceConnectionAIBProject-a8739909de7868e5ce4faa50c05ec5de.gif" width="1894" height="966" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="import-pipeline">Import Pipeline<a href="https://luke.geek.nz/azure/Azure-Image-Builder-Build-Pipeline-with-Azure-DevOps/#import-pipeline" class="hash-link" aria-label="Direct link to Import Pipeline" title="Direct link to Import Pipeline">‚Äã</a></h3>
<p>Now that we have our Service Connection let us import our pipeline, which will be used to run our image build.</p>
<ol>
<li>Login to your <strong><a href="https://dev.azure.com/" target="_blank" rel="noopener noreferrer">Azure DevOps</a></strong> instance</li>
<li><strong>Navigate</strong> to your <strong>AIB</strong> project</li>
<li>Click <strong>Pipelines</strong></li>
<li>Click <strong>Create pipeline</strong></li>
<li>Specify <strong>Azure Repos Git</strong></li>
<li>Select your <strong>repository</strong> <em>(ie AIB)</em></li>
<li>Select <strong>Existing Azure Pipelines YAML file</strong></li>
<li>Under the <strong>dropdown</strong> list for the Path, select: <strong>/.pipelines/azure-pipelines.yml</strong></li>
<li>Click <strong>Continue</strong></li>
<li>Click on the ellipsis and select <strong>Save</strong></li>
</ol>
<p><img decoding="async" loading="lazy" alt="Azure DevOps - Create Project" src="https://luke.geek.nz/assets/images/Import-AzureDevOpsPiipeline-AIBProject-f1bb2779f62ea402f3b058ebbeff1a6a.gif" width="1894" height="966" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="edit-pipeline-to-use-service-connection">Edit Pipeline to use service connection<a href="https://luke.geek.nz/azure/Azure-Image-Builder-Build-Pipeline-with-Azure-DevOps/#edit-pipeline-to-use-service-connection" class="hash-link" aria-label="Direct link to Edit Pipeline to use service connection" title="Direct link to Edit Pipeline to use service connection">‚Äã</a></h3>
<p>Now that the pipeline has been imported, we need to edit it to use the Azure resource manager service connection we created earlier. Make sure you know the name of your service connection <em>(ie ServiceConnection-AIB)</em></p>
<ol>
<li>
<p>Login to your <strong><a href="https://dev.azure.com/" target="_blank" rel="noopener noreferrer">Azure DevOps</a></strong> instance</p>
</li>
<li>
<p><strong>Navigate</strong> to your <strong>AIB</strong> project</p>
</li>
<li>
<p>Click <strong>Pipelines</strong></p>
</li>
<li>
<p>Click on your <strong>Pipelines</strong>, select <strong>Edit</strong></p>
</li>
<li>
<p>The Service Connection has been created as a <strong>Variable</strong>, named <strong>serviceconnection</strong> in the pipeline, so we need to update the section:</p>
<p>serviceconnection: azserviceconnections</p>
</li>
</ol>
<p>To match the name of our service connection:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">serviceconnection: ServiceConnection-AIB</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Then click <strong>Save</strong></p>
<p><em>Note: The Pipeline, by default, is set to run automatically; when it triggers a new commit to the main branch of the repo, you can adjust this to None else. It will try to run and fail <em>(as its missing variables, etc)</em>. If you do this, you can trigger the pipeline manually, but it depends on your requirements; as part of the testing - I liked that it automatically ran on every change to the code without having been manually triggered.</em></p>
<p><img decoding="async" loading="lazy" alt="Azure DevOps - Edit Pipeline" src="https://luke.geek.nz/assets/images/Edit-AzureDevOpsPiipelineServiceConnection-AIBProject-54ba231374150f000c4b091e641d5440.gif" width="1894" height="966" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="edit-pipeline-to-add-variables">Edit Pipeline to add variables<a href="https://luke.geek.nz/azure/Azure-Image-Builder-Build-Pipeline-with-Azure-DevOps/#edit-pipeline-to-add-variables" class="hash-link" aria-label="Direct link to Edit Pipeline to add variables" title="Direct link to Edit Pipeline to add variables">‚Äã</a></h3>
<p>Here is where some of the customisation comes into play. The pipeline is looking for the following variables:</p>
<ul>
<li>imagetemplatename</li>
<li>location</li>
<li>resourceGroupName</li>
<li>storageaccountname</li>
</ul>
<p>These variables will be consumed by the Azure CLI, to create the Resource Group and Azure Bicep, to create the Image template and Azure storage account, in your preferred region.</p>
<p>Because in my demo, I am creating a 'Windows Server 2022' image in Australia East, my variables and values will be as follows:</p>

























<table><thead><tr><th>Variables</th><th>Values</th></tr></thead><tbody><tr><td>storageaccountname</td><td>saccimg4545</td></tr><tr><td>resourceGroupName</td><td>azimagebuild-rg</td></tr><tr><td>location</td><td>australiaeast</td></tr><tr><td>imagetemplatename</td><td>server2022template</td></tr></tbody></table>
<p>So let us add them.</p>
<ol>
<li>Login to your <strong><a href="https://dev.azure.com/" target="_blank" rel="noopener noreferrer">Azure DevOps</a></strong> instance</li>
<li><strong>Navigate</strong> to your <strong>AIB</strong> project</li>
<li>Click <strong>Pipelines</strong></li>
<li>Click on your <strong>Pipelines</strong>, select <strong>Edit</strong></li>
<li>Click <strong>Variables</strong></li>
<li>Select <strong>New Variable</strong></li>
<li><strong>Add</strong> the required <strong>variables</strong>, make sure they are unique to your own environment <em>(ie the storage account name, needs to be globally unique)</em></li>
<li>Click <strong>Save</strong></li>
</ol>
<p><img decoding="async" loading="lazy" alt="Azure DevOps - Edit Pipeline" src="https://luke.geek.nz/assets/images/Save-AzureDevOpsPipelineVariables-AIBProject-063cf5d9532e725cdcad3214a88f23a6.gif" width="1894" height="966" class="img_ev3q"></p>
<blockquote>
<p>There is an <a href="https://learn.microsoft.com/en-us/azure/virtual-machines/linux/image-builder-devops-task?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure DevOps Task</a>, to do the build, however its in preview and doesn't support elements such as a Virtual Machine restart at this time, so in my Pipeline, I am triggering the build using the Azure CLI.</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="bicep-configuration">Bicep Configuration<a href="https://luke.geek.nz/azure/Azure-Image-Builder-Build-Pipeline-with-Azure-DevOps/#bicep-configuration" class="hash-link" aria-label="Direct link to Bicep Configuration" title="Direct link to Bicep Configuration">‚Äã</a></h2>
<p>You can modify the Bicep according to your own environment; items in the 'main.bicep' file you may want to change <em>(that I didn't turn into a variable)</em> are:</p>
<ul>
<li>Compute Gallery Name</li>
<li>Compute Gallery image name</li>
<li>Paired region that the image template will be replicated to. This is set to the same region as my source.</li>
<li>Name of the User Assigned Managed Identity</li>
</ul>
<blockquote>
<p>To reduce build time, the build VM size I am using is custom: Standard_D4ds_v5. If you remove this, it will default to the Standard_D2ds_v4 size, as you only pay for the time that the VM is building and sys prepping; I found the extra cores useful.</p>
</blockquote>
<p>I separated the Image Template <a href="https://learn.microsoft.com/azure/virtual-machines/linux/image-builder-json?tabs=json%2Cazure-powershell&amp;WT.mc_id=AZ-MVP-5004796#properties-customize" target="_blank" rel="noopener noreferrer">customization</a> components, into its own Bicep module, that gets called into the main variable, I intend the customizations.bicep to be separate from the Azure Image Builder infrastructure components, to reduce impact or data loss, and make it easier for a first timer to customize the image separately, allowing you to revert any changes to the image build itself easily.</p>
<p>You may also want to test <a href="https://learn.microsoft.com/en-us/azure/virtual-machines/vm-boot-optimization?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Image Optimization</a>; I have this enabled; however, it does add time to the image build process, but could improve your Virtual Machine creation time, could be useful to use in conjunction with a service, like Azure Virtual Desktop.</p>
<blockquote>
<p>This is the main file you will want to start modifying for your own image customization; I recommend starting small <em>(i.e. create a folder)</em>, then adding the apps and customisations one after the other.</p>
</blockquote>
<p>As part of the image build, I am:</p>
<ol>
<li>Creating a c:\Apps\ folder</li>
<li>Setting the timezone <em>(although this gets overwritten by the sysprep back to UTC)</em></li>
<li>Install the latest Windows Updates</li>
<li>Restart</li>
<li>Copy bginfo from the storage account <em>(this has been copied to the Azure storage account as part of the pipeline step)</em> to the apps folder. As it is small in size, I am using the File Packer provider to do the copy.</li>
<li>Copy the Azure Storage Explorer install file from the storage account <em>(this has been copied to the Azure storage account as part of the pipeline step)</em> to the apps folder. As this is a larger file, the File packer provider locked up when attempting to copy, so I am leveraging Invoke-RestMethod to download it to the apps folder.</li>
<li>Extract the bginfo zip file</li>
<li>Install the Azure Storage Explorer</li>
<li>Do a final Windows Update install <em>(in a past life, I've found new updates - ie Visual Studio can popup after application installs, if your image build time is quite long, feel free to remove this step, for me its a personal preference)</em></li>
<li>Do a final restart</li>
</ol>
<p>As you can see, everything is mostly PowerShell-driven. Be aware of the double backslashes needed as well; for directories, using a single backslash will cause issues, as it is classed as an escape character. When editing the Bicep file, make sure you make sure of the <a href="https://marketplace.visualstudio.com/items?itemName=ms-azuretools.vscode-bicep" target="_blank" rel="noopener noreferrer">Bicep Visual Studio code extension</a>. I have also created a base <a href="https://luke.geek.nz/azure/Getting-Started-with-GitHub-Codespaces/" target="_blank" rel="noopener noreferrer">Codespace</a> in the GitHub repo that you could work from as well.</p>
<p>Then, ideally, you can delete your previous image template every month and create a new one with the latest Windows Updates. Hopefully, this has given you enough of a sample to work from.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="run-image-build-deployment">Run image build deployment<a href="https://luke.geek.nz/azure/Azure-Image-Builder-Build-Pipeline-with-Azure-DevOps/#run-image-build-deployment" class="hash-link" aria-label="Direct link to Run image build deployment" title="Direct link to Run image build deployment">‚Äã</a></h2>
<p>So, we have modified our Bicep and have our pipeline ready to go! It's time to run the build and create our Azure resources. We do this from Azure DevOps.</p>
<ol>
<li>Login to your <strong><a href="https://dev.azure.com/" target="_blank" rel="noopener noreferrer">Azure DevOps</a></strong> instance</li>
<li><strong>Navigate</strong> to your <strong>AIB</strong> project</li>
<li>Click <strong>Pipelines</strong></li>
<li>Click on your <strong>Pipeline</strong></li>
<li>Select <strong>Run pipeline</strong></li>
<li>Before the pipeline runs, we need to <strong>verify that the Pipeline has permission</strong> to use the service connection</li>
<li>Select <strong>Verify</strong></li>
<li>Select <strong>Approve</strong> to allow the pipeline stages, the ability to use the service principal</li>
</ol>
<blockquote>
<p>If your build Build fails halfway through with the following error when attempting to create the Azure Image Builder resources:
ERROR: {"code": "InvalidTemplateDeployment", "message": "Deployment failed with multiple errors: 'Authorization failed for template resource 'e6eaf07c-bb64-57d4-a69a-6d1463a77bdb' of type 'Microsoft.Authorization/roleAssignments'. The client '1d06bec0-6bb8-4ba2-b33b-98a4eafd5b84' with object id '1d06bec0-6bb8-4ba2-b33b-98a4eafd5b84' does not have permission to perform action 'Microsoft.Authorization/roleAssignments/write
This is due to the Service Connection not having Owner rights to the Azure subscription. Owner rights are created for the User Assigned Managed identity role assignments. You can fix this by copying the Object ID of the error, navigating to <a href="https://portal.azure.com/#view/Microsoft_AAD_IAM/StartboardApplicationsMenuBlade/~/AppAppsPreview/menuId~/null" target="_blank" rel="noopener noreferrer">Entra ID Enterprise Apps</a>, and search by your Object ID. This will find an Enterprise Application, that is used by Azure DevOps to talk to Azure. Copy the Name, and navigate to your Azure subscription, and Access Control (IAM) blade, and add in your Enterprise Application as Owner.</p>
</blockquote>
<blockquote>
<p>It can take 30+ minutes to build a Virtual Machine; the more customisations, the longer it will take, so please be patient, after the build has kicked off. As part of the build, you can also download and review the packer logs directly from the Storage account that was created in the IT resource group. I highly recommend testing one customization before proceeding to the next until you have the implementation downpack. The build step, if completed, will move to Optimizing, then Distributing to the Compute Gallery before it can be used.</p>
</blockquote>
<p><img decoding="async" loading="lazy" alt="Azure DevOps - Run Pipeline" src="https://luke.geek.nz/assets/images/Run-AzureDevOpsBuildPipeline-AIBProject-17a9786e20178b54d27f68e2fe73f4ef.gif" width="1894" height="966" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="build-virtual-machine">Build Virtual Machine<a href="https://luke.geek.nz/azure/Azure-Image-Builder-Build-Pipeline-with-Azure-DevOps/#build-virtual-machine" class="hash-link" aria-label="Direct link to Build Virtual Machine" title="Direct link to Build Virtual Machine">‚Äã</a></h2>
<p>Now that we have successfully built our Windows Server 2022 image, entirely automated using Bicep and Azure DevOps pipeline, let us create a Virtual Machine using the image that now resides in our Compute Gallery. To do this, we will simply use the Azure Portal to build and test from the Compute Gallery.</p>
<ol>
<li>Login to the <strong><a href="https://portal.azure.com/#home" target="_blank" rel="noopener noreferrer">Azure Portal</a></strong></li>
<li>Navigate to your <strong>Azure Compute Gallery</strong></li>
<li>Click your <strong>Image definition</strong>, which should now have a version associated with it <em>(ie 1.0.0 (latest version))</em></li>
<li>Click <strong>+ Create VM</strong></li>
<li>Navigate through the normal steps to create your virtual machine using your custom template.</li>
</ol>
<p><img decoding="async" loading="lazy" alt="Azure Portal - Create Virtual Machine" src="https://luke.geek.nz/assets/images/Create-TestVM-AIBProject-32c117f9d6fa4a932f34ce811cd4533c.gif" width="1894" height="966" class="img_ev3q"></p>
<p>As you can see, the Virtual Machine has the Apps folder, Azure Storage Explorer installed and the bginfo executable stored as part of the image template.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="code">Code<a href="https://luke.geek.nz/azure/Azure-Image-Builder-Build-Pipeline-with-Azure-DevOps/#code" class="hash-link" aria-label="Direct link to Code" title="Direct link to Code">‚Äã</a></h2>
<p>All the code can be found on my public GitHub repository here: <a href="https://github.com/lukemurraynz/AzureImageBuilder" target="_blank" rel="noopener noreferrer">lukemurraynz/AzureImageBuilder</a>. This is the master <em>(and happy to take any contributions to it; just open a Pull Request)</em>,; for reference the code can be reviewed below:</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="mainbicep">main.bicep<a href="https://luke.geek.nz/azure/Azure-Image-Builder-Build-Pipeline-with-Azure-DevOps/#mainbicep" class="hash-link" aria-label="Direct link to main.bicep" title="Direct link to main.bicep">‚Äã</a></h3>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">main.bicep</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// Define parameters for the Bicep template</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> location </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">resourceGroup</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">location</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> imagetemplatename </span><span class="token datatype class-name">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> azComputeGalleryName </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'myGallery'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token decorator">@description</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'The name of the Storage account.'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> stgaccountname </span><span class="token datatype class-name">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> azUserAssignedManagedIdentity </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'useri'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Define the details for the VM offer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="token plain"> vmOfferDetails </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">offer</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'WindowsServer'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">publisher</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'MicrosoftWindowsServer'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">sku</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'2022-datacenter-azure-edition'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Include the customizations module</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">module</span><span class="token plain"> customizationsModule </span><span class="token string" style="color:rgb(255, 121, 198)">'customizations.bicep'</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'customizationsModule'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">params</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">stgaccountname</span><span class="token operator">:</span><span class="token plain"> stgaccountname</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Create a user-assigned managed identity</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> uami </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.ManagedIdentity/userAssignedIdentities@2023-01-31'</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> azUserAssignedManagedIdentity</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">location</span><span class="token operator">:</span><span class="token plain"> location</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Create a Compute Gallery</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> azComputeGallery </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.Compute/galleries@2022-03-03'</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> azComputeGalleryName</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">location</span><span class="token operator">:</span><span class="token plain"> location</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">description</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'mygallery'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Assign the Contributor role to the managed identity at the resource group scope</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> uamicontribassignment </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.Authorization/roleAssignments@2022-04-01'</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">guid</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token function" style="color:rgb(80, 250, 123)">resourceGroup</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'contributor'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">principalId</span><span class="token operator">:</span><span class="token plain"> uami</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">properties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">principalId</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">principalType</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'ServicePrincipal'</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">roleDefinitionId</span><span class="token operator">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">resourceId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.Authorization/roleDefinitions'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'b24988ac-6180-42a0-ab88-20f7382dd24c'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Contributor</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">scope</span><span class="token operator">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">resourceGroup</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Assign the Storage Blob Data Reader role to the managed identity at the resource group scope</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> uamiblobassignment </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.Authorization/roleAssignments@2022-04-01'</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">guid</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token function" style="color:rgb(80, 250, 123)">resourceGroup</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'blobreader'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">principalId</span><span class="token operator">:</span><span class="token plain"> uami</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">properties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">principalId</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">principalType</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'ServicePrincipal'</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">roleDefinitionId</span><span class="token operator">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">resourceId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.Authorization/roleDefinitions'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'2a2b9908-6ea1-4ae2-8e65-a410df84e7d1'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Storage Blob Data Reader</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">scope</span><span class="token operator">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">resourceGroup</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Create an image in the Compute Gallery</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> azImage </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.Compute/galleries/images@2022-03-03'</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">'</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">azComputeGallery</span><span class="token interpolated-string interpolation expression punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token interpolated-string interpolation expression">name</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">/myImage'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">location</span><span class="token operator">:</span><span class="token plain"> location</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">description</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'myImage'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">osType</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Windows'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">osState</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Generalized'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">hyperVGeneration</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'V2'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">identifier</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">publisher</span><span class="token operator">:</span><span class="token plain"> vmOfferDetails</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">publisher</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">offer</span><span class="token operator">:</span><span class="token plain"> vmOfferDetails</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">offer</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">sku</span><span class="token operator">:</span><span class="token plain"> vmOfferDetails</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">sku</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">dependsOn</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    uami</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Create an image template</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> azImageTemplate </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.VirtualMachineImages/imageTemplates@2022-07-01'</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> imagetemplatename</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">location</span><span class="token operator">:</span><span class="token plain"> location</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">identity</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'UserAssigned'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">userAssignedIdentities</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">'</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">uami</span><span class="token interpolated-string interpolation expression punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token interpolated-string interpolation expression">id</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">'</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">buildTimeoutInMinutes</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">360</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">distribute</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'SharedImage'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">galleryImageId</span><span class="token operator">:</span><span class="token plain"> azImage</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">id</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">runOutputName</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'myImageTemplateRunOutput'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">replicationRegions</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token string" style="color:rgb(255, 121, 198)">'Australia East'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">source</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'PlatformImage'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">publisher</span><span class="token operator">:</span><span class="token plain"> vmOfferDetails</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">publisher</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">offer</span><span class="token operator">:</span><span class="token plain"> vmOfferDetails</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">offer</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">sku</span><span class="token operator">:</span><span class="token plain"> vmOfferDetails</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">sku</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">version</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'latest'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">customize</span><span class="token operator">:</span><span class="token plain"> customizationsModule</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">outputs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">customizationsOutput</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">vmProfile</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">vmSize</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Standard_D4ds_v5'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">osDiskSizeGB</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Leave size as source image size.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">optimize</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">vmBoot</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">state</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Enabled'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="storageaccountbicep">storageaccount.bicep<a href="https://luke.geek.nz/azure/Azure-Image-Builder-Build-Pipeline-with-Azure-DevOps/#storageaccountbicep" class="hash-link" aria-label="Direct link to storageaccount.bicep" title="Direct link to storageaccount.bicep">‚Äã</a></h3>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">storageaccount.bicep</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// Define the location parameter for all resources</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token decorator">@description</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'Location for all resources.'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> location </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">resourceGroup</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">location</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Define the parameter for the Storage account name</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token decorator">@description</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'The name of the Storage account.'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> stgaccountname </span><span class="token datatype class-name">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Define the parameter for the public access setting of the Storage account</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token decorator">@description</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'Sets the public access of the storage account.'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> publicaccess </span><span class="token datatype class-name">bool</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Create a Storage account</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> storgeaccount </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.Storage/storageAccounts@2023-01-01'</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">toLower</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">stgaccountname</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Convert the Storage account name to lowercase</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">location</span><span class="token operator">:</span><span class="token plain"> location </span><span class="token comment" style="color:rgb(98, 114, 164)">// Set the location of the Storage account</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">kind</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'StorageV2'</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Use the 'StorageV2' kind</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">sku</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Standard_LRS'</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Use the 'Standard_LRS' SKU</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">accessTier</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Hot'</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Set the access tier to 'Hot'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">allowBlobPublicAccess</span><span class="token operator">:</span><span class="token plain"> publicaccess </span><span class="token comment" style="color:rgb(98, 114, 164)">// Set the public access setting</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Create a Blob service for the Storage account</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> blobService </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.Storage/storageAccounts/blobServices@2022-09-01'</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">parent</span><span class="token operator">:</span><span class="token plain"> storgeaccount </span><span class="token comment" style="color:rgb(98, 114, 164)">// Set the parent resource to the Storage account</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'default'</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Use the 'default' name</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">isVersioningEnabled</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Enable versioning</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Create a container in the Blob service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> appcontainer </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.Storage/storageAccounts/blobServices/containers@2022-09-01'</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'iac'</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Set the container name to 'iac'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">parent</span><span class="token operator">:</span><span class="token plain"> blobService </span><span class="token comment" style="color:rgb(98, 114, 164)">// Set the parent resource to the Blob service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">publicAccess</span><span class="token operator">:</span><span class="token plain"> publicaccess </span><span class="token operator">?</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Blob'</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'None'</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Set the public access setting</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Output the ID of the Storage account</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">output</span><span class="token plain"> storgeaccountid </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> storgeaccount</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">id</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Output the name of the Storage account</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">output</span><span class="token plain"> storgeaccountname </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> storgeaccount</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Output the name of the container</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">output</span><span class="token plain"> containername </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> appcontainer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">name</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="customizationsbicep">customizations.bicep<a href="https://luke.geek.nz/azure/Azure-Image-Builder-Build-Pipeline-with-Azure-DevOps/#customizationsbicep" class="hash-link" aria-label="Direct link to customizations.bicep" title="Direct link to customizations.bicep">‚Äã</a></h3>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">customizations.bicep</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// Define the parameter for the Storage account name</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token decorator">@description</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'The name of the Storage account.'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> stgaccountname </span><span class="token datatype class-name">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Get the environment-specific metadata</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="token plain"> environmentMetadata </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">environment</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Define the customizations for the image</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="token plain"> customizations </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// Create a apps directory on the OS drive</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'PowerShell'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Create Apps Directory on OS drive'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">runElevated</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">runAsSystem</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">inline</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)">// Use double backslashes to represent a single backslash in the file path</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token string" style="color:rgb(255, 121, 198)">'New-Item -ItemType Directory -Force -Path $env:SystemDrive\\apps\\'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// Set the timezone to New Zealand Standard Time</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'PowerShell'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Set Timezone - New Zealand Standard Time'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">runElevated</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">runAsSystem</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">inline</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token string" style="color:rgb(255, 121, 198)">'Set-TimeZone -Id "New Zealand Standard Time"'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// Install Windows updates, excluding preview updates</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'WindowsUpdate'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">searchCriteria</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'IsInstalled=0'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">filters</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token string" style="color:rgb(255, 121, 198)">'exclude:$_.Title -like \'*Preview*\''</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Exclude preview updates</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token string" style="color:rgb(255, 121, 198)">'include:$true'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">updateLimit</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">20</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// Restart the system after Windows updates have completed</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'WindowsRestart'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">restartCheckCommand</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'write-host \'restarting post Windows Updates\''</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">restartTimeout</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'10m'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// Copy BGInfo from the Storage account to the temporary directory</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'File'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Copy BGInfo from Storage account'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">sourceUri</span><span class="token operator">:</span><span class="token plain"> </span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">'https://</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">stgaccountname</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">.blob.</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">environmentMetadata</span><span class="token interpolated-string interpolation expression punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token interpolated-string interpolation expression">suffixes</span><span class="token interpolated-string interpolation expression punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token interpolated-string interpolation expression">storage</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">/iac/bginfo/BGInfo.zip'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">destination</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'$env:SystemDrive\\apps\\BGInfo.zip'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// Copy Storage Explorer from the Storage account to the temporary directory</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'PowerShell'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Copy Storage Explorer from Storage account'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">runElevated</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">runAsSystem</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">inline</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)">// Use double backslashes to represent a single backslash in the file path</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">'Invoke-RestMethod  https://</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">stgaccountname</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">.blob.</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">environmentMetadata</span><span class="token interpolated-string interpolation expression punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token interpolated-string interpolation expression">suffixes</span><span class="token interpolated-string interpolation expression punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token interpolated-string interpolation expression">storage</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">/iac/storageexplorer/StorageExplorer-windows-x64.exe -OutFile  $env:SystemDrive\\apps\\StorageExplorer-windows-x64.exe'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// Extract BGInfo</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'PowerShell'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Extract BGInfo'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">runElevated</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">runAsSystem</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">inline</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)">// Use double backslashes to represent a single backslash in the file path</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token string" style="color:rgb(255, 121, 198)">'Expand-Archive -LiteralPath $env:SystemDrive\\apps\\BGInfo.zip -DestinationPath $env:SystemDrive\\apps\\'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// Install Storage Explorer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'PowerShell'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Install Storage Explorer'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">runElevated</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">runAsSystem</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">inline</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)">// Use double backslashes to represent a single backslash in the file path</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)">// Check if the executable file exists</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">'$exePath = "$env:SystemDrive\\apps\\StorageExplorer-windows-x64.exe"'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">'if (Test-Path $exePath) {'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">'  &amp; $exePath /VERYSILENT /SUPPRESSMSGBOXES /NORESTART /ALLUSERS'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">'} else {'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">'  Write-Output "The file $exePath does not exist."'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">'}'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   </span><span class="token comment" style="color:rgb(98, 114, 164)">// Install any Windows updates, that are left or needed after app installs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'WindowsUpdate'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">searchCriteria</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'IsInstalled=0'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">filters</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token string" style="color:rgb(255, 121, 198)">'exclude:$_.Title -like \'*Preview*\''</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Exclude preview updates</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token string" style="color:rgb(255, 121, 198)">'include:$true'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">updateLimit</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">20</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// Restart the system after Windows updates have completed and fresh restart before sysprep.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'WindowsRestart'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">restartCheckCommand</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'write-host \'restarting post image customisation\''</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">restartTimeout</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'10m'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Output the customizations array</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">output</span><span class="token plain"> customizationsOutput </span><span class="token datatype class-name">array</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> customizations</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="azure-pipelinesyml">azure-pipelines.yml<a href="https://luke.geek.nz/azure/Azure-Image-Builder-Build-Pipeline-with-Azure-DevOps/#azure-pipelinesyml" class="hash-link" aria-label="Direct link to azure-pipelines.yml" title="Direct link to azure-pipelines.yml">‚Äã</a></h3>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">azure-pipelines.yml</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Define the pipeline name and trigger</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Azure Image Builder </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> Build and Publish Image Template</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">trigger</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Define pipeline variables</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">variables</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">serviceconnection</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> azserviceconnections</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">overwrite</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Define the VM image for the pipeline</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">pool</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">vmImage</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Define the stages of the pipeline</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">stages</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># First stage: Deploy Azure Storage Account</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">stage</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ImageBuilderDeploy</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">jobs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">deployment</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Bicepstgaccount</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Deploy Azure Storage Account to Azure for Apps'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">environment</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'AzureDeployment'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">strategy</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">runOnce</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">deploy</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">checkout</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> self</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">           </span><span class="token comment" style="color:rgb(98, 114, 164)"># Deploy the Bicep template for the Azure Storage account</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> AzureCLI@2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Deploy Bicep - Azure Storage account and IaC App Container'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token key atrule">azureSubscription</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> $(serviceconnection) </span><span class="token comment" style="color:rgb(98, 114, 164)"># replace with your service connection name</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token key atrule">scriptType</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'pscore'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token key atrule">scriptLocation</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'inlineScript'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token scalar string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                az group create --name $(ResourceGroupName) --location $(location) </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                az deployment group create `</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                        --template-file $(Build.SourcesDirectory)/iac/storageaccount.bicep `</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                        --resource-group $(resourceGroupName) `</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                        --parameters location=$(location) stgaccountname=$(storageaccountname) publicaccess=true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token comment" style="color:rgb(98, 114, 164)"># Copy the app install files to the Azure Storage account</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> AzureCLI@2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Copy App install files to Azure Storage Account'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token key atrule">azureSubscription</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> $(serviceconnection)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token key atrule">scriptType</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'bash'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token key atrule">scriptLocation</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'inlineScript'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token scalar string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                az storage blob upload-batch -d 'iac' --account-name $(storageaccountname) -s $(Build.SourcesDirectory)/apps --type block --overwrite $(overwrite) --verbose</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                blobs=$(az storage blob list --account-name $(storageaccountname) --container-name 'iac' --query '[].{name:name, url:properties.url}' -o tsv)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                echo $blobs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Second job: Deploy Azure Image Builder Infrastructure</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">job</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ImageBuilderDeployment</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">dependsOn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Bicepstgaccount</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Deploy Azure Image Builder Infrastructure'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     </span><span class="token comment" style="color:rgb(98, 114, 164)"># Build the Azure Image Builder template</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> AzureCLI@2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">' Build Azure Image Builder Template'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">azureSubscription</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> $(serviceconnection) </span><span class="token comment" style="color:rgb(98, 114, 164)"># replace with your service connection name</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">scriptType</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'pscore'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">scriptLocation</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'inlineScript'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token scalar string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            az group create --name $(ResourceGroupName) --location $(location) </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            az deployment group create `</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                    --template-file $(Build.SourcesDirectory)/iac/main.bicep `</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                    --resource-group $(resourceGroupName) `</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                    --parameters location=$(location) imagetemplatename=$(imagetemplatename) stgaccountname=$(storageaccountname) # Add more parameters as needed</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Second stage: Run Azure Image Builder Template Build</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">stage</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ImageBuilderRun</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">jobs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">job</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ImageBuilderRun</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Run Azure Image Builder Template Build'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)"># Run the Azure Image Builder</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> AzureCLI@2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Run Azure Image Builder'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">azureSubscription</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> $(serviceconnection) </span><span class="token comment" style="color:rgb(98, 114, 164)"># replace with your service connection name</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">scriptType</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'pscore'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">scriptLocation</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'inlineScript'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token scalar string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            az image builder run -n $(imagetemplatename) -g $(resourceGroupName) --no-wait --verbose</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                        az image builder wait -n $(imagetemplatename) -g $(resourceGroupName) --custom "lastRunStatus.runState!='Running'" --verbose</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> AzureCLI@2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Deploy Bicep - Set Azure Storage account public access to false'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token key atrule">azureSubscription</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> $(serviceconnection) </span><span class="token comment" style="color:rgb(98, 114, 164)"># replace with your service connection name</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token key atrule">scriptType</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'pscore'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token key atrule">scriptLocation</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'inlineScript'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token scalar string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                az group create --name $(ResourceGroupName) --location $(location) </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                az deployment group create `</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                        --template-file $(Build.SourcesDirectory)/iac/storageaccount.bicep `</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                        --resource-group $(resourceGroupName) `</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                        --parameters location=$(location) stgaccountname=$(storageaccountname) publicaccess=false</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content>
        <author>
            <name>Luke Murray</name>
            <uri>https://luke.geek.nz</uri>
        </author>
        <category label="Azure" term="Azure"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Book Review Azure Architecture Explained]]></title>
        <id>https://luke.geek.nz/azure/misc/Book-Review-Azure-architecture-explained/</id>
        <link href="https://luke.geek.nz/azure/misc/Book-Review-Azure-architecture-explained/"/>
        <updated>2023-11-18T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Book review of Azure Architecture Explained: A comprehensive guide to building effective cloud solutions]]></summary>
        <content type="html"><![CDATA[<p>Book review of <a href="https://www.packtpub.com/product/azure-architecture-explained/9781837634811" target="_blank" rel="noopener noreferrer">Azure Architecture Explained: A comprehensive guide to building effective cloud solutions</a></p>
<blockquote>
<p>Disclaimer: This is the first book review I have ever done, and this review is entirely my opinion and may not fully reflect the value you may or may not get from this book. Everyone will have their unique viewpoint and priorities of what they want out of a book, so please take my review as an opinionated view from my own viewpoint; I am, of course, happy to discuss different points of view and discussions on this page comments. We are all here to learn something!</p>
</blockquote>
<p>Book synopsis:</p>
<blockquote>
<p>"Azure is a sophisticated technology that requires a detailed understanding to reap its full potential and employ its advanced features. This book provides you with a clear path to designing optimal cloud-based solutions in Azure by delving into the platform's intricacies.
You‚Äôll begin by understanding the effective and efficient security management and operation techniques in Azure to implement the appropriate configurations in Microsoft Entra ID. Next, you‚Äôll explore how to modernize your applications for the cloud, examining the different computation and storage options, as well as using Azure data solutions to help migrate and monitor workloads. You‚Äôll also learn how to build your solutions, including containers, networking components, security principles, governance, and advanced observability. With practical examples and step-by-step instructions, you can work on infrastructure-as-code to effectively deploy and manage resources in your environment."</p>
</blockquote>
<p><img decoding="async" loading="lazy" alt="Azure Architecture Explained" src="https://luke.geek.nz/assets/images/Review_AzureArchitectureExplained_TitleBoat-87d96784f7133dd30567a910da6ceeba.jpg" width="1536" height="2040" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a href="https://luke.geek.nz/azure/misc/Book-Review-Azure-architecture-explained/#introduction" class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction">‚Äã</a></h2>
<p><a href="https://www.packtpub.com/product/azure-architecture-explained/9781837634811" target="_blank" rel="noopener noreferrer">Azure Architecture Explained</a> is a Packtpub published (in September 2023) book written by the following authors:</p>
<ul>
<li><a href="https://www.linkedin.com/in/daverndn/" target="_blank" rel="noopener noreferrer">David Rend√≥n</a></li>
<li><a href="https://www.linkedin.com/in/bretthargreaves/" target="_blank" rel="noopener noreferrer">Brett Hargreaves</a></li>
</ul>
<p>Forward by <a href="https://www.linkedin.com/in/konger/" target="_blank" rel="noopener noreferrer">Sarah Kong</a></p>
<blockquote>
<p>Although this book was given to me to review (for free, I have no formal relationship with either Packetpub, although I thank them for allowing me to review this book or the Authors, and I am reviewing this book from an entirely independent view), as someone who architects and builds Azure solutions, this is the type of book, I usually would read, based on the title and synopsis, so let us take under the cover...</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview-of-azure-architecture">Overview of Azure Architecture<a href="https://luke.geek.nz/azure/misc/Book-Review-Azure-architecture-explained/#overview-of-azure-architecture" class="hash-link" aria-label="Direct link to Overview of Azure Architecture" title="Direct link to Overview of Azure Architecture">‚Äã</a></h2>
<p>The book's slogan is "A <strong>comprehensive</strong> guide to <strong>building</strong> effective cloud solutions".</p>
<blockquote>
<p>Architecting solutions in Azure is a <strong>massive</strong> subject, requiring knowledge about the details of specific services, knowledge and understanding of <strong>Cloud adoption</strong>, <strong>well-architected frameworks</strong>, <strong>patterns and practices</strong> and <strong>interoperability</strong> between different services and systems, if one were to use this slogan and book title, I would expect the book to cover across all these areas.</p>
</blockquote>
<p><img decoding="async" loading="lazy" alt="Azure Architecture Book - Courtesy of Bing Image Creator" src="https://luke.geek.nz/assets/images/AzureBook_AzureArchitectureExplained_AIGenerated-5c503416bccc30fb7cafed69a46dad43.jpg" width="1024" height="1024" class="img_ev3q"></p>
<p>So let us look to see if the book meets these details...</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cloud-adoption">Cloud Adoption<a href="https://luke.geek.nz/azure/misc/Book-Review-Azure-architecture-explained/#cloud-adoption" class="hash-link" aria-label="Direct link to Cloud Adoption" title="Direct link to Cloud Adoption">‚Äã</a></h3>
<p>The book includes a section on the Microsoft Cloud Adoption Framework, including links, diagrams and explanations of how the Cloud Adoption framework fits in - not only with Microsoft Azure (which is the focus of this book) but with other Clouds as well!</p>
<p><strong>What I liked about the representation of the <a href="https://learn.microsoft.com/azure/cloud-adoption-framework/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Cloud Adoption</a> within this book was - it was enough for a beginner and intermediate in Cloud adoption, to get going - without the need for third-party resources (i.e. resources outside of this book), but for those after a bit more advanced information or detail - supplied the relevant internet links, to the relevant Microsoft Learn resources <em>(in short format, i.e. bit.ly - so easily can be copied from a hard covered paper book into your browser)</em>, so the authors didn't try to shove a lot of unnecessary detail into the book, but was to the point, as they started the journey into Cloud governance and covered the basics and knowledge at an intermediate level, without a lot of the detail, that you don't necessarily need as part of the book.</strong></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="well-architected-framework">Well-Architected Framework<a href="https://luke.geek.nz/azure/misc/Book-Review-Azure-architecture-explained/#well-architected-framework" class="hash-link" aria-label="Direct link to Well-Architected Framework" title="Direct link to Well-Architected Framework">‚Äã</a></h3>
<p>In terms of the Well-Architected framework, however, there needed to be more direct representation, which surprised me, as although the Cloud Adoption Framework guides the Cloud adoption journey, the Well-Architected Framework focuses more on helping you make informed decisions for building systems in These frameworks can work side by side - HOWEVER, having said that...</p>
<p>The Microsoft Well-Architected Framework consists of 5 pillars, these are:</p>
<ul>
<li>Performance Efficiency</li>
<li>Reliability</li>
<li>Security</li>
<li>Cost Optimization</li>
<li>Operational Excellence</li>
</ul>
<p>Underneath these pillars are design principles, such as design for business requirements, design for resiliency, design for recovery, etc.</p>
<p>These design principles were woven throughout the implementation portions of the books and, although not directly called out in some areas, had high-level representation that you can subtly pick up.</p>
<p><strong>I believe, reading the <a href="https://learn.microsoft.com/azure/cloud-adoption-framework/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Cloud Adoption</a> and <a href="https://learn.microsoft.com/azure/well-architected/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Well-Architected Frameworks</a>, directly on the Microsoft Learn website, can help supplement your understanding of this book, and some of the decisions made by the authors.</strong></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="patterns-and-practices">Patterns and practices<a href="https://luke.geek.nz/azure/misc/Book-Review-Azure-architecture-explained/#patterns-and-practices" class="hash-link" aria-label="Direct link to Patterns and practices" title="Direct link to Patterns and practices">‚Äã</a></h3>
<p>Let us look at a particular part of the book; my example is the 'Making the Most of the Infrastructure-as-Code for Azure' section.</p>
<p>When I talk about patterns and practices, I am thinking of 2 things:</p>
<ol>
<li>Does a Pattern provide a prescribed solution to a problem?</li>
<li>Does a Practice provide an established method or way of working?</li>
</ol>
<blockquote>
<p>"Infrastructure-as-code enables organizations to define and manage their infrastructure and application resources in a programmatic and automated manner. Developers and operations teams can use configuration files or scripts to describe their desired Azure infrastructure and deploy it consistently and reliably. This part will discuss how infrastructure-as-code in Azure empowers organizations to optimize their cloud infrastructure, increase productivity, and drive successful digital transformations."</p>
</blockquote>
<p>This particular part included Chapters such as:</p>
<ul>
<li>Governance in Azure</li>
<li>Building Solutions using Azure Bicep</li>
<li>Using Azure Pipelines to Build your Infrastructure in Azure</li>
<li>Continous integration and deployment using Azure DevOps
and Tips from the Field!</li>
</ul>
<p>Instead of jumping straight into the build, the authors take the time to explain Azure governance by following the premise of a hypothetical company and that company challenges, and then working on the previous parts of the work, where the authors had done a very prescriptive <em>(great)</em> job of the management and creation of relevant Azure resources using the Azure Portal and explain the business challenges that Infrastructure as Code helps with, before jumping into the authoring, management and implementation of Azure Bicep for Infrastructure as Code.</p>
<p><strong>Patterns and practices, in my opinion, are where this build shone through and where the true value is are the Patterns and practices. Throughout this book, the authors explain the WHY and WHAT before presenting the HOW. It was straightforward to follow and build upon what was learnt and discovered from previous chapters.</strong></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="interoperability">Interoperability<a href="https://luke.geek.nz/azure/misc/Book-Review-Azure-architecture-explained/#interoperability" class="hash-link" aria-label="Direct link to Interoperability" title="Direct link to Interoperability">‚Äã</a></h3>
<p>Interoperability is always very hard to review - the definition of interoperability I am using is <em>"the ability of computer systems or software to exchange and make use of information."</em> Commonly, how <em>systems work together</em>. In the complex world we live in, systems being able to talk to other systems made by other third-party vendors and individuals can be key to successful business outcomes so that it can be a very technically driven area.</p>
<p>This is hard to review when discussing a book-related specifically to Azure architecture <em>(i.e., this is not a book about connecting Azure services to AWS, etc.)</em>.</p>
<p><img decoding="async" loading="lazy" alt="Azure Architecture Book - Courtesy of Bing Image Creator" src="https://luke.geek.nz/assets/images/AzureBook_AzureArchitectureExplained_AIGenerated_Interopability-054e908ee0b1b59d2680a383f882f9bb.jpg" width="1024" height="1024" class="img_ev3q"></p>
<p>However, interoperability is a key area for a topic such as Entra ID, to which this book has entire chapters dedicated.</p>
<p>This book has all the problems that all books have! Information Technology changes so rapidly that there's a potential risk that the book you just purchased may be out of date.
For context, this book was published in September of 2023 <em>(22 Sept 2023)</em>, which would mean a lot of writing and work, then peer-review, assuming both from a technical standpoint and writing standpoint, after the authors initial 'pre-prod' draft, before it reaches the public. In mid-July of 2023 <em>(11 July 2023)</em> Microsoft announced a rename of Azure Active Directory to Entra ID. There was mention of the rename, but Azure AD was still used in certain areas of the book.</p>
<p>In the context of this book, Entra ID is referred to by its previous name, Azure Active Directory; as a reader who is aware of that rename, it was still incredibly easy to read and follow.</p>
<p>The book explains user identities, the differences between authentication and authorization <em>(Which I loved!)</em> and how Azure Active Directory <em>(i.e. Entrea ID)</em> can be used to integrate and secure applications and work alongside the rest of the Microsoft Entra ID suite of products, all within the context of a fictitious company, allowing you to follow on.</p>
<p><strong>Overall, I believe the interoperability portions of Identity in this book are first class, from the creation of your first tenancy to Role Based Access to Azure resources; the authors do a great job in explaining how identity underpins the platforms and enables connectivity and access to multiple services, that even a beginner can get going quickly, with knowing WHY they are doing the stuff, that the book asks of them!</strong></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="content-and-coverage">Content and Coverage<a href="https://luke.geek.nz/azure/misc/Book-Review-Azure-architecture-explained/#content-and-coverage" class="hash-link" aria-label="Direct link to Content and Coverage" title="Direct link to Content and Coverage">‚Äã</a></h2>
<p>When considering Content and Coverage, my main concern here is:</p>
<ul>
<li>Is the content in this book actually 'actionable'?</li>
<li>Can I use what I learn in this book in real-world scenarios, or is it entirely hypothetical?</li>
</ul>
<p>I am pleased to say <strong>Yes</strong> to this book; it is both actionable and useful in the real world! I was pleasantly surprised by this!</p>
<p>Architecture can be a very <em>dry</em> subject, and there are so many ways you can approach it, for example:</p>





















































<table><thead><tr><th>Architect Type</th><th>Focus Area</th></tr></thead><tbody><tr><td><strong>System Architect</strong></td><td>Design and structure of individual systems or applications.</td></tr><tr><td><strong>Enterprise Architect</strong></td><td>Aligning IT strategy with overall business strategy.</td></tr><tr><td><strong>Solution Architect</strong></td><td>Designing solutions that meet specific project requirements.</td></tr><tr><td><strong>Data Architect</strong></td><td>Designing and managing an organization's data architecture.</td></tr><tr><td><strong>Application Architect</strong></td><td>Designing the structure and interaction of applications.</td></tr><tr><td><strong>Network Architect</strong></td><td>Designing and implementing computer networks.</td></tr><tr><td><strong>Security Architect</strong></td><td>Designing and implementing security measures and controls.</td></tr><tr><td><strong>Cloud Architect</strong></td><td>Designing and implementing cloud infrastructure solutions.</td></tr><tr><td><strong>Infrastructure Architect</strong></td><td>Designing and managing IT infrastructure components.</td></tr><tr><td><strong>Integration Architect</strong></td><td>Ensuring seamless integration between different systems.</td></tr><tr><td><strong>Business Architect</strong></td><td>Aligning business processes and IT strategy.</td></tr></tbody></table>
<p><img decoding="async" loading="lazy" alt="Azure Architects - Courtesy of Bing Image Creator" src="https://luke.geek.nz/assets/images/AzureBook_AzureArchitectureExplained_AIGenerated_Architects-ffccadb8a11b85f535d73c75d06c264f.jpg" width="1024" height="1024" class="img_ev3q"></p>
<p><strong>When I look at this book, I am looking at it from a mix of Cloud, Solution and Infrastructure architecture, mainly due to my own personal journey, and this is where I feel the book fits.</strong></p>
<p>When I look at the slogan of the book again, and the word <strong>comprehensive</strong> is used, I believe this is used accurately; the authors did a great book in discussing the WHY, WHAT and HOW of various solutions in the Networking section of this book, the authors covered design considerations for VNET <em>(Virtual Networks)</em>, before delving into more advanced topics, such as Network Security and Azure Virtual Virtual WAN, bringing you on the journey that you would take in real life.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="clarity-and-accessibility">Clarity and Accessibility<a href="https://luke.geek.nz/azure/misc/Book-Review-Azure-architecture-explained/#clarity-and-accessibility" class="hash-link" aria-label="Direct link to Clarity and Accessibility" title="Direct link to Clarity and Accessibility">‚Äã</a></h2>
<p><strong>The authors did a very clear job of explaining, from start to finish, how to create the necessary Azure resources and why you should have created them in the first place. This was very well done. In just about all sections, the words were supplemented with images and diagrams, making it easier to further understand what was happening in the text. Any links to internet websites were done as short links, making it very easy to copy and navigate to, whether you have a physical copy of the book or a digital copy.</strong></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="hands-on-exercises-and-tutorials">Hands-On Exercises and Tutorials<a href="https://luke.geek.nz/azure/misc/Book-Review-Azure-architecture-explained/#hands-on-exercises-and-tutorials" class="hash-link" aria-label="Direct link to Hands-On Exercises and Tutorials" title="Direct link to Hands-On Exercises and Tutorials">‚Äã</a></h2>
<p><strong>This book contained valid hands-on exercises and tutorials, allowing you to follow along with the content.</strong></p>
<p>Sample code and exercise files were also provided publically on GitHub <a href="https://github.com/PacktPublishing/Azure-Architecture-Explained" target="_blank" rel="noopener noreferrer">PacktPublishing/Azure-Architecture-Explained</a> and <a href="https://github.com/daveRendon/azinsider" target="_blank" rel="noopener noreferrer">daveRendon/azinsider</a>, allowing readers, to easily fork and get a copy of the code required for the relevant exercises, such as creating resources, such as an Azure Virtual Network with Bicep.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="updates-and-relevance">Updates and Relevance<a href="https://luke.geek.nz/azure/misc/Book-Review-Azure-architecture-explained/#updates-and-relevance" class="hash-link" aria-label="Direct link to Updates and Relevance" title="Direct link to Updates and Relevance">‚Äã</a></h2>
<p>At the time of this review (November 2023), this book (published in September 2023) is still entirely relevant; as mentioned earlier, there have been some renames of products from Microsoft that are a 'gotcha' to know, as part of reading this book, but the theory and implementation steps are entirely relevant.</p>
<p>I came across one link to a website <a href="https://cafbaseline.com/" target="_blank" rel="noopener noreferrer">cafbaseline.com</a> that was not available at the time of reading, but all other links I used were relevant and working!</p>
<p><strong>As with all books, if you come across this book 2-3 years down the track <em>(i.e. 2025/2026)</em> make sure you check the publishing date and version and make sure there's not a renewer version of this book! This is a book I personally would love to see various revisions and updates to as the world of Microsoft Azure changes!</strong></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="authors-expertise">Author's Expertise<a href="https://luke.geek.nz/azure/misc/Book-Review-Azure-architecture-explained/#authors-expertise" class="hash-link" aria-label="Direct link to Author's Expertise" title="Direct link to Author's Expertise">‚Äã</a></h2>
<p>I believe the authors have the correct expertise to make this book viable <em>(and based on my own knowledge, reading this book)</em> and accurate.</p>
<ul>
<li><a href="https://www.linkedin.com/in/daverndn/" target="_blank" rel="noopener noreferrer">David Rend√≥n</a> is a Microsoft MVP (Most Valuable Professional) and MCT (Microsoft Certified Trainer); these awards themselves require technical validation, and the display of knowledge to help solve organisation problems, and as an MCT, David, has the experience to explain the concepts, in a way that could be easily understood as a beginner.</li>
<li><a href="https://www.linkedin.com/in/bretthargreaves/" target="_blank" rel="noopener noreferrer">Brett Hargreaves</a> as a current Cloud Practice Lead, with certifications, such as the Azure Solutions Architect Expert and a background in Architect, Brett has the practical know-how to help make this content relevant, to those looking to Architect solutions in Microsoft Azure.</li>
</ul>
<p><strong>It is my opinion that this duo is indeed suited to write this type of book, and this can be seen from the actionable and valid output of the book itself.</strong></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://luke.geek.nz/azure/misc/Book-Review-Azure-architecture-explained/#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">‚Äã</a></h2>
<p><strong>Azure Architecture Explained is a book containing 409 pages of actionable content.</strong></p>
<p>The authors draw on their extensive experience and research to provide practical patterns and practices, to help build on the story of starting from scratch, understanding the <em>big picture</em> of how complex systems within the Azure ecosystem sit together, with the advice actually to get started and create and modify those resources.</p>
<p>The book is well-structured and full of relevant examples and exercises.</p>
<blockquote>
<p><strong>I highly recommend this book to anyone interested in architecting solutions across Microsoft Azure, and it was very easy to read and consume the content! I feel smarter, having read it. Thank you to the authors for making the effort to write and release this book. It is a good addition to my library of books that I will be referencing in the future! I read this book on a Cruise while relaxing, and it didn't feel like I was doing work!</strong></p>
</blockquote>]]></content>
        <author>
            <name>Luke Murray</name>
            <uri>https://luke.geek.nz</uri>
        </author>
        <category label="Azure" term="Azure"/>
        <category label="Misc" term="Misc"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Mastering CIDRs With Azure Bicep]]></title>
        <id>https://luke.geek.nz/azure/Working-with-CIDR-Azure-Bicep/</id>
        <link href="https://luke.geek.nz/azure/Working-with-CIDR-Azure-Bicep/"/>
        <updated>2023-11-18T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Classless Inter-Domain Routing (CIDR) is a method of allocating IP addresses and routing Internet Protocol (IP) packets.]]></summary>
        <content type="html"><![CDATA[<p><a href="https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing" target="_blank" rel="noopener noreferrer">Classless Inter-Domain Routing</a> <em>(CIDR)</em> is a method of allocating IP addresses and routing Internet Protocol <em>(IP)</em> packets.</p>
<p><img decoding="async" loading="lazy" alt="Mastering CIDRs With Azure Bicep" src="https://luke.geek.nz/assets/images/BlogHeading_Mastering-CIDRs-with-Azure-Bicep-66efb8cdacf85d6baa1b1350ac084e9a.gif" width="1200" height="628" class="img_ev3q"></p>
<p>This article includes sample Bicep functions for working with CIDR, for Azure Virtual Network and Subnet creation.</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">CiDR.bicep</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// This function parses the CIDR notation and returns an object with the network address, subnet mask, and other details.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">output</span><span class="token plain"> v6addressspace </span><span class="token datatype class-name">object</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">parseCidr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'2001:db8:1234::/48'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// This function generates an array of subnets within the specified CIDR block. The subnet size is 64, and the index calculates the subnet.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// The 'range(0, 5)' function generates an array of numbers from 0 to 4. The 'for' loop iterates over these numbers.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// For each number 'i', the 'cidrSubnet' function calculates a subnet within the '2001:db8:1234::/48' CIDR block.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// The subnet size is 64, and 'i' is used as the index. The resulting array contains the calculated subnets.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">output</span><span class="token plain"> v6subnets </span><span class="token datatype class-name">array</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> i </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">in</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">range</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">5</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">cidrSubnet</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'2001:db8:1234::/48'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">64</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// This function generates an array of host addresses within the specified CIDR block. The index is used to calculate the host address.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// Similar to the 'v6subnets' array, the 'range(0, 5)' function generates an array of numbers from 0 to 4.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// For each number 'i', the 'cidrHost' function calculates a host address within the '2001:db8:1234::/48' CIDR block.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// The resulting array contains the calculated host addresses.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">output</span><span class="token plain"> v6hosts </span><span class="token datatype class-name">array</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> i </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">in</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">range</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">5</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">cidrHost</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'2001:db8:1234::/48'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// This function generates a string within the specified CIDR block. The host index is always 3 (Azure Reserved).</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// The 'cidrHost' function calculates a host address within the '2001:db8:1234::/48' CIDR block.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// The host index is '0 + 3', which is 3. This is because the first three addresses in a subnet are reserved in Azure.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">output</span><span class="token plain"> v6hostsazure </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">cidrHost</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'2001:db8:1234::/48'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> </span><span class="token number">3</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>References:</p>
<ul>
<li><a href="https://luke.geek.nz/azure/IPv6-on-Azure/" target="_blank" rel="noopener noreferrer">IPv6 in Microsoft Azure</a></li>
<li><a href="https://learn.microsoft.com/en-us/azure/azure-resource-manager/bicep/bicep-functions-cidr?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">CIDR functions for Bicep</a></li>
<li><a href="https://github.com/Azure/bicep/issues/3975" target="_blank" rel="noopener noreferrer">CIDR math functions for Azure Networking calculations #3975</a></li>
</ul>]]></content>
        <author>
            <name>Luke Murray</name>
            <uri>https://luke.geek.nz</uri>
        </author>
        <category label="Azure" term="Azure"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[IPv6 in Microsoft Azure]]></title>
        <id>https://luke.geek.nz/azure/IPv6-on-Azure/</id>
        <link href="https://luke.geek.nz/azure/IPv6-on-Azure/"/>
        <updated>2023-11-09T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Take a look at IPv6 support in Microsoft Azure.]]></summary>
        <content type="html"><![CDATA[<p>With more support for IPv6 being added to native Azure products, its time to take a closer look into IPv6 and its use within Azure.</p>
<blockquote>
<p>The <a href="https://en.wikipedia.org/wiki/IPv6_deployment" target="_blank" rel="noopener noreferrer">deployment of IPv6</a>, the latest version of the Internet Protocol (IP), has been in progress since the mid-2000s. IPv6 was designed as the successor protocol for IPv4 with an expanded addressing space. IPv4, which has been in use since 1982, is in the final stages of exhausting its unallocated address space but still carries most Internet traffic.</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="https://luke.geek.nz/azure/IPv6-on-Azure/#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">‚Äã</a></h2>
<blockquote>
<p>Most recently, <a href="https://azure.microsoft.com/en-us/updates/general-availability-gateway-load-balancer-ipv6-support/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Gateway Load Balancer</a> and <a href="https://azure.microsoft.com/en-us/updates/public-preview-application-gateway-now-supports-ipv6-frontend/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Application Gateway</a> has had IPv6 support announced, allowing these services to handle both IPv6 along with IPv4, from client and server.
IPv6 or Internet Protocol Version 6 is an upgrade of IPv4. A network layer protocol allows data communications to pass packets over a network. IPv6 uses 128-bit addressing and supports over 340 trillion trillion devices, a significant improvement over IPv4‚Äôs 32-bit addressing scheme that supports over 4.3 billion devices.</p>
</blockquote>






























<table><thead><tr><th></th><th>IPv4</th><th>IPv6</th></tr></thead><tbody><tr><td>No. of bits on IP Address</td><td>32</td><td>128</td></tr><tr><td>Format</td><td>decimal</td><td>hexadecimal</td></tr><tr><td>Capable of Addresses</td><td>4.3 billion</td><td>infinite number</td></tr><tr><td>How to ping</td><td>&nbsp;ping XXX.XXX.XXX</td><td>ping6</td></tr></tbody></table>
<blockquote>
<p>Azure Virtual Network enables you to host applications in Azure with IPv6 and IPv4 connectivity within a virtual network and to and from the Internet. Due to the exhaustion of public IPv4 addresses, new networks for mobility and the Internet of Things (IoT) are often built on IPv6.
IPv6 provides a larger address space, improved security, and better performance than IPv4. <a href="https://learn.microsoft.com/azure/virtual-network/ip-services/ipv6-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Virtual Network</a> enables you to host applications in Azure with IPv6 and IPv4 connectivity both within a virtual network and to and from the Internet, which is beneficial for expanding the reach of your Azure-hosted applications into the growing mobile and Internet of Things markets</p>
</blockquote>
<blockquote>
<p>IPv6 for Azure virtual network is much more full-featured - enabling full IPv6 solution architectures to be deployed in Azure.</p>
</blockquote>
<p>There are some current <a href="https://learn.microsoft.com/en-us/azure/virtual-network/ip-services/ipv6-overview?WT.mc_id=AZ-MVP-5004796#limitations" target="_blank" rel="noopener noreferrer">limitations</a> to be aware of, such as:</p>
<ul>
<li>VPN gateways currently support IPv4 traffic only, but they can still be deployed in a dual-stacked virtual network using Azure PowerShell and Azure CLI commands only.</li>
<li>IPv6-only Virtual Machines or Virtual Machines Scale Sets aren't supported; each NIC must include at least one IPv4 IP configuration.</li>
<li>ICMPv6 isn't currently supported in Network Security Groups.</li>
<li>Azure Firewall doesn't currently support IPv6. It can operate in a dual-stack virtual network using only IPv4, but the firewall subnet must be IPv4-only.</li>
</ul>
<p>Although still in a transitory period with some services, Microsoft has come some way to enabling IPv6 dual stack (IPv4 and IPv6) services, with <a href="https://learn.microsoft.com/troubleshoot/azure/active-directory/azure-ad-ipv6-support?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Entra ID even supporting</a> running on IPv6, and with US Government mandates like below:</p>
<blockquote>
<p>On November 19, 2020, the United States Office of Management and Budget (OMB) issued the latest U. S. federal government IPv6-only policy in its memorandum (M-21-07) directing all federal government agencies to complete at least 80% of the transition from IPv4 to the single stack of IPv6 by 2025.</p>
</blockquote>
<p>This will be an ever-increasing functionality.</p>
<p>As the world becomes increasingly interconnected, the need for robust and scalable networking solutions has never been greater. IPv6 is the latest version of the Internet Protocol, offering a range of benefits over its predecessor, IPv4.</p>
<p>There are several benefits of using IPv6 over IPv4, including:</p>
<ul>
<li>Larger Address Space: IPv6 uses 128-bit addresses, which provides a much larger address space than IPv4's 32-bit addresses. This means that there are more available addresses, an estimated 340 undecillion addresses, which is essential as the number of devices connected to the internet continues to grow. It was intended to replace&nbsp;IPv4.  <em>(The primary reason for IPv4 address exhaustion is insufficient capacity to design the original Internet infrastructure. The original designers of the network did not anticipate the rapid growth of the internet and the increasing demand for IP addresses.&nbsp;This depletion is one of the reasons for the development and deployment of its successor protocol, IPv6)</em></li>
<li>Improved Security: IPv6 includes built-in security features such as IPsec, which provides end-to-end encryption and authentication. This helps to ensure that data transmitted over the network is secure and protected from unauthorized access. Since IPv4 was already defined, IPsec is bolted on <em>(IPSec packets are payload)</em>, but IPv6 was still being determined, and IPsec is an integral part of IPv6. From the beginning, IPv6 has had the AH and ESP extension headers, something not possible with IPv4.</li>
<li>Better Quality of Service: IPv6 includes features that allow for better quality of service <em>(QoS)</em>, such as flow labelling and traffic classification. This helps ensure that critical applications receive the bandwidth and priority they need to function properly. This is especially important for real-time applications like video conferencing and online gaming.</li>
<li>Future-Proofing: IPv6 supports future technologies and applications, such as the Internet of Things <em>(IoT)</em>, smart homes/farms and cloud computing. By adopting IPv6, organizations can ensure their networks are ready to support these emerging technologies and applications.</li>
</ul>
<p>There is <a href="https://azure.microsoft.com/updates/azure-public-ipv6-offerings-are-free-as-of-july-31/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">no charge to use Public IPv6 addresses or prefixes</a>, in Microsoft Azure, resources and bandwidth on Azure are charged at the same rates as for IPv4.</p>
<p>In addition, Azure provides tools and services for monitoring and managing IPv6 traffic, such as Azure Network Watcher and Azure Traffic Manager. These tools allow you to monitor network traffic with IP flow verification, for example, that checks if packets from IPv6 are allowed or denied and also tells you what security rule allowed or denied the traffic, diagnose issues, and optimize performance, ensuring that your IPv6-enabled applications and services are running smoothly.</p>
<p>If we look at the Internet Society pulse <em>(current as of this article)</em>, 27% of the top 1000 websites globally support IPv6, growing every day.</p>
<p><img decoding="async" loading="lazy" alt="Internet Society Pulse curates information about levels of IPv6 adoption in countries and networks around the world" src="https://luke.geek.nz/assets/images/IPv6Azure_InternetSecurityPulse_Nov2023-4d4cb24ea5c133dd7ba4e169c81261e3.png" width="1553" height="1137" class="img_ev3q"></p>
<p>The transition to IPv6 will take time. While many services and platforms already support IPv6, many still need to, and as more and more devices are connected to the internet, the need for IPv6 will only grow. So, we need to be prepared and start preparation and implementation of IPv6 solutions as soon as possible.</p>
<p>So, when you hear IPv6, always consider the following:</p>
<ol>
<li><strong>Availability</strong>: There is no risk of IPv6 IP exhaustion.</li>
<li><strong>Cost</strong>: IPv6 IPs cost Azure zero dollars. This could be a trigger for customers to choose Azure.</li>
<li><strong>Compliance</strong>: IPv6 mandates are helping governments start their journeys to the cloud.</li>
<li><strong>Network Performance</strong>: NATing (Network Address Translation) adds network latency. IPv6 does not require NATing for cross-region traffic.</li>
</ol>
<p><img decoding="async" loading="lazy" alt="IPv6 Dual Stack Azure Network" src="https://luke.geek.nz/assets/images/ipv6-sample-diagram-91705225eb4451bf084008b5a92b31af.png" width="480" height="387" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="getting-started-with-ipv6-in-azure">Getting Started with IPv6 in Azure<a href="https://luke.geek.nz/azure/IPv6-on-Azure/#getting-started-with-ipv6-in-azure" class="hash-link" aria-label="Direct link to Getting Started with IPv6 in Azure" title="Direct link to Getting Started with IPv6 in Azure">‚Äã</a></h2>
<blockquote>
<p>Azure Virtual WAN currently supports IPv4 traffic only.</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="add-ipv6-address-space-to-an-existing-virtual-network">Add IPv6 address space to an existing Virtual Network<a href="https://luke.geek.nz/azure/IPv6-on-Azure/#add-ipv6-address-space-to-an-existing-virtual-network" class="hash-link" aria-label="Direct link to Add IPv6 address space to an existing Virtual Network" title="Direct link to Add IPv6 address space to an existing Virtual Network">‚Äã</a></h3>
<p>We can add IPV6 ranges to an existing Azure Virtual Network by adding an IPV6 address range and then dual stacking both IPV4 and IPV6 ranges.</p>
<blockquote>
<p>The subnets for IPv6 must be exactly /64 in size. This ensures future compatibility should you decide to enable subnet routing to an on-premises network since some routers can only accept /64 IPv6 routes.
To add IPv6 to existing IPv4 deployments, you can't add IPv6 ranges to a virtual network with existing resource navigation links.</p>
</blockquote>
<p>In my demo, I have a Virtual Network with an IPV4 address space of 10.0.0.0/16 (65,536 addresses)</p>
<p>For my demo purposes, I will add in an IPV6 address space of: 2001:db8üî¢:/48 <em>(1208925819614629174706176 addresses)</em></p>
<p>With two subnets of:</p>
<ul>
<li>2001:db8üî¢:/64 <em>(18446744073709551616 addresses)</em></li>
<li>2001:db8üî¢1::/64 <em>(18446744073709551616)</em></li>
</ul>
<p>Reference: <a href="https://www.cidr.eu/en/calculator" target="_blank" rel="noopener noreferrer">IPV6 Calculator</a></p>
<ol>
<li>Navigate to the <a href="https://portal.azure.com/#home" target="_blank" rel="noopener noreferrer">Azure Portal</a></li>
<li>Navigate to <a href="https://portal.azure.com/#view/HubsExtension/BrowseResource/resourceType/Microsoft.Network%2FvirtualNetworks" target="_blank" rel="noopener noreferrer">Virtual Networks</a></li>
<li>Navigate to the Virtual Network you want to add an IPV6 address range into.</li>
<li>Add in the IPV6 address space, click Save</li>
<li>Once completed, you can add your subnets.</li>
</ol>
<p><img decoding="async" loading="lazy" alt="Add IPV6 Address range to existing Azure Virtual Network" src="https://luke.geek.nz/assets/images/Add_IPV6AddressSpace_AzVirtualNetworkExisting-da545269a6b9b515bc3879fc4f974c01.gif" width="1856" height="955" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="add-ipv6-address-space-to-a-new-existing-virtual-network">Add IPv6 address space to a new existing Virtual Network<a href="https://luke.geek.nz/azure/IPv6-on-Azure/#add-ipv6-address-space-to-a-new-existing-virtual-network" class="hash-link" aria-label="Direct link to Add IPv6 address space to a new existing Virtual Network" title="Direct link to Add IPv6 address space to a new existing Virtual Network">‚Äã</a></h3>
<p>Adding an IPV6 range to a New Virtual Network is reasonably easy using the Portal interface.</p>
<blockquote>
<p>The subnets for IPv6 must be exactly /64 in size. This ensures future compatibility should you decide to enable subnet routing to an on-premises network since some routers can only accept /64 IPv6 routes.</p>
</blockquote>
<ol>
<li>Navigate to the <a href="https://portal.azure.com/#home" target="_blank" rel="noopener noreferrer">Azure Portal</a></li>
<li>Navigate to <a href="https://portal.azure.com/#view/HubsExtension/BrowseResource/resourceType/Microsoft.Network%2FvirtualNetworks" target="_blank" rel="noopener noreferrer">Virtual Networks</a></li>
<li>Click on New Virtual Network</li>
<li>Select a name for your Virtual Network</li>
<li>Select the Region and Resource Group, click Next</li>
<li>Skip the Security pane <em>(unless needed)</em> and click Next</li>
<li>Select the dropdown for  Add Ipv4 address space, and select Add IPv6 address space</li>
</ol>
<p><img decoding="async" loading="lazy" alt="Add IPV6 Address range to new Azure Virtual Network" src="https://luke.geek.nz/assets/images/Add_IPV6AddressSpace_AzVirtualNetworkNew-11121dada7c5b288936295b3f4245ab5.gif" width="1856" height="955" class="img_ev3q"></p>
<p>Azure provides automatic IPv6 address allocation for resources in a Virtual Network. When you enable IPv6 for a Virtual Network, Azure assigns IPv6 addresses to resources like virtual machines and load balancers. Linux and Windows Virtual Machines can all use IPv6 for Azure Virtual Network.</p>
<p>If your Virtual Network is peered, sync the connections so that your peered networks can see the IPv6 resources.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-a-virtual-machine-in-a-ipv6-subnet">Create a Virtual Machine in a IPV6 subnet<a href="https://luke.geek.nz/azure/IPv6-on-Azure/#create-a-virtual-machine-in-a-ipv6-subnet" class="hash-link" aria-label="Direct link to Create a Virtual Machine in a IPV6 subnet" title="Direct link to Create a Virtual Machine in a IPV6 subnet">‚Äã</a></h3>
<ol>
<li>Navigate to the <a href="https://portal.azure.com/#home" target="_blank" rel="noopener noreferrer">Azure Portal</a></li>
<li>Navigate to <a href="https://portal.azure.com/#view/HubsExtension/BrowseResource/resourceType/Microsoft.Compute%2FVirtualMachines" target="_blank" rel="noopener noreferrer">Virtual Machines</a></li>
<li>Click Create Azure Virtual machine</li>
<li>Go through the Create Virtual Machine wizard until you hit Networking and select the Virtual Network and Subnet with the IPV6 addresses. Your Network Interface needs to sit in the subnet that has IPV6 address ranges.</li>
</ol>
<p>You can also also create a separate NIC (Network Interface Card), assign it to the IPv6 subnet, and have this as a secondary NIC.</p>
<p><img decoding="async" loading="lazy" alt="Dual IPV4 and IP6 NIC" src="https://luke.geek.nz/assets/images/DualIPV46Nic-5608fce780da5c54824890c1526a883f.png" width="1832" height="708" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="creating-dual-stack-network-with-azure-bicep">Creating dual-stack network with Azure Bicep<a href="https://luke.geek.nz/azure/IPv6-on-Azure/#creating-dual-stack-network-with-azure-bicep" class="hash-link" aria-label="Direct link to Creating dual-stack network with Azure Bicep" title="Direct link to Creating dual-stack network with Azure Bicep">‚Äã</a></h3>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// This function parses the CIDR notation and returns an object with the network address, subnet mask, and other details.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">output</span><span class="token plain"> v6addressspace </span><span class="token datatype class-name">object</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">parseCidr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'2001:db8:1234::/48'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// This function generates an array of subnets within the specified CIDR block. The subnet size is 64, and the index calculates the subnet.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// The 'range(0, 5)' function generates an array of numbers from 0 to 4. The 'for' loop iterates over these numbers.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// For each number 'i', the 'cidrSubnet' function calculates a subnet within the '2001:db8:1234::/48' CIDR block.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// The subnet size is 64, and 'i' is used as the index. The resulting array contains the calculated subnets.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">output</span><span class="token plain"> v6subnets </span><span class="token datatype class-name">array</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> i </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">in</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">range</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">5</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">cidrSubnet</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'2001:db8:1234::/48'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">64</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// This function generates an array of host addresses within the specified CIDR block. The index is used to calculate the host address.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Similar to the 'v6subnets' array, the 'range(0, 5)' function generates an array of numbers from 0 to 4.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// For each number 'i', the 'cidrHost' function calculates a host address within the '2001:db8:1234::/48' CIDR block.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// The resulting array contains the calculated host addresses.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">output</span><span class="token plain"> v6hosts </span><span class="token datatype class-name">array</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> i </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">in</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">range</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">5</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">cidrHost</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'2001:db8:1234::/48'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// This function generates a string within the specified CIDR block. The host index is always 3 (Azure Reserved).</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// The 'cidrHost' function calculates a host address within the '2001:db8:1234::/48' CIDR block.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// The host index is '0 + 3', which is 3. This is because the first three addresses in a subnet are reserved in Azure.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">output</span><span class="token plain"> v6hostsazure </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">cidrHost</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'2001:db8:1234::/48'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> </span><span class="token number">3</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// This Bicep file creates an Azure Virtual Network with IPv4 and IPv6 subnets.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Set the default location to the location of the resource group</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> location </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">resourceGroup</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">location</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Set the number of subnets to be created</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> subnetnumber </span><span class="token datatype class-name">int</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">6</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Define the network address for the virtual network</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="token plain"> vnetAddress </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'2001:db8:1234::'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Define the network size for the virtual network</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="token plain"> vnetSize </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">48</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Combine the network address and size into a CIDR block for the IPv6 virtual network</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="token plain"> vnetCidrIPv6 </span><span class="token operator">=</span><span class="token plain"> </span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">'</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">vnetAddress</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">/</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">vnetSize</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Define the network address for the IPv4 virtual network</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="token plain"> vnetAddressIPv4 </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'192.168.0.0'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Define the network size for the IPv4 virtual network</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="token plain"> vnetSizeIPv4 </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">16</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Combine the network address and size into a CIDR block for the IPv4 virtual network</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="token plain"> vnetCidrIPv4 </span><span class="token operator">=</span><span class="token plain"> </span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">'</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">vnetAddressIPv4</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">/</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">vnetSizeIPv4</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Define the subnet sizes for IPv4 and IPv6</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="token plain"> subnetSizeIPv4 </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">24</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="token plain"> subnetSizeIPv6 </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">64</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Generate the IPv4 subnets</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// This loop will create a number of subnets equal to 'subnetnumber'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Each subnet will have a unique name and address prefix</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="token plain"> subnetsIPv4 </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> i </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">in</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">range</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> subnetnumber</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">'subnetIPv4-</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">subnetSizeIPv4</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">-</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">i</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">addressPrefix</span><span class="token operator">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">cidrSubnet</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">vnetCidrIPv4</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> subnetSizeIPv4</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Create the virtual network with IPv4 subnets</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// This resource includes both IPv4 and IPv6 address spaces</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// But only the IPv4 subnets are created at this point</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> vnet </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.Network/virtualNetworks@2023-04-01'</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'myVnet'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">location</span><span class="token operator">:</span><span class="token plain"> location</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">addressSpace</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)">// Add the IPv4 and IPv6 CIDR blocks to the address prefixes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">addressPrefixes</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"> vnetCidrIPv4</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> vnetCidrIPv6 </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">subnets</span><span class="token operator">:</span><span class="token plain"> subnetsIPv4</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Update the IPv4 subnets to add the IPv6 address prefixes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Bicep does not currently support dual stack, so the subnets must be updated after the virtual network is created and the IPv6 address space is added. Bicep will attempt to create both the IPv4 and IPv6 subnets at the same time, leading to Retry and failed errors. Redeploy if required.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> subnetsIPv6 </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.Network/virtualNetworks/subnets@2023-04-01'</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> i </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">in</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">range</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> subnetnumber</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">'subnetIPv4-</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">subnetSizeIPv4</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">-</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">i</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">parent</span><span class="token operator">:</span><span class="token plain"> vnet</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">addressPrefixes</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"> subnetsIPv4</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">properties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">addressPrefix</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">cidrSubnet</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">vnetCidrIPv6</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> subnetSizeIPv6</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Reference: <a href="https://github.com/Azure/bicep/issues/1013" target="_blank" rel="noopener noreferrer">Add "wait" and "retry" deployment options #1013</a></p>
<p><img decoding="async" loading="lazy" alt="IPv6/IPv4 Dual Stack Azure Network" src="https://luke.geek.nz/assets/images/DualIPV46VNET-142a500c999d7c899696e6e3e6d2d67d.png" width="1746" height="497" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="IPv6/IPv4 Dual Stack Azure Network" src="https://luke.geek.nz/assets/images/DualIPV46VNETSubnet-5071924702a3391bf5a91fc9a822c753.png" width="1698" height="553" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="configure-virtual-machine-with-a-private-ipv6-address">Configure Virtual Machine with a private IPv6 address<a href="https://luke.geek.nz/azure/IPv6-on-Azure/#configure-virtual-machine-with-a-private-ipv6-address" class="hash-link" aria-label="Direct link to Configure Virtual Machine with a private IPv6 address" title="Direct link to Configure Virtual Machine with a private IPv6 address">‚Äã</a></h2>
<p>Now that we have IPv6 addresses in our Virtual Network, I have a Windows Server 2022 Azure Virtual Machine created in a dual-stacked subnet; we can add an IPv6 IP configuration by navigating to the NIC of the VM and adding ipconfiguration.</p>
<p><img decoding="async" loading="lazy" alt="Azure Virtual Machine IPv6 Config" src="https://luke.geek.nz/assets/images/DualIPV46VM_IPconfiguration-4ebe936fe27d5110be63753a91a889ac.png" width="1761" height="789" class="img_ev3q">
<img decoding="async" loading="lazy" alt="ipconfig" src="https://luke.geek.nz/assets/images/DualIPV46VM_IPConfig-e9d92e837dc4c992d6f2c502804ae38d.png" width="770" height="550" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="configure-virtual-machine-with-a-public-ipv6-address">Configure Virtual Machine with a public IPv6 address<a href="https://luke.geek.nz/azure/IPv6-on-Azure/#configure-virtual-machine-with-a-public-ipv6-address" class="hash-link" aria-label="Direct link to Configure Virtual Machine with a public IPv6 address" title="Direct link to Configure Virtual Machine with a public IPv6 address">‚Äã</a></h2>
<p>You can add a public IPv6 address to a virtual machine similar to the private IPv6 address, but first, we must create our public IP.</p>
<ol>
<li>Navigate to the <a href="https://portal.azure.com/#home" target="_blank" rel="noopener noreferrer">Azure Portal</a></li>
<li>Navigate to <a href="https://portal.azure.com/#view/HubsExtension/BrowseResource/resourceType/Microsoft.Network%2FPublicIpAddresses" target="_blank" rel="noopener noreferrer">Public IP addresses</a></li>
<li>Click + Create</li>
<li>Select your Subscription/Resource Group and Region</li>
<li>Enter a name for your Public IP and select IP Version as: Ipv6</li>
<li>Click Review + Create</li>
<li>Click Create</li>
<li>Once created, shutdown the Virtual Machine you want to attach the public IP to</li>
<li>Navigate to Networking on the Virtual Machine blade</li>
<li>Click Attach network interface, and select your Ipv6 Public IP</li>
<li>Start your Virtual Machine and navigate to <a href="https://whatismyipaddress.com/" target="_blank" rel="noopener noreferrer">https://whatismyipaddress.com/</a>; your ipv6 public IP address should now match your newly added address.</li>
</ol>
<p><img decoding="async" loading="lazy" alt="What is my IP" src="https://luke.geek.nz/assets/images/IPv6WhatisMyIP-19ed0e4cebfe5aee141850d927b3a770.png" width="1505" height="749" class="img_ev3q"></p>
<p>You can test connectivity to your newly published IPv6 address now.</p>
<p>Any issues, make sure you checkout <a href="https://test-ipv6.com/" target="_blank" rel="noopener noreferrer">https://test-ipv6.com/</a> and <a href="http://www.ipv6scanner.com/cgi-bin/main.py" target="_blank" rel="noopener noreferrer">http://www.ipv6scanner.com</a>, from your client.</p>]]></content>
        <author>
            <name>Luke Murray</name>
            <uri>https://luke.geek.nz</uri>
        </author>
        <category label="Azure" term="Azure"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Azure Bicep - Principal does not exist in directory]]></title>
        <id>https://luke.geek.nz/azure/PrincpalNotFound-bicep-roleassignment/</id>
        <link href="https://luke.geek.nz/azure/PrincpalNotFound-bicep-roleassignment/"/>
        <updated>2023-10-31T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[PrincpalNotFound when doing Role Assignment of a User Assigned Managed identity]]></summary>
        <content type="html"><![CDATA[<p>Recently, I was deploying an <a href="https://learn.microsoft.com/entra/identity/managed-identities-azure-resources/how-manage-user-assigned-managed-identities?pivots=identity-mi-methods-azp&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">User Assigned Managed identity</a>, and assigning the managed identity a role assignment with Azure Bicep, and ran into an issue, where the assignment would fail, but then after a rerun would work.</p>
<blockquote>
<p>Principal e892476361114c90be141d9bf20cc94b does not exist in the directory 73160ae1-aa4a-48b5-a424-d5e43d808f53. Check that you have the correct principal ID. If you are creating this principal and then immediately assigning a role, this error might be related to a replication delay. In this case, set the role assignment principalType property to a value, such as ServicePrincipal, User, or Group. See <a href="https://learn.microsoft.com/azure/role-based-access-control/troubleshooting?tabs=bicep&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">https://aka.ms/docs-principaltype</a></p>
</blockquote>
<p><img decoding="async" loading="lazy" alt="PrincpalNotFound" src="https://luke.geek.nz/assets/images/PrincipalNotExistinDirectory-30dcbc091e1cb7613fc3c32980a0face.png" width="1044" height="622" class="img_ev3q"></p>
<p>What was happening, was that the User Assigned Identity was created, and immediately after the role assignment was attempted, leaving no time for the role assignment API to be aware that the User Assigned Managed identity existed, even with a hard coded dependson!</p>
<p>The fix was to Set the: <a href="https://learn.microsoft.com/en-us/azure/azure-resource-manager/bicep/scenarios-rbac?WT.mc_id=AZ-MVP-5004796#principal" target="_blank" rel="noopener noreferrer">principalType</a> into the Bicep, as ServicePrincipal, making sure that the Azure platform can wait for the replication to complete, before trying the role assignment.</p>
<blockquote>
<p>The principalType property specifies whether the principal is a user, a group, or a service principal. Managed identities are a form of service principal.</p>
</blockquote>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> uami </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.ManagedIdentity/userAssignedIdentities@2023-01-31'</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> azUserAssignedManagedIdentity</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">location</span><span class="token operator">:</span><span class="token plain"> location</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> uamiassignment </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.Authorization/roleAssignments@2022-04-01'</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">guid</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token function" style="color:rgb(80, 250, 123)">resourceGroup</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'contributor'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">principalId</span><span class="token operator">:</span><span class="token plain"> uami</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">properties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">principalId</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">principalType</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'ServicePrincipal'</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">roleDefinitionId</span><span class="token operator">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">resourceId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.Authorization/roleDefinitions'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'b24988ac-6180-42a0-ab88-20f7382dd24c'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Contributor</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">scope</span><span class="token operator">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">resourceGroup</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content>
        <author>
            <name>Luke Murray</name>
            <uri>https://luke.geek.nz</uri>
        </author>
        <category label="Azure" term="Azure"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Microsoft Azure Management with PowerShell - Introduction]]></title>
        <id>https://luke.geek.nz/azure/powershell/azure-management-powershell/</id>
        <link href="https://luke.geek.nz/azure/powershell/azure-management-powershell/"/>
        <updated>2023-10-30T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Delve into the common ways to work with Microsoft Azure, using PowerShell.]]></summary>
        <content type="html"><![CDATA[<blockquote>
<p>To see a video of these commands in action, take a look at the following YouTube-hosted video: <a href="https://youtu.be/a4gehHwlwBQ" target="_blank" rel="noopener noreferrer">Microsoft Azure Management with PowerShell - Introduction</a></p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="powershell">PowerShell<a href="https://luke.geek.nz/azure/powershell/azure-management-powershell/#powershell" class="hash-link" aria-label="Direct link to PowerShell" title="Direct link to PowerShell">‚Äã</a></h2>
<p>PowerShell is a powerful scripting and automation framework developed by Microsoft. It is designed for task automation and configuration management and is particularly useful for managing and automating Microsoft Windows environments. PowerShell uses a command-line interface with a scriptable approach, and it's built on the .NET Framework.</p>
<ul>
<li><a href="https://learn.microsoft.com/powershell/scripting/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">What is PowerShell?</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="powershell-and-microsoft-azure">PowerShell and Microsoft Azure<a href="https://luke.geek.nz/azure/powershell/azure-management-powershell/#powershell-and-microsoft-azure" class="hash-link" aria-label="Direct link to PowerShell and Microsoft Azure" title="Direct link to PowerShell and Microsoft Azure">‚Äã</a></h2>
<p>When it comes to Microsoft Azure, PowerShell provides a robust set of cmdlets (pronounced "command-lets") that enable you to interact with and manage Azure resources, making it a valuable tool for working with Azure services.</p>
<p>When you run a PowerShell cmdlet to, for example, create a virtual machine or retrieve information about an Azure resource, the cmdlet translates your request into an HTTP request to the relevant Azure REST API endpoint.</p>
<ul>
<li><a href="https://learn.microsoft.com/powershell/azure/?view=azps-10.4.1&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure PowerShell Documentation</a></li>
</ul>
<blockquote>
<p>There is an assumption, that you have access to an Azure environment, and the ability to create resources, within that environment.</p>
</blockquote>
<p><img decoding="async" loading="lazy" alt="Microsoft Azure Management with PowerShell" src="https://luke.geek.nz/assets/images/BlogHeading-BlogHeading-Microsoft-Azure-Management-with-PowerShell-788b8586e4737f49ce3303670020bee9.gif" width="1198" height="628" class="img_ev3q"></p>
<p>First up, let's verify the version of PowerShell we have, open a Powershell terminal and run:</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$PSVersionTable</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>A supported version of PowerShell version 7 or higher is the recommended version of PowerShell for use with the Az PowerShell module on all platforms including Windows, Linux, and macOS.</p>
<p>The Az PowerShell module is preinstalled in <a href="https://learn.microsoft.com/azure/cloud-shell/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Cloud Shell</a> and in <a href="https://learn.microsoft.com/powershell/azure/azureps-in-docker?view=azps-10.4.1&amp;tabs=amd64&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Docker</a> images.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="setting-up-your-azure-environment-for-powershell">Setting up your Azure environment for PowerShell<a href="https://luke.geek.nz/azure/powershell/azure-management-powershell/#setting-up-your-azure-environment-for-powershell" class="hash-link" aria-label="Direct link to Setting up your Azure environment for PowerShell" title="Direct link to Setting up your Azure environment for PowerShell">‚Äã</a></h3>
<p>First thigs first, lets installed the Azure (<a href="https://learn.microsoft.com/powershell/azure/new-azureps-module-az?view=azps-10.4.1&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Az PowerShell module</a>)modules.</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Install Azure Modules</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># The Set-PSRepository cmdlet is used to set values for a registered repository. </span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># The Install-Module cmdlet is used to download one or more modules from an online gallery and installs them on the local computer. In this case, the command is installing the Az module, which provides cmdlets for managing Azure resources.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Set-PSRepository</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name </span><span class="token string" style="color:rgb(255, 121, 198)">'PSGallery'</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">InstallationPolicy Trusted</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Install-Module</span><span class="token plain"> Az </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If you don't have local administrator rights, you can install it into your user profile like below:</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Install Azure Module as Current User (as opposed to System)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># '-Scope CurrentUser` specifies that the module should be installed only for the current user. If you don't specify a scope, the default is `AllUsers`, which requires administrator permissions.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Install-Module</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name Az </span><span class="token operator">-</span><span class="token plain">Repository PSGallery </span><span class="token operator">-</span><span class="token plain">Scope CurrentUser</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You can install a specific version of the Az module by specifying RequiredVersion, like below:</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Install specific version of Azure Modules</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Install-Module</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name Az </span><span class="token operator">-</span><span class="token plain">RequiredVersion 7</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You will find that the Azure powershell cmdlets will constantly get updated, to resolve bugs, offer new functionality, to update the modules to the ltest you can use:</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Update Azure Module</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># The command Get-InstalledModule -Name Az* | Update-Module is used to update all installed PowerShell modules that start with "Az".</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Set-PSRepository</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name </span><span class="token string" style="color:rgb(255, 121, 198)">'PSGallery'</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">InstallationPolicy Trusted</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Get-InstalledModule</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name Az* </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Update-Module</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Az is a collection of different cmdlets, across multiple Azure resource types, to view a list of avaliable commands you use 'Get-Command', like below:</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Gets Az Commands</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Note: Will take a while for all the cmdlets to list.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Get-Command</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Noun Az*</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="getting-started-with-azure-powershell-module">Getting started with Azure PowerShell module<a href="https://luke.geek.nz/azure/powershell/azure-management-powershell/#getting-started-with-azure-powershell-module" class="hash-link" aria-label="Direct link to Getting started with Azure PowerShell module" title="Direct link to Getting started with Azure PowerShell module">‚Äã</a></h3>
<p>Lets connect to Microsoft Azure</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Connect to Azure - Interactive will prompt for credentials</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Connect-AzAccount</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If your wanting to connect to Azure, from a device that doesn't supoport the credential prompt, like Azure Cloudshell you can connect using another device, using a device code:</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Connect to Azure</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Connect-AzAccount</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">UseDeviceAuthentication</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If you have a Service principal, you can use this to authenticate, commonly used for automation scripts, Azure DevOps agents and GitHub runners.</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Connect to Azure using Service Principal authentication</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$SecurePassword</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">ConvertTo-SecureString</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">String </span><span class="token string" style="color:rgb(255, 121, 198)">"Password123!"</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">AsPlainText </span><span class="token operator">-</span><span class="token plain">Force</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$TenantId</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">'yyyyyyyy-yyyy-yyyy-yyyy-yyyyyyy'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ApplicationId</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">'zzzzzzzz-zzzz-zzzz-zzzz-zzzzzzzz'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$Credential</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">New-Object</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">TypeName System</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Management</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Automation</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">PSCredential </span><span class="token operator">-</span><span class="token plain">ArgumentList </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ApplicationId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$SecurePassword</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Connect-AzAccount</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ServicePrincipal </span><span class="token operator">-</span><span class="token plain">TenantId </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$TenantId</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Credential </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$Credential</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Once, connected - its time to check what Azure subscriptions you can use.</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Get Azure Subscriptions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzSubscription</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Once you have selected the right Azure subscription to connect to, you can set your Subscription context (modify/delete resources). Add your subscription ID, from the earlier step in between ''.</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Select Azure Subscription</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$subid</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">''</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Set-AzContext</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">SubscriptionId </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$subid</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now you have connected to your, Azure subscription, it is time to get your Azure resources and Resource Groups</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Get Azure resource groups and resources</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzResourceGroup</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Format-Table</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzResource</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Format-Table</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Get Azure resource</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzResource</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Get Azure resource by ResourceType</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzResource</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Where-Object</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ResourceType </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.Network/virtualNetworks'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Sort Azure resource by Name and Resource Group</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzResource</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Where-Object</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ResourceType </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.Storage/storageAccounts'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Sort-Object</span><span class="token plain"> Name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzResource</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Sort-Object</span><span class="token plain"> ResourceGroupName </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Working with Variables</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Working with variables and data types in PowerShell</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceType</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.Network/virtualNetworks'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzResource</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Where-Object</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ResourceType </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resourceType</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Using PowerShell operators for comparisons and calculations</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resources</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzResource</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$count</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resources</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Count</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"You have </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$count</span><span class="token string" style="color:rgb(255, 121, 198)"> resources in your Azure subscription."</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Scripting constructs: loops and conditional statements</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resources</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzResource</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">foreach</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resource</span><span class="token plain"> in </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resources</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resource</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ResourceType </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.Network/virtualNetworks'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Found a virtual network: </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$resource</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Name</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"This virtual network is in </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$resource</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">ResourceGroupName</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ForegroundColor Green</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Scripting constructs: loops and conditional statements</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$subscriptions</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzSubscription</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">foreach</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$subscription</span><span class="token plain"> in </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$subscriptions</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resource</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzResource</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Where-Object</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ResourceType </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.Network/virtualNetworks'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$resource</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ResourceType </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.Network/virtualNetworks'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Found a virtual network: </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$resource</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Name</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">BackgroundColor Black </span><span class="token operator">-</span><span class="token plain">ForegroundColor White</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"This virtual network is in </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$resource</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">ResourceGroupName</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ForegroundColor Green</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"This Virtual Network is in </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$subscription</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Name</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ForegroundColor Green</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Error handling in PowerShell</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">try</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzResource</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ResourceGroupName </span><span class="token string" style="color:rgb(255, 121, 198)">"NonexistentResourceGroup"</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ErrorAction Stop</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"An error occurred: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token string" style="color:rgb(255, 121, 198)">. Make sure you have selected the right Resource Group"</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ForegroundColor Red</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="resource-creation">Resource Creation<a href="https://luke.geek.nz/azure/powershell/azure-management-powershell/#resource-creation" class="hash-link" aria-label="Direct link to Resource Creation" title="Direct link to Resource Creation">‚Äã</a></h3>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Import Module</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Import-Module</span><span class="token plain"> Az </span><span class="token operator">-</span><span class="token plain">Verbose</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">#Create Azure Resource Group</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">New-AzResourceGroup</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name </span><span class="token string" style="color:rgb(255, 121, 198)">"MyResourceGroup"</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Location </span><span class="token string" style="color:rgb(255, 121, 198)">"West US"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Get Regions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzLocation</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Select-Object</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">First 1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzLocation</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Select-Object</span><span class="token plain"> DisplayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> Location</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> PhysicalLocation</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> GeographyGroup </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Format-Table</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">ate Azure Resource </span><span class="token function" style="color:rgb(80, 250, 123)">Group</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$region</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">'AustraliaEast'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">New-AzResourceGroup</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name </span><span class="token string" style="color:rgb(255, 121, 198)">"MyResourceGroup</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$region</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Location </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$region</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Create a storage account</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$uniqueId</span><span class="token plain"> = </span><span class="token namespace">[guid]</span><span class="token plain">::NewGuid</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ToString</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Substring</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain">4</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$region</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">'AustraliaEast'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceGroupName</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"MyResourceGroup</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$region</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">New-AzStorageAccount</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ResourceGroupName </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceGroupName</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name </span><span class="token string" style="color:rgb(255, 121, 198)">"mystgacc</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$uniqueId</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Location </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$region</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">SkuName Standard_LRS </span><span class="token operator">-</span><span class="token plain">AllowBlobPublicAccess </span><span class="token boolean">$false</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">verbose</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">#Remove Azure Storage account</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$region</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">'AustraliaEast'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceGroupName</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceGroupName</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Remove-AzStorageAccount</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ResourceGroupName </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceGroupName</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name </span><span class="token string" style="color:rgb(255, 121, 198)">"mystgacc</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$uniqueId</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Force </span><span class="token operator">-</span><span class="token plain">verbose</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzStorageAccount</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ResourceGroupName </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceGroupName</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name </span><span class="token string" style="color:rgb(255, 121, 198)">"mystgacc</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$uniqueId</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">verbose</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Create an Azure Virtual Network</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$region</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">'AustraliaEast'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceGroupName</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">'network-prod-rg'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$VNetname</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">'vnet-prod'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$subnetname</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">'infraservers'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$subnetAddressPrefix</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">'10.0.0.0/24'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Create a resource group</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceGroup</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzResourceGroup</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceGroupName</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ErrorAction SilentlyContinue</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$null</span><span class="token plain"> </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceGroup</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Creating Resource Group </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceGroupName</span><span class="token string" style="color:rgb(255, 121, 198)"> in </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$region</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ForegroundColor Yellow</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceGroup</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">New-AzResourceGroup</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceGroupName</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Location </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$region</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Force</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Resource Group </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceGroupName</span><span class="token string" style="color:rgb(255, 121, 198)"> already exists in </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$region</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ForegroundColor Green</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Create a virtual network</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$AzVNET</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">New-AzVirtualNetwork</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ResourceGroupName </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceGroupName</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$VNetname</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">AddressPrefix </span><span class="token string" style="color:rgb(255, 121, 198)">'10.0.0.0/16'</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Location </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$region</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Create a subnet</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$subnetConfig</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Add-AzVirtualNetworkSubnetConfig</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$subnetname</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">AddressPrefix </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$subnetAddressPrefix</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">VirtualNetwork </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$AzVNET</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Get full object output</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Alias (This is a pipeline to the Format-List cmdlet (fl is an alias for Format-List). It formats the output as a list of properties for each object. This can make it easier to read the details of the virtual network.)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzVirtualNetwork</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ResourceGroupName </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceGroupName</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$VNetname</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># | fl</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Alias</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Get-Alias</span><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Select-Object</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">First 2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">#splat</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$configData</span><span class="token plain"> = @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ResourceGroupName = </span><span class="token string" style="color:rgb(255, 121, 198)">"MyResourceGroup"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Location = </span><span class="token string" style="color:rgb(255, 121, 198)">"West US"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    StorageAccountName = </span><span class="token string" style="color:rgb(255, 121, 198)">"stgacctest100"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">try</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">New-AzStorageAccount</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ResourceGroupName </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$configData</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ResourceGroupName </span><span class="token operator">-</span><span class="token plain">Name </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$configData</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">StorageAccountName </span><span class="token operator">-</span><span class="token plain">Location </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$configData</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Location </span><span class="token operator">-</span><span class="token plain">SkuName Standard_LRS</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Error</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Failed to create storage account: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">#splat as parameters</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$configData</span><span class="token plain"> = @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">"ResourceGroupName"</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"MyResourceGroup"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">"Location"</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"West US"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">"StorageAccountName"</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"stgacctest100"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">"SkuName"</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"Standard_LRS"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">try</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">New-AzStorageAccount</span><span class="token plain"> @configData</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Error</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Failed to create storage account: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Tags</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceGroupName</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">'TagTestRG'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">New-AzResourceGroup</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceGroupName</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Location </span><span class="token string" style="color:rgb(255, 121, 198)">'AustraliaEast'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Set-AzResourceGroup</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceGroupName</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Tag @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> Department = </span><span class="token string" style="color:rgb(255, 121, 198)">"Finance"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> Project = </span><span class="token string" style="color:rgb(255, 121, 198)">"Q1"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Get Tag Resource Group</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceGroupName</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">'TagTestRG'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzResourceGroup</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceGroupName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Tags</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceGroupName</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">'TagTestRG'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$tags</span><span class="token plain"> = </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzResourceGroup</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceGroupName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Tags</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$tags</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Remove</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"Project"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Set-AzResourceGroup</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceGroupName</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Tag </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$tags</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content>
        <author>
            <name>Luke Murray</name>
            <uri>https://luke.geek.nz</uri>
        </author>
        <category label="Azure" term="Azure"/>
        <category label="PowerShell" term="PowerShell"/>
    </entry>
</feed>