<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://luke.geek.nz/</id>
    <title>luke.geek.nz Blog</title>
    <updated>2024-11-30T08:14:09.250Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://luke.geek.nz/"/>
    <subtitle>luke.geek.nz Blog</subtitle>
    <icon>https://luke.geek.nz/img/favicon.ico</icon>
    <rights>Copyright Â© 2024 luke.geek.nz.</rights>
    <entry>
        <title type="html"><![CDATA[Azure Region Provider Comparison]]></title>
        <id>https://luke.geek.nz/azure/azure-region-provider-comparison/</id>
        <link href="https://luke.geek.nz/azure/azure-region-provider-comparison/"/>
        <updated>2024-11-30T08:14:09.250Z</updated>
        <summary type="html"><![CDATA[Compare the capabilities and services available in the new Azure region for example, New Zealand North, with those in Australia East.]]></summary>
        <content type="html"><![CDATA[<p>With the release of the <a href="https://datacenters.microsoft.com/globe/explore?info=region_newzealandnorth" target="_blank" rel="noopener noreferrer">New Zealand North</a> Azure Region on the horizon, I wanted a way to measure what capabilities can be deployed in the new region, particularly in comparison to Australia East.</p>
<p>To do so, I wrote a script that uses the Azure CLI to query the <a href="https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/azure-services-resource-providers?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">provider namespaces</a> of each region and compare them side by side, and output the results into a HTML table.</p>
<p><img decoding="async" loading="lazy" alt="Azure Region Provider Comparison" src="https://luke.geek.nz/assets/images/RegionCompare_AustraliaVsNZN-e0376676d0b1b7f17a42e01fed83dbd3.png" width="1502" height="526" class="img_ev3q"></p>
<p>There is bound to be differences between the regions, especially when Strategic Serviecs, such as Azure OpenAI <em>(Cognitive Services)</em> is involved, especially for such a new region, especially at the time of writing when its possible not all Foundational and Mainstream services, have been deployed.</p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>Using the Providers is not a full-proof way of comparing the regions, however for my purporses it largely helps to identify the capabilities especially when compared to the <a href="https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/azure-services-resource-providers?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure services table</a>. Its also worth mentioning, that this comparison won't touch on some services or capabilities, that may be may have preview capabilities delivered to specific regions as a sub feature of that namespace.</p></div></div>
<p>The PowerShell script can be found below:</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Get the current date in an easy-to-read format</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$currentDate</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-Date</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Format </span><span class="token string" style="color:rgb(255, 121, 198)">"MMMM dd, yyyy"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Generate the HTML report with the date in the title</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token plain"> Generate-HTMLReport </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[array]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$comparisonTable</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[string]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$location1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token namespace">[string]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$location2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$html</span><span class="token plain"> = @</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">&lt;!DOCTYPE html&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">&lt;html&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">&lt;head&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    &lt;title&gt;Azure Provider Namespaces Comparison - </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$currentDate</span><span class="token string" style="color:rgb(255, 121, 198)">&lt;/title&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    &lt;style&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        table { </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            width: 100%; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            border-collapse: collapse; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            font-family: Arial, sans-serif; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            margin: 20px 0; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            border-radius: 5px 5px 0 0; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            overflow: hidden; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            box-shadow: 0 0 20px rgba(0, 0, 0, 0.15); </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        th, td { </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            padding: 12px 15px; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            text-align: left; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        th { </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            text-transform: uppercase; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            font-weight: bold; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        th:nth-child(1) { </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            background-color: #4CAF50; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            color: white; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        th:nth-child(2) { </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            background-color: #2196F3; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            color: white; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        th:nth-child(3) { </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            background-color: #FF9800; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            color: white; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        tr { </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            border-bottom: 1px solid #dddddd; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        tr:nth-child(even) { </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            background-color: #f3f3f3; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        tr:last-child { </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            border-bottom: 2px solid #009879; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        tr:hover { </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            background-color: #f1f1f1; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    &lt;/style&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">&lt;/head&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">&lt;body&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    &lt;h1&gt;Azure Provider Namespaces Comparison&lt;/h1&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    &lt;p&gt;Comparison of &lt;a href="</span><span class="token plain">https:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token plain">learn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">microsoft</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">com/en-us/azure/azure-resource-manager/management/azure-services-resource-providers?WT</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">mc_id=AZ-MVP-5004796</span><span class="token string" style="color:rgb(255, 121, 198)">"&gt;provider namespaces&lt;/a&gt; between &lt;strong&gt;</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$location1</span><span class="token string" style="color:rgb(255, 121, 198)">&lt;/strong&gt; and &lt;strong&gt;</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$location2</span><span class="token string" style="color:rgb(255, 121, 198)">&lt;/strong&gt; as of </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$currentDate</span><span class="token string" style="color:rgb(255, 121, 198)">.&lt;/p&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    &lt;table&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        &lt;tr&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            &lt;th&gt;</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$location1</span><span class="token string" style="color:rgb(255, 121, 198)">&lt;/th&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            &lt;th&gt;</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$location2</span><span class="token string" style="color:rgb(255, 121, 198)">&lt;/th&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            &lt;th&gt;Missing in </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$location1</span><span class="token string" style="color:rgb(255, 121, 198)">&lt;/th&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        &lt;/tr&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain">@</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">foreach</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$row</span><span class="token plain"> in </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$comparisonTable</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$html</span><span class="token plain"> </span><span class="token operator">+=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"&lt;tr&gt;"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$html</span><span class="token plain"> </span><span class="token operator">+=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"&lt;td&gt;$(</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$row</span><span class="token string" style="color:rgb(255, 121, 198)">."</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$location1</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">$</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$providerNamespaces1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Count</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">")&lt;/td&gt;"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$html</span><span class="token plain"> </span><span class="token operator">+=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"&lt;td&gt;$(</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$row</span><span class="token string" style="color:rgb(255, 121, 198)">."</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$location2</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">$</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$providerNamespaces2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Count</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">")&lt;/td&gt;"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$html</span><span class="token plain"> </span><span class="token operator">+=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"&lt;td&gt;$(</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$row</span><span class="token string" style="color:rgb(255, 121, 198)">."</span><span class="token plain">Missing in </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$location1</span><span class="token string" style="color:rgb(255, 121, 198)">")&lt;/td&gt;"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$html</span><span class="token plain"> </span><span class="token operator">+=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"&lt;/tr&gt;"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$html</span><span class="token plain"> </span><span class="token operator">+=</span><span class="token plain"> @</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    &lt;/table&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    &lt;h2&gt;Service Categories&lt;/h2&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    &lt;ul&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        &lt;li&gt;&lt;strong&gt;&lt;a href="</span><span class="token plain">https:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token plain">learn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">microsoft</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">com/azure/reliability/availability-service-by-category?WT</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">mc_id=AZ-MVP-5004796</span><span class="token comment" style="color:rgb(98, 114, 164)">#available-services-by-region-category"&gt;Foundational&lt;/a&gt;&lt;/strong&gt;: Available in all recommended and alternate regions when the region is generally available, or within 90 days of a new foundational service becoming generally available.&lt;/li&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &lt;li&gt;&lt;strong&gt;&lt;a href=</span><span class="token string" style="color:rgb(255, 121, 198)">"https://learn.microsoft.com/azure/reliability/availability-service-by-category?WT.mc_id=AZ-MVP-5004796#available-services-by-region-category"</span><span class="token plain">&gt;Mainstream&lt;</span><span class="token operator">/</span><span class="token plain">a&gt;&lt;</span><span class="token operator">/</span><span class="token plain">strong&gt;: Available in all recommended regions within 90 days of the region general availability</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain"> Demand-driven in alternate regions</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> and many are already deployed into a large subset of alternate regions</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">&lt;</span><span class="token operator">/</span><span class="token plain">li&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &lt;li&gt;&lt;strong&gt;&lt;a href=</span><span class="token string" style="color:rgb(255, 121, 198)">"https://learn.microsoft.com/azure/reliability/availability-service-by-category?WT.mc_id=AZ-MVP-5004796#strategic-services"</span><span class="token plain">&gt;Strategic&lt;</span><span class="token operator">/</span><span class="token plain">a&gt;&lt;</span><span class="token operator">/</span><span class="token plain">strong&gt;: Targeted service offerings</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> often industry-focused or backed by customized hardware</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain"> Demand-driven availability across regions</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">&lt;</span><span class="token operator">/</span><span class="token plain">li&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &lt;</span><span class="token operator">/</span><span class="token plain">ul&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &lt;p&gt;Note: The rollout schedule </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> services may vary based on their category and region</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> with Foundational Services being prioritized </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> early adoption</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> followed by Mainstream services </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">+</span><span class="token plain">90 days after GA</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> and </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">finally</span><span class="token plain"> Strategic services as demand requirements</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain"> Make sure you let your Microsoft account team know </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> a Strategic Service is required in your region</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">&lt;</span><span class="token operator">/</span><span class="token plain">p&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&lt;</span><span class="token operator">/</span><span class="token plain">body&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&lt;</span><span class="token operator">/</span><span class="token plain">html&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token string" style="color:rgb(255, 121, 198)">"@</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    return </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$html</span><span class="token string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)"># Main script execution</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">try {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    Write-Host "</span><span class="token plain">Fetching provider namespaces </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$location1</span><span class="token plain"> and </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$location2</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string" style="color:rgb(255, 121, 198)">" -ForegroundColor Green</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$providerNamespaces1</span><span class="token string" style="color:rgb(255, 121, 198)"> = Get-ProviderNamespaces -location </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$location1</span><span class="token string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$providerNamespaces2</span><span class="token string" style="color:rgb(255, 121, 198)"> = Get-ProviderNamespaces -location </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$location2</span><span class="token string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$comparisonTable</span><span class="token string" style="color:rgb(255, 121, 198)"> = Create-ComparisonTable -providerNamespaces1 </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$providerNamespaces1</span><span class="token string" style="color:rgb(255, 121, 198)"> -providerNamespaces2 </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$providerNamespaces2</span><span class="token string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    Write-Host "</span><span class="token plain">Generating HTML report</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string" style="color:rgb(255, 121, 198)">" -ForegroundColor Green</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$htmlReport</span><span class="token string" style="color:rgb(255, 121, 198)"> = Generate-HTMLReport -comparisonTable </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$comparisonTable</span><span class="token string" style="color:rgb(255, 121, 198)"> -location1 </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$location1</span><span class="token string" style="color:rgb(255, 121, 198)"> -location2 </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$location2</span><span class="token string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$reportPath</span><span class="token string" style="color:rgb(255, 121, 198)"> = "</span><span class="token plain">AzureProviderComparisonReport</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">html</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$htmlReport</span><span class="token string" style="color:rgb(255, 121, 198)"> | Out-File -FilePath </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$reportPath</span><span class="token string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    Write-Host "</span><span class="token plain">HTML report generated at </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$reportPath</span><span class="token string" style="color:rgb(255, 121, 198)">" -ForegroundColor Green</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">catch {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    Write-Error "</span><span class="token plain">An error occurred: </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token plain">"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It will output a HTML report in the directory thats its ran from <em>(make sure you are authentiated to Azure first and have the <a href="https://learn.microsoft.com/powershell/azure/new-azureps-module-az?view=azps-13.0.0&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Az PowerShell</a> modules installed)</em>:</p>
<p><img decoding="async" loading="lazy" alt="Azure Region Provider Comparison" src="https://luke.geek.nz/assets/images/RegionCompare_HTMLReport-d6126b0f3d1fda5f46c775bfad6c49ae.jpg" width="6000" height="10192" class="img_ev3q"></p>]]></content>
        <author>
            <name>Luke Murray</name>
            <uri>https://luke.geek.nz</uri>
        </author>
        <category label="Azure" term="Azure"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Request is badly formatted Error with Azure OpenAI]]></title>
        <id>https://luke.geek.nz/azure/openai-request-badly-formatted/</id>
        <link href="https://luke.geek.nz/azure/openai-request-badly-formatted/"/>
        <updated>2024-11-26T19:48:56.888Z</updated>
        <summary type="html"><![CDATA[Learn how to resolve the 'Request is badly formatted' error when using Azure OpenAI with Managed Identity in a container app.]]></summary>
        <content type="html"><![CDATA[<p>When attempting to call <a href="https://learn.microsoft.com/azure/ai-services/openai/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure OpenAI</a> using a <a href="https://learn.microsoft.com/entra/identity/managed-identities-azure-resources/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Managed Identity</a>, you may encounter the following error:</p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">ERROR:root:Error generating response: Error code: 400 - {'error': {'code': 'Request is badly formated', 'message': 'Resource Id is badly formed or from wrong namespace: NA'}}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">2024-11-26T18:57:08.224640325Z ERROR:root:Response content: b'{"error":{"code":"Request is badly formated","message":"Resource Id is badly formed or from wrong namespace: NA"}}'</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<p>I had issues when attempting to call the Azure OpenAI endpoint from an <a href="https://learn.microsoft.com/azure/container-apps/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Container App</a> using a Managed Identity. The error message that was getting returned to my App was:</p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>An error generating a reponse.</p></div></div>
<p><img decoding="async" loading="lazy" alt="Error" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAvAAAAFGCAYAAAAM3auPAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAACZ0SURBVHhe7d17dFTloffx34TMkMsAiRhDkCDGEgFtfA+BxkgLWEQscAz0RMELFW3RoohFLfLamtOTthxECwulUqSiNuILHo5AV1FRORVsQY6G1qiEhhovQUK4JcAkk8wkmfePmcBkk8vkIskz+X7WYi149p6dZ/bM6Dc7z0xsPp/PJwAAAABGiLAOAAAAAOi+CHgAAADAIAQ8AAAAYBACHgAAADAIAQ8AAAAYhIAHAAAADELAAwAAAAYh4AEAAACD2LrbL3Jyu6t18uQpVVZWyev1qptNDwAAAGiRzWaT3W5XbGyM+vXrq+joKOsuHdKtAv7w4SNyuVyKj4+T0xkrh8Mhm81m3Q0AAADotnw+nzwej1yuSpWXV8jpdGrAgIusu7Vbtwn4L788KLvdrgEDLiLaAQAAEBZ8Pp8OHz4ir9erwYMHWTe3S7cI+MOHj8jn8ykpKdG6CQAAADBeaWmZbDZbp1yJ7/I3sbrd1XK5XJ1yZwAAAIDuaMCAi+RyueR2V1s3tVmXB/zJk6cUHx/HshkAAACELZvNpvj4OJ08ecq6qc26POArK6vkdMZahwEAAICw4nTGqrKyyjrcZl0e8F6vVw6HwzoMAAAAhBWHwyGv12sdbrMuD3ifz8fyGQAAAIQ9m83WKb/jqMsDHgAAAEDoCHgAAADAIAQ8AAAAYBACHgAAADAIAQ8AAAAYhIAHAAAADELAAwAAAAYh4AEAAACDEPAAAACAQQh4AAAAwCAEPAAAAGAQAh4AAAAwCAEPAAAAGISABwAAAAxieMB7dPr4CZ32NB6tOX1Cx62DAAAAQBgwPOClD1f8QLeuPRA0ckC//8EPtOxvQUMAAABAmDA84B369u3TpQ0b9JeqwNAHr+mV6Fm6d6zDsi8AAABgPsMDXlLqLC3IeFu/f+2EpBPa/PutGn3XdF0sSac/Ud5P79C4jPEaee0c/eyPX6im4XaHNmn+jav0/pkDleqV+bdo+R7/v05/sEHLX/vizFYAAACgOzA/4OXQd++apePrNml/0SY9VzZDP7rOIalUefct0OtDFupPu97R3k2zpN/eoZ9tc/lvVufRsUPHzwa9pJpjpTpWI0kevb9plfLWv6evgrYDAAAAXS0MAj5wFf7yDZo9e4Muv2+WhknSvtf0yj/G6t4fX6E+vSTFjVXOg2P1P+u2hhDlDn333/+kHb+b4b+SDwAAAHQT4RHwcui7k8fK4xmrydcG1r4fK9VXlw3Vpb3O7tU72iH940t9dnaoeQ6n+sRYBwEAAICuFSYBf5ajIdj79lGf0sM6HryxTtJlg3Vp8BgAAABgkLAL+DO+eZ2+53hLG95uWPP+hfKef1vDbhjrXxYzMEmX6hO9/5F/8+kPXtHmT8/enDexAgAAoDsK34DvdYUWrZ6r08u+r3GTb9HE6+7TK0N+rqdvSwpsH6sZt9Yo70dTNXHyVM3+83c0a1LDjXkTKwAAALonm8/n81kHz6fCwiINH55qHe5UNRUn5HFc0OSa9prTJ+SSU/37WD433uPS6VrWwQMAAKDzdEb7hu8V+CC945qOd0nq3eeCc+NdvIkVAAAA3VOPCHgAAAAgXBDwAAAAgEEIeAAAAMAgBDwAAABgEAIeAAAAMAgBDwAAABiEgAcAAAAMQsADAAAABiHgAQAAAIPYfD6fzzp4PnXGr5MNVldXL4+3VrV19aqv79K7BgAAAENFRNgU2StCDnukevXqvGvendG+nTebbsBd7VGV2xMId5t1MwAAABAim+rrfapye+Su9lg3dqmwCfhKt0d19T7V+3yBq+/11l0AAACAkNTX1/ub0udTXb1Ple7uE/FhEfDuao98Pp/q6oh2AAAAdK66unr5fL5ucyXe+ICvq6tXbW098Q4AAICvTXdqTuMD3uOtVUQE690BAADw9YqIsMnjrbUOn3fGB7x/bZJ1FAAAAOhc9T5/e3Y14wO+vt7HG1YBAADwtauv7x4fU258wAMAAAA9CQEPAAAAGISABwAAAAxCwAMAAAAGIeABAAAAgxDwAAAAgEEIeAAAAMAgBDwAAABgEAIeAAAAMAgBDwAAABiEgAcAAAAMQsADAAAABiHgAQAAAIMQ8AAAAIBBCHgAAADAIAQ8AAAAYBACHgAAADAIAQ8AAAAYhIAHAAAADELAAwAAAAYh4AEAAACDEPAAAACAQQh4AAAAwCAEPAAAAGAQAh4AAAAwCAEPAAAAGISABwAAAAxCwAMAAAAGIeABAAAAgxDwAAAAgEEIeAAAAMAgBDwAAABgEAIeAAAAMAgBDwAAABiEgAcAAAAMQsADAAAABiHgAQAAAIMQ8AAAAIBBCHgAAADAIAQ8AAAAYBACHgAAADAIAQ8AAAAYhIAHAAAADELAAwAAAAYh4AEAAACDEPAAAACAQQh4AAAAwCAEPAAAAGAQAh4AAAAwCAEPAAAAGISABwAAAAxCwAMAAAAGIeABAAAAgxDwAAAAgEEIeAAAAMAgBDwAAABgEAIeAAAAMAgBDwAAABiEgAcAAAAMQsADAAAABiHgAQAAAIMQ8AAAAIBBCHgAAADAIAQ8AAAAYBACHgAAADAIAQ8AAAAYhIAHAAAADELAAwAAAAYh4AEAAACDEPAAAACAQQh4AAAAwCAEPAAAAGAQAh4AAAAwCAEPAAAAGISABwAAAAxCwAMAAAAGIeABAAAAgxDwAAAAgEEIeAAAAMAgBDwAAABgEAIeAAAAMAgBDwAAABiEgAcAAAAMQsADAAAABiHgAQAAgFb85IF51qEuQ8ADAAAALfjJA/O0evVq63CXIeABAACAZjTEu7vaa93UZYwP+IgImyIijL8bAAAA6Gas8R4REaGICJt1t/PO+PKN7BWhbnAeAQAAEEas8f6TB+YpwuZvz67W9TPoIIc9UvX1PuswAAAA0C5Nxfvq1atVX++Twx5p3f28Mz7ge/WKUGRkhHp1g++GAAAAYLbm4t3jres2zdn1M+gE0VEO2Wy2bnFCAQAAYKaW4t1msyk6ymG9SZew+Xy+Ll1/UlhYpOHDU63D7eKu9qi2tl4RETbV+6T6+nrrLgAAAECrIiL877Osr/cpMjKi0+K9M9o3rC5ZR0c5FBPtCLw7uEu/LwEAAIDRfIqIsCkm2tFp8d5ZwuoKPAAAANCddUb7htUVeAAAACDcEfAAAACAQQh4AAAAwCAEPAAAAGAQAh4AAAAwCAEPAAAAGISABwAAAAxCwAMAAAAGIeABAAAAgxDwAAAAgEEIeAAAAMAgBDwAAABgEAIeAAAAMAgBDwAAABiEgAcAAAAMYvP5fD7r4PlUWFik4cNTrcPt5na7VVFxSlVVbnk8HutmIzgcDsXERCsurq+io6OtmwEAAGCozmjfsAr40tIyVVScVL9+fRUbG6OYmBjZ7ZHW3bo1r7dWHq9HJytOqaqqSrGxsUpKSrTuBgAAAAN1RvuGzRKaL7/8Sh6vR9/4RooGDhygfv36GhfvkmS3Ryo2JkYDBw7QJZcMlsfr0ZdffmXdDQAAAD1UWAR8aWmZfKrXJYOTjYz25tjtkbpkcLI8nhqVlpZZNwMAAKAHMj7g/WveT2pgUpJ1U9i45JLBqqyslNvttm4CAABAD2N8wFdUnNKFF14QVlferez2SPXr11cVFaesmwAAANDDGB/wVVVuxcTGWIfDTkxsjKqquAIPAADQ0xkf8B6PR7Ex4R/wsTExxn4sJgAAADqP8QEPAAAA9CQEPAAAAGAQAh4AAAAwCAEPAAAAGISABwAAAAxCwJ9nNZ/v1f/s+UI11g0AAABACHp0wNeUvKe8ZU8o99dPKHfZBv2l5Ov/mMZjO1fp4RXv6Zh1AwAAABCCnhvwf1+lqdk52lzq1KWXD1af0rf1s+yZ+tlOl3VPAAAAoNvooQHv0evrNsgzfYn++4m5mpU9QwueWKM3Ny7Xg2Oc1p0BAACAbqOHBvxxHSuzjkm9ky9R/15BAxWfKO+nt+jqUeM18to79PDGoLXrhzZp/oznVBC0z9XTc7T586DbSzr90QY9nD1VI0eN17gfrNA/IpMa7wAAAAC0QQ8N+CRNu22sTm9cpH9bslX7K6zbJVW9p9wZ9+n1IT/V1p1vavfzN0tr7lPuzsA6+TqPjn26VQ/dkyfNWKat29ZoTp+dyv3VJh1vOMbnG3TPj1bp0DU/139ve1UvL/qG/vLqzqAvAgAAALRNDw14qc+kXL31xHRduPMJ3Xrd9frX+1bpf4LexPrVxue0OfkBPX3fSPWPcaj3kCn6vz9O1evb3gs+imY+vkSzRiWpf/+h+uGd10l//0SFga1/WbtK+7/5gJ5+8Gpd2v8CXTxiin5449Cg2wMAAABt02MDXpL6XztXq197U2/9bq7Sjm3Sw9Mb3sTqUcFHB9TH8zf99teBT6n59RP67dul0mel+urMERxyBC+5Cf67SvXZP6VhY69W/+BhAAAAoAN6dMD7OdR/1HT9esOrenKSR6//fqu+kks1pyXHwCv07YyMs3+mz9WTD1ytC62HaJJLp9zWMQAAAKBjemzA13isn/nu1OWXJ0kVLp3WBUq5zKnjVU6Nvm6svhv8J+MS9bbcsmn9dXGi9NWhUusGAAAAoN16ZsAf2aT542dq/h/26nig42uO79Qz6w6o/3eu1jBJaTNnadie5/Qffyw988kzNce/0Fengw/Ukgv0nUkjdXrTKj33aeCLVLynvD8esO4IAAAAhKxnBvxF0/XkMzPk2LRIE68Zr5Gjxitz0q9UkPFzrX/wCv8+yTO0+vdTdHr5Lcq8Zqr+9brrlZn9K23+3Hrlvnn9p+dq9QyP1sy4XiNHjdfIWzfr4pum6GLrjgAAAECIbD6fz2cdPJ8KC4s0fHiqdThkHb19zekTcnkkR58L1Mdh3epXU3FCLjnVP66ZHVpT5dJxt+Ts7wxx+U3TOnpfAQAA0LU6o+d65hX4IL37XKD+/ZuPd0nqHXdB++NdkmKc6t/BeAcAAABEwAMAAABmIeABAAAAgxDwAAAAgEEIeAAAAMAgBDwAAABgkLAIeK+31joUdnrCfQQAAEDrjA94h8Mhjzf0X65kKo/XI4ejAx9lCQAAgLBgfMDHxESrqrLKOhx2qiqrFBMTbR0GAABAD2N8wMfF9dWxYyfCeomJ11urY8dOKC6ur3UTAAAAehjjAz46Olpxcf10qLTUuilsHCotVVxcP0VHcwUeAACgpzM+4CUpKSlRNkXoiy9LwupKvNdbqy++LJFNEUpKSrRuBgAAQA8UFgEvSYMHXyyH3aF//rNYR48eU2VVlbExf/LkKR06dFj//GexHHaHBg++2LoLAAAAeiibz+fzWQfPp8LCIg0fnmodbje3262KilOqqnLL4zHz02kcDodiYqIVF9eXZTMAAABhpDPaN+wCHgAAAOiuOqN9w2YJDQAAANATEPAAAACAQQh4AAAAwCAEPAAAAGAQAh4AAAAwCAEPAAAAGISABwAAAAzS5QFvs9nUxR9FDwAAAHztfD6fbDabdbjNujzg7Xa7sb8xFQAAAAiVx+OR3W63DrdZlwd8bGyMXK5K6zAAAAAQVlyuSsXGxliH26zLA75fv74qL69gGQ0AAADCls/nU3l5hfr162vd1GZdHvDR0VFyOp06fPiIdRMAAAAQFg4fPiKn06no6Cjrpjbr8oCXpAEDLpLX61VpaRlX4gEAABA2fD6fSkvL5PV6NWDARdbN7WLzdaNiPnz4iFwul+Lj4+R0xsrhcHTKO3UBAACA88Xn88nj8cjlqlR5eYWcTmenxbu6W8BLkttdrZMnT6myskper5cr8gAAADCKzWaT3W5XbGyM+vXr2ynLZoJ1u4AHAAAA0LxusQYeAAAAQGgIeAAAAMAgBDwAAABgEAIeAAAAMAgBDwAAABiEgAcAAAAMQsADAAAABiHgAQAAAIMQ8AAAAIBBCHgAAADAIAQ8AAAAYBACHgAAADAIAQ8AAAAYhIAHAAAADELAAwAAAAax+Xw+n3WwS9XWStXVktcr1ddbtwIAAADdX0SEZLdLUVFSZKR1a4d0r4B3uaSaGusoAAAAYK7evSWn0zrabt0n4E+d8l91BwAAAMKN3S717WsdbZfusQbe5SLeAQAAEL68Xn/zdoKuD/jaWpbNAAAAIPzV1Pjbt4O6PuCrq60jAAAAQHjqhPbt+oBn6QwAAAB6ik5o364PeD4qEgAAAD1FJ7Rv1wc8AAAAgJAR8AAAAIBBCHgAAADAIAQ8AAAAYBACHgAAADAIAQ8AAAAYhIAHAAAADELAAwAAAAYh4AEAAACDEPAAAACAQQh4AAAAwCAEPAAAAGAQAh4AAAAwCAEPAAAAGISAR9c7Vqz8d4tVbh1vh/IDu5V/oMI63JjXq9qz/1Dp3t3aV+JttEuP1Oi8nCed+NgDANBThFXAV3+8RetXvKJ91IBZPt2kLYs3qcQ63g4lW5Zoy5ZPrcNB8rV+erZyV+QH/n1C+55bom17Tlj262ms5+U86cTHHgCAniKMAt6rDzetVdH2ddqxp5UrsOjBhmnk7Ikac+0w64YeJF/rpy7Q9kPBY1//eTn66gLlPHmev0EAACAMhU/Au3ercFemxt2TqdLtu/iRPJoRq9TseZqUFmvd0KPU1llHzsN5qbcOAACA9rD5fD6fdfC8On7cOtIurjce09I/j9XCRVLerW9rRN7jGndhw9Yy/TUnVxU3L9XQ/U9r8x92y6VEpdz7mGbfkNz4QA3qKlW0KbBvfaycGbfrlkWTlWyXVPaa1vyiXON+maK9uU9rX3G6sjY9pPSP1mrpG9/QrO+Xa9sTeSp23Ky5q25W0sl8bV26VvkfHlRt9CAl3XiXZt2aLmevwNfa28ztGk3Iq5I3n9Lmtbt19KQUNSxT4x6YrzFD7Gd3aZjzht1yueyKGjZRk352j9IvlHRyv7Y/9bT+uuegaiNilXD9/bp9bqbie5XprzmPaV/GLzVnSmLgQAXaPHulNP9ZTRvZnvu7X9ufWqa/7ipTrXOQUmYv0u1TkhXZMM9ju7X+10+raH+lNDBTY266SAUryjXh9YeUdvbeSN58rZ+zWlEN85Dk2r5Ez+TFa+pz92hEL0nyKn/5ffrfSx7T3O8nq+DJLG3UIt2fUaD1T72mo+5YJWQt0pw5aYqSAs+F4Ptbpu333a2Ca5/VguzA/W/psbeqK9Ge5Su1fed+VStWzguc/vHB03Rn7mQltHisEJ+XLZ3Ppp47K6dLu/K0Oe9tlZZUSs4UjVjw75p5TZx//6feVnVZpXRhoqJ6Sanzn9W0keeel1DmVl2wTs+v3KrSkkpFBo4nNRyzYS//sXcUlqm6JnCOGs7Pnt8o5xdS1nPX6MCSp7XvQKUih2Zp5uK7lBo4lW15PPatuVv/m/KYxpav08Y/7Jb9tpVaMCNZtYd2a2PD8fsNU9pDOZo2OvDNimu/ti9v/NqYeU+mEuyB413ymK45tc7/unLHKuGGhtdOw1dt5bXZ8PpZkq6SwOOogZma8ItFGtNwKluYg+TV0XfX+p/PLruihk3WtF/cpRH9Gr4+AMA4/ftbR9okTK7AV+jDPxco6drRcsaPVlrafu2zLKOpPn5QHy5eqB2arDtffFGzb4tV8YqV2nGs0W4BXu1bea9e2pmsaWs3Kue/Hte4Xhv0/Ip8VUtSnVeuzz/Q1txXFDnrcS184ce6wi7JWy5X0SatX1aoSxf9VvcvnqIkV75empurD2OnaU7ei1r4xDT1eTNXTy0PHEvN3K7RfKTSjQu15qmDSnn0t1r48m+VPfKIts9bqO1nFg8H5vyqR+mPPevfZ4xdLpdXcudr/dxHtMd7vWY+96IWrlmkEb3L5QpcEa0+XiaXO+iLyStXWZlcDe/rbMv9DXytfcnzdP+rG5WzbJq07hGt3xM4mCtfL81fouKE23X7Cy/qwccmqnrXjqZ/YmK/TMmJZSoqKA4MePXJrgJVV+7QvsKGnT7VZ7tcSkg9G5WRe36nl/amKfvZF3X/I+k6/eoS/angzOYm7m+wVh57y74Fyx/RNvd1mvPfW5Sbl6PU2BOKv+kx3fvQRCWEcKxWn5etnc8mH4Pd2vEnaeRPl2vhyy9q7g8TVbT4N/rrMUnfnKF7H56iPhqk9EeW6t7lS3XDNxvm0vi8tDq3Q1u06pEPlDR/jXJf36i5t6Wo2nG1pj559ph+icp4aKkm/Iukq3+se5cvDZyfgKh8bftlvoY++IwWvrBIKce2aP0LDQ9Y6+cwWO3JMh15dZk2FqUpe82zmj0l2T/Pu3+n6qmP69E/btT9j6ap5D9+fmYJUdELudpRPUVz/muLcl5+XN/q51Jt4L+MtSfLVPzUz7XDPVGznn1R9y+eoahdS7Qmr+E5GcJrs84r1+dvauOiV6SsX+rBl5crI3a3tj312pnnfUtzOPrqQj29qlzfeuJl5fzx98q+6iOtf3SLjjZMAADQ44RHwJe/r4KCYRoxKk5SnEaMHabSd85dRhOdtUhzstOUEB+nlOyblar9Kmnq/Y6HXtO2NwZoQs5tSr3QrsjoZGXMvV0J29/RJ2eWHhQr/vu/UvboZDkvjA1c3ZVUVqnUny7SuKGJSoiPVcmm1SpyZGnmIxOVFB8n55CJuj3nZkVuX63tZxvgnNs14t6tbS8UK3n+rzQlLVHO+ESlzsrRpIxi7cjb7Q+ZQ69p2xtepS3K0YSGfbLv0rghdh3d+pL2eScr+9+zlJoYJ2dimibMafoKZvNCu79Ht76kfRffo9tnpyk+2q7I5InK/sFlKvrzB5Kko2+8pCLvZGU/MlkpiXFyDknXlCmNrrsHiVPq6BS59n4UiJVPVVKYrozp8Sr+IHDyDuSr2J2u1OFnb1Wb/mMteCBTSfFxSvjOzUofUqmSorKzO7QkpMe+QYH2vVOplOsn+q+U9humMdcmq2TnfqmfPeRjtfS8bO18Suc+BnKO1czH71LG0EQ54+OUdMNEpapAn30qyd7wUwKHoi6IkzM+TlEtPA9anNt776g8ZbzGXBkrya6EGyYqpeRt7Tt87jEj+8Up2iHJEStnfJyc/YJ2qE7XpJXzlD4kTs7ETE3IGqTaws/8j3mI5zCYq3qUbnlkslISExXvlApeXqvyGx7S7OuTFWW3Kz7tNk2aUqaCd0skVehoSaWcKSlKipYincnKmDVRSWeurksaP19zZqX7n09pWcq+bZhcW99SkUJ8bUqSnEp/tOG1maJJM8dKHxcG3rzbwhzq8rVtbZnSFi1SxpBYRdrjlDr7HqUdeVN7eecvAPRYYRHwrj07VZp8uZJ6VchVXiF78uVyfrxDBdar670cTf/dorqoUOVOjz5bt1LrVwT+/GGnTuugKs50YIqSU5taL3y5koc2/N2rQ5+XSVdepZTgIBg6TANVpqNfBn90YfDtLA4W60hdilKuDP56sUoZniIVFetow5yVrtRzWtir4sJiKWOUUoPn0Gah3d/iwmJF1hRoW8N5W7FSf3q3TCo5oqOSSj9v21wSrhol54FCFbsDsZ6cpjFpaaou/FQuSUc/+kCujNGNjxcZ/Ng6FNmGZ3loj32DePVJlGrdZx/HalelFO+Usy3HavZ52fr59GviueOtUPG7W7T5l49o6ezfqKhOOlpyzh1oXbNzk/okJEqVrrOR6q5UreLVpx1LO+xBj19k0NcJ+RwGGz5MyWeOV6ySj6Wo0p1nb79ipXYVSuUlRyTFKf22ydKmR5Q7/zfa/n5Zqx+lGX/hRZLroI6Wh/ba9HMoMvg52uj538IcivfrUJ1T5X8Ouv8rNqtUB3W00ZuQAQA9SRvSprvyL5+JPPWeNi9YqGcWLNQzy95Trf3cZTShqq2ulOyJSh6ZrqFn/kzWhEfv1Ih4694tqVStyzp2lru60jrUtJqgSLKqdMndMOcmtTyHzuX/WpEDhgedt3QNveFOZf1wpPrIK6/HeptWDE1XinO3DhRIRz/8QPbRaXIOH6WUT/L1idur4k+KlTS6YX17x7XtsU/RhLvH6tCyn2vz9t3K37pS/+/VWI27LbMdx2pKa+ezGYfe0po7fqQtH8Yo7e4cPfjCco1Jse7UcVHX3KZxfTcpb8kW5b+7U1v/8zkdmnCXxjXztpL26Pg59MhdKUUPSWt0Dr950/3KyrpMkhSVdo8WbnpW08ZK+5berdxZK1UQ6msmhNdmKJqdQ41L1YpXwlXB93+crpm/SNf4pw8A6IHMD/jy91VQkKj0xc9q4Qtn/8z6fmKTy2hC4Rw0SJHlHjn/JVPp3wn+k6akaOveLYlTwpBYqays8TyOlem0YpUwKC54tHkXpyhBZSq3/ESh/HCZlJKigQ1zbvKqXGAOnx1sec1sXVvLuin+r1VdHaMrGp23TKWPTFaU7OoT38T5aNEwpWZIhwrzVfR+pVKvSpR6XaZLr9itAwWFKilI1ODLQjyPIWjrY3/6q4PqkzVNyeWFOqxM3ZK3XBMCAdvWY52rtfPZtKItz6sk7SEtmDdRKYmxZ9883Nk8R3S0OlNjJth1eH+5LsxeqoUPpzc7r/bo+DkcoKQUyR1xkeX2mUofGvS8sScqLfsh3b9+uTIcb2nHm81d3pfKjx2RnIOUEB/aazNkTc3h4hQlqFwaYL3/mUo58yZ9AEBPY3zAu/bsVGniOKVZrjAmjxnX9DKaUFw5TWOG5mv7U2/paMPqCG+FSg81d5W7ealZM5RQ+JK2vBH4sXhdhfY8u0GlQ2do3JXWvZsRP17jbrCrYPVaFZ30D1XvX6dtb9g1Inu8nGqYc7F2LHlFDb9UtPbQbuUfCMzhi7Vav6Ek8KN5r46+u1sldZKUqOQrY1W+c7dK6/yf+LFv1VoVh7jExSo1a4YS9r6k9W+eXQZQW16io4ErmqnfGaeojzdo667AufSWaMfWoHeYNiF1VKZcn2xWQWGaLh2qM2vjD735mkqUrqHW5SMd0abHvkwF24sVlZym9Oy7NGVKupKDl4+06VhNa+18NqvKJVed/I/1my9pzxdB2xIvUoKKVVIU+jyaVPCO9nnilTxysqbMyVJGWmKL3ywkJA+SCvcHnnch6vA5jFN69kTVblqtrR+fvU1tSYnK6ySpQvl5W868riSPvHVSZEzvM/uq8AMVlPu/eO3nW7T+hf1KuGWaUhXia7NVLcwhfrzG3VCjvc+sO7u9zqvSkoafLlaqYOV9Wr6q6Tf1AgDCk+EBX6H87QVyjs/UOT+1H5quFOd+7X2n+StpzUvUhMWP66qTz+vpG7O1ePatyp1+rzZubwjgNhiYpTlPTpH7ubuVe2O2cqfeoW2Hx+n2xVlnP4WjVXaNmLdCUy59T+tnZin3xiwtXrhDfeb9SjNHN7wZMFETFv9SI72vaM2N/n1yf/ySDpyo8M9hcZZq181T7tRs5U7N1qqXC1QeuAyemnW7EkrWadXULOVk3au9wxdpUkbw12+DgVma8+T1cq+5W7k33qqlM7OVe/cy/e/BQH1deY/ufOAyfbn4VuV8L0s5/7ZEpd+ecu7jFyTqqnQlfVyg0tFpavg+LeGqUdKu3SrPGOUPqXZLVPKVcSr/w5LAp4a05bFP1JiZmSpdHrgv38tSzveytXjuEm3fX9nGYzWjtfPZhNSpdyr5nyu1dOYdWnzTHVr/xXiNuSZoh16Z+tb341T8+B1aPDNbq95o31IzjbpZGdFb9MLUhvuepZyb7tDTK3cH4rixpAnTlHz0Fa2Zeatyb13tfxNoqzp+DqNGz9Pchwfpk0dvVc5Nd2jxTVla/It1KjomqU7SyXe0/rZsLZ59txZPf0T7hszTtIlBV+ejyrRnfrZyvpel3Ll5qr4+R3dmNXzkaiivzVa0OIfA8Qfv8B9/1h3KzbpFeXkFgZ+olankbwdV/sH+ln/CBgAIK2HzOfBfG3elXNVSVN/Yxm9CazOvqssrVWuPldMZ4v/YmxLCfGpdFar22hUVb10+0cIc6rxynapUpPPcTxBpr9qTFf7PRg/+xJEG3kq5XC3fj/PHq+pyjyKtc2ntXNft18ZZq9Xn8aWa0LdS1fWSVKNPVi/Q1kMzdP9TQd+ktXasELR4Pq1CeDxrXRWqrgvxeE0of+Mxrfr7ZD34UJpqGz5z9NibWjN/nZJyt2jmaOstQptXszp8Dlt//isqTs6gpTn+3yuQo9yH0/3n39F4eyMdnV8zczjDWymXy3vuufNWqlqxbT+fAICuw+fAf82iY+WMb+f/kBuxKyo+7txwaKsQ5hPpjPPvY93Q0hx62Vv9SMG2iuxn+bjAYPbW78f5E/hmxzqX1s71hzu0zzFKI5Lt/vsaHydnfKIGXuyUomPUqMFaO1YIWjyfViE8npHONhzvHBUq2F6ggVePUpQ98NGQ8XFyDkpWfK9YRTYVoAptXs3q8Dls/fnfZDgHRPZreXuH59faHALn+ZxzZyfeAaCnIeCB9ho+SqmeV5T3i3Xa8+5u5b+7WztW3qfnXx+kSfMmhrj+2VRxGpGZouJlP9H6rf77nr99ndbc/RsdmbJIU0N9fwcAAGgzltAAHeGtUPHfd6lwV7FOK15J12Qq7f+kKL6HXBGtLSlQ/p4P9NlXVYq6OE0jMjKV2rbfENat1boCy5aaumoPAEB7dXAJDQEPAAAAnE8dDHiW0AAAAAAGIeABAAAAgxDwAAAAgEEIeAAAAMAgBDwAAABgEAIeAAAAMAgBDwAAABiEgAcAAAAMQsADAAAABiHgAQAAAIN0fcBHdP0UAAAAgPOiE9q340foKLvdOgIAAACEp05o364P+Kgo6wgAAAAQnjqhfbs+4CMjpd69raMAAABAeOnd29++HdT1AS9JTmen/DgBAAAA6Jbsdn/zdgKbz+fzWQe7jMsl1dRYRwEAAABz9e7dafGubhfwklRbK1VXS16vVF9v3QoAAAB0fxER/qvuUVGdsmwmWPcLeAAAAADN6h5r4AEAAACEhIAHAAAADELAAwAAAAYh4AEAAACDEPAAAACAQQh4AAAAwCAEPAAAAGAQAh4AAAAwCAEPAAAAGISABwAAAAxCwAMAAAAGIeABAAAAgxDwAAAAgEEIeAAAAMAgBDwAAABgEAIeAAAAMAgBDwAAABiEgAcAAAAMQsADAAAABiHgAQAAAIMQ8AAAAIBBCHgAAADAIAQ8AAAAYBACHgAAADAIAQ8AAAAYhIAHAAAADPL/AWGTujmFqnN2AAAAAElFTkSuQmCC" width="752" height="326" class="img_ev3q"></p>
<p>After enabling some logging on my Python application, I was able to review the Console Logs of my Container <em>(running in a Container Apps environment)</em> and found the following error message:</p>
<p><img decoding="async" loading="lazy" alt="Error" src="https://luke.geek.nz/assets/images/Container_ErrorGenertingResponse-82ffd02c715eab0fbc6f4fe083d38664.png" width="2360" height="146" class="img_ev3q"></p>
<p>After some testing, I was able to confirm that I could receive a response using the API keys, but when using the Managed Identity, I got an error message.</p>
<p>My Azure OpenAI instance was created with Infrastructure as Code and I noticed that the endpoint of my Azure OpenAI was:</p>
<div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">https://eastus2.api.cognitive.microsoft.com/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Azure OpenAI" src="https://luke.geek.nz/assets/images/AzureOpenAI_Bad_CognitiveServicesEndpoint-1bd027e13ad28f3b99ee846c59b60384.png" width="1733" height="859" class="img_ev3q"></p>
<p>On an Azure OpenAI instance that was created in the Portal, the endpoint was:</p>
<div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">https://azureopenaitestlol.openai.azure.com/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>So, I made a comparison between the two resources:</p>
<p><img decoding="async" loading="lazy" alt="Azure OpenAI" src="https://luke.geek.nz/assets/images/AzureOpenAI_Diff_CognitiveServicesEndpoint-048593ce8a4f7b52ee779b8cdd37d60b.png" width="1208" height="120" class="img_ev3q"></p>
<p>And my IaC-created Azure OpenAI resource was missing the following:</p>
<ul>
<li>customSubDomainName</li>
</ul>
<p>After some digging, <strong>I found that the <a href="https://learn.microsoft.com/azure/ai-services/cognitive-services-custom-subdomains?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">customSubDomainName</a> is the key to the issue.</strong> When using a Managed Identity, the customSubDomainName is required to be set for Entra ID to be able to authenticate the request</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Custom subdomain names are required to enable features like Microsoft Entra ID for authentication.</p></div></div>
<p>So after updating the Azure OpenAI resource to use the subdomain, updating my environment variables to use the right Azure OpenAI endpoint <em>(and making sure that the CLIENT_ID of the User Assigned Managed identity is correct)</em> I was able to call the Azure OpenAI endpoint using the Managed Identity successfully.</p>
<p><img decoding="async" loading="lazy" alt="Azure OpenAI" src="https://luke.geek.nz/assets/images/App_SuccessfulTest-d9d1d76c691970266c3b04399bb81504.png" width="760" height="825" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="Azure OpenAI" src="https://luke.geek.nz/assets/images/ContainerApp_EnvironmentVariabnles-de22a926d1293554220edd3fb3ea2152.png" width="2188" height="930" class="img_ev3q"></p>]]></content>
        <author>
            <name>Luke Murray</name>
            <uri>https://luke.geek.nz</uri>
        </author>
        <category label="Azure" term="Azure"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Deploying a Streamlit App to Azure Container Apps]]></title>
        <id>https://luke.geek.nz/azure/deploy-streamlit-to-container-apps/</id>
        <link href="https://luke.geek.nz/azure/deploy-streamlit-to-container-apps/"/>
        <updated>2024-11-18T05:27:32.929Z</updated>
        <summary type="html"><![CDATA[Learn how to deploy a Streamlit application to Azure Container Apps using Docker and GitHub Codespaces.]]></summary>
        <content type="html"><![CDATA[<p><a href="https://streamlit.io/" target="_blank" rel="noopener noreferrer">Streamlit</a> is an excellent tool for creating interactive web applications with Python.</p>
<p>In this post, we will deploy a Streamlit application to <a href="https://learn.microsoft.com/azure/container-apps/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Container Apps</a>. <a href="https://learn.microsoft.com/azure/container-apps/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Container Apps</a> is a fully managed serverless container service that allows you to run your containerized applications without having to manage the underlying infrastructure.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>For this article, you have access to an Azure subscription and have permission to deploy resources. If you don't have an Azure subscription, you can create a <a href="https://azure.microsoft.com/pricing/purchase-options/azure-account?icid=azurefreeaccount&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">free account</a> in just a couple of minutes.</p></div></div>
<p>Today, we are going to take a base Streamlit example application, and deploy it to Azure Container Apps.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>I will be using a GitHub Codespace; feel free to reference my public repository template: <a href="https://github.com/lukemurraynz/Codespace_IaC_Coding" target="_blank" rel="noopener noreferrer">lukemurraynz/Codespace_IaC_Coding</a> as a Codespace template.</p></div></div>
<p><img decoding="async" loading="lazy" alt="Streamlit Application" src="https://luke.geek.nz/assets/images/Streamlit_Demo_Example-e814590fa1eefb337d08774223dd5a21.png" width="1420" height="1270" class="img_ev3q"></p>
<p>Let us start off with the Streamlit application.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">streamlit_app.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> altair </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">as</span><span class="token plain"> alt</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> numpy </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">as</span><span class="token plain"> np</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> pandas </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">as</span><span class="token plain"> pd</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> streamlit </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">as</span><span class="token plain"> st</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">"""</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)"># Welcome to Streamlit!</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">Edit `/streamlit_app.py` to customize this app to your heart's desire :heart:.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">If you have any questions, check out our [documentation](https://docs.streamlit.io) and [community</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">forums](https://discuss.streamlit.io).</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">In the meantime, below is an example of what you can do with just a few lines of code:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">"""</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">num_points </span><span class="token operator">=</span><span class="token plain"> st</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">slider</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"Number of points in spiral"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">10000</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">1100</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">num_turns </span><span class="token operator">=</span><span class="token plain"> st</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">slider</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"Number of turns in spiral"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">300</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">31</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">indices </span><span class="token operator">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">linspace</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> num_points</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">theta </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">2</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> np</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">pi </span><span class="token operator">*</span><span class="token plain"> num_turns </span><span class="token operator">*</span><span class="token plain"> indices</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">radius </span><span class="token operator">=</span><span class="token plain"> indices</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">x </span><span class="token operator">=</span><span class="token plain"> radius </span><span class="token operator">*</span><span class="token plain"> np</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">cos</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">theta</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">y </span><span class="token operator">=</span><span class="token plain"> radius </span><span class="token operator">*</span><span class="token plain"> np</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">sin</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">theta</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">df </span><span class="token operator">=</span><span class="token plain"> pd</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">DataFrame</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">"x"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> x</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">"y"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> y</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">"idx"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> indices</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">"rand"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> np</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">random</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">randn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">num_points</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">st</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">altair_chart</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">alt</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Chart</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">df</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> height</span><span class="token operator">=</span><span class="token number">700</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> width</span><span class="token operator">=</span><span class="token number">700</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">mark_point</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">filled</span><span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">encode</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        x</span><span class="token operator">=</span><span class="token plain">alt</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">X</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"x"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> axis</span><span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        y</span><span class="token operator">=</span><span class="token plain">alt</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"y"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> axis</span><span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        color</span><span class="token operator">=</span><span class="token plain">alt</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Color</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"idx"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> legend</span><span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> scale</span><span class="token operator">=</span><span class="token plain">alt</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Scale</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        size</span><span class="token operator">=</span><span class="token plain">alt</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Size</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"rand"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> legend</span><span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> scale</span><span class="token operator">=</span><span class="token plain">alt</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Scale</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token builtin" style="color:rgb(189, 147, 249)">range</span><span class="token operator">=</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">150</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The next step is to create a <code>requirements.txt</code> file specifying the Streamlit application's dependencies. This will be used to install the Python dependencies for the image.</p>
<div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">requirements.txt</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">altair</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pandas</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">streamlit</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now that we have our Streamlit application, we need to create a Dockerfile to containerize the application. In this example, we use the official Python image from the Docker Hub as the base image. We then copy the application code into the container, install the dependencies, and define the command to run the Streamlit application using port 8080 <em>(the default port for Streamlit is 8501, but we are using 8080 for this example as a common port)</em>.</p>
<div class="language-Dockerfile language-dockerfile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">Dockerfile</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-dockerfile codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Use the official Python image from the Docker Hub</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">FROM python:3.12.7-slim</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Set environment variable for the port</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">ENV PORT=8080</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Expose the port that the application will run on</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">EXPOSE 8080</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Set the working directory inside the container</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">WORKDIR /usr/src/app</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Copy the requirements file into the container</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">COPY requirements.txt ./</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Install the dependencies specified in the requirements file</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">RUN pip install --no-cache-dir -r requirements.txt</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Copy the rest of the application code into the container</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">COPY . .</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Create a non-root user and switch to it</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">RUN useradd -m appuser &amp;&amp; chown -R appuser /usr/src/app</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">USER appuser</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Define the command to run the Streamlit application</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">ENTRYPOINT ["streamlit", "run", "app.py", "--server.port=8080"]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Add labels for metadata</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">LABEL maintainer="luke@luke.geke.nz"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">LABEL version="1.0"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">LABEL description="Streamlit application"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Health check to ensure the application is running</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  CMD curl --fail http://localhost:8080/_stcore/health || exit 1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p><a href="https://github.com/Azure/draft" target="_blank" rel="noopener noreferrer">Draft</a> is an open-source project that streamlines Kubernetes development. It takes a non-containerized application and generates the DockerFiles, Kubernetes manifests, Helm charts, Kustomize configurations, and other artifacts associated the application. The Azure Kubernetes Service <em>(AKS)</em> DevX extension for Visual Studio Code enhances non-cluster experiences, allowing you to create deployment files to deploy your applications to AKS. Draft is the available feature included in the DevX extension.</p><p>I used Draft, and the DevX extension was used to draft the first version of the streamlet dockerfile.</p><p>Reference: <a href="https://learn.microsoft.com/azure/aks/draft-devx-extension-aks?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Use Draft and the DevX extension for Visual Studio Code with Azure Kubernetes Service (AKS)</a></p></div></div>
<p>To build this image, I will use Docker on a GitHub Codespace to build the image locally and test it. Once confirmed, we can push it to an Azure Container Registry, which can then be used to deploy the image to Azure Container Apps.</p>
<p>We can easily test and build the image locally in a Codespace using the <a href="https://code.visualstudio.com/docs/containers/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Docker extension</a> in Visual Studio Code.</p>
<p><img decoding="async" loading="lazy" alt="Docker Build" src="https://luke.geek.nz/assets/images/Streamlit_Codespace_BuildTestDockerImage-08c7668a6cb60fb1d0b3a6ecd70502e9.gif" width="1912" height="925" class="img_ev3q"></p>
<p>Now that we have tested the image locally, we can push it to an Azure Container Registry.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>You can also refer to a previous article <a href="https://luke.geek.nz/azure/push-docker-images-to-acr-using-github-codespaces/" target="_blank" rel="noopener noreferrer">Push Docker Images to Azure Container Registry with GitHub Codespaces</a> for more information on how to push the image to an Azure Container Registry using the command line from the public dockerhub registry.</p></div></div>
<p>To push the image, we are going to use the docker extension again to do the push and tag to the <a href="https://learn.microsoft.com/azure/container-registry/container-registry-intro?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Container Registry</a>.</p>
<p><img decoding="async" loading="lazy" alt="Docker Push" src="https://luke.geek.nz/assets/images/Streamlit_Codespace_DeployStreamlitImageACR-f60d1624dc2a2c18b1bf94cabab82f20.gif" width="1912" height="925" class="img_ev3q"></p>
<p>Now that we have the image in the Azure Container Registry, we can deploy the image to Azure Container Apps.</p>
<p>To deploy the image to Azure Container Apps, we will to create a new Azure Container Apps resource in the Azure Portal and enable public ingress on port 8080, using a Microsoft managed network.</p>
<p><img decoding="async" loading="lazy" alt="Azure Container Apps" src="https://luke.geek.nz/assets/images/Streamlit_ContainerApps_DeployStreamlit-8613c190b6c78ce34c9103992e71cf1f.gif" width="1912" height="925" class="img_ev3q"></p>
<p>One of the best features of Azure Container Apps is the ability to scale the application to zero, so we can set up a Scale rule to scale <em>(replicas)</em> the Container App down to 0 when not in use.</p>
<p><img decoding="async" loading="lazy" alt="Azure Container Apps Scale" src="https://luke.geek.nz/assets/images/Streamlit_ContainerApps_HTTPScaleRule-30e8e145692ee0cca09feaf020351625.gif" width="1912" height="879" class="img_ev3q"></p>]]></content>
        <author>
            <name>Luke Murray</name>
            <uri>https://luke.geek.nz</uri>
        </author>
        <category label="Azure" term="Azure"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[New Zealand North Latency Testing and Results]]></title>
        <id>https://luke.geek.nz/azure/nz-north-latency-testing/</id>
        <link href="https://luke.geek.nz/azure/nz-north-latency-testing/"/>
        <updated>2024-11-10T05:48:55.999Z</updated>
        <summary type="html"><![CDATA[An in-depth analysis of latency within the New Zealand North Azure region, including various scenarios and performance metrics.]]></summary>
        <content type="html"><![CDATA[<p>New Zealand has a new <em>(and only)</em> Azure Cloud region: <a href="https://news.microsoft.com/aotearoa-datacenter?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">New Zealand North</a>. It's not every day that we get to explore a new region! This article will examine the latency within the New Zealand North region and between its Availability Zones.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-overview">ð Overview<a href="https://luke.geek.nz/azure/nz-north-latency-testing/#-overview" class="hash-link" aria-label="Direct link to ð Overview" title="Direct link to ð Overview">â</a></h2>
<p>New Zealand North region follows the newer, now standard, 3 + 0 model, with 3 <a href="https://learn.microsoft.com/azure/reliability/availability-zones-overview?tabs=azure-cli&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">availability zones</a> (three separate datacenters that make up a region) but with <a href="https://learn.microsoft.com/azure/reliability/cross-region-replication-azure?WT.mc_id=AZ-MVP-5004796#regions-with-availability-zones-and-no-region-pair" target="_blank" rel="noopener noreferrer">no specified region pair</a> <em>(e.g., locally or in Australia)</em>. This means that Microsoft needs to assume which other region you may want to use as a failover. You can choose any region you want (e.g., object replication on an Azure storage account can be any region). Most of us in New Zealand will likely choose New Zealand North as the primary and Australia East as the secondary, where applicable. These three availability zones already provide more resiliency out of the box than most New Zealand organizations had before.</p>
<p><img decoding="async" loading="lazy" alt="New Zealand North - Azure Avaliability Zones" src="https://luke.geek.nz/assets/images/Regions_AvaliabilityZones-e4f192fc2962f1d9336f6d6c91fad1ff.jpg" width="4000" height="2250" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>At the time of this article, New Zealand North is not officially Generally Available (indicative timelines December). However, finding I can deploy to this region now on my own subscriptions, I couldn't resist the opportunity to test the latency within the region. This article is intended as an indicative of what you can expect from New Zealand North, but I recommend running your own tests within your own environment if required. #geekingout</p></div></div>
<p>Let's look at the lower end of our resiliency tier. We can see Azure Service Bus	starts at an SLA of 99.9% <em>(Y: 8h 45m 36s  M: 43m 12s  W: 10m 4s)</em>, and the higher SLA services such as Azure Virtual Machines and API Gateway can give up to 99.99% <em>(Y: 52m 35s  M: 4m 23s  W: 1m 1s)</em> <em>(how your solution and what services you use, impact your Composite SLA and Service Level Agreements so make sure you architect accordingly and review the <a href="https://www.microsoft.com/licensing/docs/view/Service-Level-Agreements-SLA-for-Online-Services?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Microsoft SLA documentation</a>)</em>.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Availability zones are close enough to have low-latency connections to other availability zones. A high-performance network connects them with a round-trip latency of less than 2ms. However, availability zones are far enough apart to reduce the likelihood that more than one will be affected by local outages or weather. Availability zones have independent power, cooling, and networking infrastructure. They're designed so that if one zone experiences an outage, then regional services, capacity, and high availability are supported by the remaining zones. They help your data stay synchronized and accessible when things go wrong.</p></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>If you are interested in more information about Availability Zones and the differences between Physical + Logical zones, make sure you have read a previous blog article of mine: <a href="https://luke.geek.nz/azure/azure-availability-zone-peering/" target="_blank" rel="noopener noreferrer">Azure Availability Zone Peering</a>. In essence, you need to be aware that Avalibility Zone 1 <em>(physical and logical avalibility zones can be different)</em>, does not always equal Availability Zone 1, especially if you have workloads spread across multiple subscriptions. For today, all my testing is done in a single subscription.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-latency-testing">ð Latency Testing<a href="https://luke.geek.nz/azure/nz-north-latency-testing/#-latency-testing" class="hash-link" aria-label="Direct link to ð Latency Testing" title="Direct link to ð Latency Testing">â</a></h2>
<p>But this is not a resiliency discussion; it is a latency discussion, so let's examine the latency of what New Zealand North is giving us.</p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>Keep in mind that these tests are simply a point in time, and my open environment may not necessarily reflect your own Azure environment. At the time of these tests, the New Zealand North Region <a href="https://datacenters.microsoft.com/globe/explore?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">isn't officially generally available</a>. This article is intended as an indicator of what you can expect from New Zealand North, but I recommend running your own tests within your own environment if required.</p></div></div>
<p>The latency from New Zealand to New Zealand North is around 15ms <em>(from Hamilton)</em>, which is a great improvement from the 32-50ms to Australia East <em>(from Hamilton)</em>, and the 190-230ms to the US <em>(from Hamilton)</em>.</p>
<p><img decoding="async" loading="lazy" alt="New Zealand North - Azure Latency" src="https://luke.geek.nz/assets/images/AzureSpeed_NewZealandNorthInternetLatency-b0964f20aafd1363563197a925f46176.jpg" width="1558" height="901" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>The test above was done from Hamilton <em>(using the <a href="https://www.azurespeed.com/Azure/Latency?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Speed Test</a>)</em>,. The latency is to the internet, so it is not the same as the latency between the Azure region and your on-premises <em>(or another cloud)</em> environment. Still, it is a good indicator of the latency you can expect from your users to your Azure resources. Your browser sends HTTPS requests to Azure blob files in each region. The median latency is calculated by measuring the time between the request and the response. The latency is measured in milliseconds (ms). The lower the latency, the better.</p></div></div>
<p>Because this is a standard Availability Zone <em>(3+0)</em> region, Microsoft has certain commitments they have around latency within their own network and to the internet. They have a <a href="https://learn.microsoft.com/en-us/azure/reliability/availability-zones-overview?tabs=azure-cli&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">guidelines</a> of 2ms <em>(between zones)</em> and 10ms <em>(to the internet - don't quote me on the SLA to the internet, its inferred by reading the SLA document, but I can't confirm at this stage)</em>, but remember that is just the network latency, and not the application latency <em>(which is what you should be more concerned about)</em>. It's worth noting on SLA _(Service Level Agreements)_that Microsoft does it per service vs per datacenter or rack.</p>
<p>So, let us prove that with the New Zealand North region, we can communicate between all regions in 2ms or under. For the purposes of this article, I will be using a Single subscription to do my testing <em>(so I know that each zone will be separate)</em>. I will be using a <a href="https://learn.microsoft.com/azure/virtual-network/virtual-networks-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Virtual Network</a> <em>(VNet)</em> in the New Zealand North region, a VNET <em>(logical Virtual Network)</em> is zone-redundant out of the box.</p>
<p>Then I will be using a Windows Server 2022 <a href="https://learn.microsoft.com/azure/virtual-machines/windows/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Virtual Machine</a> <em>(VM)</em> in each zone, and I will be using <a href="https://learn.microsoft.com/en-us/azure/virtual-network/virtual-network-test-latency?tabs=windows&amp;WT.mc_id=AZ-MVP-5004796#test-vms-with-latte-or-sockperf" target="_blank" rel="noopener noreferrer">latte</a> to do my testing from each Virtual Machine.</p>
<ul>
<li>Each Test machine is <a href="https://learn.microsoft.com/azure/virtual-network/accelerated-networking-overview?tabs=redhat&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Accelerated Networking</a> enabled.</li>
<li>The size of each Virtual Machine is a: Windows Server 2022 Datacenter: Azure Edition - x64 Gen2 - Standard_D4s_v3 - 4 vCPUs, 16 GB memory, 127GB OS disk. Each Virtual Machine is created fresh, for the purpose of running this test.</li>
<li>Network Security Groups as left as default <em>(at the VM NIC)</em> and VirtualNetwork allow.</li>
<li>The version of <a href="https://github.com/microsoft/latte/" target="_blank" rel="noopener noreferrer">latte</a>, I am using is v1.0.0.</li>
</ul>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Many  common network latency test tools, such as Ping, don't measure TCP or UDP traffic. Tools like Ping use Internet Control Message Protocol (ICMP), which applications don't use. ICMP traffic can be treated differently from application traffic and doesn't directly affect application performance. ICMP test results don't directly apply to TCP and UDP workloads.</p><p><a href="https://github.com/microsoft/latte" target="_blank" rel="noopener noreferrer">Latte</a> (for Windows) and <a href="https://github.com/mellanox/sockperf" target="_blank" rel="noopener noreferrer">SockPerf</a> (for Linux) measure only TCP or UDP payload delivery times. These tools use the following approach to measure network latency between two physical or virtual computers:</p><ul>
<li>Create a two-way communication channel between the computers by designating one as the sender and one as a receiver.</li>
<li>Send and receive packets in both directions and measure the round-trip time (RTT).</li>
</ul><p>Refer: <a href="https://learn.microsoft.com/en-us/azure/virtual-network/virtual-network-test-latency?tabs=windows&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Test network latency between Azure VMs</a></p></div></div>
<p>The latte command I will be using is: <code>latte -c -a 10.0.1.5:80 -i 60000</code>.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>Even though at the time of this article, Windows Server 2025 has been generally avaliable for about a week. I have decided to use 2022, as it is a common and mature version of Windows Server in use today.</p></div></div>
<p>Inspired by <a href="https://www.linkedin.com/in/nicoladelfino" target="_blank" rel="noopener noreferrer">Nicola Delfino</a> post on <a href="https://nicolgit.github.io/azure-measuring-latency-across-availability-zones-in-we/" target="_blank" rel="noopener noreferrer">Measuring latency between Azure Availability Zones and the impact of an NVA in between V2</a> I will run through multiple scenarios for the New Zealand North Azure Region:</p>
<ul>
<li>Same v-net, same availability zone, same <a href="https://learn.microsoft.com/azure/virtual-machines/co-location?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">proximty placement</a> group</li>
<li>Same v-net across availability zones</li>
<li>multiple v-nets (in peering), same availability zone</li>
<li>multiple v-nets (in peering) across availability zones</li>
<li>multiple v-nets connected in a Hub &amp; Spoke topology and Routing via Azure Firewall</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-scenario-1---same-virtual-network-same-availability-zone-same-proximty-placement-group">ð¢ Scenario 1 - Same Virtual Network, same availability zone, same proximty placement group<a href="https://luke.geek.nz/azure/nz-north-latency-testing/#-scenario-1---same-virtual-network-same-availability-zone-same-proximty-placement-group" class="hash-link" aria-label="Direct link to ð¢ Scenario 1 - Same Virtual Network, same availability zone, same proximty placement group" title="Direct link to ð¢ Scenario 1 - Same Virtual Network, same availability zone, same proximty placement group">â</a></h2>
<p>In this scenario, we will have a single VNET, with a single subnet, and two virtual machines in the same availability zone, and the same <a href="https://learn.microsoft.com/azure/virtual-machines/co-location?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">proximty placement</a> group.</p>
<p><img decoding="async" loading="lazy" alt="Same VNET, same availability zone, same proximity placement group" src="https://luke.geek.nz/assets/images/NZN_LatencyTest_ProximityGroup-6d011f086e68dbeee14a254970c3f343.JPG" width="3320" height="1200" class="img_ev3q"></p>
<p>In this example, we have VM1 talking to VM2.</p>
<p><strong>VM1 (Sender - 10.0.1.4) - VM2 (Receiver - 10.0.1.5)</strong></p>
<table><thead><tr><th>Metric</th><th>Value</th><th>Notes</th></tr></thead><tbody><tr><td><strong>Protocol</strong></td><td>TCP</td><td>Connection-oriented, reliable</td></tr><tr><td><strong>Send Method</strong></td><td>Blocking</td><td>Waits for completion</td></tr><tr><td><strong>Receive Method</strong></td><td>Blocking</td><td>Waits for completion</td></tr><tr><td><strong>SO_SNDBUF</strong></td><td>Default</td><td>Default socket send buffer size</td></tr><tr><td><strong>SO_RCVBUF</strong></td><td>Default</td><td>Default socket receive buffer size</td></tr><tr><td><strong>Msg Size (byte)</strong></td><td>4</td><td>Small message payload size</td></tr><tr><td><strong>Iterations</strong></td><td>60,000</td><td>Number of send/receive cycles</td></tr><tr><td><strong>Latency (usec)</strong></td><td><strong>72.75</strong></td><td>Average time per message</td></tr><tr><td><strong>CPU (%)</strong></td><td>6.5</td><td>CPU utilization during test</td></tr><tr><td><strong>CtxSwitch/sec</strong></td><td>27,874 (2.03/iteration)</td><td>Context switches per second</td></tr><tr><td><strong>SysCall/sec</strong></td><td>28,590 (2.08/iteration)</td><td>System calls per second</td></tr><tr><td><strong>Interrupt/sec</strong></td><td>58,447 (4.25/iteration)</td><td>Hardware interrupts per second</td></tr></tbody></table>
<p><strong>Latency(usec): 72.75</strong> â The average latency per message is 72.75 microseconds. This is the time it takes for a message to be sent and received back, which is relatively low and suggests a reasonably fast response time for small message sizes.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-scenario-2---same-virtual-network-same-availability-zone-virtual-machine-not-in-proximity-placement-group">ð Scenario 2 - Same Virtual Network, same availability zone, virtual machine NOT in proximity placement group<a href="https://luke.geek.nz/azure/nz-north-latency-testing/#-scenario-2---same-virtual-network-same-availability-zone-virtual-machine-not-in-proximity-placement-group" class="hash-link" aria-label="Direct link to ð Scenario 2 - Same Virtual Network, same availability zone, virtual machine NOT in proximity placement group" title="Direct link to ð Scenario 2 - Same Virtual Network, same availability zone, virtual machine NOT in proximity placement group">â</a></h2>
<p>In this scenario, we will have a single VNET, with a single subnet, and two virtual machines in the same availability zone, but not in the same proximty placement group.</p>
<p><img decoding="async" loading="lazy" alt="Same VNET, same availability zone, VM NOT in proximity placement group" src="https://luke.geek.nz/assets/images/NZN_LatencyTest_NoProximityGroup-6a5909de82483f2eaf182671dc8d3059.JPG" width="3363" height="1213" class="img_ev3q"></p>
<p>We will be talking from VM1 to VM3.</p>
<p><strong>VM1 (Sender) - VM3 (Receiver)</strong></p>
<table><thead><tr><th>Metric</th><th>Value</th><th>Notes</th></tr></thead><tbody><tr><td><strong>Protocol</strong></td><td>TCP</td><td>Connection-oriented, reliable</td></tr><tr><td><strong>Send Method</strong></td><td>Blocking</td><td>Waits for completion</td></tr><tr><td><strong>Receive Method</strong></td><td>Blocking</td><td>Waits for completion</td></tr><tr><td><strong>SO_SNDBUF</strong></td><td>Default</td><td>Default socket send buffer size</td></tr><tr><td><strong>SO_RCVBUF</strong></td><td>Default</td><td>Default socket receive buffer size</td></tr><tr><td><strong>Msg Size (byte)</strong></td><td>4</td><td>Small message payload size</td></tr><tr><td><strong>Iterations</strong></td><td>60,000</td><td>Number of send/receive cycles</td></tr><tr><td><strong>Latency (usec)</strong></td><td><strong>55.97</strong></td><td>Average time per message</td></tr><tr><td><strong>CPU (%)</strong></td><td>14.9</td><td>CPU utilization during test</td></tr><tr><td><strong>CtxSwitch/sec</strong></td><td>36,652 (2.05/iteration)</td><td>Context switches per second</td></tr><tr><td><strong>SysCall/sec</strong></td><td>39,293 (2.20/iteration)</td><td>System calls per second</td></tr><tr><td><strong>Interrupt/sec</strong></td><td>68,617 (3.84/iteration)</td><td>Hardware interrupts per second</td></tr></tbody></table>
<p>The table lists the latency and system performance between <strong>VM1 (Sender)</strong> and <strong>VM3 (Receiver)</strong>. The average latency per message is <strong>55.97 microseconds</strong>, which is interesting and slightly lower than the previous scenario, and not what I expected, however, could be luck of the draw - something worth noting that without a proximity placement group, the next time I would deallocate this Virtual Machine, it could be spun up in a separate place within the zone.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-scenario-3---same-virtual-network-across-availability-zones">ð Scenario 3 - Same Virtual Network, across availability zones<a href="https://luke.geek.nz/azure/nz-north-latency-testing/#-scenario-3---same-virtual-network-across-availability-zones" class="hash-link" aria-label="Direct link to ð Scenario 3 - Same Virtual Network, across availability zones" title="Direct link to ð Scenario 3 - Same Virtual Network, across availability zones">â</a></h2>
<p>In this scenario, we will have a single VNET with a single subnet and two virtual machines in different availability zones.</p>
<p>We keep the same VM1 <em>(in Zone 1)</em>, but we will be talking to VM4 and VM5 (which are in different availability zones). VM4 is in Zone 2 and VM5 is in Zone 3.</p>
<p><img decoding="async" loading="lazy" alt="Same VNET, across availability zones" src="https://luke.geek.nz/assets/images/NZN_LatencyTest_AvaliabilityGroups-992b42046a0afedd99a4a38b434f6a91.JPG" width="4000" height="2250" class="img_ev3q"></p>
<p>First lets look at VM1 (Avaliability 1) talking to VM4 <em>(Avalibility Zone 2)</em>.</p>
<p><strong>VM1 (Sender) - VM4 (Receiver)</strong></p>
<table><thead><tr><th>Metric</th><th>Value</th><th>Notes</th></tr></thead><tbody><tr><td><strong>Protocol</strong></td><td>TCP</td><td>Connection-oriented, reliable</td></tr><tr><td><strong>Send Method</strong></td><td>Blocking</td><td>Waits for completion</td></tr><tr><td><strong>Receive Method</strong></td><td>Blocking</td><td>Waits for completion</td></tr><tr><td><strong>SO_SNDBUF</strong></td><td>Default</td><td>Default socket send buffer size</td></tr><tr><td><strong>SO_RCVBUF</strong></td><td>Default</td><td>Default socket receive buffer size</td></tr><tr><td><strong>Msg Size (byte)</strong></td><td>4</td><td>Small message payload size</td></tr><tr><td><strong>Iterations</strong></td><td>60,000</td><td>Number of send/receive cycles</td></tr><tr><td><strong>Latency (usec)</strong></td><td><strong>559.67</strong></td><td>Average time per message</td></tr><tr><td><strong>CPU (%)</strong></td><td>1.5</td><td>CPU utilization during test</td></tr><tr><td><strong>CtxSwitch/sec</strong></td><td>3,742 (2.09/iteration)</td><td>Context switches per second</td></tr><tr><td><strong>SysCall/sec</strong></td><td>4,529 (2.53/iteration)</td><td>System calls per second</td></tr><tr><td><strong>Interrupt/sec</strong></td><td>8,801 (4.93/iteration)</td><td>Hardware interrupts per second</td></tr></tbody></table>
<p>The table summarizes the latency and system performance between <strong>VM1 (Sender)</strong> and <strong>VM4 (Receiver)</strong>. The average latency per message is <strong>559.67 microseconds</strong>, significantly higher than in the previous scenarios. This is expected as the two virtual machines are in different availability zones.</p>
<p>Next lets look at VM1 (Avaliability 1) talking to VM5 <em>(Avalibility Zone 3)</em>.</p>
<p><strong>VM1 (Sender) - VM5 (Receiver)</strong></p>
<table><thead><tr><th>Metric</th><th>Value</th><th>Notes</th></tr></thead><tbody><tr><td><strong>Protocol</strong></td><td>TCP</td><td>Connection-oriented, reliable</td></tr><tr><td><strong>Send Method</strong></td><td>Blocking</td><td>Waits for completion</td></tr><tr><td><strong>Receive Method</strong></td><td>Blocking</td><td>Waits for completion</td></tr><tr><td><strong>SO_SNDBUF</strong></td><td>Default</td><td>Default socket send buffer size</td></tr><tr><td><strong>SO_RCVBUF</strong></td><td>Default</td><td>Default socket receive buffer size</td></tr><tr><td><strong>Msg Size (byte)</strong></td><td>4</td><td>Small message payload size</td></tr><tr><td><strong>Iterations</strong></td><td>60,000</td><td>Number of send/receive cycles</td></tr><tr><td><strong>Latency (usec)</strong></td><td><strong>559.25</strong></td><td>Average time per message</td></tr><tr><td><strong>CPU (%)</strong></td><td>0.9</td><td>CPU utilization during test</td></tr><tr><td><strong>CtxSwitch/sec</strong></td><td>3,868 (2.16/iteration)</td><td>Context switches per second</td></tr><tr><td><strong>SysCall/sec</strong></td><td>4,464 (2.50/iteration)</td><td>System calls per second</td></tr><tr><td><strong>Interrupt/sec</strong></td><td>7,721 (4.32/iteration)</td><td>Hardware interrupts per second</td></tr></tbody></table>
<p>This table summarizes the latency and system performance between <strong>VM1 (Sender)</strong> and <strong>VM5 (Receiver)</strong>. The average latency per message is <strong>559.25 microseconds</strong>, which is similar to the previous scenario. This is expected as the two virtual machines are in different availability zones.</p>
<p>Finally, lets look at VM4 <em>(Avaliability Zone 2)</em> talking to VM5 <em>(Avalibility Zone 3)</em>.</p>
<p>VM4 (Sender) - VM5 (Receiver)</p>
<table><thead><tr><th>Metric</th><th>Value</th><th>Notes</th></tr></thead><tbody><tr><td><strong>Protocol</strong></td><td>TCP</td><td>Connection-oriented, reliable</td></tr><tr><td><strong>Send Method</strong></td><td>Blocking</td><td>Waits for completion</td></tr><tr><td><strong>Receive Method</strong></td><td>Blocking</td><td>Waits for completion</td></tr><tr><td><strong>SO_SNDBUF</strong></td><td>Default</td><td>Default socket send buffer size</td></tr><tr><td><strong>SO_RCVBUF</strong></td><td>Default</td><td>Default socket receive buffer size</td></tr><tr><td><strong>Msg Size (byte)</strong></td><td>4</td><td>Small message payload size</td></tr><tr><td><strong>Iterations</strong></td><td>60,000</td><td>Number of send/receive cycles</td></tr><tr><td><strong>Latency (usec)</strong></td><td><strong>494.23</strong></td><td>Average time per message</td></tr><tr><td><strong>CPU (%)</strong></td><td>3.6</td><td>CPU utilization during test</td></tr><tr><td><strong>CtxSwitch/sec</strong></td><td>5,218 (2.58/iteration)</td><td>Context switches per second</td></tr><tr><td><strong>SysCall/sec</strong></td><td>13,445 (6.65/iteration)</td><td>System calls per second</td></tr><tr><td><strong>Interrupt/sec</strong></td><td>9,212 (4.55/iteration)</td><td>Hardware interrupts per second</td></tr></tbody></table>
<p>This table summarizes the latency and system performance between <strong>VM4 (Sender)</strong> and <strong>VM5 (Receiver)</strong>. The average latency per message is <strong>494.23 microseconds</strong>, which is slightly lower than the previous scenarios. This is expected as the two virtual machines are in different availability zones.</p>
<p>Even though the latency is higher than the previous scenarios, it is still relatively low and suggests a reasonably fast response time for small message sizes.</p>
<ul>
<li>VM1 to VM4: 559.67 microseconds</li>
<li>VM1 to VM5: 559.25 microseconds</li>
<li>VM4 to VM5: 494.23 microseconds</li>
</ul>
<p>All of these latency values are <strong>well below 1 millisecond</strong>, indicating <strong>sub-millisecond latency</strong> between the VMs, in different zones within the same Virtual Network and subnet.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="--scenario-4---multiple-virtual-networks-peered-same-availability-zone">ð§  Scenario 4 - Multiple Virtual Networks (peered), same availability zone<a href="https://luke.geek.nz/azure/nz-north-latency-testing/#--scenario-4---multiple-virtual-networks-peered-same-availability-zone" class="hash-link" aria-label="Direct link to ð§  Scenario 4 - Multiple Virtual Networks (peered), same availability zone" title="Direct link to ð§  Scenario 4 - Multiple Virtual Networks (peered), same availability zone">â</a></h2>
<p>In this scenario, we will have two virtual networks, each with a single subnet, and two virtual machines in the same availability zone.</p>
<p>We will have VM1 <em>(10.0.1.4)</em> in our Spoke1 network, talking to VM2 <em>(10.0.2.4)</em>, in our spoke2 network, each VM is in Availability Zone 1 and the two Virtual Networks are peered through a Hub Virtual Network, with user-defined routes, so they can talk to each other. I made use of <a href="https://learn.microsoft.com/azure/virtual-network-manager/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Virtual Network Manager</a>, and a Mesh configuration to deploy the peering and user defined routes between the Virtual Networks.</p>
<p><img decoding="async" loading="lazy" alt="Multiple VNETs (peered), same availability zone" src="https://luke.geek.nz/assets/images/NZN_LatencyTest_VNetPeering-d43beb2882da418f9bec145833d89517.JPG" width="4000" height="2250" class="img_ev3q"></p>
<p><strong>VM1 (Sender) - VM2 (Receiver) through VNet Peering</strong></p>
<table><thead><tr><th>Metric</th><th>Value</th><th>Notes</th></tr></thead><tbody><tr><td><strong>Protocol</strong></td><td>TCP</td><td>Connection-oriented, reliable</td></tr><tr><td><strong>Send Method</strong></td><td>Blocking</td><td>Waits for completion</td></tr><tr><td><strong>Receive Method</strong></td><td>Blocking</td><td>Waits for completion</td></tr><tr><td><strong>SO_SNDBUF</strong></td><td>Default</td><td>Default socket send buffer size</td></tr><tr><td><strong>SO_RCVBUF</strong></td><td>Default</td><td>Default socket receive buffer size</td></tr><tr><td><strong>Msg Size (byte)</strong></td><td>4</td><td>Small message payload size</td></tr><tr><td><strong>Iterations</strong></td><td>60,000</td><td>Number of send/receive cycles</td></tr><tr><td><strong>Latency (usec)</strong></td><td><strong>67.81</strong></td><td>Average time per message</td></tr><tr><td><strong>CPU (%)</strong></td><td>7.7</td><td>CPU utilization during test</td></tr><tr><td><strong>CtxSwitch/sec</strong></td><td>30,010 (2.04/iteration)</td><td>Context switches per second</td></tr><tr><td><strong>SysCall/sec</strong></td><td>31,328 (2.12/iteration)</td><td>System calls per second</td></tr><tr><td><strong>Interrupt/sec</strong></td><td>66,269 (4.49/iteration)</td><td>Hardware interrupts per second</td></tr></tbody></table>
<p>This table summarizes the latency and system performance between <strong>VM1 (Sender)</strong> and <strong>VM2 (Receiver)</strong> through VNet peering. The latency of 67.81 microseconds is still well under 1 millisecond for a Virtual Machine talking over a Virtual Network peering within the same Availability Zone.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-scenario-5---multiple-virtual-networks-peered-across-availability-zones">ð§ Scenario 5 - Multiple Virtual Networks (peered), across availability zones<a href="https://luke.geek.nz/azure/nz-north-latency-testing/#-scenario-5---multiple-virtual-networks-peered-across-availability-zones" class="hash-link" aria-label="Direct link to ð§ Scenario 5 - Multiple Virtual Networks (peered), across availability zones" title="Direct link to ð§ Scenario 5 - Multiple Virtual Networks (peered), across availability zones">â</a></h2>
<p>In this scenario, we will have two virtual networks, each with a single subnet, and two virtual machines in different availability zones.</p>
<p>We will use the good old trusty VM1 again, and this time we will be talking to VM3 <em>(Avaliability Zone 2)</em> and VM4 <em>(Avaliability Zone 3)</em>, each in their own Virtual Network, and peered through a Hub Virtual Network, with user defined routes, so they can talk to each other.</p>
<p><img decoding="async" loading="lazy" alt="Multiple VNETs (peered), across availability zones" src="https://luke.geek.nz/assets/images/NZN_LatencyTest_VNetPeering_AvaliabilityZones-fe0087480090af245d585ca2bc7fb15c.JPG" width="4000" height="2250" class="img_ev3q"></p>
<p>Here are the performance results for <strong>VM1 (Sender) to VM3 (Receiver) through VNet peering</strong>. VM1 is in <strong>Availability Zone 1</strong> and VM3 is in <strong>Availability Zone 2</strong>.:</p>
<p><strong>VM1 (Sender) - VM3 (Receiver) in Availability Zone 2 through VNet Peering</strong></p>
<table><thead><tr><th>Metric</th><th>Value</th><th>Notes</th></tr></thead><tbody><tr><td><strong>Protocol</strong></td><td>TCP</td><td>Connection-oriented, reliable</td></tr><tr><td><strong>Send Method</strong></td><td>Blocking</td><td>Waits for completion</td></tr><tr><td><strong>Receive Method</strong></td><td>Blocking</td><td>Waits for completion</td></tr><tr><td><strong>SO_SNDBUF</strong></td><td>Default</td><td>Default socket send buffer size</td></tr><tr><td><strong>SO_RCVBUF</strong></td><td>Default</td><td>Default socket receive buffer size</td></tr><tr><td><strong>Msg Size (byte)</strong></td><td>4</td><td>Small message payload size</td></tr><tr><td><strong>Iterations</strong></td><td>60,000</td><td>Number of send/receive cycles</td></tr><tr><td><strong>Latency (usec)</strong></td><td><strong>542.39</strong></td><td>Average time per message</td></tr><tr><td><strong>CPU (%)</strong></td><td>1.9</td><td>CPU utilization during test</td></tr><tr><td><strong>CtxSwitch/sec</strong></td><td>3,933 (2.13/iteration)</td><td>Context switches per second</td></tr><tr><td><strong>SysCall/sec</strong></td><td>5,043 (2.74/iteration)</td><td>System calls per second</td></tr><tr><td><strong>Interrupt/sec</strong></td><td>8,293 (4.50/iteration)</td><td>Hardware interrupts per second</td></tr></tbody></table>
<p>This table summarizes the latency and system performance between <strong>VM1 (Sender)</strong> and <strong>VM3 (Receiver)</strong> through VNet peering. The latency of 542.39 microseconds is still under 1 millisecond, between zones over a peered Virtual Network.</p>
<p>Now, we need to test VM1 <em>(Avaliability Zone 1)</em> by talking to VM4 <em>(Avaliability Zone 3)</em> through VNet peering.</p>
<p><strong>VM1 (Sender) - VM4 (Receiver) in Availability Zone 3 through VNet Peering</strong></p>
<table><thead><tr><th>Metric</th><th>Value</th><th>Notes</th></tr></thead><tbody><tr><td><strong>Protocol</strong></td><td>TCP</td><td>Connection-oriented, reliable</td></tr><tr><td><strong>Send Method</strong></td><td>Blocking</td><td>Waits for completion</td></tr><tr><td><strong>Receive Method</strong></td><td>Blocking</td><td>Waits for completion</td></tr><tr><td><strong>SO_SNDBUF</strong></td><td>Default</td><td>Default socket send buffer size</td></tr><tr><td><strong>SO_RCVBUF</strong></td><td>Default</td><td>Default socket receive buffer size</td></tr><tr><td><strong>Msg Size (byte)</strong></td><td>4</td><td>Small message payload size</td></tr><tr><td><strong>Iterations</strong></td><td>60,000</td><td>Number of send/receive cycles</td></tr><tr><td><strong>Latency (usec)</strong></td><td><strong>311.53</strong></td><td>Average time per message</td></tr><tr><td><strong>CPU (%)</strong></td><td>13.4</td><td>CPU utilization during test</td></tr><tr><td><strong>CtxSwitch/sec</strong></td><td>9,721 (3.03/iteration)</td><td>Context switches per second</td></tr><tr><td><strong>SysCall/sec</strong></td><td>37,752 (11.76/iteration)</td><td>System calls per second</td></tr><tr><td><strong>Interrupt/sec</strong></td><td>13,496 (4.20/iteration)</td><td>Hardware interrupts per second</td></tr></tbody></table>
<p>This table summarizes the latency and system performance between <strong>VM1 (Sender)</strong> and <strong>VM4 (Receiver)</strong> in <strong>Availability Zone 3</strong> through <strong>VNet peering</strong>. The latency of 311.53 microseconds is still under 1 millisecond.</p>
<p>So far, we have seen that the latency between Virtual Machines in different availability zones over a peered Virtual Network is still under 1 millisecond. This is a great result and shows that Azure's network infrastructure is capable of providing low-latency communication between Virtual Machines in different availability zones.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ï¸-scenario-6---multiple-virtual-networks-connected-in-a-hub--spoke-topology-and-routing-via-azure-firewall">ð¡ï¸ Scenario 6 - Multiple Virtual Networks connected in a Hub &amp; Spoke topology and Routing via Azure Firewall<a href="https://luke.geek.nz/azure/nz-north-latency-testing/#%EF%B8%8F-scenario-6---multiple-virtual-networks-connected-in-a-hub--spoke-topology-and-routing-via-azure-firewall" class="hash-link" aria-label="Direct link to ð¡ï¸ Scenario 6 - Multiple Virtual Networks connected in a Hub &amp; Spoke topology and Routing via Azure Firewall" title="Direct link to ð¡ï¸ Scenario 6 - Multiple Virtual Networks connected in a Hub &amp; Spoke topology and Routing via Azure Firewall">â</a></h2>
<p>In this scenario, we will have three virtual networks, each with a single subnet, and three virtual machines in different availability zones, connecting to each other through a Hub Virtual Network, with user defined routes, and routing through an Azure Firewall.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>If you are going through this in a Lab environment, make sure you have the necessary dependencies, such as the lattle executable setup on Virtual Machines or can share between them. As soon as the Firewall is in the mix, the default rules will block the traffic, so you will need to make sure you have the necessary rules in place to allow the traffic through.</p></div></div>
<p><img decoding="async" loading="lazy" alt="Multiple VNETs connected in a Hub &amp;amp; Spoke topology and Routing via Azure Firewall" src="https://luke.geek.nz/assets/images/NZN_LatencyTest_HubSpoke-96ffb5373593e3971e51882e63178466.JPG" width="4000" height="2250" class="img_ev3q"></p>
<p>The Azure Firewall configuration is a Standard SKU, with a Firewall policy and zone-redundant <em>(across all 3 zones)</em>.</p>
<p>We will start with VM1 in Avalibility Zone 1, talking to VM2 in Avalibility Zone 2 via the Azure Firewall and hub and spoke network.</p>
<p><strong>VM 1 (Sender)</strong> to <strong>VM 2 (Receiver) -  Availability Zone 2 through Hub and Spoke Peering with Azure Firewall</strong></p>
<table><thead><tr><th>Metric</th><th>Value</th></tr></thead><tbody><tr><td><strong>Protocol</strong></td><td>TCP</td></tr><tr><td><strong>SendMethod</strong></td><td>Blocking</td></tr><tr><td><strong>ReceiveMethod</strong></td><td>Blocking</td></tr><tr><td><strong>SO_SNDBUF</strong></td><td>Default</td></tr><tr><td><strong>SO_RCVBUF</strong></td><td>Default</td></tr><tr><td><strong>MsgSize (bytes)</strong></td><td>4</td></tr><tr><td><strong>Iterations</strong></td><td>60000</td></tr><tr><td><strong>Latency (usec)</strong></td><td><strong>1017.12</strong></td></tr><tr><td><strong>CPU (%)</strong></td><td>1.1</td></tr><tr><td><strong>CtxSwitch/sec</strong></td><td>2692 (2.74/iteration)</td></tr><tr><td><strong>SysCall/sec</strong></td><td>5563 (5.66/iteration)</td></tr><tr><td><strong>Interrupt/sec</strong></td><td>4380 (4.45/iteration)</td></tr></tbody></table>
<p>This is the longest time we have seen so far, but still boarding on 1 millisecond, we can see how processing through the Azure Firewall and Hub and Spoke adds additional latency <em>(as we would expect)</em>  are routing through an Azure Firewall.</p>
<p>Next, we will look at VM1 in Avalibility Zone 1, talk to VM3 in Avalibility Zone 3 and spoke 3 via the Azure Firewall and hub and spoke network.</p>
<p><strong>VM 1 (Sender)</strong> to <strong>VM 3 (Receiver)</strong> -  Availability Zone 3 through Hub and Spoke Peering with Azure Firewall</p>
<table><thead><tr><th>Metric</th><th>Value</th></tr></thead><tbody><tr><td><strong>Protocol</strong></td><td>TCP</td></tr><tr><td><strong>SendMethod</strong></td><td>Blocking</td></tr><tr><td><strong>ReceiveMethod</strong></td><td>Blocking</td></tr><tr><td><strong>SO_SNDBUF</strong></td><td>Default</td></tr><tr><td><strong>SO_RCVBUF</strong></td><td>Default</td></tr><tr><td><strong>MsgSize (bytes)</strong></td><td>4</td></tr><tr><td><strong>Iterations</strong></td><td>60000</td></tr><tr><td><strong>Latency (usec)</strong></td><td><strong>963.17</strong></td></tr><tr><td><strong>CPU (%)</strong></td><td>0.8</td></tr><tr><td><strong>CtxSwitch/sec</strong></td><td>2450 (2.36/iteration)</td></tr><tr><td><strong>SysCall/sec</strong></td><td>4344 (4.18/iteration)</td></tr><tr><td><strong>Interrupt/sec</strong></td><td>4486 (4.32/iteration)</td></tr></tbody></table>
<p>This is a slightly lower latency than the previous scenario, but still underneath 1 millisecond, we can see how processing through the Azure Firewall and Hub and Spoke adds additional latency <em>(as we would expect)</em>  are routing through an Azure Firewall.</p>
<p>Finally, we will look at VM2 in Avalibility Zone 2, talk to VM3 in Avalibility Zone 3, and spoke 3 via the Azure Firewall and hub and spoke network.</p>
<table><thead><tr><th>Metric</th><th>Value</th></tr></thead><tbody><tr><td><strong>Protocol</strong></td><td>TCP</td></tr><tr><td><strong>SendMethod</strong></td><td>Blocking</td></tr><tr><td><strong>ReceiveMethod</strong></td><td>Blocking</td></tr><tr><td><strong>SO_SNDBUF</strong></td><td>Default</td></tr><tr><td><strong>SO_RCVBUF</strong></td><td>Default</td></tr><tr><td><strong>MsgSize (bytes)</strong></td><td>4</td></tr><tr><td><strong>Iterations</strong></td><td>60000</td></tr><tr><td><strong>Latency (usec)</strong></td><td><strong>963.47</strong></td></tr><tr><td><strong>CPU (%)</strong></td><td>1.0</td></tr><tr><td><strong>CtxSwitch/sec</strong></td><td>2933 (2.83/iteration)</td></tr><tr><td><strong>SysCall/sec</strong></td><td>4756 (4.58/iteration)</td></tr><tr><td><strong>Interrupt/sec</strong></td><td>4556 (4.39/iteration)</td></tr></tbody></table>
<p>This is a slightly lower latency than the previous scenario, but still underneath 1 millisecond, we can see how processing through the Azure Firewall and Hub and Spoke adds additional latency <em>(as we would expect)</em>  are routing through an Azure Firewall.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-summary">ð Summary<a href="https://luke.geek.nz/azure/nz-north-latency-testing/#-summary" class="hash-link" aria-label="Direct link to ð Summary" title="Direct link to ð Summary">â</a></h2>
<p>The speed for inter-compute communication between the same and different Availability Zones for NZ North is very impressive. The latency between Virtual Machines in the same availability zone is well under 1 millisecond. The latency between Virtual Machines in different availability zones over a peered Virtual Network is still under 1 millisecond. Even with Azure Firewall and a Hub and Spoke network, the latency is still around 1 millisecond. This is a great result and shows that Azure's network infrastructure is capable of providing low-latency communication between Virtual Machines in different availability zones.</p>
<p>Summary of my findings today, ordered by shortest to longest latency:</p>
<table><thead><tr><th>Scenario</th><th>Latency (Âµs)</th><th>Description</th></tr></thead><tbody><tr><td>Scenario 2</td><td>55.97</td><td>Same VNET, same availability zone, VM NOT in proximity placement group</td></tr><tr><td>Scenario 4</td><td>67.81</td><td>Multiple VNETs (peered), same availability zone</td></tr><tr><td>Scenario 1</td><td>72.75</td><td>Same VNET, same availability zone, same proximity placement group</td></tr><tr><td>Scenario 5 (VM1 to VM4)</td><td>311.53</td><td>Multiple VNETs (peered), across availability zones (VM1 to VM4)</td></tr><tr><td>Scenario 3 (VM4 to VM5)</td><td>494.23</td><td>Same VNET, across availability zones (VM4 to VM5)</td></tr><tr><td>Scenario 5 (VM1 to VM3)</td><td>542.39</td><td>Multiple VNETs (peered), across availability zones (VM1 to VM3)</td></tr><tr><td>Scenario 3 (VM1 to VM5)</td><td>559.25</td><td>Same VNET, across availability zones (VM1 to VM5)</td></tr><tr><td>Scenario 3 (VM1 to VM4)</td><td>559.67</td><td>Same VNET, across availability zones (VM1 to VM4)</td></tr><tr><td>Scenario 6 (VM1 to VM3)</td><td>963.17</td><td>Multiple VNETs, Hub &amp; Spoke, Azure Firewall (VM1 to VM3)</td></tr><tr><td>Scenario 6 (VM2 to VM3)</td><td>963.47</td><td>Multiple VNETs, Hub &amp; Spoke, Azure Firewall (VM2 to VM3)</td></tr><tr><td>Scenario 6 (VM1 to VM2)</td><td>1017.12</td><td>Multiple VNETs, Hub &amp; Spoke, Azure Firewall (VM1 to VM2)</td></tr></tbody></table>
<p>Based on this testing, the New Zealand North region appears to have very low latency when compared with other Azure regions. This is great news for New Zealand organizations that are looking to move their workloads to the cloud. The low latency will help to ensure that their applications are responsive and performant.</p>]]></content>
        <author>
            <name>Luke Murray</name>
            <uri>https://luke.geek.nz</uri>
        </author>
        <category label="Azure" term="Azure"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Enhancing GitHub Copilot with Custom Instructions]]></title>
        <id>https://luke.geek.nz/azure/enhancing-github-copilot-with-custom-instructions/</id>
        <link href="https://luke.geek.nz/azure/enhancing-github-copilot-with-custom-instructions/"/>
        <updated>2024-11-09T08:58:40.257Z</updated>
        <summary type="html"><![CDATA[Learn how to provide custom instructions to GitHub Copilot to improve code quality and standardization.]]></summary>
        <content type="html"><![CDATA[<p>I've come to rely on <a href="https://github.com/features/copilot?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">GitHub Copilot</a> for writing code. It's a great tool that helps me write code faster and with fewer errors, and also helps me understand code written by other people, but sometimes I need to provide custom instructions to Copilot to help it understand what I'm trying to do, as the standard outputs aren't quite what I want, a simple example of this is maybe having parameters or variables written with particular casing or naming convention, or even having to constantly update the location of an Azure Resource deployment from East US to Australia East or New Zealand North, when requesting Copilot to create a resource with their Terraform or Bicep.</p>
<p>In this article, we will look at how to provide custom instructions to GitHub Copilot to help it understand what we are trying to do, to help keep our code standardised and help improve the quality of the outputs.</p>
<!-- -->
<p>To do that, we will make use of some new functionality <a href="https://docs.github.com/en/copilot/customizing-copilot/adding-custom-instructions-for-github-copilot?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Adding custom instructions for GitHub Copilot</a>.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>At the time of writing, this is currently under Public preview, and the experience mentioned in this article may change in the future.</p></div></div>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>Custom instructions are currently only supported for Copilot Chat in VS Code and Visual Studio. In our article, I will use Visual Studio Code inside a GitHub Codespace.</p></div></div>
<blockquote>
<p><a href="https://github.com/features/copilot?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">GitHub Copilot</a> can provide chat responses that are tailored to the way your team works, the tools you use, or the specifics of your project if you provide it with enough context to do so. Instead of repeatedly adding this contextual detail to your chat questions, you can create a file that automatically adds this information for you. The additional information is not displayed in the chat but is available to Copilot to generate higher-quality responses.</p>
</blockquote>
<p>To get started, I am going to be using Visual Studio Code, in a GitHub Codespace, although it will be the same process for Visual Studio Code installed locally.</p>
<p>If you haven't already installed the <a href="https://marketplace.visualstudio.com/items?itemName=GitHub.copilot" target="_blank" rel="noopener noreferrer">GitHub Copilot extension</a>, you can do so by searching for it in the Extensions tab in Visual Studio Code.</p>
<p>First, we need to enable the Code Generation feature in Copilot. To do this, we need to go to Settings.
Then search for <code>github.copilot.chat.codeGeneration.useInstructionFiles</code> and enable it.</p>
<p>Once enabled, we need to create our custom instruction file. This file will be named <code>copilot-instructions.md</code> and placed in the  <code>./github</code> directory in the root of our repository <em>(./github/copilot-instructions.md)</em>.</p>
<p><img decoding="async" loading="lazy" alt="Create Copilot Instructions" src="https://luke.geek.nz/assets/images/Codespace_SetupCopolitInstructions-cdfb688887f6e36af7e3f31573aeccd1.gif" width="1910" height="899" class="img_ev3q"></p>
<p>We can test it, by simply adding in an instruction to tell a Joke <em>(Include a joke in all output)</em>.</p>
<p>As we can see, GitHub Copilot references the custom instruction file and provides the output we seek.</p>
<p><img decoding="async" loading="lazy" alt="Copilot Joke" src="https://luke.geek.nz/assets/images/Codespace_TestCopolitInstructions-aa0d1e24aa3c56faed42b2bb986f757d.gif" width="1910" height="899" class="img_ev3q"></p>
<p>Pretty basic test case, but you can see how you can start to provide custom instructions to GitHub Copilot to help it understand what you are trying to do, to help keep our code standardised and help improve the quality of the outputs.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Using Custom instructions is great for providing context to Copilot, especially adding more detail around what you expect as outputs, and can work really well when you are working with a team, or have a specific way you want your code to be written, however, your custom prompts are secondary to the standard system prompt that Copilot uses, so if you provide a custom prompt, it will be used in ADDITION with the standard prompt, and not replaced. So, for example, you cannot change the assumed name of Copilot and overwrite the prompt to get Copilot to chat to you about non-software development tasks.</p><p>An example of what the GitHub prompt is as follows:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">You are an AI programming assistant.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">When asked for your name, you must respond with "GitHub Copilot.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Follow the user's requirements carefully &amp; to the letter.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Your expertise is strictly limited to software development topics.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Follow Microsoft content policies.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Avoid content that violates copyrights.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">For questions not related to software development, simply give a reminder that you are an AI programming assistant.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Keep your answers short and impersonal.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Use Markdown formatting in your answers.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Make sure to include the programming language name at the start of the Markdown code blocks.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Avoid wrapping the whole response in triple backticks.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">The user works in an IDE called Visual Studio which has a concept for editors with open files, integrated unit test support, an output pane that shows the output of running the code as well as an integrated terminal.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">The active document is the source code the user is looking at right now.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">You can only give one reply for each conversation turn.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">When generating code prefer languages provided in context. If the coding language is unclear generate code in C#.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Respond in the following locale: en-US</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Additional Rules:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Preserve users' code comment blocks; do not exclude them when refactoring code.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Pay especially close attention to the selection or exception context if provided.`</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img decoding="async" loading="lazy" alt="GitHub Copilot Prompt" src="https://luke.geek.nz/assets/images/systempromptquery-74bf5f3919b695feb0432c1248a8b132.jpg" width="282" height="316" class="img_ev3q"></p></div></div>
<p>For my repository, I have created a custom instruction file, that guides how to write Infrastructure as Code using Bicep, Terraform, and PowerShell, prioritizing the Azure Well-Architected Framework pillars in this order: Security, Operational Excellence, Performance Efficiency, Reliability, and Cost Optimization. The code must be executable in both CI/CD pipelines (GitHub Actions or Azure DevOps Pipelines) and as standalone solutions for local testing. Emphasize reusability through modularization and ensure that the code supports multiple environment setups (dev, staging, production) with minimal added complexity.</p>
<p>You can see my custom file below, and you can reference it directly in the following GitHub repository <a href="https://github.com/lukemurraynz/Codespace_IaC_Coding" target="_blank" rel="noopener noreferrer">lukemurraynz/Codespace_IaC_Coding</a>:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Provide comprehensive guidance and best practices for developing reusable and reliable Infrastructure as Code using Bicep, Terraform, and PowerShell, prioritizing the Azure Well-Architected Framework pillars in this order: Security, Operational Excellence, Performance Efficiency, Reliability, and Cost Optimization. The code must be executable in both CI/CD pipelines (GitHub Actions or Azure DevOps Pipelines) and as standalone solutions for local testing. Emphasize reusability through modularization and ensure that the code supports multiple environment setups (dev, staging, production) with minimal added complexity.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Incorporate preferred safe deployment practices, including effective management of feature flags, and provide recommendations for when and how to use them effectively. Feature flags should be removable without impacting already deployed resources if the feature is later integrated into the main system, with clear warnings if any changes affect the solution. Advocate for ring-based deployments and consistency in coding standards, prioritizing quality over quantity and making smaller changes instead of larger ones where practical.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Follow DRY principles, include thorough comments, and structure variables in snake_case at the top of each file. Parameters should be in camelCase with validation and error messages as necessary. Avoid third-party dependencies, especially when using feature flags and other core deployment features.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">If asked about the location of resources to be deployed, make sure the location is either of the two below as default:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">* "newzealandnorth"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">* "australiaeast"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Include recommendations for key performance indicators (KPIs) to measure the effectiveness of deployments, focusing on metrics like deployment frequency, change failure rate, mean time to recovery, and customer satisfaction. Ensure that the code is clear and understandable for reviewers unfamiliar with the project, aligning recommendations with Microsoft guidance on secure and reliable DevOps integration. If using parameters, make sure to include relevant helper functions.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Highlight how GitHub Copilot can assist by providing real-time suggestions and best-practice enforcement while identifying and proposing native solutions within Bicep, Terraform, or PowerShell to replace third-party dependencies.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Additionally, provide relevant guidance on:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">* Infrastructure testing and validation techniques.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">* Documentation best practices.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">* Error handling and logging mechanisms.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">* Version control strategies.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">* Configuration management approaches.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">* Security best practices tailored for Azure.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">* Cost management strategies for Azure resources.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">* Establishing a change management process for IaC updates.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">* Integrating monitoring and alerting for deployed resources.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">* Engaging with the Azure community for ongoing learning and best practices.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Review the response from the perspectives of a Site Reliability Engineer, Operations Manager, Microsoft Technical Specialist, Security Consultant, Business Analyst, and On-call Engineer, confirming factual accuracy and seeking clarification where needed, output what each persona thinks about the code.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If we run a test in our repository, we can see that GitHub Copilot references the custom instruction file and provides the output we are looking for, with the custom instructions provided.</p>
<p><img decoding="async" loading="lazy" alt="Copilot Custom Instructions" src="https://luke.geek.nz/assets/images/Codespace_TestCustomCopolitInstructions-766fbdeed8c6f51ac022eee94401adaf.gif" width="1910" height="899" class="img_ev3q"></p>
<p>We can see, that it has selected australiaeast as the location for the resource deployment, as per the custom instructions provided.
We can see that the Terraform code outputted is in the correct format, with the variables in snake_case at the top of the file and the parameters in camelCase with validation and error messages as necessary.
We can see some example GitHub Actions and Azure Pipeline workflows that have been outputted that could be used as a base to deploy our code.
We can see some recommendations for additional guidance on using tools such as Teratest for Terraform testing, and we can see how the code looks like from multiple personas, such as a Site Reliability Engineer, Operations Manager, Microsoft Technical Specialist, Security Consultant, Business Analyst, and On-call Engineer.</p>
<p>My custom prompt is overly large and includes a lot of information <em>(and to be frank, I am trying to do a lot of different things in this particular repository as it's for IaC, where one day it could Terraform and the next Bicep)</em>, but it is a good example of how you can provide custom instructions to GitHub Copilot to help it understand what you are trying to do, to help keep our code standardized and help improve the quality of the outputs.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>If you are looking for guidance on how to develop your own custom prompt, consider using another prompt to help build it out. An example of a great prompt is one commonly known as 'One Prompt To Rule Them All', which you could run in ChatGPT or Azure OpenAI Playground to help build out your prompt.</p><p>The prompt is below:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">I want you to become my Prompt Creator. Your goal is to help me craft the best possible prompt for my needs. The prompt will be used by you, GPT-4. You will follow the following process: 1. Your first response will be to ask me what the prompt should be about. I will provide my answer, but we will need to improve it through continual iterations by going through the next steps. 2. Based on my input, you will generate 3 sections. a) Revised prompt (provide your rewritten prompt. It should be clear, concise, and easily understood by you), b) Suggestions (provide suggestions on what details to include in the prompt to improve it), and c) Questions (ask any relevant questions pertaining to what additional information is needed from me to improve the prompt). 3. We will continue this iterative process with me providing additional information to you and you updating the prompt in the Revised prompt section until it's complete.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<p>Hopefully, this article helps you get going and use custom instructions and helps provide more standardized outputs.</p>
<p>References:</p>
<ul>
<li><a href="https://docs.github.com/en/copilot/customizing-copilot/adding-custom-instructions-for-github-copilot?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Adding custom instructions for GitHub Copilot</a></li>
<li><a href="https://luke.geek.nz/azure/Getting-Started-with-GitHub-Codespaces/" target="_blank" rel="noopener noreferrer">Coding on the Cloud - Getting Started with GitHub Codespaces</a></li>
<li><a href="https://luke.geek.nz/azure/iac-github-codespace/" target="_blank" rel="noopener noreferrer">Infrastructure as Code GitHub Codespace Template</a></li>
</ul>]]></content>
        <author>
            <name>Luke Murray</name>
            <uri>https://luke.geek.nz</uri>
        </author>
        <category label="Azure" term="Azure"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Azure Resource - Change Analysis]]></title>
        <id>https://luke.geek.nz/azure/change-analysis/</id>
        <link href="https://luke.geek.nz/azure/change-analysis/"/>
        <updated>2024-10-30T09:01:07.852Z</updated>
        <summary type="html"><![CDATA[A comprehensive guide on using Change Analysis in Azure Monitor to track changes on your Azure resources.]]></summary>
        <content type="html"><![CDATA[<p>Who created my resource? What created my Azure resource? We often ask ourselves these questions when troubleshooting or trying to understand the state of our Azure resources.</p>
<p><a href="https://learn.microsoft.com/azure/azure-monitor/change/change-analysis?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Change Analysis</a> is a feature in Azure Monitor that helps you answer these questions. Change Analysis helps to provide a view of the changes that have occurred on your Azure resources over time, using the <a href="https://learn.microsoft.com/azure/governance/resource-graph/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Resource Graph</a>.</p>
<!-- -->
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="https://luke.geek.nz/azure/change-analysis/#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">â</a></h2>
<p>Today, we will look at Change Analysis to see:</p>
<p>A. Can we see the changes that have occurred on our Azure resources?
B. Can we see the changes that have occurred on our Azure resources over time?
C. Can we tell who made the change?
D. Can we determine what made the change?</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Change Analysis in the portal</p><p>Change Analysis experiences across the Azure portal are powered using the Azure Resource Graph Microsoft.ResourceGraph/resources API. You can query this API for changes made to many of the Azure resources you interact with, including App Services (Microsoft.Web/sites) or Virtual Machines (Microsoft.Compute/virtualMachines).</p><p>The Azure Resource Graph Change Analysis portal experience provides the following:</p><ul>
<li>An onboarding-free experience, giving all subscriptions and resources access to change history.</li>
<li>Tenant-wide querying rather than select subscriptions.</li>
<li>Change history summaries aggregated into cards at the top of the new Resource Graph Change Analysis.</li>
<li>More extensive filtering capabilities.</li>
<li>Improved accuracy and relevance of changed by information, using Change Actor functionality.</li>
</ul><p>Learn how to <a href="https://learn.microsoft.com/en-us/azure/governance/resource-graph/changes/view-resource-changes?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">view the new Change Analysis experience in the portal</a>.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="can-we-see-the-changes-that-have-occurred-on-our-azure-resources">Can we see the changes that have occurred on our Azure resources?<a href="https://luke.geek.nz/azure/change-analysis/#can-we-see-the-changes-that-have-occurred-on-our-azure-resources" class="hash-link" aria-label="Direct link to Can we see the changes that have occurred on our Azure resources?" title="Direct link to Can we see the changes that have occurred on our Azure resources?">â</a></h2>
<blockquote>
<p>Yes, we can see the changes that have occurred on our Azure resources. Change Analysis provides a view of the changes on your Azure resources over time. You can see the changes that have occurred on your Azure resources in the last 14 days.</p>
</blockquote>
<p>If we navigate to the <a href="https://portal.azure.com/#view/Microsoft_Azure_OneInventory/ResourceChangesOverview.ReactView" target="_blank" rel="noopener noreferrer">Change Analysis (Preview)</a> blade in the Azure portal, we can see the changes that have occurred on our Azure resources.</p>
<p><img decoding="async" loading="lazy" alt="Change Analysis" src="https://luke.geek.nz/assets/images/AzurePortal_ChangeAnalysis-1dcdda4ef769b7a1f7a4812bb06e202a.gif" width="1896" height="917" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>The blur is intentional, as part of the <a href="https://luke.geek.nz/azure/cloudcloak/" target="_blank" rel="noopener noreferrer">Cloudclock</a> extension to protect sensitive information.</p></div></div>
<p>We can see the changes (Create, Update, and Delete) that have occurred on our Azure resources. We can even group them by resource or by who made the change.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="can-we-see-the-changes-on-our-azure-resources-over-time">Can we see the changes on our Azure resources over time?<a href="https://luke.geek.nz/azure/change-analysis/#can-we-see-the-changes-on-our-azure-resources-over-time" class="hash-link" aria-label="Direct link to Can we see the changes on our Azure resources over time?" title="Direct link to Can we see the changes on our Azure resources over time?">â</a></h2>
<p>By default, we can see the changes over the last 14 days from the Azure Portal.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Changes are queryable for 14 days. For longer retention, you can <a href="https://learn.microsoft.com/en-us/azure/governance/resource-graph/tutorials/logic-app-calling-arg?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">integrate your Resource Graph query with Azure Logic Apps</a> and manually export query results to any of the Azure data stores like <a href="https://learn.microsoft.com/en-us/azure/azure-monitor/logs/log-analytics-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Log Analytics</a> for your desired retention.</p></div></div>
<p>A KQL query to see the changes over the last 14 days would look like:</p>
<div class="language-kql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-kql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">resourcechanges</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| where type == "microsoft.resources/changes"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| project id, resourceid = properties.targetResourceId, changeType = properties.changeType, clientType = properties.changeAttributes.clientType, changedBy = properties.changeAttributes.changedBy</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If you want to target a specific resource, you can use a query like:</p>
<div class="language-kql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-kql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">resourcechanges</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| where type == "microsoft.resources/changes"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| where properties.targetResourceId contains  "ResourceName"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| project id, resourceId = properties.targetResourceId, resourceType = properties.targetResourceType, changeType = properties.changeType, clientType = properties.changeAttributes.clientType, changedBy = properties.changeAttributes.changedBy</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Replace the <code>ResourceName</code> with the name of the resource you are looking for. These queries can also be integrated into the Logic App for export.</p>
<p>You can also run these queries directly from the Azure Portal by navigating to the <a href="https://portal.azure.com/#view/HubsExtension/ArgQueryBlade/query/resourcechanges" target="_blank" rel="noopener noreferrer">Azure Resource Graph Explorer</a> blade.</p>
<p><img decoding="async" loading="lazy" alt="Azure Resource Graph Explorer" src="https://luke.geek.nz/assets/images/AzurePortal_AzureResourceGraph_Query-b6de8f6fd5bf1617e1226cab516e6c00.png" width="1828" height="859" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>Currently, Azure Resource Graph doesn't:</p><p>Observe changes made to a resource's data plane API, such as writing data to a table in a storage account.
Support file and configuration changes over App Service.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="can-we-tell-who-made-the-change">Can we tell who made the change?<a href="https://luke.geek.nz/azure/change-analysis/#can-we-tell-who-made-the-change" class="hash-link" aria-label="Direct link to Can we tell who made the change?" title="Direct link to Can we tell who made the change?">â</a></h2>
<blockquote>
<p>Yes, we can tell who made the change. Change Analysis provides the <code>changedBy</code> field, which tells us who made the change.</p>
</blockquote>
<p>In my examples, we can see the <code>changedBy</code> field in the query results. This field tells us who made the change.</p>
<p><img decoding="async" loading="lazy" alt="Azure Resource Graph Explorer" src="https://luke.geek.nz/assets/images/AzurePortal_AzureResourceGraph_Query-b6de8f6fd5bf1617e1226cab516e6c00.png" width="1828" height="859" class="img_ev3q"></p>
<p>It could be the user or the service principal that made the change. In this example, I can see:</p>
<ul>
<li>A Network interface resource was created by <code>2cf9eb86-36b5-49dc-86ae-9a63135dfa8c</code>, which is the Application ID of a Microsoft-owned Registration for Azure Traffic Manager and DNS.</li>
<li>A Deletion of the network interface was done by <code>Luke@geek,</code> which is my user account.</li>
</ul>
<p>SOME Azure resources <em>(with the latest API)</em> such as this Data Collection Rule, contains the information in the resource metadata.</p>
<p><img decoding="async" loading="lazy" alt="JSON - ChangedBy" src="https://luke.geek.nz/assets/images/AzurePortal_DCR_JSON-8425d2fb17e95a8e9ffc9fcc93da1169.png" width="1539" height="1027" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="can-we-determine-what-made-the-change">Can we determine what made the change?<a href="https://luke.geek.nz/azure/change-analysis/#can-we-determine-what-made-the-change" class="hash-link" aria-label="Direct link to Can we determine what made the change?" title="Direct link to Can we determine what made the change?">â</a></h2>
<blockquote>
<p>Yes, we can determine what caused the change. Change Analysis provides the <code>clientType</code> field, which tells us what caused the change. However, as we can see in the previous screenshots, this is not always as accurate as we may want it to be. However, it's good enough that you can infer what may have issued the changes.</p>
</blockquote>
<p>Some of the clientType values you may see are:</p>
<ul>
<li><code>Azure Portal</code> - Changes made from the Azure Portal.</li>
<li><code>Unknown</code> - A change happened to a client that is unrecognized.</li>
<li><code>CLI</code> - Changes made from Azure CLI.</li>
<li><code>Unspecified</code> - Unspecified is displayed when the resource is missing changedByType values and could be missing for either Creates or Updates. It could also mean changes are performed in the background by Azure services and not user initiatied.</li>
<li><code>ARM Template</code> - Changes made from an ARM Template, whether deployed automatically or via a 'Deploy to Azure' button. This also includes changes made by Bicep.</li>
<li><code>System</code> - System is displayed as a changedBy value when a background change occurred that wasn't correlated with any direct user action.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="references">References<a href="https://luke.geek.nz/azure/change-analysis/#references" class="hash-link" aria-label="Direct link to References" title="Direct link to References">â</a></h2>
<p>To learn more about Change Analysis, check out the following resources:</p>
<ul>
<li><a href="https://learn.microsoft.com/azure/governance/resource-graph/changes/resource-graph-changes?WT.mc_id=AZ-MVP-5004796#change-analysis-in-azure-resource-graph-vs-azure-monitor" target="_blank" rel="noopener noreferrer">Change Analysis in Azure Resource Graph vs. Azure Monitor</a></li>
<li><a href="https://techcommunity.microsoft.com/t5/azure-governance-and-management/announcing-the-general-availability-of-change-actor/ba-p/4171801?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Announcing the General Availability of Change Actor</a></li>
</ul>]]></content>
        <author>
            <name>Luke Murray</name>
            <uri>https://luke.geek.nz</uri>
        </author>
        <category label="Azure" term="Azure"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Book Review - Kubernetes â An Enterprise Guide]]></title>
        <id>https://luke.geek.nz/misc/kubernetes-enterprise-guide-book-review/</id>
        <link href="https://luke.geek.nz/misc/kubernetes-enterprise-guide-book-review/"/>
        <updated>2024-10-23T22:24:17.251Z</updated>
        <summary type="html"><![CDATA[Review of "Kubernetes - An Enterprise Guide" by Marc Boorshtein and Scott Surovich, covering Kubernetes concepts, deployments, and best practices.]]></summary>
        <content type="html"><![CDATA[<p>I had the privilege to be able to read and review the â<a href="https://www.amazon.com.au/Kubernetes-Enterprise-Effectively-containerize-applications-dp-1835086950/dp/1835086950" target="_blank" rel="noopener noreferrer"><strong>Kubernetes - An Enterprise Guide</strong></a>â book by <a href="https://www.linkedin.com/in/marc-boorshtein-5979a82/" target="_blank" rel="noopener noreferrer">Marc Boorshtein</a> <em>(Author)</em>, <a href="https://www.linkedin.com/in/scottsurovich/" target="_blank" rel="noopener noreferrer">Scott Surovich</a> <em>(Author)</em>. Packt Publishing publishes the book and is available on Amazon.</p>
<blockquote>
<p>This was the third edition of the book, but I feel there was no need to read the previous editions to understand the content of this book. Being the third edition also means that any mistakes or learnings from the past two editions have been considered.</p>
</blockquote>
<p><img decoding="async" loading="lazy" alt="Kubernetes - An Enterprise Guide" src="https://luke.geek.nz/assets/images/kubernetes_enterpriseguide-book-715f446a94cceccd59f5b3e6ee73d779.jpg" width="3072" height="4080" class="img_ev3q"></p>
<!-- -->
<blockquote>
<p>The book is a great read for anyone looking to understand Kubernetes from the ground up. The book is divided into 18 chapters and covers a wide range of topics, from the basics of Kubernetes to advanced topics like security, monitoring, and troubleshooting. The book is written in a language that is very easy to understand and is full of examples and diagrams to help you understand the concepts better.</p>
</blockquote>
<p>Let's dig into this a bit more:</p>
<p>First, the vision of the book is really about focusing on what you need to run Kubernetes in an Enterprise environment, based on the real-world experience from the authors, so naturally, the questions I wanted to know if this book would answer in its 623 pages of content were:</p>
<ol>
<li>Does it adequately cover core Kubernetes concepts relevant to enterprises?</li>
<li>Does it address multi-cluster and multi-cloud Kubernetes deployments?</li>
<li>Is the information backed by research, case studies, or industry best practices?</li>
<li>Is the content accessible to the intended readers, whether they are developers, operations staff, or managers?</li>
</ol>
<p>So, letâs go through each of these:</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="q-does-it-adequately-cover-core-kubernetes-concepts-that-are-relevant-to-enterprises"><strong>Q. Does it adequately cover core Kubernetes concepts that are relevant to enterprises?</strong><a href="https://luke.geek.nz/misc/kubernetes-enterprise-guide-book-review/#q-does-it-adequately-cover-core-kubernetes-concepts-that-are-relevant-to-enterprises" class="hash-link" aria-label="Direct link to q-does-it-adequately-cover-core-kubernetes-concepts-that-are-relevant-to-enterprises" title="Direct link to q-does-it-adequately-cover-core-kubernetes-concepts-that-are-relevant-to-enterprises">â</a></h2>
<p><strong>I can say yes â it does!</strong></p>
<p>The book introduces Docker and container essentials, explaining the need for containerization and how Docker works. It also covers the installation and usage of Docker before going into deploying your own Kubernetes cluster with KinD and the various components that make up Kubernetes. It covers concepts such as Ingress, Deployment, and Services, then exposes Load Balancer options, DNS considerations, and identity across multiple chapters.</p>
<ul>
<li>Now, let us look at <strong>Q. Does it address multi-cluster and multi-cloud Kubernetes deployments?</strong></li>
</ul>
<blockquote>
<p><strong>Kind of!</strong></p>
</blockquote>
<p>As alluded to, it goes through setting up KinD (Kubernetes in Docker) multi-cluster configurations, and Kubelet options, multi-tenant vCluster configuration, global load balancing!</p>
<p>However, this book â takes a neutral stance on specific Cloud deployment options, i.e., AKS and EKS, concentrating more on integration, and what's happening in the cluster, vs the opinionated Cloud provider implementations, it does, however, touch on various integrations â with identity being a key component â with some demos <em>(as part of a GitHub)</em> repository to match, if you are looking for a book all about AKS and Cloud deployment â then in my opinion not the book for you, HOWEVER, if you want to know what is happening in the background, and WHY the clusters, nodes, namespaces operate the way they do â then this is an ideal book, to understand full the concepts, which doesnât make it less valuable, but more of a supplement for fully understanding what those Cloud providers obfuscate from.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="q-is-the-information-backed-by-research-case-studies-or-industry-best-practices"><strong>Q. Is the information backed by research, case studies, or industry best practices?</strong><a href="https://luke.geek.nz/misc/kubernetes-enterprise-guide-book-review/#q-is-the-information-backed-by-research-case-studies-or-industry-best-practices" class="hash-link" aria-label="Direct link to q-is-the-information-backed-by-research-case-studies-or-industry-best-practices" title="Direct link to q-is-the-information-backed-by-research-case-studies-or-industry-best-practices">â</a></h2>
<p>I always consider this, as it removes any bias the authors may have, with more generalized guidance discovered from sweat and tears in the industry in general, and I can confirm that indeed it does!
The book features many real-world examples based on issues the authors have experienced throughout the years and resolutions on how they have been implemented. It also references external (trustedâi.e., kubernetes.io) sources where needed to point readers to additional information.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="q-is-the-content-accessible-to-the-intended-readers-whether-they-are-developers-operations-staff-or-managers"><strong>Q. Is the content accessible to the intended readers, whether they are developers, operations staff, or managers?</strong><a href="https://luke.geek.nz/misc/kubernetes-enterprise-guide-book-review/#q-is-the-content-accessible-to-the-intended-readers-whether-they-are-developers-operations-staff-or-managers" class="hash-link" aria-label="Direct link to q-is-the-content-accessible-to-the-intended-readers-whether-they-are-developers-operations-staff-or-managers" title="Direct link to q-is-the-content-accessible-to-the-intended-readers-whether-they-are-developers-operations-staff-or-managers">â</a></h2>
<blockquote>
<p><strong>Short answer Yes!</strong></p>
</blockquote>
<p>My background is in system administration (15+ years), so I approached this more from an operations and delivery perspective than a developer, so I have some bias there in my review. However, the key points are:</p>
<p>The book covered a great introduction into the concepts that make up Kubernetes, each chapter included step by step instructions, example demos supplied from a public git repo so get hands on (which was great!), managing secrets and cluster security with Gatekeeper and Dashboards!</p>
<p>I would say, yes, this book definitely covers it for developers and operations staff. It is more aligned to technical readers. However, as a Manager, there are a lot of concepts you can pick up as well, and the chapters can be skipped easily due to their names of build and deploy if not of interest.</p>
<p><strong>All in all â this is a great resource! I learned a few things, It's great to get hands-on with the guides and knowledge checks at the end of the book! Add and read this if you want to understand Kubernetes. It builds your knowledge up from concepts, so itâs a book that can meet you where you are!</strong></p>
<blockquote>
<p>The authors spent much time working on this book, training, and demo material, and you can tell!</p>
</blockquote>
<p>Iâm going to need to get a bigger bookshelf!</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>You can find the repository for the book here:</p><ul>
<li><a href="https://github.com/PacktPublishing/Kubernetes-An-Enterprise-Guide-Third-Edition" target="_blank" rel="noopener noreferrer">PacktPublishing/Kubernetes-An-Enterprise-Guide-Third-Edition</a></li>
</ul></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>If you purchase the physical book, you can also get a free eBook version from a QR code supplied on the pages of the book, which is common with many PacktPublishing books. So keep this in mind if you're like me and like switching between the physical book and an e-reader like a Kindle!</p></div></div>]]></content>
        <author>
            <name>Luke Murray</name>
            <uri>https://luke.geek.nz</uri>
        </author>
        <category label="Misc" term="Misc"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Common Challenges and Solutions for Azure OpenAI Adoption]]></title>
        <id>https://luke.geek.nz/azure/openai-adoption-challenges-solutions/</id>
        <link href="https://luke.geek.nz/azure/openai-adoption-challenges-solutions/"/>
        <updated>2024-10-15T05:08:39.693Z</updated>
        <summary type="html"><![CDATA[Explore common challenges in adopting Azure OpenAI and learn how to overcome them with best practices and solutions.]]></summary>
        <content type="html"><![CDATA[<p>When considering <a href="https://learn.microsoft.com/azure/ai-services/openai/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Open AI</a> adoption, there are some common challenges that you might face. These include:</p>
<ul>
<li>Protecting confidential information.</li>
<li>End-to-end observability.</li>
<li>Disable inferencing via Azure AI Studio</li>
<li>Protect from OWASP's Top 10 threats</li>
</ul>
<!-- -->
<p>So, let's take a look at each of these challenges and how you can overcome them.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-overview">ð Overview<a href="https://luke.geek.nz/azure/openai-adoption-challenges-solutions/#-overview" class="hash-link" aria-label="Direct link to ð Overview" title="Direct link to ð Overview">â</a></h2>
<p>When considering <a href="https://learn.microsoft.com/azure/ai-services/openai/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Open AI</a> adoption, there are some common challenges or considerations you might face, especially when looking at your solution's Day 1 and Day 2 lifecycles.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Software life cycle stages are typically broken down into the following stages:</p><ul>
<li>Day 0  - Design and build stage</li>
<li>Day 1  - Infrastructure and code deployment stage</li>
<li>Day 2  - Runtime</li>
</ul><p><img decoding="async" loading="lazy" alt="Day 0, Day 1, Day 2" src="https://luke.geek.nz/assets/images/day0-day1-day2-blogpost-11ed45fb967a3750c02e466c11a997e3.png" width="1780" height="1048" class="img_ev3q"></p></div></div>
<p>Today, we will look at common challenges and how we can overcome, work around, or mitigate them.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-landing-zone">ð¬ Landing Zone<a href="https://luke.geek.nz/azure/openai-adoption-challenges-solutions/#-landing-zone" class="hash-link" aria-label="Direct link to ð¬ Landing Zone" title="Direct link to ð¬ Landing Zone">â</a></h2>
<p>When considering Azure Open AI adoption, having a well-defined landing zone for your platform architecture and application is important.</p>
<p>This is where you will deploy your AI solution.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>An <a href="https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/landing-zone/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure landing zone</a> is an environment that follows key design principles across eight design areas. These design principles accommodate all application portfolios and enable application migration, modernization, and innovation at scale. An Azure landing zone uses subscriptions to isolate and scale application resources and platform resources. Subscriptions for application resources are called application landing zones, and subscriptions for platform resources are called platform landing zones.</p></div></div>
<p><strong>Ask</strong>:</p>
<p>Establish an Azure Landing Zone to place the Azure OpenAI solution into.</p>
<p><strong>Challenge</strong>:</p>
<ul>
<li>Ensuring a well-architected foundation</li>
<li>Need for compliance and security guardrails</li>
</ul>
<table><thead><tr><th>Why</th><th>Risk / Impact</th><th>Solution</th></tr></thead><tbody><tr><td>Solid foundation for cloud adoption</td><td>Risk â High; Impact â High</td><td>- Implement Azure Landing Zone - Include Identity, Security, and Network configurations - Address compliance and governance from the start - Provides a scalable and secure environment</td></tr></tbody></table>
<p><strong>Rationale</strong>:</p>
<p>Implementing an Azure Landing Zone ensures a secure and compliant foundation for deploying Azure OpenAI solutions. Providing necessary guardrails and governance helps mitigate the high risks and impacts of cloud adoption.</p>
<p><strong>Action</strong>:</p>
<p>Implement an Azure Landing Zone for your Azure OpenAI solution. Include Identity, Security, and Network configurations. Address compliance and governance from the start. For Platform Landing Zone recommendations, refer to the <a href="https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/landing-zone/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Cloud Adoption Framework - Ready</a>.</p>
<p>However, for more specific Azure OpenAI application landing zone considerations, we can view the <a href="https://learn.microsoft.com/azure/architecture/ai-ml/architecture/baseline-openai-e2e-chat?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">chat baseline architecture at the Azure Architecture Center</a> for reference.</p>
<p><img decoding="async" loading="lazy" alt="Azure Landing Zone" src="https://luke.geek.nz/assets/images/azure-openai-baseline-landing-zone-b1ee00fd449b9d67f722788821a42ae0.png" width="1346" height="1206" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>Azure Landing Zones consist of more than just a place to store your resources; they should also include considerations for people/processes and products to run your applications at scale. I highly recommend going through the <a href="https://learn.microsoft.com/en-us/assessments/21765fea-dfe6-4bc4-8bb7-db9df5a6f6c0/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Landing Zone Review</a> to ensure you have a solid foundation for your Azure OpenAI solution, and Azure workloads in general.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-protect-confidential-information">ð Protect confidential information<a href="https://luke.geek.nz/azure/openai-adoption-challenges-solutions/#-protect-confidential-information" class="hash-link" aria-label="Direct link to ð Protect confidential information" title="Direct link to ð Protect confidential information">â</a></h2>
<p>When considering Azure Open AI adoption, confidential information, including data, code, and other sensitive information, must be protected.</p>
<p>It is important to ensure that your data is protected, especially when you use the <a href="https://learn.microsoft.com/azure/architecture/ai-ml/guide/rag/rag-solution-design-and-evaluation-guide?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">RAG (Retrieval Augmented Generation) pattern</a>, which allows you to use your own data.</p>
<p><strong>Ask</strong>:</p>
<p>Establish an Azure Landing Zone to place Azure OpenAI solution into</p>
<p><strong>Challenge</strong>:</p>
<p>Ensuring a well-architected foundation
Need for compliance and security guardrails</p>
<table><thead><tr><th>Why</th><th>Risk / Impact</th><th>Solution</th></tr></thead><tbody><tr><td>- Solid foundation for cloud adoption- Critical for enterprise-grade workloads- Ensures compliance and governance</td><td>Risk â HighImpact â High</td><td>- Implement Azure Landing Zone- Include Identity, Security, and Network configurations - Address compliance and governance from the start- Provides a scalable and secure environment</td></tr></tbody></table>
<p><strong>Rationale</strong>:</p>
<p>Starting with Public and internal data reduces the Impact from high to low. With lower overall risk, an organization can have faster initial adoption by the time they build additional guardrails for governance and compliance in place <em>(Audit, Monitoring, and enterprise architecture)</em>.</p>
<p><strong>Action</strong>:</p>
<p>Use Platform and resource capabilities to lock down access to confidential information. For example, use Azure Key Vault to store and manage secrets, and use Azure Policy to enforce compliance of those policies.</p>
<ul>
<li>Make use of Infrastructure as Code <em>(IaC)</em>, or <a href="https://learn.microsoft.com/en-us/azure/ai-services/openai/how-to/create-resource?pivots=web-portal&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">deploy the services manually</a> to ensure that your Azure OpenAI solution is deployed in a secure and compliant manner, vs automated methods, that may automatically create the resources you need <em>(and sometimes more than you need)</em> such as Azure AI Studio with Public endpoints.</li>
<li>Make use of <a href="https://learn.microsoft.com/azure/ai-services/openai/how-to/role-based-access-control?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Role-based access control (RBAC) to ensure that only authorized users</a> have access to your Azure OpenAI solution.</li>
<li><a href="https://learn.microsoft.com/azure/storage/common/shared-key-authorization-prevent?tabs=portal&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Disable access keys for Storage accounts</a>, and make sure of <a href="https://learn.microsoft.com/entra/identity/managed-identities-azure-resources/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Managed Identities</a> for inter-Azure resource permissions.</li>
<li>Determine if the risk is high enough to manage the keys yourself using <a href="https://learn.microsoft.com/en-us/azure/storage/common/customer-managed-keys-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Customer Managed Keys</a> for your Storage account.</li>
<li>Make use of <a href="https://learn.microsoft.com/en-us/azure/private-link/private-endpoint-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Private Endpoints</a> and disable access to the public internet where possible, and monitor private endpoint <em>(East/West)</em> traffic, using a Network Virtual Appliance, such as <a href="https://learn.microsoft.com/azure/firewall/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Firewall</a>.</li>
<li>Make use of in-built Azure policies to enforce compliance, such as <a href="https://learn.microsoft.com/azure/storage/common/policy-reference?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Storage account public access should be disallowed</a>.</li>
<li>Make sure your data lifecycle is managed correctly, that you are not storing data longer than you need to, and that you are not storing data that you do not need to, you can make use of <a href="https://learn.microsoft.com/azure/storage/blobs/lifecycle-management-policy-configure?tabs=azure-portal&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">lifecycle management policies</a>, to assist with the technical aspects of this, and the Cloud Adoption Framework has some <a href="https://learn.microsoft.com/azure/cloud-adoption-framework/scenarios/cloud-scale-analytics/govern?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">guidance for Data governance</a>.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-end-to-end-observability">ð End-to-end observability<a href="https://luke.geek.nz/azure/openai-adoption-challenges-solutions/#-end-to-end-observability" class="hash-link" aria-label="Direct link to ð End-to-end observability" title="Direct link to ð End-to-end observability">â</a></h2>
<p>When considering Azure Open AI adoption, it is important to have end-to-end observability. This includes monitoring, logging, and tracing.</p>
<p>Observability for Azure Open AI has come a long way, with greater capabilities being integrated into products, such as <a href="https://learn.microsoft.com/azure/api-management/api-management-key-concepts?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure API Management</a> features, commonly referred to as an <a href="https://learn.microsoft.com/ai/playbook/technology-guidance/generative-ai/dev-starters/genai-gateway/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">AI Gateway</a>.</p>
<p><img decoding="async" loading="lazy" alt="Azure API Management" src="https://luke.geek.nz/assets/images/conceptual-architecture-ai-gw-9764a645c85341ef3fca25ac16b87704.png" width="731" height="421" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>I did a blog article on implementing and testing some of the AI Gateway capabilities a few months ago here: <a href="https://luke.geek.nz/azure/implementing-ai-gateway-in-api-management/" target="_blank" rel="noopener noreferrer">Implementing AI Gateway capabilities in API Management</a>, make sure you check this out for a bit more depth, and also <a href="https://luke.geek.nz/azure/implementing-correlation-id-in-api-management/" target="_blank" rel="noopener noreferrer">implementing a correlation ID for API Management</a> requests, to help track client transactions with Azure Application Insights.</p></div></div>
<p><strong>Ask</strong>:</p>
<p>All interactions by data scientists, including prompts &amp; responses, must be logged.</p>
<p><strong>Challenge</strong>:</p>
<p>Azure OpenAI only logs the consumer's user ID but does not log prompts sent or responses received in the Azure Diagnostics table (or anywhere else).</p>
<p>Here's how the table could be updated based on your provided details:</p>
<table><thead><tr><th>Why</th><th>Risk / Impact</th><th>Solution</th></tr></thead><tbody><tr><td>- Lines of businesses that own the data need to ensure there was no misuse of confidential data</td><td>Risk â High Impact â High</td><td>- Move complete audit trail must be established to create a fully governed environment  - Custom applications that call AOAI should log prompts and responses from their side  - Use Azure API Management services as a middle layer between published services and consuming applications and audience</td></tr></tbody></table>
<p><strong>Rationale</strong>:</p>
<p>Azure OpenAI has minimal capabilities and relies on other products to capture prompts and inferences fully for audit and governance purposes.</p>
<p><strong>Action</strong>:</p>
<ul>
<li>Use <a href="https://learn.microsoft.com/azure/api-management/api-management-key-concepts?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure API Management</a> to capture all interactions between your Azure OpenAI solution and your consumers.</li>
<li>Use <a href="https://learn.microsoft.com/azure/azure-monitor/app/app-insights-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Application Insights</a> to capture all interactions between your Azure OpenAI solution and your consumers. Application Insights works well with API Management.</li>
<li>Make sure of reference architecture, such as the <a href="https://learn.microsoft.com/azure/architecture/ai-ml/openai/architecture/log-monitor-azure-openai?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Implement logging and monitoring for Azure OpenAI models</a> for guidance on how to implement this, and to review what metrics and logs can be pulled from Azure OpenAI logging by default and adding the API Management resource into the solution.</li>
<li>Make sure of the <a href="https://aka.ms/apim/genai/labs" target="_blank" rel="noopener noreferrer">AI-Gateway labs</a>, to help add additional capabilities to your Azure API Management instance, tailored for Azure OpenAI endpoints.</li>
</ul>
<p><img decoding="async" loading="lazy" alt="Azure API Management - AI Gateway" src="https://luke.geek.nz/assets/images/ai-gateway-2de5a7f678e06b3d7e0fbd62f8219972.gif" width="1265" height="387" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-microsoft-to-not-monitor-customer-data">ð« Microsoft to not monitor customer data<a href="https://luke.geek.nz/azure/openai-adoption-challenges-solutions/#-microsoft-to-not-monitor-customer-data" class="hash-link" aria-label="Direct link to ð« Microsoft to not monitor customer data" title="Direct link to ð« Microsoft to not monitor customer data">â</a></h2>
<p>Prompts and responses are stored by Microsoft by default for <a href="https://learn.microsoft.com/azure/ai-services/openai/concepts/abuse-monitoring?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">abuse monitoring</a> <em>(not accessible to customers)</em>. You may not want Microsoft to have access to this data, including Microsoft support.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Your prompts <em>(inputs)</em> and completions <em>(outputs)</em>, your embeddings, and your training data:</p><p>Are NOT available to other customers.
Are NOT available to OpenAI.
Are NOT used to improve OpenAI models.
Are NOT used to train, retrain, or improve Azure OpenAI Service foundation models.
Are NOT used to improve any Microsoft or 3rd party products or services without your permission or instruction.
Your fine-tuned Azure OpenAI models are available exclusively for your use.
Microsoft operates the Azure OpenAI Service as an Azure service. Microsoft hosts the OpenAI models in its Azure environment, and the Service does NOT interact with any services operated by OpenAI (e.g., ChatGPT or the OpenAI API).</p><p>Reference: <a href="https://learn.microsoft.com/legal/cognitive-services/openai/data-privacy?context=%2Fazure%2Fai-services%2Fopenai%2Fcontext%2Fcontext&amp;tabs=azure-portal&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Data, privacy, and security for Azure OpenAI Service</a></p></div></div>
<p><strong>Ask</strong>:</p>
<p>Confidential data should never be stored anywhere by Microsoft or viewed by any Microsoft support or product team member.</p>
<p><strong>Challenge</strong>:</p>
<p>Microsoft logs all prompts for internal abuse monitoring for 30 days and then deletes them.</p>
<table><thead><tr><th>Why</th><th>Risk / Impact</th><th>Solution</th></tr></thead><tbody><tr><td>Some clients do not want any confidential data in prompts to be viewed by Microsoft support team</td><td><strong>Risk / Impact</strong>: High</td><td>Managed customers can apply for modified access, which stops all prompt logging</td></tr></tbody></table>
<p><strong>Rationale</strong>:</p>
<p>Microsoftâs managed customers are typically large organizations that trust Microsoft and are deemed responsible for their actions.</p>
<p><img decoding="async" loading="lazy" alt="Azure OpenAI - Data Privacy" src="https://luke.geek.nz/assets/images/azureopenai-promp-flow-2a173526497b10e1548a7135997eea16.jpg" width="1280" height="1125" class="img_ev3q"></p>
<p><strong>Action</strong>:</p>
<ul>
<li><a href="https://learn.microsoft.com/legal/cognitive-services/openai/limited-access?context=%2Fazure%2Fai-services%2Fopenai%2Fcontext%2Fcontext&amp;WT.mc_id=AZ-MVP-5004796#registration-for-modified-content-filters-andor-abuse-monitoring" target="_blank" rel="noopener noreferrer">Managed customers</a> may apply for modified access, which stops all prompt logging.</li>
<li>Make use of <a href="https://learn.microsoft.com/en-us/azure/ai-services/openai/how-to/use-your-data-securely?WT.mc_id=AZ-MVP-5004796#document-level-access-control" target="_blank" rel="noopener noreferrer">Security filters</a> in Azure AI Search, for limiting the data that is returned to the user.</li>
</ul>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Managed partners and customers are customers whose subscriptions are managed by the partner network or customers who are part of the Microsoft Enterprise Agreement program. Managed customers can apply for modified access, which stops all prompt logging. This is a contractual agreement between Microsoft and the customer, and the customer must apply for this access.</p></div></div>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>Also, make sure you talk to your account team and understand the implications of this, as it may affect the way you have architected the solution, the safeguards you may have to add, and your expectations with Microsoft support regarding any data that they may have.</p><p>"Disabling content filtering could fail to block content that violates the <a href="https://learn.microsoft.com/legal/cognitive-services/openai/code-of-conduct?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Microsoft Generative AI Services Code of Conduct</a>. My organization will implement systems and measures to ensure that the organizationâs use of Azure OpenAI complies with the <a href="https://learn.microsoft.com/legal/cognitive-services/openai/code-of-conduct?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Microsoft Generative AI Services Code of Conduct</a>".</p></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>Make sure you take a look at the <a href="https://learn.microsoft.com/en-us/azure/ai-services/openai/how-to/risks-safety-monitor?WT.mc_id=AZ-MVP-5004796#potentially-abusive-user-detection" target="_blank" rel="noopener noreferrer">Use Risks &amp; Safety monitoring</a> in Azure OpenAI Studio functionality, to review any results of the filtering activity. You can use that information to further adjust your filter configuration to serve your specific business needs and <a href="https://learn.microsoft.com/azure/machine-learning/concept-responsible-ai?view=azureml-api-2&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Responsible AI principles</a>.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ï¸-disable-inferencing-via-azure-ai-studio">âï¸ Disable inferencing via Azure AI Studio<a href="https://luke.geek.nz/azure/openai-adoption-challenges-solutions/#%EF%B8%8F-disable-inferencing-via-azure-ai-studio" class="hash-link" aria-label="Direct link to âï¸ Disable inferencing via Azure AI Studio" title="Direct link to âï¸ Disable inferencing via Azure AI Studio">â</a></h2>
<p>When considering Azure Open AI adoption, it is important to consider if you want users, to be able to inference using Azure AI Studio; using Azure AI Studio can be a security risk, as it allows users to inference directly from the Azure Portal, bypassing some traceability mechanisms <em>(such as Azure API Management)</em> which you may have in place.</p>
<p><strong>Ask</strong>:</p>
<p>Azure OpenAI Studio should not be available to make any inferencing calls and must be disabled.</p>
<p><strong>Challenge</strong>:
There is no permission or RBAC role that prevents the use of AI Studio.</p>
<p>Hereâs the table with all the missing information added:</p>
<table><thead><tr><th><strong>Why</strong></th><th><strong>Risk / Impact</strong></th><th><strong>Solution</strong></th></tr></thead><tbody><tr><td>Azure OpenAI Studio does not log prompts and responses in the diagnostic logs</td><td>Risk â High/Impact â High</td><td>- Implement custom logging at the client side to capture relevant details.  - Use alternative logging mechanisms to track prompts and responses securely.</td></tr><tr><td>Azure OpenAI Studio will bypass APIM</td><td>Risk â High  Impact â High</td><td>- Create an intermediary hop between the client and AOAI service and allow AOAI access only via Private Endpoint (e.g., AppGW/APIM). - Enable end user only via Service Principals (no portal access). - DNS block oai.azure.com.</td></tr></tbody></table>
<p>Rationale:</p>
<p>No other out-of-the-box method exists to disable Azure OpenAI Studio.</p>
<p><strong>Action</strong>:</p>
<ul>
<li>Control access to individual Azure OpenAI instances through <a href="https://learn.microsoft.com/en-gb/azure/ai-services/cognitive-services-virtual-networks?tabs=portal&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">restricting what Virtual Networks</a> can access the OpenAI instance <em>(Service Tags need to be allowed through a Network Security Group)</em>, so make sure you make use of Network Security Groups where possible to only tunnel your approved traffic <em>(i.e., AppGw or APIM only)</em>.</li>
<li>Make use of <a href="https://learn.microsoft.com/en-gb/azure/ai-services/openai/how-to/role-based-access-control?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Role-based access control for Azure OpenAI</a> Service to control who can see what.</li>
<li>Make sure of <a href="https://learn.microsoft.com/en-us/azure/ai-services/policy-reference?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Policy built-in policy definitions for Azure AI services</a> to control network access to your Azure OpenAI instances for existing or new deployments.</li>
<li>Deploy a Custom policy to prevent the creation of Azure OpenAI Studio. Refer to my blog post: <a href="https://luke.geek.nz/azure/policy-deny-creation-azure-openai-studio/" target="_blank" rel="noopener noreferrer">Azure Policy - Deny the creation of Azure OpenAI Studio</a>.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-restrict-models-to-only-certain-users">ð· Restrict models to only certain users<a href="https://luke.geek.nz/azure/openai-adoption-challenges-solutions/#-restrict-models-to-only-certain-users" class="hash-link" aria-label="Direct link to ð· Restrict models to only certain users" title="Direct link to ð· Restrict models to only certain users">â</a></h2>
<p>When considering Azure Open AI adoption, it is essential to restrict models <em>(or deployments)</em> to only certain users.</p>
<p><strong>Ask</strong>:</p>
<p>The model should be accessible to only the required audience and no one else.</p>
<p><strong>Challenge</strong>:</p>
<p>Azure OpenAI does not have the ability to grant permissions by models.</p>
<p>Hereâs the table with <strong>Risk</strong> and <strong>Impact</strong> on the same row as requested:</p>
<table><thead><tr><th><strong>Why</strong></th><th><strong>Risk / Impact</strong></th><th><strong>Solution</strong></th></tr></thead><tbody><tr><td>Model and data access should follow the principle of least privilege</td><td>Risk â High, Impact â High</td><td>- Each use case should have its own Azure OpenAI instance. - Deploy approved models for use cases only.  - Segregate duties of model deployment and model consumption via a custom RBAC role with the least privilege.</td></tr></tbody></table>
<p><strong>Rationale</strong>:</p>
<p>Having segregated instances for each use case eliminates the risk of model misuse and data exposure. New models and their inferencing capabilities need to be explicitly approved per use case before they can be leveraged.</p>
<p><strong>Action</strong>:</p>
<ul>
<li><a href="https://learn.microsoft.com/azure/ai-services/openai/how-to/create-resource?pivots=web-portal&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Create and deploy an Azure OpenAI Service resource</a> for each use case, and deploy only approved models for that use case.</li>
<li>Make sure of <a href="https://learn.microsoft.com/en-us/azure/ai-services/openai/how-to/role-based-access-control?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Role-based access control for Azure OpenAI</a> Service to control who can see what, separate the users deploying the Models, to the users consuming the models, for example Cognitive Services OpenAI User to a Managed Identity or user using the deployments.</li>
<li>Make use of <a href="https://learn.microsoft.com/en-us/azure/ai-services/policy-reference?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Policy built-in policy definitions for Azure AI services</a>, to control network access to your Azure OpenAI instances for existing or new deployments, and also restrict the creation of new 'unapproved' Azure OpenAI resources from being created.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-finops---view-total-opex-of-openai">ð° FinOps - view total opex of OpenAI<a href="https://luke.geek.nz/azure/openai-adoption-challenges-solutions/#-finops---view-total-opex-of-openai" class="hash-link" aria-label="Direct link to ð° FinOps - view total opex of OpenAI" title="Direct link to ð° FinOps - view total opex of OpenAI">â</a></h2>
<p>Consumption per use case could vary by order of magnitude. You may want to have visibility of costs at a service or deployment level, especially for use cases where the Azure OpenAI resource is shared but deployments are spread between projects.</p>
<p><strong>Ask</strong>:</p>
<p>Use cases must be able to view their total spend for the Azure OpenAI service</p>
<p><strong>Challenge</strong>:</p>
<ul>
<li>Cost metrics are available at the service level and select deployments, but not all</li>
<li>Any sharing of Azure OpenAI service makes cost determination not possible</li>
<li>No ability to stop usage beyond spending budget</li>
</ul>
<table><thead><tr><th>Why</th><th>Risk</th><th>Solution</th></tr></thead><tbody><tr><td>- Use case owners need to monitor consumption as they are responsible for cost- Azure OpenAI service can create significant costs depending on usage.</td><td>Risk â Medium Impact â High</td><td>- Provision each use case in a dedicated instance and a dedicated subscription &amp; resource group, this also ensures full AOAI capacity <em>(Tokens per min)</em> available to use case</td></tr></tbody></table>
<p><strong>Rationale</strong>:</p>
<ul>
<li>By having segregated instances for each use case, it provides accurate cost for each use case.</li>
</ul>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Sharing an instance of Azure OpenAI among multiple tenants can also lead to a <a href="https://learn.microsoft.com/en-us/azure/architecture/antipatterns/noisy-neighbor/noisy-neighbor?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Noisy Neighbor</a> problem. It can cause higher latency for some tenants. You also need to make your application code multitenancy-aware. For example, if you want to charge your customers for the consumption cost of a shared Azure OpenAI instance, implement the logic to keep track of the total number of tokens for each tenant in your application.</p></div></div>
<p><strong>Action</strong>:</p>
<ul>
<li>Provision dedicated instances for each use case and rely on distinct Resource Groups and Subscriptions to separate costs.</li>
<li>Review Cost Management and <a href="https://learn.microsoft.com/en-us/azure/ai-services/openai/how-to/manage-costs?WT.mc_id=AZ-MVP-5004796#monitor-costs" target="_blank" rel="noopener noreferrer">scope the cost per Model tokens</a>.</li>
<li>Make use of API Management, and <a href="https://journeyofthegeek.com/2024/08/22/azure-openai-service-tracking-token-usage-with-apim/" target="_blank" rel="noopener noreferrer">Token Usage</a> and merge that with your billing data.</li>
<li>If the Azure OpenAI instance is part of a wider solution, make sure you tag it with the <a href="https://luke.geek.nz/azure/application-cost-analysis-in-microsoft-azure-with-cm-resource-parent-tag/" target="_blank" rel="noopener noreferrer">cm-resource-parent</a> tag to allow full visibility of the workload's cost.</li>
<li>Understand your throughput requirements and investigate <a href="https://learn.microsoft.com/azure/ai-services/openai/concepts/provisioned-throughput?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">PTU (provisioned throughput units)</a>. You can leverage <a href="https://oai.azure.com/portal/calculator" target="_blank" rel="noopener noreferrer">Azure AI Studio for calculate PTUs</a>.</li>
<li>Review <a href="https://learn.microsoft.com/azure/architecture/guide/multitenant/service/openai?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Multitenancy and Azure OpenAI Service</a> architecture considerations.</li>
</ul>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>You don't pay for PER Azure OpenAI resource; you pay for the tokens consumed, so make sure you understand the <a href="https://azure.microsoft.com/en-us/pricing/details/cognitive-services/openai-service/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">pricing model</a>. Why overcomplicate your solution with a shared resource when you can have a dedicated resource for each use case and have a clear understanding of the costs <em>(and security)</em> associated with that use case?</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ï¸-protect-from-owasps-top-10-threats">ð¡ï¸ Protect from OWASP's Top 10 threats<a href="https://luke.geek.nz/azure/openai-adoption-challenges-solutions/#%EF%B8%8F-protect-from-owasps-top-10-threats" class="hash-link" aria-label="Direct link to ð¡ï¸ Protect from OWASP's Top 10 threats" title="Direct link to ð¡ï¸ Protect from OWASP's Top 10 threats">â</a></h2>
<p>When considering Azure Open AI adoption, it is important to protect from <a href="https://owasp.org/www-project-top-ten/" target="_blank" rel="noopener noreferrer">OWASP Top 10 threats</a>.</p>
<p><img decoding="async" loading="lazy" alt="OWASP Top 10" src="https://luke.geek.nz/assets/images/oswasp-mapping-e753666d28f07abf8f96b4a06bfa9546.png" width="936" height="258" class="img_ev3q"></p>
<p><strong>Ask</strong>:</p>
<p>Service should be protected from OWASP-10 threats.</p>
<p><strong>Challenge</strong>:</p>
<p>Azure OpenAI Service is an API-based service vulnerable to OWASP-10 threats. Web Application Firewalls, which are typically used for this, can block significant legitimate AOAI inferencing calls.</p>
<table><thead><tr><th>Why</th><th>Risk</th><th>Solution</th></tr></thead><tbody><tr><td>- Per the Microsoft shared responsibility model, protection from OWASP-10 threats is customer responsibility</td><td>Risk â High Impact â High</td><td>- Disable public access to service - Limit exposure to internal traffic only</td></tr><tr><td></td><td></td><td>- Disable file uploads to service via RBAC</td></tr><tr><td></td><td></td><td>- Add AppGW with WAF v2 in front of AOAI (Not recommended)</td></tr></tbody></table>
<p><strong>Rationale</strong>:</p>
<ul>
<li>Limiting internal traffic limits the exposure</li>
<li>Even if an attack is successful from the internal network, there is no data stored in the service to be compromised</li>
</ul>
<p><strong>Action</strong>:</p>
<ul>
<li>Control access to individual Azure OpenAI instances through <a href="https://learn.microsoft.com/en-gb/azure/ai-services/cognitive-services-virtual-networks?tabs=portal&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">restricting what Virtual Networks</a> can access the OpenAI instance <em>(Service Tags need to be allowed through a Network Security Group)</em>, so make sure you make use of Network Security Groups where possible to only tunnel your approved traffic <em>(ie, AppGw or APIM only)</em>.</li>
<li>Make use of <a href="https://learn.microsoft.com/en-gb/azure/ai-services/openai/how-to/role-based-access-control?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Role-based access control for Azure OpenAI</a> Service to control who can see what.</li>
<li>Make sure of <a href="https://learn.microsoft.com/en-us/azure/ai-services/policy-reference?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Policy built-in policy definitions for Azure AI services</a> to control network access to your Azure OpenAI instances for existing or new deployments, and disable public endpoint access.</li>
<li>Make use of <a href="https://learn.microsoft.com/azure/api-management/api-management-key-concepts?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure API Management</a> and <a href="https://learn.microsoft.com/azure/application-gateway/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Application Gateway</a> to block, prevent, and log attempted connections to the solution.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-must-use-customer-managed-keys-cmk">ð Must use Customer Managed Keys <em>(CMK)</em><a href="https://luke.geek.nz/azure/openai-adoption-challenges-solutions/#-must-use-customer-managed-keys-cmk" class="hash-link" aria-label="Direct link to -must-use-customer-managed-keys-cmk" title="Direct link to -must-use-customer-managed-keys-cmk">â</a></h2>
<p>All encryption must use <a href="https://learn.microsoft.com/azure/security/fundamentals/key-management?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Customer Managed Keys</a>. I have not personally seen this requirement yet, but it is valid, especially for highly sensitive data and industry requirements (such as Finance).</p>
<p><strong>Ask</strong>:</p>
<ul>
<li>Encryption in Azure OpenAI must be configured to use Customer Managed Keys (CMK).</li>
</ul>
<p><strong>Challenge</strong>:</p>
<ul>
<li>CMK needs to be stored in a KeyVault (in the same region).</li>
<li>AOAI service connection to KeyVault can be over 'Trusted Microsoft Connection' only, and not via KeyVault's private endpoint.</li>
</ul>
<table><thead><tr><th>Why</th><th>Risk</th><th>Solution</th></tr></thead><tbody><tr><td>Per policy, clients typically want to use CMK as opposed to MMK <em>(Microsoft Managed Keys)</em> - CMK configuration will be required to stay compliant with Azure policy</td><td>Risk â High Impact â High</td><td>- Avoid need for uploading files to Azure OpenAI studio and fine-tuning - Disable public access of KeyVault</td></tr></tbody></table>
<p><strong>Rationale</strong>:</p>
<p><a href="https://learn.microsoft.com/azure/search/search-indexer-howto-access-trusted-service-exception?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Trusted Microsoft connections</a> use the Microsoft backbone network and no public network for communication.</p>
<p><strong>Action</strong>:</p>
<ul>
<li>Azure AI Services support <a href="https://learn.microsoft.com/azure/ai-services/openai/encrypt-data-at-rest?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">encryption of data at rest</a> by either enabling customer-managed keys (CMK) or by enabling customers to bring their own storage (BYOS). By default, Azure AI services use Microsoft-managed keys to encrypt the data. With <a href="https://learn.microsoft.com/azure/ai-services/encryption/cognitive-services-encryption-keys-portal?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Customer-managed keys for encryption</a>, customers now have the choice of encrypting the data at rest with an encryption key, managed by the customers, using Azure Key Vault. There is an additional cost, as you are charged for the Key Vault and additional dependant services, as using Customer Managed Keys brings resources <em>(usually managed by Microsoft in a separate siloed subscription)</em> into your own subscription in a separate managed Resource Group.</li>
</ul>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>When considering customer-managed keys, consider People, Processes, and Products. You should have processes in place for the key lifecycles <em>(rotation, revocation, etc)</em>. Also, consider the implications of the additional costs associated with this and the additional management overhead. Be pragmatic about using Customer-Managed Keys and understand the implications of using them.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-must-not-use-shareable-access-controls">â Must not use shareable access controls<a href="https://luke.geek.nz/azure/openai-adoption-challenges-solutions/#-must-not-use-shareable-access-controls" class="hash-link" aria-label="Direct link to â Must not use shareable access controls" title="Direct link to â Must not use shareable access controls">â</a></h2>
<p>Shareable access controls are considered less secure.</p>
<p><strong>Ask</strong>:</p>
<ul>
<li>No use of passwords or access keys to access the Azure OpenAI service.</li>
</ul>
<p><strong>Challenge</strong>:</p>
<ul>
<li>The use of keys is typically less secure and unacceptable in the long term, although it typically increases the pace of initial adoption. This makes the use of Service Principals also less secure.</li>
</ul>
<table><thead><tr><th>Why - Shareable access details</th><th>Risk Risk â</th><th>Solution - Use RBAC for access</th></tr></thead><tbody><tr><td>can be transferred to unapproved consumers, losing audit trail - Bearer token of authenticated user can be potentially misused</td><td>High Impact â High</td><td>control to service for end users as well as applications (consumer and middleware)</td></tr><tr><td></td><td></td><td>- Avoid using the RBAC role with ListKey permissions or use a custom RBAC role</td></tr></tbody></table>
<p><strong>Rationale</strong>:</p>
<p>RBAC <em>(Role-based Access Control)</em> use increases the security score.</p>
<p><strong>Action</strong>:</p>
<ul>
<li>Make use of <a href="https://learn.microsoft.com/en-gb/azure/ai-services/openai/how-to/role-based-access-control?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Role-based access control for Azure OpenAI</a> Service to control who can see what, and make sure you are not using the ListKey permission or a <a href="https://learn.microsoft.com/azure/role-based-access-control/custom-roles?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">custom RBAC</a> role that allows or disallows access to the keys <em>(Microsoft.Storage/storageAccounts/listKeys/action)</em>.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-resource-must-be-in-a-specific-region-only">ð Resource must be in a specific region only<a href="https://luke.geek.nz/azure/openai-adoption-challenges-solutions/#-resource-must-be-in-a-specific-region-only" class="hash-link" aria-label="Direct link to ð Resource must be in a specific region only" title="Direct link to ð Resource must be in a specific region only">â</a></h2>
<p>Azure OpenAI resources must be in a specific region only. This is a common requirement for data sovereignty and compliance reasons.</p>
<p><strong>Ask</strong>:</p>
<p>Provision Azure OpenAI service in the same region where Express Route terminates</p>
<p><strong>Challenge</strong>:</p>
<p><a href="https://learn.microsoft.com/azure/ai-services/openai/concepts/models?tabs=python-secure&amp;WT.mc_id=AZ-MVP-5004796#model-summary-table-and-region-availability" target="_blank" rel="noopener noreferrer">Azure OpenAI and model capacity are highly variable</a>, and typically may not be available in the same region as customers Express Route region.</p>
<p><strong>Rationale</strong>:</p>
<p>Azure OpenAI Private Endpoints can be created across regions and no VNet is required for operation.</p>
<table><thead><tr><th>Why</th><th>Risk</th><th>Solution</th></tr></thead><tbody><tr><td>Network traffic is monitored for all ingress &amp; egress in a predetermined region</td><td>Risk â High Impact â High</td><td>- Enable all regions in policy within a geography acceptable to the client</td></tr><tr><td>At times there are regulatory compliance requirements to be in specific geographies</td><td></td><td>- Provision Azure OpenAI service where capacity is available in allowed regions</td></tr><tr><td></td><td></td><td>- Create private endpoint in Express Route region</td></tr></tbody></table>
<p><strong>Rationale</strong>:</p>
<p>Azure OpenAI Private Endpoints can be created across regions and no VNet is required for operation</p>
<ul>
<li>Azure OpenAI in any region can have a <a href="https://learn.microsoft.com/azure/private-link/private-link-faq?WT.mc_id=AZ-MVP-5004796#can-private-endpoint-connect-to-azure-paas-resources-across-azure-regions-" target="_blank" rel="noopener noreferrer">Private Endpoint connected to a VNET <em>(Virtual Network)</em> in a different region</a>.</li>
<li>Make sure of Azure Policy, such as the <a href="https://learn.microsoft.com/azure/cloud-adoption-framework/manage/azure-server-management/common-policies?WT.mc_id=AZ-MVP-5004796#restrict-resource-regions" target="_blank" rel="noopener noreferrer">Restrict resource regions</a> policy, to enforce the region of the Azure OpenAI resource.</li>
<li>Consider <a href="https://learn.microsoft.com/azure/ai-services/openai/how-to/deployment-types?WT.mc_id=AZ-MVP-5004796#global-versus-regional-deployment-types" target="_blank" rel="noopener noreferrer">model deployment types <em>(ie Global vs Regional)</em></a> - remember that your model inference may be in a different region to your actual Azure OpenAI resource, if Global - so need to be considered from a latency and workload variance perspective, however, these are Read Only - so data resiliency should not be a factor, as you can still store your own data in the region of your choice.</li>
</ul>]]></content>
        <author>
            <name>Luke Murray</name>
            <uri>https://luke.geek.nz</uri>
        </author>
        <category label="Azure" term="Azure"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Azure Policy - Deny the creation of Azure OpenAI Studio]]></title>
        <id>https://luke.geek.nz/azure/policy-deny-creation-azure-openai-studio/</id>
        <link href="https://luke.geek.nz/azure/policy-deny-creation-azure-openai-studio/"/>
        <updated>2024-10-14T08:20:46.782Z</updated>
        <summary type="html"><![CDATA[Custom policy definition to deny the creation of Azure OpenAI Studio.]]></summary>
        <content type="html"><![CDATA[<p>Custom <a href="https://learn.microsoft.com/azure/governance/policy/tutorials/create-custom-policy-definition?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">policy definition</a> to deny the creation of <a href="https://learn.microsoft.com/azure/ai-studio/concepts/ai-resources?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure OpenAI Studio Hubs</a>, which will stop the creation of an Azure OpenAI Studio.</p>
<!-- -->
<p>This custom Azure Policy that denies the creation of Azure OpenAI Studio hubs. Here's a breakdown of its components:</p>
<table><thead><tr><th>Key</th><th>Description</th></tr></thead><tbody><tr><td><strong>policyType</strong></td><td>Specifies that this is a custom policy.</td></tr><tr><td><strong>mode</strong></td><td>Indicates that the policy is indexed, meaning it can be evaluated against existing resources.</td></tr><tr><td><strong>displayName</strong></td><td>A human-readable name for the policy.</td></tr><tr><td><strong>description</strong></td><td>A brief description of what the policy does.</td></tr><tr><td><strong>metadata</strong></td><td>Contains additional information about the policy:</td></tr><tr><td><strong>version</strong></td><td>The version of the policy.</td></tr><tr><td><strong>category</strong></td><td>The category under which this policy falls.</td></tr><tr><td><strong>source</strong></td><td>A URL for more information.</td></tr><tr><td><strong>alzCloudEnvironments</strong></td><td>Specifies the cloud environments where this policy is applicable.</td></tr><tr><td><strong>createdBy</strong></td><td>The creator of the policy.</td></tr><tr><td><strong>lastUpdated</strong></td><td>The date when the policy was last updated.</td></tr><tr><td><strong>parameters</strong></td><td>Defines parameters that can be used within the policy:</td></tr><tr><td><strong>effect</strong></td><td>A parameter that determines the action to take (Audit, Disabled, or Deny).</td></tr><tr><td><strong>type</strong></td><td>The type of the parameter (String).</td></tr><tr><td><strong>metadata</strong></td><td>Additional information about the parameter:</td></tr><tr><td><strong>displayName</strong></td><td>A human-readable name for the parameter.</td></tr><tr><td><strong>description</strong></td><td>A brief description of the parameter.</td></tr><tr><td><strong>allowedValues</strong></td><td>The allowed values for this parameter.</td></tr><tr><td><strong>defaultValue</strong></td><td>The default value for this parameter (Deny).</td></tr><tr><td><strong>policyRule</strong></td><td>Defines the rule that the policy enforces:</td></tr><tr><td><strong>if</strong></td><td>Specifies the conditions to check:</td></tr><tr><td><strong>allOf</strong></td><td>An array of conditions that must all be true.</td></tr><tr><td><strong>field</strong></td><td>The field to check (type and kind).</td></tr><tr><td><strong>equals</strong></td><td>The expected value for the field.</td></tr><tr><td><strong>then</strong></td><td>Specifies the action to take if the conditions are met:</td></tr><tr><td><strong>effect</strong></td><td>The action to take, which is determined by the value of the effect parameter.</td></tr></tbody></table>
<p>This policy checks if a resource is of type Microsoft.MachineLearningServices/workspaces and kind Hub. If both conditions are met, the policy enforces the action specified by the effect parameter, which defaults to "Deny".</p>
<p><img decoding="async" loading="lazy" alt="Azure Policy - Deny the creation of Azure OpenAI Studio" src="https://luke.geek.nz/assets/images/DenyAzureStudioHub_PolicyAzurePortal-2464c7fa2edb6ebc65e6c34f0195b3b7.jpg" width="1362" height="897" class="img_ev3q"></p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"policyType"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Custom"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"mode"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Indexed"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"displayName"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Deny Azure OpenAI Studio creation"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"description"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Deny Azure OpenAI Studio hub creation."</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"metadata"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"version"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"1.0.0"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"category"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Machine Learning"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"source"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"https://luke.geek.nz"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"alzCloudEnvironments"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token string" style="color:rgb(255, 121, 198)">"AzureCloud"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"createdBy"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Luke"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"lastUpdated"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"2024-10-01"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"parameters"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"effect"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">"type"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"String"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">"metadata"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token property">"displayName"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Effect"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token property">"description"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Enable or disable the execution of the policy"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">"allowedValues"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token string" style="color:rgb(255, 121, 198)">"Audit"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token string" style="color:rgb(255, 121, 198)">"Disabled"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token string" style="color:rgb(255, 121, 198)">"Deny"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">"defaultValue"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Deny"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"policyRule"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"if"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">"allOf"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token property">"field"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"type"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token property">"equals"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Microsoft.MachineLearningServices/workspaces"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token property">"field"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"kind"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token property">"equals"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Hub"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"then"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">"effect"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"[parameters('effect')]"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Azure Policy - Deny the creation of Azure OpenAI Studio" src="https://luke.geek.nz/assets/images/DenyAzureStudioHubCreation_PolicyAzurePortal-4f0b0c43493b490c43b6a00e07c738ae.jpg" width="1359" height="527" class="img_ev3q"></p>]]></content>
        <author>
            <name>Luke Murray</name>
            <uri>https://luke.geek.nz</uri>
        </author>
        <category label="Azure" term="Azure"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Cloudcloak]]></title>
        <id>https://luke.geek.nz/azure/cloudcloak/</id>
        <link href="https://luke.geek.nz/azure/cloudcloak/"/>
        <updated>2024-09-29T23:37:38.995Z</updated>
        <summary type="html"><![CDATA[Install and test Cloudcloak, a browser extension that hides sensitive information while streaming or presenting Microsoft Cloud Portals.]]></summary>
        <content type="html"><![CDATA[<p><a href="https://github.com/microsoft/Cloudcloak" target="_blank" rel="noopener noreferrer">Cloud Cloak</a> is a browser extension for folks streaming or presenting while simultaneously showing one of the Microsoft Cloud Portals. It does its best to hide connection strings, email addresses, avatars, and anything that might show secure or personal information.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>You can consider this the next version/update to <a href="https://github.com/clarkio/azure-mask/" target="_blank" rel="noopener noreferrer">Azure Mask</a> <em>(shout out to Brian Clark for his pioneering work and blessing us to create this one)</em>.</p></div></div>
<p><img decoding="async" loading="lazy" alt="Cloudcloak" src="https://luke.geek.nz/assets/images/cloudcloak-icon-128-797d8ce09303938c3fca00a0c5a6dd8f.png" width="128" height="128" class="img_ev3q"></p>
<!-- -->
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Developed as part of the Microsoft Global Hackathon 2024 ð! This extension helps to 'cloak <em>(i.e., blur)</em>' potentially personable information in the relevant Azure portals that could be mistreated, allowing presenters to focus on the content they are delivering instead of having to worry about the type of information <em>(such as Azure subscription ids)</em>, that people can see.</p><p><img decoding="async" loading="lazy" alt="Cloudcloak" src="https://luke.geek.nz/assets/images/AzurePortal_Cloudcloak_On-c90255421f868b30503c0c00eb6bc45a.jpg" width="1975" height="747" class="img_ev3q"></p><p><a href="https://github.com/microsoft/Cloudcloak" target="_blank" rel="noopener noreferrer">Cloud Cloak</a> is open for contributions, and make sure you provide feedback by opening an issue on how it could be improved further. This is an open-source initiative and not directly supported by Microsoft. At the time of writing, this is the release version of version 1.0.</p></div></div>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>It does not guarantee that all sensitive information is hidden, for example, although the information is hidden in the UI on render, it might still be present in the HTML source code, or the address bar, and link previews.</p></div></div>
<p>So let us see how it works according to GitHub Copilot:</p>
<p>The extension monitors specific websites and, when activated, blurs sensitive information such as email addresses, GUIDs, IP addresses, and phone numbers. It achieves this functionality using a combination of background scripts and content scripts.</p>
<p>The extension is activated by clicking on the extension icon in the browser toolbar. When activated, sensitive information is blurred on the current page. It will remain active until the user deactivates it by clicking on the extension icon again.</p>
<ol>
<li>Initialization: When the extension is installed or updated, it initializes the state from storage and updates the badge for the current tab.
Tab Update/Activation: When a tab is updated or activated, the extension checks if the URL matches one of the specified extensions. If it does, it injects the cloak.js script and updates the badge.</li>
<li>Cloak Mode: When the user clicks the extension icon, the extension toggles the cloak mode. If enabled, it injects the cloak.js script, which identifies and blurs sensitive information on the page.</li>
<li>DOM Changes: The MutationObserver in cloak.js monitors changes in the DOM and reapplies the blur filter to newly added elements containing sensitive information.</li>
</ol>
<table><thead><tr><th><strong>Component</strong></th><th><strong>Description</strong></th></tr></thead><tbody><tr><td><code>manifest.json</code></td><td>Configures the extension with metadata, permissions, and the background script.</td></tr><tr><td><code>background.js</code></td><td>Manages the extensionâs state, handles events, and injects the content script into specified websites.</td></tr><tr><td><code>cloak.js</code></td><td>Contains the logic to identify and blur sensitive information on web pages.</td></tr><tr><td><strong>How It Works</strong></td><td></td></tr><tr><td><code>manifest.json</code></td><td>- Defines metadata, permissions, and the background script. Specifies icons and permissions.</td></tr><tr><td><code>background.js</code></td><td>- Manages the extensionâs state. Injects <code>cloak.js</code> script into the specified tab and frames.</td></tr><tr><td><strong>Event Listeners</strong></td><td></td></tr><tr><td><code>chrome.tabs.onUpdated</code></td><td>Listens for tab updates and injects the script if the URL matches the specified conditions.</td></tr><tr><td><code>chrome.tabs.onActivated</code></td><td>Listens for tab activation and updates the badge accordingly.</td></tr><tr><td><code>chrome.webNavigation.onCompleted</code></td><td>Injects the script into iframes upon navigation completion.</td></tr><tr><td><code>chrome.action.onClicked</code></td><td>Toggles the extension's enabled/disabled state when clicking the action button.</td></tr></tbody></table>
<p>At the time of writing, the following URLs are supported:</p>
<ul>
<li><a href="https://portal.azure.com/" target="_blank" rel="noopener noreferrer">https://portal.azure.com</a></li>
<li><a href="https://ms.portal.azure.com/" target="_blank" rel="noopener noreferrer">https://ms.portal.azure.com</a></li>
<li><a href="https://rc.portal.azure.com/" target="_blank" rel="noopener noreferrer">https://rc.portal.azure.com</a></li>
<li><a href="https://preview.portal.azure.com/" target="_blank" rel="noopener noreferrer">https://preview.portal.azure.com</a></li>
<li><a href="https://entra.microsoft.com/" target="_blank" rel="noopener noreferrer">https://entra.microsoft.com</a></li>
<li><a href="https://intune.microsoft.com/" target="_blank" rel="noopener noreferrer">https://intune.microsoft.com</a></li>
<li><a href="https://ai.azure.com/" target="_blank" rel="noopener noreferrer">https://ai.azure.com</a></li>
<li><a href="https://admin.microsoft.com/" target="_blank" rel="noopener noreferrer">https://admin.microsoft.com</a></li>
<li><a href="https://sip.security.microsoft.com/" target="_blank" rel="noopener noreferrer">https://sip.security.microsoft.com</a></li>
<li><a href="https://purview.microsoft.com/" target="_blank" rel="noopener noreferrer">https://purview.microsoft.com</a></li>
<li><a href="https://make.powerapps.com/" target="_blank" rel="noopener noreferrer">https://make.powerapps.com</a></li>
<li><a href="https://make.preview.powerapps.com/" target="_blank" rel="noopener noreferrer">https://make.preview.powerapps.com</a></li>
<li><a href="https://msazure.visualstudio.com/" target="_blank" rel="noopener noreferrer">https://msazure.visualstudio.com</a></li>
<li><a href="https://github.com/" target="_blank" rel="noopener noreferrer">https://github.com</a></li>
<li><a href="https://copilotstudio.microsoft.com/" target="_blank" rel="noopener noreferrer">https://copilotstudio.microsoft.com</a></li>
<li><a href="https://copilotstudio.preview.microsoft.com/" target="_blank" rel="noopener noreferrer">https://copilotstudio.preview.microsoft.com</a></li>
<li><a href="https://portal.azure.us/" target="_blank" rel="noopener noreferrer">https://portal.azure.us</a></li>
</ul>
<p>However, new URLs can be added by updating the <code>background.js</code> file and reading it in your browser to test locally.</p>
<p>Because of the Chrome event listeners, this extension is only available for Chrome and Edge browsers (and I would assume any other Chrome browser).</p>
<p>So, let's get started with the installation. We will be using Edge, as it's the browser I use mainly for my presentations.</p>
<p>This is an unofficial extension, and at this time, it is not in the Edge or Chrome stores, so it will need to be installed and updated manually. If your browser has multiple profiles, this is also per user profile.</p>
<p>So, let us download the extension from the <a href="https://github.com/microsoft/Cloudcloak" target="_blank" rel="noopener noreferrer">GitHub repository</a> and unzip the file.</p>
<p><img decoding="async" loading="lazy" alt="Download Cloudcloak" src="https://luke.geek.nz/assets/images/Download_Cloudcloak-f4502c278303035fb97448261a01c5d0.gif" width="1876" height="949" class="img_ev3q"></p>
<p>Then, in Edge, go to <code>edge://extensions/</code> and enable Developer mode. Then click on <code>Load unpacked</code> and select the folder where you unzipped the extension.</p>
<p><img decoding="async" loading="lazy" alt="Install Cloudcloak" src="https://luke.geek.nz/assets/images/Install_Cloudcloak-5c29c52a117188a14fe1567f8594447d.gif" width="1903" height="1021" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>After the extension is installed, you can disable Developer mode. For ease of use, you can pin the extension to the toolbar.</p></div></div>
<p>Now, when you are presenting, you can click on the extension icon, which will blur out sensitive information on the page. So, let's test it by navigating to an Azure resource.</p>
<p><img decoding="async" loading="lazy" alt="Cloudcloak On" src="https://luke.geek.nz/assets/images/Test_Cloudcloak-728751552c343add8af59c03e7a171e6.gif" width="1896" height="957" class="img_ev3q"></p>]]></content>
        <author>
            <name>Luke Murray</name>
            <uri>https://luke.geek.nz</uri>
        </author>
        <category label="Azure" term="Azure"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[System Managed Identity in Storage Queue PowerShell Azure Functions]]></title>
        <id>https://luke.geek.nz/azure/storage-queue-triggers-system-managed-identity-powershell/</id>
        <link href="https://luke.geek.nz/azure/storage-queue-triggers-system-managed-identity-powershell/"/>
        <updated>2024-09-02T03:14:00.526Z</updated>
        <summary type="html"><![CDATA[Learn how to create and configure a storage queue trigger using PowerShell in Azure Functions to automate your workflows.]]></summary>
        <content type="html"><![CDATA[<p><a href="https://learn.microsoft.com/azure/azure-functions/functions-overview?pivots=programming-language-powershell&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Functions</a> is a serverless compute service that enables you to run event-driven code without having to manage infrastructure. You can use Azure Functions to run small pieces of code in response to events, such as HTTP requests, messages in a queue, or changes in data in a storage account. In this article, I will show you how to use Azure Functions with a storage queue trigger using the System Managed Identity of the Function Application <em>(instead of a Connection String)</em>.</p>
<!-- -->
<p>When you create an Azure Function, you can use a storage queue trigger to execute the function when a message is added to a storage queue. This is useful when you want to process messages in a queue asynchronously. In this article, I will show you how to use an Azure Function with a storage queue by using the System Managed Identity of the Function Application to authenticate with the storage account.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p><a href="https://learn.microsoft.com/azure/azure-functions/functions-bindings-storage-queue-trigger?tabs=python-v2%2Cisolated-process%2Cnodejs-v4%2Cextensionv5&amp;pivots=programming-language-powershell&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Queue storage trigger for Azure Functions</a>. The queue storage trigger runs a function as messages are added to Azure Queue storage.</p><p>The Azure Functions runtime supports triggers and bindings for Azure Queue storage. The Azure Queue storage trigger lets you respond to new messages in a queue. When a message is added to the queue, the runtime invokes your function.</p></div></div>
<p>The first thing you will need to do is enable the System Managed Identity of the Azure Function.</p>
<p><img decoding="async" loading="lazy" alt="Enable System Managed Identity" src="https://luke.geek.nz/assets/images/AzurePortal_AzureFunction_SystemManagedIdentity-6a63314cdd46f2733b0b0f8a69dc2cbc.jpg" width="1739" height="867" class="img_ev3q"></p>
<p>Once that has been completed, we can assign the required roles to the Storage account that contains the queue.</p>
<p>What level of permissions you need to assign to the Function App's System Managed Identity depends on what you want to do with the queue. In this example, I will be using the <code>Storage Queue Data Contributor</code> role.</p>
<table><thead><tr><th>Binding type</th><th>Example built-in roles</th></tr></thead><tbody><tr><td>Trigger</td><td><a href="https://learn.microsoft.com/azure/role-based-access-control/built-in-roles/storage?WT.mc_id=AZ-MVP-5004796#storage-queue-data-reader" target="_blank" rel="noopener noreferrer">Storage Queue Data Reader</a>, <a href="https://learn.microsoft.com/azure/role-based-access-control/built-in-roles/storage?WT.mc_id=AZ-MVP-5004796#storage-queue-data-message-processor" target="_blank" rel="noopener noreferrer">Storage Queue Data Message Processor</a></td></tr><tr><td>Output binding</td><td><a href="https://learn.microsoft.com/azure/role-based-access-control/built-in-roles/storage?WT.mc_id=AZ-MVP-5004796#storage-queue-data-contributor" target="_blank" rel="noopener noreferrer">Storage Queue Data Contributor</a>, <a href="https://learn.microsoft.com/azure/role-based-access-control/built-in-roles/storage?WT.mc_id=AZ-MVP-5004796#storage-queue-data-message-sender" target="_blank" rel="noopener noreferrer">Storage Queue Data Message Sender</a></td></tr></tbody></table>
<p>Because we are going to assign the permissions to a Storage account, we can do this directly through the Azure Portal at the Function App System Managed identity location.</p>
<p><img decoding="async" loading="lazy" alt="Assign Role to Storage Account" src="https://luke.geek.nz/assets/images/AzurePortal_AzureFunction_SystemManagedIdentityAssignRole-feb74c8f71f57ab22488ef90b8d5799b.gif" width="1753" height="947" class="img_ev3q"></p>
<p>Once permissions have been granted in our Azure Function App, we will need to create some Connection variables, which our Function App will use.</p>
<p>In the Function App, under Settings, go to Environment variables.</p>
<p>We will need to determine a Connection name, which will be used by our Azure Function. In this example, I will be using <code>StgQueueAccount</code>. This will be used as a prefix for additional variables, for example:</p>
<ul>
<li><code>StgQueueAccount__queueServiceUri</code></li>
</ul>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Note that the variable has x2 underscores <code>__</code> between the Connection name and the variable name.</p></div></div>
<p>This variable will be used to store the <a href="https://learn.microsoft.com/azure/azure-functions/functions-bindings-storage-queue-trigger?tabs=python-v2%2Cin-process%2Cnodejs-v4%2Cextensionv5&amp;pivots=programming-language-powershell&amp;WT.mc_id=AZ-MVP-5004796#identity-based-connections" target="_blank" rel="noopener noreferrer">URI of the Storage Account Queue</a>.</p>
<p>For the valuiie of the StgQueueAccount__queueServiceUri, you can get this from the Azure Portal, by going to the Storage Account, and then to the Queue Service, to find the endpoint uri.</p>
<p><img decoding="async" loading="lazy" alt="Queue Service URI" src="https://luke.geek.nz/assets/images/AzurePortal_AzureFunction_StorageAccountQueueenebdpoint-6b33ebf7ccb56d12490c735b84f10fd0.jpg" width="1564" height="525" class="img_ev3q"></p>
<p>Once we have retrieved it, we can navigate back to the Environment variables and add in the Key-Value pair.</p>
<p><img decoding="async" loading="lazy" alt="Environment Variables" src="https://luke.geek.nz/assets/images/AzurePortal_AzureFunction_EnvironmentVariables_queueuri-318c6e94becefce1c858583cb30376b0.jpg" width="1533" height="779" class="img_ev3q"></p>
<p>Make sure to click Apply and Apply.</p>
<p>Once completed, the default profile.ps1 file will run to authenticate using the Managed Identity of the Function App.</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">profile.ps1</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$env</span><span class="token plain">:MSI_SECRET</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Disable-AzContextAutosave</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Scope </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">Process</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Out-Null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Connect-AzAccount</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Identity</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Your actual function will need to have the binding updated with the name of the Connection prefix determined earlier and include the queue name, for example:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">function.json</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"bindings"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"name"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"QueueItem"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"type"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"queueTrigger"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"direction"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"in"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"queueName"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"rg-queue-create"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"connection"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"StgQueueAccount"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You should now be able to read the messages from the queue and process them as required using the System Managed Identity of the Azure Function account.</p>]]></content>
        <author>
            <name>Luke Murray</name>
            <uri>https://luke.geek.nz</uri>
        </author>
        <category label="Azure" term="Azure"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Azure Communication Services and PowerShell for Email]]></title>
        <id>https://luke.geek.nz/azure/using-communication-services-and-powershell-to-send-emails/</id>
        <link href="https://luke.geek.nz/azure/using-communication-services-and-powershell-to-send-emails/"/>
        <updated>2024-08-24T10:21:21.789Z</updated>
        <summary type="html"><![CDATA[A step-by-step guide on how to use Azure Communication Services and PowerShell to send emails.]]></summary>
        <content type="html"><![CDATA[<p><a href="https://azure.microsoft.com/products/communication-services?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Communication Services</a> brings rich communication APIs to all of your apps across any device on any platform, using the same reliable and secure infrastructure that powers Microsoft Teams.</p>
<p>Today, we will explore using Email as part of Azure Communication Services, using the REST API and PowerShell to send an email.</p>
<p><img decoding="async" loading="lazy" alt="Azure Communication Services" src="https://luke.geek.nz/assets/images/BlogHeading_DeployandTestACS-f9838a4feb1c05d77481cc14d4141606.gif" width="1200" height="628" class="img_ev3q"></p>
<!-- -->
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>I did a previous article: <a href="https://luke.geek.nz/azure/azure-email-communication-services/" target="_blank" rel="noopener noreferrer">Deploying and Testing Azure Email Communication Services</a> on this, however the authentication was using an Azure Service Principal. This time we will use oauth using a System Assigned Managed Identity.</p></div></div>
<p>In this example, I will access a token from <a href="https://azure.microsoft.com/products/communication-services?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Communication Services</a>. I will make a GET request to the identity endpoint of Azure Communication Services, using the oauth identity from the system-managed identity. This will return a token we can use to authenticate against the REST API.</p>
<p>Here's a step-by-step explanation of the script:</p>
<p>The script first defines the subject and body of the email. The body is an HTML string that contains the email content.
It checks if the email body is not empty.
If the email body is not empty, it proceeds to get an access token from Azure Communication Services. This is done by making a GET request to the identity endpoint of Azure Communication Services. The access token is then printed to the console.
If there's an error when getting the access token, the script catches the exception and prints the error message and response details on the console.
The script then constructs the URI for the email-sending endpoint and defines the headers for the REST API call. The headers include the content type and the obtained access token in the Authorization header.
The script defines the body for the REST API call. This includes the sender address, the email content (subject and body), the recipients, the reply-to address, and a flag to disable user engagement tracking.
The script then converts the PowerShell object to JSON and attempts to send the email by making a POST request to the email-sending endpoint. The request details and response are logged to the console.
If the email is sent incorrectly, the script catches the exception and logs the error message and stack trace to the console.</p>
<p>Further information on the authentication process itself:</p>
<ol>
<li>The script first defines the resource ID for Azure Communication Services and the communication endpoint URL.</li>
<li>It then constructs the URI for the identity endpoint. This URI includes the environment variable IDENTITY_ENDPOINT (automatically set by Azure when using Managed Identity) and the resource ID.</li>
<li>The script then attempts to get an access token from the identity endpoint. It does this by sending a GET request to the identity endpoint with a header that includes Metadata: true. This tells the identity endpoint that the request is coming from within Azure.</li>
<li>the response will include an access token if the request is successful. This token is then extracted from the response.</li>
</ol>
<p>This access token can then be used to authenticate requests to Azure Communication Services. The token tells Azure Communication Services that the request comes from an authenticated source (in this case, the Managed Identity) and should be allowed.</p>
<p><em>(This authenticaiton was inititally written to be used in a Azure Automation Runbook, with the System Managed Identity assigned Contributor rights to the Azure Communication Services resource (not the Email Communication Services).)</em></p>
<p>Here is the PowerShell script to send an email using Azure Communication Services using the <a href="https://learn.microsoft.com/entra/identity/managed-identities-azure-resources/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">System Managed identity</a> of an <a href="https://learn.microsoft.com/azure/automation/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Automation account</a>:</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$emailSubject</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"Important: Server Maintenance Notification"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$EmailRecipient</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"ituser@contoso.com"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$emailBody</span><span class="token plain"> = @</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">&lt;html&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">&lt;body&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">&lt;p&gt;Dear User,&lt;/p&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">&lt;p&gt;This is to inform you that a &lt;b&gt;&lt;i&gt;server maintenance is scheduled for the next week&lt;/i&gt;&lt;/b&gt;.&lt;/p&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">&lt;p&gt;The servers will be down from 10:00 PM to 2:00 AM.&lt;/p&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">&lt;p&gt;Please save your work and log off during this period to avoid any data loss.&lt;/p&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">&lt;p&gt;If you have any questions or concerns, please contact our IT Support team.&lt;/p&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">&lt;p&gt;Thank you for your understanding and cooperation.&lt;/p&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">&lt;p&gt;Best Regards,&lt;/p&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">&lt;p&gt;IT Support Team&lt;/p&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">&lt;/body&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">&lt;/html&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain">@</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$emailBody</span><span class="token plain"> </span><span class="token operator">-ne</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">""</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$emailBody</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Define the resource ID for Azure Communication Services</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceID</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">'https://communication.azure.com'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Define the communication endpoint URL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$communicationendpointurl</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"azcomm-contoso.australia.communication.azure.com"</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Update with your communication endpoint URL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Construct the URI for the identity endpoint</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$Uri</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$env</span><span class="token string function" style="color:rgb(80, 250, 123)">:IDENTITY_ENDPOINT</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">?api-version=2018-02-01&amp;resource=</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceID</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Debug output</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Print the constructed URI and headers</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"URI: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$Uri</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Headers: @{ Metadata = 'true' }"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Try to get the access token</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">try</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Invoke a GET request to the identity endpoint to get the access token</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$AzToken</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Invoke-WebRequest</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Uri </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$Uri</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Method GET </span><span class="token operator">-</span><span class="token plain">Headers @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> Metadata = </span><span class="token string" style="color:rgb(255, 121, 198)">"true"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">UseBasicParsing </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Select-Object</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ExpandProperty Content </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">ConvertFrom-Json</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Select-Object</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ExpandProperty access_token</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Print the obtained access token</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Access Token: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$AzToken</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># If there's an error, print the error message and response details</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Error</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Failed to get access token: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Response Status Code: </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Exception</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Response</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">StatusCode</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Value__</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Response Status Description: </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Exception</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Response</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">StatusDescription</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Response Content: </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Exception</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Response</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">GetResponseStream</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)"> | %{ </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token string" style="color:rgb(255, 121, 198)">.ReadToEnd() })"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Construct the URI for the email sending endpoint</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$uri</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"https://</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$communicationendpointurl</span><span class="token string" style="color:rgb(255, 121, 198)">/emails:send?api-version=2023-03-31"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Define the headers for the REST API call</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Include the content type and the obtained access token in the Authorization header</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$headers</span><span class="token plain"> = @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">"Content-Type"</span><span class="token plain">  = </span><span class="token string" style="color:rgb(255, 121, 198)">"application/json"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">"Authorization"</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">"Bearer </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$AzToken</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Define the body for the REST API call</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$apiResponse</span><span class="token plain"> = @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        headers                        = @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            id = </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token function" style="color:rgb(80, 250, 123)">New-Guid</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Guid</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        senderAddress                  = </span><span class="token string" style="color:rgb(255, 121, 198)">'DoNotReply@7647475b-a51b-4901-8674-917e6abea743.azurecomm.net'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        content                        = @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            subject = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$emailSubject</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            html    = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$emailBody</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        recipients                     = @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            to = @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    address     = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$EmailRecipient</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    displayName = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$EmailRecipient</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        replyTo                        = @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                address     = </span><span class="token string" style="color:rgb(255, 121, 198)">"example@contoso.com"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                displayName = </span><span class="token string" style="color:rgb(255, 121, 198)">"Contoso"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        userEngagementTrackingDisabled = </span><span class="token boolean">$true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Convert the PowerShell object to JSON</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$body</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$apiResponse</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">ConvertTo-Json</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Depth 10</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Send the email</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">try</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Log the request details</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Sending email..."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"URI: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$uri</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Headers: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$headers</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Body: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$body</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Make the request</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$response</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Invoke-RestMethod</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Uri </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$uri</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Method Post </span><span class="token operator">-</span><span class="token plain">Headers </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$headers</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Body </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$body</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">UseBasicParsing</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Log the response</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Response: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$response</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Return the response</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$response</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Log the error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Error</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Failed to send email: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Exception Message: </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Exception</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Message</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Exception StackTrace: </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Exception</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">StackTrace</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You can run this script in an Azure Automation Runbook <em>(and theoretically in an <a href="https://learn.microsoft.com/azure/azure-functions/functions-overview?pivots=programming-language-csharp&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Function</a> as well)</em> to send an email using Azure Communication Services and the System Managed Identityâand there is no need to maintain or store client secrets!</p>]]></content>
        <author>
            <name>Luke Murray</name>
            <uri>https://luke.geek.nz</uri>
        </author>
        <category label="Azure" term="Azure"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Implementing Correlation ID for API Management requests]]></title>
        <id>https://luke.geek.nz/azure/implementing-correlation-id-in-api-management/</id>
        <link href="https://luke.geek.nz/azure/implementing-correlation-id-in-api-management/"/>
        <updated>2024-08-16T10:21:21.789Z</updated>
        <summary type="html"><![CDATA[This article provides a comprehensive guide on implementing correlation IDs in API management systems, enhancing traceability and debugging capabilities.]]></summary>
        <content type="html"><![CDATA[<p>When working with <a href="https://learn.microsoft.com/azure/api-management/api-management-key-concepts?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure API Management</a>, you may want to enable traceability and correlation of requests across different services. This is where the Correlation ID comes in.</p>
<p>Similar to <a href="https://www.w3.org/TR/trace-context/#traceparent-header-field-values" target="_blank" rel="noopener noreferrer">traceparent</a>, the Correlation ID is a unique identifier passed along with the request and response headers. It allows you to track a request's flow as it moves through different services and systems.</p>
<p>In this article, we will explore how to generate a new correlation ID through API Management Inbound policies and pass it back to the Client through an outbound policy, which then is used to help troubleshoot specific calls with <a href="https://learn.microsoft.com/azure/azure-monitor/app/app-insights-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Application Insights</a>.</p>
<!-- -->
<p>So, if you want an experience like the following to help pass the Correlation ID back to the client, then look up the transaction in Application Insights, then let us take a look:</p>
<p><img decoding="async" loading="lazy" alt="Correlation ID" src="https://luke.geek.nz/assets/images/apim_appin_requesttrace-7f84df8f428f2b3c298d8550ae1af671.gif" width="1614" height="1197" class="img_ev3q"></p>
<p>To start with, make sure that the API <em>(Global or specific API)</em> has the following settings enabled:</p>
<p><img decoding="async" loading="lazy" alt="Correlation protocol" src="https://luke.geek.nz/assets/images/apim-appin-trace_verbosity-cf0f09eef2ceb0682a50c1564b2044b7.jpg" width="1992" height="1123" class="img_ev3q"></p>
<p>Now, we need to set an Inbound Policy to create the Correlation ID (if it's not already passed in the request) as a variable and assign that variable to an inbound header.</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">inbound</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">set-variable</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">name</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">correlation-id</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">value</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">@(context.Request.Headers.GetValueOrDefault('x-correlation-id', Guid.NewGuid().ToString()))</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">set-header</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">name</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">x-correlation-id</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">exists-action</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">override</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">value</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">@((string)context.Variables["correlation-id"])</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">value</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">set-header</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">inbound</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<table><thead><tr><th><strong>Line</strong></th><th><strong>Explanation</strong></th></tr></thead><tbody><tr><td><code>&lt;set-variable name="correlation-id" value="@(context.Request.Headers.GetValueOrDefault("x-correlation-id", Guid.NewGuid().ToString()))" /&gt;</code></td><td>This line is setting a variable named "correlation-id". It's getting the value from the request headers. If a header with the name "x-correlation-id" exists, it uses that value. If not, it generates a new unique ID using <code>Guid.NewGuid().ToString()</code>.</td></tr><tr><td><code>&lt;set-header name="x-correlation-id" exists-action="override"&gt;</code></td><td>This line is setting a header named "x-correlation-id". If a header with this name already exists, it will be overridden.</td></tr><tr><td><code>&lt;value&gt;@((string)context.Variables["correlation-id"])&lt;/value&gt;</code></td><td>This line sets the value of the "x-correlation-id" header to the value of the "correlation-id" variable.</td></tr><tr><td><code>&lt;/set-header&gt;</code></td><td>This line is closing the <code>&lt;set-header&gt;</code> tag.</td></tr></tbody></table>
<p>Once that added, we need to add another inbound policy:</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">inbound</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">trace</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">source</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">Global APIM Policy</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">severity</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">information</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">message</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">@(String.Format("API: {0}, Operation: {1}", context.Api.Name, context.Operation.Name))</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">message</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">metadata</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">name</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">correlation-id</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">value</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">@((string)context.Variables[</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">correlation-id"])"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">trace</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">inbound</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<table><thead><tr><th><strong>Element</strong></th><th><strong>Description</strong></th></tr></thead><tbody><tr><td><code>&lt;trace source="Global APIM Policy" severity="information"&gt;</code></td><td>This is the start of a trace element. The&nbsp;source&nbsp;attribute is set to "Global APIM Policy" and the&nbsp;severity&nbsp;attribute is set to "information".</td></tr><tr><td><code>&lt;message&gt;@(String.Format("API: {0}, Operation: {1}", context.Api.Name, context.Operation.Name))&lt;/message&gt;</code></td><td>This is a message element. It uses&nbsp;String.Format&nbsp;to create a string that includes the name of the API and the operation from the context.</td></tr><tr><td><code>&lt;metadata name="correlation-id" value='@((string)context.Variables["correlation-id"])' /&gt;</code></td><td>This is a metadata element. It has a&nbsp;name&nbsp;attribute set to "correlation-id" and a&nbsp;value&nbsp;attribute that retrieves the "correlation-id" from the context variables and casts it to a string.</td></tr><tr><td><code>&lt;/trace&gt;</code></td><td>This is the end of the trace element.</td></tr></tbody></table>
<p><img decoding="async" loading="lazy" alt="Inbound Policy" src="https://luke.geek.nz/assets/images/apim-appin-trace_inboundpolicy-29950dbb1ce2ffd7c7a0598c0636f3fa.jpg" width="2095" height="1134" class="img_ev3q"></p>
<p>This will help you track the Correlation ID in the logs and troubleshoot any issues that may arise.</p>
<p>Once that has been added, it's time to return it to the client. This can be done with the following Outbound policy:</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">outbound</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">set-header</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">name</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">x-correlation-id</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">exists-action</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">override</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">value</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">@((string)context.Variables["correlation-id"])</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">value</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">set-header</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">outbound</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<table><thead><tr><th><strong>Element</strong></th><th><strong>Description</strong></th></tr></thead><tbody><tr><td><code>&lt;outbound&gt;</code></td><td>This tag defines the outbound section of the policy. The operations inside this tag are applied to the response before it's sent back to the client.</td></tr><tr><td><code>&lt;set-header name="x-correlation-id" exists-action="override"&gt;</code></td><td>This tag sets an HTTP header in the outbound response. The&nbsp;<code>name</code>&nbsp;attribute specifies the name of the header, in this case&nbsp;<code>x-correlation-id</code>. The&nbsp;<code>exists-action</code>&nbsp;attribute specifies what to do if the header already exists, in this case it's set to&nbsp;<code>override</code>, meaning the existing header will be replaced.</td></tr><tr><td><code>&lt;value&gt;@((string)context.Variables["correlation-id"])&lt;/value&gt;</code></td><td>This tag sets the value of the header. It's using a variable from the context named&nbsp;<code>correlation-id</code>. The&nbsp;<code>@</code>&nbsp;symbol is used to denote an expression in Azure API Management policies.</td></tr></tbody></table>
<p><img decoding="async" loading="lazy" alt="Outbound Policy" src="https://luke.geek.nz/assets/images/apim-appin-trace_outboundpolicy-87a73d904abbaa9e23010ecdf2426867.jpg" width="2113" height="1135" class="img_ev3q"></p>
<p>Reference:</p>
<ul>
<li><a href="https://yourazurecoach.com/2021/01/22/optimizing-api-traceability-in-azure-api-management/" target="_blank" rel="noopener noreferrer">Optimizing traceability in Azure API Management</a></li>
</ul>]]></content>
        <author>
            <name>Luke Murray</name>
            <uri>https://luke.geek.nz</uri>
        </author>
        <category label="Azure" term="Azure"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Implementing AI Gateway capabilities in API Management]]></title>
        <id>https://luke.geek.nz/azure/implementing-ai-gateway-in-api-management/</id>
        <link href="https://luke.geek.nz/azure/implementing-ai-gateway-in-api-management/"/>
        <updated>2024-08-14T06:40:06.774Z</updated>
        <summary type="html"><![CDATA[Comprehensive guide on implementing an AI Gateway in API Management, covering key concepts, benefits, and implementation details.]]></summary>
        <content type="html"><![CDATA[<p>Today, we are going to delve into some of the Generative <a href="https://learn.microsoft.com/ai/playbook/technology-guidance/generative-ai/dev-starters/genai-gateway/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">AI Gateway capabilities</a> <em>(commonly referred to as AI Gateway)</em> that are available in the <a href="https://learn.microsoft.com/azure/api-management/api-management-key-concepts?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">API Management</a> service.</p>
<p>These capabilities are designed to help secure and monitor your OpenAI endpoints in your applications as you head toward production.</p>
<!-- -->
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-overview">ð Overview<a href="https://luke.geek.nz/azure/implementing-ai-gateway-in-api-management/#-overview" class="hash-link" aria-label="Direct link to ð Overview" title="Direct link to ð Overview">â</a></h2>
<p>Common scenarios that the AI Gateway capabilities can help with include:</p>
<ul>
<li>How can we track token usage across multiple applications? How can we do cross charges for multiple applications/teams that use Azure OpenAI models?</li>
<li>How can we make sure that a single app does not consume the whole TPM quota, leaving other apps with no option to use Azure OpenAI models?</li>
<li>How can we make sure that the API key is securely distributed across multiple applications?</li>
<li>How can we distribute load across multiple Azure OpenAI endpoints? How can we make sure that PTUs are used first before falling back to Pay-as-you-go instances?</li>
</ul>
<p>In this post, we will explore how to use the AI Gateway capabilities in API Management to address these scenarios.</p>
<p><img decoding="async" loading="lazy" alt="APIM + Azure OpenAI" src="https://luke.geek.nz/assets/images/AI_Gateway_APIMOpenAI-80ae2388688f19a95cc432db3e783854.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="AI Gateway" src="https://luke.geek.nz/assets/images/ai-gateway-d9353e29e0749e3ad7ac37733aff7831.gif" width="1265" height="387" class="img_ev3q"></p>
<p>The first step is to <a href="https://learn.microsoft.com/azure/api-management/azure-openai-api-from-specification?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">import the Azure OpenAI</a> service and definition into API Management. This will allow you to create a new API in API Management that can act as a gateway to the Azure OpenAI service.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>You can import an Azure OpenAI API directly from the Azure OpenAI Service to API Management. When you import the API, API Management automatically configures:</p><ul>
<li>Operations for each of the Azure OpenAI REST API endpoints.</li>
<li>A system-assigned identity with the necessary permissions to access the Azure OpenAI resource.</li>
<li>A backend resource and set-backend-service policy that directs API requests to the Azure OpenAI Service endpoint.</li>
<li>An authentication-managed-identity policy that can authenticate to the Azure OpenAI resource using the instance's system-assigned identity.</li>
<li><em>(optionally)</em> Policies help you monitor and manage token consumption using the Azure OpenAI API.</li>
</ul><p>The general availability of this functionality went into May 2024. <a href="https://azure.microsoft.com/en-us/updates/ga-import-azure-openai-enpoints-as-an-apis-in-azure-api-management/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">GA Import Azure OpenAI endpoints as an API in Azure API Management</a>.</p></div></div>
<p>So, let us take a look at how to import the Azure OpenAI service and definition into API Management.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-request-forwarding">ð¬ Request Forwarding<a href="https://luke.geek.nz/azure/implementing-ai-gateway-in-api-management/#-request-forwarding" class="hash-link" aria-label="Direct link to ð¬ Request Forwarding" title="Direct link to ð¬ Request Forwarding">â</a></h2>
<p>Let us take a look at forwarding the request.</p>
<p><img decoding="async" loading="lazy" alt="Request Forwarding" src="https://luke.geek.nz/assets/images/AI_Gateway_APIMRequestForwarding-367920bce5a96a3bc6faafe060dab2e3.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>For this article, I have the following resources pre-deployed already:</p>
<table><thead><tr><th><strong>Name</strong></th><th><strong>Type</strong></th><th><strong>Region</strong></th></tr></thead><tbody><tr><td>openai-ca-res-eastus</td><td>Azure OpenAI</td><td>East US</td></tr><tr><td>openai-ca-res-uksouth</td><td>Azure OpenAI</td><td>UK South</td></tr><tr><td>apim-lmv01-dev-eastus-aka</td><td>API Management service</td><td>East US</td></tr></tbody></table>
<p>We will start by adding openai-ca-res-eastus to the Azure API Management service first before looking at adding the other resources.</p>
<blockquote>
<p>This will automatically, enable the System Managed Identity of API Management, to access the Azure OpenAI service with the role of <a href="https://learn.microsoft.com/azure/ai-services/openai/how-to/role-based-access-control?WT.mc_id=AZ-MVP-5004796#cognitive-services-openai-user" target="_blank" rel="noopener noreferrer">Cognitive Services OpenAI User</a>, and create a new Backend instance, and operations.</p>
</blockquote>
<p><img decoding="async" loading="lazy" alt="Add Azure OpenAI to API Management" src="https://luke.geek.nz/assets/images/apim_add_azureopenaibackend-bef0dddd0efac4ec71aabab47f30cd83.gif" width="1896" height="963" class="img_ev3q"></p>
<p>We can see the police changes applied, pointing to the backend and system-managed identity.</p>
<p><img decoding="async" loading="lazy" alt="Azure OpenAI API Management Policies" src="https://luke.geek.nz/assets/images/apim_api_openaipolicybase-a73f2a7fae5ab39b84c8c0bf3336d43d.png" width="2685" height="821" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>There is Azure Portal integration to enable a few API policies that are out of the box to help you manage the token consumption of the Azure OpenAI API.</p><p>These are:</p><p>Manage token consumption <em>(Use the Azure OpenAI token limit policy to protect the API from overuse and to control Azure OpenAI cost. If selected, API Management will add the policy with the configured TPM value. You can add, edit, or remove this policy after the API is created.)</em>
Track token usage <em>(Use the Azure OpenAI emit token policy to log the consumed total, completion, and prompt tokens. If selected, API Management will add the policy with the specified configuration. You can add, edit, or remove this policy after the API is created)</em></p></div></div>
<p>Now that we have a frontend for our Azure OpenAI service, it's time to test the Azure OpenAI endpoint through Azure API Management.</p>
<p>To do this, we will need a:</p>
<ul>
<li>deployment-id _(this is the name of the Model deployment, in Azure OpenAI)</li>
<li>api-version <em>(this is the version of the Azure OpenAI API, that we want to use)</em></li>
</ul>
<p>We can get this information from the Azure AI Studio, in the Azure Portal, in the Deployment blade.</p>
<p><img decoding="async" loading="lazy" alt="Azure OpenAI Deployment ID and API Version" src="https://luke.geek.nz/assets/images/AzureAIStudio-gpt4odeploymenturl-8e01e250dd05e2d036ffd133e8742176.png" width="1911" height="631" class="img_ev3q"></p>
<p>Now, we can test the Azure OpenAI endpoint, through Azure API Management. In Azure API Management, navigate to the openai API that you created, and select the Creates a completion for the chat message operation and the Test tab.</p>
<p>Add in your deployment ID and API version, and in the request body, enter a sample prompt like the one below:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"messages"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token property">"role"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"system"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token property">"content"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"You are a knowledgeable assistant in an ice cream parlor."</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token property">"role"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"user"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token property">"content"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"What are the ingredients typically used to make a classic vanilla ice cream?"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"max_tokens"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Azure OpenAI Test" src="https://luke.geek.nz/assets/images/apim_test_azureopenaibackend-df1f2fafd998f9f09f6a837854f26665.gif" width="1896" height="963" class="img_ev3q"></p>
<p>This confirms that we can now communicate with the Azure OpenAI service, through Azure API Management.</p>
<p>So let us test Request forwarding, from a client application, such as Postman.</p>
<p>We will need to get the subscription key from the Azure API Management instance and add this to the request header as 'API-key' after first associating the open API with a Product and the subscription key is generated.</p>
<p><img decoding="async" loading="lazy" alt="Azure OpenAI Postman Request Forwarding" src="https://luke.geek.nz/assets/images/apim_test_postmanrequestforwarding-7e4ea8153e19804af9f2e5c19dc519d3.gif" width="1896" height="963" class="img_ev3q"></p>
<p>Here is a sample PowerShell script for invoking the Azure OpenAI endpoint, through Azure API Management, as well.</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$headers</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">New-Object</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"System.Collections.Generic.Dictionary[[String],[String]]"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$headers</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Add</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"api-key"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"YOURSUBSCRIPTIONKEY"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$headers</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Add</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"Content-Type"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"application/json"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$body</span><span class="token plain"> = @</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    `"messages`": [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            `"role`": `"system`",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            `"content`": `"You are a knowledgeable assistant in an ice cream parlor.`"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        },</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            `"role`": `"user`",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            `"content`": `"What are the ingredients typically used to make a classic vanilla ice cream?`"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    ],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    `"max_tokens`": 100</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain">@</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$response</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Invoke-RestMethod</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'https://apim-lmv01-dev-eastus-aka.azure-api.net/openai/deployments/gpt-4o/chat/completions?api-version=2024-02-15-preview'</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Method </span><span class="token string" style="color:rgb(255, 121, 198)">'POST'</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Headers </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$headers</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Body </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$body</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$response</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">ConvertTo-Json</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We have successfully implemented Request forwarding, through API Management to the Azure OpenAI endpoint.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-backend-circuit-breaking">ð Backend circuit breaking<a href="https://luke.geek.nz/azure/implementing-ai-gateway-in-api-management/#-backend-circuit-breaking" class="hash-link" aria-label="Direct link to ð Backend circuit breaking" title="Direct link to ð Backend circuit breaking">â</a></h2>
<p>Now, let us take a look at Backend circuit breaking. The <a href="https://learn.microsoft.com/azure/architecture/patterns/circuit-breaker?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Circuit Breaker</a> pattern, follows the same principles as the electrical circuit breaker. It is used to detect failures and encapsulate the logic of preventing a failure from constantly recurring, during maintenance, temporary overloads, or unexpected spikes in traffic. When the circuit breaker trips, it can return an error immediately, without trying to execute the operation.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>The Circuit Breaker pattern is mentioned in my <a href="https://luke.geek.nz/azure/cloud-design-patterns/" target="_blank" rel="noopener noreferrer">Cloud Design Patterns</a> blog post.</p></div></div>
<p>A circuit breaker acts as a proxy for operations that might fail. The proxy should monitor the number of recent failures that have occurred, and use this information to decide whether to allow the operation to proceed, or simply return an exception immediately, when the circuit is Closed the requests are allowed to pass through, when the circuit is Open, the requests are blocked.</p>
<p><img decoding="async" loading="lazy" alt="Backend Circuit Breaking" src="https://luke.geek.nz/assets/images/AI_Gateway_APIMCircuitBreaker-9ff007d6e10e3e0dbc9d0e6bfb72fa62.png" width="1402" height="766" class="img_ev3q"></p>
<p>To implement a circuit breaker in API Management, we will need to add a policy to the Azure OpenAI API that monitors the number of recent failures and uses this information to decide whether to allow the operation to proceed or simply return an exception immediately.</p>
<p>Unlike Request forwarding, configuring the Circuit Breaker cannot currently be done in the Azure Portal and will require configuration through Infrastructure as Code (i.e., Bicep)_ or the API Management REST API.</p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>Before you configure a circuitbreaker policy, make sure you have a backup of your Backend configuration and test this in a non-production environment.</p></div></div>
<p>Today, we will configure it using Bicep, by referencing the backend of an already existing API Management resource, and adding in the circuitBreaker rule.</p>
<p><img decoding="async" loading="lazy" alt="Backend Circuit Breaking Bicep" src="https://luke.geek.nz/assets/images/AI_Gateway_APIMCircuitBreakerBicepDeploy-004cb18c8010a4b41fa1edf77a2bb50f.png" width="2595" height="823" class="img_ev3q"></p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> backend </span><span class="token datatype class-name">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> existingUrl </span><span class="token datatype class-name">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Use the parameters to update properties</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> updatedBackend </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.ApiManagement/service/backends@2023-09-01-preview'</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> backend</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">url</span><span class="token operator">:</span><span class="token plain"> existingUrl  </span><span class="token comment" style="color:rgb(98, 114, 164)">// Use the parameter to keep the existing URL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">protocol</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'http'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">circuitBreaker</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">rules</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">failureCondition</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">count</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">3</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Number of failures before tripping the circuit breaker</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">errorReasons</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token string" style="color:rgb(255, 121, 198)">'Server errors'</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Reasons for the failure</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">interval</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'PT1H'</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Time interval to count the failures</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">statusCodeRanges</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token property">min</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">500</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Minimum status code to consider as a failure</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token property">max</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">599</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Maximum status code to consider as a failure</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'myBreakerRule'</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Name of the circuit breaker rule</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">tripDuration</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'PT1H'</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Duration for which the circuit breaker remains tripped</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">acceptRetryAfter</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Whether to accept retry after the trip duration</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In the Circuit Breaker rule above, the following behavior will occur:</p>
<table><thead><tr><th><strong>Parameter</strong></th><th><strong>Description</strong></th></tr></thead><tbody><tr><td><strong>Number of Failures</strong></td><td>The circuit breaker will trip if there are 3 or more failures within the specified time interval.</td></tr><tr><td><strong>Error Reasons</strong></td><td>Failures considered are those matching the reason 'Server errors'. The application or service should categorize errors with this reason.</td></tr><tr><td><strong>Status Code Ranges</strong></td><td>Failures are identified based on HTTP status codes ranging from 500 to 599, covering server-side errors such as internal server errors (500), service unavailable (503), and similar issues.</td></tr><tr><td><strong>Time Interval</strong></td><td>Failures are counted within a time interval of 1 hour ('PT1H'). If there are 3 or more failures with status codes in the 500â599 range within any 1-hour window, the circuit breaker will trip.</td></tr><tr><td><strong>Trip Duration</strong></td><td>Once tripped, the circuit breaker remains in the tripped state for 1 hour ('PT1H'). During this period, requests will not pass through until the breaker is reset.</td></tr><tr><td><strong>Retry Behavior</strong></td><td>After the trip duration of 1 hour, the circuit breaker is designed to allow retries (acceptRetryAfter: true). Requests will be accepted again after the trip duration, and the service will attempt to recover.</td></tr><tr><td><strong>Scenarios Where the Circuit Breaker Will Trip</strong></td><td>If, within any 1-hour period, there are 3 or more server-side errors (HTTP status codes 500â599) with the reason 'Server errors', the circuit breaker will trip. Once tripped, the circuit breaker will block requests for 1 hour. After the 1-hour block period, the circuit breaker will reset and start accepting requests again.</td></tr></tbody></table>
<p>There is nothing in the Azure Portal for API management, but if we take a look at the backend provider resource, we can confirm that the configuration for the backend has been set.</p>
<p><img decoding="async" loading="lazy" alt="Backend Circuit Breaking Bicep" src="https://luke.geek.nz/assets/images/AI_Gateway_APIMCircuitBreakerPostBicepDeploy-190c9f1188abcb165e1ba9054103a4f8.png" width="1539" height="509" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ï¸-backend-load-balancing">âï¸ Backend Load Balancing<a href="https://luke.geek.nz/azure/implementing-ai-gateway-in-api-management/#%EF%B8%8F-backend-load-balancing" class="hash-link" aria-label="Direct link to âï¸ Backend Load Balancing" title="Direct link to âï¸ Backend Load Balancing">â</a></h2>
<p>Let us now take a look at Backend Load Balancing with <a href="https://learn.microsoft.com/azure/api-management/backends?tabs=bicep&amp;WT.mc_id=AZ-MVP-5004796#load-balanced-pool" target="_blank" rel="noopener noreferrer">Load-Balanced Pools</a>. Load balancing is the process of distributing network traffic across multiple endpoints. This ensures that no single server bears too much demand. By spreading the work evenly, load balancing improves application responsiveness.</p>
<p><img decoding="async" loading="lazy" alt="Backend Load Balancing" src="https://luke.geek.nz/assets/images/AI_Gateway_APIMBackendLoadBalancing-9b8309c78822bc9e5aacb67487938eae.PNG" width="1396" height="764" class="img_ev3q"></p>
<p>Backend pooling your Azure OpenAI endpoints, allows you to:</p>
<ul>
<li>Spread the load to multiple backends, which may have individual backend circuit breakers.</li>
<li>Shift the load from one set of backends to another for upgrade <em>(blue-green deployment)</em>.</li>
</ul>
<p>Note Backend pools don't need any policy configuration. The rules are just properties of the backend.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>API Management supports the following load balancing options for backend pools:</p><ul>
<li>Round-robin: By default, requests are distributed evenly across the backends in the pool.</li>
<li>Weighted: Weights are assigned to the backends in the pool, and requests are distributed across the backends based on the relative weight assigned to each backend. Use this option for scenarios such as conducting a blue-green deployment.</li>
<li>Priority-based: Backends are organized in priority groups, and requests are sent to the backends in order of the priority groups. Within a priority group, requests are distributed either evenly across the backends, or (if assigned) according to the relative weight assigned to each backend.</li>
</ul><p><em>(Backends in lower priority groups will only be used when all backends in higher priority groups are unavailable because circuit breaker rules are tripped.)</em></p></div></div>
<p>If we go back to my environment, we are currently operating with the following resources:</p>
<table><thead><tr><th><strong>Name</strong></th><th><strong>Type</strong></th><th><strong>Region</strong></th></tr></thead><tbody><tr><td>openai-ca-res-eastus</td><td>Azure OpenAI</td><td>East US</td></tr><tr><td>openai-ca-res-uksouth</td><td>Azure OpenAI</td><td>UK South</td></tr><tr><td>apim-lmv01-dev-eastus-aka</td><td>API Management service</td><td>East US</td></tr></tbody></table>
<p>So so far, the Azure OpenAI backend of eastus is being used, but we can add the uksouth backend to the backend pool, and configure it to be used in a round-robin fashion.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>One of the reasons you may want to do this is not only to ensure reliability, using a priority group - that your Azure OpenAI service is highly available and can be accessed from multiple regions, but you may also want to ensure that you are not hitting the <a href="https://learn.microsoft.com/azure/ai-services/openai/quotas-limits?WT.mc_id=AZ-MVP-5004796#regional-quota-limits" target="_blank" rel="noopener noreferrer">TPM <em>(Tokens Per Minute)</em> regional limits</a> of the Azure OpenAI service, and that you are distributing the load across multiple regions.</p><p>A common scenario here would be to have a primary region, that has a <a href="https://learn.microsoft.com/azure/ai-services/openai/concepts/provisioned-throughput?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">PTU <em>(Proviosned Throughout)</em></a> assigned, and failover to a pay as you go region.</p></div></div>
<p>Similar to the Circuit Breaker rule capability, we need to configure Backend Pools using the Azure RestAPI or an Infrastructure as Code method, such as Bicep.</p>
<p>In my example, I will be adding the openai-ca-res-uksouth to the backend pool of the Azure OpenAI API and configuring it to use EastUS first and failover to UKSouth if east us stops responding.</p>
<p>To do this, we need to add a new backend and then reference that in a new pool configuration.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>When we initially added our first Azure OpenAI resource, a lot of the configuration was done for us, including adding the <a href="https://learn.microsoft.com/azure/ai-services/openai/how-to/role-based-access-control?WT.mc_id=AZ-MVP-5004796#cognitive-services-openai-user" target="_blank" rel="noopener noreferrer">Cognitive Services OpenAI User</a> role to the System Managed Identity of the API Management instance to authenticate with the Azure OpenAI resource, so make sure you grant Azure API Management the necessary permissions to access any other Azure OpenAI resource.</p><p><img decoding="async" loading="lazy" alt="Azure OpenAI API Management Policies" src="https://luke.geek.nz/assets/images/apim_add_cognitiveaiuserrbacuksouth-9fc00c5bb551804001531619f03c852e.gif" width="1896" height="824" class="img_ev3q"></p></div></div>
<p>Navigate to your secondary Azure OpenAI instance, and navigate to Keys and Endpoints, we need to grab the endpoint URL ie <em>(<a href="https://openai-ca-res-uksouth.openai.azure.com/" target="_blank" rel="noopener noreferrer">https://openai-ca-res-uksouth.openai.azure.com/</a>)</em>, to add as another Backend and append with /openai.</p>
<p><img decoding="async" loading="lazy" alt="Azure OpenAI UKSouth Endpoint" src="https://luke.geek.nz/assets/images/apim_add_cognitiveaiserviceuksouth-da040a214e8a8ad004a7bfd6f067a0cd.gif" width="1896" height="824" class="img_ev3q"></p>
<p>Now that its added as a backend, we can add it to the backend pool, and configure it.</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> backendnane </span><span class="token datatype class-name">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> subscriptionID </span><span class="token datatype class-name">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> resourceGroupName </span><span class="token datatype class-name">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> APIManagementName </span><span class="token datatype class-name">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> backend1 </span><span class="token datatype class-name">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> backend2 </span><span class="token datatype class-name">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Use the parameters to update properties</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> updatedBackend </span><span class="token string" style="color:rgb(255, 121, 198)">'Microsoft.ApiManagement/service/backends@2023-09-01-preview'</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">'</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">APIManagementName</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">/</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">backendnane</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">description</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Load balancer for multiple backends'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Pool'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">pool</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">services</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)">// Define the backend pool configuration for an API Management service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token comment" style="color:rgb(98, 114, 164)">// Define the first backend with a specific ID, priority, and weight</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">id</span><span class="token operator">:</span><span class="token plain"> </span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">'/subscriptions/</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">subscriptionID</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">/resourceGroups/</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">resourceGroupName</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">/providers/Microsoft.ApiManagement/service/</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">APIManagementName</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">/backends/</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">backend1</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">priority</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Higher priority backend</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">weight</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain">   </span><span class="token comment" style="color:rgb(98, 114, 164)">// Weight of the backend</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token comment" style="color:rgb(98, 114, 164)">// Define the second backend with a specific ID, priority, and weight</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">id</span><span class="token operator">:</span><span class="token plain"> </span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">'/subscriptions/</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">subscriptionID</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">/resourceGroups/</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">resourceGroupName</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">/providers/Microsoft.ApiManagement/service/</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">APIManagementName</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">/backends/</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">backend2</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">priority</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Higher priority backend</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">weight</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">2</span><span class="token plain">   </span><span class="token comment" style="color:rgb(98, 114, 164)">// Weight of the backend</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Backend Pool Bicep" src="https://luke.geek.nz/assets/images/AI_Gateway_APIMBackendPoolBicepDeploy-289231677f28105dc86256ef5761cfda.png" width="1476" height="713" class="img_ev3q"></p>
<p>Once the deploy is done, we can see the backend pool configuration in the Azure Portal.</p>
<p><img decoding="async" loading="lazy" alt="Backend Pool Bicep" src="https://luke.geek.nz/assets/images/AI_Gateway_APIMBackendPool-6986a7ac57ecfcc77e0e21d5a6209b60.png" width="1808" height="682" class="img_ev3q"></p>
<p>Now we need to update the Azure API Managememt OpenAI API, to use the backend pool, instead of the single backend.</p>
<p>Navigate to APIs, and your OpenAI API, select All Operations and then select the edit button.</p>
<p>Change the backend it to the name of your Backend Pool.</p>
<p><img decoding="async" loading="lazy" alt="Backend Pool Bicep" src="https://luke.geek.nz/assets/images/AI_Gateway_APIMBackendPoolAPIPolicyConfig-2ff002f67a62ca29b6851a20c3f1e569.png" width="1837" height="659" class="img_ev3q"></p>
<p>Now if we test the Azure OpenAI endpoint, through Azure API Management, we can see that the requests are being distributed across the two backends in the backend pool.</p>
<p>If we enable, Tracing we can see the handoff, and our API callers are oblivious to the fact that their API call is getting redirected.</p>
<p><img decoding="async" loading="lazy" alt="Backend Pool Bicep" src="https://luke.geek.nz/assets/images/apim_test_loadbalancedpools-754ac7221f305622d6840c97763440ef.gif" width="1896" height="824" class="img_ev3q"></p>
<p>You can use the Circuitbreaker and Backend Pooling in conjunction with each other, to ensure that your Azure OpenAI service is highly available, and can be accessed from multiple regions.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>The Circuitbreaker policies are on the Backends, not the Pools.</p></div></div>
<p>For example, I changed the circuitBreaker rule, status code range to: 401 <em>(Permission Denied)</em> and removed the Cogniative User role from the System Managed Identity of the API Management instance, to simulate a backend failure, and moved the UkSouth endpoint to priority group 2.</p>
<p><img decoding="async" loading="lazy" alt="Backend Pool Bicep" src="https://luke.geek.nz/assets/images/AI_Gateway_APIMBackendPoolPermissionDenied-b445246a6e53b17e7a817f37c014481e.png" width="1004" height="522" class="img_ev3q"></p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">         statusCodeRanges</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">               </span><span class="token comment" style="color:rgb(98, 114, 164)">// Define the range of HTTP status codes that will be considered as failures for the circuit breaker</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token property">min</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">401</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Minimum status code to consider as a failure (e.g., Unauthorized)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token property">max</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">401</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Maximum status code to consider as a failure (e.g., Unauthorized)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>And it worked as expected, the circuit breaker tripped, and the requests were redirected to the UKSouth backend.</p>
<p><img decoding="async" loading="lazy" alt="Backend Pool Bicep" src="https://luke.geek.nz/assets/images/apim_test_loadbalancedcircuitbreakerpools-cc8d8e9284555389d1e559a788bc6bd1.gif" width="1483" height="811" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-response-streaming">ð¡ Response Streaming<a href="https://luke.geek.nz/azure/implementing-ai-gateway-in-api-management/#-response-streaming" class="hash-link" aria-label="Direct link to ð¡ Response Streaming" title="Direct link to ð¡ Response Streaming">â</a></h2>
<p>Let us take a look at Response Streaming. Response streaming is a technique used to send a response to a client in chunks, rather than all at once. This can be useful when the response is large, or when the response is being generated in real-time.</p>
<p><img decoding="async" loading="lazy" alt="Response Streaming" src="https://luke.geek.nz/assets/images/AI_Gateway_APIMResponseStreaming-01d33957f271809e6df6789b672156a3.PNG" width="4000" height="2250" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>Follow the <a href="https://learn.microsoft.com/en-us/azure/api-management/how-to-server-sent-events?WT.mc_id=AZ-MVP-5004796#guidelines-for-sse" target="_blank" rel="noopener noreferrer">guidelines</a> when using API Management to reach a backend API that implements SSE (Server side streaming).</p></div></div>
<p>If I go back to our Creates a completion for the chat message, operation, and edit the policy and add the following to the inbound and outbound Azure policies.</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">inbound</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)">&lt;!-- Base inbound processing --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">base</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)">&lt;!-- Conditional logic to check if the request body contains a non-null "stream" property --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">choose</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">when</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">condition</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">@(context.Request.Body.As&lt;JObject&gt;(true)[</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">stream"]</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">!</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)"> null</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">&amp;&amp;</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">context.Request.Body.As&lt;JObject</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">(true)["stream"].Type != JTokenType.Null)"&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token comment" style="color:rgb(98, 114, 164)">&lt;!-- Set a variable "isStream" with the value of the "stream" property from the request body --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">set-variable</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">name</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">isStream</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">value</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">@{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token tag attr-value" style="color:rgb(255, 121, 198)">                    var content = (context.Request.Body?.As&lt;JObject&gt;(true));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token tag attr-value" style="color:rgb(255, 121, 198)">                    string streamValue = content[</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">stream"].ToString();</span><span class="token tag" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token tag" style="color:rgb(255, 121, 198)">                    </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">return</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">streamValue;</span><span class="token tag" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token tag" style="color:rgb(255, 121, 198)">                </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">}"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">when</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">choose</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">inbound</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">&lt;!-- Control if and how the requests are forwarded to services --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">backend</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)">&lt;!-- Base backend processing --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">base</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">backend</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">&lt;!-- Customize the responses --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">outbound</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)">&lt;!-- Base outbound processing --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">base</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)">&lt;!-- Set a custom header "x-ms-stream" based on the value of the "isStream" variable --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">set-header</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">name</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">x-ms-stream</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">exists-action</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">override</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">value</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">@{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    return context.Variables.GetValueOrDefault</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">string</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">("isStream","false").Equals("true", StringComparison.OrdinalIgnoreCase).ToString();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                }</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">value</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">set-header</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">outbound</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This sets the x-ms-stream header to true, if the request body contains a non-null "stream" property, allowing streaming, so let us test this in Postman</p>
<p>By using the following prompt:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"messages"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">"role"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"system"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">"content"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"You are a knowledgeable assistant in an ice cream parlor."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">"role"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"user"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">"content"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"What are the ingredients typically used to make a classic vanilla ice cream?"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"max_tokens"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">100</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"stream"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Response Streaming" src="https://luke.geek.nz/assets/images/apim_test_responsestreamingpostman-30c067a88313695c3ea3d6fb1b5f9c4e.gif" width="1483" height="922" class="img_ev3q"></p>
<p>Note: Full JSON streaming support <a href="https://github.com/postmanlabs/postman-app-support/issues/12713" target="_blank" rel="noopener noreferrer">is not avaliable</a> at this time of this article in postman, so again - you need a client to support this.</p>
<p>We can, however see the response does include the response being streamed and broken up into chunks:</p>
<p><img decoding="async" loading="lazy" alt="Response Streaming" src="https://luke.geek.nz/assets/images/AI_Gateway_APIMResponseStreamingPostmanOutput-c3cc800d5ded2012e1aaaa49afcd6449.PNG" width="542" height="357" class="img_ev3q"></p>
<p>To remove the streaming component, we can either remove the stream from the body or change the stream from true to false.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-token-rate-limiting">â³ Token rate limiting<a href="https://luke.geek.nz/azure/implementing-ai-gateway-in-api-management/#-token-rate-limiting" class="hash-link" aria-label="Direct link to â³ Token rate limiting" title="Direct link to â³ Token rate limiting">â</a></h2>
<p>Let us take a look at Token rate limiting. Token rate limiting is a technique used to limit the number of requests that can be made to an API within a certain time period. This can help prevent abuse of the API, and ensure that all users have fair access to the API.</p>
<p><img decoding="async" loading="lazy" alt="Token Rate Limiting" src="https://luke.geek.nz/assets/images/AI_Gateway_APIMTokenRateLimiting-9abe8628c0c20291dee7af1511cac346.PNG" width="1280" height="682" class="img_ev3q"></p>
<p>To implement token rate limiting in API Management, we need to add a policy to the Azure OpenAI API, that will limit the number of requests that can be made to the API within a certain time period, the tokens per minute.</p>
<p>This is an Inbound policy, and will limit the tokens per minute, with a 429 <em>(Too Many Requests)</em> response, that can be called from a single IP address <em>(each unqiue IP address will have its own counter)</em>.</p>
<p><img decoding="async" loading="lazy" alt="Token Rate Limiting" src="https://luke.geek.nz/assets/images/apim_set_RateLimitPolicy-e931dbbcf9a4be862ab32818a0310f84.gif" width="1895" height="960" class="img_ev3q"></p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">azure-openai-token-limit</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">counter-key</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">@(context.Request.IpAddress)</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">tokens-per-minute</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">500</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">estimate-prompt-tokens</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">false</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">remaining-tokens-variable-name</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">remainingTokens</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">/&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<table><thead><tr><th><strong>Property</strong></th><th><strong>Description</strong></th></tr></thead><tbody><tr><td><code>&lt;azure-openai-token-limit&gt;</code></td><td>This is a custom tag or directive used to define the rate-limiting policy for Azure OpenAI tokens.</td></tr><tr><td><code>counter-key="@(context.Request.IpAddress)"</code></td><td>This specifies that the rate-limiting should be based on the client's IP address. Each unique IP address will have its own counter.</td></tr><tr><td><code>tokens-per-minute="500"</code></td><td>This sets the limit to 500 tokens per minute for each IP address. Once an IP address consumes 500 tokens within a minute, further requests will be restricted until the next minute.</td></tr><tr><td><code>estimate-prompt-tokens="false"</code></td><td>This indicates whether to estimate the number of tokens in the prompt. Setting it to false means the actual token count will be used rather than an estimate.</td></tr><tr><td><code>remaining-tokens-variable-name="remainingTokens"</code></td><td>This specifies the variable name (<code>remainingTokens</code>) that will store the number of tokens remaining for the current minute.</td></tr></tbody></table>
<p>So lets test it, in my test, I am using a PowerShell script to call the Azure OpenAI endpoint, through Azure API Management, and I am calling it 20 times, in a loop, to test the rate limiting.</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Define the headers</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$headers</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">New-Object</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"System.Collections.Generic.Dictionary[[String],[String]]"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$headers</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Add</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"api-key"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"YOURSUBSCRIPTIONKEY"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$headers</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Add</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"Content-Type"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"application/json"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Define the body</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$body</span><span class="token plain"> = @</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    `"messages`": [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            `"role`": `"system`",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            `"content`": `"You are a knowledgeable assistant in an ice cream parlor.`"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        },</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            `"role`": `"user`",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            `"content`": `"What are the ingredients typically used to make a classic vanilla ice cream?`"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    ],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    `"max_tokens`": 100</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain">@</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Loop to run the script 20 times</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$i</span><span class="token plain"> = 1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$i</span><span class="token plain"> </span><span class="token operator">-le</span><span class="token plain"> 20</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$i</span><span class="token operator">++</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">try</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Send the request and capture the response</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$response</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Invoke-RestMethod</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'https://apim-lmv01-dev-eastus-aka.azure-api.net/openai/deployments/gpt-4o/chat/completions?api-version=2024-02-15-preview'</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Method </span><span class="token string" style="color:rgb(255, 121, 198)">'POST'</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Headers </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$headers</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Body </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$body</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Output the response as JSON</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$responseJson</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$response</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">ConvertTo-Json</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Depth 10</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$responseJson</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Handle any errors that occur during the request</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Error</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Exception</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Message</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Token Rate Limit test" src="https://luke.geek.nz/assets/images/apim_test_RateLimitPolicy-5f10867ab873c57a2602495a9fee6e9f.gif" width="1547" height="884" class="img_ev3q"></p>
<p>As we can see, it instantly gets declined after the 500th token; however, traffic from other IP addresses can still access the API.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ï¸-semantic-caching">ðï¸ Semantic Caching<a href="https://luke.geek.nz/azure/implementing-ai-gateway-in-api-management/#%EF%B8%8F-semantic-caching" class="hash-link" aria-label="Direct link to ðï¸ Semantic Caching" title="Direct link to ðï¸ Semantic Caching">â</a></h2>
<p>Let us take a look at <a href="https://learn.microsoft.com/en-us/azure/api-management/azure-openai-enable-semantic-caching?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Semantic Caching</a>. Semantic caching is a technique used to cache responses from an API based on the content of the request. This can help improve performance by reducing the number of requests that need to be made to the API.</p>
<blockquote>
<p>With semantic caching, you can return cached responses for identical prompts and also for prompts that are similar in meaning, even if the text isn't the same.</p>
</blockquote>
<p>To use Semantic Caching, we need an Embedding model to generate embeddings for the prompts and a Cache policy to cache the responses based on the embeddings.</p>
<p>In my example, I will deploy an Embedding model <em>(text-embedding-ada-002)</em> to the East US Azure OpenAI resource.</p>
<p><img decoding="async" loading="lazy" alt="Semantic Caching - text-embedding-ada-002 deployment" src="https://luke.geek.nz/assets/images/AI_Gateway_APIMSemanticCaching_EmbeddingDeployment-bc8c70a25d269d8de2b7ea10232b0fd1.PNG" width="1633" height="981" class="img_ev3q"></p>
<p>Now, we need to add a Backend for the embedding endpoint, similar to how we originally added the US East backend. If you are using load balancing, you can add this to a new backend pool as well, as long as the model is deployed across all endpoints.</p>
<p>However, instead of a /chat endpoint, we will use the /embed endpoint, and the deployment will be the name of the embedding model deployment, as an example <em>(<a href="https://openai-ca-res-eastus.openai.azure.com/openai/deployments/text-embedding-ada-002/embeddings" target="_blank" rel="noopener noreferrer">https://openai-ca-res-eastus.openai.azure.com/openai/deployments/text-embedding-ada-002/embeddings</a>)</em>.</p>
<p>Once we have our URL we can add a new Backend.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>This could be deployed to another Azure OpenAI instance, but make sure you enable the Cognitive Services OpenAI User role on the System Managed Identity of the API Management instance to authenticate with the Azure OpenAI resource.</p></div></div>
<p><img decoding="async" loading="lazy" alt="Semantic Caching - Embedding Backend" src="https://luke.geek.nz/assets/images/apim_set_SemanticCachingModelBackend-d84de613221c75aec46d7ab782fecddb.gif" width="1906" height="884" class="img_ev3q"></p>
<p>Now, it is time to configure our <a href="https://learn.microsoft.com/azure/api-management/azure-openai-semantic-cache-lookup-policy?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">semantic caching policy</a>.</p>
<blockquote>
<p>We will need a <strong><a href="https://learn.microsoft.com/azure/api-management/api-management-howto-cache-external?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Redis Enterprise Cache deployed</a></strong>, and configured as an External cache to API Management, with <strong><a href="https://learn.microsoft.com/azure/azure-cache-for-redis/cache-redis-modules?WT.mc_id=AZ-MVP-5004796#redisearch" target="_blank" rel="noopener noreferrer">RediSearch module</a> enabled</strong> and then we can add the semantic caching policy to the Azure OpenAI API. Without the Redis cache, the semantic caching policy will not work, and the azure-openai-semantic-cache-lookup policy will be skipped.</p>
</blockquote>
<p>Navigate to our OpenAI API, select the Creates a completion for the chat message operation, and add the following policy to the inbound section.</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">azure-openai-semantic-cache-lookup</span><span class="token tag" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token tag" style="color:rgb(255, 121, 198)">    </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">score-threshold</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">0.5</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)">  </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">&lt;!--</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">Adjusted</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">threshold</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">for</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">better</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">precision</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">--</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    embeddings-backend-id="azureaiembeddingbackend"  </span><span class="token comment" style="color:rgb(98, 114, 164)">&lt;!-- Updated backend ID --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    embeddings-backend-auth="system-assigned"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ignore-system-messages="false"  </span><span class="token comment" style="color:rgb(98, 114, 164)">&lt;!-- Include system messages if they add value --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    max-message-count="15"&gt; </span><span class="token comment" style="color:rgb(98, 114, 164)">&lt;!-- Increased message count for more context --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">vary-by</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">@(context.Subscription.Id)</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">vary-by</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">azure-openai-semantic-cache-lookup</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<table><thead><tr><th><strong>Element</strong></th><th><strong>Description</strong></th></tr></thead><tbody><tr><td><code>&lt;azure-openai-semantic-cache-lookup&gt;</code></td><td>A custom tag used to define the semantic cache lookup policy for Azure OpenAI.</td></tr><tr><td><code>score-threshold="0.8"</code></td><td>Sets the threshold for similarity scores. Only results with a score of 0.5 or higher are considered.</td></tr><tr><td><code>embeddings-backend-id="embeddings-deployment"</code></td><td>Specifies the ID of the embeddings backend deployment used for the cache lookup.</td></tr><tr><td><code>embeddings-backend-auth="system-assigned"</code></td><td>Indicates that the system-assigned managed identity is used for authentication with the embeddings backend.</td></tr><tr><td><code>ignore-system-messages="true"</code></td><td>Specifies that system messages should be ignored during the cache lookup.</td></tr><tr><td><code>max-message-count="10"</code></td><td>Sets the maximum number of messages to be considered in the cache lookup.</td></tr><tr><td><code>&lt;vary-by&gt;@(context.Subscription.Id)&lt;/vary-by&gt;</code></td><td>Specifies that the cache should vary by subscription ID, meaning each subscription will have its own cache.</td></tr></tbody></table>
<p>In the Outbound processing section for the API, add the azure-openai-semantic-cache-store policy.</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">azure-openai-semantic-cache-store</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">duration</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">60</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">/&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<table><thead><tr><th><strong>Attribute</strong></th><th><strong>Description</strong></th></tr></thead><tbody><tr><td><code>&lt;azure-openai-semantic-cache-store&gt;</code></td><td>This is a custom tag or directive used to define the semantic cache store policy for Azure OpenAI.</td></tr><tr><td><code>duration="60"</code></td><td>This specifies the duration for which the cached data should be stored in minutes. In this case, the cache will be stored for 60 minutes.</td></tr></tbody></table>
<p><img decoding="async" loading="lazy" alt="Semantic Caching - Embedding Backend" src="https://luke.geek.nz/assets/images/apim_Add_SemanticCachingAPIPolicies-ffe7cbcdb9019d67cef34df899be4ce6.gif" width="1906" height="895" class="img_ev3q"></p>
<p>Once added, we can test it.</p>
<p>We can do this, using the <a href="https://learn.microsoft.com/azure/api-management/api-management-howto-api-inspector?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Trace</a> feature in Azure API Management, and we can see the cache hit, and the response being returned from the cache.</p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>If you get HTTP/1.1 415 model_error, make sure you are using a <a href="https://learn.microsoft.com/azure/ai-services/openai/concepts/models?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">model that supports embeddings</a>, and that the model is deployed.
Also if you are testing, make sure that the content-type is application/json.</p></div></div>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>I was not able to test this end-to-end in my environment due to needing a payment instance for Redis, not covered under my Visual Studio Enterprise subscription.</p></div></div>
<p>If this is all configured you should see something like the below in a Trace:</p>
<p><img decoding="async" loading="lazy" alt="Semantic Caching - Semantic Cache lookup" src="data:image/png;base64,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" width="902" height="305" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-logging">ð Logging<a href="https://luke.geek.nz/azure/implementing-ai-gateway-in-api-management/#-logging" class="hash-link" aria-label="Direct link to ð Logging" title="Direct link to ð Logging">â</a></h2>
<p>Now let us take a look at Logging. Logging is the process of recording events that occur during the execution of a process. Logs can be used to monitor and troubleshoot requests, as well as to analyze and report on application performance.</p>
<p><img decoding="async" loading="lazy" alt="APIM Built in Logging" src="https://luke.geek.nz/assets/images/AI_Gateway_APIMBuiltinLogging-3eb67482fcc9ca685d10242055dc315d.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>To do this, we need to enable <a href="https://learn.microsoft.com/azure/azure-monitor/app/app-insights-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Application Insights</a>, which will create a <a href="https://learn.microsoft.com/azure/templates/microsoft.apimanagement/service/loggers?pivots=deployment-language-bicep&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Logger entity</a> to Application Insights from API Management.</p>
<p><img decoding="async" loading="lazy" alt="APIM Built in Logging" src="https://luke.geek.nz/assets/images/AI_Gateway_APIMLogging_AppInsights-287e0ea93ebe8c5df5e6cb53bdaac841.PNG" width="1361" height="487" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>If you're not using Azure API Management, I recommend you check out the workbook by Dolev Shor (Microsoft Fastrack Engineer). You can read more about it here: <a href="https://techcommunity.microsoft.com/t5/fasttrack-for-azure/azure-openai-insights-monitoring-ai-with-confidence/ba-p/4026850?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure OpenAI Insights: Monitoring AI with Confidence</a>.</p></div></div>
<p>So, let's take a look at some of the logs generated by the Azure OpenAI API through Azure API Management and visible through the Application Insights and Log Analytics workspace.</p>
<p><img decoding="async" loading="lazy" alt="APIM Built in Logging" src="https://luke.geek.nz/assets/images/AI_Gateway_APIMBuiltinLoggingAppInsights-178892bf52e262e9009cb8600c5e0bba.PNG" width="1669" height="889" class="img_ev3q"></p>
<p>The first thing you could do is configure an availability test for your API Management endpoint.</p>
<p>The API Management Gateway health probe URL is: /status-0123456789abcdef</p>
<p>So our availability test URL would be: '<a href="https://apim-lmv01-dev-eastus-aka.azure-api.net/status-0123456789abcdef" target="_blank" rel="noopener noreferrer">https://apim-lmv01-dev-eastus-aka.azure-api.net/status-0123456789abcdef</a>'</p>
<p><img decoding="async" loading="lazy" alt="API Management avaliability test" src="https://luke.geek.nz/assets/images/AI_Gateway_APIMLogging_AppInsightsAvaliabilityTest-cdb16c486eeb95f7d06665fc5c9c5ba7.PNG" width="1679" height="680" class="img_ev3q"></p>
<p>Next, we need to make sure that we are logging the information from the API requests, such as client IP, request URL, response code, and response time, to do that, we need to <a href="https://learn.microsoft.com/en-us/azure/api-management/api-management-howto-app-insights?tabs=rest&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">enable the Application Insights logging on our openai</a> API in API Management.</p>
<p><img decoding="async" loading="lazy" alt="APIM Built in Logging" src="https://luke.geek.nz/assets/images/AI_Gateway_APIMBuiltinLoggingAppInsightsEnable-fcff727a466f91ea50c8b4719b747fff.PNG" width="1413" height="790" class="img_ev3q"></p>
<p>Let's take a look at a custom <a href="https://learn.microsoft.com/azure/azure-monitor/visualize/workbooks-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Monitor workbook</a> that helps visualize and bring out a lot of the data you need to make informed decisions without having to delve into KQL <em>(Kusto Query Language)</em> queries in Log Analytics.</p>
<p>In Application Insights, navigate to Workbooks, click + New, click on the Code and paste the workbook data from: <a href="https://github.com/Azure-Samples/AI-Gateway/blob/main/labs/built-in-logging/openai-usage-analysis-workbook.json" target="_blank" rel="noopener noreferrer">AI-Gateway/main/labs/built-in-logging/openai-usage-analysis-workbook.json</a>.</p>
<p>You can see the APIs getting called, the subscription key being used, the response time, and the response code.</p>
<p><img decoding="async" loading="lazy" alt="APIM Built in Logging" src="https://luke.geek.nz/assets/images/apim_test_OpenAIWorkbook-2c7ebb1f779b8e751890e56c81927e6e.gif" width="1895" height="960" class="img_ev3q"></p>
<p>If you are using a Token Limit policy, you can trace the OpenAITokenLimitExeeded exceptions. This can help you determine if you need to block any particular IP addresses either using an ip-filter policy or Application Gateway if that is in front of your API Management or if you need to increase the TPM limit.</p>
<p><img decoding="async" loading="lazy" alt="App Insights - Token Limit" src="https://luke.geek.nz/assets/images/AI_Gateway_APIMBuiltinLoggingAppInsights_TokenLimit-f8be079f178c67e719247ebb6082bd22.PNG" width="1847" height="905" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-conclusion">ð Conclusion<a href="https://luke.geek.nz/azure/implementing-ai-gateway-in-api-management/#-conclusion" class="hash-link" aria-label="Direct link to ð Conclusion" title="Direct link to ð Conclusion">â</a></h2>
<p>In this article, we have taken a look at how we can use Azure OpenAI as a backend to Azure API Management, how to test the Azure OpenAI endpoint, through Azure API Management, and how to implement Request forwarding, Backend circuit breaking, Backend Load Balancing, Response Streaming, Token rate limiting, Semantic Caching, and Logging.</p>
<p>All code can be found here: <a href="https://github.com/lukemurraynz/AI_Gateway_Tests" target="_blank" rel="noopener noreferrer">lukemurraynz/AI_Gateway_Tests</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-reference">ð Reference<a href="https://luke.geek.nz/azure/implementing-ai-gateway-in-api-management/#-reference" class="hash-link" aria-label="Direct link to ð Reference" title="Direct link to ð Reference">â</a></h2>
<ul>
<li>ð<a href="https://learn.microsoft.com/azure/api-management/api-management-key-concepts?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">What is Azure API Management</a></li>
<li>ð<a href="https://learn.microsoft.com/azure/ai-services/openai?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure OpenAI</a></li>
<li>ð<a href="https://techcommunity.microsoft.com/t5/azure-integration-services-blog/introducing-genai-gateway-capabilities-in-azure-api-management/ba-p/4146525?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Introducing GenAI Gateway Capabilities in Azure API Management</a></li>
<li>ð<a href="https://luke.geek.nz/azure/cloud-design-patterns/" target="_blank" rel="noopener noreferrer">Cloud Design Patterns</a></li>
<li>ð<a href="https://luke.geek.nz/azure/api-management-overview/" target="_blank" rel="noopener noreferrer">Features and Benefits of Azure API Management</a></li>
<li>ð<a href="https://aka.ms/apim/genai/labs" target="_blank" rel="noopener noreferrer">Azure-Samples/AI-Gateway</a></li>
</ul>]]></content>
        <author>
            <name>Luke Murray</name>
            <uri>https://luke.geek.nz</uri>
        </author>
        <category label="Azure" term="Azure"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Securing Container Supply Chains with CSSC Framework]]></title>
        <id>https://luke.geek.nz/azure/secure-container-supply-chain/</id>
        <link href="https://luke.geek.nz/azure/secure-container-supply-chain/"/>
        <updated>2024-08-08T08:50:10.680Z</updated>
        <summary type="html"><![CDATA[Explore Microsoft's Containers Secure Supply Chain (CSSC) Framework, a robust ecosystem of tools and processes for securing container supply chains.]]></summary>
        <content type="html"><![CDATA[<p>Today, we are going to take a look inside the <a href="https://learn.microsoft.com/azure/security/container-secure-supply-chain/articles/container-secure-supply-chain-implementation/containers-secure-supply-chain-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Containers Secure Supply Chain Framework</a>, a framework from Microsoft that utilizes an agile ecosystem of tools and processes built to integrate and execute security controls throughout the lifecycle of containers.</p>
<!-- -->
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">ðOverview<a href="https://luke.geek.nz/azure/secure-container-supply-chain/#overview" class="hash-link" aria-label="Direct link to ðOverview" title="Direct link to ðOverview">â</a></h2>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p><img decoding="async" loading="lazy" alt="Container Supply Chain (CSSC) Framework" src="https://luke.geek.nz/assets/images/ContainerSupplyFramework_Overview-4b5856ae5fca80ac8d85b78045c76274.PNG" width="4000" height="2250" class="img_ev3q"></p><blockquote>
<p>Microsoft's <a href="https://learn.microsoft.com/azure/security/container-secure-supply-chain/articles/container-secure-supply-chain-implementation/containers-secure-supply-chain-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Containers Secure Supply Chain Framework</a> framework is a seamless, agile ecosystem of tools and processes built to integrate and execute security controls throughout the lifecycle of containers. The container secure supply chain strategy considers all the security needs of container applications. The goal is to prevent the use of vulnerable container images and create container infrastructure with a standard security portfolio.</p>
</blockquote><p>The CSSC framework is built using the following steps:</p><ul>
<li>Identify the supply chain stages for containerized applications</li>
<li>Outline the risks and the required security controls in each stage</li>
<li>Describe the security objectives and goals in each stage</li>
<li>Identify security tools, processes, and best practices in each stage</li>
<li>Maintain security posture with metadata, logging, and reporting in each stage</li>
</ul></div></div>
<p>In essence, the Containers Secure Supply Chain (CSSC) framework ensures the security and integrity of containerized applications throughout their lifecycle. It aims to prevent vulnerable container images and create a secure container infrastructure by integrating security controls at every stage of the supply chain.</p>
<p>The CSSC framework protects against several risks, including:</p>
<ul>
<li>Vulnerable container images: Ensuring that only secure and compliant images are used.</li>
<li>Malware and unauthorized changes: Verifying the authenticity and integrity of container images.</li>
<li>Supply chain attacks: Mitigating risks from external sources and third-party vendors.</li>
<li>Runtime threats: Reducing the attack surface of running containers.</li>
</ul>
<p>By addressing these risks, the CSSC framework helps maintain a secure and reliable environment for containerized applications.</p>
<p>During each stage, make sure you have gates in place to ensure that the image is secure, meets the minimum quality standard, and gets peer approval before moving to the next stage. This could be done by using Azure Policy, Azure Security Center, or CI/CD with tools such as Azure DevOps or GitHub.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="stages-of-the-container-supply-chain">ðStages of the Container Supply Chain<a href="https://luke.geek.nz/azure/secure-container-supply-chain/#stages-of-the-container-supply-chain" class="hash-link" aria-label="Direct link to ðStages of the Container Supply Chain" title="Direct link to ðStages of the Container Supply Chain">â</a></h2>
<p>We will dig into each stage, with a focus on some of the tools, mainly <a href="https://learn.microsoft.com/azure/container-registry/container-registry-intro?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Container Registry (ACR)</a>, that can be used to implement the security controls in each stage.</p>
<p>We will consider using separate Container Registers, one for each stage, to ensure that the security controls are implemented at each stage.</p>
<p><img decoding="async" loading="lazy" alt="Azure Container registries" src="https://luke.geek.nz/assets/images/ContainerSupplyFramework_ACRRegistries-4f7f1c98a843ffe672a0673d0ee49183.PNG" width="4000" height="2250" class="img_ev3q"></p>
<ul>
<li>One for Quarantine</li>
<li>One for Catalog</li>
<li>One for deployment</li>
</ul>
<p><img decoding="async" loading="lazy" alt="Container Supply Chain (CSSC) Framework" src="https://luke.geek.nz/assets/images/ContainerSupplyFramework_PortalACRRegistries-56a878b75c3f94e96d085572334dcbc5.PNG" width="306" height="131" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>Make use of <a href="https://learn.microsoft.com/en-us/azure/container-registry/container-registry-webhook?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Container Registry webhooks</a> to trigger awareness and automation when images are pushed to the registries. This could trigger a pipeline to scan the images and move them to the next stage if they meet the minimum quality standard.</p></div></div>
<p>So, let us dig into each stage.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="stage-1-acquire">ðStage 1: Acquire<a href="https://luke.geek.nz/azure/secure-container-supply-chain/#stage-1-acquire" class="hash-link" aria-label="Direct link to ðStage 1: Acquire" title="Direct link to ðStage 1: Acquire">â</a></h3>
<p>The <a href="https://learn.microsoft.com/azure/security/container-secure-supply-chain/articles/container-secure-supply-chain-implementation/acquire-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Acquire</a> stage is the first step in the container supply chain. It involves obtaining container images from sources that you may deem trusted or un-trusted and ensuring their integrity and authenticity.</p>
<p><img decoding="async" loading="lazy" alt="Acquire" src="https://luke.geek.nz/assets/images/ContainerSupplyFramework_Acquire-061991d6f6507311d35619bc18802716.PNG" width="4000" height="2250" class="img_ev3q"></p>
<ul>
<li>The Acquire stage aims to validate and ensure compliance of external container images with enterprise policies before internal use. This includes vulnerability and malware scanning.</li>
<li>It involves centralizing the acquisition and management of external artifacts, importing images into an internal registry, and enriching images with metadata like SBOMs and provenance.</li>
<li>Key tools include Azure Container Registry (ACR) for storing and distributing images, ORAS for interacting with OCI registries, ACR Tasks for automating tasks, and Microsoft Defender for Cloud security.</li>
<li>Microsoft recommends building software from source when possible and, if not, following the CSSC frameworkâs practices for acquiring external container images.</li>
</ul>
<p>In the Aquire stage, you should establish a minimum quality standard for images sourced externally. This includes scanning for vulnerabilities and malware, verifying the authenticity and integrity of images, and enriching images with metadata like Software Bill of Materials (SBOMs) and provenance information.</p>
<p>Tools that can be useful during this stage are:</p>
<ul>
<li><a href="https://learn.microsoft.com/azure/defender-for-cloud/defender-for-containers-introduction?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Microsoft Defender for Cloud (for Containers)</a></li>
<li><a href="https://trivy.dev/" target="_blank" rel="noopener noreferrer">Trivy</a></li>
<li><a href="https://project-copacetic.github.io/copacetic/website/" target="_blank" rel="noopener noreferrer">Copacetic</a></li>
<li><a href="https://learn.microsoft.com/azure/container-registry/container-registry-intro?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Container Registry (ACR)</a></li>
</ul>
<blockquote>
<p>The process of quarantining is a security measure that consists of a series of checkpoints that are employed before an artifact is consumed. Those security checkpoints make sure that an artifact transitions from an untrusted status to a trusted status.</p>
</blockquote>
<p>Let's take a look at the <a href="https://learn.microsoft.com/azure/architecture/patterns/quarantine?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Quarantine</a> function of Azure Container Registry. This function could automate the process of scanning and quarantining images that do not meet the minimum quality standard.</p>
<p>In my demo, I will be using the <a href="https://hub.docker.com/_/debian" target="_blank" rel="noopener noreferrer">debian</a> base image from the dockerhub and pushed into my Azure Container Registry.</p>
<p><img decoding="async" loading="lazy" alt="Container Image - Debian" src="https://luke.geek.nz/assets/images/ContainerSupplyFramework_Quarantine_debianimage-3df69e9f341828f61313ba5cfb79eafc.PNG" width="1915" height="628" class="img_ev3q"></p>
<p>Let's enable Quarantine functionality on the Azure Container Registry. <strong>At the time of this article, this is a preview feature.</strong></p>
<blockquote>
<p>When a registries policy is set to <a href="https://learn.microsoft.com/rest/api/containerregistry/registries/update?view=rest-containerregistry-2023-01-01-preview&amp;tabs=HTTP&amp;WT.mc_id=AZ-MVP-5004796#quarantinepolicy" target="_blank" rel="noopener noreferrer">Quarantine</a> Enabled, all images pushed to that registry are put in quarantine by default. Only after the image has been verified and the quarantine flag removed may a subsequent pull be completed. Once Quarantine is enabled on a registry, a newly pushed image will enter a quarantine state automatically, and only a user with quarantine reader permissions can see the image.</p>
</blockquote>
<p>Using Azure CLI, we can enable Quarantine on the Azure Container Registry. Quarantine functionality is only allowed on Premium SKU registries.</p>
<p><img decoding="async" loading="lazy" alt="Enable Container Registry quarantinePolicy" src="https://luke.geek.nz/assets/images/ACR_EnableqQuarantine-3b07443b9cd59778978ceed957bc4a47.gif" width="934" height="515" class="img_ev3q"></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token builtin class-name" style="color:rgb(189, 147, 249)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">ACR_NAME</span><span class="token operator">=</span><span class="token plain">acrqr</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">id</span><span class="token operator">=</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">az acr show </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--name</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> $ACR_NAME </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--query</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable function" style="color:rgb(80, 250, 123);font-style:italic">id</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-o</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> tsv</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">az resource update </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--ids</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$id</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--set</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">properties.policies.quarantinePolicy.status</span><span class="token operator">=</span><span class="token plain">enabled</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Once the image is quarantined, you need a user with the AcrQuarantineReader role. The presumption here is the Vulnerability Scanning solution is configured to use this account.</p>
<p>We can run the following Azure CLI to check the image status in the Quarantine.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token builtin class-name" style="color:rgb(189, 147, 249)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">ACR_NAME</span><span class="token operator">=</span><span class="token plain">acrqr</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">IMAGE_NAME</span><span class="token operator">=</span><span class="token plain">debian</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">az acr manifest list </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-r</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ACR_NAME</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-n</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$IMAGE_NAME</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>!<img decoding="async" loading="lazy" alt="Check Quarantine status" src="https://luke.geek.nz/assets/images/ACR_CheckQuarantine-a08812704c6360b0ac25785c4518e204.gif" width="934" height="515" class="img_ev3q"></p>
<ol>
<li>Now using <a href="https://learn.microsoft.com/azure/defender-for-cloud/defender-for-containers-introduction?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Defender for Containers</a>, we can scan our images in the Container Registry for vulnerabilities.</li>
<li>You can also use <a href="https://trivy.dev/" target="_blank" rel="noopener noreferrer">Trivy</a> to scan the images for vulnerabilities and reveal more about the SBOM (Software Bill of Materials) used in the image.</li>
<li>Add any additional metadata to the image, such as the <a href="https://learn.microsoft.com/azure/security/container-secure-supply-chain/articles/attach-sbom?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">SBOM</a>, and <a href="https://docs.docker.com/build/attestations/slsa-provenance/" target="_blank" rel="noopener noreferrer">provenance</a> information.</li>
</ol>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>Check out <a href="https://luke.geek.nz/azure/automate-container-patching-with-trivy-copacetic-azure-devops/" target="_blank" rel="noopener noreferrer">Container Patching with Azure DevOps, Trivy and Copacetic</a> blog article for more information on how to automate the scanning of images with Copacetic in the Azure Container Registry, from an Azure DevOps pipeline.</p></div></div>
<p>Once you have determined that your Container Image's state is good, you can remove the Quarantine flag from it by running the following Azure CLI command.</p>
<p>In order to call the API, you currently need permissions for both Contributor and AcrQuarantineWriter (or AcrPush role) on the registry.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token builtin class-name" style="color:rgb(189, 147, 249)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">ACR_NAME</span><span class="token operator">=</span><span class="token plain">acrqr</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">IMAGE_NAME</span><span class="token operator">=</span><span class="token plain">debian</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">az acr repository show-manifests </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--name</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ACR_NAME</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--repository</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$IMAGE_NAME</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--detail</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Find the digest of the image you want to remove the quarantine flag from, and run the following Azure CLI command.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token builtin class-name" style="color:rgb(189, 147, 249)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">ACR_NAME</span><span class="token operator">=</span><span class="token plain">acrqr</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">IMAGE_NAME</span><span class="token operator">=</span><span class="token plain">debian</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">MANIFEST_DIGEST</span><span class="token operator">=</span><span class="token plain">sha256:b1ae8b5bfaa9afa86b50c2a151a442d832c4449cf3731bddf8a728e5628ebb59</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">REPOSITORY</span><span class="token operator">=</span><span class="token plain">debian</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">REGISTRY</span><span class="token operator">=</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ACR_NAME</span><span class="token plain">.azurecr.io</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Get the Entra ID access token</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">EID_ACCESS_TOKEN</span><span class="token operator">=</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">az account get-access-token </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--query</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> accessToken </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-o</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> tsv</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Exchange the AAD access token for an ACR refresh token</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">ACR_REFRESH_TOKEN</span><span class="token operator">=</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token variable function" style="color:rgb(80, 250, 123);font-style:italic">curl</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-s</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-X</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> POST </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-H</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">"Content-Type: application/x-www-form-urlencoded"</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable punctuation" style="color:rgb(248, 248, 242);font-style:italic">\</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">  </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-d</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">"grant_type=access_token&amp;service=</span><span class="token variable string variable" style="color:rgb(189, 147, 249);font-style:italic">$REGISTRY</span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">&amp;access_token=</span><span class="token variable string variable" style="color:rgb(189, 147, 249);font-style:italic">$EID_ACCESS_TOKEN</span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">"</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable punctuation" style="color:rgb(248, 248, 242);font-style:italic">\</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">  https://$REGISTRY/oauth2/exchange </span><span class="token variable punctuation" style="color:rgb(248, 248, 242);font-style:italic">\</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">  </span><span class="token variable operator" style="color:rgb(189, 147, 249);font-style:italic">|</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> jq </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-r</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">'.refresh_token'</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Create the repo-level scope</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">SCOPE</span><span class="token operator">=</span><span class="token string" style="color:rgb(255, 121, 198)">"repository:</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$REPOSITORY</span><span class="token string" style="color:rgb(255, 121, 198)">:pull,metadata_write"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Get the ACR access token using the refresh token</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">ACR_ACCESS_TOKEN</span><span class="token operator">=</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token variable function" style="color:rgb(80, 250, 123);font-style:italic">curl</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-s</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-X</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> POST </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-H</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">"Content-Type: application/x-www-form-urlencoded"</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable punctuation" style="color:rgb(248, 248, 242);font-style:italic">\</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">  </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-d</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">"grant_type=refresh_token&amp;service=</span><span class="token variable string variable" style="color:rgb(189, 147, 249);font-style:italic">$REGISTRY</span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">&amp;scope=</span><span class="token variable string variable" style="color:rgb(189, 147, 249);font-style:italic">$SCOPE</span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">&amp;refresh_token=</span><span class="token variable string variable" style="color:rgb(189, 147, 249);font-style:italic">$ACR_REFRESH_TOKEN</span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">"</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable punctuation" style="color:rgb(248, 248, 242);font-style:italic">\</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">  https://$REGISTRY/oauth2/token </span><span class="token variable punctuation" style="color:rgb(248, 248, 242);font-style:italic">\</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">  </span><span class="token variable operator" style="color:rgb(189, 147, 249);font-style:italic">|</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> jq </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-r</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">'.access_token'</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Check if the access token is null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$ACR_ACCESS_TOKEN</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"> </span><span class="token operator">==</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"null"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Failed to retrieve access token. Please check your credentials and scope."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">exit</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Use the ACR access token in the curl command</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-v</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-X</span><span class="token plain"> PATCH </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-H</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Authorization: Bearer </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$ACR_ACCESS_TOKEN</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-H</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Content-Type: application/json"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-d</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        "quarantineState": "Passed", </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        "quarantineDetails": "{\"state\":\"scan passed\"}"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">      }'</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string" style="color:rgb(255, 121, 198)">"https://</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$ACR_NAME</span><span class="token string" style="color:rgb(255, 121, 198)">.azurecr.io/acr/v1/</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$IMAGE_NAME</span><span class="token string" style="color:rgb(255, 121, 198)">/_manifests/</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$MANIFEST_DIGEST</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Remove Quarantine" src="https://luke.geek.nz/assets/images/ACR_RemoveQuarantine-0a75dfc6cb9ce4f99d260a60ee196a8e.gif" width="934" height="375" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="stage-2-catalog">ð¦Stage 2: Catalog<a href="https://luke.geek.nz/azure/secure-container-supply-chain/#stage-2-catalog" class="hash-link" aria-label="Direct link to ð¦Stage 2: Catalog" title="Direct link to ð¦Stage 2: Catalog">â</a></h3>
<p>The <a href="https://learn.microsoft.com/azure/security/container-secure-supply-chain/articles/container-secure-supply-chain-implementation/catalog-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Catalog</a> stage is the second step in the container supply chain. It involves storing and managing container images in a central repository, where they can be easily accessed and deployed.</p>
<p><img decoding="async" loading="lazy" alt="Catalog" src="https://luke.geek.nz/assets/images/ContainerSupplyFramework_Catalog-2a459a46cb7b5afff337d136f4c3d1ad.PNG" width="4000" height="2250" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Microsoft recommends that internal teams use container images from an internal catalog whenever possible.</p><p>If enterprises are not able to do so, we recommend the following practices for cataloging container images.</p><ul>
<li>Catalog golden images to enable internal teams to easily discover and consume approved images that enterprise applications and services require.</li>
<li>Continuously scan container images for vulnerabilities and malware, generate reports, and sign reports to ensure authenticity and integrity.</li>
<li>Monitor the lifecycle of catalog images and retire images that are out of support.</li>
</ul></div></div>
<p>After the images have been acquired, vetted by the previous step, and meet organizational requirements, it's time to move the photos into a Catalog Container Registry, where they can be stored in a central repository and easily accessed.</p>
<p>Unlike the Acquire Container Registry, this Registry will not be quarantined. However, it will need to be continuously scanned for vulnerabilities and malware as part of operations using tools like Defender for Cloud and Trivy.</p>
<ol>
<li>Now using <a href="https://learn.microsoft.com/azure/defender-for-cloud/defender-for-containers-introduction?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Defender for Containers</a>, we can scan our images in the Container Registry for vulnerabilities. As this is a Catalog registry, we need to make sure that we monitor and remediate any vulnerabilities that are found.</li>
<li>You can also make use of <a href="https://trivy.dev/" target="_blank" rel="noopener noreferrer">Trivy</a>, to scan the images for vulnerabilities.</li>
</ol>
<p>It can also be valid to move images from the Catalog back to the Quarantine registry if the Catalog registry is not monitored or the image has been found to have high-priority vulnerabilities that fall beneath an organization threshold.</p>
<p>You can use the following Azure CLI command to move an image between the Quarantine and Catalog registries.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Variables</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">SOURCE_REGISTRY</span><span class="token operator">=</span><span class="token string" style="color:rgb(255, 121, 198)">"acrqr"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">TARGET_REGISTRY</span><span class="token operator">=</span><span class="token string" style="color:rgb(255, 121, 198)">"acrcatalog"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">IMAGE_NAME</span><span class="token operator">=</span><span class="token string" style="color:rgb(255, 121, 198)">"debian:v1"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Import image from source registry to target registry</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">az acr </span><span class="token function" style="color:rgb(80, 250, 123)">import</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--name</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$TARGET_REGISTRY</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--source</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$SOURCE_REGISTRY</span><span class="token plain">.azurecr.io/</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$IMAGE_NAME</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--image</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$IMAGE_NAME</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Move Image between Registries" src="https://luke.geek.nz/assets/images/ACR_MoveQuarantinetoCatalog-f262519143351521aa7b163af208987e.gif" width="934" height="375" class="img_ev3q"></p>
<p>We can see the image now in our Catalog registry. The image is left in the Quarantine registry, as it has not been removed. If needed, you can now remove this.</p>
<p><img decoding="async" loading="lazy" alt="Azure Container Registry - Catalog" src="https://luke.geek.nz/assets/images/ContainerSupplyFramework_Catalog_debianimage-202c7557b0a984c5b522133b00dd6eb1.PNG" width="1642" height="631" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ï¸stage-3-build">ð ï¸Stage 3: Build<a href="https://luke.geek.nz/azure/secure-container-supply-chain/#%EF%B8%8Fstage-3-build" class="hash-link" aria-label="Direct link to ð ï¸Stage 3: Build" title="Direct link to ð ï¸Stage 3: Build">â</a></h3>
<p>The <a href="https://learn.microsoft.com/azure/security/container-secure-supply-chain/articles/container-secure-supply-chain-implementation/build-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Build</a> step is the third step in the container supply chain. It involves building container images from source code and ensuring that they meet security and compliance requirements, whereas previous steps were more aligned with container images that were sourced externally. However, the following practices can be applied to both.</p>
<p><img decoding="async" loading="lazy" alt="Build" src="https://luke.geek.nz/assets/images/ContainerSupplyFramework_Build-9d3e6b2ada13b3dce97ceb562cbcada5.PNG" width="4000" height="2250" class="img_ev3q"></p>
<blockquote>
<p>It is crucial to ensure that base images are always pulled from the internal catalog and verified before use. After building the images, some enterprises publish them without vulnerability and malware scanning and fail to generate attestations like SBOM, which cannot be verified in subsequent supply chain stages. It is essential to ensure that the produced container images are trusted and compliant with the enterprise policies.</p>
</blockquote>
<p>The build phase is all about building application images consistently and securely.</p>
<ul>
<li>Use trusted images only</li>
<li>Verify lifecycle and provenance metadata</li>
<li>Scan after build</li>
<li>Fix known vulnerabilities during and post-build</li>
<li>Sign images and artifacts</li>
</ul>
<p>Tools that can be used during the Build stage are:</p>
<ul>
<li><a href="https://github.com/" target="_blank" rel="noopener noreferrer">GitHub</a></li>
<li><a href="https://azure.microsoft.com/products/devops?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure DevOps</a></li>
<li><a href="https://learn.microsoft.com/azure/defender-for-cloud/defender-for-containers-introduction?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Defender for Cloud</a></li>
<li><a href="https://docs.github.com/en/code-security/getting-started/dependabot-quickstart-guide" target="_blank" rel="noopener noreferrer">Dependabot</a></li>
<li><a href="https://project-copacetic.github.io/copacetic/website/" target="_blank" rel="noopener noreferrer">Copacetic</a></li>
</ul>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p><a href="https://learn.microsoft.com/azure/container-registry/container-registry-tasks-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Container Registry (ACR) Tasks</a> can help fill in the gaps in the Build stage. ACR Tasks can automate the building of container images from source code, scanning for vulnerabilities, and signing images, as part of your build workflow.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="stage-4-deploy">ð¢Stage 4: Deploy<a href="https://luke.geek.nz/azure/secure-container-supply-chain/#stage-4-deploy" class="hash-link" aria-label="Direct link to ð¢Stage 4: Deploy" title="Direct link to ð¢Stage 4: Deploy">â</a></h3>
<p>The Deploy stage is the fourth step in the container supply chain. It involves deploying container images to production environments where end-users can access them.</p>
<p><img decoding="async" loading="lazy" alt="Build" src="https://luke.geek.nz/assets/images/ContainerSupplyFramework_Deploy-84fea8f21107edd18dd2f9add99cb341.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>This stage is usually where you move the images downstream from the Catalog registry to the application Deployment registries, where they are deployed to production environments.</p>
<p>Use a secure and scalable private registry for application deployments. Ensure that the registry is protected with role-based access control (RBAC), that images are signed, and that the correct metadata is attached.</p>
<ul>
<li>Continuously scan for vulnerabilities and malware</li>
<li>Keep artifact metadata up-to-date</li>
<li>Enforce deployment policies</li>
</ul>
<p>Just because the images have been moved to the Deployment registry does not mean that they are safe to deploy. You should still be scanning them for vulnerabilities and malware and ensuring that they are signed and have the correct metadata attached.</p>
<p>The same tools we have used in the previous stages can be used in this stage.</p>
<ul>
<li><a href="https://learn.microsoft.com/azure/defender-for-cloud/defender-for-containers-introduction?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Defender for Cloud</a></li>
<li><a href="https://project-copacetic.github.io/copacetic/website/" target="_blank" rel="noopener noreferrer">Copacetic</a></li>
<li><a href="https://trivy.dev/" target="_blank" rel="noopener noreferrer">Trivy</a></li>
<li><a href="https://helm.sh/" target="_blank" rel="noopener noreferrer">HELM</a></li>
</ul>
<p>This is the stage where Copacetic can assist with patching deployed containers and ensuring that the images are up-to-date and secure at the OS layers. The images are fully patched and tested back at the Build and Catalog stages.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="stage-5-runtime">ðStage 5: Runtime<a href="https://luke.geek.nz/azure/secure-container-supply-chain/#stage-5-runtime" class="hash-link" aria-label="Direct link to ðStage 5: Runtime" title="Direct link to ðStage 5: Runtime">â</a></h3>
<p>The Runtime stage is the fifth and final step in the container supply chain. It involves monitoring and securing running containers in production environments so that end-users can access them.</p>
<p><img decoding="async" loading="lazy" alt="Run" src="https://luke.geek.nz/assets/images/ContainerSupplyFramework_Run-2d1a6e0e361dec3fb677df39022ac514.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>This is one of the most important stages, as this is where the images are running in production and are exposed to the Internet. You should monitor the images for vulnerabilities and malware and ensure that they are signed and have the correct metadata attached.</p>
<ul>
<li>Monitor for Abnormal behavior</li>
<li>Continuously scan for vulnerabilities and malware</li>
<li>Keep runtime node ContainerSupplyFramework_Quarantine_debianimage</li>
</ul>
<p>Tools that can be used in this stage are:</p>
<ul>
<li><a href="https://learn.microsoft.com/azure/governance/policy/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Policy</a></li>
<li><a href="https://learn.microsoft.com/azure/aks/what-is-aks?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Kubernetes (AKS)</a></li>
<li><a href="https://learn.microsoft.com/azure/defender-for-cloud/defender-for-cloud-introduction?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Defender for Cloud</a></li>
<li><a href="https://open-policy-agent.github.io/gatekeeper/website/" target="_blank" rel="noopener noreferrer">Gatekeeper</a></li>
<li><a href="https://learn.microsoft.com/azure/aks/image-integrity?tabs=azure-cli&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Ratify</a></li>
</ul>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p><a href="https://portal.azure.com/#view/Microsoft_Azure_Security_CloudNativeCompute/AggregatedRecommendationBlade/assessmentKey/e9acaf48-d2cf-45a3-a6e7-3caa2ef769e0/showSecurityCenterCommandBar~/false" target="_blank" rel="noopener noreferrer">Containers running in Azure should have vulnerability findings resolved</a> Defender recommendations are worth a look to see a list of vulnerabilities, once Defender for Cloud is turned, for Azure Kubernetes Clusters.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-conclusion">ð Conclusion<a href="https://luke.geek.nz/azure/secure-container-supply-chain/#-conclusion" class="hash-link" aria-label="Direct link to ð Conclusion" title="Direct link to ð Conclusion">â</a></h3>
<p>Hopefully, this article has given you an insight into the <a href="https://learn.microsoft.com/azure/security/container-secure-supply-chain/articles/container-secure-supply-chain-implementation/containers-secure-supply-chain-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Containers Secure Supply Chain Framework</a>, and how you can implement the security controls at each stage, using Azure Container Registry, and other tools.</p>
<p><img decoding="async" loading="lazy" alt="Impact of Technology" src="https://luke.geek.nz/assets/images/ImpactofTechnology_SatyaNadella-b9091c962836d451b3892c08353da771.PNG" width="4000" height="2250" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-reference">ð Reference<a href="https://luke.geek.nz/azure/secure-container-supply-chain/#-reference" class="hash-link" aria-label="Direct link to ð Reference" title="Direct link to ð Reference">â</a></h2>
<ul>
<li>ð<a href="https://learn.microsoft.com/azure/security/container-secure-supply-chain/articles/container-secure-supply-chain-implementation/containers-secure-supply-chain-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Containers Secure Supply Chain Framework</a></li>
<li>ð<a href="https://github.com/duffney/secure-supply-chain-on-aks" target="_blank" rel="noopener noreferrer">duffney/secure-supply-chain-on-aks</a></li>
<li>ð<a href="https://learn.microsoft.com/azure/architecture/patterns/quarantine?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Quarantine pattern</a></li>
<li>ð<a href="https://www.youtube.com/watch?v=7RvFj_RWE7c" target="_blank" rel="noopener noreferrer">Secure Container Supply Chain with Notation, ORAS, and Ratify</a></li>
<li>ð<a href="https://notaryproject.dev/" target="_blank" rel="noopener noreferrer">Notary</a></li>
<li>ð<a href="https://learn.microsoft.com/azure/aks/use-azure-policy?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Secure your Azure Kubernetes Service (AKS) clusters with Azure Policy</a></li>
</ul>]]></content>
        <author>
            <name>Luke Murray</name>
            <uri>https://luke.geek.nz</uri>
        </author>
        <category label="Azure" term="Azure"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Features and Benefits of Azure API Management]]></title>
        <id>https://luke.geek.nz/azure/api-management-overview/</id>
        <link href="https://luke.geek.nz/azure/api-management-overview/"/>
        <updated>2024-08-07T09:25:09.372Z</updated>
        <summary type="html"><![CDATA[Discover the key features and benefits of Azure API Management, including security, scalability, and monitoring capabilities.]]></summary>
        <content type="html"><![CDATA[<p>Today, we are going to look at <a href="https://learn.microsoft.com/azure/api-management/api-management-key-concepts?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure API Management</a>. Azure API Management is a service that creates consistent and modern API gateways for existing back-end services. It also publishes APIs to external, partner, and internal developers. Azure API Management is a fully managed service that enables customers to publish, secure, transform, maintain, and monitor APIs.</p>
<!-- -->
<blockquote>
<p><a href="https://learn.microsoft.com/azure/api-management/api-management-key-concepts?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure API Management</a> is a hybrid, multi-cloud management platform for APIs across all environments. As a platform-as-a-service, API Management supports the complete API lifecycle.</p>
</blockquote>
<p>We'll examine the API life cycle phases in-depth and explore how Azure API Management can help you efficiently manage your APIs from start to finish.</p>
<p><img decoding="async" loading="lazy" alt="Azure API Management - Overview" src="https://luke.geek.nz/assets/images/apim_overview-9c57c798c4389c1dc408e504110da877.PNG" width="4000" height="2250" class="img_ev3q"></p>
<ul>
<li><strong>Design</strong>
The first phase of the API life cycle is Design. In this phase, we define the API's purpose, endpoints, and the data it will handle. This involves creating a blueprint for the API, including its structure and functionality. Azure API Management provides tools and templates to help you design efficient, scalable, and easy-to-use APIs.</li>
<li><strong>Develop</strong>
Once the design is in place, we move on to the development phase. This is where the actual coding happens. Developers write the code that implements the API's functionality based on the design specifications. Azure API Management supports various development environments and integrates seamlessly with tools like Visual Studio, making the development process smoother and more efficient.</li>
<li><strong>Secure</strong>
Security is a critical aspect of API management. We ensure our APIs are protected from unauthorized access and potential threats in the Secure phase. Azure API Management offers robust security features such as authentication, authorization, and encryption. These features help safeguard your APIs and the data they handle, ensuring that only authorized users can access them.</li>
<li><strong>Publish</strong>
After securing the API, it's time to make it available to users. The Publish phase involves exposing the API to developers and end-users. Azure API Management provides a developer portal where you can publish your APIs, offer documentation, and manage subscriptions. This makes it easy for developers to discover and start using your APIs.</li>
<li><strong>Scale</strong>
As your API gains popularity, you must ensure it can handle increased traffic. The Scale phase focuses on optimizing the API's performance and scalability. Azure API Management allows you to scale your APIs effortlessly, ensuring they can handle large volumes of requests without compromising performance.</li>
<li><strong>Monitor</strong>
Monitoring is essential to ensuring your APIs function correctly and efficiently. Azure API Management provides detailed analytics and logging capabilities in the Monitor phase. You can track usage patterns, monitor performance metrics, and identify potential issues before they impact your users.</li>
<li><strong>Analyze</strong>
In the Analyze phase, we use the data collected during monitoring to gain insights into how our APIs are used. Azure API Management offers powerful analytics tools that help you understand user behavior, identify trends, and make data-driven decisions to improve your APIs continuously.</li>
</ul>
<p>In the modern digital era, transformation is more than just a buzzwordâit's necessary. APIs are at the heart of this transformation, enabling connected experiences and seamless integration of services and data.</p>
<p><img decoding="async" loading="lazy" alt="Azure API Management - Digital Transformation" src="https://luke.geek.nz/assets/images/apim_overview_digitaltransformation-a579568972f49eb29cfd94428caa6c86.gif" width="2238" height="1200" class="img_ev3q"></p>
<p>APIs are crucial in connecting various devices and platforms. Whether it's a smart home system, wearable technology, automotive applications, or industrial equipment, APIs facilitate the communication and interoperability between these diverse endpoints.</p>
<p>Please be sure to think about your daily interactions with technology. From unlocking your smartphone, using applications on your tablet, streaming content on your smart TV, and engaging in augmented reality experiences, APIs are working behind the scenes to ensure a smooth and connected experience. They enable devices and applications to talk to each other, share data, and create a cohesive user experience.</p>
<p>APIs connect various services, databases, servers, and cloud infrastructures. They allow these systems to interact, share data, and coordinate complex functions.</p>
<p>APIs also enable businesses to be agile and adaptive. By exposing functionalities through APIs, companies can quickly integrate new services, scale their operations, and meet evolving customer demands. They empower developers to build robust applications, enhance user experiences, and drive digital growth.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-api-governance">ð API governance<a href="https://luke.geek.nz/azure/api-management-overview/#-api-governance" class="hash-link" aria-label="Direct link to ð API governance" title="Direct link to ð API governance">â</a></h2>
<p>Three crucial aspects of API governance and usage play a significant role in achieving success:</p>
<ul>
<li><strong>FaÃ§ade Abstraction</strong>
This concept involves creating an interface that simplifies and standardizes how APIs interact with backend systems.
Aggregate or Slice: APIs can aggregate data from multiple sources or slice it into meaningful pieces for specific use cases. This flexibility allows businesses to present data in the most relevant and valuable way to their users.
Normalize or Modernize: FaÃ§ade Abstraction also helps normalize or modernize legacy systems, making them compatible with modern applications. This allows you to extend the life of older systems and integrate them with new technologies without extensive rework.
Decouple Lifecycle Mock: Decoupling the API lifecycle from the backend systems ensures that changes in backend services do not disrupt the API functionality. Mocking services during the development and testing phases further ensures smooth transitions and updates.</li>
<li><strong>Front Door Control</strong>
This aspect is about managing and controlling how APIs are accessed and utilized.
Route and Accelerate: You can optimize your applications' performance and responsiveness by routing API requests efficiently. Acceleration techniques like caching and load balancing can significantly improve user experience.
Secure and Protect: Security is paramount in API management. Front Door Control involves implementing robust security measures to protect APIs from threats and unauthorized access. These measures include authentication, authorization, and data encryption.
Transform and Observe: Transforming API requests and responses to meet specific requirements and observing API usage patterns helps maintain control and ensure optimal performance. Monitoring tools provide insights into how APIs are being used and can alert you to potential issues before they become critical.</li>
<li><strong>Frictionless Consumption</strong>
This principle is about making it easy for developers and users to discover, access, and use your APIs.
Onboarding: A smooth onboarding process is crucial for attracting and retaining users. Clear documentation, tutorials, and support help users quickly understand and start using your APIs.
Discover and Learn: APIs should be easily discoverable. A well-organized developer portal where users can learn about the available APIs, their functionalities, and use cases can achieve this.
Try and Obtain Access: Allowing users to try APIs in a sandbox environment and easily obtain access through streamlined registration encourages experimentation and adoption.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-stakeholders">ð¤ Stakeholders<a href="https://luke.geek.nz/azure/api-management-overview/#-stakeholders" class="hash-link" aria-label="Direct link to ð¤ Stakeholders" title="Direct link to ð¤ Stakeholders">â</a></h2>
<p>Azure API Management has the following stakeholders:
&nbsp;</p>
<ul>
<li><strong>App Developers</strong>
These are the individuals or teams responsible for creating applications that consume APIs. They use the platform to discover, learn, try, onboard, and get help with APIs.
Employees, Partners.</li>
<li><strong>Customers</strong>
These stakeholders leverage the APIs to enhance workflows, integrate systems, and improve customer experiences.</li>
<li><strong>Apps on Devices</strong>
These represent the end-user applications that interact with the APIs. They could be mobile apps, web applications, IoT devices, or other software that consumes APIs.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ï¸-planes">âï¸ Planes<a href="https://luke.geek.nz/azure/api-management-overview/#%EF%B8%8F-planes" class="hash-link" aria-label="Direct link to âï¸ Planes" title="Direct link to âï¸ Planes">â</a></h2>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Azure API Management consists of three main planes:
&nbsp;</p><ul>
<li><strong>User Plane</strong>
Developer Portal: This portal serves as the primary interface for app developers. It provides resources for developers to discover, learn, try, and onboard with APIs. The portal ensures developers have the support they need to integrate APIs efficiently into their applications.</li>
<li><strong>Data Plane</strong>
Gateway: The Gateway is a secure bridge between the API consumers and the backend services. It enforces security policies, manages traffic, and ensures reliable API performance. The gateway handles rate limiting, authentication, and request routing tasks.</li>
<li><strong>Management Plane</strong>
API Management Plane: This is where API providers manage the lifecycle of their APIs. The management plane includes tools for abstracting, securing, evolving, observing, and monetizing APIs. This layer ensures that APIs are managed effectively, from creation and deployment to monitoring and analytics.</li>
</ul></div></div>
<p>Azure API Management integrates with various Azure services and microservices, providing a cohesive environment for managing and deploying APIs. This integration allows organizations to leverage the full power of Azure's cloud capabilities, ensuring that their APIs are scalable, secure, and performant.</p>
<ul>
<li><strong>Benefits</strong></li>
</ul>
<p>Some of the benefits of Azure API Management include:</p>
<ul>
<li>Discoverability: Developers can easily find and access APIs.</li>
<li>Security: Robust security measures protect data and ensure compliance.</li>
<li>Scalability: APIs can scale to meet growing demand.</li>
<li>Efficiency: Streamlined management processes enhance productivity.</li>
<li>Monetization: Organizations can generate revenue from their APIs.</li>
</ul>
<p>In conclusion, Azure API Management is a robust platform that enables organizations to create, manage, and scale APIs efficiently. By following the API life cycle phases and leveraging Azure API Management's features, businesses can deliver seamless digital experiences, drive innovation, and stay ahead in today's competitive landscape.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-azure-api-management-plans">ð Azure API Management plans<a href="https://luke.geek.nz/azure/api-management-overview/#-azure-api-management-plans" class="hash-link" aria-label="Direct link to ð Azure API Management plans" title="Direct link to ð Azure API Management plans">â</a></h2>
<p><img decoding="async" loading="lazy" alt="API Management - Pricing Tiers" src="https://luke.geek.nz/assets/images/apim_overview_pricingtiers-bcfa201ca0c9fd9294564e842a8384f7.gif" width="2238" height="1200" class="img_ev3q"></p>
<p>Azure API Management offers various service tiers that provide specific capabilities and benefits. Let's explore these tiers in more detail.</p>
<ul>
<li><strong>Consumption Tier</strong>
&nbsp;
Key Features include:</li>
</ul>
<ul>
<li>No Infrastructure to Provision or Manage: The consumption tier eliminates the need to manage infrastructure. This serverless approach lets you focus solely on your APIs without worrying about the underlying hardware or software.</li>
<li>Built-in Auto-scaling Down to Zero: It automatically scales to handle varying loads and can scale down to zero during inactivity, ensuring cost-efficiency.</li>
<li>Consumption-based Micro Billing: Billing is based on actual usage, making it a cost-effective solution for unpredictable or fluctuating traffic applications.</li>
<li>Variable, Usage-based Monthly Cost: You pay only for what you use, allowing for a flexible and budget-friendly approach.</li>
<li>No Reserved Capacity: This tier does not require any reserved capacity, making it ideal for projects with uncertain demands.</li>
<li>Shared Management Plane: The management plane is shared, simplifying administration and reducing costs.</li>
<li>On-demand Activation: APIs can be activated on demand, providing flexibility and agility.</li>
<li>Curated Set of Features and Usage Limits: This tier offers a curated set of features and usage limits, ensuring a streamlined and efficient API management experience.</li>
</ul>
<ul>
<li><strong>Developer, Basic, Standard, and Premium Tiers</strong>
&nbsp;
Key Features include:</li>
</ul>
<ul>
<li>No Infrastructure to Provision or Manage: Similar to the consumption tier, these tiers also eliminate the need to manage infrastructure, allowing you to focus on development and deployment.</li>
<li>Manual Scaling or External Auto-scaling: These tiers support manual scaling or external auto-scaling, providing more control over resource allocation.</li>
<li>Billing Based on Reserved Capacity: Billing is based on reserved capacity, offering predictable and consistent costs.</li>
<li>Constant, Predictable Monthly Cost: Unlike the consumption tier, these tiers provide a constant, predictable monthly cost, making budget planning easier.</li>
<li>Reserved Capacity: These tiers offer reserved capacity, ensuring that your APIs can handle consistent and high-demand workloads.</li>
<li>Dedicated Management, User, and Data Planes: With dedicated planes, you get enhanced security, performance, and isolation, which is crucial for mission-critical applications.</li>
<li>Always On APIs are always available, ensuring high availability and reliability for your applications.</li>
<li>Full Set of Features: These tiers offer complete features without governance limits, providing comprehensive capabilities for complex and large-scale API management needs.</li>
</ul>
<p><img decoding="async" loading="lazy" alt="APIM Pricing Tiers" src="https://luke.geek.nz/assets/images/apim_pricing_tiers-795f483a8b914bce8072e7d9bfd089fa.png" width="4000" height="2250" class="img_ev3q"></p>
<p>Let's delve into the key features of each tier.</p>
<table><thead><tr><th>Feature</th><th>Basic</th><th>Basic v2</th><th>Standard</th><th>Standard v2</th><th>Premium</th></tr></thead><tbody><tr><td>Microsoft Entra Integration</td><td>No</td><td>Yes</td><td>Yes</td><td>Yes</td><td>Yes</td></tr><tr><td>Virtual Network (VNet) Support</td><td>No</td><td>No</td><td>No</td><td>Yes</td><td>Yes</td></tr><tr><td>Private Endpoint Support</td><td>Yes</td><td>No</td><td>Yes</td><td>No</td><td>Yes</td></tr><tr><td>Multi-region Deployment</td><td>No</td><td>No</td><td>No</td><td>No</td><td>Yes</td></tr><tr><td>Availability Zones</td><td>No</td><td>No</td><td>No</td><td>No</td><td>Yes</td></tr><tr><td>Autoscaling</td><td>Yes</td><td>No</td><td>Yes</td><td>No</td><td>Yes</td></tr><tr><td>Self-hosted Gateway</td><td>No</td><td>No</td><td>No</td><td>No</td><td>Yes</td></tr><tr><td>Backup and Restore</td><td>Yes</td><td>No</td><td>Yes</td><td>No</td><td>Yes</td></tr><tr><td>Management over Git</td><td>Yes</td><td>No</td><td>Yes</td><td>No</td><td>Yes</td></tr><tr><td>Static IP</td><td>Yes</td><td>No</td><td>Yes</td><td>No</td><td>Yes</td></tr></tbody></table>
<blockquote>
<p>"Accelerate your API strategy with Azure API Management, the comprehensive lifecycle solution trusted by thousands of enterprises worldwide. From abstraction and security to observability and discoverability, the APIM platform empowers you to manage APIs effortlessly across clouds and on-premises environments. Built for reliability, security, scalability, and performance, it's designed to support DevOps and developers, seamlessly integrating with Azure services. Benefit from global availability, robust support, and competitive, accessible pricingâAzure API Management simplifies API management so you can focus on innovation."</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-api-lifecycle">ð API Lifecycle<a href="https://luke.geek.nz/azure/api-management-overview/#-api-lifecycle" class="hash-link" aria-label="Direct link to ð API Lifecycle" title="Direct link to ð API Lifecycle">â</a></h2>
<p><img decoding="async" loading="lazy" alt="API Lifecycle" src="https://luke.geek.nz/assets/images/apim_api_lifecycle-82f1ac68f6035c8177bb18ad49f66b02.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>The API lifecycle consists of several phases, each essential for creating, managing, and optimizing APIs. This lifecycle emphasizes the continuous and iterative nature of API development and management.</p>
<ul>
<li><strong>Design</strong></li>
</ul>
<p>The lifecycle begins with the Design phase. In this phase, APIs are conceptualized and defined.</p>
<p>Key features include:</p>
<ul>
<li>Start fast with proxy mode: Quickly create an API proxy to start testing.</li>
<li>Design and mock: Define and simulate APIs to validate their design.</li>
<li>Import from a definition: Use existing API definitions to create new APIs.</li>
<li>Import from Azure resources: Generate APIs based on Azure services.</li>
<li>Capture schema from test calls: Automatically generate API schemas from sample requests and responses.</li>
</ul>
<ul>
<li><strong>Develop</strong></li>
</ul>
<p>The next phase is Develop, where the API is built and refined. This stage includes:</p>
<ul>
<li>50+ policies: Apply various policies to control API behavior.</li>
<li>SOAP-to-REST: Convert SOAP services to RESTful APIs.</li>
<li>Visual Studio Code integration: Use VS Code for development and debugging.</li>
<li>Live policy debugging: Debug policies in real-time.</li>
<li>API scaffolding: Automatically generate code and configurations for APIs.</li>
</ul>
<ul>
<li><strong>Secure</strong></li>
</ul>
<p>In the Secure phase, the API's security is ensured. This involves:</p>
<ul>
<li>Data | Management | User planes: Secure different aspects of data and management.</li>
<li>Keys, OAuth, certificates, custom: Implement authentication and authorization mechanisms.</li>
<li>1st and 3rd party identity providers: Integrate with various identity providers.</li>
<li>Request/response validation: Validate API requests and responses for security.</li>
<li>IP-based access control: Restrict access based on IP addresses.</li>
<li>Private networking: Secure APIs within private networks.</li>
<li>Compliance: Ensure APIs comply with industry standards and regulations.</li>
</ul>
<ul>
<li><strong>Publish</strong></li>
</ul>
<p>After securing the API, it is time to Publish it. This stage involves:</p>
<ul>
<li>Revisions and versions: Manage different versions and revisions of the API.</li>
<li>API products, user groups, subscriptions: Organize APIs into products and manage user access.</li>
<li>Customizable developer portal: Provide a portal for developers to access and use APIs.</li>
<li>Integrated API playground: Allow developers to test APIs within the portal.</li>
<li>Export to the Power Platform: Integrate APIs with Microsoft Power Platform.</li>
<li>Self-service onboarding: Enable users to onboard themselves.</li>
<li>DevOps: Integrate with DevOps pipelines for continuous integration and deployment.</li>
</ul>
<ul>
<li><strong>Scale</strong></li>
</ul>
<p>Once published, the API needs to be scaled to handle increased demand. The Scale phase includes:</p>
<ul>
<li>Worldwide availability: Deploy APIs globally to ensure availability.</li>
<li>Multi-region deployments: Distribute APIs across multiple regions for redundancy and performance.</li>
<li>Availability zones: Utilize availability zones to increase reliability.</li>
<li>Caching: Implement caching to improve performance.</li>
<li>Auto-scaling: Automatically adjust resources based on demand.</li>
<li>Hybrid and multi-cloud: Deploy APIs in hybrid and multi-cloud environments.</li>
<li>Azure Arc enabled: Manage and govern APIs across different environments using Azure Arc.</li>
</ul>
<ul>
<li><strong>Monitor</strong></li>
</ul>
<p>The API must be monitored after scaling to ensure it operates correctly. The Monitor phase involves:</p>
<ul>
<li>Azure Monitor: Use Azure Monitor to track and analyze API performance.</li>
<li>Application Insights: Gain insights into application performance and user behavior.</li>
<li>Logs | Metrics | Traces | Alerts: Collect and analyze logs, metrics, and traces and set up alerts.</li>
<li>Configurable verbosity: Adjust the level of detail in logs and metrics.</li>
<li>E2E request tracing: Trace requests end-to-end to diagnose issues.</li>
<li>Local telemetry for self-hosted gateway: Collect telemetry data from self-hosted API gateways.</li>
</ul>
<ul>
<li><strong>Analyze</strong></li>
</ul>
<p>Finally, in the Analyze phase, the collected data is used to gain insights and improve the API. This stage includes:</p>
<ul>
<li>Built-in reports: Use built-in reports for quick insights.</li>
<li>Custom reports with Log Analytics: Create custom reports using Log Analytics.</li>
<li>Reports in Power BI: Visualize data and generate reports using Power BI.</li>
<li>Custom telemetry pipelines: Set up custom telemetry pipelines for advanced analysis.</li>
</ul>
<p>This lifecycle ensures that APIs are well-designed, developed, secured, published, scaled, monitored, and analyzed, providing a comprehensive approach to API management.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-design">ð¨ Design<a href="https://luke.geek.nz/azure/api-management-overview/#-design" class="hash-link" aria-label="Direct link to ð¨ Design" title="Direct link to ð¨ Design">â</a></h3>
<p><img decoding="async" loading="lazy" alt="API Lifecycle - Design" src="https://luke.geek.nz/assets/images/apim_apilifecyle_design-54ff90660862827afb8ef8a7337fc86d.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Code-and design-first approaches to building APIs</p>
<p>API Management supports both approaches to building APIs:</p>
<ul>
<li>
<p><strong>Code-first approach</strong>
Implement the API and generate the API specification as an afterthought (i.e., with Swashbuckle). Benefits:
More convenient for API developers: The only option for existing APIs</p>
</li>
<li>
<p><strong>Design-first approach</strong>
Create an API specification, review it with stakeholders, and implement the API Kickstart development by scaffolding the code from the API specification.</p>
</li>
</ul>
<p>Benefits:</p>
<p>Better API consumer experience thanks to the deliberate API design Reduced risk thanks to the API review processes</p>
<p><img decoding="async" loading="lazy" alt="API Lifecycle - Develop" src="https://luke.geek.nz/assets/images/apim_apilifecyle_design_codefirst-aac369e9d29dc29ac251aabef2348ce8.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>You can create APIs</p>
<ul>
<li>Support for SOAP, REST, WebSocket and GraphQLAPIs</li>
<li>Import an API from OpenAPI(1, 2, or 3), WADL, or WSDL files</li>
<li>Import an API from App Service, Logic App, Function App, or Container App</li>
<li>Create a blank API</li>
</ul>
<p><img decoding="async" loading="lazy" alt="API Management - Create an API" src="https://luke.geek.nz/assets/images/apim_apilifecyle_design_createAPI-977bd9f958be9031251fc22ff3b217ee.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>So, let us create a new API by importing the <a href="https://swapi.dev/" target="_blank" rel="noopener noreferrer">Star Wars API</a>.</p>
<ol>
<li>Open your Azure API Management instance</li>
<li>Navigate to APIs</li>
<li>Click on + Add API</li>
<li>Click on HTTP (manually define an HTTP API)</li>
<li>Select Full</li>
<li>Fill in the details:<!-- -->
<ul>
<li>Display name: Star Wars</li>
<li>Name: star-wars</li>
<li>Description: Star Wars API</li>
<li>Web service URL: <a href="https://swapi.dev/api" target="_blank" rel="noopener noreferrer">https://swapi.dev/api</a></li>
<li>API URL suffix: starwars</li>
</ul>
</li>
<li>Click Create
Now that we have imported our initial API endpoint, we can start defining the operations we want to expose.</li>
<li>Click on + Add operation</li>
<li>Fill in the details:<!-- -->
<ul>
<li>Display name: Get People</li>
<li>Name: get-people</li>
<li>URL template: /people</li>
<li>HTTP verb: GET
Now, let's add another operation to get information about Starships in the Star Wars universe. Fill in the details:</li>
<li>Display name: Get Starships</li>
<li>Name: get-starships</li>
<li>URL template: /starships</li>
<li>HTTP verb: GET</li>
</ul>
</li>
</ol>
<p>Now let us test it.</p>
<ol>
<li>Click on Get Starships API operation</li>
<li>Click on test</li>
<li>Click + Add parameter</li>
<li>Type in Search in the name and the value as 'Star Destroyer'</li>
<li>Click Send</li>
</ol>
<p><img decoding="async" loading="lazy" alt="API Management - Add Star Wars API" src="https://luke.geek.nz/assets/images/apim-add-starwars-api-8768b3f40bbb8bf0827b19e951ed6320.gif" width="1901" height="885" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>You can use a wildcard in the URL path if you are not sure of an accurate specification while you work on the API design.</p><p><img decoding="async" loading="lazy" alt="API Management - wildcard" src="https://luke.geek.nz/assets/images/apim_apilifecyle_design_wildcardproxy-c75b189db9307fd2a601fbce2ffd3e06.PNG" width="4000" height="2250" class="img_ev3q"></p></div></div>
<p>Now that we have imported and tested an existing API, let's consider designing a new one.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Design a API" src="https://luke.geek.nz/assets/images/apim_apilifecyle_design_designaapi-a8683536c660e8a0c0c94ca27a4a3df5.png" width="4000" height="2250" class="img_ev3q"></p>
<p>Azure offers powerful resources to streamline and enhance our workflow.</p>
<p>Defining the API:</p>
<p>First, let's talk about defining our API. Azure provides two main approaches:</p>
<p>Form-Based Editors:</p>
<p>These editors are highly intuitive, offering a user-friendly interface to input all necessary details about your API.
Perfect for those who prefer a guided, step-by-step setup.</p>
<p>Text-Based Editors:</p>
<p>For those more comfortable with coding, Azure allows us to edit the API definition directly in JSON format.
This method offers greater flexibility and control over the API specifications.</p>
<p>Visual Studio Code Extension:</p>
<p>In addition to the Azure portal, you can also leverage the Visual Studio Code extension. This extension integrates seamlessly with Azure, allowing you to manage and define your APIs directly within your development environment. It's an excellent tool for developers who prefer to work locally.</p>
<p>Testing the API:</p>
<p>Once the API is defined, the next crucial step is testing. Azure simplifies this process in several ways:</p>
<p>Azure Portal Testing:
You can test your API directly within the Azure portal. This feature lets you ensure everything functions correctly without switching between multiple tools.
Schema Generation:
Azure can generate schemas from your API responses. These schemas provide a clear structure of your API's data, ensuring that both developers and consumers understand the expected input and output formats.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Mock API" src="https://luke.geek.nz/assets/images/apim_apilifecyle_design_mockapi-b84e58f8c6ec4e7661ed0a65692f0946.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Adopting a design-first approach can significantly enhance efficiency and collaboration. One technique we can utilize is mocking the API. Let's explore how this approach can benefit our development workflow.</p>
<p>Design-First Approach - Mock the API:</p>
<ol>
<li>Unblock Front-End Teams:</li>
</ol>
<p>Mocking API responses is a game-changer for front-end developers.
Providing predefined responses enables front-end teams to continue their development work without waiting for the back-end to be fully implemented.
This leads to parallel development, reducing bottlenecks and speeding up the overall project timeline.</p>
<ol start="2">
<li>Use an Example Defined in the API Definition:</li>
</ol>
<p>The process starts with defining an example response within the API definition.
This predefined response acts as a placeholder, simulating the actual API behavior.
It ensures that front-end teams have consistent and reliable data to work with during the early stages of development.
3. Configure with a Single-Line Policy:</p>
<p>One of Azure API Management's standout features is the ability to configure mocking with a simple, single-line policy.</p>
<p>As shown in the example on the image, the policy can be written as:</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">inbound</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">base</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">mock-response</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">status-code</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">200</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">content-type</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">application/json</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">inbound</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="APIM - Mock Design" src="https://luke.geek.nz/assets/images/apim_apilifecyle_design_apimock-9020b782711066d24856bf651e1cb633.gif" width="1901" height="885" class="img_ev3q"></p>
<p>This configuration tells the API to return a mock response with a status code of 200 and a content type of application/json.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Websocket" src="https://luke.geek.nz/assets/images/apim_apilifecyle_design_websocket-7eeea69c929249bae19d4bab29f78273.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p><a href="https://learn.microsoft.com/azure/api-management/websocket-api?tabs=portal&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">WebSocket API</a> support enables real-time communication, making our APIs more dynamic and responsive.</p>
<p><a href="https://learn.microsoft.com/azure/api-management/websocket-api?tabs=portal&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">WebSocket API</a> support in Azure API Management opens up a whole new realm of possibilities for real-time applications. Let's delve into what this entails and how it can benefit our API infrastructure.</p>
<p>Passthrough Support for WebSocket APIs:</p>
<ol>
<li>Establishing Connections:</li>
</ol>
<p>Client applications can establish WebSocket connections directly with API Management (APIM).
This setup allows for continuous, two-way communication between clients and backend services.
Once the connection is established, APIM seamlessly proxies WebSocket messages to the backend services, ensuring smooth and reliable communication.</p>
<ol start="2">
<li>Features of WebSocket API Support:</li>
</ol>
<p>CRUD Operations:</p>
<p>With WebSocket API support, we can perform Create, Read, Update, and Delete (CRUD) operations on WebSocket APIs.
This flexibility ensures that our APIs can handle various real-time data interactions effectively.</p>
<p>Apply Policies:</p>
<p>We can apply policies to handshake requests, which is crucial for managing security, authentication, and other operational requirements.
These policies ensure that only authorized and legitimate requests can establish WebSocket connections.
Browse and Test:</p>
<p>WebSocket APIs can be easily browsed and tested within the Azure and Developer portals.
This capability allows developers to interact with and validate the WebSocket APIs during the design and development phases.</p>
<p>Monitoring and Logging:</p>
<p>Azure Monitor provides metrics and logs specifically for WebSocket APIs.
These monitoring tools enable us to track performance, detect issues, and gain insights into the usage patterns of our WebSocket connections.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ï¸-develop">ð ï¸ Develop<a href="https://luke.geek.nz/azure/api-management-overview/#%EF%B8%8F-develop" class="hash-link" aria-label="Direct link to ð ï¸ Develop" title="Direct link to ð ï¸ Develop">â</a></h3>
<p><img decoding="async" loading="lazy" alt="API Lifecycle - Develop" src="https://luke.geek.nz/assets/images/apim_apilifecyle_develop-40d0a11c0c3d20462c3787e679224373.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Azure API Management offers a range of features to streamline the development process and enhance the functionality of our APIs.</p>
<p><img decoding="async" loading="lazy" alt="APIM - API Challenges" src="https://luke.geek.nz/assets/images/apim_apilifecyle_develop_apichallenges-54766c74b68d018aaf589566b240e6c0.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>APIs are the backbone of modern digital ecosystems, enabling connected experiences across various devices and services. However, managing these APIs efficiently comes with its own set of challenges. API management provides a structured approach to streamlining the API lifecycle.</p>
<ol>
<li>Consume:</li>
</ol>
<p><em>(Developer Portal)</em></p>
<p>The first pillar of API management is the Developer Portal.
This portal is a crucial interface where developers can discover, understand, and consume APIs.
It provides comprehensive documentation, code samples, and testing tools, making it easier for developers to integrate APIs into their applications.
The Developer Portal offers a centralized hub for API information, enhancing developer productivity and reducing the time to market for new applications.</p>
<ol start="2">
<li>Mediate:</li>
</ol>
<p><em>(Gateway)</em></p>
<p>The gateway is at the heart of API management. It mediates the communication between client applications and backend services.
The Gateway ensures secure, reliable, and efficient API traffic management.
It provides various capabilities, such as load balancing, rate limiting, and security enforcement.
By mediating API requests, the Gateway helps scale applications, protect against malicious attacks, and ensure consistent performance.</p>
<ol start="3">
<li>Publish:</li>
</ol>
<p><em>(Azure Portal)</em></p>
<p>The third pillar is the Azure Portal, where APIs are published and managed.
This portal allows API providers to define and publish their APIs, making them available to developers.</p>
<p>It offers tools for monitoring API usage, setting up policies, and managing API versions.
API providers can ensure their APIs are robust, secure, and up-to-date through the Azure Portal.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Product" src="https://luke.geek.nz/assets/images/apim_apilifecyle_develop_apichallengesproduct-0c1b5041e09b1ec6aeb15e30b50fadc1.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>APIs are essential for modern digital ecosystems, but managing them efficiently can be complex. API management provides a unified approach to streamlining product interaction and backend services.</p>
<p>Products:</p>
<ul>
<li>Diverse Product Integration:</li>
</ul>
<p>We have multiple products (Products 1 to 5) at the top. Each product has unique functionalities and API requirements.
These products represent different applications and services that need to communicate with various backend systems.</p>
<p>API Management Layer:</p>
<ul>
<li>Centralized Management:</li>
</ul>
<p>The middle section represents the API Management layer, a crucial component in this architecture.
API Management acts as a mediator, facilitating seamless communication between the products and the backend services.
It standardizes API interactions, ensuring consistency, security, and reliability.</p>
<ul>
<li>Backend Systems:</li>
</ul>
<p>Backend on Azure and On-premises:
At the bottom, we see the backend systems, categorized into Azure-based and on-premises backends.
Azure backends include services such as Azure Functions, Virtual Machines, and Logic Apps.
On-premises backends consist of traditional servers and databases.
API Management ensures that products seamlessly interact with cloud-based and on-premises backend systems.
Critical Benefits of API Management:</p>
<ul>
<li>Unified API Gateway:</li>
</ul>
<p>Provides a single entry point for all API requests, simplifying the management of APIs across multiple products and services.
Enhanced Security:</p>
<p>Authentication, authorization, and rate-limiting policies ensure secure communication between products and backend systems.</p>
<ul>
<li>Scalability:</li>
</ul>
<p>Handles large volumes of API traffic, enabling applications to scale efficiently.</p>
<ul>
<li>Monitoring and Analytics:</li>
</ul>
<p>Offers insights into API usage, performance metrics, and error tracking, helping in proactive management and optimization.
Developer Empowerment:</p>
<p>Facilitates a developer-friendly environment with comprehensive documentation, testing tools, and self-service capabilities.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Cross Domain policies" src="https://luke.geek.nz/assets/images/apim_apilifecyle_design_crossdomainpolicy-dee621e36fc6a851c601b6f649becdea.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Policy Scopes</p>
<p><img decoding="async" loading="lazy" alt="APIM - Policy Scopes" src="https://luke.geek.nz/assets/images/apim_apilifecyle_design_policyscopes-798c598ad09cebfb296141546877fe55.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Let's examine the policy scopes. Understanding the scope is crucial to applying the right policy in the right place. Policies are inherited from the parent scope to the child scope.</p>
<p>So let us go through them.</p>
<ul>
<li>Global <em>(Red Border)</em></li>
</ul>
<p>Description: Global policies apply to all requests and responses passing through the API Management instance. They are the outermost scope, impacting every operation, API, and product.
Usage: Commonly used for policies like CORS <em>(Cross-Origin Resource Sharing)</em> and logging, which should be consistent across the entire API Management instance.</p>
<ul>
<li>Workspace <em>(Yellow Border)</em></li>
</ul>
<p>Description: This scope is associated with a workspace, which groups related APIs and other components within API Management.
Usage: Policies defined at this level are used when consistent policy enforcement is needed across multiple APIs belonging to the same workspace.</p>
<ul>
<li>Product <em>(Green Border)</em></li>
</ul>
<p>Description: Product-level policies apply to all APIs included within a specific product. Products are a way to bundle APIs together for subscription and access management.
Usage: Common for setting rate limits and quotas that apply to all APIs in the product, helping to manage usage and prevent abuse.</p>
<ul>
<li>API <em>(Blue Border)</em></li>
</ul>
<p>Description: API-level policies apply to all operations within a specific API. This scope allows for API-wide behavior customization.
Usage: Often used for API-specific security measures like JWT (JSON Web Token) validation or other API-wide configurations.</p>
<ul>
<li>Operation <em>(Purple Border)</em></li>
</ul>
<p>Description: Operation-level policies are the most granular and apply to a specific operation within an API <em>(e.g., a single endpoint or method)</em>.
Usage: Useful for operation-specific requirements like caching, URL rewriting, or request/response transformation.</p>
<ul>
<li>Inbound and Outbound policies</li>
</ul>
<p>Inbound policies are applied as the request comes in from the caller, and outbound policies are applied as the response is sent back to the caller after being processed by the backend.</p>
<p>Each of these scopes allows for different levels of customization and control over how requests and responses are handled within Azure API Management.</p>
<p>If we take a look at the <a href="https://learn.microsoft.com/azure/api-management/api-management-howto-properties?tabs=azure-portal&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">policy named values</a> and <a href="https://learn.microsoft.com/azure/api-management/api-management-policy-expressions?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">expressions</a>.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Policy Values" src="https://luke.geek.nz/assets/images/apim_apilifecyle_design_policysvalues-a699bb0fcc072978e1873e5c20effd9d.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>We can see that Named Values are a powerful feature in Azure API Management that allows us to define reusable variables and secrets that can be used across policies.</p>
<blockquote>
<p>Policies are a collection of statements that are executed sequentially on the request or response of an API. Policy statements can be constructed using literal text values, policy expressions, and named values.</p>
</blockquote>
<p>Named values are a global collection of name/value pairs in each API Management instance. There is no imposed limit on the number of items in the collection. Named values can be used to manage constant string values and secrets across all API configurations and policies.</p>
<p>Lets take a look at some out of the box policies</p>
<p><img decoding="async" loading="lazy" alt="APIM - Out of the box policies" src="https://luke.geek.nz/assets/images/apim_apilifecyle_design_outoftheboxpolicies-5282f68c21386cddf8904f61e5df4f1e.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Azure API Management includes, "Out of the box policies" provides the majority of use cases that that can be implemented to manage access, transform data, advance functionalities, integrate with Dapr, authenticate users, cache data, manage cross-domain calls, and validate information.</p>
<p>Let us delve into each category to understand the capabilities these policies offer.</p>
<ul>
<li><strong>Access Restriction</strong></li>
</ul>
<p>Access restriction policies are crucial for controlling who can access your services and how often. These policies include:</p>
<p>Check HTTP header: Validates headers in HTTP requests.
Limit call rate by subscription/key: Controls the rate of API calls based on the subscription or key.
Restrict caller IPs: Allows access only from specified IP addresses.
Set usage quota by subscription/key: Limits the usage based on subscription or key.
Validate client certificate: Ensures the authenticity of the client via certificates.
Validate JWT (JSON Web Token): Verifies the token to ensure secure access.</p>
<ul>
<li><strong>Transformation</strong></li>
</ul>
<p>Transformation policies handle the modification and conversion of data formats and content. These policies include:</p>
<p>Convert JSON to XML / XML to JSON: Transforms data between JSON and XML formats.
Find and replace string in body: Replaces specific strings in the request or response body.
Mask URLs in content: Hides sensitive URLs within the content.
Set backend service/body/HTTP header/query string parameter: Customizes backend service configurations and request parameters.
Rewrite URL: Modifies the URL of incoming requests.
Transform XML using XSLT: Applies XSLT to transform XML data.</p>
<ul>
<li><strong>Advanced</strong></li>
</ul>
<p>Advanced policies provide extended functionalities for handling requests and responses. These include:</p>
<p>Send one-way request / request: Facilitates sending HTTP requests.
Set HTTP proxy / request method / status code / variable: Configures proxy, method, status code, and variables.
Control flow / Emit metric: Manages the flow of requests and emits metrics.
Log to Event Hub / Trace: Logs events and traces for monitoring.
Mock response / Forward request: Creates mock responses or forwards requests.
Limit concurrency / Return response / Retry / Wait: Manages concurrency, responses, and retry mechanisms.</p>
<ul>
<li><strong>Dapr Integration</strong></li>
</ul>
<p>Dapr (Distributed Application Runtime) integration policies enable communication with Dapr services:</p>
<p>Send request to a service / message to a pub/subtopic: Facilitates interaction with Dapr services and pub/subtopics.
Trigger output binding: Initiates output bindings in Dapr.</p>
<ul>
<li><strong>Authentication</strong></li>
</ul>
<p>Authentication policies ensure that only authorized users can access your services:</p>
<p>Authenticate with basic / client certificate / managed identity: Supports various authentication methods to verify user identity.</p>
<ul>
<li><strong>Caching</strong></li>
</ul>
<p>Caching policies improve performance by storing and retrieving data from the cache:</p>
<p>Store to cache / Get value from cache / Store value from cache / Remove value from cache: Manages caching operations to optimize data retrieval.</p>
<ul>
<li><strong>Cross Domain</strong>
Cross-domain policies handle calls across different domains:</li>
</ul>
<p>CORS / JSON: Manages cross-origin resource sharing and JSON data handling.</p>
<ul>
<li><strong>Validation Policies</strong></li>
</ul>
<p>Validation policies ensure the integrity and correctness of data:</p>
<p>Validate content/parameters/headers/status code / GraphQL request: Check the validity of content, parameters, headers, status codes, and GraphQL requests.</p>
<p>An example of policies that are useful is <strong>Request Forwarding</strong>:</p>
<p><img decoding="async" loading="lazy" alt="APIM - Policy Example" src="https://luke.geek.nz/assets/images/apim_apilifecyle_design_outoftheboxpolicies_RequestForwarding-16185468fc02efa145d2c8fe3fdb3017.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>This policy is usually inherited from the global scope via the </p><base> tag. If no specific policy is set, it defaults to the base configuration.
Timeout Settings: The forwarding timeout can be configured between 30 seconds to 10 minutes, with the default being 5 minutes.
Redirect Handling: It can be configured to follow redirects or, by default, return them to the caller.<p></p>
<ul>
<li>You can configure Retry (<retry></retry>)</li>
</ul>
<p>Triggering Conditions: Retry is triggered when a specified expression evaluates to true.
Backoff Intervals: Offers options for fixed, linear, or exponential backoff intervals.
Fast First Retry: An optional feature for a quick retry attempt.
Request Copy: Does not retain a copy of the request automatically, ensuring efficient resource utilization.</p>
<ul>
<li>Limit Concurrency (<limit-concurrency></limit-concurrency>)</li>
</ul>
<p>Concurrency Cap: Caps the number of concurrent requests forwarded to the backend to prevent overloading.
Policy Integration: Can be used in conjunction with other policies to limit the number of requests entering enclosed policies.
Set Backend Service (<set-backend-service></set-backend-service>)</p>
<p>Runtime Changes: Allows changing the backend service during runtime, providing flexibility in managing backend services.
Conditional Policies: Can be configured with conditional policies for blue/green deployment, ensuring smooth transitions and updates.</p>
<p>and Authentication (<authentication></authentication>)</p>
<p><img decoding="async" loading="lazy" alt="APIM - Authentication policy" src="https://luke.geek.nz/assets/images/apim_apilifecyle_design_outoftheboxpolicies_Authentication-c478c63564154abbcde4d4cae67ce3a3.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Such as:</p>
<ul>
<li>validate-jwt</li>
</ul>
<p>Purpose: Validates JSON Web Tokens (JWTs).
Supported Standards:</p>
<ul>
<li>
<p>JWS (JSON Web Signature)</p>
</li>
<li>
<p>JWE (JSON Web Encryption)</p>
</li>
<li>
<p>RSA256 and HS256 algorithms</p>
</li>
<li>
<p>OpenID Configuration: Supports OpenID Configuration endpoints for validation.</p>
</li>
<li>
<p>Claims Validation: Can check specific claims within the JWT.</p>
</li>
<li>
<p>Scope: Can be configured at any policy scope, offering flexibility in where it is applied.</p>
</li>
<li>
<p>validate-client-certificate</p>
</li>
</ul>
<p>Purpose: Enforces that a certificate presented by a client matches the specified validation rules and claims.
Key Attributes:</p>
<ul>
<li>validate-revocation="true": Ensures the certificate has not been revoked.</li>
<li>validate-trust="true": Checks that the certificate is trusted.</li>
<li>validate-not-before="true": Ensures the certificate is not used before a certain date.</li>
<li>validate-not-after="true": Ensures the certificate is not used after a certain date.</li>
<li>ignore-error="false": Indicates whether errors should be ignored.</li>
</ul>
<p>Identities Section:</p>
<p>Contains one or more identity elements.</p>
<ul>
<li>Each identity element includes a thumbprint attribute, identifying the specific certificate by its thumbprint.</li>
</ul>
<p>Let us take a look at the <a href="https://marketplace.visualstudio.com/items?itemName=ms-azuretools.vscode-apimanagement" target="_blank" rel="noopener noreferrer">Azure API Management Visual Studio Code extension</a>.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Visual Studio Code" src="https://luke.geek.nz/assets/images/apim_apilifecyle_design_vscodeextension-6c9faef973d2df0e2a4218ac00c0c4ba.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>The Azure API Management Visual Studio Code extension provides a seamless experience for managing APIs directly from your development environment.</p>
<p><img decoding="async" loading="lazy" alt="VSCode Visual Studio Extension" src="https://luke.geek.nz/assets/images/VSCode_APIMExtension-158b8751c63a5dfe40d6dfbdbe4428df.gif" width="1876" height="992" class="img_ev3q"></p>
<p>The extension allows us to test and edit APIs directly from Visual Studio Code and push those changes straight to Azure API Management, streamlining the development process and enhancing productivity.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Visual Studio Code - Test APIs" src="https://luke.geek.nz/assets/images/apim_apilifecyle_design_vscodeextensiontest-8bb4910ae743ac6f40b54e8b0d903db5.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Let us take a look at some of the Deployment Options for Azure API Management.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Deployment Options" src="https://luke.geek.nz/assets/images/apim_apilifecyle_design_deploymentoptions-a51ad19bab22e3d6c31a9312e9b1b814.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Azure API Management is an ARM (Azure Resource Manager) resource and can be deployed using <a href="https://learn.microsoft.com/azure/azure-resource-manager/templates/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">ARM templates</a>, <a href="https://learn.microsoft.com/azure/azure-resource-manager/bicep/overview?tabs=bicep&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Bicep</a>, or <a href="https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs" target="_blank" rel="noopener noreferrer">Terraform</a>.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>It is worth noting that Azure API Management has a <a href="https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/scenarios/app-platform/api-management/landing-zone-accelerator?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Landing Zone Accelerator</a>, which is a set of pre-built configurations and best practices for deploying Azure API Management in a secure and compliant manner.</p><p><img decoding="async" loading="lazy" alt="APIM - Landing Zone Accelerator" src="https://luke.geek.nz/assets/images/apim_reference-implementation-59035bb0917552fdf01ea63f2b3529b9.png" width="1233" height="675" class="img_ev3q"></p></div></div>
<p><a href="https://azure.github.io/apiops/" target="_blank" rel="noopener noreferrer">APIOps</a> is a set of practices and tools that help organizations manage the full lifecycle of APIs, from design to deprecation. It combines the principles of DevOps with API management to streamline API development and deployment.</p>
<p><img decoding="async" loading="lazy" alt="APIOps" src="https://luke.geek.nz/assets/images/apim_apilifecyle_publish_APIOps-35ac2c2bbfd02a0746c79ba1ce9bcfab.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="APIOps" src="https://luke.geek.nz/assets/images/ApiOps-ba714e5dbf5a703e46c7826affab267c.gif" width="1280" height="720" class="img_ev3q"></p>
<p>APIOps can be used to automate API management tasks, improve collaboration between development and operations teams, and ensure consistency and quality across APIs, and API Management environments, such as Development, Testing and Production.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-secure">ð Secure<a href="https://luke.geek.nz/azure/api-management-overview/#-secure" class="hash-link" aria-label="Direct link to ð Secure" title="Direct link to ð Secure">â</a></h3>
<p><img decoding="async" loading="lazy" alt="API Lifecycle - Secure" src="https://luke.geek.nz/assets/images/apim_apilifecyle_secure-cebce17d19a653c3e13d5626181e07fb.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Security is a critical aspect of API management, ensuring that APIs are protected from unauthorized access, data breaches, and other security threats. Azure API Management offers a range of security features to safeguard APIs and ensure compliance with industry standards.</p>
<p>The <a href="https://owasp.org/" target="_blank" rel="noopener noreferrer">Open Web Application Security Project (OWASP)</a> has identified the top 10 critical API security risks for 2023</p>
<p><img decoding="async" loading="lazy" alt="APIM - Security" src="https://luke.geek.nz/assets/images/apim_apilifecyle_secure_OWASP-852e95d7cdf827aa49b1b515ba81ab78.PNG" width="4000" height="2250" class="img_ev3q"></p>
<table><thead><tr><th><strong>#</strong></th><th><strong>Threat</strong></th><th><strong>Description</strong></th><th><strong>Mitigation</strong></th></tr></thead><tbody><tr><td>1</td><td>Broken Object Level Authorization</td><td>Unauthorized access to objects.</td><td>Implement key/token/certificate-based authentication and request transformation. Policy-based Access Control: Use policies to enforce authorization rules. OAuth2/JWT: Integrate with Entra ID for token validation.</td></tr><tr><td>2</td><td>Broken Authentication</td><td>Weak authentication mechanisms.</td><td>Use strong key/token-based authentication methods and transform requests appropriately. Authentication Policies: Enforce authentication using OAuth2, OpenID Connect, certificates, and API keys.</td></tr><tr><td>3</td><td>Broken Object Property Level Authorization</td><td>Unauthorized access to object properties.</td><td>Filter or mask sensitive data and ensure both request and response validations. Data Masking: Use policies to mask sensitive data. Validation: Validate input to ensure only authorized properties are accessed.</td></tr><tr><td>4</td><td>Unrestricted Resource Consumption</td><td>Overuse of resources leads to service denial.</td><td>Apply throttling and quota limits and manage backend concurrency effectively. Rate Limiting and Quotas: Use policies to set rate limits and quotas. Caching: Reduce load by caching responses.</td></tr><tr><td>5</td><td>Broken Function Level Authorization</td><td>Unauthorized access to functions.</td><td>Enforce key/token-based and custom authorizations. Role-Based Access Control (RBAC): Use Azure RBAC to control access to different API operations. Request Validation: Validate incoming requests to ensure they don't contain malicious URLs. Network Security: Use VNETs and NSGs to control outbound traffic.</td></tr><tr><td>Configuration Management: Use Azure Policy and deployment stacks to enforce security configurations. Automated Deployments: Use CI/CD pipelines to ensure consistent and secure deployments.</td><td></td><td></td><td></td></tr><tr><td>6</td><td>Unrestricted Access to Sensitive Business Flows</td><td>Uncontrolled access to critical business operations.</td><td>Validate all requests and responses meticulously. Custom Policies: Implement custom policies to validate requests and responses, ensuring sensitive operations are protected.</td></tr><tr><td>7</td><td>Server-Side Request Forgery (SSRF)</td><td>Attackers tricking the server into making requests to unintended locations.</td><td>Validate remote resources and user-supplied URIs and ensure response validation.</td></tr><tr><td>8</td><td>Security Misconfiguration</td><td>Incorrectly configured API settings.</td><td>Maintain an up-to-date API catalog and manage the API lifecycle rigorously.</td></tr><tr><td>9</td><td>Improper Inventory Management</td><td>Exposing more endpoints than necessary.</td><td>Regularly update and document your API endpoints to manage exposure effectively. API Versioning: Implement API versioning to manage the exposure of endpoints. Documentation: Keep API documentation updated and use tools like Swagger or OpenAPI.</td></tr><tr><td>10</td><td>Insufficient Logging and Monitoring</td><td>Lack of proper logging and monitoring mechanisms.</td><td>Ensure comprehensive and updated documentation and maintain robust logging and monitoring practices. Azure Monitor and Application Insights: Integrate with these services for comprehensive logging and monitoring. Alerts: Set up alerts for unusual activities.</td></tr><tr><td></td><td></td><td></td><td></td></tr></tbody></table>
<p>Azure API Management provides a range of security features to protect APIs from these threats.</p>
<p>Let us take a look at securing the different planes of Azure API Management.</p>
<p><img decoding="async" loading="lazy" alt="APIM - APIM Planes" src="https://luke.geek.nz/assets/images/apim_apilifecyle_secure_planes-0ea6cbc8bcb55e476bb51c8bc191abeb.PNG" width="4000" height="2250" class="img_ev3q"></p>
<table><thead><tr><th>Plane Name</th><th>Used For</th></tr></thead><tbody><tr><td>User Plane</td><td>Securing user interactions and data at the entry point.</td></tr><tr><td>Management Plane</td><td>Managing and securing interactions between API providers and the management system.</td></tr><tr><td>Data Plane</td><td>Securing the flow and integrity of data between the gateway and backend services.</td></tr></tbody></table>
<p><img decoding="async" loading="lazy" alt="APIM - Data Plane" src="https://luke.geek.nz/assets/images/apim_apilifecyle_secure_dataplanes-eb2b2e6da5490011cb00516c8d2bf4fd.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>In today's interconnected digital landscape, securing backend APIs is paramount. One key strategy for achieving this is through robust data plane security. This layered defense mechanism protects sensitive data and applications from unauthorized access and malicious attacks. Let's delve deeper into how data plane security works and the roles of its components.</p>
<p><strong>Firewall: Blocking Suspicious Requests</strong></p>
<p>The first line of defense in data plane security is the firewall. It acts as a gatekeeper, scrutinizing incoming requests to block any that appear suspicious. The firewall employs several rule sets and mechanisms to identify and mitigate potential threats:</p>
<ul>
<li>OWASP Core Rule Sets: These are standardized rules for detecting common web application security risks.</li>
<li>Bot Protection Rule Set: This helps in identifying and blocking automated bot traffic that could pose security risks.</li>
<li>Custom Rules: Organizations can define their own rules tailored to their specific security requirements.</li>
</ul>
<p><strong>Gateway: Authenticating and Authorizing Requests</strong></p>
<p>Once a request passes through the firewall, it reaches the gateway. The gateway is responsible for performing in-depth request authentication and authorization to ensure only valid requests proceed. Key functions of the gateway include:</p>
<ul>
<li>Authentication Mechanisms: OAuth 2, client certificates, and custom authentication methods.</li>
<li>Authorization Mechanisms: Including IP filtering and custom authorization rules.</li>
<li>Request/Response Validation: Ensuring that both incoming requests and outgoing responses meet predefined security criteria.</li>
<li>Throttling: Managing the rate of incoming requests to prevent denial-of-service (DoS) attacks.</li>
</ul>
<p><strong>Backend APIs: Fine-Grained Authorization</strong></p>
<p>The final layer involves the backend APIs themselves, which must accept requests only from trusted sources. This layer applies fine-grained authorization to enforce strict access controls. Key security measures include:</p>
<ul>
<li>HTTP Basic (Shared Secret): Simple but effective method for authenticating requests.</li>
<li>Mutual Certificates: Ensuring both client and server authenticate each other.</li>
<li>OAuth 2: Secure token-based authentication.</li>
<li>Managed Identity and IP Filtering: This involves restricting access based on IP addresses and managing identities to enforce security policies.</li>
<li>Private Networking: Isolating the APIs within a secure network environment.</li>
</ul>
<p><img decoding="async" loading="lazy" alt="APIM - Data Plane - Facade" src="https://luke.geek.nz/assets/images/apim_apilifecyle_secure_dataplanesfacafe-ec2c06831c35062b6f9f186e25827f6d.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="APIM - Data Plane - Keys" src="https://luke.geek.nz/assets/images/apim_apilifecyle_secure_dataplaneskeys-9777cedbe4e30ba09947149fa6408fe9.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="APIM - Data Plane - JWT" src="https://luke.geek.nz/assets/images/apim_apilifecyle_secure_dataplanejwt-555c0ba40ac5b90feb6fcd40120a2c23.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="APIM - Data Plane - Client certificates" src="https://luke.geek.nz/assets/images/apim_apilifecyle_secure_dataplaneclientcerts-4c8eaaeaa5fcd111bf7aa6322f9d5cfc.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="APIM - Data Plane - Throttling" src="https://luke.geek.nz/assets/images/apim_apilifecyle_secure_dataplanethrottling-050c154f6878ef96a54df966082ac87a.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="APIM - Data Plane - Sanitization" src="https://luke.geek.nz/assets/images/apim_apilifecyle_secure_dataplaneresponsesanitization-18068eacf98a67abccb32d21af05ef76.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="APIM - Data Plane - DDoS" src="https://luke.geek.nz/assets/images/apim_apilifecyle_secure_dataplanereddos-9b7e6f30c693a2fde8bf2a31c97ef510.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Let's take a look at the security considerations when networking.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Private Networking Security" src="https://luke.geek.nz/assets/images/apim_apilifecyle_secure_privatenetworking-9b7722a9ff678a4447ef50b7898dfa96.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Azure API Management has two networking options:</p>
<ul>
<li>Internal</li>
<li>External</li>
</ul>
<p>The <a href="https://learn.microsoft.com/azure/api-management/api-management-using-with-internal-vnet?tabs=stv2&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">internal</a> option is more secure, as it is not exposed to the public internet. It is ideal for scenarios where you want to restrict access to your APIs to only internal clients or services.
The <a href="https://learn.microsoft.com/azure/api-management/api-management-using-with-vnet?tabs=stv2&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">external</a> option is exposed to the public internet, making it accessible to a broader audience. This option suits scenarios where you want to provide public access to your APIs.</p>
<p><img decoding="async" loading="lazy" alt="APIM - External" src="https://luke.geek.nz/assets/images/apim_apilifecyle_secure_external-eea39bf0a2989265bea5284a96292daf.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="APIM - External" src="https://luke.geek.nz/assets/images/apim_apilifecyle_secure_internal-46a2eebec44ffb8c40d479d82334b34b.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>You can also use the best of both worlds by allowing Azure API Management in Internal mode to publish APIs to the Internet or external customers and using Azure Front Door or Azure Application Gateway to expose the APIs to the Internet.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Internal with WAF" src="https://luke.geek.nz/assets/images/apim_apilifecyle_secure_internalwaf-f13da5e00ddbbdc68805301204d404b4.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Deciding between using Azure API Management (APIM) in Internal or External mode depends on your specific requirements for security, accessibility, and network configuration. Here are some key considerations:</p>
<ul>
<li>Internal Mode</li>
</ul>
<p>Accessibility: The APIM endpoints are accessible only from within the Virtual Network (VNet) via an internal load balancer.
Security: This mode is more secure as it restricts access to the APIM endpoints to only those resources within the VNet.
Use Case: This is ideal for scenarios where you need to protect sensitive APIs and ensure that they are only accessible from within your organizationâs network.</p>
<ul>
<li>External Mode</li>
</ul>
<p>Accessibility: The APIM endpoints are accessible from the public internet via an external load balancer.
Security: While still secure, this mode allows for broader access, including from the internet.
Use Case: Suitable for scenarios where you must expose APIs to external clients or partners.</p>
<p>Deciding between Internal and External modes depends on your specific requirements and use case. Consider your APIs' security, accessibility, and network configuration needs to determine the best mode for your scenario.</p>
<p>For example:</p>
<p>Security Requirements: Internal mode is preferable if your APIs handle sensitive data.
Accessibility Needs: If you need to provide access to external clients, external mode is the way to go.
Network Configuration: Consider your existing network setup and how APIM will integrate.</p>
<p><img decoding="async" loading="lazy" alt="APIM Compliance" src="https://luke.geek.nz/assets/images/apim_apilifecyle_secure_compliance-61bc71cb1f56cbd5a74479627c54648a.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Azure API Management meets Compliance requirements, such as:</p>
<ul>
<li>GDPR</li>
<li>HIPAA</li>
<li>ISO 27001 PCI</li>
</ul>
<p>More information on the compliance can be found here: <a href="https://learn.microsoft.com/azure/compliance/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure compliance documentation</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-publish">ð Publish<a href="https://luke.geek.nz/azure/api-management-overview/#-publish" class="hash-link" aria-label="Direct link to ð Publish" title="Direct link to ð Publish">â</a></h3>
<p><img decoding="async" loading="lazy" alt="API Lifecycle - Publish" src="https://luke.geek.nz/assets/images/apim_apilifecyle_publish-205798b51e663ddfade8f5f686f1c5d4.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Once an API is designed, developed, and secured, it is ready to be published. Azure API Management offers a range of features to help you publish and manage your APIs effectively.</p>
<p>One of those features is the Developer Portal.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Developer Portal" src="https://luke.geek.nz/assets/images/apim_apilifecyle_publish_DeveloperPortal-f85d911221a99a624cba998b951d2ebb.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>The Developer Portal in API Management <em>(APIM)</em> is a discovery and self-onboarding point for application developers. Here are the primary functions and features it offers:</p>
<ul>
<li>Discover APIs:
Developers can explore and find available APIs to integrate into their applications.</li>
<li>Learn How to Use Them:
The portal provides comprehensive documentation and tutorials to help developers understand how to use the APIs effectively.</li>
<li>Test Them Out with Interactive Console:
Developers can interactively test the APIs within the portal using a built-in console. This allows them to see how the APIs work and validate their functionality before integrating them into their applications.</li>
<li>Create and Manage Accounts:
Developers can create accounts on the portal, manage their profiles, and keep track of their API usage and subscriptions.</li>
<li>Request and Manage API Access:
The portal enables developers to request access to specific APIs and manage their access permissions, ensuring they have the appropriate level of access for their needs.</li>
<li>Analyze API Usage:
Developers can analyze their API usage data to monitor performance, identify trends, and optimize their application's interaction with the APIs.</li>
</ul>
<p>The Developer Portal is customizable, allowing organizations to tailor it to their needs and branding. It is a central hub for developers to discover, learn, and interact with APIs, streamlining the API consumption process and fostering collaboration between API providers and consumers.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Developer Portal" src="https://luke.geek.nz/assets/images/apim_apilifecyle_publish_DeveloperPortalcustomization-72463c4ebb9c44c60b2311c58b4e2799.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>You can also self-host the Developer Portal, whether in an App Service, a Virtual Machine, or a Kubernetes Cluster.</p>
<p>You can find the files here: <a href="https://github.com/Azure/api-management-developer-portal" target="_blank" rel="noopener noreferrer">Azure/api-management-developer-portal</a>.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Developer Portal" src="https://luke.geek.nz/assets/images/apim_apilifecyle_publish_DeveloperPortalselfhostedn-069f2ed78160a74b6322dd38a80f8e69.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="APIM - Developer Portal" src="https://luke.geek.nz/assets/images/apim_apilifecyle_publish_DeveloperPortaSwagger-decbc50ea2f117494ba14cc171919160.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Let us take a look at Revisions and Versions.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Revisions and Versions" src="https://luke.geek.nz/assets/images/apim_apilifecyle_publig_RevisionsVersions-99ac42aa3108180b3837524d8c3afda4.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Azure API Management provides the ability to manage <a href="https://learn.microsoft.com/azure/api-management/api-management-revisions?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">revisions</a> and <a href="https://learn.microsoft.com/azure/api-management/api-management-versions?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">versions</a> of APIs, allowing you to make changes and updates without affecting existing consumers.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Revisions and Versions" src="https://luke.geek.nz/assets/images/apim_apilifecyle_publig_RevisionsVersionscompare-8f91e2e2549e8680e224f91d4a824482.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="APIM - Revisions" src="https://luke.geek.nz/assets/images/apim_apilifecyle_publig_Revisions-891796e529b758dec142662a6fcee7fa.PNG" width="4000" height="2250" class="img_ev3q"></p>
<table><thead><tr><th>Scenario</th><th>Description</th><th>Benefits</th></tr></thead><tbody><tr><td>Non-Breaking Changes to Your API</td><td>Modifications that do not disrupt existing end-user functionality.</td><td>- Track and document changes systematically.</td></tr><tr><td></td><td></td><td>- Ensure a smooth transition for developers using the API.</td></tr><tr><td>Potential Roll-Back of Changes</td><td>Reverting to a previous stable state if new changes cause problems.</td><td>- Quickly revert to a stable state.</td></tr><tr><td></td><td></td><td>- Minimize downtime and maintain service reliability.</td></tr><tr><td>Communicating Changes to Your Developer Community</td><td>Keep your developer community informed about your changes.</td><td>- Provide detailed logs and documentation of changes.</td></tr><tr><td></td><td></td><td>- Help developers understand how updates might affect their applications and how to adapt to them.</td></tr></tbody></table>
<p><img decoding="async" loading="lazy" alt="APIM - Versions" src="https://luke.geek.nz/assets/images/apim_apilifecyle_publig_versions-99eadd57f18b471dbcc7a1dce2014886.PNG" width="4000" height="2250" class="img_ev3q"></p>
<table><thead><tr><th>Scenario</th><th>Description</th><th>Benefits</th></tr></thead><tbody><tr><td>Show relationship between APIs</td><td>Demonstrating how different versions of APIs are related</td><td>Helps developers understand the evolution and compatibility of APIs</td></tr><tr><td>Provide a predictable way to switch APIs</td><td>Giving developers a clear method to switch between different API versions</td><td>Reduces confusion and ensures smoother transitions between versions</td></tr><tr><td>Add breaking changes</td><td>Introducing changes that are not backward compatible</td><td>Allows for significant improvements and updates without disrupting users</td></tr><tr><td>Try out changes and solicit feedback</td><td>Testing new features or changes and gathering community feedback</td><td>Encourages community engagement and helps refine the API before release</td></tr></tbody></table>
<p>Let's look at the following flowchart to decide between revisions and versions.</p>
<!-- -->
<p><img decoding="async" loading="lazy" alt="APIM - Revisions and Versions" src="https://luke.geek.nz/assets/images/apim_apilifecyle_publig_RevisionsVersexample-0e5b4528d60d7818b41646da3edfc676.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Now that we have reviewed the Revisions and versions, let's examine <a href="https://learn.microsoft.com/azure/api-management/api-management-howto-add-products?tabs=azure-portal&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Products</a>.</p>
<blockquote>
<p>In Azure API Management, a product contains one or more APIs, a usage quota, and the terms of use. After a product is published, developers can subscribe to the product and begin to use the product's APIs.</p>
</blockquote>
<p>APIs <em>(Application Programming Interfaces)</em> enable seamless interaction between software applications. However, managing multiple APIs can be challenging. Bundling APIs with products has emerged as an effective strategy to streamline this process.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Products" src="https://luke.geek.nz/assets/images/apim_apilifecyle_publish_BundleAPIs-85ccffcc743bbdacf5b4ed9eb87dbf95.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>API bundling involves grouping multiple APIs into a single package or product. This approach simplifies developers' and organizations' management, subscription, and usage of APIs.</p>
<ul>
<li>
<p>Developer Portal
Browse Products: Developers can explore various API products available in the portal.
Subscribe to Products: Once a suitable product is identified, developers can subscribe to it.
Manage Subscriptions and Keys: The portal allows developers to manage their subscriptions and obtain the necessary API keys.</p>
</li>
<li>
<p>Management Plane
Manage Products and API Associations: Administrators can define and manage the associations between products and their respective APIs.
Define Product-Scoped Policies: Specific policies can be set for each product, ensuring controlled and secure access.
Approve and Manage Subscriptions: Administrators can approve subscription requests and manage existing subscriptions.
Collect and Analyze Usage Data: Usage data is collected and analyzed to monitor and optimize API performance.
Monetize Access: Administrators can monetize API access by setting pricing plans and usage limits.</p>
</li>
<li>
<p>Gateway
Authenticate API Requests: The gateway authenticates incoming API requests using the provided keys.
Execute Product-Scoped Policies: It ensures that the defined policies for each product are enforced during API execution.</p>
</li>
</ul>
<p><img decoding="async" loading="lazy" alt="APIM - Products" src="https://luke.geek.nz/assets/images/apim_apilifecyle_publish_APISubscriptions-1114aabf06a703c07c8428202397544b.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Understanding the relationships between users, groups, products, APIs, and subscriptions is crucial for efficient and effective management.</p>
<table><thead><tr><th>Entity</th><th>Relationships</th></tr></thead><tbody><tr><td><strong>User</strong></td><td>- Can have many Subscriptions</td></tr><tr><td></td><td>- Can belong to many Groups</td></tr><tr><td><strong>Group</strong></td><td>- Can contain many Users</td></tr><tr><td></td><td>- Can have many Subscriptions</td></tr><tr><td></td><td>- Built-in: Guest, Developer, Admin</td></tr><tr><td></td><td>- Custom: native or Entra ID</td></tr><tr><td><strong>Subscription</strong></td><td>- Each Subscription is related to one User or Group</td></tr><tr><td></td><td>- Can provide access to one Product</td></tr><tr><td><strong>Product</strong></td><td>- Can be part of many Subscriptions</td></tr><tr><td></td><td>- Can contain many APIs</td></tr><tr><td><strong>API</strong></td><td>- Each API is part of one Product</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-scale">ð Scale<a href="https://luke.geek.nz/azure/api-management-overview/#-scale" class="hash-link" aria-label="Direct link to ð Scale" title="Direct link to ð Scale">â</a></h3>
<p><img decoding="async" loading="lazy" alt="API Lifecycle - Scale" src="https://luke.geek.nz/assets/images/apim_apilifecyle_scale-bf01c71d9390e9a22b78f911a885e31a.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Azure and the Azure API Management service have a significant <a href="https://azure.microsoft.com/en-au/explore/global-infrastructure/products-by-region?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">global footprint</a>, with 44+ public regions worldwide, 6 regions for US government use, and 4 regions in China, showcasing its extensive infrastructure and specialized services.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Scale" src="https://luke.geek.nz/assets/images/apim_apilifecyle_scale_GlobalPresence-adb8dcab06686cc7e9769fe85fb80887.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="APIM - Multi-region" src="https://luke.geek.nz/assets/images/apim_apilifecyle_scale_Multiregion-0e2e7c23dce94b1c00a01ce868718b69.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Azure API Management's multi-region deployment offers a robust solution for improving API reliability and reducing latency. Let's dive into the key features and benefits of this setup.
Improved Availability and Reduced Latency</p>
<p>One of the standout features of Azure API Management's multi-region deployment is the significantly improved availability of the data plane. You can expect minimal downtime with a Service Level Agreement (SLA) of 99.99% compared to the standard 99.95%. This increased reliability ensures that your APIs remain accessible to users worldwide, enhancing the overall user experience.</p>
<ul>
<li>Scalability Across Multiple Regions</li>
</ul>
<p>A single Premium instance of Azure API Management can be scaled across multiple regions. This flexibility allows you to deploy additional units into the primary or secondary regions based on your needs. However, regions and units come at an additional cost. This scalability ensures that your API infrastructure can grow alongside your business demands.</p>
<ul>
<li>Primary and Secondary Regions</li>
</ul>
<p>In a multi-region deployment, the primary region hosts all components, including the gateway, developer portal, management API, and developer portal API. If the primary region becomes unavailable, these components are inaccessible, highlighting the importance of a robust primary region setup.</p>
<p>On the other hand, secondary regions host only the gateway. These secondary gateways can operate on the last received configuration while the primary area is unavailable. They periodically try to reconnect and catch up, ensuring that API requests continue to be processed even during primary region outages.</p>
<ul>
<li>Global API Availability</li>
</ul>
<p>One of the most significant advantages of multi-region deployment is that all APIs are available in every region. Azure Traffic Manager plays a crucial role in routing requests to the closest available region in this setup. Using Traffic Managerâs performance routing with a 5-minute Time-to-Live (TTL), API requests are efficiently managed, reducing latency and improving response times for users worldwide.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Multi-Region Example" src="https://luke.geek.nz/assets/images/apim_apilifecyle_scale_MultiregionEExample-676cd55575626c8fc3d3a5ad58e06340.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Lets take a look at the nuances on the anatomy of an Azure API Management instance.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Anatomy" src="https://luke.geek.nz/assets/images/apim_apilifecyle_scale_AnatomyAPIM-c63666f907fc47e4c67abd2488e01422.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>An Azure API Management instance with 1 unit, represented by two machines (Machine #1 and Machine #2). Each machine has a set of components that work together to manage and secure APIs.</p>
<table><thead><tr><th>Machine</th><th>Component</th><th>Description</th></tr></thead><tbody><tr><td>Machine #1</td><td>Control-Plane</td><td>The administrative interface for configuring and managing APIs and policies.</td></tr><tr><td></td><td>Gateway</td><td>Handles API requests and applies rate limiting and authentication policies.</td></tr><tr><td></td><td>Developer Portal</td><td>Customizable portal for developers to discover, learn, and use APIs.</td></tr><tr><td>Machine #2</td><td>Control-Plane</td><td>Redundant administrative interface for high availability.</td></tr><tr><td></td><td>Gateway</td><td>Redundant API Gateway for load balancing and fault tolerance.</td></tr><tr><td></td><td>Developer Portal</td><td>Another instance of the Developer Portal to ensure high availability.</td></tr></tbody></table>
<p>This is a typical setup of an Azure API Management instance. It emphasizes redundancy and high availability by distributing core components (Control-Plane, Gateway, and Developer Portal) across multiple machines. This setup ensures the API management service remains operational even if one machine fails.</p>
<p>However, to ensure high availability and disaster recovery, one may want to expand the Azure API Management instance to another region.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Scale" src="https://luke.geek.nz/assets/images/apim_apilifecyle_scale_AnatomyAPIMSecondRegion-f223eb30d4dba49d7cb4bbf5d2d90e21.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>When you scale an Azure API Management instance to another region, you are essentially creating a secondary region deployment. This setup provides high availability and disaster recovery capabilities, ensuring your APIs remain accessible even during a regional outage by expanding the Gateway service. All Control planet traffic and the developer portal are still managed by the primary region, however your APIs will still function.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Availability Zones" src="https://luke.geek.nz/assets/images/apim_apilifecyle_scale_AvaliabilityZone-d4ef68e4c9fcf5423cf2c986990752fa.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>By deploying your APIM instance across two or more Availability Zones within a single region, you can achieve a Service Level Agreement (SLA) of 99.99%.
In a multi-region deployment, using Availability Zones can enhance the resiliency of the primary region. Even if one zone experiences an outage, the services can operate seamlessly from another zone within the same region.</p>
<p>Every unit deployed across the Availability Zones includes all necessary API Management components, ensuring comprehensive coverage and functionality.</p>
<p>Using Availability Zones in Azure API Management provides enhanced availability, reliability, and resiliency for your API services, especially in a multi-region deployment. This setup ensures that your APIs remain accessible and operational even in the face of regional outages or disruptions.</p>
<p>Now, let us take a look at self-hosting your own Gateway.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Self-hosted Gateway" src="https://luke.geek.nz/assets/images/apim_apilifecyle_scale_SelfHostedAPIGateway-9a3b77f802ab4dcc77bc9434140378be.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>The self-hosted API gateway is functionally equivalent to the managed gateway. This feature provides flexibility, allowing the gateway to be deployed on-premises or in the cloud, depending on the organization's needs. The self-hosted gateway requires only outgoing connectivity to Azure <em>(API Management Gateway)</em> on port 443.</p>
<p>The self-hosted gateway connects to a "parent" API Management service in Azure. It pulls down configuration settings and pushes up telemetry data to Azure. This integration with Azure allows for centralized management and monitoring, simplifying the oversight and control of the API gateway.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Self-hosted Gateway SKU" src="https://luke.geek.nz/assets/images/apim_apilifecyle_scale_SelfHostedAPIGatewaySKU-6afdcfffadc0a6ac9e966f5bd4f8ad91.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Now, let us take a look at <a href="https://dapr.io/" target="_blank" rel="noopener noreferrer">Dapr</a> and Azure API Management.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><blockquote>
<p><a href="https://docs.dapr.io/developing-applications/integrations/azure/azure-api-management/" target="_blank" rel="noopener noreferrer">Azure API Management is a way to create consistent and modern API gateways for back-end services, including those built with Dapr</a>. You can enable Dapr support in self-hosted API Management gateways to allow them to:</p>
</blockquote><p>Forward requests to Dapr services
Send messages to Dapr Pub/Sub topics
Trigger Dapr output bindings</p></div></div>
<p><img decoding="async" loading="lazy" alt="APIM - Dapr" src="https://luke.geek.nz/assets/images/apim_apilifecyle_scale_Dapr-467d22df34b4afeac447ee9776d4b46a.PNG" width="4000" height="2250" class="img_ev3q"></p>
<ul>
<li>Dapr can work with self-hosted Azure API Management gateways and invoke services running in different pods. This allows for seamless communication between microservices within the Kubernetes cluster.</li>
<li>Dapr supports publish/subscribe messaging, enabling applications to send messages to topics and other applications to subscribe to these topics</li>
<li>Dapr can trigger outbound bindings, which allows it to interact with external systems and services. This feature is useful for integrating with external databases, message queues, and other services.</li>
</ul>
<p>By integrating Dapr with self-hosted gateways, the architecture's complexity is reduced, and common tasks like service discovery, state management, and pub/sub are simplified.</p>
<p>Azure API Management offers an isolated SKU, a dedicated instance of Azure API Management that runs on a single-tenant virtual network. This SKU is ideal for organizations that require enhanced security, compliance, and isolation for their APIs.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Isolated SKU" src="https://luke.geek.nz/assets/images/apim_apilifecyle_scale_IsolatedTenant-940e7b0deec0a711648bd64c9671d4b9.PNG" width="4000" height="2250" class="img_ev3q"></p>
<blockquote>
<p>The purpose of the Isolated tier is to enable the use of all the features of the API Management Premium tier in highly regulated industries where compute environment isolation is a requirement.</p>
</blockquote>
<p>Now, let us discuss <a href="https://learn.microsoft.com/azure/api-management/api-management-howto-disaster-recovery-backup-restore?tabs=powershell&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Backup and Restore</a>.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Backup and Restore" src="https://luke.geek.nz/assets/images/apim_apilifecyle_scale_IBackupRestore-7f0df87da055d9655a002fbf9cc68cca.PNG" width="4000" height="2250" class="img_ev3q"></p>
<table><thead><tr><th><strong>Process</strong></th><th><strong>Details</strong></th></tr></thead><tbody><tr><td><strong>Backup</strong></td><td></td></tr><tr><td>Duration</td><td>Usually takes around 10 minutes.</td></tr><tr><td>Scope</td><td>Captures everything but reports and custom domain settings in a blob.</td></tr><tr><td>Service Configuration</td><td>Operations such as scaling and upgrades are blocked while the backup is in progress.</td></tr><tr><td>Changes</td><td>Any changes applied after the backup starts are not included in the backup.</td></tr><tr><td><strong>Restore</strong></td><td></td></tr><tr><td>Duration</td><td>It Could take 30 minutes or more, depending on the size.</td></tr><tr><td>Availability</td><td>The instance is not available while the restore is in progress.</td></tr><tr><td>Custom Domain</td><td>Custom domain configurations need to be re-applied manually after the restore.</td></tr><tr><td><strong>Standby Failover Instance</strong></td><td></td></tr><tr><td>Setup</td><td>Create a backup instance in a different region in advance.</td></tr><tr><td>Configuration</td><td>Configure the custom domain identically to the active instance.</td></tr><tr><td>Sync</td><td>Periodically sync the configuration with the active instance to achieve the desired RPO (Recovery Point Objective).</td></tr><tr><td>Failover</td><td>To failover, update the CNAME to reference the backup instance.</td></tr><tr><td>Scalability</td><td>Scale up the backup instance if and as required.</td></tr><tr><td><strong>Summary</strong></td><td></td></tr><tr><td>Backup</td><td>This process is relatively quick but does block certain operations and does not capture changes made after the backup begins.</td></tr><tr><td>Restore</td><td>This can be time-consuming and renders the instance unavailable during the process. Manual intervention is required for custom domain settings.</td></tr><tr><td>Standby Failover</td><td>Setting up a standby instance in advance can significantly reduce downtime and improve recovery times. This involves periodic synchronization and possibly updating DNS records during a failover.</td></tr></tbody></table>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>Backup and restore need to be configured. It is not enabled by default.
Backup is not possible in Consumption.
Backup and restore could take between 30 minutes to 1 hour.
Taking a backup or restore puts the API Management Management plane in a read-only state while the backup or restore is in progress.
The backups expire after 30 days.</p></div></div>
<p>Backup and restore is where you can consider Infrastructure as Code and APIOps functionality and testing.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-monitor-and-analyze">ð Monitor and Analyze<a href="https://luke.geek.nz/azure/api-management-overview/#-monitor-and-analyze" class="hash-link" aria-label="Direct link to ð Monitor and Analyze" title="Direct link to ð Monitor and Analyze">â</a></h3>
<p><img decoding="async" loading="lazy" alt="API Lifecycle - Monitor and Analyze" src="https://luke.geek.nz/assets/images/apim_apilifecyle_MonitorAnalyze-40d533759aa62b720005173e34760838.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Now we need to monitor and analyze the APIs and API Management to ensure that they are performing as expected and to identify any issues that may arise. Azure API Management provides a range of monitoring and analytics features to help you track API usage, performance, and health.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Monitor and Analyze" src="https://luke.geek.nz/assets/images/apim_apilifecyle_MonitorAnalyzeFeatures-e514006bc3cbb46153a3f7db814a79f8.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="APIM - Monitor and Analyze" src="https://luke.geek.nz/assets/images/apim_apilifecyle_MonitorAnalyzeAPIInspector-ef5274c2c3d3385874f38ac723150c7b.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>The "<a href="https://learn.microsoft.com/azure/api-management/observability?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">API Inspector</a>" feature monitors and analyzes API requests. It provides detailed information about each request, including the URL, headers, and response status code. This feature helps troubleshoot issues and optimize API performance.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Monitor and Analyze" src="https://luke.geek.nz/assets/images/apim_apilifecyle_MonitorAnalyzeAzureMonitorMetrics-861c586e59018acf39add8f53fc70ee9.PNG" width="4000" height="2250" class="img_ev3q"></p>
<table><thead><tr><th style="text-align:left">Tool</th><th style="text-align:left">Useful for</th><th style="text-align:left">Data lag</th><th style="text-align:left">Retention</th><th style="text-align:left">Sampling</th><th style="text-align:left">Data kind</th><th style="text-align:left">Supported Deployment Model(s)</th></tr></thead><tbody><tr><td style="text-align:left"><strong><a href="https://learn.microsoft.com/azure/api-management/api-management-howto-api-inspector?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">API Inspector</a></strong></td><td style="text-align:left">Testing and debugging</td><td style="text-align:left">Instant</td><td style="text-align:left">Last 100 traces</td><td style="text-align:left">Turned on per request</td><td style="text-align:left">Request traces</td><td style="text-align:left">Managed, Self-hosted, Azure Arc</td></tr><tr><td style="text-align:left"><strong><a href="https://learn.microsoft.com/azure/api-management/howto-use-analytics?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Built-in Analytics</a></strong></td><td style="text-align:left">Reporting and monitoring</td><td style="text-align:left">Minutes</td><td style="text-align:left">Lifetime</td><td style="text-align:left">100%</td><td style="text-align:left">Reports and logs</td><td style="text-align:left">Managed</td></tr><tr><td style="text-align:left"><strong><a href="https://learn.microsoft.com/azure/api-management/api-management-howto-use-azure-monitor?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Monitor Metrics</a></strong></td><td style="text-align:left">Reporting and monitoring</td><td style="text-align:left">Minutes</td><td style="text-align:left">90 days (upgrade to extend)</td><td style="text-align:left">100%</td><td style="text-align:left">Metrics</td><td style="text-align:left">Managed, Self-hosted<sup>2</sup>, Azure Arc</td></tr><tr><td style="text-align:left"><strong><a href="https://learn.microsoft.com/azure/api-management/api-management-howto-use-azure-monitor?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Monitor Logs</a></strong></td><td style="text-align:left">Reporting, monitoring, and debugging</td><td style="text-align:left">Minutes</td><td style="text-align:left">31 days/5GB (upgrade to extend)</td><td style="text-align:left">100% (adjustable)</td><td style="text-align:left">Logs</td><td style="text-align:left">Managed<sup>1</sup>, Self-hosted<sup>3</sup>, Azure Arc<sup>3</sup></td></tr><tr><td style="text-align:left"><strong><a href="https://learn.microsoft.com/azure/api-management/api-management-howto-app-insights?tabs=rest&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Application Insights</a></strong></td><td style="text-align:left">Reporting, monitoring, and debugging</td><td style="text-align:left">Seconds</td><td style="text-align:left">90 days/5GB (upgrade to extend)</td><td style="text-align:left">Custom</td><td style="text-align:left">Logs, metrics</td><td style="text-align:left">Managed<sup>1</sup>, Self-hosted<sup>1</sup>, Azure Arc<sup>1</sup></td></tr><tr><td style="text-align:left"><strong><a href="https://learn.microsoft.com/azure/api-management/api-management-howto-log-event-hubs?tabs=PowerShell&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Logging through Azure Event Hubs</a></strong></td><td style="text-align:left">Custom scenarios</td><td style="text-align:left">Seconds</td><td style="text-align:left">User managed</td><td style="text-align:left">Custom</td><td style="text-align:left">Custom</td><td style="text-align:left">Managed<sup>1</sup>, Self-hosted<sup>1</sup>, Azure Arc<sup>1</sup></td></tr><tr><td style="text-align:left"><strong><a href="https://learn.microsoft.com/azure/api-management/how-to-deploy-self-hosted-gateway-kubernetes-opentelemetry?WT.mc_id=AZ-MVP-5004796#introduction-to-opentelemetry" target="_blank" rel="noopener noreferrer">OpenTelemetry</a></strong></td><td style="text-align:left">Monitoring</td><td style="text-align:left">Minutes</td><td style="text-align:left">User managed</td><td style="text-align:left">100%</td><td style="text-align:left">Metrics</td><td style="text-align:left">Self-hosted<sup>2</sup></td></tr></tbody></table>
<p><em>1. Optional, depending on the configuration of the feature in Azure API Management</em></p>
<p><em>2. Optional, depending on the configuration of the gateway</em></p>
<p><em>3. The self-hosted gateway currently does not send diagnostic logs to Azure Monitor. However, it is possible to configure and persist logs locally where the self-hosted gateway is deployed.</em></p>
<p><img decoding="async" loading="lazy" alt="APIM - Monitor Logs" src="https://luke.geek.nz/assets/images/apim_apilifecyle_MonitorAnalyzeAzureMonitorLogs-095fdefa2225f1737d1ec99c501e51f2.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="APIM - Monitor Logs" src="https://luke.geek.nz/assets/images/apim_apilifecyle_MonitorAnalyzeAppInsights-ca96afa427b477146562d62a7271786b.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="APIM - Monitor Reports" src="https://luke.geek.nz/assets/images/apim_apilifecyle_MonitorAnalyzeReports-7ab257fd873d58e35398a4a8335d49f0.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>More information on API Management can be found here: <a href="https://aka.ms/apimlove" target="_blank" rel="noopener noreferrer">https://aka.ms/apimlove</a>.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Monitor and Analyze" src="https://luke.geek.nz/assets/images/apim_love-1c20502ac2a7b72384eca9a9ea26106d.png" width="4000" height="2250" class="img_ev3q"></p>
<p>An excellent resource for Architecting Azure API Management, considerations can be found here: <a href="https://github.com/stephaneey/azure-and-k8s-architecture/blob/main/maps/apim.md" target="_blank" rel="noopener noreferrer">stephaneey/azure-and-k8s-architecture</a> from MVP <a href="https://www.linkedin.com/in/stephane-eyskens" target="_blank" rel="noopener noreferrer">Stephane Eyskens</a>.</p>
<p><img decoding="async" loading="lazy" alt="APIM - Monitor and Analyze" src="https://luke.geek.nz/assets/images/apim_architecturemap-218572e8e16e98d868f3f4d40275429f.PNG" width="4000" height="2250" class="img_ev3q"></p>]]></content>
        <author>
            <name>Luke Murray</name>
            <uri>https://luke.geek.nz</uri>
        </author>
        <category label="Azure" term="Azure"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Azure Hackathon Vending with Terraform]]></title>
        <id>https://luke.geek.nz/azure/hackathon-vending-project/</id>
        <link href="https://luke.geek.nz/azure/hackathon-vending-project/"/>
        <updated>2024-07-29T06:27:25.893Z</updated>
        <summary type="html"><![CDATA[Learn how to build and deploy a Hackathon environment with Azure, GitHub Actions, Entra ID, and Terraform.]]></summary>
        <content type="html"><![CDATA[<p>When working with Microsoft Azure, you may want an environment for learning, testing, or Hackathons. This post will cover some technical implementation considerations for creating a sandbox environment in Azure that could be used for your Hackathons using Terraform, Entra ID Access packages, and GitHub Actions.</p>
<!-- -->
<p><img decoding="async" loading="lazy" alt="Microsoft Azure - Hackathon" src="https://luke.geek.nz/assets/images/hackathon_overview-68a98616da8e81ab9fe921e6f2fc0e3a.png" width="4000" height="2250" class="img_ev3q"></p>
<p>So let us look at a scenario:</p>
<blockquote>
<p>"As a hackathon organizer, I want to build an Azure environment that supports various AI-driven solutions to automate and enhance operational processes, including customer feedback analysis, testing plan creation, and standard procedure refinement."</p>
</blockquote>
<p><img decoding="async" loading="lazy" alt="Hackathon - Requirements" src="https://luke.geek.nz/assets/images/hackathon_requirements-1d6c7bbc58eddc063d7e0b34b9c5720c.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>We have a few Technical Requirements:</p>
<ul>
<li>It needs to support multiple <em>(external)</em> users and teams from different organizations using Work and Personal accounts who work together.</li>
<li>Needs to support the creation of multiple Azure resources</li>
</ul>
<p>And our limitations are:</p>
<ul>
<li>One Azure subscription</li>
</ul>
<p>Let us look at how we can leverage Microsoft Azure technologies to implement this.</p>
<p><img decoding="async" loading="lazy" alt="Hackathon - Azure environment" src="https://luke.geek.nz/assets/images/hackathon_environmenttech-564e79187f0a99533670876d61a40f67.PNG" width="4000" height="2250" class="img_ev3q"></p>
<ul>
<li><a href="https://learn.microsoft.com/azure/cost-management-billing/manage/create-subscription?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Subscription</a></li>
<li><a href="https://learn.microsoft.com/azure/azure-resource-manager/management/overview?WT.mc_id=AZ-MVP-5004796#resource-groups" target="_blank" rel="noopener noreferrer">Azure Resource Groups</a> <em>(within Azure subscription)</em></li>
<li><a href="https://learn.microsoft.com/entra/fundamentals/whatis?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Entra ID</a></li>
<li><a href="https://learn.microsoft.com/entra/id-governance/entitlement-management-access-package-create?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Entra ID Identity Governance - Access Packages</a>. This requires a Entra ID P2 license.</li>
</ul>
<p>For this article, there are some assumptions I will be making, such as:</p>
<ul>
<li>A Resource Group per Team is sufficient for the Hackathon.</li>
</ul>
<p><img decoding="async" loading="lazy" alt="Hackathon - Environment concepts" src="https://luke.geek.nz/assets/images/hackathon_environmentconcepts-6e9d88470c62e51b3b951e5713fe6bfd.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>We will approach this as a <a href="https://luke.geek.nz/azure/microsoft-azure-sandbox-design-considerations/" target="_blank" rel="noopener noreferrer">Lightly Managed Sandbox</a>.</p>
<p><img decoding="async" loading="lazy" alt="Hackathon - Sandbox Types" src="https://luke.geek.nz/assets/images/hackathon_sandboxtypes-b9154dc64e946394357ff70eca29f46d.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>And give External Identities access to an Azure subscription through Access Packages and a Group with a Contributor role assigned to the individual Resource Groups.</p>
<p><img decoding="async" loading="lazy" alt="Hackathon - Identity &amp;amp; Access" src="https://luke.geek.nz/assets/images/hackathon_identityaccess-7705a603b81cf5c9fb64db289058179d.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>To do this, we will leverage Access packages to invite external users into the Hackathon tenancy and assign them to a group with the Contributor role assigned to the Resource Group.</p>
<p><img decoding="async" loading="lazy" alt="Hackthon - Access packages" src="https://luke.geek.nz/assets/images/hackathon_identityaccesspackages-111a83f65e10bb6219d52889d8f38830.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>By creating a Policy allowing external organizations to make requests, the Hackathon Organiser can invite external users to the Azure subscription and access internal <em>(Hackathon)</em> resources.</p>
<p><img decoding="async" loading="lazy" alt="Hackathon - Identity Access packages" src="https://luke.geek.nz/assets/images/hackathon_identityaccesspackagespolicy-d698483f2d38445027259d76a20a6689.PNG" width="4000" height="2250" class="img_ev3q">
<img decoding="async" loading="lazy" alt="Hackathon - Identity Access packages" src="https://luke.geek.nz/assets/images/hackathon_identityaccesspackagespolicy1-8839a3331df4715d577fad134e127c94.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="Hackathon - Identity Access packages" src="https://luke.geek.nz/assets/images/hackathonaccesspackage_signup-19dd9142ba0850219162553278c63dd3.gif" width="1901" height="965" class="img_ev3q"></p>
<blockquote>
<p>You may also need to consider <a href="https://learn.microsoft.com/entra/external-id/cross-tenant-access-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Inbound Cross-tenant Access</a> setting Trust configuration.</p>
</blockquote>
<p><img decoding="async" loading="lazy" alt="Hackathon - Cross tenant Access Settings" src="https://luke.geek.nz/assets/images/hackathon_identityaccesstrustsettings-9866c39d287f36c72ed8e9732f3184e6.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>So, let's look at some of the main Terraform code snippets that could be used to create the Azure resources for the Hackathon.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>The identity being used to create these Terraform resources will need the following:</p><ul>
<li><a href="https://learn.microsoft.com/azure/role-based-access-control/role-assignments-portal-subscription-admin?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Owner</a> of the Azure Subscription to create the Resource Groups and role assignments.</li>
<li><a href="https://learn.microsoft.com/entra/identity/role-based-access-control/permissions-reference?WT.mc_id=AZ-MVP-5004796#identity-governance-administrator" target="_blank" rel="noopener noreferrer">Identity Governance Administrator</a>, to create the Access Packages and Catalog.</li>
<li><a href="https://learn.microsoft.com/entra/identity/role-based-access-control/permissions-reference?WT.mc_id=AZ-MVP-5004796#groups-administrator" target="_blank" rel="noopener noreferrer">Groups Administrator</a> role to create and delete the Groups in the Entra ID tenant.</li>
</ul></div></div>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">locals</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Read the content of the CSV file named "az_hackathon.csv" and store it in the local variable "csv_content."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">csv_content</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> file(</span><span class="token string" style="color:rgb(255, 121, 198)">"az_hackathon.csv"</span><span class="token plain">)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Decode the CSV content into a list of maps, each representing a row in the CSV file.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">csv_data</span><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> csvdecode(local.csv_content)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This reads a CSV file containing the details of the Azure Resource Groups that need to be created for the Hackathon. I have used this base CSV file.</p>
<div class="language-csv codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csv codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Team,Location,Environment,Application,Notes</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Team1,AustraliaEast,hackathon,AI,"AI Hackathon for luke.geek.nz."</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Team2,canadaeast,hackathon,AI,"AI Hackathon for luke.geek.nz."</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Team3,francecentral,hackathon,AI,"AI Hackathon for luke.geek.nz."</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Team4,swedencentral,hackathon,AI,"AI Hackathon for luke.geek.nz."</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Team5,uksouth,hackathon,AI,"AI Hackathon for luke.geek.nz."</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Using this and the <a href="https://registry.terraform.io/providers/hashicorp/azurerm/latest" target="_blank" rel="noopener noreferrer">AzureRM</a> Terraform provider, we can create the Resource Groups and assign the Access Packages to them.</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Define an Azure Resource Group resource named "rg".</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource </span><span class="token keyword type variable" style="color:rgb(189, 147, 249);font-style:italic">"azurerm_resource_group"</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"rg"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Create one resource group for each entry in the csv_data list.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">count</span><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> length(local.csv_data)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Set the name of the resource group using the Team, Environment, and Application attributes from the csv_data list.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token plain">     </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> lower(format(</span><span class="token string" style="color:rgb(255, 121, 198)">"%s-%s-%s-rg"</span><span class="token plain">, local.csv_data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">count.index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">.Team, local.csv_data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">count.index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">.Environment, local.csv_data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">count.index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">.Application))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Set the location of the resource group using the Location attribute from the csv_data list.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">location</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> local.csv_data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">count.index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">.Location</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Set tags for the resource group using attributes from the csv_data list.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">tags</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">Environment</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> lower(local.csv_data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">count.index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">.Environment)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">Team</span><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> lower(local.csv_data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">count.index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">.Team)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">Application</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> lower(local.csv_data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">count.index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">.Application)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">Notes</span><span class="token plain">       </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> lower(local.csv_data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">count.index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">.Notes)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You will create a Resource Group, such as below, for each team based on the CSV file:</p>
<p><img decoding="async" loading="lazy" alt="Hackathon - Resource Group 1" src="https://luke.geek.nz/assets/images/hackathon_team1_resourcegroupbeforeOpenAI-ce22af101cb5df3abb2eb58fd6747a4c.png" width="1762" height="471" class="img_ev3q"></p>
<p>Now we can create the Groups and assign the permissions:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Define an Azure AD Group resource named "ad_group".</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource </span><span class="token keyword type variable" style="color:rgb(189, 147, 249);font-style:italic">"azuread_group"</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"ad_group"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Create one Azure AD group for each entry in the csv_data list.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">count</span><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> length(local.csv_data)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Set the display name of the Azure AD group using the Team, Environment, and Application attributes from the csv_data list.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">display_name</span><span class="token plain">     </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> lower(format(</span><span class="token string" style="color:rgb(255, 121, 198)">"%s-%s-%s-group"</span><span class="token plain">, local.csv_data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">count.index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">.Team, local.csv_data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">count.index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">.Environment, local.csv_data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">count.index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">.Application))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Set the description of the Azure AD group using the Team, Environment, and Application attributes from the csv_data list.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">description</span><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> format(</span><span class="token string" style="color:rgb(255, 121, 198)">"Group for %s environment of %s application managed by %s team."</span><span class="token plain">, title(local.csv_data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">count.index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">.Environment), title(local.csv_data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">count.index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">.Application), title(local.csv_data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">count.index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">.Team))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Disable mail for the Azure AD group.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">mail_enabled</span><span class="token plain">     </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Enable security for the Azure AD group.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">security_enabled</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Define an Azure Role Assignment resource named "role_assignment".</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource </span><span class="token keyword type variable" style="color:rgb(189, 147, 249);font-style:italic">"azurerm_role_assignment"</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"role_assignment"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Create one role assignment for each entry in the csv_data list.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">count</span><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> length(local.csv_data)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Set the scope of the role assignment to the ID of the corresponding resource group.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">scope</span><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> azurerm_resource_group.rg</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">count.index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">.id</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Assign the "Owner" role to the principal.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">role_definition_name</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Owner"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Set the principal ID to the object ID of the corresponding Azure AD group.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">principal_id</span><span class="token plain">         </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> azuread_group.ad_group</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">count.index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">.object_id</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Hackathon - Resource Group Access Control (IAM)" src="https://luke.geek.nz/assets/images/hackathon_team1_resourcegroupiam-6593adbc494da6046c4f07ec33ba0a69.png" width="1606" height="744" class="img_ev3q">'</p>
<p>So now, we have created the Resource Groups and Entra ID groups and assigned Owner permissions to the Resource Groups for each Team in the CSV file; it is time to deploy a base resource - such as Azure OpenAI, which those hackathon teams can use, to get going! <a href="https://learn.microsoft.com/azure/ai-services/openai/concepts/models?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure OpenAI models are deployed to various regions</a> and have token limits constrained to the region, so we need to consider how heavily these endpoints will be hit - which is why you may have noticed in the CSV, that the location of each Resource Group is different, so we want to use that to make sure that our Azure OpenAI resources are deployed in the same region as the Resource Group, to help balance.</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># This resource block defines an Azure Cognitive Account resource named "openai"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource </span><span class="token keyword type variable" style="color:rgb(189, 147, 249);font-style:italic">"azurerm_cognitive_account"</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"openai"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The for_each argument is used to iterate over a map created from local.csv_data.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Each entry in the map is identified by an index (idx) and its corresponding value (val).</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">for_each</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> for idx, val in local.csv_data : </span><span class="token property">idx</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain">&gt; val </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The name of the cognitive account is dynamically set using the "Team" attribute from each value in the map.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"openai-ca-</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">$</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string interpolation function" style="color:rgb(80, 250, 123)">lower</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string interpolation" style="color:rgb(255, 121, 198)">each</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation" style="color:rgb(255, 121, 198)">value</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation" style="color:rgb(255, 121, 198)">Team</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string" style="color:rgb(255, 121, 198)">-</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">$</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string interpolation function" style="color:rgb(80, 250, 123)">lower</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string interpolation" style="color:rgb(255, 121, 198)">each</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation" style="color:rgb(255, 121, 198)">value</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation" style="color:rgb(255, 121, 198)">Location</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The location of the cognitive account is set using the "Location" attribute from each value in the map.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">location</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> each.value.Location</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The resource group name is dynamically set using the key from the map.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">resource_group_name</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> azurerm_resource_group.rg</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">each.key</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">.name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The kind of cognitive account is set to "OpenAI."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">kind</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"OpenAI"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The SKU (pricing tier) of the cognitive account is set to "S0".</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">sku_name</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"S0"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>So we end up with something like this:</p>
<p><img decoding="async" loading="lazy" alt="Hackathon - Azure OpenAI" src="https://luke.geek.nz/assets/images/hackathon_resources_AzureOpenAI-4d1f6aa92f81b86364326fd118f9ce39.png" width="1382" height="617" class="img_ev3q"></p>
<p>We may also need to consider the Azure <a href="https://learn.microsoft.com/azure/azure-resource-manager/management/resource-providers-and-types?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Resource Providers</a>, as the Hackathon teams, won't have permissions to register these.</p>
<p>So we can create a map of the Resource Providers, and then iterate over them, to register them.</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">variable</span><span class="token keyword type variable" style="color:rgb(189, 147, 249);font-style:italic"> "resource_providers" </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">description</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Map of Azure resource providers to register"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">default</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"Microsoft.Maps"</span><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"Microsoft.OperationalInsights"</span><span class="token plain">     </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"Microsoft.EventGrid"</span><span class="token plain">               </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"Microsoft.EventHub"</span><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"Microsoft.GuestConfiguration"</span><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"Microsoft.HDInsight"</span><span class="token plain">               </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"Microsoft.KeyVault"</span><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"Microsoft.ContainerService"</span><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"Microsoft.DBforMySQL"</span><span class="token plain">              </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"Microsoft.DBforMariaDB"</span><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"Microsoft.DBforMySQL"</span><span class="token plain">              </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"Microsoft.DBforPostgreSQL"</span><span class="token plain">         </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"Microsoft.DataFactory"</span><span class="token plain">             </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"Microsoft.HealthBot"</span><span class="token plain">               </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"Microsoft.HealthModel"</span><span class="token plain">             </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"Microsoft.HealthcareApis"</span><span class="token plain">          </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"Microsoft.MachineLearning"</span><span class="token plain">         </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"Microsoft.Orbital"</span><span class="token plain">                 </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"Microsoft.Sql"</span><span class="token plain">                     </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// Add the rest of your providers here</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource </span><span class="token keyword type variable" style="color:rgb(189, 147, 249);font-style:italic">"azurerm_resource_provider_registration"</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"resourceproviders"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">for_each</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> var.resource_providers</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token plain">     </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> each.key</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now, we need to create our Entra ID Catalog and Access Packages and assign the Resource Groups to the Access package.</p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>The <a href="https://learn.microsoft.com/entra/id-governance/entitlement-management-access-package-create?WT.mc_id=AZ-MVP-5004796#create-request-policies" target="_blank" rel="noopener noreferrer">request policies</a> themselves, I had issues deploying via Terraform, I suspect due to missing Graph permissions 'EntitlementManagement.ReadWrite.All' on the identity, but had some issues adding this, so did them manually, however, I have successfully deployed the policies in another environment successfully using the: <a href="https://registry.terraform.io/providers/hashicorp/azuread/latest/docs/resources/access_package_assignment_policy" target="_blank" rel="noopener noreferrer">azuread_access_package_assignment_policy</a> terraform resource.</p><p>Make sure you add:
requests_accepted = true
To the requestors block, enable the policy, or the policy will be deployed as Disabled.</p></div></div>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource </span><span class="token keyword type variable" style="color:rgb(189, 147, 249);font-style:italic">"azuread_access_package_catalog"</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Sandbox"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token property">description</span><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Hackathon Sandboxes"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token property">display_name</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Sandbox"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token property">published</span><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Define an Azure AD Access Package resource named "access_package"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource </span><span class="token keyword type variable" style="color:rgb(189, 147, 249);font-style:italic">"azuread_access_package"</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"access_package"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># The count parameter determines how many instances of this resource to create based on the length of the csv_data list.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token property">count</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> length(local.csv_data)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># The display_name parameter sets the display name of the access package for each instance,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># using the Team, Environment, and Application attributes from the csv_data list.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token property">display_name</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> format(</span><span class="token string" style="color:rgb(255, 121, 198)">"%s-%s-%s-access-package"</span><span class="token plain">, local.csv_data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">count.index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">.Team, local.csv_data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">count.index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">.Environment, local.csv_data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">count.index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">.Application)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># The catalog_id parameter sets the ID of the access package catalog for each instance,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># using the Sandbox catalog ID.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token property">catalog_id</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> azuread_access_package_catalog.Sandbox.id</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># The description parameter sets the description of the access package for each instance,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># using the Team, Environment, and Notes attributes from the csv_data list.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token property">description</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Access package for </span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">$</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string interpolation keyword" style="color:rgb(189, 147, 249);font-style:italic">local</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation type variable" style="color:rgb(189, 147, 249);font-style:italic">csv_data</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string interpolation keyword" style="color:rgb(189, 147, 249);font-style:italic">count</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation type variable" style="color:rgb(189, 147, 249);font-style:italic">index</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation" style="color:rgb(255, 121, 198)">Team</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string" style="color:rgb(255, 121, 198)">-</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">$</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string interpolation keyword" style="color:rgb(189, 147, 249);font-style:italic">local</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation type variable" style="color:rgb(189, 147, 249);font-style:italic">csv_data</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string interpolation keyword" style="color:rgb(189, 147, 249);font-style:italic">count</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation type variable" style="color:rgb(189, 147, 249);font-style:italic">index</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation" style="color:rgb(255, 121, 198)">Environment</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string" style="color:rgb(255, 121, 198)">-</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">$</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string interpolation keyword" style="color:rgb(189, 147, 249);font-style:italic">local</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation type variable" style="color:rgb(189, 147, 249);font-style:italic">csv_data</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string interpolation keyword" style="color:rgb(189, 147, 249);font-style:italic">count</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation type variable" style="color:rgb(189, 147, 249);font-style:italic">index</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string interpolation" style="color:rgb(255, 121, 198)">Notes</span><span class="token string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string" style="color:rgb(255, 121, 198)">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Assign all groups we have created to our catalog</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource </span><span class="token keyword type variable" style="color:rgb(189, 147, 249);font-style:italic">"azuread_access_package_resource_catalog_association"</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"CloudSandbox_Groups"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># The count parameter determines how many instances of this resource to create based on the length of the csv_data list.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token property">count</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> length(local.csv_data)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># The catalog_id parameter sets the ID of the access package catalog for each instance using the Sandbox catalog ID.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token property">catalog_id</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> azuread_access_package_catalog.Sandbox.id</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># The resource_origin_id parameter sets the ID of the Azure AD group for each instance using the index from the csv_data list.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token property">resource_origin_id</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> azuread_group.ad_group</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">count.index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">.id</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># The resource_origin_system parameter specifies the origin system of the resource, which is "AadGroup" in this case.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token property">resource_origin_system</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"AadGroup"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource </span><span class="token keyword type variable" style="color:rgb(189, 147, 249);font-style:italic">"azuread_access_package_resource_package_association"</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"group_association"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># The count parameter determines how many instances of this resource to create based on the length of the csv_data list.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token property">count</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> length(local.csv_data)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># The access_package_id parameter sets the ID of the access package for each instance using the index from the csv_data list.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token property">access_package_id</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> azuread_access_package.access_package</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">count.index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">.id</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># The catalog_resource_association_id parameter sets the ID of the catalog resource association for each instance using the index from the csv_data list.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token property">catalog_resource_association_id</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> azuread_access_package_resource_catalog_association.CloudSandbox_Groups</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">count.index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">.id</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Hackathon - Entra ID Access Packages" src="https://luke.geek.nz/assets/images/hackathon_identityaccesspackagesazportal-68a7720d71b613d8f88329c815488890.png" width="1855" height="740" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="Hackathon - GitHub Actions" src="https://luke.geek.nz/assets/images/hackathon_githubactions-af337675c2e1c65569af8430ff90e44b.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>Now we have our base Terraform, it is time to deploy this, and we can use GitHub Actions to do this by creating a GitHub Actions workflow file, such as below:</p>
<!-- -->
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Terraform Plan/Apply'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">on</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">push</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">branches</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">pull_request</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">branches</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">#Special permissions required for OIDC authentication</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">permissions</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">id-token</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> write</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">contents</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> read</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">pull-requests</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> write</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">jobs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">terraform-plan</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Terraform Plan'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">runs-on</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">environment</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> production</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)">#this is needed since we are running terraform with read-only permissions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">ARM_SKIP_PROVIDER_REGISTRATION</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">outputs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">tfplanExitCode</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> steps.tf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">plan.outputs.exitcode </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Checkout the repository to the GitHub Actions runner</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Checkout</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> actions/checkout@v4</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Install the latest version of the Terraform CLI</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Setup Terraform</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> hashicorp/setup</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">terraform@v3</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">terraform_wrapper</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Initialize a new or existing Terraform working directory by creating initial files, loading any remote state, downloading modules, etc.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Terraform Init</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">run</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> terraform init</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)">#These environment variables are used by the terraform azure provider to setup OIDD authenticate. </span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">ARM_CLIENT_ID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"${{ secrets.AZURE_CLIENT_ID }}"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">ARM_SUBSCRIPTION_ID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"${{ secrets.AZURE_SUBSCRIPTION_ID }}"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">ARM_TENANT_ID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"${{ secrets.AZURE_TENANT_ID }}"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">working-directory</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ./iac</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Checks that all Terraform configuration files adhere to a canonical format</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Will fail the build if not</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Terraform Format</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">run</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> terraform fmt </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">check</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">working-directory</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ./iac</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Generates an execution plan for Terraform</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># An exit code of 0 indicated no changes, 1 a terraform failure, 2 there are pending changes.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Terraform Plan</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> tf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">plan</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">ARM_CLIENT_ID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"${{ secrets.AZURE_CLIENT_ID }}"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">ARM_SUBSCRIPTION_ID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"${{ secrets.AZURE_SUBSCRIPTION_ID }}"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">ARM_TENANT_ID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"${{ secrets.AZURE_TENANT_ID }}"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">working-directory</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ./iac</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">run</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token scalar string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        export exitcode=0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        terraform plan -detailed-exitcode -no-color -out tfplan || export exitcode=$?</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        echo "exitcode=$exitcode" </span><span class="token punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"> $GITHUB_OUTPUT</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"> $exitcode </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">eq 1 </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">; then</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          echo Terraform Plan Failed</span><span class="token tag" style="color:rgb(255, 121, 198)">!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          exit 1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        else </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          exit 0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        fi</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Upload Terraform Plan</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">if</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> success() </span><span class="token important">&amp;&amp;</span><span class="token plain"> steps.plan.outputs.exitcode </span><span class="token tag" style="color:rgb(255, 121, 198)">!=</span><span class="token plain"> '1'</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> actions/upload</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">artifact@v4</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> tfplan</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">path</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ./iac/tfplan </span><span class="token comment" style="color:rgb(98, 114, 164)"># Ensure this path is correct</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Create string output of Terraform Plan</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Create String Output</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> tf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">plan</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">string</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">run</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token scalar string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        cd ./iac</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        TERRAFORM_PLAN=$(terraform show -no-color tfplan)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        delimiter="$(openssl rand -hex 8)"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        echo "summary&lt;&lt;${delimiter}" &gt;&gt; $GITHUB_OUTPUT</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        echo "## Terraform Plan Output" &gt;&gt; $GITHUB_OUTPUT</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        echo "&lt;details&gt;&lt;summary&gt;Click to expand&lt;/summary&gt;" &gt;&gt; $GITHUB_OUTPUT</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        echo "" &gt;&gt; $GITHUB_OUTPUT</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        echo '```terraform' &gt;&gt; $GITHUB_OUTPUT</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        echo "$TERRAFORM_PLAN" &gt;&gt; $GITHUB_OUTPUT</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        echo '```' &gt;&gt; $GITHUB_OUTPUT</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        echo "&lt;/details&gt;" &gt;&gt; $GITHUB_OUTPUT</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        echo "${delimiter}" &gt;&gt; $GITHUB_OUTPUT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Publish Terraform Plan as task summary</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Publish Terraform Plan to Task Summary</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">SUMMARY</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> steps.tf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">plan</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">string.outputs.summary </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">run</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token scalar string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        echo "$SUMMARY" &gt;&gt; $GITHUB_STEP_SUMMARY</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># If this is a PR post the changes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Push Terraform Output to PR</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">if</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> github.ref </span><span class="token tag" style="color:rgb(255, 121, 198)">!=</span><span class="token plain"> 'refs/heads/main'</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> actions/github</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">script@v7</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">SUMMARY</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"${{ steps.tf-plan-string.outputs.summary }}"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">github-token</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> secrets.GITHUB_TOKEN </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">script</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token scalar string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            const body = `${process.env.SUMMARY}`;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            github.rest.issues.createComment({</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                issue_number: context.issue.number,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                owner: context.repo.owner,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                repo: context.repo.repo,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                body: body</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            })</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                </span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">terraform-apply</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Terraform Apply'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">if</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> github.ref == 'refs/heads/main' </span><span class="token important">&amp;&amp;</span><span class="token plain"> needs.terraform</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">plan.outputs.tfplanExitCode == 2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">runs-on</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">environment</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> production</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">needs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">terraform</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">plan</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Checkout the repository to the GitHub Actions runner</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Checkout</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> actions/checkout@v4</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Install the latest version of Terraform CLI and configure the Terraform CLI configuration file with a Terraform Cloud user API token</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Setup Terraform</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> hashicorp/setup</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">terraform@v3</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Initialize a new or existing Terraform working directory by creating initial files, loading any remote state, downloading modules, etc.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Terraform Init</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">run</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> terraform init</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">ARM_CLIENT_ID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"${{ secrets.AZURE_CLIENT_ID }}"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">ARM_SUBSCRIPTION_ID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"${{ secrets.AZURE_SUBSCRIPTION_ID }}"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">ARM_TENANT_ID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"${{ secrets.AZURE_TENANT_ID }}"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">working-directory</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ./iac</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Download saved plan from artifacts  </span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Download Terraform Plan</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> actions/download</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">artifact@v4</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> tfplan</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">path</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ./iac  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Specify the directory where the tfplan should be saved</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Terraform Apply</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">run</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> terraform apply </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">auto</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">approve tfplan</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">working-directory</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ./iac</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">ARM_CLIENT_ID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"${{ secrets.AZURE_CLIENT_ID }}"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">ARM_SUBSCRIPTION_ID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"${{ secrets.AZURE_SUBSCRIPTION_ID }}"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">ARM_TENANT_ID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"${{ secrets.AZURE_TENANT_ID }}"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This GitHub Actions workflow will connect to Azure, using OIDC from a User Managed Identity, deploy the Terraform plan, and apply the changes to the Azure subscription.</p>
<p>The Terraform backend settings look like this, with the state file stored in an Azure Storage account called tfstatehackathon in a container called tfstate in the rg-terraform-hackathon-prod Resource Group. These resources were manually deployed:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">backend</span><span class="token keyword type variable" style="color:rgb(189, 147, 249);font-style:italic"> "azurerm" </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">resource_group_name</span><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"rg-terraform-hackathon-prod"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">storage_account_name</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"tfstatehackathon"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">container_name</span><span class="token plain">       </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"tfstate"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">key</span><span class="token plain">                  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"terraform.tfstate"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">use_oidc</span><span class="token plain">             </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">provider</span><span class="token keyword type variable" style="color:rgb(189, 147, 249);font-style:italic"> "azuread" </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">use_oidc</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Configure the Azure Provider with the features block</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">provider</span><span class="token keyword type variable" style="color:rgb(189, 147, 249);font-style:italic"> "azurerm" </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">skip_provider_registration</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">use_oidc</span><span class="token plain">                   </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">features</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">key_vault</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">purge_soft_delete_on_destroy</span><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">recover_soft_deleted_key_vaults</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In the GitHub repository, we have an Environment named production, and inside this is our:</p>
<table><thead><tr><th>Variable</th><th>Description</th></tr></thead><tbody><tr><td>AZURE_CLIENT_ID</td><td>The client ID of the Entra ID User assigned managed identity used for authentication</td></tr><tr><td>AZURE_SUBSCRIPTION_ID</td><td>The ID of the Azure subscription</td></tr><tr><td>AZURE_TENANT_ID</td><td>The ID of the Entra ID tenant</td></tr></tbody></table>
<p><img decoding="async" loading="lazy" alt="Hackathon - GitHub Actions" src="https://luke.geek.nz/assets/images/hackathon_GitHub_ProductionEnvironment-a65b65a571eb7da24df9314cc6819fbd.png" width="1282" height="857" class="img_ev3q"></p>
<p>The full code for this can be found in the <a href="https://github.com/lukemurraynz/HackathonRGAzureEnvironment" target="_blank" rel="noopener noreferrer">lukemurraynz/HackathonRGAzureEnvironment</a>. If you have any suggestions or improvements, feel free to open a PR <em>(Pull Request)</em>.</p>
<p>Finally, once the Hackathon is over, you can use Terraform to revert the configuration and clean up the Azure subscription; once the users are removed from the Hackathon Access packages, their Guest accounts can be Disabled; you can also configure the policy to remove them from your tenancy automatically.</p>
<p>Your Hackathon students should now be able to log in to the <a href="https://learn.microsoft.com/entra/id-governance/entitlement-management-request-access?WT.mc_id=AZ-MVP-5004796#sign-in-to-the-my-access-portal" target="_blank" rel="noopener noreferrer">My Access Portal</a>, request access, to a Team, and once approved <em>(based on the policy you specified in the Access package)</em> will be able to navigate to the Azure Portal for your tenancy '<a href="https://portal.azure.com/YOURTENANTNAMEORID" target="_blank" rel="noopener noreferrer">https://portal.azure.com/YOURTENANTNAMEORID</a>' and be able to create resources in the Azure Resource Group, and as Teams expand, you simply have to edit the CSV file and push the change.</p>]]></content>
        <author>
            <name>Luke Murray</name>
            <uri>https://luke.geek.nz</uri>
        </author>
        <category label="Azure" term="Azure"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Container Patching with Azure DevOps, Trivy and Copacetic]]></title>
        <id>https://luke.geek.nz/azure/automate-container-patching-with-trivy-copacetic-azure-devops/</id>
        <link href="https://luke.geek.nz/azure/automate-container-patching-with-trivy-copacetic-azure-devops/"/>
        <updated>2024-07-22T09:28:31.063Z</updated>
        <summary type="html"><![CDATA[Learn how to automate Docker container patching with Trivy, Copacetic, and Azure DevOps. This guide covers vulnerability scanning, image patching, and pushing to Azure Container Registry.]]></summary>
        <content type="html"><![CDATA[<p><a href="https://project-copacetic.github.io/copacetic/website/" target="_blank" rel="noopener noreferrer">Copacetic</a> (or Copa for short) is a CLI tool written in Go and based on buildkit that can be used to directly patch container images given the vulnerability scanning results from popular tools like <a href="https://github.com/aquasecurity/trivy" target="_blank" rel="noopener noreferrer">Trivy</a>.</p>
<p><a href="https://aquasecurity.github.io/trivy/" target="_blank" rel="noopener noreferrer">Trivy</a> is a security scanner that can scan container images for vulnerabilities. It is a simple and comprehensive scanner that can be used to scan images for vulnerabilities in the OS packages, application dependencies, and language-specific packages, supplemented by vulnerability databases supplemented with Copa, which can be used to patch the vulnerabilities found by Trivy; this tool can be used to quickly patch container images without going upstream for a full rebuild, which may require more time, and the involvement of multiple teams <em>(ie Developers, Q&amp;A, Operations, Support)</em> to patch, test and deploy.</p>
<p>In this article, we will use <a href="https://azure.microsoft.com/products/devops?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure DevOps</a> to run a pipeline that will use <a href="https://aquasecurity.github.io/trivy/" target="_blank" rel="noopener noreferrer">Trivy</a> to scan a container image for vulnerabilities, and then use <a href="https://project-copacetic.github.io/copacetic/website/" target="_blank" rel="noopener noreferrer">Copa</a> to patch the vulnerabilities found by Trivy, and then push the patched image to an <a href="https://azure.microsoft.com/products/container-registry?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Container Registry (ACR)</a>.</p>
<!-- -->
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">ðOverview<a href="https://luke.geek.nz/azure/automate-container-patching-with-trivy-copacetic-azure-devops/#overview" class="hash-link" aria-label="Direct link to ðOverview" title="Direct link to ðOverview">â</a></h2>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p><a href="https://github.com/project-copacetic/copacetic" target="_blank" rel="noopener noreferrer">Copa</a> gives the ability to patch containers quickly without going upstream for a complete rebuild. As the window between <a href="https://www.bleepingcomputer.com/news/security/hackers-scan-for-vulnerabilities-within-15-minutes-of-disclosure/" target="_blank" rel="noopener noreferrer">vulnerability disclosure and active exploitation</a> continues to narrow, there is a growing operational need to patch critical security vulnerabilities in container images so they can be quickly redeployed into production.</p><p>In addition to filling the operational gap not met by left-shift security practices and tools, the ability of Copa to patch a container without requiring a rebuild of the container image provides other benefits:</p><p><img decoding="async" loading="lazy" alt="Container image patching" src="https://luke.geek.nz/assets/images/direct-image-patching-9660f2e54a813b9973eec665e7bacff9.png" width="624" height="230" class="img_ev3q"></p><ul>
<li>Allows users other than the image publishers also to patch container images, such as DevSecOps engineers.</li>
<li>Reduces the storage and transmission costs of redistributing patched images by only creating an additional patch layer instead of rebuilding the entire image, which usually results in different layer hashes that break layer caching.</li>
<li>Reduces the turnaround time for patching a container image by not having to wait for base image updates and being a faster operation than a full image rebuild.</li>
<li>Reduces the complexity of patching the image from running a rebuild pipeline to running a single tool on the image.</li>
</ul></div></div>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>Copa currently only supports OS package vulnerabilities and does not support application dependencies or language-specific packages. When validated and tested with developers, it is recommended to use Copa in conjunction with Trivy to patch OS package vulnerabilities and other tools to patch application dependencies and language-specific packages.</p></div></div>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>The copa tool is an extensible engine that:</p><p>Parses the needed update packages from the container imageâs vulnerability report produced by a scanner like Trivy. New adapters can be written to accommodate more report formats.
Obtains and processes the needed update packages using the appropriate package manager tools such as apt, apk, etc. New adapters can be written to support more package managers.
Applies the resulting update binaries to the container image using buildkit.</p><p><img decoding="async" loading="lazy" alt="Copa" src="https://luke.geek.nz/assets/images/vulnerability-patch-e57f146e24f2c339b2f80c0bb48b95bf.png" width="624" height="242" class="img_ev3q"></p><p>This approach is motivated by the core principles of making direct container patching broadly applicable and accessible:</p><ul>
<li>Copa supports patching existing container images <em>(Devs don't need to build their images using specific tools or modify them in some way to support container patching)</em>.</li>
<li>Copa supports containers without package managers, including distro less containers</li>
<li>Copa works with the existing vulnerability scanning and mitigation ecosystems.
<em>(Image publishers don't need to create new workflows for container patching since Copa supports patching container images using the security update packages already being published today.)</em>
<em>(Consumers do not need to migrate to a new and potentially more limited support ecosystem for custom distros or change their container vulnerability scanning pipelines to include remediation since Copa can be integrated seamlessly as an extra step to patch containers based on those scanning reports.)</em></li>
<li>Copa reduces the technical expertise needed and waiting on dependencies needed to patch an image.
<em>(For OS package vulnerabilities, no specialized knowledge about a specific image is needed to be patch it as Copa relies on the vulnerability remediation knowledge already embedded in the reports produced by popular container scanning tools today.)</em></li>
</ul></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="azure-devops-deploy">ðAzure DevOps deploy<a href="https://luke.geek.nz/azure/automate-container-patching-with-trivy-copacetic-azure-devops/#azure-devops-deploy" class="hash-link" aria-label="Direct link to ðAzure DevOps deploy" title="Direct link to ðAzure DevOps deploy">â</a></h2>
<p>So let's get started by creating a new Azure DevOps pipeline that will use Trivy to scan a container image for vulnerabilities, and then use Copa to patch the vulnerabilities found by Trivy, and then push the patched image to an Azure Container Registry (ACR).</p>
<p>First we need to create the Service Connection, we can create a <a href="https://learn.microsoft.com/azure/devops/pipelines/ecosystems/containers/publish-to-acr?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Docker Registry service connection</a>.</p>
<p><img decoding="async" loading="lazy" alt="Create Service Connection" src="https://luke.geek.nz/assets/images/docker-registry-acr-serviceconnection-899ff4e48ae4dbd6aed45af177283510.png" width="681" height="1021" class="img_ev3q"></p>
<p>Then, we can use the pipeline to connect to the Container Registry and patch the Container.</p>
<!-- -->
<p>Make sure you update the parameters, and Service Principal variable name with the up-to-date versions of Trivy, Copacetic and BuildKit, at the time you run this, and of course the container image you want to patch.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ï¸pipeline">ð ï¸Pipeline<a href="https://luke.geek.nz/azure/automate-container-patching-with-trivy-copacetic-azure-devops/#%EF%B8%8Fpipeline" class="hash-link" aria-label="Direct link to ð ï¸Pipeline" title="Direct link to ð ï¸Pipeline">â</a></h3>
<p>You can also find the full pipeline code at the following gist: <a href="https://gist.github.com/lukemurraynz/ea00bc9c6b6a9468a82f3b679c40a220" target="_blank" rel="noopener noreferrer">lukemurraynz/copacetic.yml</a>.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># The name of the pipeline, including the date and a revision number</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> copa_$(Date</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">yyyyMMdd)_$(Rev</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">r)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># This pipeline is not triggered automatically by any event</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">trigger</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> none</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># This pipeline is not triggered automatically by any pull request</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">pr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> none</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Parameters for the pipeline</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">parameters</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The Docker image to be patched</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># This parameter specifies the Docker image that will be patched by the pipeline.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> image</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Image To Patch</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> string</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">default</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"azcontainerregistry.azurecr.io/api-firewall:0.6.14"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The version of Trivy to be used</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Trivy is a Simple and Comprehensive Vulnerability Scanner for Containers and other Artifacts,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># suitable for CI. This parameter specifies the version of Trivy to be used in the pipeline.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> trivyVersion</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Trivy Version'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> string</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">default</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'0.53.0'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The version of Copacetic to be used</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Copacetic is a tool for checking the health of services. This parameter specifies the version</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># of Copacetic to be used in the pipeline.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> copaVersion</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Copacetic Version'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> string</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">default</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'0.7.0'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The version of BuildKit to be used</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># BuildKit is a toolkit for converting source code to build artifacts in an efficient, </span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># expressive and repeatable manner. This parameter specifies the version of BuildKit to be used in the pipeline.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> buildkitVersion</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'BuildKit Version'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> string</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">default</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'0.15.0'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Variables for the pipeline</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">variables</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The port on which BuildKit will run</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">buildkit.port</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"8888"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The name of the service connection to be used</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">serviceConnectionName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'azcontainerregistry'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># The system.debug variable is set to true. This enables verbose logging for the entire pipeline.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># When this is enabled, Azure Pipelines will output more detailed logs, which can be helpful for debugging.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">system.debug</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">stages</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">stage</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> patch</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">jobs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">job</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Copacetic</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">bash</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token scalar string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # Exit immediately if a command exits with a non-zero status</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            set -e</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # Download the Trivy tarball from the specified URL</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            wget "https://github.com/aquasecurity/trivy/releases/download/v${{ parameters.trivyVersion }}/trivy_${{ parameters.trivyVersion }}_Linux-64bit.tar.gz"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # Extract the Trivy binary to /usr/local/bin</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            sudo tar -C /usr/local/bin -zxvf trivy_${{ parameters.trivyVersion }}_Linux-*.tar.gz trivy</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # Make the Trivy binary executable</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            sudo chmod +x /usr/local/bin/trivy</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # Download the Copacetic tarball from the specified URL</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            wget "https://github.com/project-copacetic/copacetic/releases/download/v${{ parameters.copaVersion }}/copa_${{ parameters.copaVersion }}_linux_amd64.tar.gz"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # Extract the Copacetic binary to /usr/local/bin</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            sudo tar -C /usr/local/bin -zxvf copa_${{ parameters.copaVersion }}_*.tar.gz copa</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # Make the Copacetic binary executable</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            sudo chmod +x /usr/local/bin/copa</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Download and Install Trivy and Copa</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">bash</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token scalar string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # This script is used to run a new Docker container in the background.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # 'set -e' is used to exit the script immediately if a command exits with a non-zero status.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            set -e</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # The 'docker run' command is used to start a new Docker container.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # The '--detach' option is used to run the container in the background and print the new container ID.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # The '--rm' option is used to automatically remove the container when it exits.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # The '--privileged' option is used to give extended privileges to this container.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # The '-p' option is used to publish the container's port to the host.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # The '--name' option is used to assign a name to the container.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # The '--entrypoint' option is used to overwrite the default ENTRYPOINT of the image.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # The '--addr' option is used to specify the listening address of the BuildKit daemon.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            docker run \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">              --detach \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">              --rm \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">              --privileged \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">              -p 127.0.0.1:$(buildkit.port):$(buildkit.port)/tcp \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">              --name buildkitd \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">              --entrypoint buildkitd \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">              "moby/buildkit:v${{ parameters.buildkitVersion }}" \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">              --addr tcp://0.0.0.0:$(buildkit.port)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Run Buildkit</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Docker@2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Login to ACR</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">command</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> login</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">containerRegistry</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> $(serviceConnectionName)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token comment" style="color:rgb(98, 114, 164)"># This task uses the Docker@2 task to log in to Azure Container Registry (ACR)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token comment" style="color:rgb(98, 114, 164)"># The 'command: login' input tells the task to perform a 'docker login' command</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token comment" style="color:rgb(98, 114, 164)"># The 'containerRegistry: $(serviceConnectionName)' input specifies the service connection to use for logging in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token comment" style="color:rgb(98, 114, 164)"># The service connection contains the credentials needed to authenticate with ACR</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">bash</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token scalar string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # Exit immediately if a command exits with a non-zero status</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            set -e</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # Extract the tag from the image name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            tag=${IMAGE#*:}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # Extract the repository from the image name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            repo=${IMAGE%:*}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # Scan the image with Trivy and store the output as a JSON file named copa-patch.json</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            stdbuf -oL trivy image --vuln-type os --ignore-unfixed $IMAGE | grep Total</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token comment" style="color:rgb(98, 114, 164)"># The image to be patched</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">IMAGE</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> parameters.image </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Scan image for DevOps Output</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">bash</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token scalar string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # Exit immediately if a command exits with a non-zero status</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            set -e</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # Extract the tag from the image name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            tag=${IMAGE#*:}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # Extract the repository from the image name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            repo=${IMAGE%:*}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # Scan the image with Trivy and store the output as a JSON file named copa-patch.json</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            stdbuf -oL trivy image --vuln-type os --ignore-unfixed -f json $IMAGE | tee copa-patch.json</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # Use the scan result to patch the image, if needed</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            copa patch \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">              -i $IMAGE \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">              -r copa-patch.json \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">              -t $tag-patched \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">              -a tcp://0.0.0.0:$(buildkit.port)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            docker save -o patched-image.tar $repo:$tag-patched</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # The 'copa patch' command is used to patch the image.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # '-i $IMAGE' specifies the image to be patched.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # '-r copa-patch.json' specifies the file containing the scan results.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # '-t $tag-patched' specifies the tag for the patched image.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # '-a tcp://0.0.0.0:$(buildkit.port)' specifies the address of the BuildKit daemon.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # The 'docker save' command is used to save the new patched image as a tar file that can be used later.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token comment" style="color:rgb(98, 114, 164)"># The image to be patched</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">IMAGE</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> parameters.image </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Scan and Patch Image</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> PublishPipelineArtifact@1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">targetPath</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> $(System.DefaultWorkingDirectory)/copa</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">patch.json</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">artifactName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> scan_results</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Upload Scan Results as a pipeline artifact</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token comment" style="color:rgb(98, 114, 164)"># This task uses the PublishPipelineArtifact@1 task to upload the scan results as a pipeline artifact</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token comment" style="color:rgb(98, 114, 164)"># The 'targetPath: $(System.DefaultWorkingDirectory)/copa-patch.json' input specifies the file to upload</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token comment" style="color:rgb(98, 114, 164)"># The 'artifactName: scan_results' input specifies the name of the artifact in the pipeline</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> PublishPipelineArtifact@1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">targetPath</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> $(System.DefaultWorkingDirectory)/patched</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">image.tar</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">artifactName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> patched</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Upload patched image as a pipeline artifact</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token comment" style="color:rgb(98, 114, 164)"># This task uses the PublishPipelineArtifact@1 task to upload the patched image as a pipeline artifact</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token comment" style="color:rgb(98, 114, 164)"># The 'targetPath: $(System.DefaultWorkingDirectory)/patched-image.tar' input specifies the file to upload</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token comment" style="color:rgb(98, 114, 164)"># The 'artifactName: patched' input specifies the name of the artifact in the pipeline</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">bash</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token scalar string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # Exit immediately if a command exits with a non-zero status</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            set -e</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # Print each command that is executed to the terminal</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            set -x</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # Extract the tag from the image name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            tag=${IMAGE#*:}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # Extract the repository from the image name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            repo=${IMAGE%:*}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # Tag the patched image with the appropriate repository name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # The 'docker tag' command creates a new alias for the image</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # The format is 'docker tag source_image target_image'</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # In this case, the source and target images are the same, so this command effectively does nothing</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            docker tag $repo:$tag-patched $repo:$tag-patched</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # Push the patched image back to Azure Container Registry</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            # The 'docker push' command pushes an image or a repository to a registry</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            docker push $repo:$tag-patched</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token comment" style="color:rgb(98, 114, 164)"># The image to be patched</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">IMAGE</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> parameters.image </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Push Patched Image to ACR</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>For demo purposes, I am using an older version of the <a href="https://hub.docker.com/_/api-firewall" target="_blank" rel="noopener noreferrer">api-firewall</a> image, which has known vulnerabilities that must be patched.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="deployment-results">âDeployment results<a href="https://luke.geek.nz/azure/automate-container-patching-with-trivy-copacetic-azure-devops/#deployment-results" class="hash-link" aria-label="Direct link to âDeployment results" title="Direct link to âDeployment results">â</a></h3>
<p>Let's look at the image in Azure Container Registry before the patch.</p>
<p><img decoding="async" loading="lazy" alt="API FW Before Patch" src="https://luke.geek.nz/assets/images/api-firewall-acr-beforecopapatch-f7b59d864bc68fe82c35a4dd0962e007.png" width="1603" height="574" class="img_ev3q"></p>
<p>Now, let us deploy the pipeline and see the results.</p>
<p><img decoding="async" loading="lazy" alt="API FW Before Patch" src="https://luke.geek.nz/assets/images/api-firewall-ado-beforecopapatch-888841a2192db7c95f253180b5f7eeb8.png" width="1840" height="943" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="Copa ADO pipeline" src="https://luke.geek.nz/assets/images/copa-pipelinerun-f0ba56d6bbe249b36261d27d157b6870.gif" width="2238" height="1190" class="img_ev3q"></p>
<p>After the pipeline has run, we can see the patched image in the Azure Container Registry.</p>
<p><img decoding="async" loading="lazy" alt="API Firewall" src="https://luke.geek.nz/assets/images/api-firewall-acr-aftercopapatch-7ed500a7d4a5bbc90c4794f10f0792de.png" width="1552" height="552" class="img_ev3q"></p>
<p>If we re-run the pipeline again, this time targetting our new patched image, we can see that there are no patchable vulnerabilities found.</p>
<p><img decoding="async" loading="lazy" alt="Copa ADO pipeline" src="https://luke.geek.nz/assets/images/copa-pipelinererun-7b0415f1a2bdb060abffb91500174d26.gif" width="2238" height="1190" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>Remember that Copacetic is a tool that can be used to quickly patch container images without going upstream for a full rebuild - HOWEVER, it does not replace the need to do a full rebuild of the image, as it only patches OS package vulnerabilities, and does not support application dependencies or language-specific packages. It is also recommended not to layer patch on top of patch, as this can lead to a bloated image, and potential conflicts between patches, consider patching the same base image other an an already patched image, if new updates occur.</p></div></div>]]></content>
        <author>
            <name>Luke Murray</name>
            <uri>https://luke.geek.nz</uri>
        </author>
        <category label="Azure" term="Azure"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Push Docker Images to Azure Container Registry with GitHub Codespaces]]></title>
        <id>https://luke.geek.nz/azure/push-docker-images-to-acr-using-github-codespaces/</id>
        <link href="https://luke.geek.nz/azure/push-docker-images-to-acr-using-github-codespaces/"/>
        <updated>2024-07-16T09:16:17.120Z</updated>
        <summary type="html"><![CDATA[This article guides you through pulling and pushing Docker images from DockerHub to Azure Container Registry using GitHub Codespaces.]]></summary>
        <content type="html"><![CDATA[<p><a href="https://github.com/features/codespaces" target="_blank" rel="noopener noreferrer">GitHub Codespaces</a> already have Docker preinstalled as a dependency for the Codespaces environment. This article will guide you through pulling and pushing a Docker image from DockerHub to Azure Container Registry using GitHub Codespaces.</p>
<!-- -->
<p>Pushing a container from Docker Hub to your own Azure Container Registry (ACR) can offer several benefits:</p>
<ul>
<li>Security: You can control who can access your container images, and gives you more control over vulnerability scanning.</li>
<li>Network latency: You can reduce network latency by hosting your container images closer to your deployment targets.</li>
<li>Compliance: You can meet compliance requirements by storing your container images in a specific region.</li>
<li>Integration: You can integrate your container images with other Azure services.</li>
</ul>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>This article assumes you have an <a href="https://learn.microsoft.com/azure/container-registry/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Container Registry</a> already provisioned, you don't need a <a href="https://hub.docker.com/" target="_blank" rel="noopener noreferrer">DockerHub</a> account, if you are pulling from the public repository.</p></div></div>
<ol>
<li>Launch a Codespace, for example: <a href="https://github.com/lukemurraynz/Codespace_IaC_Coding" target="_blank" rel="noopener noreferrer">lukemurraynz/Codespace_IaC_Coding</a>
<img decoding="async" loading="lazy" alt="Open Codespace" src="https://luke.geek.nz/assets/images/Open_IAC_Codespace-4219be529162c1b4167674a9b8a54953.gif" width="2027" height="1021" class="img_ev3q"></li>
<li>Install the <a href="https://marketplace.visualstudio.com/items?itemName=ms-azuretools.vscode-docker" target="_blank" rel="noopener noreferrer">Docker extension</a> for Visual Studio Code in the Codespace</li>
<li>Open the Docker extension and sign in to DockerHub
<img decoding="async" loading="lazy" alt="Install Docker Extension" src="https://luke.geek.nz/assets/images/Open_IAC_Codespace_InstallDockerExtension-f91ef7a3a2bf724a2c09ca9f1e698b5c.gif" width="1888" height="960" class="img_ev3q"></li>
<li>Now we need to log to our Azure Registry; under Registry, select Azure, and connect and log in to your Azure account</li>
<li>Now, we don't have any images, so we need to pull them down from the docker hub. Open the terminal and run the following command:</li>
</ol>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Replace <code>api-firewall:0.6.14</code> with the image and tag you want to pull from DockerHub.</p></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">docker</span><span class="token plain"> pull api-firewall:0.6.14</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="6">
<li>Now that our image is pulled down from the Dockerhub, we need to tag it with our Azure Container Registry and push it. We can do this directly from the Docker extension.</li>
<li>Right-click and select Push</li>
<li>Select Azure as the provider, and select your Azure Container Registry</li>
<li>Now, we need to tag the image with the Azure Container Registry to push it. You can adjust the name and Tag and click OK to Push it.
<img decoding="async" loading="lazy" alt="Push Azure Container Registry" src="https://luke.geek.nz/assets/images/Open_IAC_Codespace_PushContainerACR-6ecce687b3cbfa1c309cf00a3a51cfec.gif" width="1888" height="960" class="img_ev3q"></li>
<li>Now, navigate to your Azure Container Registry in the Azure Portal, and you should see your new image in the repository.
<img decoding="async" loading="lazy" alt="Azure Container Registry" src="https://luke.geek.nz/assets/images/Open_IAC_Codespace_PushedACR-7e4c5116a25736135dfe13d6d862aaa7.png" width="1875" height="806" class="img_ev3q"></li>
</ol>
<p>You have now successfully pulled and pushed a Docker image from DockerHub to Azure Container Registry using GitHub Codespaces.</p>]]></content>
        <author>
            <name>Luke Murray</name>
            <uri>https://luke.geek.nz</uri>
        </author>
        <category label="Azure" term="Azure"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Unable to delete DevCenter Project]]></title>
        <id>https://luke.geek.nz/azure/devcenter-project-deletion-issues/</id>
        <link href="https://luke.geek.nz/azure/devcenter-project-deletion-issues/"/>
        <updated>2024-07-15T08:19:49.761Z</updated>
        <summary type="html"><![CDATA[This article provides solutions to common problems encountered when trying to delete a DevCenter project.]]></summary>
        <content type="html"><![CDATA[<p>When attempting to delete a devcenter project, you may encounter the following error:</p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>This resource is in a failed state.</p></div></div>
<p><img decoding="async" loading="lazy" alt="This resource is in a failed state" src="https://luke.geek.nz/assets/images/devcenter-failed-delete-project-85db72d48ef193b193175fa5259a214e.png" width="1667" height="765" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>The error message usually occurs when environments are created for these projects. This prevents the deletion of the Environment Type / Project / DevCenter. This behavior is designed to prevent accidental deletion.</p></div></div>
<ol>
<li>Sign-in to the <a href="https://azure.microsoft.com/get-started/azure-portal?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Portal</a> go to the project page.</li>
<li>Select Access Control (IAM) in the left panel, then click Add and choose Add role assignment
<img decoding="async" loading="lazy" alt="Dev Center - RBAC (Role Based Access Control)" src="https://luke.geek.nz/assets/images/devcenter-projectadmin-assignrole-255cb29911a82c7bfaddfaebf3dba4d6.png" width="626" height="162" class="img_ev3q"></li>
<li>Search the <strong>DevCenter Project Admin</strong> and grant this role to yourself. <strong>You still need to assign this role - even if you have Owner permissions.</strong>
<img decoding="async" loading="lazy" alt="DevCenter - Assign Project Admin role" src="data:image/png;base64,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" width="658" height="114" class="img_ev3q"></li>
<li>After the operation executes successfully, try to delete the project again</li>
</ol>
<p>If this doesn't work, then you may need to delete the Environment first; if you get an Internal Server error, then wait 2 minutes and retry the deletion again.</p>
<p><img decoding="async" loading="lazy" alt="DevCenter" src="https://luke.geek.nz/assets/images/devcenter-environments-5cf1cc4a63a9a37171dc5c07e18527de.png" width="1621" height="770" class="img_ev3q"></p>]]></content>
        <author>
            <name>Luke Murray</name>
            <uri>https://luke.geek.nz</uri>
        </author>
        <category label="Azure" term="Azure"/>
    </entry>
</feed>