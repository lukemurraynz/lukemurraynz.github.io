<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-tags-post-list-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">164 posts tagged with &quot;Azure&quot; | luke.geek.nz</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://luke.geek.nz/img/social-card.png"><meta data-rh="true" name="twitter:image" content="https://luke.geek.nz/img/social-card.png"><meta data-rh="true" property="og:url" content="https://luke.geek.nz/tags/azure/page/25/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" property="og:title" content="164 posts tagged with &quot;Azure&quot; | luke.geek.nz"><meta data-rh="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://luke.geek.nz/tags/azure/page/25/"><link data-rh="true" rel="alternate" href="https://luke.geek.nz/tags/azure/page/25/" hreflang="en"><link data-rh="true" rel="alternate" href="https://luke.geek.nz/tags/azure/page/25/" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://ZBH2T1WJQD-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="luke.geek.nz RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="luke.geek.nz Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="luke.geek.nz JSON Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0QDLBY7NNN"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-0QDLBY7NNN",{anonymize_ip:!0})</script><link rel="stylesheet" href="/assets/css/styles.a8967c60.css">
<script src="/assets/js/runtime~main.c2626aea.js" defer="defer"></script>
<script src="/assets/js/main.9c974474.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"dark")}(),function(){try{const a=new URLSearchParams(window.location.search).entries();for(var[t,e]of a)if(t.startsWith("docusaurus-data-")){var n=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(n,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:#D3D3D3" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY">If you haven't already make sure you sign up for my Weekly Azure Newsletter, straight to your inbox! <a target="_blank" rel="noopener noreferrer" href="https://newsletter.azurefeeds.com/join">Subscribe now!</a></div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="luke.geek.nz" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.png" alt="luke.geek.nz" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">luke.geek.nz</b></a><a class="navbar__item navbar__link" href="/Tags/">Tags</a><a class="navbar__item navbar__link" href="/Archive/">Blog</a><a class="navbar__item navbar__link" href="/about/">About</a></div><div class="navbar__items navbar__items--right"><a href="https://www.youtube.com/channel/UCUG3TKDTAZz4UXshGrjBBoQ" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-icon" aria-label="YouTube">
              <svg width="24" height="24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path d="M23.498,6.186c-0.273-1.186-1.143-2.144-2.332-2.417C18.389,3.153,12,3.153,12,3.153s-6.389,0-9.166,0.616
                  c-1.19,0.273-2.06,1.23-2.332,2.417C0,8.07,0,12,0,12s0,3.93,0.502,5.814c0.272,1.187,1.142,2.062,2.332,2.335
                  C5.611,20.847,12,20.847,12,20.847s6.389,0,9.166-0.698c1.189-0.273,2.059-1.148,2.332-2.335C24,15.93,24,12,24,12
                  S24,8.07,23.498,6.186z M9.545,15.568V8.432l6.545,3.568L9.545,15.568z"/>
              </svg>
            </a><a href="https://aus.social/@lukemurray" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-icon" aria-label="Mastodon">
              <svg height="20" width="20" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" xml:space="preserve">
                <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                <g id="SVGRepo_iconCarrier">
                  <path d="M21.327 8.566c0-4.339-2.843-5.61-2.843-5.61-1.433-.658-3.894-.935-6.451-.956h-.063c-2.557.021-5.016.298-6.45.956 0 0-2.843 1.272-2.843 5.61 0 .993-.019 2.181.012 3.441.103 4.243.778 8.425 4.701 9.463 1.809.479 3.362.579 4.612.510 2.268-.126 3.541-.809 3.541-.809l-.075-1.646s-1.621.511-3.441.449c-1.804-.062-3.707-.194-3.999-2.409a4.523 4.523 0 0 1-.04-.621s1.77.433 4.014.536c1.372.063 2.658-.08 3.965-.236 2.506-.299 4.688-1.843 4.962-3.254.434-2.223.398-5.424.398-5.424zm-3.353 5.59h-2.081V9.057c0-1.075-.452-1.62-1.357-1.62-1 0-1.501.647-1.501 1.927v2.791h-2.069V9.364c0-1.28-.501-1.927-1.502-1.927-.905 0-1.357.546-1.357 1.62v5.099H6.026V8.903c0-1.074.273-1.927.823-2.558.566-.631 1.307-.955 2.228-.955 1.065 0 1.872.409 2.405 1.228l.518.869.519-.869c.533-.819 1.34-1.228 2.405-1.228.92 0 1.662.324 2.228.955.549.631.822 1.484.822 2.558v5.253z"></path>
                </g>
              </svg>
            </a><a href="https://bsky.app/profile/lukemurraynz.bsky.social" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-icon" aria-label="Bluesky">
              <svg class="octicon" xmlns="http://www.w3.org/2000/svg" role="img" viewBox="0 0 16 16" height="20" width="20" fill="currentColor">
                <title>Bluesky</title>
                <path d="M8 7.2c-.72-1.4-2.7-4.04-4.53-5.33C1.7.63 1.04.84.6 1.04.1 1.27 0 2.05 0 2.51c0 .46.25 3.77.42 4.32.54 1.82 2.47 2.45 4.25 2.25-2.6.38-4.92 1.33-1.88 4.71 3.33 3.46 4.57-.74 5.21-2.87.64 2.13 1.37 6.18 5.16 2.87 2.84-2.87.78-4.33-1.83-4.71 1.78.2 3.71-.43 4.25-2.25.17-.55.42-3.86.42-4.32 0-.46-.09-1.24-.6-1.47-.44-.2-1.11-.42-2.87.83A17.87 17.87 0 0 0 8 7.2Z"></path>
              </svg>
            </a><a href="https://twitter.com/lukemurraynz" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-icon" aria-label="X"><svg height="20" width="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 8.586l4.293-4.293a1 1 0 011.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 011.414-1.414L10 8.586z" clip-rule="evenodd"/>
          </svg></a><a href="https://www.linkedin.com/in/ljmurray/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-icon" aria-label="LinkedIn"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" height="20" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854V1.146zm4.943 12.248V6.169H2.542v7.225h2.401zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248-.822 0-1.359.54-1.359 1.248 0 .694.521 1.248 1.327 1.248h.016zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274 0-1.845.7-2.165 1.193v.025h-.016a5.54 5.54 0 0 1 .016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225h2.4z"></path></svg></a><a href="https://luke.geek.nz/rss" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-rss-link" aria-label="RSS"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)" aria-live="polite" aria-pressed="true"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><div role="group"><h3 class="yearGroupHeading_rMGB">2025</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/misc/product-development-lifecycle/">Product Development lifecycle</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/misc/precommit-hooks-codespaces-terraform-iac/">Pre-commit Hooks in GitHub Codespaces for Terraform IaC</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure/deploying-azure-managed-redis-with-bicep/">Deploying Azure Managed Redis with Bicep</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2024</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure/using-communication-services-and-umi-powershell-to-send-emails/">Using Azure Communication Services and UMI PowerShell to Send Emails</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure/authenticating-azureopenai-python/">Authenticating Azure OpenAI with Managed Identity</a></li></ul></div></nav></aside><main class="col col--7"><header class="margin-bottom--xl"><h1>164 posts tagged with &quot;Azure&quot;</h1><a href="/tags/">View All Tags</a></header><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/azure/application-security-groups-in-microsoft-azure/">Application Security Groups in Microsoft Azure</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-01-21T00:00:00.000Z">January 21, 2022</time> · <!-- -->5 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://luke.geek.nz/img/logo.png" alt="Luke Murray"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">Luke Murray</span></a></div><small class="authorTitle_nd0D" title="Author">Author</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><p>Azure Application Security Groups (ASG) allow you to define what workloads <em>(Virtual Machines)</em> you are running in Azure has access to what resource - without being tied by managing complex IP address rules inside a <a href="https://learn.microsoft.com/en-us/azure/virtual-network/network-security-groups-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Network security groups">Network Security Group</a>.</p>
<blockquote>
<p>Application security groups enable you to configure network security as a natural extension of an application&#x27;s structure, allowing you to group virtual machines and define network security policies based on those groups. You can reuse your security policy at scale without manual maintenance of explicit IP addresses.</p>
</blockquote>
<p>These Azure Application Security groups allow you to define your workloads, for example, Azure Virtual Desktop Session Hosts as a &#x27;group&#x27; and what they may have access to in your Azure Virtual Network without opening up the service to everything inside of that VNET or creating overly complex rules that could make it hard to troubleshoot.</p>
<p>There are a few things to be mindful of:</p>
<ul>
<li>Azure Application Security Groups are Virtual Network-specific, so they can work to allow resources across subnets, but not in separate Virtual Networks, even if they have peered.</li>
<li>As with most Azure resources, there are Subscription level<a href="https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/azure-subscription-service-limits?toc=%2Fazure%2Fvirtual-network%2Ftoc.json&amp;WT.mc_id=AZ-MVP-5004796#azure-resource-manager-virtual-networking-limits" target="_blank" rel="noopener noreferrer" title="Networking limits - Azure Resource Manager">limits</a>; you cannot have more than 3,000 Azure Application Security groups in a single subscription and region.</li>
<li>The rules that specify an application security group as the source or destination are only applied to the network interfaces that are members of the application security group; this does not affect anything not in this group, even though your Network Security Group is based on the subnet.</li>
<li>You can assign more than one Application Security group to a resource</li>
</ul>
<p>In my example, I have a single virtual network, with 2 subnets <em>(one subnet, has an Azure Virtual Desktop session host and the other one has a webserver running IIS)</em>, using Azure Application Security Groups, we will restrict IIS access to the webserver from the Azure Virtual Session hosts only - so IIS won&#x27;t be accessible from any other machine in the Virtual Network.</p>
<p><img decoding="async" loading="lazy" alt="High Level  - Diagram ASG" src="/assets/images/highleveldiagram_asg-b3541199809fbe28888be07cd337ab22.png" title="High Level  - Diagram ASG" width="627" height="527" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-application-security-group">Create Application Security Group<a href="#create-application-security-group" class="hash-link" aria-label="Direct link to Create Application Security Group" title="Direct link to Create Application Security Group">​</a></h4>
<p>Let&#x27;s get started by creating an Application Security Group.</p>
<ol>
<li>Open the <strong>Azure Portal</strong></li>
<li>Click on <a href="https://portal.azure.com/#create/hub" target="_blank" rel="noopener noreferrer" title="Azure Portal - Create a resoruce"><strong>+ Create a resource</strong></a></li>
<li>Search for: <strong>Application security group</strong> and select it</li>
<li>Click <strong>Create</strong></li>
<li><strong>Select</strong> the <strong>subscription</strong> that the Application Security group will be created in</li>
<li><strong>Select</strong> the <strong>Resource Group</strong> <em>(in my example, I am selecting AVD)</em></li>
<li><img decoding="async" loading="lazy" alt="Create an Application Security Group" src="/assets/images/create-applicationsecuritygroup-7c738b80cdc65d2afbc2e536ee6a13fb.png" title="Create an Application Security Group" width="795" height="416" class="img_ev3q"></li>
<li>Click <strong>Review + create</strong></li>
<li>Click <strong>Create</strong></li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="assign-application-security-group">Assign Application Security Group<a href="#assign-application-security-group" class="hash-link" aria-label="Direct link to Assign Application Security Group" title="Direct link to Assign Application Security Group">​</a></h4>
<p>Now that the Application Security group has been created it&#x27;s time to assign it this our Azure Virtual Desktop session hosts.</p>
<ol>
<li>Open the <strong>Azure Portal</strong></li>
<li><strong>Navigate</strong> to your <strong>Azure Virtual Desktop</strong> session host <em>(or other workloads you are going to use)</em></li>
<li>Select <strong>Networking</strong></li>
<li>Select <strong>Application security groups</strong></li>
<li>Click <strong>Configure the application security groups</strong></li>
<li><strong>Select</strong> the Application Security <strong>group</strong> created earlier</li>
<li><img decoding="async" loading="lazy" alt="Assign Application Security Group" src="/assets/images/assign-applicationsecuritygroup-a027d76b6b8017a47834f83cd8e195dd.png" title="Assign Application Security Group" width="1090" height="370" class="img_ev3q"></li>
<li>Click <strong>Save</strong></li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="assign-block-rule-security-group">Assign Block Rule Security Group<a href="#assign-block-rule-security-group" class="hash-link" aria-label="Direct link to Assign Block Rule Security Group" title="Direct link to Assign Block Rule Security Group">​</a></h4>
<p>Now it&#x27;s time to assign a block rule to our web server, for port 80 as by default it is allowed through the &#x27;AllowVnetInBound&#x27; default rule.</p>
<ol>
<li>Navigate to the <strong>Network Security Group</strong> that holds your web server <em>(I am going to make the change on a Network Security group that is tied to the Network Interface of the web server, but the same principle applies if it was applied to a Network Security Group on the subnet - you just need to add the destination IP of the webserver)</em></li>
<li>Click on <strong>Inbound security rules</strong></li>
<li>Click <strong>+ Add</strong></li>
<li>Add a <strong>Deny</strong> port <strong>rule</strong> for port <strong>80</strong> for all source</li>
<li><img decoding="async" loading="lazy" alt="Assign Block Network Security Group Rule" src="/assets/images/create-blocknsg80rule-bc26478f693a52a88eca9ec532b4150a.png" title="Assign Block Network Security Group Rule" width="1721" height="964" class="img_ev3q"></li>
<li>Click <strong>Save</strong></li>
</ol>
<p>After a few minutes, traffic from any workloads on the virtual network will now be blocked from accessing the web server on port 80.</p>
<p><img decoding="async" loading="lazy" alt="Port 80 blocked" src="/assets/images/avd-testport80_deny-14b3573e8ea4a22bd77000fdfe5ab572.png" title="Port 80 blocked" width="999" height="748" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-allow-rule-using-application-security-group">Create Allow rule using Application Security Group<a href="#create-allow-rule-using-application-security-group" class="hash-link" aria-label="Direct link to Create Allow rule using Application Security Group" title="Direct link to Create Allow rule using Application Security Group">​</a></h4>
<p>Just a note around the priorities of Network Security Group rules:</p>
<blockquote>
<p>Rules are processed in priority order <em>(using a number between 100 and 4096)</em>, with lower numbers processed before higher numbers, because lower numbers have higher priority. Once traffic matches a rule, processing stops.</p>
<p>As a result, any rules that exist with lower priorities (higher numbers) that have the same attributes as rules with higher priorities are not processed.</p>
</blockquote>
<ol>
<li>Navigate to the <strong>Network Security Group</strong> that holds your web server <em>(I am going to make the change on a Network Security group that is tied to the Network Interface of the web server, but the same principle applies if it was applied to a Network Security Group on the subnet - you just need to add the destination IP of the webserver)</em></li>
<li>Click on <strong>Inbound security rules</strong></li>
<li>Click <strong>+ Add</strong></li>
<li>For <strong>Source</strong>, select the <strong>Application Security Group</strong></li>
<li>Select <strong>HTTP</strong> as the service</li>
<li>Select <strong>Allow</strong> as the action</li>
<li>Set the <strong>Priority</strong> to be <strong>lower</strong> than the block rule, ie 4095</li>
<li>Click <strong>Save</strong></li>
<li><img decoding="async" loading="lazy" alt="Create Network Security Rule Allow" src="/assets/images/avd-testport80_allow-3b6c766ed0c1fd30f863b2698e3733ac.png" title="Create Network Security Rule Allow" width="1263" height="971" class="img_ev3q"></li>
</ol>
<p>After a few minutes, traffic from any workloads on the virtual network will now be allowed for any workloads from your Azure Virtual Desktop farm only <em>(assigned to the Application Security group)</em>.</p>
<p><img decoding="async" loading="lazy" alt="AVD - Test Port 80 Allow" src="/assets/images/avd-testport80_edgeallow-1e2a72b524e604e0989c21987b646f7c.png" width="1276" height="688" class="img_ev3q"></p>
<p>If I attempted to access the webserver from my application server, it fails:</p>
<p><img decoding="async" loading="lazy" alt="AVD - Test Port 80 Deny" src="/assets/images/avd-testport80_deny-14b3573e8ea4a22bd77000fdfe5ab572.png" width="999" height="748" class="img_ev3q"></p>
<p>Hopefully, this helps you avoid overly complex security rules that are reliant on knowing and managing the IP of your workloads and help secure your networks.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/azure/">Azure</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/2022/01/16/awesome-azure-architecture-list/">AWESOME-Azure-Architecture List</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-01-16T00:00:00.000Z">January 16, 2022</time> · <!-- -->One min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://luke.geek.nz/img/logo.png" alt="Luke Murray"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">Luke Murray</span></a></div><small class="authorTitle_nd0D" title="Author">Author</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><p>A very brief Blog article today, I have created an AWESOME-Azure-Architecture list, this list is hosted in Github and located here:</p>
<ul>
<li><a href="https://github.com/lukemurraynz/awesome-azure-architecture/blob/main/README.md" target="_blank" rel="noopener noreferrer" title="AWESOME-Azure-Architecture">AWESOME-Azure-Architecture</a></li>
</ul>
<p>This list is a curated list of AWESOME blogs, videos, tutorials, code, tools &amp; scripts, related to the design and implementation of solutions in Microsoft Azure.</p>
<p>This list contains anything that can help with your <strong>Microsoft Azure architecture</strong> and quickly get you up and running when designing, planning, and implementing services that empower organisations around the planet to achieve more.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/azure/">Azure</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/azure/create-azure-point-to-site-vpn-using-azure-active-directory-authentication/">Create Azure Point to Site VPN using Microsoft Entra ID authentication</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-01-12T00:00:00.000Z">January 12, 2022</time> · <!-- -->9 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://luke.geek.nz/img/logo.png" alt="Luke Murray"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">Luke Murray</span></a></div><small class="authorTitle_nd0D" title="Author">Author</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><p>You may be working remotely or only have a few devices needing access to your resources in Azure; a solution that can be deployed is a point to site connection straight into your Microsoft Azure network.</p>
<p>This functionality allows your computer to connect privately to resources over a secure tunnel using your internet connection, using an Azure Virtual Network gateway, you can seamlessly connect to resources without the need of opening up your resources to the internet or having to whitelist your <em>(or third party vendor)</em> IP address, which may change daily.</p>
<p>You know only your specified users access your Azure resources using Microsoft Entra ID.</p>
<p>You can have a site to site and point to site VPN running on the same Gateway today. We will set up a Point to Site VPN using Windows 11.</p>
<p><img decoding="async" loading="lazy" alt="Azure Point to Site" src="/assets/images/hl_azurep2s-b91230db64b1534a63ed0a1112fb73ed.png" width="620" height="293" class="img_ev3q"></p>
<p>Depending on the SKU of your Virtual Network Gateway, depends on the number of concurrent connections and throughput you are allowed; because we are using Microsoft Entra ID and the OpenVPN protocol, I will be selecting Generation 1, VpnGw1, supporting a max of 250 connections <em>(you can double the number of throughput and connections if you are running in Active/Active and have a second gateway, or select a higher SKU)</em>.</p>
<blockquote>
<p>Azure AD authentication is supported for OpenVPN® protocol connections only and requires the Azure VPN client.</p>
</blockquote>
<p>A note about Gateway SKUs <em>(apart from Basic)</em> you can resize in the same generation <em>(i.e. Generation 1 VpnGw1 to VpnGw3, but you can&#x27;t go from Generation 1 VpnGw1 to Generation 2 VpnGw5, in order to upgrade, you have to delete and recreate the Gateway, just keep this in mind when deciding on the SKU of your resources</em>).</p>
<p>You can read more about the Virtual Network Gateways and VPN SKUs at the official Microsoft documentation <a href="https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpngateways?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">here</a>; your Gateway SKU may differ depending on your requirements.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-azure-point-to-site-vpn-using-microsoft-entra-id-authentication">Create Azure Point to Site VPN using Microsoft Entra ID authentication<a href="#create-azure-point-to-site-vpn-using-microsoft-entra-id-authentication" class="hash-link" aria-label="Direct link to Create Azure Point to Site VPN using Microsoft Entra ID authentication" title="Direct link to Create Azure Point to Site VPN using Microsoft Entra ID authentication">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="prerequisites">Prerequisites<a href="#prerequisites" class="hash-link" aria-label="Direct link to Prerequisites" title="Direct link to Prerequisites">​</a></h4>
<ul>
<li>An Azure subscription <em>(that you have at least contributor rights to and the ability to create Users and Groups)</em></li>
<li>An endpoint device running Windows 10 or 11 that you can install the <a href="https://www.microsoft.com/en-us/p/azure-vpn-client-preview/9np355qt2sqb?rtc=2&amp;activetab=pivot:overviewtab" target="_blank" rel="noopener noreferrer" title=" Azure VPN Client">Azure VPN client</a> onto</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-virtual-network">Create Virtual Network<a href="#create-virtual-network" class="hash-link" aria-label="Direct link to Create Virtual Network" title="Direct link to Create Virtual Network">​</a></h4>
<p>First things first, let&#x27;s create a Virtual Network.</p>
<ol>
<li>Log in to the <a href="https://portal.azure.com/#home" target="_blank" rel="noopener noreferrer" title="Azure Portal"><strong>Azure Portal</strong></a></li>
<li>Click on <strong>+ Create a resource</strong></li>
<li>Search for: <strong>Virtual Network</strong> and click on it</li>
<li>Click <strong>Create</strong></li>
<li><strong>Select</strong> or create your <strong>Resource Group</strong> that you want your network resource to sit in <em>(I recommend Virtual Network and the gateway resources sit in its own Resource Group away from other resources so that they can be protected by resource locks, RBAC and they are usually classified as a shared resource)</em>.</li>
<li><img decoding="async" loading="lazy" alt="Azure Virtual Network" src="/assets/images/azureportal-createvirtualnetwork-a1fbd5e45e24eb1276224ba7ce936150.png" title="Azure Virtual Network" width="782" height="481" class="img_ev3q"></li>
<li>Click <strong>Next: IP Addresses</strong></li>
<li>Now we need to <strong>define</strong> the <strong>Address space</strong> and subnets; I will leave the Address space as 10.0.0.0/16 but remove the Default subnet <em>(select the checkbox next to the Subnet and select Delete)</em></li>
<li>Click +<strong>Add Subnet</strong>, and add a new subnet with the name of GatewaySubnet with an IP range of: 10.0.1.0/27 <em>(this Subnet will be used by our Virtual Network Gateway, and the name needs to be exactly GatewaySubnet)</em>.</li>
<li>Now I will add a subnet named: app servers, for the Virtual Machines I will need to connect to will be placed.</li>
<li><img decoding="async" loading="lazy" alt="Azure Virtual Network" src="/assets/images/azureportal-createvirtualnetworksubnets-646829ca5d787c48027b5d59962ab0c0.png" title="Azure Virtual Network" width="782" height="493" class="img_ev3q"></li>
<li>Click <strong>Next: Security</strong></li>
<li>Leave everything <em>(BastionHost, DDoS Protection Standard, Firewall)</em> as Disabled.</li>
<li>Click <strong>Next: Tags</strong></li>
<li>Enter in any tags and click <strong>Review + Create</strong></li>
<li>Review your configuration and click <strong>Create</strong></li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-virtual-network-gateway">Create Virtual Network Gateway<a href="#create-virtual-network-gateway" class="hash-link" aria-label="Direct link to Create Virtual Network Gateway" title="Direct link to Create Virtual Network Gateway">​</a></h4>
<p>Now that we have the foundation of our setup - an Azure Virtual Network, it is time to provision the Gateway itself; just a note before we continue, the Gateway can take 30-60 minutes to provision.</p>
<ol>
<li>Log in to the <a href="https://portal.azure.com/#home" target="_blank" rel="noopener noreferrer" title="Azure Portal">Azure Portal</a></li>
<li>Click on <strong>+ Create a resource</strong></li>
<li>Type in and search for: <strong>Virtual Network Gateway</strong></li>
<li>Click <strong>Create</strong></li>
<li>Type in the <strong>name</strong> of your Azure Virtual Network <strong>Gateway</strong></li>
<li>Select the <strong>region</strong> <em>(it must be the same region as your virtual network)</em></li>
<li>Select the Gateway Type: <strong>VPN</strong></li>
<li>The VPN type is: <strong>Route-based</strong></li>
<li><strong>Select</strong> the <strong>SKU</strong>, in this example - I will be going with VpnGw1</li>
<li><strong>Select</strong> the <strong>Generation</strong> of the Virtual Network Gateway; I am going with: Generation 1</li>
<li><strong>Select</strong> the <strong>Virtual Network</strong> that you created earlier, and it will automatically find and assign the Gateway to the Subnet named: GatewaySubnet</li>
<li><strong>Select</strong> Standard <strong>public IP</strong> address <strong>SKU</strong></li>
<li><strong>Select Public IP</strong> address and select: <strong>Create new</strong></li>
<li><strong>Type</strong> in your public IP <strong>name</strong></li>
<li><strong>Leave</strong> &#x27;Enable active-active mode&#x27; and &#x27;Configure BGP&#x27; as <strong>Disabled</strong>.</li>
<li>Click <strong>Review + Create</strong></li>
<li><img decoding="async" loading="lazy" alt="Azure Virtual Network Gateway" src="/assets/images/azureportal-createvnetfgw-5d497c12b28d82b47ebe4cfe171943d6.png" title="Azure Virtual Network Gateway" width="809" height="1004" class="img_ev3q"></li>
<li><strong>Verify configuration</strong> is correct and clicks <strong>Create</strong></li>
<li>It can take up to 30-60 minutes for the Virtual Network Gateway to be created.</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="setup-microsoft-entra-id-authentication-on-the-virtual-network-gateway">Setup Microsoft Entra ID authentication on the Virtual Network Gateway<a href="#setup-microsoft-entra-id-authentication-on-the-virtual-network-gateway" class="hash-link" aria-label="Direct link to Setup Microsoft Entra ID authentication on the Virtual Network Gateway" title="Direct link to Setup Microsoft Entra ID authentication on the Virtual Network Gateway">​</a></h4>
<p>Now that the Virtual Network has been created, we can now set up Microsoft Entra ID authentication.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="collect-microsoft-entra-id-tenant-id">Collect Microsoft Entra ID Tenant ID<a href="#collect-microsoft-entra-id-tenant-id" class="hash-link" aria-label="Direct link to Collect Microsoft Entra ID Tenant ID" title="Direct link to Collect Microsoft Entra ID Tenant ID">​</a></h5>
<p>First, we need to collect the Azure AD Tenancy ID</p>
<ol>
<li>Log in to the <a href="https://portal.azure.com/#home" target="_blank" rel="noopener noreferrer" title="Azure Portal"><strong>Azure Portal</strong></a></li>
<li>Click on <strong>Microsoft Entra ID</strong></li>
<li>In the Overview pane, <strong>copy</strong> the <strong>Tenant ID</strong> and save this for the next step.</li>
</ol>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="grant-azure-vpn-client-permisisons">Grant Azure VPN Client permisisons<a href="#grant-azure-vpn-client-permisisons" class="hash-link" aria-label="Direct link to Grant Azure VPN Client permisisons" title="Direct link to Grant Azure VPN Client permisisons">​</a></h5>
<p>Now we need to grant the Azure VPN application permissions.</p>
<ol>
<li>
<p>Log in to the <a href="https://portal.azure.com/#home" target="_blank" rel="noopener noreferrer" title="Azure Portal"><strong>Azure Portal</strong></a></p>
</li>
<li>
<p>Open a new window and type in and press Enter:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">https://login.microsoftonline.com/common/oauth2/authorize?client_id=41b23e61-6c1e-4545-b367-cd054e0ed4b4&amp;response_type=code&amp;redirect_uri=https://portal.azure.com&amp;nonce=1234&amp;prompt=admin_consent</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>If you get an error about external identity, then replace /<strong>common</strong>/ with your tenant ID.</p>
</li>
<li>
<p><img decoding="async" loading="lazy" alt="Azure VPN Permissions" src="/assets/images/azureportal_azurevpnpermissions-4859ac00017f2a1a732286341841759f.png" title="Azure VPN Permissions" width="458" height="588" class="img_ev3q"></p>
</li>
<li>
<p>Click <strong>Accept</strong></p>
</li>
<li>
<p>Navigate back to <strong>Microsoft Entra ID</strong></p>
</li>
<li>
<p>Select <strong>Enterprise Applications</strong></p>
</li>
<li>
<p>Select <strong>Azure VPN</strong></p>
</li>
<li>
<p><strong>Copy</strong> the <strong>Application ID</strong> of the Azure VPN enterprise application <em>(you will need both Application ID and tenant ID for the next steps)</em></p>
</li>
<li>
<p><img decoding="async" loading="lazy" alt="Azure VPN" src="/assets/images/azurevpn_enterpriseappvpn-48f8cda9eb6f9303035c244b742d5c11.png" title="Azure VPN" width="652" height="338" class="img_ev3q"></p>
</li>
</ol>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="configure-point-to-site-connection">Configure Point to Site Connection<a href="#configure-point-to-site-connection" class="hash-link" aria-label="Direct link to Configure Point to Site Connection" title="Direct link to Configure Point to Site Connection">​</a></h5>
<p>Now its time to configure the Virtual Network Gateway</p>
<ol>
<li>Log in to the <a href="https://portal.azure.com/#home" target="_blank" rel="noopener noreferrer" title="Azure Portal"><strong>Azure Portal</strong></a></li>
<li><strong>Navigate</strong> to the Virtual Network <strong>Gateway</strong> you created earlier</li>
<li>Click on <strong>Point-to-site configuration</strong></li>
<li>Click <strong>Configure now</strong></li>
<li>Enter in your <strong>address pool</strong> <em>(this is the address pool of the VPN clients, make sure this doesn&#x27;t overlap with any other IP range you use, I will go with: 172.0.0.0/16)</em></li>
<li>Make sure the Tunnel type is: <strong>OpenVPN (SSL)</strong></li>
<li>Select <strong>Microsoft Entra ID</strong> for the <strong>Authentication</strong> type</li>
<li>For <strong>Tenant, ID enter</strong> in: <a href="https://login.microsoftonline.com/**TENANTID**/" target="_blank" rel="noopener noreferrer">https://login.microsoftonline.com/**TENANTID**/</a> and enter in your own Tenant ID.</li>
<li>For the Audience (this is the users and groups that are assigned to the Enterprise Azure VPN application), put in the Application ID of the Azure VPN.</li>
<li>For the Issuer, enter in: <a href="https://sts.windows.net/**TENANTID**/" target="_blank" rel="noopener noreferrer">https://sts.windows.net/**TENANTID**/</a></li>
<li><img decoding="async" loading="lazy" alt="Azure Virtual Network Gateway" src="/assets/images/azure-point-to-site-configuration-14d899979995fe8bec94fe6971233b8e.png" title="Azure Virtual Network Gateway" width="893" height="912" class="img_ev3q"></li>
<li>Click <strong>Save</strong></li>
<li>It may take 1-5 minutes to save the configuration</li>
</ol>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="install-and-connect-using-the-azure-vpn-client">Install and connect using the Azure VPN client<a href="#install-and-connect-using-the-azure-vpn-client" class="hash-link" aria-label="Direct link to Install and connect using the Azure VPN client" title="Direct link to Install and connect using the Azure VPN client">​</a></h5>
<p>Now that the Point to Site VPN has been configured it&#x27;s time to connect!</p>
<ol>
<li>Click on <strong>Download VPN client</strong> <em>(if it is greyed out, then navigate to the Overview pane, then back to the Point-to-site configuration)</em>.</li>
<li>Extract the zip file, you will need these files</li>
<li><strong>Download</strong> the <a href="https://go.microsoft.com/fwlink/?linkid=2117554" target="_blank" rel="noopener noreferrer">Azure VPN Client</a> to your computer.</li>
<li><img decoding="async" loading="lazy" alt="Azure VPN Client" src="/assets/images/windowsstore-azurevpn-e3c19700463ac2ec4b149f6c5dffffd5.png" title="Azure VPN Client" width="1200" height="929" class="img_ev3q"></li>
<li>Once, downloaded click <strong>Open.</strong></li>
<li>Click the <strong>+</strong> sign (lower left)</li>
<li>Click <strong>Import</strong></li>
<li><strong>Navigate</strong> to the: <strong>azurevpnconfig.xml</strong> file that you downloaded earlier and click <strong>Open</strong></li>
<li>You can change the Connection Name to something more user friendly <em>(you can also edit the file directly for when you look at pushing out this to multiple users, but make sure you have a backup of the file)</em></li>
<li>Click <strong>Save</strong></li>
<li><img decoding="async" loading="lazy" alt="Azure VPN Connection" src="/assets/images/azurevpnclient-beforeconnection-9c72c647ae6b840531511a45307f43b5.png" title="Azure VPN Connection" width="1160" height="850" class="img_ev3q"></li>
<li>Click <strong>Connect</strong></li>
<li>Enter in your Microsoft Entra ID credentials <em>(you may be prompted for MFA, depending on the rules - you can use Azure VPN application under conditional access)</em></li>
<li><img decoding="async" loading="lazy" alt="Azure VPN Connection" src="/assets/images/azurevpnclient-afterconnection-17f6b2c4077a7fa39392fc321fddb00c.png" title="Azure VPN Connection" width="1160" height="850" class="img_ev3q"></li>
<li><strong>You should now be connected to the Azure network through a point to site VPN!</strong></li>
<li>If I run &#x27;ipconfig /all&#x27; on my device, I can see a PPP adapter that is connected and on the VPN address range created earlier: 172.0.0.2</li>
<li><img decoding="async" loading="lazy" alt="Azure Point to Site Connections" src="/assets/images/azurevpn-ipconfig-2c8c0b092f836ec502ad15d41cc3cc31.png" title="Azure Point to Site Connections" width="564" height="227" class="img_ev3q"></li>
<li>If I navigate back to the Point-to-site connection in the Azure Portal, I can see, my connection has been allocated:</li>
<li><img decoding="async" loading="lazy" alt="Azure Point to Site Connections" src="/assets/images/azurevpn-p2sconnections-a5656eeefdd5297cec6ce9c2fef165d7.png" title="Azure Point to Site Connections" width="871" height="552" class="img_ev3q"></li>
<li>I can now use Remote Desktop to connect to a Virtual Machine, running in my AppServers Subnet, which I am running without the need of a Public IP or bastion/jump host:</li>
<li><img decoding="async" loading="lazy" alt="Azure Point to Site VPN" src="/assets/images/azurevpn-rdp-1e634ab96e9fa3a4173047be002a127a.png" title="Azure Point to Site VPN" width="1380" height="692" class="img_ev3q"></li>
</ol>
<p>Note: I don&#x27;t have a DNS service running in Azure, but the Azure VPN agent will take DNS from the Virtual Network if you have this configured to point towards a DNS server (Active Directory, or other DNS forwarder (pointing towards Azure DNS IP: 168.63.129.16) such as Azure Firewall DNS proxy; you can set Custom DNS servers by modifying your DNS configuration, or add entries into the host file of the computers.</p>
<p>You can set your Custom DNS settings (remember to add the DNS suffix if needed) and configure the VPN to automatically connect by following the details on the <a href="https://learn.microsoft.com/en-us/azure/vpn-gateway/openvpn-azure-ad-client#faq" target="_blank" rel="noopener noreferrer" title="Microsoft Entra ID authentication: Configure a VPN client for P2S OpenVPN protocol connections">OpenVPN Azure AD</a> Client page.</p>
<p>Using Intune, you can also push this configuration to your Windows 10 and 11 clients</p>
<ul>
<li><a href="https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-profile-intune?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Create custom Intune profiles to deploy VPN client profiles</a></li>
</ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/azure/">Azure</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/azure/azure-public-dns-as-code/">Azure Public DNS as Code</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-01-07T00:00:00.000Z">January 7, 2022</time> · <!-- -->13 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://luke.geek.nz/img/logo.png" alt="Luke Murray"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">Luke Murray</span></a></div><small class="authorTitle_nd0D" title="Author">Author</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><p>The Microsoft Azure ecosystem offers a lot of capabilities that empower individuals and businesses; one of those capabilities that are often overlooked is <a href="https://en.wikipedia.org/wiki/Domain_Name_System" target="_blank" rel="noopener noreferrer">DNS</a><em>(Domain Name System)</em>.</p>
<blockquote>
<p><em>Azure DNS allows you to host your DNS domain in Azure, so you can manage your DNS records using the same credentials, billing, and support contract as your other Azure services. Zones can be either public or private, where Private DNS Zones (in Managed Preview) are only visible to VMs that are in your virtual network.</em></p>
<p><em>You can configure Azure DNS to resolve hostnames in your public domain. For example, if you purchased the contoso.xyz domain name from a domain name registrar, you can configure Azure DNS to host the contoso.xyz domain and resolve <code>www.contoso.xyz</code> to the IP address of your web server or web app.</em></p>
</blockquote>
<p>In this article, we are going to focus on <a href="https://learn.microsoft.com/en-us/azure/dns/dns-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Public DNS</a>.</p>
<p>I had my external DNS under source control using Terraform and the Cloudflare provider a few years ago. I wanted to see if I use source control and continuous integration to do the same thing using Azure DNS and Azure Bicep.</p>
<p>My theory was I could make a change to a file and then commit it and have the Azure DNS records created or modified automatically, allowing changes to DNS to be gated, approved, scheduled and audited, allowing changes and rollback a lot easier – without having to give people access to be able to create DNS records with no auditability, turns out you can!</p>
<p>Using an Azure DevOps pipeline and repository and Azure Bicep, we will deploy an Azure Public DNS zone to a resource group automatically on a successful commit and any records.</p>
<p><img decoding="async" loading="lazy" alt="Azure Bicep - Pipeline High Level" src="/assets/images/azurebicep_dns_hld-d9c6656c1bcbd625f9ea4faebd61a01a.png" title="Azure Bicep - Pipeline High Level" width="1398" height="649" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-azure-public-dns-as-code">Create Azure Public DNS as Code<a href="#create-azure-public-dns-as-code" class="hash-link" aria-label="Direct link to Create Azure Public DNS as Code" title="Direct link to Create Azure Public DNS as Code">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="prerequisites">Prerequisites<a href="#prerequisites" class="hash-link" aria-label="Direct link to Prerequisites" title="Direct link to Prerequisites">​</a></h4>
<ul>
<li>An <a href="https://azure.microsoft.com/en-us/pricing/details/devops/azure-devops-services/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure DevOps</a> account and permissions to create a service endpoint</li>
<li>An Azure subscription that you have at least contributor rights to</li>
<li>A git repository <em>(I am going to use the repository in Azure DevOps, but you could use a nested repository from GitHub)</em></li>
<li>The latest <a href="https://learn.microsoft.com/en-us/powershell/azure/install-az-ps?view=azps-7.5.0&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure PowerShell</a> modules and <a href="https://learn.microsoft.com/en-us/azure/azure-resource-manager/bicep/install?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Bicep/Azure CLI</a> for local editing</li>
<li>A domain name and rights to change the nameservers to point towards Azure DNS</li>
</ul>
<p>In this article, I will be using an Azure subscription. I have access to an Azure DevOps <em>(free)</em> subscription and a custom domain I joined named &#x27;badasscloud.com&#x27;.</p>
<p>I will assume that you have nothing set up but feel free to skip the sections that aren&#x27;t relevant.</p>
<p>That that we have the prerequisites sorted let&#x27;s set it up...</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-azure-devops-repository">Create Azure DevOps Repository<a href="#create-azure-devops-repository" class="hash-link" aria-label="Direct link to Create Azure DevOps Repository" title="Direct link to Create Azure DevOps Repository">​</a></h4>
<ol>
<li>
<p><a href="https://go.microsoft.com/fwlink/?LinkId=2014676&amp;githubsi=true&amp;clcid=0x409&amp;WebUserId=e3e298aac5104b0e8e949b3b5bbeb314" target="_blank" rel="noopener noreferrer"><strong>Sign in to Azure DevOps</strong></a></p>
</li>
<li>
<p>Select <strong>+ New Project</strong></p>
</li>
<li>
<p>Give your <strong>project</strong> a <strong>name</strong> <em>(i.e., I am going with: DNSAsCode)</em></p>
</li>
<li>
<p><img decoding="async" loading="lazy" alt="Azure DevOps - Create New Project" src="/assets/images/azuredevops-creatednsproject-df36404500efaa8d7c0ef858faab19d9.png" title="Azure DevOps - Create New Project" width="631" height="636" class="img_ev3q"></p>
</li>
<li>
<p>Click <strong>Create</strong> <em>(your project will now be created)</em></p>
</li>
<li>
<p>Click on <strong>Repos</strong></p>
</li>
<li>
<p>Click on <strong>Files</strong></p>
</li>
<li>
<p>Find the &#x27;<strong>Initialize Main branch with a README or gitignore</strong>&#x27; section and click <strong>Initialize.</strong></p>
</li>
<li>
<p><img decoding="async" loading="lazy" alt="Azure DevOps - Create New Project" src="data:image/png;base64,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" title="Azure DevOps - Create New Project" width="559" height="147" class="img_ev3q"></p>
</li>
<li>
<p>You should now have an empty git repository!</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-azure-devops-service-connection">Create Azure DevOps Service Connection<a href="#create-azure-devops-service-connection" class="hash-link" aria-label="Direct link to Create Azure DevOps Service Connection" title="Direct link to Create Azure DevOps Service Connection">​</a></h4>
<p>For Azure DevOps to connect to Microsoft Azure, we need to set up a service principal; you can create the service connection in Azure DevOps. However, it usually generates a service principal with a name that could be unrecognizable in the future in Azure, and I prefer to develop them according to naming convention and something that I can look at and instantly recognize its use-case. To do that, we will create it using Azure CLI.</p>
<ol>
<li>
<p>Open <strong>PowerShell</strong></p>
</li>
<li>
<p><strong>Run</strong> the following <strong>commands</strong> to connect to Azure and <strong>create</strong> your <strong>Service Principal</strong> with Contributor <strong>access</strong> to <strong>Azure</strong>:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">#Connects to Microsoft Azure</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">az.cmd login</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#Set SPN name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$AppRegName = &#x27;SPN.AzureSubscription.Contributor&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#Creates SPN and sets SPN as Contributor to the subscription</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$spn = az.cmd ad sp create-for-rbac --name $AppRegName --role &#x27;contributor&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#Exports Password, Tenant &amp; App ID for better readability - required for Azure DevOps setup</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$spn | ConvertFrom-Json | Select-Object -Property password, tenant, appId</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">az.cmd account show --query id --output tsv</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">az.cmd account show --query name --output tsv</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>Make sure you <strong>record</strong> the <strong>password</strong>, <strong>application ID</strong> and the <strong>subscription ID/name</strong>; you will need this for the next step - you won&#x27;t be able to view it anywhere else; if you lose it, you can rerun the sp create command to generate a new password. Now that we have the SPN, we need to add the details into Azure DevOps.</p>
</li>
<li>
<p><a href="https://go.microsoft.com/fwlink/?LinkId=2014676&amp;githubsi=true&amp;clcid=0x409&amp;WebUserId=e3e298aac5104b0e8e949b3b5bbeb314" target="_blank" rel="noopener noreferrer"><strong>Sign in to Azure DevOps</strong></a></p>
</li>
<li>
<p>Navigate to the DNS As Code <strong>project</strong> you created earlier</p>
</li>
<li>
<p>Click on <strong>Project Setting</strong>s <em>(bottom right-hand side of the window)</em></p>
</li>
<li>
<p>Click on <strong>Service connections</strong></p>
</li>
<li>
<p>Click on: <strong>Create a service connection</strong></p>
</li>
<li>
<p>Select <strong>Azure Resource Manager</strong></p>
</li>
<li>
<p>Click <strong>Next</strong></p>
</li>
<li>
<p>Click on: <strong>Service Principal (Manual</strong>) and click Next</p>
</li>
<li>
<p><strong>Enter</strong> in the following <strong>details</strong> that we exported earlier from the creation of the service principal:</p>
<ul>
<li>Subscription ID</li>
<li>Subscription Name</li>
<li>Service Principal ID <em>(the appId)</em></li>
<li>Service principal key <em>(password)</em></li>
<li>Tenant ID</li>
</ul>
</li>
<li>
<p>Click <strong>Verify</strong> to verify that Azure DevOps can connect to Azure; you should hopefully see a Verification succeeded.</p>
</li>
<li>
<p>Give the <strong>Service</strong> connection a <strong>name</strong> <em>(this is the display name that is visual in Azure DevOps)</em></p>
</li>
<li>
<p><strong>Add</strong> a <strong>description</strong> <em>(i.e. created by, created on, created for)</em></p>
</li>
<li>
<p>Click on <strong>Verify and save</strong></p>
</li>
<li>
<p>You now have a new Service connection!</p>
</li>
<li>
<p><img decoding="async" loading="lazy" alt="Azure DevOps - Service Connection" src="/assets/images/new_azure_serviceconnectioncreated-6e213b4808f26d6ffbb00974f46582d3.png" title="Azure DevOps - Service Connection" width="1184" height="353" class="img_ev3q"></p>
</li>
</ol>
</li>
</ol>
<p><em>Note: The password for the service principal is valid for one year, so when they expire, you can come into the Azure DevOps service connection and update it here.</em></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="add-azure-bicep-to-repository">Add Azure Bicep to Repository<a href="#add-azure-bicep-to-repository" class="hash-link" aria-label="Direct link to Add Azure Bicep to Repository" title="Direct link to Add Azure Bicep to Repository">​</a></h4>
<p>Now that Azure DevOps has the delegated rights to create resources in Microsoft Azure, we need to add the Azure Bicep for Azure DNS Zone.</p>
<p>I have created the below Azure Bicep file named: Deploy-PublicDNS.bicep</p>
<p><strong>Don&#x27;t edit the file yet. You can add your DNS records later - after we add some variables into the Azure Pipeline.</strong></p>
<p>This file will:</p>
<ul>
<li>Create a new public Azure DNS zone, if it doesn&#x27;t exist</li>
<li>Add/Remove and modify any records</li>
</ul>
<p>I have added CNAME, A Record and TXT Records as a base.</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">Deploy-PublicDNS.bicep</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">///Variables - Edit, these variables can be set in the script or implemented as part of Azure DevOps variables.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">//Set the Domain Name Zone:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> PrimaryDNSZone </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">//Deploys to the location of your resource group, that is specified during the deployment.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="token plain"> location </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Global&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">//Variable array for your A records. Add, remove and amend as needed, any new record needs to be included in {}.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="token plain"> arecords </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;@&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">ipv4Address</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;8.8.8.8&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;webmail&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">ipv4Address</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;8.8.8.8&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">//Variable array for your CNAME records. Add, remove and amend as needed, any new record needs to be included in {}.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="token plain"> cnamerecords </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;blog&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">value</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;luke.geek.nz&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// </span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="token plain"> txtrecords </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;@&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">value</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;v=spf1 include:spf.protection.outlook.com -all&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">///Deploys your infrastructure below.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">//Deploys your DNS Zone.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> DNSZone </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Microsoft.Network/dnsZones@2018-05-01&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">toLower</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">PrimaryDNSZone</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">location</span><span class="token operator">:</span><span class="token plain"> location</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">zoneType</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Public&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">//Deploys your A records that are listed in the arecord variable table above.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> DNSARecords </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Microsoft.Network/dnsZones/A@2018-05-01&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> arecord </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">in</span><span class="token plain"> arecords</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">toLower</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">arecord</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">parent</span><span class="token operator">:</span><span class="token plain"> DNSZone</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">TTL</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">3600</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">ARecords</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">ipv4Address</span><span class="token operator">:</span><span class="token plain"> arecord</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ipv4Address</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">targetResource</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">//Deploys your CNAME records that are listed in the cnamerecord variable table above.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> CNAMErecords </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Microsoft.Network/dnsZones/CNAME@2018-05-01&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> cnamerecord </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">in</span><span class="token plain"> cnamerecords</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">toLower</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">cnamerecord</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">parent</span><span class="token operator">:</span><span class="token plain"> DNSZone</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">&#x27;TTL&#x27;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">3600</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">CNAMERecord</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">cname</span><span class="token operator">:</span><span class="token plain"> cnamerecord</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">value</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">targetResource</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> TXTrecords </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Microsoft.Network/dnsZones/TXT@2018-05-01&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> txtrecord </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">in</span><span class="token plain"> txtrecords</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">toLower</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">txtrecord</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token property">parent</span><span class="token operator">:</span><span class="token plain"> DNSZone</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   </span><span class="token property">&#x27;TTL&#x27;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">3600</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   </span><span class="token property">TXTRecords</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> </span><span class="token property">value</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        txtrecord</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">value               </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">output</span><span class="token plain"> cnamerecords </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> CNAMErecords</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">properties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">CNAMERecord</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">cname</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">output</span><span class="token plain"> arecords </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> arecords</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ipv4Address</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>To add the Azure Bicep file into Azure DevOps, you can commit it into the git repository; see a previous post on &#x27;<a href="https://luke.geek.nz/windows/git-using-github-desktop-on-windows-for-sysadmins/" target="_blank" rel="noopener noreferrer" title="Git using Github Desktop on Windows for SysAdmins ">Git using Github Desktop on Windows for SysAdmins</a>&#x27; to help get started. However, at this stage, I will create it manually in the portal.</p>
<ol>
<li><a href="https://go.microsoft.com/fwlink/?LinkId=2014676&amp;githubsi=true&amp;clcid=0x409&amp;WebUserId=e3e298aac5104b0e8e949b3b5bbeb314" target="_blank" rel="noopener noreferrer"><strong>Sign in to Azure DevOps</strong></a></li>
<li>Navigate to the DNS As Code <strong>project</strong> you created earlier</li>
<li>Click on <strong>Repos</strong></li>
<li>Click on <strong>Files</strong></li>
<li>Click on the <strong>Ellipsis</strong> on the right-hand side</li>
<li>Click <strong>New</strong></li>
<li>Click <strong>File</strong></li>
<li><img decoding="async" loading="lazy" alt="Azure DevOps - New File" src="/assets/images/azuredevops-createfile-80e661ef18f63ca331b69fa5f3398dbd.png" title="Azure DevOps - New File" width="536" height="229" class="img_ev3q"></li>
<li>Type in the name of your file <em>(including the bicep extension)</em>, i.e. <strong>Deploy-PublicDNS.bicep</strong></li>
<li>Click <strong>Create</strong></li>
<li><strong>Copy</strong> the <strong>contents</strong> of the Azure <strong>Bicep</strong> file supplied above and <strong>paste</strong> them into the Contents of <strong>Deploy-PublicDNS.bicep in Azure DevOps</strong></li>
<li><img decoding="async" loading="lazy" alt="Azure DevOps - Azure Bicep" src="/assets/images/azuredevops-deploypublicdnsinitialcommit-4ed7c138c81001307db524cda198ed5c.png" title="Azure DevOps - Azure Bicep" width="1170" height="541" class="img_ev3q"></li>
<li>Click <strong>Commit</strong></li>
<li>Click <strong>Commit</strong> again</li>
<li>While we are here, let&#x27;s <strong>delete</strong> the <strong>README.md</strong> file (as it will cause issues with the pipeline later on), click on the README.md file.</li>
<li>Click on the Ellipsis on the right-hand side</li>
<li>Click <strong>Delete</strong></li>
<li>Click <strong>Commit</strong></li>
<li>You should now only have your: Deploy-PublicDNS.bicep in the repository.</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-azure-devops-pipeline">Create Azure DevOps Pipeline<a href="#create-azure-devops-pipeline" class="hash-link" aria-label="Direct link to Create Azure DevOps Pipeline" title="Direct link to Create Azure DevOps Pipeline">​</a></h4>
<p>Now that we have the initial Azure Bicep file, it&#x27;s time to create our pipeline that will do the heavy lifting. I have created the base pipeline that you can download, and we will import it into Azure DevOps.</p>
<div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">azure-pipelines.yml</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Variable &#x27;location&#x27; was defined in the Variables tab</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Variable &#x27;PrimaryDNSZone&#x27; was defined in the Variables tab</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Variable &#x27;ResourceGroupName&#x27; was defined in the Variables tab</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Variable &#x27;SPN&#x27; is defined in the Variables tab</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">trigger</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">branches</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">include</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> refs/heads/main</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">jobs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">job</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Job_1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Agent job 1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">pool</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">vmImage</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">checkout</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> self</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> AzureCLI@2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Azure CLI &#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">connectedServiceNameARM</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> $(SPN)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">scriptType</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> pscore</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">scriptLocation</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> inlineScript</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">         az group create </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">name $(ResourceGroupName) </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">location $(location)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        az deployment group create  `</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">template</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">file $(Build.SourcesDirectory)\Deploy</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">PublicDNS.bicep `</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">resource</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">group $(ResourceGroupName) `</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">parameters PrimaryDNSZone=$(PrimaryDNSZone)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">powerShellErrorActionPreference</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> continue</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This pipeline will run through the following steps:</p>
<ul>
<li>Spin up an Azure-hosted agent running Ubuntu <em>(it already has the Azure CLI and PowerShell setup)</em></li>
<li>Create the Azure resource group to place your DNS zone into <em>(if it doesn&#x27;t already exist)</em></li>
<li>Finally, do the actual Azure Bicep deployment and create your Primary DNS zone resource, and, if necessary, modify any resources.</li>
</ul>
<p>Copy the contents of the YAML pipeline above, and let&#x27;s import it to Azure DevOps.</p>
<ol>
<li><a href="https://go.microsoft.com/fwlink/?LinkId=2014676&amp;githubsi=true&amp;clcid=0x409&amp;WebUserId=e3e298aac5104b0e8e949b3b5bbeb314" target="_blank" rel="noopener noreferrer"><strong>Sign in to Azure DevOps</strong></a></li>
<li>Navigate to the DNS As Code <strong>project</strong> you created earlier</li>
<li>Click on <strong>Pipelines</strong></li>
<li>Click on the <strong>Create Pipeline</strong></li>
<li>Select <strong>Azure Repos Git (YAML)</strong></li>
<li><strong>Select</strong> your DNSAsCode <strong>repository</strong></li>
<li>Select <strong>Starter pipeline</strong></li>
<li><strong>Overwrite</strong> the contents of the starter <strong>pipeline</strong> with the YAML file supplied</li>
<li><img decoding="async" loading="lazy" alt="Azure DevOps - YAML" src="/assets/images/azuredevops-newpipeline-95f1b6881da1b77d479989262306a464.png" title="Azure DevOps - YAML" width="1450" height="832" class="img_ev3q"></li>
<li>Click on the arrow next to Save and Run and select <strong>Save</strong></li>
<li>Select <strong>Commit directly to the main branch</strong></li>
<li>Click <strong>Save</strong></li>
<li>You may get an error about the trigger. You can ignore it - we will need to set the variables and trigger now.</li>
<li>Click on <strong>Pipelines</strong>, select your newly created pipeline</li>
<li>Select <strong>Edit</strong></li>
<li>Click <strong>Variables</strong></li>
<li>Click on <strong>New Variable</strong></li>
<li>We need to <strong>add</strong> four <strong>variables</strong>. To make the deployment more environment-specific, add the following variables into Azure DevOps <em>(these variables will be accessible by this pipeline only).</em></li>
</ol>

























<table><thead><tr><th>Variable</th><th>Note</th></tr></thead><tbody><tr><td>location</td><td>Location where you want to deploy the Resource into – i.e. ‘Australia East’</td></tr><tr><td>PrimaryDNSZone</td><td>The name of your domain you want the public zone to be, i.e. badasscloud.com</td></tr><tr><td>ResourceGroupName</td><td>The name of the Resource Group that the DNS Zone resource will be deployed into, i.e. DNS-PRD-RG</td></tr><tr><td>SPN</td><td>The name of the Service Connection, that we created earlier to connect Azure DevOps to Azure, i.e., SPN.AzureDNSCode</td></tr></tbody></table>
<ol>
<li>
<p><img decoding="async" loading="lazy" alt="Azure DevOps Variables" src="data:image/png;base64,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" title="Azure DevOps Variables" width="467" height="352" class="img_ev3q"></p>
</li>
<li>
<p>Click <strong>Save</strong></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="test--final-approval-of-azure-devops-pipeline">Test &amp; final approval of Azure DevOps Pipeline<a href="#test--final-approval-of-azure-devops-pipeline" class="hash-link" aria-label="Direct link to Test &amp; final approval of Azure DevOps Pipeline" title="Direct link to Test &amp; final approval of Azure DevOps Pipeline">​</a></h4>
<p>Now that the Azure Pipeline has been created and variables set, it&#x27;s time to test, warning <strong>this will run an actual deployment to your Azure subscription</strong>!</p>
<p>We will deploy a once-off to grant the pipeline access to the service principal created earlier and verify that it works.</p>
</li>
<li>
<p><a href="https://go.microsoft.com/fwlink/?LinkId=2014676&amp;githubsi=true&amp;clcid=0x409&amp;WebUserId=e3e298aac5104b0e8e949b3b5bbeb314" target="_blank" rel="noopener noreferrer"><strong>Sign in to Azure DevOps</strong></a></p>
</li>
<li>
<p>Navigate to the DNS As Code <strong>project</strong> you created earlier</p>
</li>
<li>
<p>Click on <strong>Pipelines</strong></p>
</li>
<li>
<p>Click on your <strong>Pipeline</strong></p>
</li>
<li>
<p>Select <strong>Run pipeline</strong></p>
</li>
<li>
<p>Click <strong>Run</strong></p>
</li>
<li>
<p><strong>Click</strong> on A<strong>gent job 1</strong></p>
</li>
<li>
<p>You will see a message: <strong>This pipeline needs permission to access a resource before this run can continue</strong></p>
</li>
<li>
<p>Click <strong>View</strong></p>
</li>
<li>
<p><img decoding="async" loading="lazy" alt="Azure DevOps - badasscloud.com DNS deployment" src="/assets/images/azuredevops-spn-approval-0fcf8a42adc8b7fd660fa7450a75810e.png" title="Azure DevOps - badasscloud.com DNS deployment" width="1163" height="268" class="img_ev3q"></p>
</li>
<li>
<p>Click <strong>Permit</strong></p>
</li>
<li>
<p>Click <strong>Permit</strong> again, to authorise your SPN access to your pipeline for all future runs</p>
</li>
<li>
<p>Your <strong>pipeline</strong> will be added to the <strong>queue</strong> and once an agent becomes available will start to <strong>run</strong>.</p>
</li>
</ol>
<p>As seen below, there were no resources before my deployment and the Azure Pipeline agent kicked off and created the resources in the Azure portal.</p>
<p><em>Note: You can expand the Agent Job to see the steps of the job, I hid it as it revealed subscription ID information etc during the deployment.</em></p>
<p><img decoding="async" loading="lazy" alt="Azure DevOps - badasscloud.com DNS deployment" src="/assets/images/azure-devopsdeployment-azurebicep-0f0cec1c6184280292a7b7da08818505.gif" title="Azure DevOps - badasscloud.com DNS deployment" width="1443" height="865" class="img_ev3q"></p>
<p>Remember to update your nameserver records for your domain to point towards the nameserver entries in the Azure DNS zone resource, to use Azure DNS!</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="edit-the-bicep-file">Edit the Bicep file<a href="#edit-the-bicep-file" class="hash-link" aria-label="Direct link to Edit the Bicep file" title="Direct link to Edit the Bicep file">​</a></h4>
<p>Now that you have successfully deployed your Azure Bicep file, you can go into the Azure Bicep and update the A, CNAME records to match your own environment - any new change to this repository will automatically trigger Continous Integration and deployment, you can override this behaviour by editing the Pipeline, clicking Edit Trigger and unselect &#x27;Enable; continuous integration</p>
<p>Each variable <em>(var object) (cnames, arecords)</em> is enclosed in brackets, this array allows you to add multiple records, for example, if I wanted to add another name record, it would look like this:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">//Variable array for your CNAME records. Add, remove and amend as needed, any new record needs to be included in {}.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">var cnamerecords = [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> name: &#x27;blog&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> value: &#x27;luke.geek.nz&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> name: &#x27;fancierblog&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> value: &#x27;azure.com&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Simply add another object under the first, as long as it is included in the brackets, then upon deployment Azure Bicep will parse the variable array and for each record, create/modify the DNS records, you only ever need to edit the content in the variable without touching the actual resource deployment.</p>
<p>As records are added and removed over time, you will develop a commit history and with the power of Azure DevOps, can implement scheduling changes at certain times and approval!</p>
<p>Hopefully, this article helps you achieve Infrastructure as Code for your Azure DNS resource, the same concept can be applied for other resources using Azure Bicep as well.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/azure/">Azure</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/azure/controlled-chaos-in-azure-using-chaos-studio/">Controlled Chaos in Azure using Chaos Studio</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-01-06T00:00:00.000Z">January 6, 2022</time> · <!-- -->13 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://luke.geek.nz/img/logo.png" alt="Luke Murray"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">Luke Murray</span></a></div><small class="authorTitle_nd0D" title="Author">Author</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><p>Chaos engineering has been around for a while; Netflix runs their own famous <a href="https://netflix.github.io/chaosmonkey/" target="_blank" rel="noopener noreferrer">Chaos Monkey</a>, supposedly running 24/7, taking down their resources and pushing them to the limit continuously; it almost sounds counter-intuitive – but it&#x27;s not.</p>
<blockquote>
<p>Chaos engineering is defined as “the discipline of experimenting on a system in order to build confidence in the system’s capability to withstand turbulent conditions in production” (Principles of Chaos Engineering, <a href="http://principlesofchaos.org/" target="_blank" rel="noopener noreferrer" title="http://principlesofchaos.org/">http://principlesofchaos.org/</a>). In other words, it’s a software testing method focusing on finding evidence of problems before they are experienced by users.</p>
<p>Chaos engineering is a methodology that helps developers attain consistent reliability by hardening services against failures in production. Another way to think about chaos engineering is that it&#x27;s about embracing the inherent chaos in complex systems and, through experimentation, growing confidence in your solution&#x27;s ability to handle it.</p>
<p>A common way to introduce chaos is to deliberately inject faults that cause system components to fail. The goal is to observe, monitor, respond to, and improve your system&#x27;s reliability under adverse circumstances. For example, taking dependencies offline (stopping API apps, shutting down VMs, etc.), restricting access (enabling firewall rules, changing connection strings, etc.), or forcing failover (database level, Front Door, etc.), is a good way to validate that the application is able to handle faults gracefully.</p>
</blockquote>
<p>Introducing controlled Chaos tools such as Chaos Monkey and now – <a href="https://azure.microsoft.com/en-us/services/chaos-studio/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Chaos Studio</a> allows you to put pressure and, in some cases, take down your services to teach you how your services will react under strain and identity areas of improvement as resiliency and scalability to improve your systems.</p>
<p><img decoding="async" loading="lazy" alt="Chaos" src="/assets/images/chaosengineering-banner-0929ef3aa12bf5e4832160ff75a00b4b.png" title="Chaos" width="2400" height="700" class="img_ev3q"></p>
<p>Azure Chaos Studio <em>(currently in Preview and only supported in several</em> <a href="https://azure.microsoft.com/en-us/global-infrastructure/services/?products=chaos-studio&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer"><em>regions</em></a><em>now)</em> is an enabler for &#x27;controlled Chaos&#x27; in the Microsoft Azure ecosystem. Using that same tool that Microsoft uses to test and improve their services – you can as well!</p>
<p>Chaos Studio works by creating Experiments <em>(i.e., Faults/Capabilities)</em> that run against Targets <em>(your resources, whether they are agent or service-based)</em>.</p>
<p>There are two types of methods you can use to target your resources:</p>
<ul>
<li>Service-direct</li>
<li>Agent-based</li>
</ul>
<p>Service-direct is tied into the Azure fabric and puts pressure on your resources from outside them <em>(i.e., supported on most resources that don&#x27;t need agent-based, PaaS resources, such as Network Security Groups).</em> For example, a service-direct capability may be to add or remove a security rule from your network security group for faulty findings.</p>
<p>Agent-based relies on an agent installed; these are targeted at resources such as Virtual Machine and Virtual Machine scale sets; agent-based targets use a user-assigned managed identity to manage an agent on your virtual machines and wreak havoc by running capabilities such as stopping services and putting memory and disk pressure on your workloads.</p>
<p>Just a word of warning, before you proceed to allow Chaos to reign in your environment, make sure it is done out of hours or, better yet – against development or test resources, also make sure that any resources that support autoscaling are disabled – or you might suddenly find ten more instances of that resource you were running <em>(unless of course you&#x27;re testing that autoscaling is working)</em>! 😊</p>
<p>In my test setup, I have the following already pre-created that I will be running my experiments against:</p>
<ul>
<li>Virtual Machine Scale set <em>(running Windows with two instances)</em></li>
<li>Single Virtual Machine <em>(running Windows)</em> to test shutdown against</li>
</ul>
<p>The currently supported resource types of Azure Chaos Studio can be found &#x27;<a href="https://learn.microsoft.com/en-us/azure/chaos-studio/chaos-studio-fault-providers?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">here</a>&#x27;.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="setup-azure-chaos-studio">Setup Azure Chaos Studio<a href="#setup-azure-chaos-studio" class="hash-link" aria-label="Direct link to Setup Azure Chaos Studio" title="Direct link to Setup Azure Chaos Studio">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-managed-identity">Create Managed Identity<a href="#create-managed-identity" class="hash-link" aria-label="Direct link to Create Managed Identity" title="Direct link to Create Managed Identity">​</a></h4>
<p>Because we will use Agent-based capabilities to generate our Faults, I needed to create a Managed Identity to give Chaos Studio the ability to wreak havoc on my resources!</p>
<ol>
<li>In the <strong>Azure Portal,</strong> search for <a href="https://portal.azure.com/#blade/HubsExtension/BrowseResource/resourceType/Microsoft.ManagedIdentity%2FuserAssignedIdentities" target="_blank" rel="noopener noreferrer"><strong>Managed Identities</strong></a></li>
<li>Click on <strong>Create</strong></li>
<li><strong>Select</strong> the <strong>subscrSubscription</strong>ng the resources that you want to test against</li>
<li><strong>Select</strong> your <strong>Resource Group</strong> to place the managed identity in (<em>I suggest creating a new Resource Group, as your Chaos experiments may have a different lifecycle than your resources, but it&#x27;s just a preference, I will be placing mine in the Chaos Studio resource group so I can quickly delete it later)</em>.</li>
<li><strong>Select</strong> the <strong>RegionRegion</strong>ur resources</li>
<li>Type in a <strong>name</strong> (<em>this will be the identity that you will see in logs running these experiments, so make sure its something you can identify with)</em></li>
<li><img decoding="async" loading="lazy" alt="Azure Portal - Create User Management Identity" src="/assets/images/azure_userassignedmanageidentity-8f2cdc8b86ee1f35091c9270a3061f5a.png" title="Azure Portal - Create User Management Identity" width="602" height="347" class="img_ev3q"></li>
<li>Click <strong>Next: Tags</strong></li>
<li>Make sure you enter appropriate tags to make sure that the resource can be identified and tracked, and click <strong>Review + Create</strong></li>
<li><img decoding="async" loading="lazy" alt="Azure Portal Tags" src="/assets/images/azuretags_chaos-3882e50f463cdfc7bb84fb50a0845993.png" title="Azure Portal Tags" width="602" height="238" class="img_ev3q"></li>
<li>Verify that everything looks good and click <strong>Create</strong> to create your User Assigned Managed identity.</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-application-insights">Create Application Insights<a href="#create-application-insights" class="hash-link" aria-label="Direct link to Create Application Insights" title="Direct link to Create Application Insights">​</a></h4>
<p>Now, it&#x27;s time to create an Application Insights resource. Applications Insights is for the logs of the experiments to go into, so you can see the faults and their behaviours.</p>
<ol>
<li>In the <strong>Azure Portal</strong>, search for <a href="https://portal.azure.com/#blade/HubsExtension/BrowseResource/resourceType/microsoft.insights%2Fcomponents" target="_blank" rel="noopener noreferrer"><strong>Application Insights</strong></a></li>
<li>Click on <strong>Create</strong></li>
<li><strong>Select</strong> the <strong>Subscription</strong> the resources that you want to test against</li>
<li><strong>Select</strong> your <strong>Resource Group</strong> to place the Application Insights resource into (<em>I suggest creating a new Resource Group, as your Chaos experiments may have a different lifecycle than your resources, but it&#x27;s just a preference, I will be placing mine in the Chaos Studio resource group so I can easily delete it later)</em>.</li>
<li><strong>Select</strong> the <strong>Region</strong> the resources are in</li>
<li>Type in a <strong>name</strong></li>
<li><strong>Select</strong> your <strong>Log Analytics workspace</strong> you want to link Application Insights to <em>(if you don&#x27;t have a Log Analytics workspace, you can create one &#x27;</em><a href="https://portal.azure.com/#blade/HubsExtension/BrowseResource/resourceType/Microsoft.OperationalInsights%2Fworkspaces" target="_blank" rel="noopener noreferrer"><em>here</em></a><em>&#x27;)</em>.</li>
<li><img decoding="async" loading="lazy" alt="Azure Portal - Application Insights" src="/assets/images/azure_applicationinsights-c4676bae524a9a2cafbeaa8ed778cc01.png" title="Azure Portal - Application Insightsv" width="602" height="520" class="img_ev3q"></li>
<li>Click <strong>Tags</strong></li>
<li>Make sure you <strong>enter appropriate tags</strong> to make sure that the resource can be identified and tracked, and click <strong>Review + Create</strong></li>
<li>Verify that everything looks good and click <strong>Create</strong> to create your Application Insights.</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="setup-chaos-studio-targets">Setup Chaos Studio Targets<a href="#setup-chaos-studio-targets" class="hash-link" aria-label="Direct link to Setup Chaos Studio Targets" title="Direct link to Setup Chaos Studio Targets">​</a></h4>
<p>It is now time to add the resources targets to Chaos Studio</p>
<ol>
<li>In the <strong>Azure Portal</strong>, search for <a href="https://portal.azure.com/#blade/Microsoft_Azure_Chaos/ChaosStudioMenuBlade/overview" target="_blank" rel="noopener noreferrer"><strong>Chaos Studio</strong></a></li>
<li>On the left band side Blade, select <strong>Targets</strong></li>
<li><img decoding="async" loading="lazy" alt="Azure Chaos Studio" src="/assets/images/azure_chaosstudio_targets-989d1638d9ab55b2a648197eb570d72f.png" title="Azure Chaos Studio" width="602" height="125" class="img_ev3q"></li>
<li>As you can see, I have a Virtual Machine Scale Set and a front-end Network Security Group.</li>
<li><strong>Select</strong> the <strong>checkbox</strong> next to Name to <strong>select all</strong> the Resources</li>
<li>Select <strong>Enable Targets</strong></li>
<li><img decoding="async" loading="lazy" alt="Azure Chaos Studio" src="/assets/images/azure_chaosstudio_targets2-52ce0a064e8a54465447a2997047630b.png" title="Azure Chaos Studio" width="602" height="106" class="img_ev3q"></li>
<li>Select <strong>Enable service-direct targets (All resources)</strong></li>
<li>Enabling the service-direct targets will then add the capabilities supported by Service-direct targets into Chaos Studio for you to use.</li>
<li>Once completed, I will <strong>select</strong> the scale set and click <strong>Enable Target</strong></li>
<li>Then finally, <strong>Enable agent-based targets (VM, VMSS)</strong></li>
<li>This is where you link the user-managed identity, and Application Insights created earlier</li>
<li><strong>Select</strong> your <strong>Subscription</strong></li>
<li>Select your <strong>managed identity</strong></li>
<li>Select Enabled for Application Insights and select your Application Insights account. The instrumentation key should be selected manually.</li>
<li><img decoding="async" loading="lazy" alt="Azure Chaos Studio - Enable targets" src="/assets/images/azure_chaosstudio_enableagenttargets-620b1ddfd69c44193fff354eaca7ceb8.png" title="Azure Chaos Studio - Enable targets" width="602" height="584" class="img_ev3q"></li>
<li><em>If your instrumentation key isn&#x27;t filled in, you can find it on the Overview pane of the Application Insights resource.</em></li>
<li>Click <strong>Review + Enable</strong></li>
<li><strong>Review</strong> the <strong>resources</strong> you want to enable Chaos Studio to target and select <strong>Enable</strong></li>
<li>Finally, you should now be back at the Targets pane make sure you select Manage actions and make sure that all actions are ticked and click <strong>Save</strong></li>
<li><img decoding="async" loading="lazy" alt="Azure Chaos Studio Capabilities" src="/assets/images/azurechaosactions-1af7db09581d9982ae10818aa1075db4.png" title="Azure Chaos Studio Capabilities" width="829" height="679" class="img_ev3q"></li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="configure-and-run-azure-chaos-studio">Configure and run Azure Chaos Studio<a href="#configure-and-run-azure-chaos-studio" class="hash-link" aria-label="Direct link to Configure and run Azure Chaos Studio" title="Direct link to Configure and run Azure Chaos Studio">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="action-exclusions">Action exclusions<a href="#action-exclusions" class="hash-link" aria-label="Direct link to Action exclusions" title="Direct link to Action exclusions">​</a></h4>
<p>There may be actions that you don&#x27;t want to be run against specific resources; an example might be you don&#x27;t want anyone to kill any processes on a Virtual Machine.</p>
<ol>
<li>In the Target pane of Chaos Studio, select <strong>Actions</strong> next to the resource</li>
<li><strong>Unselect</strong> the <strong>capability</strong> you don&#x27;t want to run on that resource</li>
<li>Select <strong>Save</strong></li>
<li><img decoding="async" loading="lazy" alt="Azure Chaos Studio Actions" src="/assets/images/azure_chaosstudio_manageactions-5786b1de8eca578ccac4c06c5e680398.png" title="Azure Chaos Studio - Enable targets" width="602" height="641" class="img_ev3q"></li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="configure-experiments">Configure Experiments<a href="#configure-experiments" class="hash-link" aria-label="Direct link to Configure Experiments" title="Direct link to Configure Experiments">​</a></h4>
<p>An experiment is a collection of capabilities to create faults, put pressure on your resources, and cause Chaos that will run against your target resources. These experiments are saved so you can run them multiple times and edit them later, although currently, you cannot reassign the same experiments to other resources.</p>
<p>Note: If you name an Experiment the same as another experiment, it will replace the older Experiment with your new one and retain the previous history.</p>
<ol>
<li>In the <strong>Azure Portal,</strong> search for <a href="https://portal.azure.com/#blade/Microsoft_Azure_Chaos/ChaosStudioMenuBlade/overview" target="_blank" rel="noopener noreferrer"><strong>Chaos Studio</strong></a>.</li>
<li>On the left band side Blade, select <strong>Experiments</strong></li>
<li>Click <strong>+ Create</strong></li>
<li><strong>Select</strong> your <strong>Subscription</strong></li>
<li><strong>Select</strong> your <strong>Resource Group</strong> to save the Experiment into</li>
<li><strong>Type</strong> in a <strong>name</strong> for your <strong>Experiment</strong> that makes sense; in this case, we will put some Memory pressure on the VM scale set.</li>
<li><strong>Select</strong> your <strong>Region</strong></li>
<li>Click <strong>Next: Experiment Designer</strong></li>
<li><strong>Using</strong> Experiment <strong>Designer</strong>, you can <strong>design</strong> your <strong>Faults</strong>; you can have multiple capabilities hit a resource with expected delays, <em>i.e., you can have Memory pressure on a VM for 10 minutes, then CPU pressure, then shutdown.</em></li>
<li>We are going to select <strong>Add Action</strong></li>
<li>Then <strong>Add Fault</strong></li>
<li>I am going to select <strong>Physical Memory</strong> pressure</li>
<li>Leave the duration to <strong>10 minutes</strong></li>
<li>Because this will go against my VM scale set, I will add in the instances I want to target <em>(if you aren&#x27;t targeting a VM Scale set, you can leave this blank, you can find the instance ID by going to your VM Scale set click on Instances, click on the VM instance you want to target and you should see the Instance ID in the Overview pane)</em></li>
<li><img decoding="async" loading="lazy" alt="Azure Chaos Studio - Add fault" src="/assets/images/azure_chaosstudio_createexperimentaddfault-f6ff8fd1cfc8dab21fb1bcb99813e20d.png" title="Azure Chaos Studio - Add fault" width="602" height="441" class="img_ev3q"></li>
<li>Select <strong>Next: Target resources</strong></li>
<li><strong>Select</strong> your <strong>resources</strong> <em>(you will notice as this is an Agent-based capability, only agent supported resources are listed)</em></li>
<li>Select <strong>Add</strong></li>
<li>I am then going to <strong>Add delay for 5 Minutes</strong></li>
<li>Then add an <strong>abrupt VM shutdown</strong> for 10 minutes <em>(Chaos Studio will automatically restart the VM after the 10-minute duration)</em>.</li>
<li><img decoding="async" loading="lazy" alt="Azure Chaos Studio create experiment" src="/assets/images/azure_chaosstudio_createexperimentaddfault2-ab12282d4c3801eb941de223ee7bc627.png" title="Azure Chaos Studio create experiment" width="602" height="266" class="img_ev3q"></li>
<li>As you can see with the Branches <em>(items that will run in parallel)</em> and actions, you can have multiple faults running at once in parallel by using branches or one after the other sequentially.</li>
<li>Now that we are ready with our faulty, we are going to click <strong>Review + Create</strong></li>
<li>Click <strong>Create</strong></li>
</ol>
<p><em>Note: I had an API error; after some investigation, I found it was having problems with the &#x27;?&#x27; in my experiment name, so I removed it and continued to create the Experiment.</em></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="assign-permissions-for-the-experiments">Assign permissions for the Experiments<a href="#assign-permissions-for-the-experiments" class="hash-link" aria-label="Direct link to Assign permissions for the Experiments" title="Direct link to Assign permissions for the Experiments">​</a></h4>
<p>Now that the Experiment has been created, we need to give rights to the Managed User account created earlier <em>(and/or the System managed identity that was created when the Experiment was created for service-direct experiments)</em>.</p>
<p>I will assign permissions to the Resource Group that the VM Scale set exists in, but you might be better off applying the rights to the individual resource for more granular control. You can see suggested roles to give resources: <a href="https://learn.microsoft.com/en-us/azure/chaos-studio/chaos-studio-fault-providers?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Supported resource types and role assignments for the Chaos Studio</a> Microsoft page.</p>
<ol>
<li>In the <strong>Azure Portal</strong>, click on the <strong>Resource Group</strong> containing the resources you want to run the Experiment against</li>
<li>Select <strong>Access control (IAM)</strong></li>
<li>Click <strong>+ Add</strong></li>
<li>Click <strong>Add Role Assignment</strong></li>
<li>Click <strong>Reader</strong></li>
<li>Click <strong>Next</strong></li>
<li>Select <strong>Assign access to Managed identity</strong></li>
<li>Click on <strong>+ Select Members</strong></li>
<li><strong>Select</strong> the <strong>User</strong> assigned <strong>management identity</strong></li>
<li>Click <strong>Review</strong> and <strong>assign</strong>.</li>
<li>Because the shutdown is a service-direct, <strong>go back and give the experiment system managed identity Virtual Machine Contributor rights</strong>, so it has access to shutdown the VM.</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="run-experiments">Run Experiments<a href="#run-experiments" class="hash-link" aria-label="Direct link to Run Experiments" title="Direct link to Run Experiments">​</a></h4>
<p>Now that the Experiment has been created, it should appear as a resource in the resource group you selected earlier; if you open it, you can see the Experiment&#x27;s History, Start, and Edit buttons.</p>
<ol>
<li>Click <strong>Start</strong></li>
<li><img decoding="async" loading="lazy" alt="Azure Chaos studio - Run experiment" src="/assets/images/azure_chaosstudio_whatmemory-09151c403439e67c1de46401589b3418.png" title="Azure Chaos studio - Run experiment" width="602" height="145" class="img_ev3q"></li>
<li>Click <strong>Ok</strong> to <strong>start</strong> the <strong>Experiment</strong> <em>(and place it into the queue)</em></li>
<li><strong>Click</strong> on <strong>Details</strong> to see the <strong>experiment progress</strong> <em>(and any errors)</em>, and if it fails one part, it may move to the next step depending on the fault.</li>
<li><img decoding="async" loading="lazy" alt="Azure Chaos studio - Run experiment" src="/assets/images/azure_chaosstudio_whatmemoryrun-1bac1d245af3399c523a6792dea66041.png" title="Azure Chaos studio - Run experiment" width="602" height="346" class="img_ev3q"></li>
<li><strong>Azure Chaos studio should now run rampant and do best – cause Chaos</strong>!</li>
</ol>
<p>This service is still currently in Preview. If you have any issues, take a look at the: <a href="https://learn.microsoft.com/en-us/azure/chaos-studio/troubleshooting" target="_blank" rel="noopener noreferrer">Troubleshoot issues with Azure Chaos Studio</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="monitor-and-auditing-of-azure-chaos-studio">Monitor and Auditing of Azure Chaos Studio<a href="#monitor-and-auditing-of-azure-chaos-studio" class="hash-link" aria-label="Direct link to Monitor and Auditing of Azure Chaos Studio" title="Direct link to Monitor and Auditing of Azure Chaos Studio">​</a></h3>
<p>Now that Azure Chaos Studio is in use by your organization, you may want to know what auditing is available, along with reporting to Application Insights.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="azure-activity-log">Azure Activity Log<a href="#azure-activity-log" class="hash-link" aria-label="Direct link to Azure Activity Log" title="Direct link to Azure Activity Log">​</a></h4>
<p>When an Azure Chaos Studio experiment has touched a resource, there will be an audit trail in the Azure activity log of that resource; here, you can see that &#x27;WhatMemory&#x27;, which is the Name of my Chaos Experiment, has successfully powered off and on my VM.</p>
<p><img decoding="async" loading="lazy" alt="Azure Activity Log - Azure Chaos Studio" src="/assets/images/azure_chaosstudio_activitylog-27476f7626f821f811db0174c941c034.png" title="Azure Activity Log - Azure Chaos Studio" width="602" height="56" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="azure-alerts">Azure Alerts<a href="#azure-alerts" class="hash-link" aria-label="Direct link to Azure Alerts" title="Direct link to Azure Alerts">​</a></h4>
<p>It is easy to set up alerts when a Chaos experiment kicks off; to create an Azure, do the following.</p>
<ol>
<li>In the <strong>Azure Portal</strong>, click on <strong>Azure Monito</strong>r</li>
<li>Click on <strong>Alerts</strong></li>
<li>Click <strong>+ Create</strong></li>
<li>Select <strong>Alert Rule</strong></li>
<li>Click <strong>Create resource</strong></li>
<li><strong>Filter</strong> your resource <strong>type</strong> to <strong>Chaos Experiments</strong></li>
<li><strong>Filter</strong> your <strong>alert</strong> to <strong>Subscription</strong> and click <strong>Done</strong></li>
<li>Click <strong>Add Condition</strong></li>
<li>Select: <strong>Starts a Chaos Experiment</strong></li>
<li>Make sure that: *<em>Event initiated by is set to (All services and users)</em></li>
<li>Click <strong>Done</strong></li>
<li>Click <strong>Add Action Group</strong></li>
<li>If you have one, <strong>assign</strong> an <strong>action group</strong> <em>(these are who and how the alerts will get to you)</em>. If you don&#x27;t have one, click: <strong>+ Create an action group</strong>.</li>
<li><strong>Specify</strong> a resource <strong>group</strong> to hold your action groups <em>(usually a monitor or management resource group)</em></li>
<li>Type the <strong>Action Group name</strong></li>
<li>Type the <strong>Action group Display name</strong></li>
<li>Click <strong>Next: Notifications</strong></li>
<li>Select <strong>Notification Type</strong></li>
<li>Select <strong>email</strong></li>
<li>Select <strong>Email</strong></li>
<li><strong>Type</strong> in your <strong>email</strong> address to be notified</li>
<li>Click <strong>ok</strong></li>
<li><strong>Type</strong> in the <strong>Name</strong> of the <strong>mail</strong> to be a reference in the future <em>(i.e. Help Desk)</em></li>
<li>Click <strong>Review + Create</strong></li>
<li>Click <strong>Create</strong> to create your Action group</li>
<li>Type in your <strong>rule name</strong> <em>(i.e. Alert – Chaos Experiment – Started)</em></li>
<li>Type in a <strong>description</strong></li>
<li><strong>Specify</strong> the <strong>resource group</strong> to place the alert in <em>(again, usually a monitor or management resource group)</em></li>
<li>Check <strong>Enable alert rule on creation</strong></li>
<li>Click <strong>Create alert rule</strong></li>
</ol>
<p><em>Note: Activity Log alerts are hidden types; they are not shown in the resource group by default, but if you check the: Show hidden types box, they will appear.</em></p>
<p><img decoding="async" loading="lazy" alt="Azure Activity Log - Azure Chaos Studio" src="/assets/images/azure_chaosstudio_alert-9d90704feb648ce05039987b32de9c97.png" title="Azure Activity Log - Azure Chaos Studio" width="602" height="48" class="img_ev3q"></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/azure/">Azure</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/tags/azure/page/24/"><div class="pagination-nav__label">Newer entries</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/tags/azure/page/26/"><div class="pagination-nav__label">Older entries</div></a></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 luke.geek.nz. Powered by coffee, clouds and hamsters on wheels!</div></div></div></footer></div>
</body>
</html>