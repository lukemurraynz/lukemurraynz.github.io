<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-tags-post-list-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">174 posts tagged with &quot;Azure&quot; | luke.geek.nz</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://luke.geek.nz/img/social-card.png"><meta data-rh="true" name="twitter:image" content="https://luke.geek.nz/img/social-card.png"><meta data-rh="true" property="og:url" content="https://luke.geek.nz/tags/azure/page/25/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" property="og:title" content="174 posts tagged with &quot;Azure&quot; | luke.geek.nz"><meta data-rh="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://luke.geek.nz/tags/azure/page/25/"><link data-rh="true" rel="alternate" href="https://luke.geek.nz/tags/azure/page/25/" hreflang="en"><link data-rh="true" rel="alternate" href="https://luke.geek.nz/tags/azure/page/25/" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://ZBH2T1WJQD-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="luke.geek.nz RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="luke.geek.nz Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="luke.geek.nz JSON Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0QDLBY7NNN"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-0QDLBY7NNN",{anonymize_ip:!0})</script><link rel="stylesheet" href="/assets/css/styles.a8967c60.css">
<script src="/assets/js/runtime~main.c7792525.js" defer="defer"></script>
<script src="/assets/js/main.e31f15e1.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"dark")}(),function(){try{const a=new URLSearchParams(window.location.search).entries();for(var[t,e]of a)if(t.startsWith("docusaurus-data-")){var n=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(n,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:#D3D3D3" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY">If you haven't already, make sure you sign up for my Weekly Azure updates Newsletter, straight to your inbox! <a target="_blank" rel="noopener noreferrer" href="https://newsletter.azurefeeds.com/join">Subscribe now!</a></div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="luke.geek.nz" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.png" alt="luke.geek.nz" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">luke.geek.nz</b></a><a class="navbar__item navbar__link" href="/Tags/">Tags</a><a class="navbar__item navbar__link" href="/Archive/">Blog</a><a class="navbar__item navbar__link" href="/about/">About</a></div><div class="navbar__items navbar__items--right"><a href="https://www.youtube.com/channel/UCUG3TKDTAZz4UXshGrjBBoQ" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-icon" aria-label="YouTube">
              <svg width="24" height="24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path d="M23.498,6.186c-0.273-1.186-1.143-2.144-2.332-2.417C18.389,3.153,12,3.153,12,3.153s-6.389,0-9.166,0.616
                  c-1.19,0.273-2.06,1.23-2.332,2.417C0,8.07,0,12,0,12s0,3.93,0.502,5.814c0.272,1.187,1.142,2.062,2.332,2.335
                  C5.611,20.847,12,20.847,12,20.847s6.389,0,9.166-0.698c1.189-0.273,2.059-1.148,2.332-2.335C24,15.93,24,12,24,12
                  S24,8.07,23.498,6.186z M9.545,15.568V8.432l6.545,3.568L9.545,15.568z"/>
              </svg>
            </a><a href="https://aus.social/@lukemurray" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-icon" aria-label="Mastodon">
              <svg height="20" width="20" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" xml:space="preserve">
                <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                <g id="SVGRepo_iconCarrier">
                  <path d="M21.327 8.566c0-4.339-2.843-5.61-2.843-5.61-1.433-.658-3.894-.935-6.451-.956h-.063c-2.557.021-5.016.298-6.45.956 0 0-2.843 1.272-2.843 5.61 0 .993-.019 2.181.012 3.441.103 4.243.778 8.425 4.701 9.463 1.809.479 3.362.579 4.612.510 2.268-.126 3.541-.809 3.541-.809l-.075-1.646s-1.621.511-3.441.449c-1.804-.062-3.707-.194-3.999-2.409a4.523 4.523 0 0 1-.04-.621s1.77.433 4.014.536c1.372.063 2.658-.08 3.965-.236 2.506-.299 4.688-1.843 4.962-3.254.434-2.223.398-5.424.398-5.424zm-3.353 5.59h-2.081V9.057c0-1.075-.452-1.62-1.357-1.62-1 0-1.501.647-1.501 1.927v2.791h-2.069V9.364c0-1.28-.501-1.927-1.502-1.927-.905 0-1.357.546-1.357 1.62v5.099H6.026V8.903c0-1.074.273-1.927.823-2.558.566-.631 1.307-.955 2.228-.955 1.065 0 1.872.409 2.405 1.228l.518.869.519-.869c.533-.819 1.34-1.228 2.405-1.228.92 0 1.662.324 2.228.955.549.631.822 1.484.822 2.558v5.253z"></path>
                </g>
              </svg>
            </a><a href="https://bsky.app/profile/lukemurraynz.bsky.social" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-icon" aria-label="Bluesky">
              <svg class="octicon" xmlns="http://www.w3.org/2000/svg" role="img" viewBox="0 0 16 16" height="20" width="20" fill="currentColor">
                <title>Bluesky</title>
                <path d="M8 7.2c-.72-1.4-2.7-4.04-4.53-5.33C1.7.63 1.04.84.6 1.04.1 1.27 0 2.05 0 2.51c0 .46.25 3.77.42 4.32.54 1.82 2.47 2.45 4.25 2.25-2.6.38-4.92 1.33-1.88 4.71 3.33 3.46 4.57-.74 5.21-2.87.64 2.13 1.37 6.18 5.16 2.87 2.84-2.87.78-4.33-1.83-4.71 1.78.2 3.71-.43 4.25-2.25.17-.55.42-3.86.42-4.32 0-.46-.09-1.24-.6-1.47-.44-.2-1.11-.42-2.87.83A17.87 17.87 0 0 0 8 7.2Z"></path>
              </svg>
            </a><a href="https://twitter.com/lukemurraynz" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-icon" aria-label="X"><svg height="20" width="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 8.586l4.293-4.293a1 1 0 011.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 011.414-1.414L10 8.586z" clip-rule="evenodd"/>
          </svg></a><a href="https://www.linkedin.com/in/ljmurray/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-icon" aria-label="LinkedIn"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" height="20" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854V1.146zm4.943 12.248V6.169H2.542v7.225h2.401zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248-.822 0-1.359.54-1.359 1.248 0 .694.521 1.248 1.327 1.248h.016zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274 0-1.845.7-2.165 1.193v.025h-.016a5.54 5.54 0 0 1 .016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225h2.4z"></path></svg></a><a href="https://luke.geek.nz/rss" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-rss-link" aria-label="RSS"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)" aria-live="polite" aria-pressed="true"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><div role="group"><h3 class="yearGroupHeading_rMGB">2025</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/misc/codespace-secrets/">GitHub Codespace Secrets</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure/acr-continuous-patching-security/">Azure Container Registry Continuous Patching for Security</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure/sftp-event-hub-function/">Processing SFTP Events with Azure Function and Event Hub</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure/mcp-acs-email-integration/">Sending Emails with MCP and Azure Communication Services</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure/business-critical-workloads/">Understanding Workload Criticality in the Cloud</a></li></ul></div></nav></aside><main class="col col--7"><header class="margin-bottom--xl"><h1>174 posts tagged with &quot;Azure&quot;</h1><a href="/tags/">View All Tags</a></header><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/2022/05/12/deallocate-stopped-virtual-machines-using-azure-automation/">Deallocate &#x27;Stopped&#x27; Virtual Machines using Azure Automation</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-05-12T00:00:00.000Z">May 12, 2022</time> · <!-- -->13 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://luke.geek.nz/img/logo.png" alt="Luke Murray"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">Luke Murray</span></a></div><small class="authorTitle_nd0D" title="Author">Author</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><p><a href="https://azure.microsoft.com/en-us/overview/what-is-a-virtual-machine/?WT.mc_id=AZ-MVP-5004796#overview" target="_blank" rel="noopener noreferrer" title=" What is a virtual machine (VM)?">Virtual Machines</a> in Microsoft Azure have different states and, depending on what state the Virtual Machine is in, will determine whether you get billed or not <em>(for the Compute, storage and network adapters are still billed)</em>.</p>








































<table><thead><tr><th>Power state</th><th>Description</th><th>Billing</th></tr></thead><tbody><tr><td>Starting</td><td>Virtual Machine is powering up.</td><td>Billed</td></tr><tr><td>Running</td><td>Virtual Machine is fully up. This is the standard working state.</td><td>Billed</td></tr><tr><td>Stopping</td><td>This is a transitional state between running and stopped.</td><td>Billed</td></tr><tr><td>Stopped</td><td>The Virtual Machine is allocated on a host but not running. Also called PoweredOff state or Stopped (Allocated). This can be result of invoking the PowerOff API operation or invoking shutdown from within the guest OS. The Stopped state may also be observed briefly during VM creation or while starting a VM from Deallocated state.</td><td>Billed</td></tr><tr><td>Deallocating</td><td>This is the transitional state between running and deallocated.</td><td>Not billed</td></tr><tr><td>Deallocated</td><td>The Virtual Machine has released the lease on the underlying hardware and is completely powered off. This state is also referred to as Stopped (Deallocated).</td><td>Not billed</td></tr></tbody></table>
<p>Suppose a Virtual Machine is not being used. In that case, turning off a Virtual Machine from the Microsoft Azure Portal <em>(or programmatically via</em> <a href="https://learn.microsoft.com/en-us/powershell/azure/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Azure PowerShell Documentation"><em>PowerShell</em></a><em>/</em><a href="https://learn.microsoft.com/en-us/cli/azure/install-azure-cli?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="How to install the Azure CLI"><em>Azure CLI</em></a><em>)</em> is recommended to ensure that the Virtual Machine is deallocated and its affinity on the host has been released.</p>
<p><img decoding="async" loading="lazy" alt="Microsoft Azure - Virtual Machine Power States" src="/assets/images/azvm-power-states-c67f8a6c163301a9851ce1e794a9cb8a.png" title="Microsoft Azure - Virtual Machine Power States" width="1212" height="416" class="img_ev3q"></p>
<p>However, you need to know this, and those new to Microsoft Azure, or users who don&#x27;t have <a href="https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Azure built-in roles">Virtual Machine Administrator</a> rights to deallocate a Virtual Machine, may simply shut down the operating system, leaving the Virtual Machine in a &#x27;Stopped&#x27; state, but still tied to an underlying Azure host and incurring cost.</p>
<p>Our solution can help; by triggering an Alert when a Virtual Machine becomes unavailable due to a user-initiated shutdown, we can then start an <a href="https://learn.microsoft.com/en-us/azure/automation/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Automation</a> runbook to deallocate the Virtual Machine.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">​</a></h3>
<p>Today, we are going to set up an Azure Automation runbook, triggered by a Resource Health alert that will go through the following steps:</p>
<ol>
<li>User shutdowns Virtual Machine from within the Operating System</li>
<li>The Virtual Machine enters an unavailable state</li>
<li>A Resource Alert is triggered when the Virtual Machine becomes unavailable (after being available) by a user initiated event</li>
<li>The Alert triggers a Webhook to an Azure Automation runbook</li>
<li>Using permissions assigned to the Azure Automation account through a System Managed Identity connects to Microsoft Azure and checks the VM state; if the Virtual Machine state is still &#x27;Stopped&#x27;, then deallocate the virtual machine.</li>
<li>Then finally, resolve the triggered alert.</li>
</ol>
<p>To do this, we need a few resources.</p>
<ul>
<li>Azure Automation Account</li>
<li>Az.AlertsManagement module in the Azure Automation account</li>
<li>Az.Accounts module <em>(updated in the Azure Automation account)</em></li>
<li>Azure Automation runbook <em>(I will supply this below)</em></li>
<li>Resource Health Alert</li>
<li>Webhook <em>(to trigger to the runbook and pass the JSON from the alert)</em></li>
</ul>
<p>And, of course, &#x27;Contributor&#x27; rights to the Microsoft Azure subscription to provide the resources and the alerts and resources and set up the system managed identity.</p>
<p>We will set up this from scratch using the Azure Portal and an already created PowerShell Azure Automation runbook.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="deploy-deallocate-solution">Deploy Deallocate Solution<a href="#deploy-deallocate-solution" class="hash-link" aria-label="Direct link to Deploy Deallocate Solution" title="Direct link to Deploy Deallocate Solution">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="setup-azure-automation-account">Setup Azure Automation Account<a href="#setup-azure-automation-account" class="hash-link" aria-label="Direct link to Setup Azure Automation Account" title="Direct link to Setup Azure Automation Account">​</a></h4>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="create-azure-automation-account">Create Azure Automation Account<a href="#create-azure-automation-account" class="hash-link" aria-label="Direct link to Create Azure Automation Account" title="Direct link to Create Azure Automation Account">​</a></h5>
<p>First, we need an <a href="https://learn.microsoft.com/en-us/azure/automation/automation-create-standalone-account?tabs=azureportal&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Create a standalone Azure Automation account">Azure Automation</a> resource.</p>
<ol>
<li>Log into the <a href="https://portal.azure.com/#home" target="_blank" rel="noopener noreferrer" title="Microsoft Azure Portal"><strong>Microsoft Azure Portal</strong></a>.</li>
<li>Click <strong>+ Create a resource.</strong></li>
<li>Type in <strong>automation</strong></li>
<li>Select <strong>Create</strong> under Automation, and select <strong>Automation.</strong></li>
<li><img decoding="async" loading="lazy" alt="Create Azure Automation Account" src="/assets/images/azureportal-create-automation-f17fe5866b2554fab2016911fdae4250.jpg" title="Create Azure Automation Account" width="426" height="573" class="img_ev3q"></li>
<li>Select your <strong>subscription</strong></li>
<li>Select your <strong>Resource Group</strong> or Create one if you don&#x27;t already have one <em>(I recommend placing your automation resources in an Azure Management or Automation resource group, this will also contain your Runbooks)</em></li>
<li>Select your <strong>region</strong></li>
<li><img decoding="async" loading="lazy" alt="Create Azure Automation Account" src="/assets/images/azureportal-create-automation_basics-1389cb6873b6fc1b5c884f01279f38c4.jpg" title="Create Azure Automation Account" width="749" height="479" class="img_ev3q"></li>
<li>Select <strong>Next</strong></li>
<li>Make sure: <strong>System assigned</strong> is selected for Managed identities <em>(this will be required for giving your automation account permissions to deallocate your Virtual Machine, but it can be enabled later if you already have an Azure Automation account)</em>.</li>
<li>Click <strong>Next</strong></li>
<li>Leave Network connectivity as default (<strong>Public access</strong>)</li>
<li>Click <strong>Next</strong></li>
<li><strong>Enter</strong> in appropriate <strong>tags</strong></li>
<li><img decoding="async" loading="lazy" alt="Create Azure Automation Account" src="/assets/images/azureportal-create-automation_tags-cf8d12ea6a602ac7d4d3019f34458da0.jpg" title="Create Azure Automation Account" width="753" height="524" class="img_ev3q"></li>
<li>Click <strong>Review + Create</strong></li>
<li>After validation has passed, select <strong>Create</strong></li>
</ol>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="configure-system-identity">Configure System Identity<a href="#configure-system-identity" class="hash-link" aria-label="Direct link to Configure System Identity" title="Direct link to Configure System Identity">​</a></h5>
<p>Now that we have our Azure Automation account, its time to set up the System Managed Identity and grant it the following roles:</p>
<ul>
<li>Virtual Machine Contributor <em>(to deallocate the Virtual Machine)</em></li>
<li>Monitoring Contributor <em>(to close the Azure Alert)</em></li>
</ul>
<p>You can set up a custom role to be least privileged and use that instead. But in this article, we will stick to the built-in roles.</p>
<ol>
<li>Log into the <a href="https://portal.azure.com/#home" target="_blank" rel="noopener noreferrer" title="Microsoft Azure Portal"><strong>Microsoft Azure Portal</strong></a>.</li>
<li>Navigate to your Azure <strong>Automation account</strong></li>
<li>Click on: <strong>Identity</strong></li>
<li>Make sure that the <strong>System assigned</strong> toggle is: <strong>On</strong> and click <strong>Azure role assignments.</strong></li>
<li><img decoding="async" loading="lazy" alt="Azure Automation Account managed identity" src="/assets/images/azureportal-automation_managedidentity-46173e0eb415b07c841cfd616266eb7c.jpg" title="Azure Automation Account managed identity" width="773" height="706" class="img_ev3q"></li>
<li>Click <strong>+ Add role assignments</strong></li>
<li>Select the <strong>Subscription</strong> <em>(make sure this subscription matches the same subscription your Virtual Machines are in)</em></li>
<li>Select Role: <strong>Virtual Machine Contributor</strong></li>
<li>Click <strong>Save</strong></li>
<li>Now we repeat the same process for <strong>Monitoring Contributor</strong></li>
<li>lick <strong>+ Add role assignments</strong></li>
<li>Select the <strong>Subscription</strong> <em>(make sure this subscription matches the same subscription your Virtual Machines are in)</em></li>
<li>Select Role: <strong>Monitoring Contributor</strong></li>
<li>Click <strong>Save</strong></li>
<li>Click <strong>Refresh</strong> <em>(it may take a few seconds to update the Portal, so if it is blank - give it 10 seconds and try again)</em>.</li>
<li>You have now set up the System Managed identity and granted it the roles necessary to execute the automation.</li>
</ol>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="import-modules">Import Modules<a href="#import-modules" class="hash-link" aria-label="Direct link to Import Modules" title="Direct link to Import Modules">​</a></h5>
<p>We will use the Azure Runbook and use a few Azure PowerShell Modules; by default, Azure Automation has the base Azure PowerShell modules, but we will need to add <a href="https://learn.microsoft.com/en-us/powershell/module/az.alertsmanagement/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Az.AlertsManagement">Az.AlertsManagement</a>, and update the Az.Accounts as required as a pre-requisite for Az.AlertsManagement.</p>
<ol>
<li>Log into the <a href="https://portal.azure.com/#home" target="_blank" rel="noopener noreferrer" title="Microsoft Azure Portal"><strong>Microsoft Azure Portal</strong></a>.</li>
<li>Navigate to your Azure <strong>Automation account</strong></li>
<li>Click on <strong>Modules</strong></li>
<li>Click on <strong>+ Add a module</strong></li>
<li>Click on <strong>Browse from Gallery</strong></li>
<li>Click: <strong>Click here to browse from the gallery</strong></li>
<li>Type in: <strong>Az.Accounts</strong></li>
<li>Press <strong>Enter</strong></li>
<li>Click on <strong>Az.Accounts</strong></li>
<li>Click <strong>Select</strong></li>
<li><img decoding="async" loading="lazy" alt="Import Az.Accounts module" src="/assets/images/azureportal-automation_modules_az-accounts-6b84545ff7cf24ce120cd93e0c255a97.jpg" title="Import Az.Accounts module" width="738" height="417" class="img_ev3q"></li>
<li>Make sure that the Runtime version is: <strong>5.1</strong></li>
<li>Click <strong>Import</strong></li>
<li>Now that the Az.Accounts have been updated, and it&#x27;s time to import Az.AlertsManagement!</li>
<li>Click on <strong>Modules</strong></li>
<li>Click on <strong>+ Add a module</strong></li>
<li>Click on <strong>Browse from Gallery</strong></li>
<li>Click: <strong>Click here to browse from the gallery</strong></li>
<li>Type in: <strong>Az.AlertsManagement</strong> <em>(note its Alert<strong>s)</strong></em></li>
<li>Click <strong>Az.AlertsManagement</strong></li>
<li><img decoding="async" loading="lazy" alt="Az.AlertsManagement module" src="/assets/images/azureportal-automation_modules_az-alertsmanagement-3e56fcc89310e58f9e631b4e713107b3.jpg" title="Az.AlertsManagement module" width="1319" height="1019" class="img_ev3q"></li>
<li>Click <strong>Select</strong></li>
<li>Make sure that the Runtime version is: <strong>5.1</strong></li>
<li>Click <strong>Import</strong> <em>(if you get an error, make sure that Az.Accounts has been updated, through the Gallery import as above)</em></li>
<li>Now you have successfully added the dependent modules!</li>
</ol>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="import-runbook">Import Runbook<a href="#import-runbook" class="hash-link" aria-label="Direct link to Import Runbook" title="Direct link to Import Runbook">​</a></h5>
<p>Now that the modules have been imported into your Azure Automation account, it is time to import the Azure Automation runbook.</p>
<ol>
<li>Log into the <a href="https://portal.azure.com/#home" target="_blank" rel="noopener noreferrer" title="Microsoft Azure Portal"><strong>Microsoft Azure Portal</strong></a>.</li>
<li>Navigate to your Azure <strong>Automation account</strong></li>
<li>Click on <strong>Runbooks</strong></li>
<li>Click <strong>+ Create a runbook</strong></li>
<li>Specify a <strong>name</strong> <em>(i.e. Deallocate-AzureVirtualMachine)</em></li>
<li>Select Runbook type of: <strong>PowerShell</strong></li>
<li>Select Runtime version of: <strong>5.1</strong></li>
<li>Type in a <strong>Description</strong> that explains the runbook <em>(this isn&#x27;t mandatory, but like Tags is recommended, this is an opportunity to indicate to others what it is for and who set it up)</em></li>
<li><img decoding="async" loading="lazy" alt="Create Azure Runbook" src="/assets/images/azureportal-runbook-create-3d404335d690517ee5dd2ccad6d62a58.jpg" title="Create Azure Runbook" width="735" height="467" class="img_ev3q"></li>
<li>Click <strong>Create</strong></li>
<li>Now you will be greeted with a blank edit pane; paste in the Runbook from below:</li>
</ol>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">Deallocate-AzureVirtualMachine.ps1</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">#requires -Version 3.0 -Modules Az.Accounts, Az.AlertsManagement</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">&lt;#</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    .SYNOPSIS</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    PowerShell Azure Automation Runbook for Stopping Virtual Machines, that have been Shutdown within the Windows Operating System (Stopped and not Deallocated). </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    .AUTHOR</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    Luke Murray (https://github.com/lukemurraynz/)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">#&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">OutputType</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;PSAzureOperationResponse&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">Parameter</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">Mandatory = </span><span class="token boolean">$true</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> HelpMessage = </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Data from the WebHook/Azure Alert&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token namespace">[Object]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$WebhookData</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Import-Module</span><span class="token plain"> Az</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">AlertsManagement</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ErrorActionPreference</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;stop&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Get the data object from WebhookData</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$WebhookData</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$WebhookData</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">RequestBody</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">InputObject </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$WebhookData</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$Schema</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$WebhookData</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">ConvertFrom-Json</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">#Sets the Webhook data into object</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$Essentials</span><span class="token plain"> = </span><span class="token namespace">[object]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$Schema</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">essentials</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">InputObject </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$Essentials</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Get the first target only as this script doesn&#x27;t handle multiple and and export variables for the resource.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$alertIdArray</span><span class="token plain"> = </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$Essentials</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">alertId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Split</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;/&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$alertTargetIdArray</span><span class="token plain"> = </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$Essentials</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">alertTargetIds</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Split</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;/&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$alertid</span><span class="token plain"> =  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$alertIdArray</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">6</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$SubId</span><span class="token plain"> = </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$alertTargetIdArray</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceGroupName</span><span class="token plain"> = </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$alertTargetIdArray</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">4</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceType</span><span class="token plain"> = </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$alertTargetIdArray</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">6</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;/&#x27;</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$alertTargetIdArray</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">7</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceName</span><span class="token plain"> = </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$alertTargetIdArray</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token operator">-</span><span class="token plain">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$status</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$Essentials</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">monitorCondition</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">InputObject </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$alertTargetIdArray</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain">  </span><span class="token operator">-</span><span class="token plain">InputObject </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;status: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$status</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Verbose</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">#Sets VM shutdown</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$status</span><span class="token plain"> </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Activated&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">-or</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$status</span><span class="token plain"> </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Fired&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$status</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$Essentials</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">monitorCondition</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">InputObject </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;resourceType: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceType</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Verbose</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain">  </span><span class="token operator">-</span><span class="token plain">InputObject </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;resourceName: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceName</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Verbose</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain">  </span><span class="token operator">-</span><span class="token plain">InputObject </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;resourceGroupName: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceGroupName</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Verbose</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain">  </span><span class="token operator">-</span><span class="token plain">InputObject </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;subscriptionId: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$SubId</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Verbose</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Determine code path depending on the resourceType</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceType</span><span class="token plain"> </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Microsoft.Compute/virtualMachines&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># This is an Resource Manager VM</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain">  </span><span class="token operator">-</span><span class="token plain">InputObject </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;This is an Resource Manager VM.&#x27;</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Verbose</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Ensures you do not inherit an AzContext in your runbook</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Disable-AzContextAutosave</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Scope </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">Process</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Connect to Azure with system-assigned managed identity</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$AzureContext</span><span class="token plain"> = </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token function" style="color:rgb(80, 250, 123)">Connect-AzAccount</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Identity</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">context</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># set and store context</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$AzureContext</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Set-AzContext</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">SubscriptionName </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$AzureContext</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Subscription </span><span class="token operator">-</span><span class="token plain">DefaultProfile </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$AzureContext</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain">   </span><span class="token operator">-</span><span class="token plain">InputObject </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$AzureContext</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)">#Checks Azure VM status</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$VMStatus</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzVM</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ResourceGroupName </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceGroupName</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceName</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Status</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain">  </span><span class="token operator">-</span><span class="token plain">InputObject </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$VMStatus</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">If</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$VMStatus</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Statuses</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Code </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;PowerState/stopped&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain">  </span><span class="token operator">-</span><span class="token plain">InputObject </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Stopping the VM, it was Shutdown without being Deallocated - </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceName</span><span class="token string" style="color:rgb(255, 121, 198)"> - in resource group - </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceGroupName</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Verbose</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Stop-AzVM</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceName</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ResourceGroupName </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceGroupName</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">DefaultProfile </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$AzureContext</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Force </span><span class="token operator">-</span><span class="token plain">Verbose</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token comment" style="color:rgb(98, 114, 164)">#Check VM Status after deallocation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$VMStatus</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzVM</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ResourceGroupName </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceGroupName</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceName</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Status </span><span class="token operator">-</span><span class="token plain">Verbose</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain">  </span><span class="token operator">-</span><span class="token plain">InputObject </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$VMStatus</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">If</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$VMStatus</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Statuses</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Code </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;PowerState/deallocated&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token comment" style="color:rgb(98, 114, 164)">#Closes Alert</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain">  </span><span class="token operator">-</span><span class="token plain">InputObject </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$VMStatus</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Statuses</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Code</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain">  </span><span class="token operator">-</span><span class="token plain">InputObject </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$alertid</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzAlert</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">AlertId </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$alertid</span><span class="token plain">  </span><span class="token operator">-</span><span class="token plain">verbose </span><span class="token operator">-</span><span class="token plain">DefaultProfile </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$AzureContext</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzAlert</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">AlertId </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$alertid</span><span class="token plain">  </span><span class="token operator">-</span><span class="token plain">verbose </span><span class="token operator">-</span><span class="token plain">DefaultProfile </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$AzureContext</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Update-AzAlertState</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">State </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Closed&#x27;</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Verbose </span><span class="token operator">-</span><span class="token plain">DefaultProfile </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$AzureContext</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">             </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">Elseif</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$VMStatus</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Statuses</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Code </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;PowerState/deallocated&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain">  </span><span class="token operator">-</span><span class="token plain">InputObject </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Already deallocated&#x27;</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Verbose</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">Elseif</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$VMStatus</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Statuses</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Code </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;PowerState/running&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain">  </span><span class="token operator">-</span><span class="token plain">InputObject </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;VM running. No further actions&#x27;</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Verbose</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># [OutputType(PSAzureOperationResponse&quot;)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># The alert status was not &#x27;Activated&#x27; or &#x27;Fired&#x27; so no action taken</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain">  </span><span class="token operator">-</span><span class="token plain">InputObject </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;No action taken. Alert status: &#x27;</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$status</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Verbose</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="13">
<li>Click <strong>Save</strong></li>
<li><img decoding="async" loading="lazy" alt="Azure Automation runbook" src="/assets/images/azureportal-runbook-import-9ad03aed284d9f134d6f103fbbaf3703.jpg" title="Azure Automation runbook" width="1160" height="993" class="img_ev3q"></li>
<li>Click <strong>Publish</strong> <em>(so the runbook is actually in production and can be used)</em></li>
<li>You can select View or Edit at any stage, but you have now imported the Azure Automation runbook!</li>
</ol>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="setup-webhook">Setup Webhook<a href="#setup-webhook" class="hash-link" aria-label="Direct link to Setup Webhook" title="Direct link to Setup Webhook">​</a></h5>
<p>Now that the Azure runbook has been imported, we need to set up a Webhook for the Alert to trigger and start the runbook.</p>
<ol>
<li>Log into the <a href="https://portal.azure.com/#home" target="_blank" rel="noopener noreferrer" title="Microsoft Azure Portal"><strong>Microsoft Azure Portal</strong></a>.</li>
<li>Navigate to your Azure <strong>Automation account</strong></li>
<li>Click on <strong>Runbooks</strong></li>
<li><strong>Click</strong> on the <strong>runbook</strong> you just imported <em>(i.e. Deallocate-AzureVirtualMachine)</em></li>
<li>Click on <strong>Add webhook</strong></li>
<li>Click <strong>Create a new webhook</strong></li>
<li><strong>Enter</strong> a <strong>name</strong> for the webhook</li>
<li>Make sure it is <strong>Enabled</strong></li>
<li>You can edit the expiry date to match your security requirements; make sure you <strong>record</strong> the expiry date, as it will need to be renewed before it expires.</li>
<li><strong>Copy</strong> the <strong>URL</strong> and paste it somewhere safe <em>(you won&#x27;t see this again! and you need it for the next steps)</em></li>
<li><img decoding="async" loading="lazy" alt="Create Azure webhook" src="/assets/images/azureportal-webhook-create-6623ef89825a6c0a1f726b79b468ef97.jpg" title="Create Azure webhook" width="345" height="503" class="img_ev3q"></li>
<li>Click <strong>Ok</strong></li>
<li>Click on <strong>Configure parameters and run settings.</strong></li>
<li>Because we will be taking in dynamic data from an Azure Alert, enter in: <strong>[EmptyString]</strong></li>
<li>Click <strong>Ok</strong></li>
<li>Click <strong>Create</strong></li>
<li>You have now set up the webhook <em>(make sure you have saved the URL from the earlier step as you will need it in the following steps)!</em></li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="setup-alert--action-group">Setup Alert &amp; Action Group<a href="#setup-alert--action-group" class="hash-link" aria-label="Direct link to Setup Alert &amp; Action Group" title="Direct link to Setup Alert &amp; Action Group">​</a></h4>
<p>Now that the Automation framework has been created with the Azure Automation account, runbook and webhook, we now need a way to detect if a Virtual Machine has been Stopped; this is where a Resource Health alert will come in.</p>
<ol>
<li>Log into the <a href="https://portal.azure.com/#home" target="_blank" rel="noopener noreferrer" title="Microsoft Azure Portal"><strong>Microsoft Azure Portal</strong></a>.</li>
<li>Navigate to: <a href="https://portal.azure.com/#blade/Microsoft_Azure_Monitoring/AzureMonitoringBrowseBlade/overview" target="_blank" rel="noopener noreferrer"><strong>Monitor</strong></a></li>
<li>Click on <strong>Service Health</strong></li>
<li>Select <strong>Resource Health</strong></li>
<li>Select <strong>+ Add resource health alert</strong></li>
<li>Select your <strong>subscription</strong></li>
<li>Select <strong>Virtual machine</strong> for Resource Type</li>
<li>You can target specific Resource Groups for your alert <em>(and, as such, your automation)</em> or <strong>select all.</strong></li>
<li>Check <strong>Include all future resource groups</strong></li>
<li>Check <strong>include all future resources</strong></li>
<li>Under the Alert conditions, make sure <strong>Event Status</strong> is: <strong>All selected</strong></li>
<li>Set Current resource status to <strong>Unavailable</strong></li>
<li>Set Previous resource status to <strong>All selected</strong></li>
<li>For reason type, select: <strong>User initiated</strong> and <strong>unknown</strong></li>
<li><img decoding="async" loading="lazy" alt="Create Azure Resource Health Alert" src="/assets/images/azureportal-alert-create-525afa13de376a81109f6c9693561cd1.jpg" title="Create Azure Resource Health Alert" width="877" height="956" class="img_ev3q"></li>
<li>Now that we have the Alert rule configured, we need to set up an Action group. That will get triggered when the alert gets fired.</li>
<li>Click <strong>Select Action groups.</strong></li>
<li>Click <strong>+ Create action group</strong></li>
<li><strong>Select</strong> your subscription and <strong>resource group</strong> <em>(this is where the Action alert will go, I recommend your Azure Management/Monitoring resource group that may have a Log Analytics workspace as an example)</em>.</li>
<li>Give your Action Group a <strong>name</strong>, i.e. AzureAutomateActionGroup</li>
<li>The display name will be automatically generated, but feel free to adjust it to suit your naming convention</li>
<li>Click <strong>Next: Notifications</strong></li>
<li>Under <strong>Notifications</strong>, you can trigger an <strong>email alert</strong>, which can be handy in determining how often the runbook runs. This can be modified and removed if it is running, especially during testing.</li>
<li>Click <strong>Next: Actions</strong></li>
<li>Under Action Type, select <strong>Webhook</strong></li>
<li><strong>Paste</strong> in the <strong>URI</strong> created earlier when setting up the Webhook</li>
<li>Select <strong>Yes</strong> to enable the <strong>common alert schema</strong> (<em>this is required as the JSON that the runbook is parsing is expecting it to the in the schema, if it isn&#x27;t the runbook will fail)</em></li>
<li><img decoding="async" loading="lazy" alt="Create Azure Action Group" src="/assets/images/azureportal-actiongroup-webhook-0c15f37f442496a15c8840646f976dab.jpg" title="Create Azure Action Group" width="1552" height="425" class="img_ev3q"></li>
<li>Click <strong>Ok</strong></li>
<li>Give the <strong>webhook</strong> a <strong>name</strong>.</li>
<li>Click <strong>Review + create</strong></li>
<li>Click <strong>Create</strong></li>
<li>Finally, enter in an Alert <strong>name</strong> and <strong>description</strong>, specify the resource group for the Alert to go into and click <strong>Save.</strong></li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="test-deallocate-solution">Test Deallocate Solution<a href="#test-deallocate-solution" class="hash-link" aria-label="Direct link to Test Deallocate Solution" title="Direct link to Test Deallocate Solution">​</a></h3>
<p>So now we have stood up our:</p>
<ul>
<li>Azure automation account</li>
<li>Alert</li>
<li>Action Group</li>
<li>Azure automation runbook</li>
<li>Webhook</li>
</ul>
<p>It is time to test! I have a VM called: VM-D01, running Windows <em>(theoretically, this runbook will also run against Linux workloads, as its relying on the Azure agent to send the correct status to the Azure Logs, but in my testing, it was against Windows workloads)</em> in the same subscription that the alert has been deployed against.</p>
<p>As you can see below, I shut down the Virtual Machine. After a few minutes <em>(be patient, Azure needs to wait for the status of the VM to be triggered)</em>, an Azure Alert was fired into Azure Monitor, which triggered the webhook and runbook, and the Virtual Machine was deallocated, and the Azure Alert was closed.</p>
<p><img decoding="async" loading="lazy" alt="Azure deallocate testing" src="/assets/images/deallocatevm-d03b67f813b3eeb276033ac07d8636a5.gif" title="Azure deallocate testing" width="1449" height="647" class="img_ev3q"></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/azure/">Azure</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/azure/hidden-tags-in-azure/">Hidden Tags in Azure</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-05-07T00:00:00.000Z">May 7, 2022</time> · <!-- -->4 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://luke.geek.nz/img/logo.png" alt="Luke Murray"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">Luke Murray</span></a></div><small class="authorTitle_nd0D" title="Author">Author</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><p><a href="https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/tag-resources?tabs=json&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Use tags to organize your Azure resources and management hierarchy">Tags</a> in Microsoft Azure are pivotal to resource management, whether it&#x27;s used for reporting or automation.</p>
<p>But sometimes, you need that extra bit of information to help discover what resources are for, or you may way to add information to a resource that isn&#x27;t directly displayed in the portal, especially when complex tags are in use that might be used in automation initiatives.</p>
<p>This is where &#x27;hidden&#x27; Azure Tags come in handy.</p>
<p>Tags starting with the prefix of <em>&#x27;hidden-&#x27;</em> will not be displayed under Tags in the Azure Portal; however, they will be displayed in the resource metadata and utilised by PowerShell and Azure CLI for automation initiatives.</p>
<p>Examples are:</p>

















<table><thead><tr><th>Tags</th><th>Value</th></tr></thead><tbody><tr><td>hidden-title</td><td>Web Server</td></tr><tr><td>hidden-ShutdownAutomation</td><td>Yes</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="hidden-title">hidden-title<a href="#hidden-title" class="hash-link" aria-label="Direct link to hidden-title" title="Direct link to hidden-title">​</a></h3>
<p>As I mentioned above, every tag with &#x27;hidden-&#x27; in front of it will be hidden in the Azure Portal. However, &#x27;hidden-title&#x27; behaves differently.</p>
<p>You may have noticed that some resources in Azure, especially if the Azure ARM <em>(Azure Resource Manager)</em> creates them and the name is GUID based, has a &#x27;(name)&#x27; around them after the resource name; this is because of the hidden-title tag.</p>
<p>The hidden-title tag is especially useful for being able to pick resources that belong to a specific service or application.</p>
<p>An example is below:</p>
<p><img decoding="async" loading="lazy" alt="Azure Portal - Hidden Title Tag" src="/assets/images/azureportal_hiddentitle-8eb0b684f90791788753ef73ee864d5e.png" title="Azure Portal - Hidden Title Tag" width="1331" height="685" class="img_ev3q"></p>
<p>In this case, I have used the <em>hidden-title</em> of &#x27;Web Server&#x27;, allowing me to quickly view what resources may be mapped to my Web Server.</p>
<p>You may notice that the Test-Virtual Machines title, is displayed in the Resource Groups search blade and not in the actual Resource Group, there are some areas of the Portal that will not display the hidden-title tag currently.</p>
<p>If I navigate to my Virtual Machine and click on the Tags blade, all I see is my CreatedBy tag.</p>
<p><img decoding="async" loading="lazy" alt="Azure Portal - Tags" src="/assets/images/azureportal-hiddentitle-vmtags-05ea996b39af58b4cd28997dac7f0b7b.png" title="Azure Portal - Tags" width="1323" height="457" class="img_ev3q"></p>
<p>However, if I navigate to the Overview page and click on JSON View, I can see the hidden tags in the resource metadata.</p>
<p><img decoding="async" loading="lazy" alt="Azure Portal - Resource Tags" src="/assets/images/azureportal-hiddentitle-vmtagsjson-d94859243123bbf8192f16a32fc2e3dd.png" title="Azure Portal - Resource Tags" width="1108" height="504" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="hidden-tags">hidden tags<a href="#hidden-tags" class="hash-link" aria-label="Direct link to hidden tags" title="Direct link to hidden tags">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="azure-portal">Azure Portal<a href="#azure-portal" class="hash-link" aria-label="Direct link to Azure Portal" title="Direct link to Azure Portal">​</a></h4>
<p>You can use the Azure Portal directly to add the Tags to apply hidden tags.</p>
<p><img decoding="async" loading="lazy" alt="Azure Portal - Add Tags" src="/assets/images/azureportal_hiddentagsadd-f8360ab83e2f73247cad3e4ad88f361f.png" title="Azure Portal - Add Tags" width="1177" height="400" class="img_ev3q"></p>
<p>You can remove the Tag by adding the hidden-tag again and keeping the value empty <em>(ie blanking out the hidden-title will remove the title)</em>, but it will still be against the metadata <em>(Resource Graph)</em> as a Tag that exists (as seen in the screenshot below) - it is much cleaner to use PowerShell.</p>
<p><img decoding="async" loading="lazy" alt="Azure - Resource Tags" src="data:image/png;base64,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" title="Azure - Resource Tags" width="441" height="121" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="powershell">PowerShell<a href="#powershell" class="hash-link" aria-label="Direct link to PowerShell" title="Direct link to PowerShell">​</a></h4>
<p>Get-AzTag and Remove-AzTag, do not display the hidden tags, to add and remove the tags, you need to add them through &#x27;Update-AzTag&#x27; and &#x27;Replace&#x27; or &#x27;Merge&#x27; to overwrite the tags, which requires the Resource targetted by Resource ID.</p>
<p>A handy snippet to use to add/remove the Tags on individual or multiple resources is:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$replacedTags = @{&quot;hidden-title&quot; = &quot;Web Server&quot;; &quot;hidden-ShutdownAutomation&quot; = &quot;Yes&quot;}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$resouceGroup = &#x27;vm-dev-rg&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Get-AzResource -ResourceGroupName $resouceGroup | Select-Object ResourceId | Out-GridView -PassThru | Update-AzTag -Tag $replacedTags -Operation Merge</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This will snippet will gather all the resources in your Resource Group, then select their Resource IDs; the script will then prompt with a GUI allowing you to select which resources or resources you want to update your tags on, then once you click Ok, it will update the Tags on the resources you selected.</p>
<p><img decoding="async" loading="lazy" alt="PowerShell - Add Azure Tags" src="/assets/images/powershell_hiddentagsadd-13bedddf846b3f320146ed434671508e.png" title="PowerShell - Add Azure Tags" width="1470" height="422" class="img_ev3q"></p>
<p>You may be wondering if the Hidden tags are useful for automation, but if the &#x27;Get-AzTag&#x27; cmdlet doesn&#x27;t work, how can I retrieve the resources? It&#x27;s a good question, and that is where &#x27;Get-AzResource&#x27; comes to the rescue.</p>
<p>Examples are:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Get-AzResource -TagName hidden-ShutdownAutomation</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Get-AzResource -TagValue Yes</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$TagName = &#x27;hidden-title&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$TagValue = &#x27;Web Server&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Get-AzResource -TagName $TagName -TagValue $TagValue | Where-Object -FilterScript {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    $_.ResourceType -like &#x27;Microsoft.Compute/virtualMachines&#x27; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="azure-bicep">Azure Bicep<a href="#azure-bicep" class="hash-link" aria-label="Direct link to Azure Bicep" title="Direct link to Azure Bicep">​</a></h4>
<p>You can also add the Tags, with Azure Bicep.</p>
<p>Example is:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">param resourceTags object = {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   hidden-title: &#x27;Web Server&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   hidden-ShutdownAutomation: &#x27;Yes&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">tags: resourceTags</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/azure/">Azure</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/2022/04/20/azure-arc-bridge-implementing-and-testing/">Azure Arc Bridge - Implementation and Testing</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-04-20T00:00:00.000Z">April 20, 2022</time> · <!-- -->8 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://luke.geek.nz/img/logo.png" alt="Luke Murray"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">Luke Murray</span></a></div><small class="authorTitle_nd0D" title="Author">Author</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><p><a href="https://learn.microsoft.com/en-us/azure/azure-arc/resource-bridge/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="What is Azure Arc resource bridge ">Azure Arc Bridge</a><em>(currently in preview)</em> is part of the core Azure Arc Hybrid Cloud platform.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">​</a></h3>
<p>The Azure Arc resource bridge allows for VM <em>(Virtual Machine)</em> self-servicing and managing on-premises Azure Stack HCI and VMWare virtualised workloads, supporting Linux and Windows.</p>
<p>Along with standard integration of Azure Arc workloads, such as support for Azure Policy and Azure extensions, Azure Update Management and Defender for Cloud support. The Azure Arc resource bridge offers the following self-service functionality direct from the Microsoft Azure portal, offering a single pane of a glass of your workloads, whether they exist on-premises or in Azure:</p>
<ul>
<li>Start, stop and restart a virtual machine</li>
<li>Control access and add Azure tags</li>
<li>Add, remove, and update network interfaces</li>
<li>Add, remove, and update disks and update VM size <em>(CPU cores and memory)</em></li>
<li>Enable guest management</li>
<li>Install extensions</li>
<li>Azure Stack HCI - You can provision and manage on-premises Windows and Linux virtual machines <em>(VMs)</em> running on Azure Stack HCI clusters.</li>
</ul>
<blockquote>
<p>The resource bridge is a packaged virtual machine, which hosts a <em>management</em> Kubernetes cluster that requires no user management. This virtual appliance delivers the following benefits:</p>
<ul>
<li>Enables VM self-servicing from Azure without having to create and manage a Kubernetes cluster</li>
<li>It is fully supported by Microsoft, including update of core components.</li>
<li>Designed to recover from software failures.</li>
<li>Supports deployment to any private cloud hosted on Hyper-V or VMware from the Azure portal or using the Azure Command-Line Interface (CLI).</li>
</ul>
<p>All management operations are performed from Azure, no local configuration is required on the appliance.</p>
</blockquote>
<p><img decoding="async" loading="lazy" alt="Azure Arc - Overview" src="/assets/images/arc-bridge-architecture-overview-b3830ef9b2fc8d9528dd85dbb0f49e4d.png" width="2150" height="1119" class="img_ev3q"></p>
<blockquote>
<p>Azure Arc resource bridge currently supports the following Azure regions:</p>
<ul>
<li>East US</li>
<li>West Europe</li>
</ul>
</blockquote>
<p>These regions hold the Resource Bridge metadata for the resources.</p>
<p>Today, we will stand up an Azure Arc Bridge that supports VMWare vSphere.</p>
<p>I will be running vSphere 6.7 on a single host in my home lab, connected to my Visual Studio subscription.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="prerequisites">Prerequisites<a href="#prerequisites" class="hash-link" aria-label="Direct link to Prerequisites" title="Direct link to Prerequisites">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="private-cloud-environments">Private cloud environments<a href="#private-cloud-environments" class="hash-link" aria-label="Direct link to Private cloud environments" title="Direct link to Private cloud environments">​</a></h4>
<p>The following private cloud environments and their versions are officially supported for the Azure Arc resource bridge:</p>
<ul>
<li>VMware vSphere version 6.7</li>
<li>Azure Stack HCI</li>
</ul>
<p><em>Note: You are unable to set this up on vSphere 7.0.3, as it is not currently supported - I tried!</em></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="permissions">Permissions<a href="#permissions" class="hash-link" aria-label="Direct link to Permissions" title="Direct link to Permissions">​</a></h4>
<ul>
<li>Contributor rights to the Resource Group that the Azure Arc bridge resource will be created.</li>
<li>vSphere account <em>(with at least Read and modify VM rights)</em></li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="required-azure-resources">Required Azure resources<a href="#required-azure-resources" class="hash-link" aria-label="Direct link to Required Azure resources" title="Direct link to Required Azure resources">​</a></h4>
<ul>
<li>Resource Group for your Azure Arc Resource Bridge</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="required-on-premises-resources">Required On-premises resources<a href="#required-on-premises-resources" class="hash-link" aria-label="Direct link to Required On-premises resources" title="Direct link to Required On-premises resources">​</a></h4>
<ul>
<li>Resource pool with a reservation of at least 16 GB of RAM and four vCPUs. It should also have access to a datastore with at least 100 GB of free disk space.</li>
<li>A workstation with rights to run PowerShell and install Python and the Azure CLI, with a line of sight to vCenter.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="networking">Networking<a href="#networking" class="hash-link" aria-label="Direct link to Networking" title="Direct link to Networking">​</a></h4>
<ul>
<li>The Arc resource bridge communicates outbound securely to Azure Arc over TCP port 443</li>
<li>At least one free IP <em>(Internet Protocol)</em> address on the on-premises network <em>(or three if there isn&#x27;t a DHCP server).</em> Make sure this isn&#x27;t a used IP; you will need to enter this during the bridge provisioning script.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-azure-arc-resource-bridge">Create Azure Arc Resource Bridge<a href="#create-azure-arc-resource-bridge" class="hash-link" aria-label="Direct link to Create Azure Arc Resource Bridge" title="Direct link to Create Azure Arc Resource Bridge">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-resource-bridge">Create Resource Bridge<a href="#create-resource-bridge" class="hash-link" aria-label="Direct link to Create Resource Bridge" title="Direct link to Create Resource Bridge">​</a></h4>
<ol>
<li>Log in to the <strong>Azure Portal</strong></li>
<li>In the search box up the top, type in: <strong>Azure Arc</strong></li>
<li>Click <strong>Azure Arc</strong></li>
<li>Click on: <strong>VMware vCenters (preview)</strong></li>
<li>Click <strong>Add</strong></li>
<li><img decoding="async" loading="lazy" alt="Azure Arc - Resource Bridge" src="/assets/images/azure_arc_vmware_portal-7b59ed598cf193e6480f282ecd316d26.png" title="Azure Arc - Resource Bridge" width="1233" height="617" class="img_ev3q"></li>
<li>Click: <strong>Create a new resource bridge</strong></li>
<li><img decoding="async" loading="lazy" alt="Azure Arc - Resource Bridge" src="/assets/images/azure_arc_vmware_portal_createresourcebridge-dab7c47b4e4e1b54e38dd5db5be60005.png" title="Azure Arc - Resource Bridge" width="830" height="422" class="img_ev3q"></li>
<li>Click <strong>Next: Basics</strong></li>
<li><strong>Enter</strong> the <strong>following</strong> information to suit your environment:</li>
</ol>
<ul>
<li><strong>Name</strong> <em>(of the Resource Bridge resource)</em></li>
<li>Select the <strong>region</strong> for your Metadata</li>
<li>Create a <a href="https://learn.microsoft.com/en-us/azure/azure-arc/kubernetes/custom-locations?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Create and manage custom locations on Azure Arc-enabled Kubernetes"><strong>Custom Location</strong></a><em>(that matches your on-premises location, where your resources are stored, i.e. could be a data centre prefix that matches your naming convention)</em></li>
<li>Enter in the <strong>name</strong> of your <strong>vCenter</strong> resource <em>(this will represent your vCenter in Azure, so make sure it is easily identifiable)</em></li>
</ul>
<ol>
<li>
<p><img decoding="async" loading="lazy" alt="Azure Arc - vCenter" src="/assets/images/azure_arc_vmware_portal_createresourcesbridge-e81ff5b8b6d31e9f0b733545ecb99a83.png" title="Azure Arc - vCenter" width="826" height="812" class="img_ev3q"></p>
</li>
<li>
<p>Click <strong>Next: Tags</strong></p>
</li>
<li>
<p>A list of default tags has been supplied; feel free to enter or change these to suit your environment.</p>
</li>
<li>
<p><img decoding="async" loading="lazy" alt="Azure Arc - vCenter" src="/assets/images/azure_arc_vmware_portal_createresourcesbridgetags-e000ec87637765de71baa9428d57589a.png" title="Azure Arc - vCenter" width="839" height="688" class="img_ev3q"></p>
</li>
<li>
<p>Click <strong>Next: Download and run the script.</strong></p>
</li>
<li>
<p>Click on <strong>Register</strong> to register the Azure Arc Provider to your subscription. Please wait for this process to complete <em>(it may take a minute or two, you will see: Successfully register your subscription(s) when completed)</em>.</p>
</li>
<li>
<p>Once completed, <strong>download</strong> the <strong>onboarding</strong> PowerShell <strong>script</strong></p>
</li>
<li>
<p><strong>Run</strong> the PowerShell <strong>script</strong> from a computer that has access to Azure and vCenter. This script will download the necessary dependencies <em>(Azure CLI, Python)</em> and, if necessary, authenticate to Azure.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">./resource-bridge-onboarding-script.ps1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>When the script runs, you will be prompted for the following information.</p>
<ul>
<li><strong>Proxy</strong> information <em>(if the Workstation is behind a proxy)</em></li>
<li><strong>UAC</strong> <em>(User Access Control)</em> <strong>approval</strong> for the script to install Azure CLI/Python on the workstation</li>
<li><strong>Azure authentication</strong></li>
<li><strong>vCenter</strong> FQDN/<strong>Address</strong></li>
<li><strong>vCenter Username</strong> &amp; <strong>Password</strong></li>
<li><strong>vCenter datastore</strong></li>
<li><strong>vCenter folder</strong> <em>(to place the template in)</em></li>
<li><strong>IP address</strong></li>
</ul>
</li>
<li>
<p><img decoding="async" loading="lazy" alt="Azure Arc - vCenter Onboarding" src="/assets/images/deploy-azurearcbridge-ed3a9634b0646dde9c2901deeb84dd01.gif" title="Azure Arc - vCenter Onboarding" width="1118" height="654" class="img_ev3q"></p>
</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="link-vcenter-to-azure-arc">Link vCenter to Azure Arc<a href="#link-vcenter-to-azure-arc" class="hash-link" aria-label="Direct link to Link vCenter to Azure Arc" title="Direct link to Link vCenter to Azure Arc">​</a></h4>
<p>You may not need to do the below, but my Bridge was in a &#x27;running&#x27; state but hadn&#x27;t added in the connection to vCenter.</p>
<ol>
<li>Log in to the <strong>Azure Portal</strong></li>
<li>In the search box up the top, type in: <strong>Azure Arc</strong></li>
<li>Click <strong>Azure Arc</strong></li>
<li>Click on: <strong>Resource bridges (preview)</strong></li>
<li>Click on your Azure Arc Bridge and <strong>verify</strong> the <strong>status</strong> is &#x27;<strong>Running</strong>&#x27; <em>(if it is not, make sure it has been started on-premises)</em></li>
<li>In the Azure Portal, click on <strong>VMWare vCenters (preview)</strong></li>
<li>Click <strong>Add</strong></li>
<li>Click <strong>Use an existing resource bridge</strong></li>
<li>Click <strong>Next: Basics</strong></li>
<li>Create your <strong>Custom Location</strong>, then <strong>enter</strong> in the on-premises <strong>vCenter</strong> details</li>
<li><img decoding="async" loading="lazy" alt="Azure Arc - vCenter Onboarding" src="/assets/images/azure_arc_vmware_portal_bridge_vcenter-8ba9b982516feea46403f067989aba72.png" title="Azure Arc - vCenter Onboarding" width="856" height="740" class="img_ev3q"></li>
<li>On the next blade, enter in your appropriate <strong>Tags,</strong> then click <strong>Create</strong></li>
<li>Wait for the deployment to complete; this could take 2-5 minutes.</li>
<li>In the search box up the top, type in: <strong>Azure Arc</strong></li>
<li>Click <strong>Azure Arc</strong></li>
<li>Click on: <strong>VMware vCenters (preview)</strong></li>
<li>You should now see your vSphere instance in a Connected state.</li>
<li><img decoding="async" loading="lazy" alt="Azure Arc - vCenter" src="/assets/images/azure_arc_vmware_portal_bridge_vcenterdeployed-7261215b6c776103c5e0d97f2bda2d6f.png" title="Azure Arc - vCenter" width="1522" height="615" class="img_ev3q"></li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="enable-vcenter-resources-to-be-managed-in-microsoft-azure">Enable vCenter resources to be managed in Microsoft Azure<a href="#enable-vcenter-resources-to-be-managed-in-microsoft-azure" class="hash-link" aria-label="Direct link to Enable vCenter resources to be managed in Microsoft Azure" title="Direct link to Enable vCenter resources to be managed in Microsoft Azure">​</a></h4>
<p>Now that the Bridge has been created, we need to allow resources <em>(such as Virtual Machines, Datastores,  Networks)</em>.</p>
<ol>
<li>Log in to the <strong>Azure Portal</strong></li>
<li>In the search box up the top, type in: <strong>Azure Arc</strong></li>
<li>Click <strong>Azure Arc</strong></li>
<li>Click on: <strong>VMware vCenters (preview)</strong></li>
<li>Click on your <strong>vCenter instance</strong></li>
<li>Under vCenter Inventory, select <strong>Virtual Machines</strong></li>
<li><img decoding="async" loading="lazy" alt="Azure Arc - vCenter" src="/assets/images/azure_arc_vsphere_vm-1d224a3ec54342ba86a8d4c375bd14ca.png" title="Azure Arc - vCenter" width="1122" height="826" class="img_ev3q"></li>
<li>Select the Virtual Machines you want to enable for management in Azure and click &#x27;<strong>Enable in Azure</strong>&#x27;</li>
<li>Select your applicable Subscription and Resource Group (this is where the Azure Arc VM resources will be placed)</li>
<li>Make sure &#x27;<strong>Enable Guest management</strong>&#x27; is selected.</li>
<li>Enter in your Administrator <em>(this is the Admin Username and password of the workloads you want to install the Azure guest management too)</em></li>
<li><img decoding="async" loading="lazy" alt="Azure Arc - On-premises VM" src="/assets/images/azure_arc_vsphere_vmguestagent-0dc9d76a22dd2a5ef9c2af97e223c9ab.png" title="Azure Arc - On-premises VM" width="1102" height="755" class="img_ev3q"></li>
<li>Click <strong>Enable</strong></li>
<li>It can take a few minutes to onboard these clients. If it fails, pick a single Virtual Machine and attempt to onboard that.</li>
<li>You can now repeat the process to onboard Networks, Resource Pools etc.</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="manage-virtual-machines-in-microsoft-azure">Manage Virtual Machines in Microsoft Azure<a href="#manage-virtual-machines-in-microsoft-azure" class="hash-link" aria-label="Direct link to Manage Virtual Machines in Microsoft Azure" title="Direct link to Manage Virtual Machines in Microsoft Azure">​</a></h3>
<p>Now that you have set up an Azure Arc Bridge and onboarded vCenter resources. You can now see and manage your vCenter Virtual Machines in Azure, examples below.</p>
<ul>
<li>Ensure that you have VMWare Tools installed and up-to-date to help full functionality, such as Restart, or there may be issues managing these.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="stopstop-virtual-machines">Stop/Stop Virtual Machines<a href="#stopstop-virtual-machines" class="hash-link" aria-label="Direct link to Stop/Stop Virtual Machines" title="Direct link to Stop/Stop Virtual Machines">​</a></h4>
<p><img decoding="async" loading="lazy" alt="Azure Arc - Start/Stop VM" src="/assets/images/startstopvm-azurearcbridge-b93358fa9aa6af44456593db385a6b70.gif" title="Azure Arc - Start/Stop VM" width="1846" height="635" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="resize-virtual-machines---cpumemory">Resize Virtual Machines - CPU/Memory<a href="#resize-virtual-machines---cpumemory" class="hash-link" aria-label="Direct link to Resize Virtual Machines - CPU/Memory" title="Direct link to Resize Virtual Machines - CPU/Memory">​</a></h4>
<p><img decoding="async" loading="lazy" alt="Azure Arc - Resize VM" src="/assets/images/resizevm-azurearcbridge-a87f8ffb8b70cf1d8c387ef88c6a5a55.gif" title="Azure Arc - Resize VM" width="2023" height="635" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="resize-virtual-machines---disk">Resize Virtual Machines - Disk<a href="#resize-virtual-machines---disk" class="hash-link" aria-label="Direct link to Resize Virtual Machines - Disk" title="Direct link to Resize Virtual Machines - Disk">​</a></h4>
<p><img decoding="async" loading="lazy" alt="Azure Arc - Resize Disk" src="/assets/images/resizevmdisk-azurearcbridge-62493fc1cb21cde8ebcabdcaf16d576c.gif" title="Azure Arc - Resize Disk" width="2549" height="655" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="troubleshooting">Troubleshooting<a href="#troubleshooting" class="hash-link" aria-label="Direct link to Troubleshooting" title="Direct link to Troubleshooting">​</a></h3>
<ul>
<li>The &#x27;resource-bridge-onboarding-script.ps1&#x27; script contains an output file, named: arcvmware-output.log. This log file exists in the same directory as the script and is useful for investigating any errors.</li>
<li>If you get no Folders, listed when the script prompts you to select a folder <em>(i.e. Please select folder)</em>:</li>
</ul>
<ol>
<li>Right-click the Datacenter in vSphere</li>
<li>Select New Folder</li>
<li>Select New VM and Templates folder</li>
<li>Create a folder</li>
</ol>
<ul>
<li>If your Center becomes unavailable, it is most likely because you specified the same IP for the Azure Arc Appliance; if this is the case, log in to the host containing your Azure Arc Bridge and stop/delete the resources from the disk and remove from inventory. Then rerun deployment, this time selecting an appropriate IP.</li>
</ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/azure/">Azure</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/2022/03/27/create-a-site-to-site-vpn-to-azure-with-a-ubiquiti-dream-machine-pro/">Create a Site to Site VPN to Azure with a Ubiquiti Dream Machine Pro</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-03-27T00:00:00.000Z">March 27, 2022</time> · <!-- -->7 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://luke.geek.nz/img/logo.png" alt="Luke Murray"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">Luke Murray</span></a></div><small class="authorTitle_nd0D" title="Author">Author</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><p>The Ubiquiti <a href="https://store.ui.com/collections/unifi-network-unifi-os-consoles/products/udm-pro" target="_blank" rel="noopener noreferrer" title="Dream Machine Pro">Dream Machine Pro</a> has a lot of functionality built-in, including IPsec Site-to-site VPN_(Virtual Private Network)_ support.</p>
<p>I recently installed and configured a UDM-PRO at home, so now it&#x27;s time to set up a site-to-vpn to my Microsoft Azure network.</p>
<p>I will create Virtual Network and Gateway resources using Azure Bicep, but please skip ahead.</p>
<p>My address range is as follows <em>(so make sure you adjust to match your setup and IP ranges)</em>:</p>













<table><thead><tr><th>On-premises</th><th>Azure</th></tr></thead><tbody><tr><td>192.168.1.0/24</td><td>10.0.0.0/16</td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="prerequisites">Prerequisites<a href="#prerequisites" class="hash-link" aria-label="Direct link to Prerequisites" title="Direct link to Prerequisites">​</a></h4>
<ul>
<li>The latest <a href="https://learn.microsoft.com/en-us/powershell/azure/install-az-ps?view=azps-7.1.0?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure PowerShell</a> modules and <a href="https://learn.microsoft.com/en-us/azure/azure-resource-manager/bicep/install?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Bicep/Azure CLI</a> for local editing</li>
<li>An Azure subscription that you have at least contributor rights to</li>
<li>Permissions to the UDM Pro to set up a new network connection</li>
</ul>
<p>I will be using PowerShell <a href="https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_splatting?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Splatting">splatting</a> as it&#x27;s easier to edit and display. You can easily take the scripts here to make them your own.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="deploy---azure-network-and-virtual-network-gateway">Deploy - Azure Network and Virtual Network Gateway<a href="#deploy---azure-network-and-virtual-network-gateway" class="hash-link" aria-label="Direct link to Deploy - Azure Network and Virtual Network Gateway" title="Direct link to Deploy - Azure Network and Virtual Network Gateway">​</a></h4>
<p>I will assume that you have both <a href="https://learn.microsoft.com/en-us/azure/azure-resource-manager/bicep/install#windows?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Azure Bicep - Install">Azure Bicep</a> and<a href="https://learn.microsoft.com/en-us/powershell/azure/install-az-ps?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="PowerShell - Azure">PowerShell Azure</a> modules installed and the know-how to connect to Microsoft Azure.</p>
<p>Azure Bicep deployments <em>(like ARM)</em> have the following command: &#x27;TemplateParameterObject&#x27;. &#x27;TemplateParameterObject&#x27; allows Azure Bicep to accept parameters from PowerShell directly, which can be pretty powerful when used with a self-service portal or pipeline.</p>
<p>I will first make an Azure Resource Group using PowerShell for my Azure Virtual Network, then use the New-AzResourceGroupDeployment cmdlet to deploy my Virtual Network and subnets from my bicep file.</p>
<p>Along with the Virtual Network, we will also create 2 other Azure resources needed for a Site to Site VPN, a <a href="https://learn.microsoft.com/en-us/azure/vpn-gateway/tutorial-site-to-site-portal?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Tutorial: Create a site-to-site VPN connection in the Azure portal">Local Network Gateway</a> _(this will represent your on-premises subnet and external IP to assist with routing)_and a <a href="https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpngateways?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="What is VPN Gateway?">Virtual Network Gateway</a> <em>(which is used to send encrypted traffic over the internet between your on-premises site(s) and Azure)</em>.</p>
<p>Update the parameters of the PowerShell script below, to match your own needs, and you may need to edit the Bicep file itself to add/remove subnets and change the IP address space to match your standards.</p>
<p>The shared key will be used between the UDM Pro and your Azure network; make sure this is unique.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">#Connects to Azure</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Connect-AzAccount</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#Resource Group Name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$resourcegrpname = &#x27;network_rg&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#Creates a resource group for the storage account</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">New-AzResourceGroup -Name $resourcegrpname -Location &#x27;AustraliaEast&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Parameters splat, for Azure Bicep</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Parameter options for the Azure Bicep Template, this is where your Azure Bicep parameters go</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$paramObject = @{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&#x27;sitecode&#x27; = &#x27;luke&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&#x27;environment&#x27; = &#x27;prod&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&#x27;contactEmail&#x27; = &#x27;email@luke.geek.nz&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&#x27;sharedkey&#x27; = &#x27;18d5b51a17c68a42d493651bed88b73234bbaad0&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&#x27;onpremisesgwip&#x27; = &#x27;123.456.789.101&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&#x27;onpremisesaddress&#x27; = &#x27;192.168.1.0/24&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Parameters for the New-AzResourceGroupDeployment cmdlet goes into.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$parameters = @{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&#x27;Name&#x27; = &#x27;AzureNetwork-S2S&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&#x27;ResourceGroupName&#x27; = $resourcegrpname</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&#x27;TemplateFile&#x27; = &#x27;c:\temp\Deploy-AzVNETS2S.bicep&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&#x27;TemplateParameterObject&#x27; = $paramObject</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&#x27;Verbose&#x27; = $true</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#Deploys the Azure Bicep template</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">New-AzResourceGroupDeployment @parameters -WhatIf</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Note: The <em>&#x27;</em><a href="https://learn.microsoft.com/en-us/azure/azure-resource-manager/bicep/deploy-what-if?tabs=azure-powershell%2CCLI?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Bicep deployment what-if operation"><em>-whatif</em></a>&#x27; parameter has been added as a safeguard, so once you know the changes are suitable, then remove and rerun.</p>
<p>The Virtual Network Gateway can take 20+ minutes to deploy, leave the Terminal/PowerShell window open, you can also check the Deployment in the Azure Portal <em>(Under Deployments panel in the Resource Group)</em>.</p>
<p><img decoding="async" loading="lazy" alt="Azure Portal - Resource Group Deployments" src="/assets/images/vnet-deployments2svpnazportal-00f3d6d0c4cda436390bb1c99d53d621.png" title="Azure Portal - Resource Group Deployments" width="1076" height="368" class="img_ev3q"></p>
<p>The Azure Bicep file is located here:</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">Deploy-AzVNETS2S.bicep</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">targetScope</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;resourceGroup&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">///Parameter and Variable Setting</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token decorator">@minLength</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">3</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token decorator">@maxLength</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">6</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> sitecode </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> environment </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> contactEmail </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> resourceTags </span><span class="token datatype class-name">object</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">Application</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Azure Infrastructure Management&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">CostCenter</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Operational&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">CreationDate</span><span class="token operator">:</span><span class="token plain"> dateTime</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">Environment</span><span class="token operator">:</span><span class="token plain"> environment</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">CreatedBy</span><span class="token operator">:</span><span class="token plain"> contactEmail</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">Notes</span><span class="token operator">:</span><span class="token plain"> </span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">&#x27;Created on behalf of: </span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">sitecode</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)"> for their Site to Site VPN.&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> dateTime </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">utcNow</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;d&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> location </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">resourceGroup</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">location</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> sharedkey </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> onpremisesaddress </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> onpremisesgwip </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">//Resource Naming Parameters</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> virtualNetworks_vnet_name </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">&#x27;</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">sitecode</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">-vnet&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> connections_S2S_Connection_Home_name </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;S2S_Connection_Home&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> publicIPAddresses_virtualngw_prod_name </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">&#x27;</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">sitecode</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">-pip-vngw-</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">environment</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> localNetworkGateways_localngw_prod_name </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">&#x27;</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">sitecode</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">-localngw-</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">environment</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> virtualNetworkGateways_virtualngw_prod_name </span><span class="token datatype class-name">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">&#x27;</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">sitecode</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">-virtualngw-</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">environment</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> localNetworkGateways_localngw_prod_name_resource </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Microsoft.Network/localNetworkGateways@2020-11-01&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> localNetworkGateways_localngw_prod_name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">location</span><span class="token operator">:</span><span class="token plain"> location</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">localNetworkAddressSpace</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">addressPrefixes</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        onpremisesaddress</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">gatewayIpAddress</span><span class="token operator">:</span><span class="token plain"> onpremisesgwip</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> publicIPAddresses_virtualngw_prod_name_resource </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Microsoft.Network/publicIPAddresses@2020-11-01&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> publicIPAddresses_virtualngw_prod_name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">tags</span><span class="token operator">:</span><span class="token plain"> resourceTags</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">location</span><span class="token operator">:</span><span class="token plain"> location</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">sku</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Standard&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">tier</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Regional&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">publicIPAddressVersion</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;IPv4&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">publicIPAllocationMethod</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Static&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">idleTimeoutInMinutes</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">ipTags</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> virtualNetworks_vnet_name_resource </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Microsoft.Network/virtualNetworks@2020-11-01&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> virtualNetworks_vnet_name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">location</span><span class="token operator">:</span><span class="token plain"> location</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">tags</span><span class="token operator">:</span><span class="token plain"> resourceTags</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">addressSpace</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">addressPrefixes</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;10.0.0.0/16&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">subnets</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;GatewaySubnet&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">addressPrefix</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;10.0.0.0/26&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">delegations</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">privateEndpointNetworkPolicies</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Enabled&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">privateLinkServiceNetworkPolicies</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Enabled&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;AzureBastionSubnet&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">addressPrefix</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;10.0.0.64/27&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">delegations</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">privateEndpointNetworkPolicies</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Enabled&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">privateLinkServiceNetworkPolicies</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Enabled&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;AzureFirewallSubnet&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">addressPrefix</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;10.0.0.128/26&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">delegations</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">privateEndpointNetworkPolicies</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Enabled&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">privateLinkServiceNetworkPolicies</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Enabled&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;appservers&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">addressPrefix</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;10.0.2.0/24&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">delegations</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">privateEndpointNetworkPolicies</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Enabled&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">privateLinkServiceNetworkPolicies</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Enabled&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">virtualNetworkPeerings</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">enableDdosProtection</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> virtualNetworks_vnet_name_appservers </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Microsoft.Network/virtualNetworks/subnets@2020-11-01&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">parent</span><span class="token operator">:</span><span class="token plain"> virtualNetworks_vnet_name_resource</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;appservers&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">addressPrefix</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;10.0.2.0/24&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">delegations</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">privateEndpointNetworkPolicies</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Enabled&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">privateLinkServiceNetworkPolicies</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Enabled&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> virtualNetworks_vnet_name_AzureBastionSubnet </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Microsoft.Network/virtualNetworks/subnets@2020-11-01&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">parent</span><span class="token operator">:</span><span class="token plain"> virtualNetworks_vnet_name_resource</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;AzureBastionSubnet&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">addressPrefix</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;10.0.0.64/27&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">delegations</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">privateEndpointNetworkPolicies</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Enabled&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">privateLinkServiceNetworkPolicies</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Enabled&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> virtualNetworks_vnet_name_AzureFirewallSubnet </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Microsoft.Network/virtualNetworks/subnets@2020-11-01&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">parent</span><span class="token operator">:</span><span class="token plain"> virtualNetworks_vnet_name_resource</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;AzureFirewallSubnet&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">addressPrefix</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;10.0.0.128/26&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">delegations</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">privateEndpointNetworkPolicies</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Enabled&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">privateLinkServiceNetworkPolicies</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Enabled&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> virtualNetworks_vnet_name_GatewaySubnet </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Microsoft.Network/virtualNetworks/subnets@2020-11-01&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">parent</span><span class="token operator">:</span><span class="token plain"> virtualNetworks_vnet_name_resource</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;GatewaySubnet&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">addressPrefix</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;10.0.0.0/26&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">delegations</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">privateEndpointNetworkPolicies</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Enabled&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">privateLinkServiceNetworkPolicies</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Enabled&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> connections_S2S_Connection_Home_name_resource </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Microsoft.Network/connections@2020-11-01&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> connections_S2S_Connection_Home_name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">location</span><span class="token operator">:</span><span class="token plain"> location</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">virtualNetworkGateway1</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">id</span><span class="token operator">:</span><span class="token plain"> virtualNetworkGateways_virtualngw_prod_name_resource</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">id</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">localNetworkGateway2</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">id</span><span class="token operator">:</span><span class="token plain"> localNetworkGateways_localngw_prod_name_resource</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">id</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">connectionType</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;IPsec&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">connectionProtocol</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;IKEv2&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">routingWeight</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">sharedKey</span><span class="token operator">:</span><span class="token plain"> sharedkey</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">enableBgp</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">useLocalAzureIpAddress</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">usePolicyBasedTrafficSelectors</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">ipsecPolicies</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">trafficSelectorPolicies</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">expressRouteGatewayBypass</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">dpdTimeoutSeconds</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">connectionMode</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Default&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> virtualNetworkGateways_virtualngw_prod_name_resource </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Microsoft.Network/virtualNetworkGateways@2020-11-01&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> virtualNetworkGateways_virtualngw_prod_name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">location</span><span class="token operator">:</span><span class="token plain"> location</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">enablePrivateIpAddress</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">ipConfigurations</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;default&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">privateIPAllocationMethod</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Dynamic&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">publicIPAddress</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">id</span><span class="token operator">:</span><span class="token plain"> publicIPAddresses_virtualngw_prod_name_resource</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">id</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">subnet</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">id</span><span class="token operator">:</span><span class="token plain"> virtualNetworks_vnet_name_GatewaySubnet</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">id</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">sku</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;VpnGw2&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">tier</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;VpnGw2&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">gatewayType</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Vpn&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">vpnType</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;RouteBased&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">enableBgp</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">activeActive</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">bgpSettings</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">asn</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">65515</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">bgpPeeringAddress</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;10.0.0.62&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">peerWeight</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">vpnGatewayGeneration</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Generation2&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Once deployed, run the following command to capture and copy the Gateway Public IP:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Get-AzPublicIPAddress | Select-Object Name, IpAddress </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Copy the Public IP, we will need this for configuring the UDM Pro, this would have been generated dynamically.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="configure---ubiquiti-dream-machine-pro">Configure - Ubiquiti Dream Machine Pro<a href="#configure---ubiquiti-dream-machine-pro" class="hash-link" aria-label="Direct link to Configure - Ubiquiti Dream Machine Pro" title="Direct link to Configure - Ubiquiti Dream Machine Pro">​</a></h4>
<ol>
<li>
<p><strong>Login</strong> to the <strong>UDM-Pro</strong></p>
</li>
<li>
<p><img decoding="async" loading="lazy" alt="Unifi OS" src="/assets/images/udm-pro_unifi-os-bdb2512186eb2bb3bfb27c8a55525932.png" title="UDM Pro Unifi OS" width="449" height="654" class="img_ev3q"></p>
</li>
<li>
<p>Click on <strong>Network</strong> <em>(under Applications heading)</em></p>
</li>
<li>
<p>Click <strong>Settings</strong> <em>(Gear icon)</em></p>
</li>
<li>
<p><img decoding="async" loading="lazy" alt="Unifi OS - Network" src="/assets/images/udm-pro_networksettings-2aea153dcc5b2db42e6dc328b96d3bac.png" title="UDM Pro Unifi OS" width="341" height="538" class="img_ev3q"></p>
</li>
<li>
<p>Click <strong>VPN</strong></p>
</li>
<li>
<p><img decoding="async" loading="lazy" alt="UDM Pro Unifi OS - VPN" src="/assets/images/udm-pro_vpn_s2svpn-b66b7d7f8ed7a452e2c8f902af3fcea7.png" title="UDM Pro Unifi OS - VPN" width="1376" height="934" class="img_ev3q"></p>
</li>
<li>
<p>Scroll down and click <strong>+ Create Site-to site-VPN</strong></p>
</li>
<li>
<p>Fill in the following information:</p>
<ul>
<li><strong>Network Name</strong><em>(ie Azure - SYD)</em></li>
<li><strong>VPN Protocol</strong> <em>(select Manual IPsec)</em></li>
<li><strong>Pre-shared Key</strong> <em>(enter in the SAME key that was used by Azure Bicep to create the Connection - if you have lost it, it can be updated in Azure, under Shared key on the connection attached to the Virtual network gateway, but will stop any other VPN connections using the old key)</em></li>
<li><strong>Server Address</strong> <em>(make sure you select the interface for your WAN/External IP)</em></li>
<li><strong>Remote</strong> Gateway/<strong>Subnets</strong> <em>(Enter in the Address Prefix of your Azure virtual network or subnets, remember to add any peered virtual networks and Press Enter)</em></li>
<li><strong>Remote IP Address</strong> <em>(Enter in the Public IP of the Virtual Network gateway, the same IP retrieved by Get-AzPublicIPAddress cmdlet )</em></li>
</ul>
</li>
<li>
<p><img decoding="async" loading="lazy" alt="UDM Pro - Azure S2S VPN" src="/assets/images/udmpro_s2svpnsettings1-5abc4266b7a8bc676d5598f76c08b8a4.png" title="UDM Pro - Azure S2S VPN" width="914" height="653" class="img_ev3q"></p>
</li>
<li>
<p>Select <strong>Manual</strong></p>
</li>
<li>
<p><img decoding="async" loading="lazy" alt="UDM Pro - Azure S2S VPN" src="/assets/images/udmpro_s2svpnsettings2-2bed9cfa9f1b1b3fab388ecf384dd129.png" title="UDM Pro - Azure S2S VPN" width="840" height="542" class="img_ev3q"></p>
<p>Select <strong>IPSec Profile</strong>, and select <strong>Azure Dynamic Routing</strong></p>
</li>
<li>
<p>Click <strong>Apply Changes</strong></p>
</li>
</ol>
<p>After a few minutes, the VPN should become connected and you should be able to connect to devices on the Azure Network using their private IP address.</p>
<p>If you have problems, make sure that the Gateway IPs line up and are correct, along with the pre-shared key.  You can also Pause the Network from the UDM-Pro and Resume to reinitiate the connection.</p>
<p>You can also troubleshoot the VPN connection, from the Azure Portal, by navigating the Virtual network gateway and selecting VPN Troubleshoot.</p>
<p><img decoding="async" loading="lazy" alt="Azure Portal - VPN Troubleshoot" src="/assets/images/azureportal_vpntroubleshoot-e13f4777d68002f8004727c5fcdf5d48.png" title="Azure Portal - VPN Troubleshoot" width="1189" height="885" class="img_ev3q"></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/azure/">Azure</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/2022/03/16/azure-optimisation-engine/">Azure Optimization Engine</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-03-16T00:00:00.000Z">March 16, 2022</time> · <!-- -->21 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://luke.geek.nz/img/logo.png" alt="Luke Murray"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">Luke Murray</span></a></div><small class="authorTitle_nd0D" title="Author">Author</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><p>This post is a part of <a href="https://www.azurespringclean.com/" target="_blank" rel="noopener noreferrer">Azure Spring Clean</a>, which is a community event focused on Azure management topics from March 14-18, 2022.</p>
<p>Thanks to <a href="https://twitter.com/wedoazure" target="_blank" rel="noopener noreferrer">Joe Carlyle</a> and <a href="https://twitter.com/tamstar1234" target="_blank" rel="noopener noreferrer">Thomas Thornton</a> for putting in the time and organising this event.</p>
<p>This article, along with others of its kind <em>(Articles, Videos etc.),</em> cover Azure Management topics such as Azure Monitor, Azure Cost Management, Azure Policy, Azure Security Principles or Azure Foundations!</p>
<p>Today I will be covering the <a href="https://github.com/helderpinto/AzureOptimizationEngine" target="_blank" rel="noopener noreferrer" title="Azure Optimization Engine">Azure Optimization Engine</a>.</p>
<p><img decoding="async" loading="lazy" alt="#AzureSpringClean - Azure Optimization Engine" src="/assets/images/azurespringclean_2022_aoe-28392a18f272b222d14eafb305ae40f5.png" title="#AzureSpringClean - Azure Optimization Engine" width="2545" height="1429" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">​</a></h3>
<blockquote>
<p>The Azure Optimization Engine <em>(AOE)</em> is an extensible solution designed to generate optimization recommendations for your Azure environment, like a fully customizable Azure Advisor.</p>
<p>The first custom recommendations use-case covered by this tool was augmenting Azure Advisor Cost recommendations, particularly Virtual Machine right-sizing, with a fit score based on VM <em>(Virtual Machine)</em> metrics and properties.</p>
</blockquote>
<p>The Azure Optimization Engine can…</p>
<ul>
<li>Enable new custom recommendation types</li>
<li>Augment Azure Advisor recommendations with richer details that better drive action</li>
<li>Add fit score to recommendations.</li>
<li>Add historical perspective to recommendations <em>(the older the recommendation, the higher the chances to remediate it)</em></li>
<li>Drive continuous automated optimisation</li>
</ul>
<p>Azure Optimisation Engine combines multiple data sources to give you better data-driven decisions and recommendations, outside of that usually deployed by the inbuilt Azure Advisor, example use-cases and data sources can be seen below:</p>
<ul>
<li>Azure Resource Graph <em>(Virtual Machine and Managed Disks properties)</em></li>
<li>Azure Monitor Logs <em>(Virtual Machine performance metrics)</em></li>
<li>Azure Consumption <em>(consumption/billing usage details events)</em></li>
<li>Extracts data periodically to build a recommendations history</li>
<li>Joins and queries data in an analytics-optimised repository <em>(Log Analytics)</em></li>
<li>Virtual Machine performance metrics collected with Log Analytics agent</li>
<li>Can leverage existing customer setup</li>
<li>Requires only a few metrics collected with a frequency &gt;= 60 seconds</li>
</ul>
<blockquote>
<p>Besides collecting <strong>all Azure Advisor recommendations</strong>, AOE includes other custom recommendations that you can tailor to your needs:</p>
<ul>
<li>Cost
<ul>
<li>Augmented Advisor Cost VM right-size recommendations, with fit score based on Virtual Machine guest OS metrics <em>(collected by Log Analytics agents)</em> and Azure properties</li>
<li>Underutilized VM Scale Sets</li>
<li>Unattached disks</li>
<li>Standard Load Balancers without backend pool</li>
<li>Application Gateways without backend pool</li>
<li>VMs deallocated since a long time ago (<em>forgotten VMs)</em></li>
<li>Orphaned Public IPs</li>
</ul>
</li>
<li>High Availability
<ul>
<li>Virtual Machine high availability <em>(availability zones count, availability set, managed disks, storage account distribution when using unmanaged disks)</em></li>
<li>VM Scale Set high availability <em>(availability zones count, managed disks)</em></li>
<li>Availability Sets structure <em>(fault/update domains count)</em></li>
</ul>
</li>
<li>Performance
<ul>
<li>VM Scale Sets constrained by lack of compute resources</li>
</ul>
</li>
<li>Security
<ul>
<li>Service Principal credentials/certificates without expiration date</li>
<li>NSG rules referring to empty or non-existing subnets</li>
<li>NSG rules referring to orphan or removed NICs</li>
<li>NSG rules referring to orphan or removed Public IPs</li>
</ul>
</li>
<li>Operational Excellence
<ul>
<li>Load Balancers without backend pool</li>
<li>Service Principal credentials/certificates expired or about to expire</li>
<li>Subscriptions close to the maximum limit of RBAC <em>(Role Based Access Control)</em> assignments</li>
<li>Management Groups close to the maximum limit of RBAC assignments</li>
<li>Subscriptions close to the maximum limit of resource groups</li>
<li>Subnets with low free IP space</li>
<li>Subnets with too much IP space wasted</li>
<li>Empty subnets</li>
<li>Orphaned NICs</li>
</ul>
</li>
</ul>
</blockquote>
<p>Feel free to skip to the Workbook and PowerBI sections to look at some of the outs of box data and recommendations.</p>
<p>The Azure Optimisation Engine is battle-tested</p>
<ul>
<li>Providing custom recommendations since Nov 2019</li>
<li>Serving Azure customers worldwide</li>
<li>From smaller 50-500 VMs customers to larger ones with more than 5K VMs</li>
<li>Several customer-specific developments (custom collectors and recommendation algorithms)</li>
<li>Flexibility options include <em>(multi-subscription and multi-tenant capability)</em></li>
<li>Based on cheap services <em>(Azure Automation, Storage, small SQL Database</em>)</li>
</ul>
<p>A few hours after setting up the engine, you will get access to a Power BI dashboard and Log Analytic Workbooks with all Azure optimisation opportunities, coming from both Azure Advisor and tailored recommendations included in the engine.</p>
<p>These recommendations are then updated every seven days.</p>
<blockquote>
<p>It is worth noting that Azure Optimisation Engine is <strong>NOT</strong> an official <strong>Microsoft Product,</strong> and as such is under no offical support, it was created and maintened by: Hélder Pinto, a Senior Customer Engineer for Microsoft and would like to take the opportunity to thank Hélder the amazing work he is doing with this product on a continous basis, and giving me his blessing to write this article, on which he has already done an amazing job documenting on Github.</p>
</blockquote>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="architecture">Architecture<a href="#architecture" class="hash-link" aria-label="Direct link to Architecture" title="Direct link to Architecture">​</a></h4>
<p><img decoding="async" loading="lazy" alt="Azure Optimization Engine Architecture" src="/assets/images/architecture-a9d4dd501d8f97d571f6dc0d927227c1.jpg" title="Azure Optimization Engine Architecture" width="786" height="360" class="img_ev3q"></p>
<p>Azure Optimization Engine runs on top of Azure Automation <em>(Runbooks for each data source)</em> and Log Analytics. It is supplemented by a storage account to store JSON and Azure SQL database to help control ingestion <em>(last processed blob and lines processed)</em>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="install">Install<a href="#install" class="hash-link" aria-label="Direct link to Install" title="Direct link to Install">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="prerequisites">Prerequisites<a href="#prerequisites" class="hash-link" aria-label="Direct link to Prerequisites" title="Direct link to Prerequisites">​</a></h4>
<p>Taken directly from the Git repository readme, the prerequisite for Azure Optimization Engine are:</p>
<ul>
<li>A supported Azure subscription <em>(see the</em> <a href="https://github.com/helderpinto/AzureOptimizationEngine#faq" target="_blank" rel="noopener noreferrer"><em>FAQs</em></a><em>on Github)</em></li>
<li><a href="hhttps://learn.microsoft.com/en-us/powershell/azure/install-az-ps?view=azps-7.5.0&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Install the Azure Az PowerShell module">Azure Powershell 6.6.0+</a><em>(Azure Bicep support is not currently available but is being worked on)</em>.</li>
<li><a href="https://learn.microsoft.com/en-us/powershell/microsoftgraph/installation?view=graph-powershell-beta&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title=" Microsoft.Graph.Authentication ">Microsoft.Graph.Authentication</a> and <a href="https://learn.microsoft.com/en-us/powershell/microsoftgraph/installation?view=graph-powershell-beta&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Microsoft.Graph.Identity.DirectoryManagement">Microsoft.Graph.Identity.DirectoryManagement</a> PowerShell modules</li>
<li>A user account with Owner permissions over the chosen subscription, so that the Automation Managed Identity is granted the required privileges over the subscription (Reader) and deployment resource group <em>(Contributor)</em></li>
<li><em>(Optional)</em> A user account with at least Privileged Role Administrator permissions over the Azure AD tenant, so that the Managed Identity is granted the required privileges over Azure AD <em>(Global Reader)</em></li>
</ul>
<p>During deployment, you&#x27;ll be asked several questions. It would be best if you planned for the following:</p>
<ul>
<li>Whether you&#x27;re going to reuse an existing Log Analytics Workspace or create a new one. <strong>IMPORTANT</strong>: you should ideally reuse a workspace where you have VMs onboarded and already sending performance metrics <em>(<code>Perf</code> table)</em>; otherwise, you will not fully leverage the augmented right-size recommendations capability. If this is not possible/desired for some reason, you can still manage to use multiple workspaces <em>(see</em> <a href="https://github.com/helderpinto/AzureOptimizationEngine/blob/master/docs/configuring-workspaces.md" target="_blank" rel="noopener noreferrer"><em>Configuring Log Analytics workspaces</em></a><em>)</em>.</li>
<li>An Azure subscription to deploy the solution <em>(if you&#x27;re reusing a Log Analytics workspace, you must deploy into the same subscription the workspace is in).</em></li>
<li>A unique name prefix for the Azure resources being created (if you have specific naming requirements, you can also choose resource names during deployment)</li>
<li>Azure region</li>
</ul>
<p>If the deployment fails for some reason, you can repeat it, as it is idempotent <em>(i.e. they can be applied multiple times without changing the result)</em>. The exact process is used to upgrade a previous deployment with the latest version. You have to keep the same deployment options, so make sure you document them.</p>
<p>We will now go through and install the prerequisites from scratch; as in this article, I will be deploying the Azure Optimization Engine from our local workstation.</p>
<p>You can also install from the <a href="https://luke.geek.nz/azure/setup-azure-cloud-shell/" target="_blank" rel="noopener noreferrer" title="Azure Cloud Shell">Azure Cloud Shell,</a></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="install-azure-powershell--microsoft-graph-modules">Install Azure PowerShell &amp; Microsoft Graph modules<a href="#install-azure-powershell--microsoft-graph-modules" class="hash-link" aria-label="Direct link to Install Azure PowerShell &amp; Microsoft Graph modules" title="Direct link to Install Azure PowerShell &amp; Microsoft Graph modules">​</a></h5>
<ol>
<li>
<p>Open Windows PowerShell</p>
</li>
<li>
<p>Type in:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Install-Module -Name Az,Microsoft.Graph.Authentication,Microsoft.Graph.Identity.DirectoryManagement -Scope CurrentUser -Repository PSGallery -Force</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="install-1">Install<a href="#install-1" class="hash-link" aria-label="Direct link to Install" title="Direct link to Install">​</a></h4>
<p>Now that we have the prerequisites installed! Let&#x27;s set up Azure Optimization Engine!</p>
<ol>
<li>
<p>In your favourite web browser, <strong>navigate</strong> to the <a href="https://github.com/helderpinto/AzureOptimizationEngine" target="_blank" rel="noopener noreferrer" title="https://github.com/helderpinto/AzureOptimizationEngine"><strong>AzureOptimizationEngine</strong></a> GitHub repository.</p>
</li>
<li>
<p>Select <strong>Code</strong>, <strong>Download Zip</strong></p>
</li>
<li>
<p><img decoding="async" loading="lazy" alt="Azure Optimization Engine - GitHub" src="/assets/images/2022-03-12-09_23_49-helderpinto_azureoptimizationengine_-the-azure-optimization-engine-is-an-extensi-bcef43692efcf0dfe56e6918137b48ee.png" title="Azure Optimization Engine - GitHub" width="425" height="359" class="img_ev3q"></p>
</li>
<li>
<p><strong>Download</strong> and <strong>extract</strong> the ZIP file to a location you can easily navigate to in PowerShell (<em>I have extracted it to C:\temp\AzureOptimizationEngine-master\AzureOptimizationEngine-master)</em></p>
</li>
<li>
<p>Open PowerShell <em>(or Windows Terminal)</em></p>
</li>
<li>
<p>Because the scripts were downloaded from the internet, we will need to <strong>Unblock</strong> these so that we can run them, open PowerShell and run the <strong>script</strong> below <em>(changing your path to the path that the files were extracted)</em></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Get-ChildItem -r &#x27;C:\temp\AzureOptimizationEngine-master\AzureOptimizationEngine-master&#x27; | Unblock-File</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>Now that the script and associated files have been unblocked <strong>change</strong> the <strong>directory</strong> to the <strong>location</strong> of the Deploy-AzureOptimizationEngine.ps1 <strong>file</strong>.</p>
</li>
<li>
<p>Run: <strong>.\Deploy-AzureOptimizationEngine.ps1</strong></p>
</li>
<li>
<p><img decoding="async" loading="lazy" alt="Windows Terminal -\Deploy-AzureOptimizationEngine.ps1" src="/assets/images/2022-03-12-09_48_40-plex-fc05e1149c5c344be34d84613efbc787.png" title="Windows Terminal -\Deploy-AzureOptimizationEngine.ps1" width="952" height="469" class="img_ev3q"></p>
</li>
<li>
<p>A browser window will then popup, <strong>authenticate to Azure</strong> <em>(connect to the Azure tenant that has access to the Azure subscription you wish to set up Azure Optimization Engine on)</em>.</p>
</li>
<li>
<p>Once authentication, you will need to <strong>confirm</strong> the Azure <strong>subscription</strong> to which you want to deploy Azure Optimization Engine.</p>
</li>
<li>
<p><img decoding="async" loading="lazy" alt="Azure Optimization Engine - Select Subscription" src="/assets/images/aoe-selectazsubscription-9594c8d11829e4fbed4434555ef65053.png" title="Azure Optimization Engine - Select Subscription" width="1005" height="185" class="img_ev3q"></p>
</li>
<li>
<p>Once your subscription is selected, it&#x27;s time to <strong>choose</strong> a <strong>naming prefix</strong> for your resources <em>(if you choose Enter, you can manually name each resource); in</em> my case, my prefix will be: <em>aoegeek.</em> Because Azure Optimization Engine will be creating resources that are globally available, make sure you select a prefix that suits your organisation/use-case as you may run into issues with the name already being used.</p>
</li>
<li>
<p><img decoding="async" loading="lazy" alt="Azure Optimization Engine - Select Region" src="/assets/images/aoe-selectazprefix-bd0db3795e9e239f0fa734b3e08ff0b5.png" title="Azure Optimization Engine - Select Region" width="1251" height="96" class="img_ev3q"></p>
</li>
<li>
<p>If you have an <strong>existing Log Analytics</strong> workspace that your Virtual Machines and resources are connected to, you can specify &#x27;Y&#x27; here to select your existing resource; I am creating this from fresh so that I will choose <strong>&#x27;N.</strong>&#x27;</p>
</li>
<li>
<p><img decoding="async" loading="lazy" alt="Azure Log Analytics" src="/assets/images/aoe-selectazloganalyticworkspace-a9d2a4573f2c9e6a3869399d73fd3393.png" title="Azure Log Analytics" width="637" height="29" class="img_ev3q"></p>
</li>
<li>
<p>The Azure Optimization <strong>Engine will now check that the names and resources are available</strong> to be deployed to your subscriptions and resources <em>(nothing is deployed during this stage - if there is an error, you can fix the issue and go back)</em>.</p>
</li>
<li>
<p>Once validation has passed, <strong>select</strong> the <strong>region</strong> that Azure Optimization will be deployed to; I will deploy to australiaeast, so I choose 1.</p>
</li>
<li>
<p>Azure Optimization Engine now <strong>requires</strong> the <strong>SQL Admin</strong> username; for the SQL server and database it will create, I will go with: sqladmin</p>
</li>
<li>
<p><img decoding="async" loading="lazy" alt="Azure Optimization Engine - Region" src="/assets/images/aoe-selectlocationsql-2f77a2a5c24d2d6226866145ed16b899.png" title="Azure Optimization Engine - Region" width="680" height="495" class="img_ev3q"></p>
</li>
<li>
<p>Now enter the <strong>password</strong> for the <strong>sqladmin</strong> account and press Enter</p>
</li>
<li>
<p>Verify that everything is correct, then press <strong>Y</strong> to deploy Azure Optimization Engine!</p>
</li>
<li>
<p><img decoding="async" loading="lazy" alt="Windows Terminal - Deploy Azure Optimization Engine" src="/assets/images/deploy-azureoptimizationengine-4f5a53915f65769f48c41d735cff59df.gif" title="Windows Terminal - Deploy Azure Optimization Engine" width="1115" height="566" class="img_ev3q"></p>
</li>
<li>
<p>Deployment could take 10-25 minutes... <em>(mine took 22 minutes and 51 seconds)</em></p>
</li>
<li>
<p>While leaving the PowerShell window open, log into the Azure Portal; you should now have a new Resource Group, and your resources will start getting created... you can click on Deployments <em>(under Settings navigation bar)</em> in the Resource Group to review the deployment status.</p>
</li>
<li>
<p><img decoding="async" loading="lazy" alt="Azure Portal - Deployments" src="/assets/images/deploycheck-azureoptimizationengine-599e59e9d3c464022a4c1cff95ed2d10.gif" title="Azure Portal - Deployments" width="1411" height="566" class="img_ev3q"></p>
</li>
<li>
<p>If you notice a failure, in the Deployment tab for: &#x27;PolicyDeployment&#x27; you can ignore this, as it may have failed if the SQL Server hasn&#x27;t been provisioned yet; once it has been provisioned, you can navigate back to this failed deployment and click &#x27;Redeploy&#x27;, to deploy a SQL Security Alert policy.</p>
</li>
</ol>
<p><em>Note: The Azure SQL database will have the Public IP from the location the script was deployed from, allowed on the Azure SQL database; you may need to adjust this depending on your requirements.</em></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="configure">Configure<a href="#configure" class="hash-link" aria-label="Direct link to Configure" title="Direct link to Configure">​</a></h4>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="onboard-azure-vms-to-log-analytics-using-azure-policy-and-powershell">Onboard Azure VMs to Log Analytics using Azure Policy and PowerShell<a href="#onboard-azure-vms-to-log-analytics-using-azure-policy-and-powershell" class="hash-link" aria-label="Direct link to Onboard Azure VMs to Log Analytics using Azure Policy and PowerShell" title="Direct link to Onboard Azure VMs to Log Analytics using Azure Policy and PowerShell">​</a></h5>
<p>Now that Azure Optimization has been installed, let&#x27;s onboard our current and future Azure Virtual Machines to Azure Optimization Engine, using Azure Policy. This is required if you want to get Azure Advisor Virtual Machine right-size recommendations augmented with guest OS metrics. If you don&#x27;t collect metrics from the Virtual Machines, you will still have a fully functional Optimisation Engine, with many recommendations, but the Advisor Virtual Machine right-size ones will be served as is.</p>
<ol>
<li>
<p>Open <strong>PowerShell</strong> and <strong>login</strong> to <strong>Azure</strong> using: Connect-AzAccount</p>
</li>
<li>
<p><strong>Connect to</strong> your Azure <strong>subscription</strong> that contains the Virtual Machines you want to onboard to Log Analytics</p>
</li>
<li>
<p>Type:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Register the resource provider if it&#x27;s not already registered</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Register-AzResourceProvider -ProviderNamespace &#x27;Microsoft.PolicyInsights&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>The PowerShell script below will:</p>
<ul>
<li>Copies the built-in Azure Policy definition of <a href="https://www.azadvertizer.net/azpolicyadvertizer/0868462e-646c-4fe3-9ced-a733534b6a2c.html?desc=compareJson&amp;left=https%3A%2F%2Fwww.azadvertizer.net%2Fazpolicyadvertizerjson%2F0868462e-646c-4fe3-9ced-a733534b6a2c_2.0.0.json&amp;right=https%3A%2F%2Fwww.azadvertizer.net%2Fazpolicyadvertizerjson%2F0868462e-646c-4fe3-9ced-a733534b6a2c_2.0.1.json" target="_blank" rel="noopener noreferrer" title=" Azure Policy definition Deploy - Configure Log Analytics extension to be enabled on Windows virtual machines ">Deploy - Configure Log Analytics extension to be enabled on Windows virtual machines</a></li>
<li>Create a User-Managed Identity</li>
<li>Assign: Log Analytics contributor rights to a subscription scope</li>
<li>Create a policy assignment, and assign it to the subscription</li>
</ul>
</li>
<li>
<p>Just update the variables to match your setup</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">#requires -Version 1.0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Variables</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#Enter your subscription name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$subscriptionName = &#x27;luke.geek.nz&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#Enter the name of yuour </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$policyDisplayName = &#x27;Deploy - Log Analytics&#x27; #Cant Exceed 24 characters</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$location = &#x27;australiaeast&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$resourceGroup = &#x27;aoegeek-rg&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$UsrIdentityName = &#x27;AOE_ManagedIdentityUsr&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$param = @{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  logAnalytics = &#x27;aoegeek-la&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Get a reference to the subscription that will be the scope of the assignment</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$sub = Get-AzSubscription -SubscriptionName $subscriptionName</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$subid = $sub.Id</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#Creates User Managed identity </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$AzManagedIdentity = New-AzUserAssignedIdentity -ResourceGroupName $resourceGroup -Name $UsrIdentityName</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#Adds Contributor rights to User Managed identity to Subscription</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#Waits 10 seconds to allow for Azure AD to replicate and recognise Managed identity has been created.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Start-Sleep -Seconds &#x27;10&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#Assigns role assignement to managed identity</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> New-AzRoleAssignment -Objectid $AzManagedIdentity.PrincipalId -scope (&#x27;/subscriptions/&#x27; + $subid ) -RoleDefinitionName &#x27;Log Analytics Contributor&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Get a reference to the built-in policy definition that will be assigned</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$definition = Get-AzPolicyDefinition | Where-Object -FilterScript {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  $_.Properties.DisplayName -eq &#x27;Deploy - Configure Log Analytics extension to be enabled on Windows virtual machines&#x27; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Create the policy assignment with the built-in definition against your subscription</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">New-AzPolicyAssignment -Name $policyDisplayName -DisplayName $policyDisplayName -Scope (&#x27;/subscriptions/&#x27; + $subid ) -PolicyDefinition $definition -IdentityType &#x27;UserAssigned&#x27;  -IdentityId $AzManagedIdentity.id -location $location -PolicyParameterObject $param</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#Creates R3mediation task, to deploy the extension to the VM</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$policyAssignmentID = Get-AzPolicyAssignment -Name $policyDisplayName | Select-Object -Property PolicyAssignmentId </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Start-AzPolicyRemediation -Name &#x27;Deploy - LA Agent&#x27; -PolicyAssignmentId $policyAssignmentID.PolicyAssignmentId -ResourceDiscoveryMode ReEvaluateCompliance</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ol>
<p><em>Note: The default &#x27;Deploy - Configure Log Analytics extension to be enabled on Windows virtual machines&#x27; policy doesn&#x27;t currently support Gen 2 or Windows Server 2022 Virtual Machines; if you have these, then you can copy the Azure Policy definition and then make your own with the new imageSKUs, although this policy may be replaced by the: Configure Windows virtual machines to run Azure Monitor Agent policy. Although I haven&#x27;t tested it yet, the same script above can be modified to suit.</em></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="onboard-azure-vms-to-log-analytics-using-the-azure-portal">Onboard Azure VMs to Log Analytics using the Azure Portal<a href="#onboard-azure-vms-to-log-analytics-using-the-azure-portal" class="hash-link" aria-label="Direct link to Onboard Azure VMs to Log Analytics using the Azure Portal" title="Direct link to Onboard Azure VMs to Log Analytics using the Azure Portal">​</a></h5>
<p>If you do not want to onboard VMs with Policy, you can do it manually via the Azure Portal.</p>
<ol>
<li>Open <strong>Azure Portal</strong></li>
<li>Navigate to <a href="https://portal.azure.com/#blade/HubsExtension/BrowseResource/resourceType/Microsoft.OperationalInsights%2Fworkspaces" target="_blank" rel="noopener noreferrer" title="Log Analytic Workspaces"><strong>Log Analytic Workspaces</strong></a></li>
<li><strong>Click on</strong> the Log Analytic <strong>workspace</strong> that was provisioned for Azure Optimization Engine</li>
<li>Navigate to <strong>Virtual Machines</strong> <em>(under Workspace Data Sources)</em></li>
<li>Click on the Virtual Machine you want to link up to the Log Analytics workspace, and click <strong>Connect -</strong> this will trigger the Log Analytic extension and agent o be installed. Repeat for any further Virtual Machines.</li>
<li><img decoding="async" loading="lazy" alt="Log Analytics - Connect VM" src="/assets/images/aoe-2019vmgen1_connectla-0756cd76382986357e3e66c456d28055.png" title="Log Analytics - Connect VM" width="371" height="424" class="img_ev3q"></li>
</ol>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="setup-log-analytic-performance-counters">Setup Log Analytic Performance Counters<a href="#setup-log-analytic-performance-counters" class="hash-link" aria-label="Direct link to Setup Log Analytic Performance Counters" title="Direct link to Setup Log Analytic Performance Counters">​</a></h5>
<p>Now that we have Virtual Machines reporting to our Log Analytic instance, it&#x27;s time to make sure we are collecting as much data as we need to give suitable recommendations, luckily a script has already been included in the Azure Optimisation repository called &#x27;<em>Setup-LogAnalyticsWorkspaces.ps1</em>&#x27; to configure the performance counters.</p>
<ol>
<li>
<p>Open <strong>PowerShell</strong> <em>(or Windows Terminal)</em></p>
</li>
<li>
<p><strong>Change</strong> the <strong>directory</strong> to the <strong>location</strong> of the Setup-LogAnalyticsWorkspaces.ps1, in the root folder of the repository extracted earlier</p>
</li>
<li>
<p>Run the following PowerShell commands to download the required PowerShell Modules:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Install-Module -Name Az.ResourceGraph</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Install-Module -Name Az.OperationalInsights</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>Then run: .<strong>\Setup-LogAnalyticsWorkspaces.ps1</strong></p>
</li>
<li>
<p>The script will then go through all Log Analytic workspaces that you have access to and check for performance counters.</p>
</li>
<li>
<p><img decoding="async" loading="lazy" alt="Windows PowerShell - \Setup-LogAnalyticsWorkspaces.ps1" src="/assets/images/deploycheck-loganalytics-9e21d4aee2426844a4576b72fda1d56e.gif" title="Windows PowerShell - \Setup-LogAnalyticsWorkspaces.ps1" width="1122" height="562" class="img_ev3q"></p>
</li>
<li>
<p>If they are missing from the Log Analytics workspace, then you can run:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">./Setup-LogAnalyticsWorkspaces.ps1 -AutoFix</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ol>
<p>or</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain"> #Fix specific workspaces configuration, using a custom counter collection frequency</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">./Setup-LogAnalyticsWorkspaces.ps1 -AutoFix -WorkspaceIds &quot;d69e840a-2890-4451-b63c-bcfc5580b90f&quot;,&quot;961550b2-2c4a-481a-9559-ddf53de4b455&quot; -IntervalSeconds 30</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="setup-azure-ad-based-recommendations-by-granting-permissions-to-managed-identity">Setup Azure AD-based recommendations by granting permissions to Managed Identity.<a href="#setup-azure-ad-based-recommendations-by-granting-permissions-to-managed-identity" class="hash-link" aria-label="Direct link to Setup Azure AD-based recommendations by granting permissions to Managed Identity." title="Direct link to Setup Azure AD-based recommendations by granting permissions to Managed Identity.">​</a></h5>
<p>Azure Optimization Engine, has the ability to do recommendations based on Microsoft Entra ID roles and permissions, but in order to do that, the System Assigned Identity of the Azure Optimization Engine account needs to be given &#x27;Global Reader&#x27; rights. As part of the deployment, you may have gotten the following error:</p>
<p><em>Cannot bind argument to parameter &#x27;DirectoryRoleId&#x27; because it is an empty string.</em></p>
<p><em>Could not grant role. If you want Azure AD-based recommendations, please grant the Global Reader role manually to the aoegeek-auto managed identity or, for previous versions of AOE, to the Run As Account principal.</em></p>
<p>We are going to grant the Azure Automation account &#x27;Global Reader&#x27; rights manually in the Azure Portal.</p>
<ol>
<li>Open <strong>Azure Portal</strong></li>
<li>Navigate to <a href="https://portal.azure.com/#blade/HubsExtension/BrowseResource/resourceType/Microsoft.Automation%2FAutomationAccounts" target="_blank" rel="noopener noreferrer" title="Automation Accounts"><strong>Automation Accounts</strong></a></li>
<li><strong>Open</strong> your Azure Optimisation Engine <strong>automation account</strong></li>
<li>Navigate down the navigation bar to the <strong>Account Settings</strong> section and select: <strong>Identity</strong></li>
<li><img decoding="async" loading="lazy" alt="Azure Automation - Identity" src="/assets/images/aoe-managedidentityazautomate-1b4014ef61ac4c7e7cd46b3ffdbc4e3c.png" title="Azure Automation - Identity" width="1328" height="525" class="img_ev3q"></li>
<li><strong>Copy</strong> the <strong>object ID</strong></li>
<li>Now navigate to <a href="https://portal.azure.com/#blade/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/Overview" target="_blank" rel="noopener noreferrer" title="Microsoft Entra ID"><strong>Microsoft Entra ID</strong></a></li>
<li>Click on <strong>Roles and Administrators</strong></li>
<li>Search for: <strong>Global Reader</strong></li>
<li>Select Global Reader and select <strong>+ Add assignments</strong></li>
<li>Paste in the object ID earlier, and click <strong>Ok</strong> to grant Global Reader rights to the Azure Automation identity.</li>
</ol>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="azure-automation---runbooks--automation">Azure Automation - Runbooks &amp; Automation<a href="#azure-automation---runbooks--automation" class="hash-link" aria-label="Direct link to Azure Automation - Runbooks &amp; Automation" title="Direct link to Azure Automation - Runbooks &amp; Automation">​</a></h5>
<p>The wind that gives Azure Optimization Engine its lift is Azure Automation and Runbooks, at the time I deployed this - I had x1 Azure Automation account and 33 runbooks!</p>
<p>Looking at the runbooks deployed, you can get a sense of what Azure Optimization Engine is doing...</p>

















































































































































<table><thead><tr><th>NAME</th><th>TYPE</th></tr></thead><tbody><tr><td>aoegeek-auto</td><td>Automation Account</td></tr><tr><td>Export-AADObjectsToBlobStorage (aoegeek-auto/Export-AADObjectsToBlobStorage)</td><td>Runbook</td></tr><tr><td>Export-AdvisorRecommendationsToBlobStorage (aoegeek-auto/Export-AdvisorRecommendationsToBlobStorage)</td><td>Runbook</td></tr><tr><td>Export-ARGAppGatewayPropertiesToBlobStorage (aoegeek-auto/Export-ARGAppGatewayPropertiesToBlobStorage)</td><td>Runbook</td></tr><tr><td>Export-ARGAvailabilitySetPropertiesToBlobStorage (aoegeek-auto/Export-ARGAvailabilitySetPropertiesToBlobStorage)</td><td>Runbook</td></tr><tr><td>Export-ARGLoadBalancerPropertiesToBlobStorage (aoegeek-auto/Export-ARGLoadBalancerPropertiesToBlobStorage)</td><td>Runbook</td></tr><tr><td>Export-ARGManagedDisksPropertiesToBlobStorage (aoegeek-auto/Export-ARGManagedDisksPropertiesToBlobStorage)</td><td>Runbook</td></tr><tr><td>Export-ARGNICPropertiesToBlobStorage (aoegeek-auto/Export-ARGNICPropertiesToBlobStorage)</td><td>Runbook</td></tr><tr><td>Export-ARGNSGPropertiesToBlobStorage (aoegeek-auto/Export-ARGNSGPropertiesToBlobStorage)</td><td>Runbook</td></tr><tr><td>Export-ARGPublicIpPropertiesToBlobStorage (aoegeek-auto/Export-ARGPublicIpPropertiesToBlobStorage)</td><td>Runbook</td></tr><tr><td>Export-ARGResourceContainersPropertiesToBlobStorage (aoegeek-auto/Export-ARGResourceContainersPropertiesToBlobStorage)</td><td>Runbook</td></tr><tr><td>Export-ARGUnmanagedDisksPropertiesToBlobStorage (aoegeek-auto/Export-ARGUnmanagedDisksPropertiesToBlobStorage)</td><td>Runbook</td></tr><tr><td>Export-ARGVirtualMachinesPropertiesToBlobStorage (aoegeek-auto/Export-ARGVirtualMachinesPropertiesToBlobStorage)</td><td>Runbook</td></tr><tr><td>Export-ARGVMSSPropertiesToBlobStorage (aoegeek-auto/Export-ARGVMSSPropertiesToBlobStorage)</td><td>Runbook</td></tr><tr><td>Export-ARGVNetPropertiesToBlobStorage (aoegeek-auto/Export-ARGVNetPropertiesToBlobStorage)</td><td>Runbook</td></tr><tr><td>Export-AzMonitorMetricsToBlobStorage (aoegeek-auto/Export-AzMonitorMetricsToBlobStorage)</td><td>Runbook</td></tr><tr><td>Export-ConsumptionToBlobStorage (aoegeek-auto/Export-ConsumptionToBlobStorage)</td><td>Runbook</td></tr><tr><td>Export-RBACAssignmentsToBlobStorage (aoegeek-auto/Export-RBACAssignmentsToBlobStorage)</td><td>Runbook</td></tr><tr><td>Ingest-OptimizationCSVExportsToLogAnalytics (aoegeek-auto/Ingest-OptimizationCSVExportsToLogAnalytics)</td><td>Runbook</td></tr><tr><td>Ingest-RecommendationsToSQLServer (aoegeek-auto/Ingest-RecommendationsToSQLServer)</td><td>Runbook</td></tr><tr><td>Recommend-AADExpiringCredentialsToBlobStorage (aoegeek-auto/Recommend-AADExpiringCredentialsToBlobStorage)</td><td>Runbook</td></tr><tr><td>Recommend-AdvisorAsIsToBlobStorage (aoegeek-auto/Recommend-AdvisorAsIsToBlobStorage)</td><td>Runbook</td></tr><tr><td>Recommend-AdvisorCostAugmentedToBlobStorage (aoegeek-auto/Recommend-AdvisorCostAugmentedToBlobStorage)</td><td>Runbook</td></tr><tr><td>Recommend-ARMOptimizationsToBlobStorage (aoegeek-auto/Recommend-ARMOptimizationsToBlobStorage)</td><td>Runbook</td></tr><tr><td>Recommend-LongDeallocatedVmsToBlobStorage (aoegeek-auto/Recommend-LongDeallocatedVmsToBlobStorage)</td><td>Runbook</td></tr><tr><td>Recommend-UnattachedDisksToBlobStorage (aoegeek-auto/Recommend-UnattachedDisksToBlobStorage)</td><td>Runbook</td></tr><tr><td>Recommend-UnusedAppGWsToBlobStorage (aoegeek-auto/Recommend-UnusedAppGWsToBlobStorage)</td><td>Runbook</td></tr><tr><td>Recommend-UnusedLoadBalancersToBlobStorage (aoegeek-auto/Recommend-UnusedLoadBalancersToBlobStorage)</td><td>Runbook</td></tr><tr><td>Recommend-VMsHighAvailabilityToBlobStorage (aoegeek-auto/Recommend-VMsHighAvailabilityToBlobStorage)</td><td>Runbook</td></tr><tr><td>Recommend-VMSSOptimizationsToBlobStorage (aoegeek-auto/Recommend-VMSSOptimizationsToBlobStorage)</td><td>Runbook</td></tr><tr><td>Recommend-VNetOptimizationsToBlobStorage (aoegeek-auto/Recommend-VNetOptimizationsToBlobStorage)</td><td>Runbook</td></tr><tr><td>Remediate-AdvisorRightSizeFiltered (aoegeek-auto/Remediate-AdvisorRightSizeFiltered)</td><td>Runbook</td></tr><tr><td>Remediate-LongDeallocatedVMsFiltered (aoegeek-auto/Remediate-LongDeallocatedVMsFiltered)</td><td>Runbook</td></tr><tr><td>Remediate-UnattachedDisksFiltered (aoegeek-auto/Remediate-UnattachedDisksFiltered)</td><td>Runbook</td></tr></tbody></table>
<p>A lot of the runbooks, such as the Log Analytics workspace ID, link up to Azure Automation variables, such as this period in Days to look back for Advisor recommendations, by default, this is &#x27;7&#x27; but you can change this variable to suit your organisation&#x27;s needs.</p>
<p><img decoding="async" loading="lazy" alt="Azure Automation - Runbooks &amp;amp; Automation" src="/assets/images/aoe-variables-6d7cf08f142e3c5d21c5ea56f3a5af51.png" title="Azure Automation - Runbooks &amp;amp; Automation" width="1319" height="949" class="img_ev3q"></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="azure-automation---schedules">Azure Automation - Schedules<a href="#azure-automation---schedules" class="hash-link" aria-label="Direct link to Azure Automation - Schedules" title="Direct link to Azure Automation - Schedules">​</a></h5>
<p>Along with containing the variables and configurations used by the Runbooks, it also contains the schedules for the ingest of data into the storage account and SQL databases, most of these are Daily, but schedules such as ingesting from the Azure Advisor are weekly, by default these times are in UTC.</p>
<p><img decoding="async" loading="lazy" alt="Azure Automation - Schedules" src="/assets/images/aoe-schedules-6fb5f8721167e4866f605cdd63180043.png" title="Azure Automation - Schedules" width="1333" height="970" class="img_ev3q"></p>
<p>When making changes to these schedules <em>(or moving the Runbooks to be run from a Hybrid worker)</em>, it is recommended to use the Reset-AutomationSchedules.ps1 script. These times need to be in UTC.</p>
<p><img decoding="async" loading="lazy" alt="Terminal - Reset-AutomationSchedules.ps1" src="/assets/images/update-automationschedules-97b92517562b267c0ec3d9b27e2b19e2.gif" title="Terminal - Reset-AutomationSchedules.ps1" width="1122" height="647" class="img_ev3q"></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="azure-automation---credentials">Azure Automation - Credentials<a href="#azure-automation---credentials" class="hash-link" aria-label="Direct link to Azure Automation - Credentials" title="Direct link to Azure Automation - Credentials">​</a></h5>
<p>When we set up the Azure SQL database earlier, as part of the Azure Optimisation setup, we configured the SQL Admin account and password, these credentials are stored and used by the Runbooks in the Azure Automation credential pane.</p>
<p><img decoding="async" loading="lazy" alt="Azure Automation - Credentials" src="/assets/images/aoe-credentials-a6723fb26c307eb1ba48d0776eeab30a.png" title="Azure Automation - Credentials" width="1324" height="588" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="view-recommendations">View Recommendations<a href="#view-recommendations" class="hash-link" aria-label="Direct link to View Recommendations" title="Direct link to View Recommendations">​</a></h3>
<p>It&#x27;s worth noting, that because Azure Optimization Engine stores its data into Log Analytics and SQL, you can use languages such as KQL directly on the Log Analytics workspace to pull out any information you might need and develop integration into other toolsets.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="workbooks">Workbooks<a href="#workbooks" class="hash-link" aria-label="Direct link to Workbooks" title="Direct link to Workbooks">​</a></h5>
<p>There are x3 Azure Log Analytics workbooks included in the Azure Optimization Engine, these are as follows:</p>





















<table><thead><tr><th>NAME</th><th>TYPE</th></tr></thead><tbody><tr><td>Resources Inventory</td><td>Azure Workbook</td></tr><tr><td>Identities and Roles</td><td>Azure Workbook</td></tr><tr><td>Costs Growing</td><td>Azure Workbook</td></tr></tbody></table>
<p>They can be easily accessed in the Azure Portal.</p>
<ol>
<li>Log in to the <strong>Azure Portal</strong></li>
<li>Navigate to <a href="https://portal.azure.com/#blade/HubsExtension/BrowseResource/resourceType/Microsoft.OperationalInsights%2Fworkspaces" target="_blank" rel="noopener noreferrer" title="Log Analytics Workspace"><strong>Log Analytics Workspace</strong></a></li>
<li>Click on the Log Analytics workspace you set up for Azure Optimization Engine earlier and click on <strong>Workbooks</strong> <em>(under General)</em>.</li>
<li>Click on: <strong>Workbooks</strong> filter at the top to display the 3 Azure Optimization Engine</li>
<li><img decoding="async" loading="lazy" alt="Log Analtics - Workbooks" src="/assets/images/aoe-displayworkbooks-b0ecb34c41aaebdd1e02e10b3f42e8d3.png" title="Log Analtics - Workbooks" width="954" height="569" class="img_ev3q"></li>
<li>After a few days of collecting data, you should now be able to see data like below.</li>
</ol>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id="resource-inventory---general">Resource Inventory - General<a href="#resource-inventory---general" class="hash-link" aria-label="Direct link to Resource Inventory - General" title="Direct link to Resource Inventory - General">​</a></h6>
<p><img decoding="async" loading="lazy" alt="Resource Inventory - General" src="/assets/images/aoe-workbookresourceinventory-ad40a7d0fcd64ab6192513f16524c648.png" title="Resource Inventory - General" width="1047" height="823" class="img_ev3q"></p>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id="resource-inventory---virtual-machines">Resource Inventory - Virtual Machines<a href="#resource-inventory---virtual-machines" class="hash-link" aria-label="Direct link to Resource Inventory - Virtual Machines" title="Direct link to Resource Inventory - Virtual Machines">​</a></h6>
<p><img decoding="async" loading="lazy" alt="Resource Inventory - Virtual Machines" src="/assets/images/aoe-workbookresourceinventory_virtualmachines-583da597c732a19e9c8277516c57ddca.png" title="Resource Inventory - Virtual Machines" width="1028" height="2264" class="img_ev3q"></p>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id="resource-inventory---virtual-machine-scalesets">Resource Inventory - Virtual Machine ScaleSets<a href="#resource-inventory---virtual-machine-scalesets" class="hash-link" aria-label="Direct link to Resource Inventory - Virtual Machine ScaleSets" title="Direct link to Resource Inventory - Virtual Machine ScaleSets">​</a></h6>
<p><img decoding="async" loading="lazy" alt="Resource Inventory - Virtual Machine ScaleSets" src="/assets/images/aoe-workbookresourceinventory_virtualmachinescaletset-13581dbfe3d4fb718cf56cb69c2af14c.png" title="Resource Inventory - Virtual Machine ScaleSets" width="1016" height="2178" class="img_ev3q"></p>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id="resource-inventory---virtual-machine-scalesets-disks">Resource Inventory - Virtual Machine ScaleSets Disks<a href="#resource-inventory---virtual-machine-scalesets-disks" class="hash-link" aria-label="Direct link to Resource Inventory - Virtual Machine ScaleSets Disks" title="Direct link to Resource Inventory - Virtual Machine ScaleSets Disks">​</a></h6>
<p><img decoding="async" loading="lazy" alt="Resource Inventory - Virtual Machine ScaleSets Disks" src="/assets/images/aoe-workbookresourceinventory_virtualmachinescaletsetdisks-d4ec1fc4885585343ae1d9cfe9a80b97.png" title="Resource Inventory - Virtual Machine ScaleSets Disks" width="1033" height="890" class="img_ev3q"></p>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id="resource-inventory---virtual-networks">Resource Inventory - Virtual Networks<a href="#resource-inventory---virtual-networks" class="hash-link" aria-label="Direct link to Resource Inventory - Virtual Networks" title="Direct link to Resource Inventory - Virtual Networks">​</a></h6>
<p><img decoding="async" loading="lazy" alt="Resource Inventory - Virtual Networks" src="/assets/images/aoe-workbookresourceinventory_virtualnetworks-ba3f4ca93d3956bc377d2301211f3d14.png" title="Resource Inventory - Virtual Networks" width="1018" height="1491" class="img_ev3q"></p>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id="identities-and-roles---overview">Identities and Roles - Overview<a href="#identities-and-roles---overview" class="hash-link" aria-label="Direct link to Identities and Roles - Overview" title="Direct link to Identities and Roles - Overview">​</a></h6>
<p><img decoding="async" loading="lazy" alt="Identities and Roles - Overview" src="/assets/images/aoe-workbookaad_overview-fee5d40d84bf6457c7220691e9a4ff68.png" title="Identities and Roles - Overview" width="2587" height="934" class="img_ev3q"></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="power-bi">Power BI<a href="#power-bi" class="hash-link" aria-label="Direct link to Power BI" title="Direct link to Power BI">​</a></h5>
<p>The true power of the Azure Optimisation engine, is the data stored in the SQL database, using PowerBI you can pull the data into dashboards and make it more meaningful, and the recommendations given from PowerBI and SQL.</p>
<p>The Optimisation Engine already has a starter PowerBI file, which pulls data from the database.</p>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id="install-powerbi-desktop">Install PowerBI Desktop<a href="#install-powerbi-desktop" class="hash-link" aria-label="Direct link to Install PowerBI Desktop" title="Direct link to Install PowerBI Desktop">​</a></h6>
<ol>
<li>Open Microsoft Store and search for: <a href="https://aka.ms/pbidesktopstore" target="_blank" rel="noopener noreferrer" title=" Microsoft Power BI Desktop"><strong>Power BI Desktop</strong></a></li>
<li>Click <strong>Get</strong></li>
<li><img decoding="async" loading="lazy" alt="Power BI Desktop" src="/assets/images/microsoft-store-powerbidesktop-cc7ad117e2985fa7b8d179ff0972556c.png" title="Power BI Desktop" width="403" height="368" class="img_ev3q"></li>
<li>Once Downloaded, click <strong>Open</strong></li>
</ol>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id="obtain-azure-sql-information">Obtain Azure SQL Information<a href="#obtain-azure-sql-information" class="hash-link" aria-label="Direct link to Obtain Azure SQL Information" title="Direct link to Obtain Azure SQL Information">​</a></h6>
<p>In order to connect PowerBI to the Azure SQL database, we need to know the URL of the database and make sure our IP has been opened on the Azure SQL Firewall.</p>
<ol>
<li>Open <strong>Azure Portal</strong></li>
<li>Navigate to <a href="https://portal.azure.com/#blade/HubsExtension/BrowseResource/resourceType/Microsoft.Sql%2Fservers" target="_blank" rel="noopener noreferrer" title="Azure Portal - SQL servers"><strong>SQL Servers</strong></a></li>
<li>Click on the SQL server created earlier, under the Security heading click on <strong>Firewall and Virtual Networks</strong></li>
<li>Under: Client IP address, make sure your public IP is added and click <strong>Save</strong></li>
<li><img decoding="async" loading="lazy" alt="Azure SQL - Virtual Network" src="/assets/images/aoe-sql-server-firewall-2c994b63f831458b9f5b94e0db50e4f6.png" title="Azure SQL - Virtual Network" width="1328" height="812" class="img_ev3q"></li>
<li>Now that we have verified/added our client IP, we need to get the SQL <strong>database</strong> <em>(not server)</em> URL</li>
<li>Click on <strong>Overview</strong></li>
<li><strong>Click</strong> on the <em>aoeoptimization</em> <strong>database</strong> <em>(under Available resources, down the bottom)</em></li>
<li>Click on <strong>Copy to Clipboard</strong> for the <strong>server Name</strong>/URL</li>
<li><img decoding="async" loading="lazy" alt="Azure SQL - Database URL" src="data:image/png;base64,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" title="Azure SQL - Database URL" width="480" height="145" class="img_ev3q"></li>
</ol>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id="open-powerbi-desktop-file">Open PowerBI Desktop File<a href="#open-powerbi-desktop-file" class="hash-link" aria-label="Direct link to Open PowerBI Desktop File" title="Direct link to Open PowerBI Desktop File">​</a></h6>
<p>Now that we have PowerBI Desktop installed, it&#x27;s time to open: AzureOptimizationEngine.pbix. This PowerBI file is located in the Views folder of the Azure Optimization Engine repository.</p>
<ol>
<li><strong>Open</strong>: <strong>AzureOptimizationEngine.pbix</strong> in PowerBI Desktop</li>
<li>On the Home page ribbon, click on <strong>Transform Data</strong></li>
<li>Click <strong>Data source settings</strong></li>
<li>Click <strong>Change Source</strong></li>
<li><strong>Change</strong> the default <strong>SQL server</strong> of aoedevgithub-sql.database.windows.net to your SQL database, copied earlier.</li>
<li>Click <strong>Ok</strong></li>
<li>Click Ok and press <strong>Apply Changes</strong></li>
<li>It will prompt for credentials, click on <strong>Database</strong></li>
<li>Enter in your SQLAdmin details entered as part of the Azure Optimization Engine setup</li>
<li>Click <strong>Connect</strong></li>
</ol>
<p>After PowerBI updates its database and queries, your PowerBI report should now be populated with data like below.</p>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id="powerbi---overview">PowerBI - Overview<a href="#powerbi---overview" class="hash-link" aria-label="Direct link to PowerBI - Overview" title="Direct link to PowerBI - Overview">​</a></h6>
<p><img decoding="async" loading="lazy" alt="PowerBI - Overview" src="/assets/images/aoe-powerbi_overview-8d059e8ed738e8a3690cbb2ee774a0c0.png" title="PowerBI - Overview" width="1614" height="893" class="img_ev3q"></p>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id="powerbi---cost">PowerBI - Cost<a href="#powerbi---cost" class="hash-link" aria-label="Direct link to PowerBI - Cost" title="Direct link to PowerBI - Cost">​</a></h6>
<p><img decoding="async" loading="lazy" alt="PowerBI - Cost" src="/assets/images/aoe-powerbi_cost-9dff1afe13c6526978b67786a636cbae.png" title="PowerBI - Cost" width="1558" height="524" class="img_ev3q"></p>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id="powerbi---high-availability">PowerBI - High Availability<a href="#powerbi---high-availability" class="hash-link" aria-label="Direct link to PowerBI - High Availability" title="Direct link to PowerBI - High Availability">​</a></h6>
<p><img decoding="async" loading="lazy" alt="PowerBI - High Availability" src="/assets/images/aoe-powerbi_ha-690bbe8afef11ceff2e0339fbff66323.png" title="PowerBI - High Availability" width="1561" height="775" class="img_ev3q"></p>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id="powerbi---security">PowerBI - Security<a href="#powerbi---security" class="hash-link" aria-label="Direct link to PowerBI - Security" title="Direct link to PowerBI - Security">​</a></h6>
<p><img decoding="async" loading="lazy" alt="PowerBI - Security" src="/assets/images/aoe-powerbi_security-a08e6c5ea3c79142f23ee9737c74bcee.png" title="PowerBI - Security" width="1609" height="798" class="img_ev3q"></p>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id="powerbi---operational-excellence">PowerBI - Operational Excellence<a href="#powerbi---operational-excellence" class="hash-link" aria-label="Direct link to PowerBI - Operational Excellence" title="Direct link to PowerBI - Operational Excellence">​</a></h6>
<p><img decoding="async" loading="lazy" alt="PowerBI - Operational Excellence" src="/assets/images/aoe-powerbi_operationalexcellencepng-a2a1ca90266c98bcfd0b8bca4a2f81fc.png" title="PowerBI - Operational Excellence" width="1571" height="782" class="img_ev3q"></p>
<p><strong>Congratulations! You have now successfully stood up and configured Azure Optimization Engine!</strong></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="additional-recommended-reading">Additional Recommended Reading<a href="#additional-recommended-reading" class="hash-link" aria-label="Direct link to Additional Recommended Reading" title="Direct link to Additional Recommended Reading">​</a></h4>
<ul>
<li><em>&quot;Augmenting Azure Advisor Cost Recommendations for Automated Continuous Optimization&quot;</em> blog post series:
<ol>
<li><a href="https://techcommunity.microsoft.com/t5/core-infrastructure-and-security/augmenting-azure-advisor-cost-recommendations-for-automated/ba-p/1339298?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Augmenting Azure Advisor Cost Recommendations for Automated Continuous Optimization – Part 1">Part 1 - Solution Overview</a></li>
<li><a href="https://techcommunity.microsoft.com/t5/core-infrastructure-and-security/augmenting-azure-advisor-cost-recommendations-for-automated/ba-p/1457687?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Augmenting Azure Advisor Cost Recommendations for Automated Continuous Optimization – Part 2">Part 2 - Collecting Data</a></li>
<li><a href="https://techcommunity.microsoft.com/t5/core-infrastructure-and-security/augmenting-azure-advisor-cost-recommendations-for-automated/ba-p/1544796?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Augmenting Azure Advisor Cost Recommendations for Automated Continuous Optimization – Part 3">Part 3 - Generating &amp; Viewing Recommendations</a></li>
<li><a href="https://techcommunity.microsoft.com/t5/core-infrastructure-and-security/automating-continuous-optimization-with-the-azure-optimization/ba-p/1851317?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Automating Continuous Optimization with the Azure Optimization Engine">Part 4 - Automating Continous Optimisation with the Azure Optimization Engine</a></li>
</ol>
</li>
<li><a href="https://github.com/helderpinto/AzureOptimizationEngine#usage-instructions" target="_blank" rel="noopener noreferrer" title="Azure Optimization Engine">Azure Optimization Engine Github - Usage instructions</a></li>
</ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/azure/">Azure</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/tags/azure/page/24/"><div class="pagination-nav__label">Newer entries</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/tags/azure/page/26/"><div class="pagination-nav__label">Older entries</div></a></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 luke.geek.nz. Powered by coffee, clouds and hamsters on wheels!</div></div></div></footer></div>
</body>
</html>