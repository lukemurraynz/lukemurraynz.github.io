<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-tags-post-list-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.5.2">
<title data-rh="true">157 posts tagged with &quot;Azure&quot; | luke.geek.nz</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://luke.geek.nz/img/social-card.png"><meta data-rh="true" name="twitter:image" content="https://luke.geek.nz/img/social-card.png"><meta data-rh="true" property="og:url" content="https://luke.geek.nz/tags/azure/page/21/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" property="og:title" content="157 posts tagged with &quot;Azure&quot; | luke.geek.nz"><meta data-rh="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://luke.geek.nz/tags/azure/page/21/"><link data-rh="true" rel="alternate" href="https://luke.geek.nz/tags/azure/page/21/" hreflang="en"><link data-rh="true" rel="alternate" href="https://luke.geek.nz/tags/azure/page/21/" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://ZBH2T1WJQD-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="luke.geek.nz RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="luke.geek.nz Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="luke.geek.nz JSON Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0QDLBY7NNN"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-0QDLBY7NNN",{anonymize_ip:!0})</script><link rel="stylesheet" href="/assets/css/styles.dcdba76e.css">
<script src="/assets/js/runtime~main.180fcc36.js" defer="defer"></script>
<script src="/assets/js/main.da915e79.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"dark")}(),function(){try{const a=new URLSearchParams(window.location.search).entries();for(var[t,e]of a)if(t.startsWith("docusaurus-data-")){var n=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(n,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:#D3D3D3" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY">If you haven't already make sure you sign up for my Weekly Azure Newsletter, straight to your inbox! <a target="_blank" rel="noopener noreferrer" href="https://newsletter.azurefeeds.com/join">Subscribe now!</a></div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="luke.geek.nz" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.png" alt="luke.geek.nz" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">luke.geek.nz</b></a><a class="navbar__item navbar__link" href="/Tags/">Tags</a><a class="navbar__item navbar__link" href="/Archive/">Blog</a><a class="navbar__item navbar__link" href="/about/">About</a></div><div class="navbar__items navbar__items--right"><a href="https://www.youtube.com/channel/UCUG3TKDTAZz4UXshGrjBBoQ" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-icon" aria-label="YouTube">
              <svg width="24" height="24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path d="M23.498,6.186c-0.273-1.186-1.143-2.144-2.332-2.417C18.389,3.153,12,3.153,12,3.153s-6.389,0-9.166,0.616
                  c-1.19,0.273-2.06,1.23-2.332,2.417C0,8.07,0,12,0,12s0,3.93,0.502,5.814c0.272,1.187,1.142,2.062,2.332,2.335
                  C5.611,20.847,12,20.847,12,20.847s6.389,0,9.166-0.698c1.189-0.273,2.059-1.148,2.332-2.335C24,15.93,24,12,24,12
                  S24,8.07,23.498,6.186z M9.545,15.568V8.432l6.545,3.568L9.545,15.568z"/>
              </svg>
            </a><a href="https://aus.social/@lukemurray" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-icon" aria-label="Mastodon">
              <svg height="20" width="20" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" xml:space="preserve">
                <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                <g id="SVGRepo_iconCarrier">
                  <path d="M21.327 8.566c0-4.339-2.843-5.61-2.843-5.61-1.433-.658-3.894-.935-6.451-.956h-.063c-2.557.021-5.016.298-6.45.956 0 0-2.843 1.272-2.843 5.61 0 .993-.019 2.181.012 3.441.103 4.243.778 8.425 4.701 9.463 1.809.479 3.362.579 4.612.510 2.268-.126 3.541-.809 3.541-.809l-.075-1.646s-1.621.511-3.441.449c-1.804-.062-3.707-.194-3.999-2.409a4.523 4.523 0 0 1-.04-.621s1.77.433 4.014.536c1.372.063 2.658-.08 3.965-.236 2.506-.299 4.688-1.843 4.962-3.254.434-2.223.398-5.424.398-5.424zm-3.353 5.59h-2.081V9.057c0-1.075-.452-1.62-1.357-1.62-1 0-1.501.647-1.501 1.927v2.791h-2.069V9.364c0-1.28-.501-1.927-1.502-1.927-.905 0-1.357.546-1.357 1.62v5.099H6.026V8.903c0-1.074.273-1.927.823-2.558.566-.631 1.307-.955 2.228-.955 1.065 0 1.872.409 2.405 1.228l.518.869.519-.869c.533-.819 1.34-1.228 2.405-1.228.92 0 1.662.324 2.228.955.549.631.822 1.484.822 2.558v5.253z"></path>
                </g>
              </svg>
            </a><a href="https://bsky.app/profile/lukemurraynz.bsky.social" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-icon" aria-label="Bluesky">
              <svg class="octicon" xmlns="http://www.w3.org/2000/svg" role="img" viewBox="0 0 16 16" height="20" width="20" fill="currentColor">
                <title>Bluesky</title>
                <path d="M8 7.2c-.72-1.4-2.7-4.04-4.53-5.33C1.7.63 1.04.84.6 1.04.1 1.27 0 2.05 0 2.51c0 .46.25 3.77.42 4.32.54 1.82 2.47 2.45 4.25 2.25-2.6.38-4.92 1.33-1.88 4.71 3.33 3.46 4.57-.74 5.21-2.87.64 2.13 1.37 6.18 5.16 2.87 2.84-2.87.78-4.33-1.83-4.71 1.78.2 3.71-.43 4.25-2.25.17-.55.42-3.86.42-4.32 0-.46-.09-1.24-.6-1.47-.44-.2-1.11-.42-2.87.83A17.87 17.87 0 0 0 8 7.2Z"></path>
              </svg>
            </a><a href="https://twitter.com/lukemurraynz" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-icon" aria-label="X"><svg height="20" width="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 8.586l4.293-4.293a1 1 0 011.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 011.414-1.414L10 8.586z" clip-rule="evenodd"/>
          </svg></a><a href="https://www.linkedin.com/in/ljmurray/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-icon" aria-label="LinkedIn"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" height="20" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854V1.146zm4.943 12.248V6.169H2.542v7.225h2.401zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248-.822 0-1.359.54-1.359 1.248 0 .694.521 1.248 1.327 1.248h.016zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274 0-1.845.7-2.165 1.193v.025h-.016a5.54 5.54 0 0 1 .016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225h2.4z"></path></svg></a><a href="https://luke.geek.nz/rss" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-rss-link" aria-label="RSS"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><div role="group"><h3 class="yearGroupHeading_rMGB">2024</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure/nz-north-latency-testing/">New Zealand North Latency Testing and Results</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure/enhancing-github-copilot-with-custom-instructions/">Enhancing GitHub Copilot with Custom Instructions</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure/change-analysis/">Azure Resource - Change Analysis</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/misc/kubernetes-enterprise-guide-book-review/">Book Review - Kubernetes – An Enterprise Guide</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure/openai-adoption-challenges-solutions/">Common Challenges and Solutions for Azure OpenAI Adoption</a></li></ul></div></nav></aside><main class="col col--7"><header class="margin-bottom--xl"><h1>157 posts tagged with &quot;Azure&quot;</h1><a href="/tags/">View All Tags</a></header><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/2022/06/02/microsoft-azure-naming-conventions/">Microsoft Azure Naming Conventions</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-06-02T00:00:00.000Z">June 2, 2022</time> · <!-- -->8 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://luke.geek.nz/img/logo.png" alt="Luke Murray"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">Luke Murray</span></a></div><small class="authorTitle_nd0D" title="Author">Author</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><p>Accurately representing and naming your resources is essential for security purposes.</p>
<p>In a security incident, it is critical to identify affected systems quickly, what functions those systems support, and the potential business impact.</p>
<p>A useful naming convention composes resource names from important information about each resource. A well-chosen name helps you quickly identify the resource&#x27;s type, its associated workload, its deployment environment, and the Azure region hosting it.</p>
<p>Some resource names, such as PaaS services with public endpoints or virtual machine DNS labels, have global scopes, so they must be unique across the Azure platform.</p>
<p>There&#x27;s no one size fits all to Azure naming conventions, it needs to suit your organisation, however, it is worth noting that there are limitations to naming rules to Azure resources.</p>
<ul>
<li><a href="https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/resource-name-rules?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Naming rules and restrictions for Azure resources">Naming rules and restrictions for Azure resources</a></li>
<li><a href="https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/resource-naming?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Define your naming convention">Define your naming convention</a></li>
<li><a href="https://luke.geek.nz/azure/deploy-azure-naming-tool-into-an-azure-webapp-as-a-container/" target="_blank" rel="noopener noreferrer">Deploy Azure Naming Tool into an Azure WebApp as a container</a></li>
</ul>
<p>The use of these limitations and scopes have been used to determine the following naming conventions across associated resources.</p>













<table><thead><tr><th>Casing</th><th>Name Format</th></tr></thead><tbody><tr><td>Lowercase</td><td>{organizationName}-{component}-{resourceTypeshortCode}-{regionShortCode}-{environmentlongcode}</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="naming-convention-examples">Naming Convention Examples<a href="#naming-convention-examples" class="hash-link" aria-label="Direct link to Naming Convention Examples" title="Direct link to Naming Convention Examples">​</a></h3>
































































































































































































































































































































<table><thead><tr><th>Environment</th><th>Application Name</th><th>Azure Region</th><th>Azure Service</th><th>Example Name</th></tr></thead><tbody><tr><td>Production</td><td>application1</td><td>Australia East</td><td>App Service</td><td>company-application1-asvc-au-e-prod</td></tr><tr><td>Production</td><td>application1</td><td>Australia East</td><td>App Service Environment</td><td>company-application1-ase-au-e-prod</td></tr><tr><td>Production</td><td>application1</td><td>Australia East</td><td>App Service Plan</td><td>company-application1-asp-au-e-prod</td></tr><tr><td>Production</td><td>application1</td><td>Australia East</td><td>Application Gateway</td><td>company-application1-agw-au-e-prod</td></tr><tr><td>Production</td><td>application1</td><td>Australia East</td><td>Automation Account</td><td>company-application1-aum-au-e-prod</td></tr><tr><td>Production</td><td>application1</td><td>Australia East</td><td>Availability Set</td><td>company-application1-avs-au-e-prod</td></tr><tr><td>Production</td><td>application1</td><td>Australia East</td><td>Azure Arc enabled Kubernetes cluster</td><td>company-application1-arck-au-e-prod</td></tr><tr><td>Production</td><td>application1</td><td>Australia East</td><td>Azure Arc enabled server</td><td>company-application1-arcs-au-e-prod</td></tr><tr><td>Production</td><td>application1</td><td>Australia East</td><td>Azure Cosmos DB database</td><td>company-application1-cosmos-au-e-prod</td></tr><tr><td>Production</td><td>application1</td><td>Australia East</td><td>Azure Data Factory</td><td>company-application1-adf-au-e-prod</td></tr><tr><td>Production</td><td>application1</td><td>Australia East</td><td>Azure Search</td><td>company-application1-srch-au-e-prod</td></tr><tr><td>Production</td><td>application1</td><td>Australia East</td><td>Azure SQL Database</td><td>company-application1-sqldb-au-e-prod</td></tr><tr><td>Production</td><td>application1</td><td>Australia East</td><td>Azure SQL Elastic Pool</td><td>company-application1-sqlep-au-e-prod</td></tr><tr><td>Production</td><td>application1</td><td>Australia East</td><td>Azure SQL Server</td><td>company-application1-sql-au-e-prod</td></tr><tr><td>Production</td><td>application1</td><td>Australia East</td><td>Container registry</td><td>company-application1-cr-au-e-prod</td></tr><tr><td>Production</td><td>application1</td><td>Australia East</td><td>Cosmos DB</td><td>company-application1-cdb-au-e-prod</td></tr><tr><td>Production</td><td>application1</td><td>Australia East</td><td>Function App</td><td>company-application1-func-au-e-prod</td></tr><tr><td>Production</td><td>application1</td><td>Australia East</td><td>Gateway connection</td><td>company-application1-cn-au-e-prod</td></tr><tr><td>Test</td><td>application1</td><td>Australia East</td><td>IoT Central</td><td>company-application1-iotc-au-e-test</td></tr><tr><td>Test</td><td>application1</td><td>Australia East</td><td>Key Vault</td><td>company-application1-kv-au-e-test</td></tr><tr><td>Test</td><td>application1</td><td>Australia East</td><td>Load Balancer</td><td>company-application1-lb-au-e-test</td></tr><tr><td>Test</td><td>application1</td><td>Australia East</td><td>Local Network Gateway</td><td>company-application1-lgw-au-e-test</td></tr><tr><td>Test</td><td>application1</td><td>Australia East</td><td>Log Analytics workspace</td><td>company-application1-la-au-e-test</td></tr><tr><td>Production</td><td>application1</td><td>Australia East</td><td>MySQL database</td><td>company-application1-mysql-au-e-prod</td></tr><tr><td>Production</td><td>application1</td><td>Australia East</td><td>Network Interface</td><td>company-application1-nic-au-e-prod</td></tr><tr><td>Production</td><td>application1</td><td>Australia East</td><td>Network Security Group</td><td>company-application1-nsg-au-e-prod</td></tr><tr><td>Production</td><td>application1</td><td>Australia East</td><td>Network Security Group Rule</td><td>company-application1-nsg-au-e-prod</td></tr><tr><td>Production</td><td>application1</td><td>Australia East</td><td>Public IP Address</td><td>company-application1-pip-au-e-prod</td></tr><tr><td>Production</td><td></td><td>Australia East</td><td>Recovery Services vault</td><td>company-rsv-au-e-prod</td></tr><tr><td>Production</td><td>application1</td><td>Australia East</td><td>Recovery Services Vault - Backup policies</td><td>company-application1-rsvp-au-e-prod</td></tr><tr><td>Production</td><td>application1</td><td>Australia East</td><td>Resource Group</td><td>company-application1-rg-au-e-prod</td></tr><tr><td>Production</td><td>application1</td><td>Australia East</td><td>Route table</td><td>company-application1-route-au-e-prod</td></tr><tr><td>Production</td><td>application1</td><td>Australia East</td><td>Runbooks</td><td>company-application1-run-au-e-prod</td></tr><tr><td>Production</td><td>application1</td><td>Australia East</td><td>Service Bus - Namespace</td><td>company-application1-sbns-au-e-prod</td></tr><tr><td>Production</td><td>application1</td><td>Australia East</td><td>SQL Data Warehouse</td><td>company-application1-sqldw-au-e-prod</td></tr><tr><td>Production</td><td>application1</td><td>Australia East</td><td>SQL Managed Instance</td><td>company-application1-sqlmi-au-e-prod</td></tr><tr><td>Production</td><td>App1</td><td>Australia East</td><td>Storage Account</td><td>company-pp1-stg-au-e-prod</td></tr><tr><td>Production</td><td>application1</td><td>Australia East</td><td>Subnet</td><td>company-application1-snet-au-e-prod</td></tr><tr><td>Production</td><td>application1</td><td>Australia East</td><td>Subscription</td><td>company-application1-sub-prod</td></tr><tr><td>Production</td><td>application1</td><td>Australia East</td><td>Traffic Manager Profile</td><td>company-application1-tmp-au-e-prod</td></tr><tr><td>Production</td><td>application1</td><td>Australia East</td><td>User defined route (UDR)</td><td>company-application1-udr-au-e-prod</td></tr><tr><td>Production</td><td>application1</td><td>Australia East</td><td>Virtual machine scale set</td><td>company-application1-vmss-au-e-prod</td></tr><tr><td>Production</td><td>application1</td><td>Australia East</td><td>Virtual Network</td><td>company-application1-vn-au-e-prod</td></tr><tr><td>Production</td><td>application1</td><td>Australia East</td><td>Virtual Network Gateway</td><td>company-application1-vngw-au-e-prod</td></tr></tbody></table>
<p><img decoding="async" loading="lazy" alt="Azure Naming - Global" src="/assets/images/azurenaming-de5701625b4cd5285260a9d2ace49307.png" title="Azure Naming - Global" width="1010" height="415" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="resource-group">Resource Group<a href="#resource-group" class="hash-link" aria-label="Direct link to Resource Group" title="Direct link to Resource Group">​</a></h3>



















<table><thead><tr><th>Environment</th><th>Application Name</th><th>Azure Region</th><th>Azure Service</th><th>Example Name</th></tr></thead><tbody><tr><td>Production</td><td>application1</td><td>Australia East</td><td>Resource Group</td><td>company-application1-rg-au-e-prod</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="resource-type-codes">Resource Type Codes<a href="#resource-type-codes" class="hash-link" aria-label="Direct link to Resource Type Codes" title="Direct link to Resource Type Codes">​</a></h3>

























































































































































































































































































<table><thead><tr><th>Resource Type</th><th>Short Code</th><th>Scope</th><th>Character Limit</th></tr></thead><tbody><tr><td>App Service</td><td>asvc</td><td>Global</td><td>40</td></tr><tr><td>App Service Environment</td><td>ase</td><td>Resource Group</td><td>38</td></tr><tr><td>App Service Plan</td><td>asp</td><td>Resource Group</td><td>40</td></tr><tr><td>Application Gateway</td><td>agw</td><td>Resource Group</td><td>80</td></tr><tr><td>Automation Account</td><td>aum</td><td>Resource Group</td><td>50</td></tr><tr><td>Availability Set</td><td>avs</td><td>Resource Group</td><td>80</td></tr><tr><td>Azure Arc enabled Kubernetes cluster</td><td>arck</td><td>Resource Group</td><td>63</td></tr><tr><td>Azure Arc enabled server</td><td>arcs</td><td>Resource Group</td><td>15</td></tr><tr><td>Azure Cosmos DB database</td><td>cosmos</td><td>Global</td><td>63</td></tr><tr><td>Azure Data Factory</td><td>adf</td><td>Global</td><td>63</td></tr><tr><td>Azure Search</td><td>srch</td><td>Global</td><td>60</td></tr><tr><td>Azure SQL Database</td><td>sqldb</td><td>Server</td><td>128</td></tr><tr><td>Azure SQL Elastic Pool</td><td>sqlep</td><td>Server</td><td>128</td></tr><tr><td>Azure SQL Server</td><td>sql</td><td>Global</td><td>63</td></tr><tr><td>Container registry</td><td>cr</td><td>Global</td><td>50</td></tr><tr><td>Cosmos DB</td><td>cdb</td><td>Global</td><td>50</td></tr><tr><td>Function App</td><td>func</td><td>Global</td><td>40</td></tr><tr><td>Gateway connection</td><td>cn</td><td>Resource Group</td><td>80</td></tr><tr><td>IoT Central</td><td>iotc</td><td>Global</td><td>63</td></tr><tr><td>Key Vault</td><td>kv</td><td>Global</td><td>24</td></tr><tr><td>Load Balancer</td><td>lb</td><td>Resource Group</td><td>80</td></tr><tr><td>Local Network Gateway</td><td>lgw</td><td>Resource Group</td><td>80</td></tr><tr><td>Log Analytics workspace</td><td>la</td><td>Global</td><td>24</td></tr><tr><td>MySQL database</td><td>mysql</td><td>Global</td><td>63</td></tr><tr><td>Network Interface</td><td>nic</td><td>Resource Group</td><td>80</td></tr><tr><td>Network Security Group</td><td>nsg</td><td>Resource Group</td><td>80</td></tr><tr><td>Network Security Group Rule</td><td>nsg</td><td>Resource Group</td><td>80</td></tr><tr><td>Public IP Address</td><td>pip</td><td>Resource Group</td><td>80</td></tr><tr><td>Recovery Services vault</td><td>rsv</td><td>Resource Group</td><td>50</td></tr><tr><td>Recovery Services Vault - Backup policies</td><td>rsvp</td><td>vault</td><td>50</td></tr><tr><td>Resource Group</td><td>rg</td><td>Global</td><td>64</td></tr><tr><td>Route table</td><td>route</td><td>Resource Group</td><td>80</td></tr><tr><td>Runbooks</td><td>run</td><td>Automation Account</td><td>63</td></tr><tr><td>Service Bus - Namespace</td><td>sbns</td><td>Global</td><td>50</td></tr><tr><td>SQL Data Warehouse</td><td>sqldw</td><td>Global</td><td>63</td></tr><tr><td>SQL Managed Instance</td><td>sqlmi</td><td>Global</td><td>63</td></tr><tr><td>Storage Account</td><td>stg</td><td>Global</td><td>24</td></tr><tr><td>Subnet</td><td>snet</td><td>Virtual Network</td><td>80</td></tr><tr><td>Subscription</td><td>sub</td><td>Account</td><td>64</td></tr><tr><td>Traffic Manager Profile</td><td>tmp</td><td>Resource Group</td><td>63</td></tr><tr><td>User defined route (UDR)</td><td>udr</td><td>Resource Group</td><td>80</td></tr><tr><td>Virtual Machine</td><td>vm</td><td>Resource Group</td><td>15</td></tr><tr><td>Virtual machine scale set</td><td>vmss</td><td>Resource Group</td><td>15</td></tr><tr><td>Virtual Network</td><td>vn</td><td>Resource Group</td><td>63</td></tr><tr><td>Virtual Network Gateway</td><td>vngw</td><td>Resource Group</td><td>80</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="environment-names">Environment Names<a href="#environment-names" class="hash-link" aria-label="Direct link to Environment Names" title="Direct link to Environment Names">​</a></h3>

























<table><thead><tr><th>Environment Name</th><th>Long Code</th></tr></thead><tbody><tr><td>Development</td><td>dev</td></tr><tr><td>Test</td><td>test</td></tr><tr><td>Staging</td><td>stg</td></tr><tr><td>Production</td><td>prod</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="azure-regions">Azure Regions<a href="#azure-regions" class="hash-link" aria-label="Direct link to Azure Regions" title="Direct link to Azure Regions">​</a></h3>













































































<table><thead><tr><th>Azure Region</th><th>Geo Short Code</th><th>Datacentre Short Code</th><th>Short Code</th></tr></thead><tbody><tr><td>East US</td><td>us</td><td>e</td><td>us-e</td></tr><tr><td>East US 2</td><td>us</td><td>e2</td><td>us-e2</td></tr><tr><td>Central US</td><td>us</td><td>c</td><td>us-c</td></tr><tr><td>North Central US</td><td>us</td><td>cn</td><td>us-cn</td></tr><tr><td>West Central US</td><td>us</td><td>cw</td><td>us-cw</td></tr><tr><td>West US</td><td>us</td><td>w</td><td>us-w</td></tr><tr><td>West US 2</td><td>us</td><td>w2</td><td>us-w2</td></tr><tr><td>Australia East</td><td>au</td><td>e</td><td>au-e</td></tr><tr><td>Australia Southeast</td><td>au</td><td>se</td><td>au-se</td></tr><tr><td>Australia Central</td><td>au</td><td>c</td><td>au-c</td></tr><tr><td>New Zealand North</td><td>nz</td><td>n</td><td>nz-n</td></tr></tbody></table></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/azure/">Azure</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/azure/microsoft-azure-tagging-conventions/">Microsoft Azure Tagging Conventions</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-06-01T12:00:00.000Z">June 1, 2022</time> · <!-- -->5 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://luke.geek.nz/img/logo.png" alt="Luke Murray"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">Luke Murray</span></a></div><small class="authorTitle_nd0D" title="Author">Author</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><p>Organizing cloud-based resources is a crucial task for IT unless you only have simple deployments. Use naming and tagging standards to organize your resources for these reasons:</p>
<ul>
<li><strong>Resource management</strong>: Your IT teams will need to quickly locate resources associated with specific workloads, environments, ownership groups, or other important information. Organizing resources is critical to assigning organizational roles and access permissions for resource management.</li>
<li><strong>Cost management and optimization</strong>: Making business groups aware of cloud resource consumption requires IT to understand each team&#x27;s resources and workloads.</li>
<li><strong>Operations management</strong>: Visibility for the operations management team regarding business commitments and SLAs is an essential aspect of ongoing operations.</li>
<li><strong>Security:</strong> Classification of data and security impact is a vital data point for the team when breaches or other security issues arise.</li>
<li><strong>Governance and regulatory compliance:</strong> Maintaining consistency across resources helps identify deviation from agreed-upon policies.</li>
<li><strong>Automation:</strong> In addition to making resources easier for IT to manage, a proper organizational scheme allows you to take advantage of automation as part of resource creation, operational monitoring, and the result of DevOps processes.</li>
</ul>
<p><strong>Workload optimization:</strong> Tagging can help identify patterns and resolve broad issues. A tag can also help determine the assets required to support a single workload. Tagging all assets associated with each workload enables a more profound analysis of your mission-critical workloads to make sound architectural decisions.</p>
<ul>
<li><a href="https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/tag-resources?tabs=json&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Use tags to organize your Azure resources and management hierarchy">Use tags to organize your Azure resources and management hierarchy</a></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="tagging-types">Tagging Types<a href="#tagging-types" class="hash-link" aria-label="Direct link to Tagging Types" title="Direct link to Tagging Types">​</a></h3>
<p>The common tagging patterns listed below provide examples of how tagging can be used to organize cloud assets. These patterns are not meant to be exclusive and can be used in parallel, providing multiple ways of organizing assets based on your company&#x27;s needs.</p>



































<table><thead><tr><th>Tag type</th><th>Examples</th><th>Description</th></tr></thead><tbody><tr><td>Functional</td><td>app = catalogsearch1 tier = web webserver = apache env = prod env = staging env = dev</td><td>Categorize resources in relation to their purpose within a workload, what environment they have been deployed to, or other functionality and operational details.</td></tr><tr><td>Classification</td><td>confidentiality = private SLA = 24hours</td><td>Classifies a resource by how it is used and what policies apply to it.</td></tr><tr><td>Accounting</td><td>department = finance program = business-initiative region = northamerica</td><td>Allows a resource to be associated with specific groups within an organization for billing purposes.</td></tr><tr><td>Partnership</td><td>owner = jsmith contactalias = catsearchowners stakeholders = user1; user2; user3</td><td>Provides information about what people (outside of IT) are related or otherwise affected by the resource.</td></tr><tr><td>Purpose</td><td>businessprocess = support businessimpact = moderate revenueimpact = high</td><td>Aligns resources to business functions to better support investment decisions.</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="tagging-baselines">Tagging Baselines<a href="#tagging-baselines" class="hash-link" aria-label="Direct link to Tagging Baselines" title="Direct link to Tagging Baselines">​</a></h3>
<p>Tag at the Resource Group level and then have an Azure policy implemented that tags the resources in that Resource Group with the appropriate tags.</p>

























































































<table><thead><tr><th>Tag Name</th><th>Value</th><th>Tag Type</th><th>Description</th><th>Example</th></tr></thead><tbody><tr><td>Environment</td><td>Production Development Sandbox</td><td>Functional</td><td>Tags the resources with the Environment Tag. This can be used to determine if a resource is Production, Development or Sandbox.</td><td>Environment: Production</td></tr><tr><td>Creator</td><td>{CreatorName}</td><td>Partnership</td><td>Tags the resource with the name of who created the resource. This can be used to determine who created the resource to be able to get more information.</td><td>Creator: Luke Murray</td></tr><tr><td>CreatedDate</td><td>{CreatedDate}</td><td>Purpose</td><td>Tags the resource with the Date/Time when the resource was created. This can be used to determine how old a resource is, which can be used to look at new functionality on created resources or check if resources are still required.</td><td>CreatedDate: 10:00 PM 03/06/2022 NZT</td></tr><tr><td>Criticality</td><td>P1 P2 P3</td><td>Purpose</td><td>Tags the resources with the criticality of the resources, i.e., if critical, then it is P1. This can be used to determine whether resources need to be highly available, whether changes can be made during or out of business hours.</td><td>Criticality:P1</td></tr><tr><td>SupportedBy</td><td>{TeamName}</td><td>Partnership</td><td>Tags the resources with the team/person or company who supports the resources, whether it is internally supported by the company or outsourced.</td><td>SupportedBy:Company</td></tr><tr><td>RequesterName</td><td>{Requestor}-{CompanyName)</td><td>Partnership</td><td>Tags the resources with the user that requested the creation of the resources.</td><td>RequesterName:Project Manager</td></tr><tr><td>BillTo</td><td>{BillTo}</td><td>Accounting</td><td>Tags the resources with the cost centre or project codes who will pay for the resources.</td><td>BillTo:AppTransformationProject1</td></tr><tr><td>AutoShutDown</td><td>Yes</td><td>Functional</td><td>This is an Automation functional tag, i.e., tag the resource (Virtual Machine) with a tagging code which will automatically Shut down and Start-up the Virtual Machine at specified times.</td><td>AutoShutDown:Yes</td></tr><tr><td>ApplicationName</td><td>{ProjectName}</td><td>Partnership</td><td>Tags the resource with the name of the project or what the resources in the resource group are for.</td><td>ApplicationName:AzureVirtualDesktopSH</td></tr><tr><td>Business Unit</td><td>{BusinessUnit}</td><td>Partnership</td><td>Tags the resource with the name of the Business Unit or Company that owns the resources.</td><td>BusinessUnit:Finance</td></tr><tr><td>Snapshot</td><td>True</td><td>Functional</td><td>This is an Automation functional tag, i.e., tag the resource (Disk) with a tagging code which can create daily snapshots of disks.</td><td>Snapshot:True</td></tr></tbody></table></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/azure/">Azure</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/azure/architecture-in-the-cloud/">Architecture in the Cloud</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-05-30T00:00:00.000Z">May 30, 2022</time> · <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://luke.geek.nz/img/logo.png" alt="Luke Murray"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">Luke Murray</span></a></div><small class="authorTitle_nd0D" title="Author">Author</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><p>Solution architecture is concerned with the planning, design, implementation, and ongoing improvement of a technology system.</p>
<p>The architecture of a system must balance and align the business requirements with the technical capabilities that are needed to execute those requirements.</p>
<p>The finished architecture is a balance of risk, cost, and capability throughout the system and its components.</p>
<p>Running a solution in the cloud does not reduce the need for requirements to be clear. In fact, the flexibility and power provided by the cloud mean that it is even more important to have clear requirements from business stakeholders; otherwise, you could end up solving problems that don&#x27;t exist, missing an important design decision, or going beyond the available budget by adding unnecessary resiliency.</p>
<p><img decoding="async" loading="lazy" alt="Requirements and Architecture" src="/assets/images/requirementsandarchitecture-bc4f513c2f5b1e235b05504d13422ef8.png" title="Requirements and Architecture" width="903" height="333" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="non-functional-requirements-nfrs">Non-functional requirements <em>(NFRs)</em><a href="#non-functional-requirements-nfrs" class="hash-link" aria-label="Direct link to non-functional-requirements-nfrs" title="Direct link to non-functional-requirements-nfrs">​</a></h4>
<p>Below is a short list of NFRs (not exhaustive) that may be provided by the business to help inform the design of a solution.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="reliability-requirements"><strong>Reliability requirements</strong><a href="#reliability-requirements" class="hash-link" aria-label="Direct link to reliability-requirements" title="Direct link to reliability-requirements">​</a></h5>
<ul>
<li>Service level agreement (SLA)</li>
<li>Uptime objective</li>
<li>Recovery time objective (RTO)</li>
<li>Recovery point objective (RPO)</li>
<li>Recoverability</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="security-requirements"><strong>Security requirements</strong><a href="#security-requirements" class="hash-link" aria-label="Direct link to security-requirements" title="Direct link to security-requirements">​</a></h5>
<ul>
<li>Geographical location</li>
<li>Compliance and legislation</li>
<li>Identity and access management</li>
<li>Privacy</li>
<li>Data Integrity</li>
<li>Public or private endpoints (or both)</li>
<li>OWASP</li>
<li>Hybrid connectivity</li>
<li>DDOS</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="performance-requirements"><strong>Performance requirements</strong><a href="#performance-requirements" class="hash-link" aria-label="Direct link to performance-requirements" title="Direct link to performance-requirements">​</a></h5>
<ul>
<li>Peak throughput, e.g., Requests per minute (RPM), active users</li>
<li>Business plan for growth</li>
<li>UX metrics (e.g., Page load time)</li>
<li>Asynchronous vs Synchronous operations</li>
<li>Workload profile (predictable, unpredictable, peak time of day)</li>
<li>Scalability</li>
<li>Data estate size and growth rate</li>
<li>Time-to-live (TTL) of reports and views (real-time vs eventual consistency)</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="operational-requirements"><strong>Operational requirements</strong><a href="#operational-requirements" class="hash-link" aria-label="Direct link to operational-requirements" title="Direct link to operational-requirements">​</a></h5>
<ul>
<li>Prod and non-prod environments (Dev/Test, QA, Pre-prod, Prod)</li>
<li>Release frequency (hours / days / months)</li>
<li>Time to onboard (new customer)</li>
<li>Licensing</li>
<li>Cost <em>(Management)</em></li>
<li>Manageability</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="cost-optimization"><strong>Cost optimization</strong><a href="#cost-optimization" class="hash-link" aria-label="Direct link to cost-optimization" title="Direct link to cost-optimization">​</a></h5>
<ul>
<li>Cost per user</li>
<li>Target hosting costs as a percentage of revenue</li>
<li>Pricing model</li>
<li>Tenancy model</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="azure-slas"><strong>Azure SLAs</strong><a href="#azure-slas" class="hash-link" aria-label="Direct link to azure-slas" title="Direct link to azure-slas">​</a></h5>
<ul>
<li>Familiarize yourself with <a href="https://azure.microsoft.com/en-au/support/legal/sla/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title=" Service-level agreements">Azure service-level agreements</a></li>
<li>An Azure Service-level Agreement (SLA) can also be read as a minimum service-level objective (SLO).</li>
<li>An SLA is a financial guarantee, not an absolute guarantee</li>
<li>Read the SLA details carefully, particularly the definition of &quot;downtime&quot; for each service, which gives important hints about failure modes</li>
</ul>
<p>For example, in the <a href="https://azure.microsoft.com/en-au/support/legal/sla/azure-sql-database/v1_8/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title=" SLA for Azure SQL Database">SLA for Azure SQL Database</a>, &quot;downtime&quot; is defined as:</p>
<p><em>&quot;The total accumulated Deployment Minutes across all Databases in a given Microsoft Azure subscription during which the Database is unavailable. A minute is considered unavailable for a given Database if all continuous attempts by Customer to establish a connection to the Database within the minute fail.&quot;</em></p>
<p>The Azure SQL Database team expect almost all outages to be transient (brief and non-recurring). Therefore, the retry pattern should be used to continuously retry for up to a minute. This is typical in cloud services; retry has been the default behaviour in ADO.NET since .NET Framework 4.6.1.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="external-resources">External Resources<a href="#external-resources" class="hash-link" aria-label="Direct link to External Resources" title="Direct link to External Resources">​</a></h4>
<p>Finally, resources such as the Azure Architecture Center, Cloud Adoption and Well-Architected Framework can help with thinking around the design and building blocks of your architecture</p>
<ul>
<li><a href="https://learn.microsoft.com/en-us/azure/architecture/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Azure Architecture Center"><strong>Azure Architecture Center</strong></a></li>
<li><a href="https://learn.microsoft.com/en-us/azure/architecture/framework/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Microsoft Azure Well-Architected Framework"><strong>Microsoft Azure Well-Architected Framework</strong></a></li>
<li><a href="https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Microsoft Cloud Adoption Framework for Azure"><strong>Microsoft Cloud Adoption Framework for Azure</strong></a></li>
</ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/azure/">Azure</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/2022/05/12/deallocate-stopped-virtual-machines-using-azure-automation/">Deallocate &#x27;Stopped&#x27; Virtual Machines using Azure Automation</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-05-12T00:00:00.000Z">May 12, 2022</time> · <!-- -->13 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://luke.geek.nz/img/logo.png" alt="Luke Murray"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">Luke Murray</span></a></div><small class="authorTitle_nd0D" title="Author">Author</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><p><a href="https://azure.microsoft.com/en-us/overview/what-is-a-virtual-machine/?WT.mc_id=AZ-MVP-5004796#overview" target="_blank" rel="noopener noreferrer" title=" What is a virtual machine (VM)?">Virtual Machines</a> in Microsoft Azure have different states and, depending on what state the Virtual Machine is in, will determine whether you get billed or not <em>(for the Compute, storage and network adapters are still billed)</em>.</p>








































<table><thead><tr><th>Power state</th><th>Description</th><th>Billing</th></tr></thead><tbody><tr><td>Starting</td><td>Virtual Machine is powering up.</td><td>Billed</td></tr><tr><td>Running</td><td>Virtual Machine is fully up. This is the standard working state.</td><td>Billed</td></tr><tr><td>Stopping</td><td>This is a transitional state between running and stopped.</td><td>Billed</td></tr><tr><td>Stopped</td><td>The Virtual Machine is allocated on a host but not running. Also called PoweredOff state or Stopped (Allocated). This can be result of invoking the PowerOff API operation or invoking shutdown from within the guest OS. The Stopped state may also be observed briefly during VM creation or while starting a VM from Deallocated state.</td><td>Billed</td></tr><tr><td>Deallocating</td><td>This is the transitional state between running and deallocated.</td><td>Not billed</td></tr><tr><td>Deallocated</td><td>The Virtual Machine has released the lease on the underlying hardware and is completely powered off. This state is also referred to as Stopped (Deallocated).</td><td>Not billed</td></tr></tbody></table>
<p>Suppose a Virtual Machine is not being used. In that case, turning off a Virtual Machine from the Microsoft Azure Portal <em>(or programmatically via</em> <a href="https://learn.microsoft.com/en-us/powershell/azure/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Azure PowerShell Documentation"><em>PowerShell</em></a><em>/</em><a href="https://learn.microsoft.com/en-us/cli/azure/install-azure-cli?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="How to install the Azure CLI"><em>Azure CLI</em></a><em>)</em> is recommended to ensure that the Virtual Machine is deallocated and its affinity on the host has been released.</p>
<p><img decoding="async" loading="lazy" alt="Microsoft Azure - Virtual Machine Power States" src="/assets/images/azvm-power-states-c67f8a6c163301a9851ce1e794a9cb8a.png" title="Microsoft Azure - Virtual Machine Power States" width="1212" height="416" class="img_ev3q"></p>
<p>However, you need to know this, and those new to Microsoft Azure, or users who don&#x27;t have <a href="https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Azure built-in roles">Virtual Machine Administrator</a> rights to deallocate a Virtual Machine, may simply shut down the operating system, leaving the Virtual Machine in a &#x27;Stopped&#x27; state, but still tied to an underlying Azure host and incurring cost.</p>
<p>Our solution can help; by triggering an Alert when a Virtual Machine becomes unavailable due to a user-initiated shutdown, we can then start an <a href="https://learn.microsoft.com/en-us/azure/automation/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Automation</a> runbook to deallocate the Virtual Machine.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">​</a></h3>
<p>Today, we are going to set up an Azure Automation runbook, triggered by a Resource Health alert that will go through the following steps:</p>
<ol>
<li>User shutdowns Virtual Machine from within the Operating System</li>
<li>The Virtual Machine enters an unavailable state</li>
<li>A Resource Alert is triggered when the Virtual Machine becomes unavailable (after being available) by a user initiated event</li>
<li>The Alert triggers a Webhook to an Azure Automation runbook</li>
<li>Using permissions assigned to the Azure Automation account through a System Managed Identity connects to Microsoft Azure and checks the VM state; if the Virtual Machine state is still &#x27;Stopped&#x27;, then deallocate the virtual machine.</li>
<li>Then finally, resolve the triggered alert.</li>
</ol>
<p>To do this, we need a few resources.</p>
<ul>
<li>Azure Automation Account</li>
<li>Az.AlertsManagement module in the Azure Automation account</li>
<li>Az.Accounts module <em>(updated in the Azure Automation account)</em></li>
<li>Azure Automation runbook <em>(I will supply this below)</em></li>
<li>Resource Health Alert</li>
<li>Webhook <em>(to trigger to the runbook and pass the JSON from the alert)</em></li>
</ul>
<p>And, of course, &#x27;Contributor&#x27; rights to the Microsoft Azure subscription to provide the resources and the alerts and resources and set up the system managed identity.</p>
<p>We will set up this from scratch using the Azure Portal and an already created PowerShell Azure Automation runbook.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="deploy-deallocate-solution">Deploy Deallocate Solution<a href="#deploy-deallocate-solution" class="hash-link" aria-label="Direct link to Deploy Deallocate Solution" title="Direct link to Deploy Deallocate Solution">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="setup-azure-automation-account">Setup Azure Automation Account<a href="#setup-azure-automation-account" class="hash-link" aria-label="Direct link to Setup Azure Automation Account" title="Direct link to Setup Azure Automation Account">​</a></h4>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="create-azure-automation-account">Create Azure Automation Account<a href="#create-azure-automation-account" class="hash-link" aria-label="Direct link to Create Azure Automation Account" title="Direct link to Create Azure Automation Account">​</a></h5>
<p>First, we need an <a href="https://learn.microsoft.com/en-us/azure/automation/automation-create-standalone-account?tabs=azureportal&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Create a standalone Azure Automation account">Azure Automation</a> resource.</p>
<ol>
<li>Log into the <a href="https://portal.azure.com/#home" target="_blank" rel="noopener noreferrer" title="Microsoft Azure Portal"><strong>Microsoft Azure Portal</strong></a>.</li>
<li>Click <strong>+ Create a resource.</strong></li>
<li>Type in <strong>automation</strong></li>
<li>Select <strong>Create</strong> under Automation, and select <strong>Automation.</strong></li>
<li><img decoding="async" loading="lazy" alt="Create Azure Automation Account" src="/assets/images/azureportal-create-automation-f17fe5866b2554fab2016911fdae4250.jpg" title="Create Azure Automation Account" width="426" height="573" class="img_ev3q"></li>
<li>Select your <strong>subscription</strong></li>
<li>Select your <strong>Resource Group</strong> or Create one if you don&#x27;t already have one <em>(I recommend placing your automation resources in an Azure Management or Automation resource group, this will also contain your Runbooks)</em></li>
<li>Select your <strong>region</strong></li>
<li><img decoding="async" loading="lazy" alt="Create Azure Automation Account" src="/assets/images/azureportal-create-automation_basics-1389cb6873b6fc1b5c884f01279f38c4.jpg" title="Create Azure Automation Account" width="749" height="479" class="img_ev3q"></li>
<li>Select <strong>Next</strong></li>
<li>Make sure: <strong>System assigned</strong> is selected for Managed identities <em>(this will be required for giving your automation account permissions to deallocate your Virtual Machine, but it can be enabled later if you already have an Azure Automation account)</em>.</li>
<li>Click <strong>Next</strong></li>
<li>Leave Network connectivity as default (<strong>Public access</strong>)</li>
<li>Click <strong>Next</strong></li>
<li><strong>Enter</strong> in appropriate <strong>tags</strong></li>
<li><img decoding="async" loading="lazy" alt="Create Azure Automation Account" src="/assets/images/azureportal-create-automation_tags-cf8d12ea6a602ac7d4d3019f34458da0.jpg" title="Create Azure Automation Account" width="753" height="524" class="img_ev3q"></li>
<li>Click <strong>Review + Create</strong></li>
<li>After validation has passed, select <strong>Create</strong></li>
</ol>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="configure-system-identity">Configure System Identity<a href="#configure-system-identity" class="hash-link" aria-label="Direct link to Configure System Identity" title="Direct link to Configure System Identity">​</a></h5>
<p>Now that we have our Azure Automation account, its time to set up the System Managed Identity and grant it the following roles:</p>
<ul>
<li>Virtual Machine Contributor <em>(to deallocate the Virtual Machine)</em></li>
<li>Monitoring Contributor <em>(to close the Azure Alert)</em></li>
</ul>
<p>You can set up a custom role to be least privileged and use that instead. But in this article, we will stick to the built-in roles.</p>
<ol>
<li>Log into the <a href="https://portal.azure.com/#home" target="_blank" rel="noopener noreferrer" title="Microsoft Azure Portal"><strong>Microsoft Azure Portal</strong></a>.</li>
<li>Navigate to your Azure <strong>Automation account</strong></li>
<li>Click on: <strong>Identity</strong></li>
<li>Make sure that the <strong>System assigned</strong> toggle is: <strong>On</strong> and click <strong>Azure role assignments.</strong></li>
<li><img decoding="async" loading="lazy" alt="Azure Automation Account managed identity" src="/assets/images/azureportal-automation_managedidentity-46173e0eb415b07c841cfd616266eb7c.jpg" title="Azure Automation Account managed identity" width="773" height="706" class="img_ev3q"></li>
<li>Click <strong>+ Add role assignments</strong></li>
<li>Select the <strong>Subscription</strong> <em>(make sure this subscription matches the same subscription your Virtual Machines are in)</em></li>
<li>Select Role: <strong>Virtual Machine Contributor</strong></li>
<li>Click <strong>Save</strong></li>
<li>Now we repeat the same process for <strong>Monitoring Contributor</strong></li>
<li>lick <strong>+ Add role assignments</strong></li>
<li>Select the <strong>Subscription</strong> <em>(make sure this subscription matches the same subscription your Virtual Machines are in)</em></li>
<li>Select Role: <strong>Monitoring Contributor</strong></li>
<li>Click <strong>Save</strong></li>
<li>Click <strong>Refresh</strong> <em>(it may take a few seconds to update the Portal, so if it is blank - give it 10 seconds and try again)</em>.</li>
<li>You have now set up the System Managed identity and granted it the roles necessary to execute the automation.</li>
</ol>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="import-modules">Import Modules<a href="#import-modules" class="hash-link" aria-label="Direct link to Import Modules" title="Direct link to Import Modules">​</a></h5>
<p>We will use the Azure Runbook and use a few Azure PowerShell Modules; by default, Azure Automation has the base Azure PowerShell modules, but we will need to add <a href="https://learn.microsoft.com/en-us/powershell/module/az.alertsmanagement/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Az.AlertsManagement">Az.AlertsManagement</a>, and update the Az.Accounts as required as a pre-requisite for Az.AlertsManagement.</p>
<ol>
<li>Log into the <a href="https://portal.azure.com/#home" target="_blank" rel="noopener noreferrer" title="Microsoft Azure Portal"><strong>Microsoft Azure Portal</strong></a>.</li>
<li>Navigate to your Azure <strong>Automation account</strong></li>
<li>Click on <strong>Modules</strong></li>
<li>Click on <strong>+ Add a module</strong></li>
<li>Click on <strong>Browse from Gallery</strong></li>
<li>Click: <strong>Click here to browse from the gallery</strong></li>
<li>Type in: <strong>Az.Accounts</strong></li>
<li>Press <strong>Enter</strong></li>
<li>Click on <strong>Az.Accounts</strong></li>
<li>Click <strong>Select</strong></li>
<li><img decoding="async" loading="lazy" alt="Import Az.Accounts module" src="/assets/images/azureportal-automation_modules_az-accounts-6b84545ff7cf24ce120cd93e0c255a97.jpg" title="Import Az.Accounts module" width="738" height="417" class="img_ev3q"></li>
<li>Make sure that the Runtime version is: <strong>5.1</strong></li>
<li>Click <strong>Import</strong></li>
<li>Now that the Az.Accounts have been updated, and it&#x27;s time to import Az.AlertsManagement!</li>
<li>Click on <strong>Modules</strong></li>
<li>Click on <strong>+ Add a module</strong></li>
<li>Click on <strong>Browse from Gallery</strong></li>
<li>Click: <strong>Click here to browse from the gallery</strong></li>
<li>Type in: <strong>Az.AlertsManagement</strong> <em>(note its Alert<strong>s)</strong></em></li>
<li>Click <strong>Az.AlertsManagement</strong></li>
<li><img decoding="async" loading="lazy" alt="Az.AlertsManagement module" src="/assets/images/azureportal-automation_modules_az-alertsmanagement-3e56fcc89310e58f9e631b4e713107b3.jpg" title="Az.AlertsManagement module" width="1319" height="1019" class="img_ev3q"></li>
<li>Click <strong>Select</strong></li>
<li>Make sure that the Runtime version is: <strong>5.1</strong></li>
<li>Click <strong>Import</strong> <em>(if you get an error, make sure that Az.Accounts has been updated, through the Gallery import as above)</em></li>
<li>Now you have successfully added the dependent modules!</li>
</ol>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="import-runbook">Import Runbook<a href="#import-runbook" class="hash-link" aria-label="Direct link to Import Runbook" title="Direct link to Import Runbook">​</a></h5>
<p>Now that the modules have been imported into your Azure Automation account, it is time to import the Azure Automation runbook.</p>
<ol>
<li>Log into the <a href="https://portal.azure.com/#home" target="_blank" rel="noopener noreferrer" title="Microsoft Azure Portal"><strong>Microsoft Azure Portal</strong></a>.</li>
<li>Navigate to your Azure <strong>Automation account</strong></li>
<li>Click on <strong>Runbooks</strong></li>
<li>Click <strong>+ Create a runbook</strong></li>
<li>Specify a <strong>name</strong> <em>(i.e. Deallocate-AzureVirtualMachine)</em></li>
<li>Select Runbook type of: <strong>PowerShell</strong></li>
<li>Select Runtime version of: <strong>5.1</strong></li>
<li>Type in a <strong>Description</strong> that explains the runbook <em>(this isn&#x27;t mandatory, but like Tags is recommended, this is an opportunity to indicate to others what it is for and who set it up)</em></li>
<li><img decoding="async" loading="lazy" alt="Create Azure Runbook" src="/assets/images/azureportal-runbook-create-3d404335d690517ee5dd2ccad6d62a58.jpg" title="Create Azure Runbook" width="735" height="467" class="img_ev3q"></li>
<li>Click <strong>Create</strong></li>
<li>Now you will be greeted with a blank edit pane; paste in the Runbook from below:</li>
</ol>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">Deallocate-AzureVirtualMachine.ps1</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">#requires -Version 3.0 -Modules Az.Accounts, Az.AlertsManagement</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">&lt;#</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    .SYNOPSIS</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    PowerShell Azure Automation Runbook for Stopping Virtual Machines, that have been Shutdown within the Windows Operating System (Stopped and not Deallocated). </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    .AUTHOR</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    Luke Murray (https://github.com/lukemurraynz/)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">#&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">OutputType</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;PSAzureOperationResponse&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">Parameter</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">Mandatory = </span><span class="token boolean">$true</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> HelpMessage = </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Data from the WebHook/Azure Alert&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token namespace">[Object]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$WebhookData</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Import-Module</span><span class="token plain"> Az</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">AlertsManagement</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ErrorActionPreference</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;stop&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Get the data object from WebhookData</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$WebhookData</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$WebhookData</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">RequestBody</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">InputObject </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$WebhookData</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$Schema</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$WebhookData</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">ConvertFrom-Json</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">#Sets the Webhook data into object</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$Essentials</span><span class="token plain"> = </span><span class="token namespace">[object]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$Schema</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">essentials</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">InputObject </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$Essentials</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Get the first target only as this script doesn&#x27;t handle multiple and and export variables for the resource.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$alertIdArray</span><span class="token plain"> = </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$Essentials</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">alertId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Split</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;/&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$alertTargetIdArray</span><span class="token plain"> = </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$Essentials</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">alertTargetIds</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Split</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;/&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$alertid</span><span class="token plain"> =  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$alertIdArray</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">6</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$SubId</span><span class="token plain"> = </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$alertTargetIdArray</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceGroupName</span><span class="token plain"> = </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$alertTargetIdArray</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">4</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceType</span><span class="token plain"> = </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$alertTargetIdArray</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">6</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;/&#x27;</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$alertTargetIdArray</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">7</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceName</span><span class="token plain"> = </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$alertTargetIdArray</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token operator">-</span><span class="token plain">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$status</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$Essentials</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">monitorCondition</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">InputObject </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$alertTargetIdArray</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain">  </span><span class="token operator">-</span><span class="token plain">InputObject </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;status: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$status</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Verbose</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">#Sets VM shutdown</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$status</span><span class="token plain"> </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Activated&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">-or</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$status</span><span class="token plain"> </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Fired&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$status</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$Essentials</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">monitorCondition</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">InputObject </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;resourceType: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceType</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Verbose</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain">  </span><span class="token operator">-</span><span class="token plain">InputObject </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;resourceName: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceName</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Verbose</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain">  </span><span class="token operator">-</span><span class="token plain">InputObject </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;resourceGroupName: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceGroupName</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Verbose</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain">  </span><span class="token operator">-</span><span class="token plain">InputObject </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;subscriptionId: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$SubId</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Verbose</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Determine code path depending on the resourceType</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceType</span><span class="token plain"> </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Microsoft.Compute/virtualMachines&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># This is an Resource Manager VM</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain">  </span><span class="token operator">-</span><span class="token plain">InputObject </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;This is an Resource Manager VM.&#x27;</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Verbose</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Ensures you do not inherit an AzContext in your runbook</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Disable-AzContextAutosave</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Scope </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">Process</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Connect to Azure with system-assigned managed identity</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$AzureContext</span><span class="token plain"> = </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token function" style="color:rgb(80, 250, 123)">Connect-AzAccount</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Identity</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">context</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># set and store context</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$AzureContext</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Set-AzContext</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">SubscriptionName </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$AzureContext</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Subscription </span><span class="token operator">-</span><span class="token plain">DefaultProfile </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$AzureContext</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain">   </span><span class="token operator">-</span><span class="token plain">InputObject </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$AzureContext</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)">#Checks Azure VM status</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$VMStatus</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzVM</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ResourceGroupName </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceGroupName</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceName</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Status</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain">  </span><span class="token operator">-</span><span class="token plain">InputObject </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$VMStatus</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">If</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$VMStatus</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Statuses</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Code </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;PowerState/stopped&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain">  </span><span class="token operator">-</span><span class="token plain">InputObject </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Stopping the VM, it was Shutdown without being Deallocated - </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceName</span><span class="token string" style="color:rgb(255, 121, 198)"> - in resource group - </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceGroupName</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Verbose</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Stop-AzVM</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceName</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ResourceGroupName </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceGroupName</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">DefaultProfile </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$AzureContext</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Force </span><span class="token operator">-</span><span class="token plain">Verbose</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token comment" style="color:rgb(98, 114, 164)">#Check VM Status after deallocation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$VMStatus</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzVM</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ResourceGroupName </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceGroupName</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceName</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Status </span><span class="token operator">-</span><span class="token plain">Verbose</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain">  </span><span class="token operator">-</span><span class="token plain">InputObject </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$VMStatus</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">If</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$VMStatus</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Statuses</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Code </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;PowerState/deallocated&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token comment" style="color:rgb(98, 114, 164)">#Closes Alert</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain">  </span><span class="token operator">-</span><span class="token plain">InputObject </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$VMStatus</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Statuses</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Code</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain">  </span><span class="token operator">-</span><span class="token plain">InputObject </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$alertid</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzAlert</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">AlertId </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$alertid</span><span class="token plain">  </span><span class="token operator">-</span><span class="token plain">verbose </span><span class="token operator">-</span><span class="token plain">DefaultProfile </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$AzureContext</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzAlert</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">AlertId </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$alertid</span><span class="token plain">  </span><span class="token operator">-</span><span class="token plain">verbose </span><span class="token operator">-</span><span class="token plain">DefaultProfile </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$AzureContext</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Update-AzAlertState</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">State </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Closed&#x27;</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Verbose </span><span class="token operator">-</span><span class="token plain">DefaultProfile </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$AzureContext</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">             </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">Elseif</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$VMStatus</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Statuses</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Code </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;PowerState/deallocated&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain">  </span><span class="token operator">-</span><span class="token plain">InputObject </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Already deallocated&#x27;</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Verbose</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">Elseif</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$VMStatus</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Statuses</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Code </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;PowerState/running&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain">  </span><span class="token operator">-</span><span class="token plain">InputObject </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;VM running. No further actions&#x27;</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Verbose</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># [OutputType(PSAzureOperationResponse&quot;)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># The alert status was not &#x27;Activated&#x27; or &#x27;Fired&#x27; so no action taken</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain">  </span><span class="token operator">-</span><span class="token plain">InputObject </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;No action taken. Alert status: &#x27;</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$status</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Verbose</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="13">
<li>Click <strong>Save</strong></li>
<li><img decoding="async" loading="lazy" alt="Azure Automation runbook" src="/assets/images/azureportal-runbook-import-9ad03aed284d9f134d6f103fbbaf3703.jpg" title="Azure Automation runbook" width="1160" height="993" class="img_ev3q"></li>
<li>Click <strong>Publish</strong> <em>(so the runbook is actually in production and can be used)</em></li>
<li>You can select View or Edit at any stage, but you have now imported the Azure Automation runbook!</li>
</ol>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="setup-webhook">Setup Webhook<a href="#setup-webhook" class="hash-link" aria-label="Direct link to Setup Webhook" title="Direct link to Setup Webhook">​</a></h5>
<p>Now that the Azure runbook has been imported, we need to set up a Webhook for the Alert to trigger and start the runbook.</p>
<ol>
<li>Log into the <a href="https://portal.azure.com/#home" target="_blank" rel="noopener noreferrer" title="Microsoft Azure Portal"><strong>Microsoft Azure Portal</strong></a>.</li>
<li>Navigate to your Azure <strong>Automation account</strong></li>
<li>Click on <strong>Runbooks</strong></li>
<li><strong>Click</strong> on the <strong>runbook</strong> you just imported <em>(i.e. Deallocate-AzureVirtualMachine)</em></li>
<li>Click on <strong>Add webhook</strong></li>
<li>Click <strong>Create a new webhook</strong></li>
<li><strong>Enter</strong> a <strong>name</strong> for the webhook</li>
<li>Make sure it is <strong>Enabled</strong></li>
<li>You can edit the expiry date to match your security requirements; make sure you <strong>record</strong> the expiry date, as it will need to be renewed before it expires.</li>
<li><strong>Copy</strong> the <strong>URL</strong> and paste it somewhere safe <em>(you won&#x27;t see this again! and you need it for the next steps)</em></li>
<li><img decoding="async" loading="lazy" alt="Create Azure webhook" src="/assets/images/azureportal-webhook-create-6623ef89825a6c0a1f726b79b468ef97.jpg" title="Create Azure webhook" width="345" height="503" class="img_ev3q"></li>
<li>Click <strong>Ok</strong></li>
<li>Click on <strong>Configure parameters and run settings.</strong></li>
<li>Because we will be taking in dynamic data from an Azure Alert, enter in: <strong>[EmptyString]</strong></li>
<li>Click <strong>Ok</strong></li>
<li>Click <strong>Create</strong></li>
<li>You have now set up the webhook <em>(make sure you have saved the URL from the earlier step as you will need it in the following steps)!</em></li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="setup-alert--action-group">Setup Alert &amp; Action Group<a href="#setup-alert--action-group" class="hash-link" aria-label="Direct link to Setup Alert &amp; Action Group" title="Direct link to Setup Alert &amp; Action Group">​</a></h4>
<p>Now that the Automation framework has been created with the Azure Automation account, runbook and webhook, we now need a way to detect if a Virtual Machine has been Stopped; this is where a Resource Health alert will come in.</p>
<ol>
<li>Log into the <a href="https://portal.azure.com/#home" target="_blank" rel="noopener noreferrer" title="Microsoft Azure Portal"><strong>Microsoft Azure Portal</strong></a>.</li>
<li>Navigate to: <a href="https://portal.azure.com/#blade/Microsoft_Azure_Monitoring/AzureMonitoringBrowseBlade/overview" target="_blank" rel="noopener noreferrer"><strong>Monitor</strong></a></li>
<li>Click on <strong>Service Health</strong></li>
<li>Select <strong>Resource Health</strong></li>
<li>Select <strong>+ Add resource health alert</strong></li>
<li>Select your <strong>subscription</strong></li>
<li>Select <strong>Virtual machine</strong> for Resource Type</li>
<li>You can target specific Resource Groups for your alert <em>(and, as such, your automation)</em> or <strong>select all.</strong></li>
<li>Check <strong>Include all future resource groups</strong></li>
<li>Check <strong>include all future resources</strong></li>
<li>Under the Alert conditions, make sure <strong>Event Status</strong> is: <strong>All selected</strong></li>
<li>Set Current resource status to <strong>Unavailable</strong></li>
<li>Set Previous resource status to <strong>All selected</strong></li>
<li>For reason type, select: <strong>User initiated</strong> and <strong>unknown</strong></li>
<li><img decoding="async" loading="lazy" alt="Create Azure Resource Health Alert" src="/assets/images/azureportal-alert-create-525afa13de376a81109f6c9693561cd1.jpg" title="Create Azure Resource Health Alert" width="877" height="956" class="img_ev3q"></li>
<li>Now that we have the Alert rule configured, we need to set up an Action group. That will get triggered when the alert gets fired.</li>
<li>Click <strong>Select Action groups.</strong></li>
<li>Click <strong>+ Create action group</strong></li>
<li><strong>Select</strong> your subscription and <strong>resource group</strong> <em>(this is where the Action alert will go, I recommend your Azure Management/Monitoring resource group that may have a Log Analytics workspace as an example)</em>.</li>
<li>Give your Action Group a <strong>name</strong>, i.e. AzureAutomateActionGroup</li>
<li>The display name will be automatically generated, but feel free to adjust it to suit your naming convention</li>
<li>Click <strong>Next: Notifications</strong></li>
<li>Under <strong>Notifications</strong>, you can trigger an <strong>email alert</strong>, which can be handy in determining how often the runbook runs. This can be modified and removed if it is running, especially during testing.</li>
<li>Click <strong>Next: Actions</strong></li>
<li>Under Action Type, select <strong>Webhook</strong></li>
<li><strong>Paste</strong> in the <strong>URI</strong> created earlier when setting up the Webhook</li>
<li>Select <strong>Yes</strong> to enable the <strong>common alert schema</strong> (<em>this is required as the JSON that the runbook is parsing is expecting it to the in the schema, if it isn&#x27;t the runbook will fail)</em></li>
<li><img decoding="async" loading="lazy" alt="Create Azure Action Group" src="/assets/images/azureportal-actiongroup-webhook-0c15f37f442496a15c8840646f976dab.jpg" title="Create Azure Action Group" width="1552" height="425" class="img_ev3q"></li>
<li>Click <strong>Ok</strong></li>
<li>Give the <strong>webhook</strong> a <strong>name</strong>.</li>
<li>Click <strong>Review + create</strong></li>
<li>Click <strong>Create</strong></li>
<li>Finally, enter in an Alert <strong>name</strong> and <strong>description</strong>, specify the resource group for the Alert to go into and click <strong>Save.</strong></li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="test-deallocate-solution">Test Deallocate Solution<a href="#test-deallocate-solution" class="hash-link" aria-label="Direct link to Test Deallocate Solution" title="Direct link to Test Deallocate Solution">​</a></h3>
<p>So now we have stood up our:</p>
<ul>
<li>Azure automation account</li>
<li>Alert</li>
<li>Action Group</li>
<li>Azure automation runbook</li>
<li>Webhook</li>
</ul>
<p>It is time to test! I have a VM called: VM-D01, running Windows <em>(theoretically, this runbook will also run against Linux workloads, as its relying on the Azure agent to send the correct status to the Azure Logs, but in my testing, it was against Windows workloads)</em> in the same subscription that the alert has been deployed against.</p>
<p>As you can see below, I shut down the Virtual Machine. After a few minutes <em>(be patient, Azure needs to wait for the status of the VM to be triggered)</em>, an Azure Alert was fired into Azure Monitor, which triggered the webhook and runbook, and the Virtual Machine was deallocated, and the Azure Alert was closed.</p>
<p><img decoding="async" loading="lazy" alt="Azure deallocate testing" src="/assets/images/deallocatevm-d03b67f813b3eeb276033ac07d8636a5.gif" title="Azure deallocate testing" width="1449" height="647" class="img_ev3q"></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/azure/">Azure</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/azure/hidden-tags-in-azure/">Hidden Tags in Azure</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-05-07T00:00:00.000Z">May 7, 2022</time> · <!-- -->4 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://luke.geek.nz/img/logo.png" alt="Luke Murray"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">Luke Murray</span></a></div><small class="authorTitle_nd0D" title="Author">Author</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><p><a href="https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/tag-resources?tabs=json&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Use tags to organize your Azure resources and management hierarchy">Tags</a> in Microsoft Azure are pivotal to resource management, whether it&#x27;s used for reporting or automation.</p>
<p>But sometimes, you need that extra bit of information to help discover what resources are for, or you may way to add information to a resource that isn&#x27;t directly displayed in the portal, especially when complex tags are in use that might be used in automation initiatives.</p>
<p>This is where &#x27;hidden&#x27; Azure Tags come in handy.</p>
<p>Tags starting with the prefix of <em>&#x27;hidden-&#x27;</em> will not be displayed under Tags in the Azure Portal; however, they will be displayed in the resource metadata and utilised by PowerShell and Azure CLI for automation initiatives.</p>
<p>Examples are:</p>

















<table><thead><tr><th>Tags</th><th>Value</th></tr></thead><tbody><tr><td>hidden-title</td><td>Web Server</td></tr><tr><td>hidden-ShutdownAutomation</td><td>Yes</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="hidden-title">hidden-title<a href="#hidden-title" class="hash-link" aria-label="Direct link to hidden-title" title="Direct link to hidden-title">​</a></h3>
<p>As I mentioned above, every tag with &#x27;hidden-&#x27; in front of it will be hidden in the Azure Portal. However, &#x27;hidden-title&#x27; behaves differently.</p>
<p>You may have noticed that some resources in Azure, especially if the Azure ARM <em>(Azure Resource Manager)</em> creates them and the name is GUID based, has a &#x27;(name)&#x27; around them after the resource name; this is because of the hidden-title tag.</p>
<p>The hidden-title tag is especially useful for being able to pick resources that belong to a specific service or application.</p>
<p>An example is below:</p>
<p><img decoding="async" loading="lazy" alt="Azure Portal - Hidden Title Tag" src="/assets/images/azureportal_hiddentitle-8eb0b684f90791788753ef73ee864d5e.png" title="Azure Portal - Hidden Title Tag" width="1331" height="685" class="img_ev3q"></p>
<p>In this case, I have used the <em>hidden-title</em> of &#x27;Web Server&#x27;, allowing me to quickly view what resources may be mapped to my Web Server.</p>
<p>You may notice that the Test-Virtual Machines title, is displayed in the Resource Groups search blade and not in the actual Resource Group, there are some areas of the Portal that will not display the hidden-title tag currently.</p>
<p>If I navigate to my Virtual Machine and click on the Tags blade, all I see is my CreatedBy tag.</p>
<p><img decoding="async" loading="lazy" alt="Azure Portal - Tags" src="/assets/images/azureportal-hiddentitle-vmtags-05ea996b39af58b4cd28997dac7f0b7b.png" title="Azure Portal - Tags" width="1323" height="457" class="img_ev3q"></p>
<p>However, if I navigate to the Overview page and click on JSON View, I can see the hidden tags in the resource metadata.</p>
<p><img decoding="async" loading="lazy" alt="Azure Portal - Resource Tags" src="/assets/images/azureportal-hiddentitle-vmtagsjson-d94859243123bbf8192f16a32fc2e3dd.png" title="Azure Portal - Resource Tags" width="1108" height="504" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="hidden-tags">hidden tags<a href="#hidden-tags" class="hash-link" aria-label="Direct link to hidden tags" title="Direct link to hidden tags">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="azure-portal">Azure Portal<a href="#azure-portal" class="hash-link" aria-label="Direct link to Azure Portal" title="Direct link to Azure Portal">​</a></h4>
<p>You can use the Azure Portal directly to add the Tags to apply hidden tags.</p>
<p><img decoding="async" loading="lazy" alt="Azure Portal - Add Tags" src="/assets/images/azureportal_hiddentagsadd-f8360ab83e2f73247cad3e4ad88f361f.png" title="Azure Portal - Add Tags" width="1177" height="400" class="img_ev3q"></p>
<p>You can remove the Tag by adding the hidden-tag again and keeping the value empty <em>(ie blanking out the hidden-title will remove the title)</em>, but it will still be against the metadata <em>(Resource Graph)</em> as a Tag that exists (as seen in the screenshot below) - it is much cleaner to use PowerShell.</p>
<p><img decoding="async" loading="lazy" alt="Azure - Resource Tags" src="data:image/png;base64,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" title="Azure - Resource Tags" width="441" height="121" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="powershell">PowerShell<a href="#powershell" class="hash-link" aria-label="Direct link to PowerShell" title="Direct link to PowerShell">​</a></h4>
<p>Get-AzTag and Remove-AzTag, do not display the hidden tags, to add and remove the tags, you need to add them through &#x27;Update-AzTag&#x27; and &#x27;Replace&#x27; or &#x27;Merge&#x27; to overwrite the tags, which requires the Resource targetted by Resource ID.</p>
<p>A handy snippet to use to add/remove the Tags on individual or multiple resources is:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$replacedTags = @{&quot;hidden-title&quot; = &quot;Web Server&quot;; &quot;hidden-ShutdownAutomation&quot; = &quot;Yes&quot;}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$resouceGroup = &#x27;vm-dev-rg&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Get-AzResource -ResourceGroupName $resouceGroup | Select-Object ResourceId | Out-GridView -PassThru | Update-AzTag -Tag $replacedTags -Operation Merge</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This will snippet will gather all the resources in your Resource Group, then select their Resource IDs; the script will then prompt with a GUI allowing you to select which resources or resources you want to update your tags on, then once you click Ok, it will update the Tags on the resources you selected.</p>
<p><img decoding="async" loading="lazy" alt="PowerShell - Add Azure Tags" src="/assets/images/powershell_hiddentagsadd-13bedddf846b3f320146ed434671508e.png" title="PowerShell - Add Azure Tags" width="1470" height="422" class="img_ev3q"></p>
<p>You may be wondering if the Hidden tags are useful for automation, but if the &#x27;Get-AzTag&#x27; cmdlet doesn&#x27;t work, how can I retrieve the resources? It&#x27;s a good question, and that is where &#x27;Get-AzResource&#x27; comes to the rescue.</p>
<p>Examples are:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Get-AzResource -TagName hidden-ShutdownAutomation</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Get-AzResource -TagValue Yes</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$TagName = &#x27;hidden-title&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$TagValue = &#x27;Web Server&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Get-AzResource -TagName $TagName -TagValue $TagValue | Where-Object -FilterScript {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    $_.ResourceType -like &#x27;Microsoft.Compute/virtualMachines&#x27; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="azure-bicep">Azure Bicep<a href="#azure-bicep" class="hash-link" aria-label="Direct link to Azure Bicep" title="Direct link to Azure Bicep">​</a></h4>
<p>You can also add the Tags, with Azure Bicep.</p>
<p>Example is:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">param resourceTags object = {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   hidden-title: &#x27;Web Server&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   hidden-ShutdownAutomation: &#x27;Yes&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">tags: resourceTags</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/azure/">Azure</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/tags/azure/page/20/"><div class="pagination-nav__label">Newer entries</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/tags/azure/page/22/"><div class="pagination-nav__label">Older entries</div></a></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 luke.geek.nz. Powered by coffee, clouds and hamsters on wheels!</div></div></div></footer></div>
</body>
</html>