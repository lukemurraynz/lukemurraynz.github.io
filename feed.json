{
    "version": "https://jsonfeed.org/version/1",
    "title": "luke.geek.nz Blog",
    "home_page_url": "https://luke.geek.nz/",
    "description": "luke.geek.nz Blog",
    "items": [
        {
            "id": "https://luke.geek.nz/azure/service-namespace-invalid-eventhub",
            "content_html": "<p>When deploying an Event Hub using Azure Bicep, you may get the following error:</p>\n<p>\"code\": \"BadRequest\",\n\"message\": \"The specified service namespace is invalid. CorrelationId: 652cc73c-1fa7-450a-9788-b73ad6a818df\"</p>\n<p><img loading=\"lazy\" alt=\"The specified service namespace is invalid\" src=\"https://luke.geek.nz/assets/images/EventHub_ServiceNamespaceisInvalid-9eeab3667abb3efbbf089a2d33e530d0.png\" width=\"779\" height=\"305\" class=\"img_ev3q\"></p>\n<p>This could be caused by the name of your namespace needing to meet the naming requirements.</p>\n<!-- -->\n<p>For example:</p>\n<p>The namespace identifier should adhere to the following naming conventions:</p>\n<ul>\n<li>The name must be unique across Azure. The system immediately checks to see if the name is available.</li>\n<li>The name length is at least 6 and at most 50 characters.</li>\n<li>The name can contain only letters, numbers, and hyphens “-“.</li>\n<li>The name must start with a letter and end with a letter or number.</li>\n<li>The name doesn't end with “-sb“ or “-mgmt“.</li>\n</ul>\n<p>Reference:</p>\n<ul>\n<li><a href=\"https://learn.microsoft.com/rest/api/servicebus/create-namespace?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Create Namespace</a>, even though this article dates back to an API from 2021, the naming standards are still valid in the API for 2023-01-01-preview.</li>\n<li><a href=\"https://learn.microsoft.com/en-us/azure/service-bus-messaging/service-bus-quickstart-portal#:~:text=Enter%20a%20name,sb%E2%80%9C%20or%20%E2%80%9C-mgmt?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Create Service Bus Namespace in Portal</a></li>\n</ul>",
            "url": "https://luke.geek.nz/azure/service-namespace-invalid-eventhub",
            "title": "The specified service namespace is invalid EventHub",
            "summary": "The specified service namespace is invalid when attempting to deploy an Azure EventHub using Bicep",
            "date_modified": "2024-01-05T07:52:10.785Z",
            "author": {
                "name": "Luke Murray",
                "url": "https://luke.geek.nz"
            },
            "tags": [
                "Azure"
            ]
        },
        {
            "id": "https://luke.geek.nz/azure/azure-email-communication-services",
            "content_html": "<p><a href=\"https://learn.microsoft.com/azure/communication-services/overview?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Communication Services</a> brings rich communication APIs to all of your apps across any device on any platform, using the same reliable and secure infrastructure that powers Microsoft Teams.</p>\n<p>Today, we will look into using Email as part of Azure Communication Services using the REST API and PowerShell to send an email.</p>\n<p><img loading=\"lazy\" alt=\"Azure Communication Services\" src=\"https://luke.geek.nz/assets/images/BlogHeading_DeployandTestACSE-f9838a4feb1c05d77481cc14d4141606.gif\" width=\"1200\" height=\"628\" class=\"img_ev3q\"></p>\n<!-- -->\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"overview\">Overview<a href=\"https://luke.geek.nz/azure/azure-email-communication-services#overview\" class=\"hash-link\" aria-label=\"Direct link to Overview\" title=\"Direct link to Overview\">​</a></h2>\n<p>Azure Communication Services is a platform of products and services that enable you to create custom communication applications and solutions. Microsoft has taken the same technologies that power Skype and Microsoft Teams and made it available to developers as an Azure product, allowing easy integration with other Microsoft developer services for additional functionality.</p>\n<div class=\"theme-admonition theme-admonition-info admonition_xJq3 alert alert--info\"><div class=\"admonitionHeading_Gvgb\"><span class=\"admonitionIcon_Rf37\"><svg viewBox=\"0 0 14 16\"><path fill-rule=\"evenodd\" d=\"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z\"></path></svg></span>info</div><div class=\"admonitionContent_BuS1\"><p>Azure Communication Services supports various communication formats:</p><ul>\n<li><a href=\"https://learn.microsoft.com/en-us/azure/communication-services/concepts/voice-video-calling/calling-sdk-features?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Voice and Video Calling</a></li>\n<li><a href=\"https://learn.microsoft.com/azure/communication-services/concepts/chat/concepts?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Rich Text Chat</a></li>\n<li><a href=\"https://learn.microsoft.com/en-us/azure/communication-services/concepts/sms/concepts?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">SMS</a></li>\n<li><a href=\"https://learn.microsoft.com/en-us/azure/communication-services/concepts/email/email-overview?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Email</a></li>\n</ul></div></div>\n<div class=\"theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary\"><div class=\"admonitionHeading_Gvgb\"><span class=\"admonitionIcon_Rf37\"><svg viewBox=\"0 0 14 16\"><path fill-rule=\"evenodd\" d=\"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z\"></path></svg></span>note</div><div class=\"admonitionContent_BuS1\"><p><a href=\"https://learn.microsoft.com/en-us/azure/communication-services/concepts/sms/concepts?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">SMS</a> services are not available on Azure Sponsorship or Visual Studio Enterprise subscriptions.</p></div></div>\n<p>Today we will be looking at the <strong><a href=\"https://learn.microsoft.com/azure/communication-services/concepts/email/email-overview?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Email Communication Service</a> by deploying Email and Azure Communication Services with <a href=\"https://learn.microsoft.com/azure/azure-resource-manager/bicep/overview?tabs=bicep&amp;WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Bicep</a>, and Send a test email using the API and PowerShell RestMethod</strong>.</p>\n<!-- -->\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"deployment\">Deployment<a href=\"https://luke.geek.nz/azure/azure-email-communication-services#deployment\" class=\"hash-link\" aria-label=\"Direct link to Deployment\" title=\"Direct link to Deployment\">​</a></h3>\n<p>I am going to make some assumptions here that you know how to deploy with <a href=\"https://learn.microsoft.com/azure/azure-resource-manager/bicep/overview?tabs=bicep&amp;WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Bicep</a>, and have it <a href=\"https://learn.microsoft.com/azure/azure-resource-manager/bicep/install?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">installed</a>, and that you have an Azure subscription and the ability to create new resources.</p>\n<div class=\"theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success\"><div class=\"admonitionHeading_Gvgb\"><span class=\"admonitionIcon_Rf37\"><svg viewBox=\"0 0 12 16\"><path fill-rule=\"evenodd\" d=\"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z\"></path></svg></span>tip</div><div class=\"admonitionContent_BuS1\"><p>If you are doing Bicep deployment, I do recommend looking at the <a href=\"https://luke.geek.nz/azure/Azure-Bicep-Deploy-Pane/\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Bicep Deploy Pane Visual Studio Code extension</a>.</p></div></div>\n<p>In order to use the Email Communication Service, we need to create it and then create Azure Communication Services, whose endpoint we will then use to send an email.\nTo authenticate with Azure Communication Services, we will use a Service Principal, which we will create, then use that Service Principal with a custom role to send an email using PowerShell and the Azure APIs.</p>\n<p>For email services, you can use your own <a href=\"https://learn.microsoft.com/azure/communication-services/quickstarts/email/add-custom-verified-domains?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Custom Domain</a>, and in most Production based scenarios you would, this requires some records being added to your DNS server, for domain ownership and to configure the DKIM/SFP records, but for the purposes of this article, we will use an Azure Managed <em>(and autogenerated domain)</em>.</p>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"bicep-deployment\">Bicep Deployment<a href=\"https://luke.geek.nz/azure/azure-email-communication-services#bicep-deployment\" class=\"hash-link\" aria-label=\"Direct link to Bicep Deployment\" title=\"Direct link to Bicep Deployment\">​</a></h4>\n<p>Deployment of Azure Communication Services via Bicep can be done using the <a href=\"https://learn.microsoft.com/en-us/azure/azure-resource-manager/bicep/deploy-cli?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">PowerShell cmdlet or the Azure CLI</a>. Still, today I will use the Deployment Pane and deploy from Visual Studio Code for my demo.</p>\n<p>The Azure Bicep will deploy:</p>\n<ul>\n<li>Azure Communication services</li>\n<li>Email Communication Services</li>\n</ul>\n<p>And configure 2 FROM email addresses:</p>\n<ul>\n<li>DoNotReply</li>\n<li>itservicedesk</li>\n</ul>\n<p>However, you can modify this to your requirements; I put these in a variable array to make it easier to add and remove sender addresses.</p>\n<p>Default tags have been added. However, these can easily be modified or removed if needed.</p>\n<p>3 Parameter values will need to be defined:</p>\n<table><thead><tr><th>Parameters</th><th>Notes</th></tr></thead><tbody><tr><td>emailServicesName</td><td>Azure Communication Services Email resource name.</td></tr><tr><td>communicationServicesName</td><td>Azure Communication Services Email name.</td></tr><tr><td>emailServicesLocation</td><td>This is a global service; however, the data at rest (Data Location) needs to be specified.</td></tr></tbody></table>\n<p>I am based in New Zealand, so my Region and Data location is Australia and Australia East.</p>\n<div class=\"theme-admonition theme-admonition-info admonition_xJq3 alert alert--info\"><div class=\"admonitionHeading_Gvgb\"><span class=\"admonitionIcon_Rf37\"><svg viewBox=\"0 0 14 16\"><path fill-rule=\"evenodd\" d=\"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z\"></path></svg></span>info</div><div class=\"admonitionContent_BuS1\"><p>The Azure Communication Service is a global resource and will need a unique name. You can only have 1 Azure managed domain per Email Communication Service, but you can also add a Custom Domain.</p></div></div>\n<p>Let us deploy and configure Azure Communication Services to talk to the Email service!</p>\n<p><img loading=\"lazy\" alt=\"Azure Communication Services - Bicep Deployment\" src=\"https://luke.geek.nz/assets/images/ACS_ProvisionEmailService-d47027e90cb1a26c1f41438edf6826a0.gif\" width=\"1911\" height=\"944\" class=\"img_ev3q\"></p>\n<div class=\"language-bicep codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockTitle_Ktv7\">main.bicep</div><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-bicep codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Scope</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">targetScope</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'resourceGroup'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Parameters &amp; Variables</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">param</span><span class=\"token plain\"> emailServicesName </span><span class=\"token datatype class-name\">string</span><span class=\"token plain\"> </span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">param</span><span class=\"token plain\"> communicationServicesName </span><span class=\"token datatype class-name\">string</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token decorator\">@description</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'The location where the email service stores its data at rest.'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">param</span><span class=\"token plain\"> emailServicesLocation </span><span class=\"token datatype class-name\">string</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Australia'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">var</span><span class=\"token plain\"> emailServicesTags </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">environment</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'production'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">department</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'IT'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">project</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'emailServices'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">var</span><span class=\"token plain\"> senderUsernames </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'donotreply'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">username</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'DoNotReply'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">displayName</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'DoNotReply'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'itservicedesk'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">username</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'itservicedesk'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">displayName</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'itservicedesk'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Add more sender usernames here</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Bicep</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">resource</span><span class=\"token plain\"> emailServices </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Communication/emailServices@2023-04-01-preview'</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> emailServicesName</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">location</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'global'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">tags</span><span class=\"token operator\">:</span><span class=\"token plain\"> emailServicesTags</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">dataLocation</span><span class=\"token operator\">:</span><span class=\"token plain\"> emailServicesLocation</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">resource</span><span class=\"token plain\"> emailServicesAzureDomain </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Communication/emailServices/domains@2023-06-01-preview'</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'AzureManagedDomain'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">parent</span><span class=\"token operator\">:</span><span class=\"token plain\"> emailServices</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">location</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'global'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">domainManagement</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'AzureManaged'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">userEngagementTracking</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Disabled'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">resource</span><span class=\"token plain\"> emailServicesSendAddresses </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Communication/emailServices/domains/senderUsernames@2023-06-01-preview'</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">for</span><span class=\"token plain\"> senderUsername </span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">in</span><span class=\"token plain\"> senderUsernames</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">parent</span><span class=\"token operator\">:</span><span class=\"token plain\"> emailServicesAzureDomain</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> senderUsername</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">name</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">username</span><span class=\"token operator\">:</span><span class=\"token plain\"> senderUsername</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">username</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">displayName</span><span class=\"token operator\">:</span><span class=\"token plain\"> senderUsername</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">displayName</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">resource</span><span class=\"token plain\"> communicationServices </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Communication/communicationServices@2023-06-01-preview'</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> communicationServicesName</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">location</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'global'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">tags</span><span class=\"token operator\">:</span><span class=\"token plain\"> emailServicesTags</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">dataLocation</span><span class=\"token operator\">:</span><span class=\"token plain\"> emailServicesLocation</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">linkedDomains</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    emailServicesAzureDomain</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">id</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\">  </span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">output</span><span class=\"token plain\"> emailAddresses </span><span class=\"token datatype class-name\">array</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">for</span><span class=\"token plain\"> senderUsername </span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">in</span><span class=\"token plain\"> senderUsernames</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">email</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\">'</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">${</span><span class=\"token interpolated-string interpolation expression\">senderUsername</span><span class=\"token interpolated-string interpolation expression punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token interpolated-string interpolation expression\">username</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\">@</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">${</span><span class=\"token interpolated-string interpolation expression\">emailServicesAzureDomain</span><span class=\"token interpolated-string interpolation expression punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token interpolated-string interpolation expression\">name</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\">'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">output</span><span class=\"token plain\"> domainName </span><span class=\"token datatype class-name\">string</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> emailServicesAzureDomain</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">properties</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">mailFromSenderDomain</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">output</span><span class=\"token plain\"> communicationServicesuri </span><span class=\"token datatype class-name\">string</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> communicationServices</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">properties</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">hostName</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"setup-and-configure-authentication\">Setup and configure Authentication<a href=\"https://luke.geek.nz/azure/azure-email-communication-services#setup-and-configure-authentication\" class=\"hash-link\" aria-label=\"Direct link to Setup and configure Authentication\" title=\"Direct link to Setup and configure Authentication\">​</a></h4>\n<p>Now, that we have our Azure Communications Service and Email Communication service, next we need to create a Service Principal and Custom Role that we will use in the script.</p>\n<p>To do that, we will, set up a new Service Principal and then add a custom role, which has the least amount of privileges to send an email, then add it to our Resource Group, containing the Azure Communication Services resources.</p>\n<div class=\"theme-admonition theme-admonition-info admonition_xJq3 alert alert--info\"><div class=\"admonitionHeading_Gvgb\"><span class=\"admonitionIcon_Rf37\"><svg viewBox=\"0 0 14 16\"><path fill-rule=\"evenodd\" d=\"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z\"></path></svg></span>info</div><div class=\"admonitionContent_BuS1\"><p>Use this opportunity to copy your Application ID and generate and copy a new Secret; these will be used by the test PowerShell script in the next step, along with your Entra ID tenant ID. In a Production scenario, the secret should be stored in an <a href=\"https://azure.microsoft.com/products/key-vault?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Key Vault</a> as a Secret and not referenced as plain text anywhere.</p></div></div>\n<p><img loading=\"lazy\" alt=\"Azure Communication Services - Create SPN and assign custom role\" src=\"https://luke.geek.nz/assets/images/ACS_ProvisionEmailService_SPN-61494cb2d982f03ed4272c27eafa9525.gif\" width=\"1911\" height=\"944\" class=\"img_ev3q\"></p>\n<div class=\"language-json codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockTitle_Ktv7\">CommunicationServiceMailSender.json</div><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-json codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">\"properties\"</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">\"roleName\"</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"Communication Service Mail Sender\"</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">\"description\"</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"Minimal set of permissions required to send mail with Azure Communication Service.\"</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">\"assignableScopes\"</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"\"</span><span class=\"token plain\"> </span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">\"permissions\"</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token property\">\"actions\"</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"Microsoft.Communication/CommunicationServices/Write\"</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"Microsoft.Communication/CommunicationServices/Read\"</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"Microsoft.Communication/EmailServices/read\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token property\">\"notActions\"</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token property\">\"dataActions\"</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token property\">\"notDataActions\"</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"test-outgoing-email-using-api\">Test outgoing email using API<a href=\"https://luke.geek.nz/azure/azure-email-communication-services#test-outgoing-email-using-api\" class=\"hash-link\" aria-label=\"Direct link to Test outgoing email using API\" title=\"Direct link to Test outgoing email using API\">​</a></h3>\n<p>Now that we have our Communication Services and email Services and configured our Service Principal, it is time to run our test.</p>\n<div class=\"theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning\"><div class=\"admonitionHeading_Gvgb\"><span class=\"admonitionIcon_Rf37\"><svg viewBox=\"0 0 16 16\"><path fill-rule=\"evenodd\" d=\"M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z\"></path></svg></span>warning</div><div class=\"admonitionContent_BuS1\"><p>The script I will run below was written purely for my testing purposes and stores credentials as plain text; when looking to do this in Production, make sure these credentials are protected and the Service Principal is locked down from accepting requests outside of approved networks.</p></div></div>\n<p>To do our test, we need to update a few variables.</p>\n<table><thead><tr><th>Parameters</th><th>Notes</th></tr></thead><tbody><tr><td>SPNAppId</td><td>Your Service Principal Application ID</td></tr><tr><td>SPNSecretValue</td><td>Your Service Principal Client Secret</td></tr><tr><td>SPNTenantId</td><td>Your Entra ID Tenant ID</td></tr><tr><td>senderAddress</td><td>The email address Azure Communication Services is sending FROM</td></tr><tr><td>recipientAddress</td><td>The email address you re sending TO</td></tr><tr><td>communicationendpointurl</td><td>The endpoint of your Azure Communication Services (not Email Service). Https will be added further in the script.</td></tr></tbody></table>\n<p>The senderAddress must match a valid email address configured in Azure Email Communication Service. I also added in some random Contoso email addresses into the recipient's body for testing, the idea is to give you a scaffold to adjust as needed; feel free to amend and remove what you don't need.</p>\n<p><img loading=\"lazy\" alt=\"Azure Communication Services - Test sending an email\" src=\"https://luke.geek.nz/assets/images/ACS_ProvisionEmailService_Test-379c9bea955e294573d9e71f9a7bb056.gif\" width=\"1911\" height=\"944\" class=\"img_ev3q\"></p>\n<div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockTitle_Ktv7\">AzureEmailCommunicationSend.ps1</div><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Define the Service Principal credentials and email addresses</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># The Service Principal's Application (client) ID</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># This is a unique identifier for the app, assigned by Entra ID. Replace to match your environment.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$SPNAppId</span><span class=\"token plain\"> = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'069893df-a389-4a2a-99aa-d035265cfbb7'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># The Service Principal's secret</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># This is like a password for the app, used for authentication. Replace to match your environment.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$SPNSecretValue</span><span class=\"token plain\"> = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'fc6652c483d4475a9c59cc1d81b6d45a'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># The Entra ID tenant ID</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># This is the unique identifier for the Entra ID tenancy instance where the app is registered. Replace to match your environment.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$SPNTenantId</span><span class=\"token plain\"> = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'49e37426-fba3-4995-b563-0355b5d6fc60'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># The sender's email address</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># This is the email address that will appear in the \"From\" field of the email</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$senderAddress</span><span class=\"token plain\"> = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'itservicedesk@959df321-6092-41e7-8414-e7b4ea05da2b.azurecomm.net'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># The recipient's email address</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># This is the email address where the email will be sent</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$recipientAddress</span><span class=\"token plain\"> = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'recipientemail@test.com'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># The URI for the Azure Communication Services API</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$communicationendpointurl</span><span class=\"token plain\"> = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"azcommservices1.australia.communication.azure.com\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Function to get the access token from Entra ID</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">function</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Get-AccessToken</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\">    </span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Define the parameters for the REST API call</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$params</span><span class=\"token plain\"> = @</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        Uri    = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"https://login.microsoftonline.com/</span><span class=\"token string function\" style=\"color:rgb(80, 250, 123)\">$</span><span class=\"token string function punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token string function variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$SPNTenantId</span><span class=\"token string function punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">/oauth2/v2.0/token\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        Method = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"POST\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        Body   = @</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">            client_id     = </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$SPNAppId</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">            client_secret = </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$SPNSecretValue</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">            grant_type    = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"client_credentials\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">            scope         = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"https://communication.azure.com/.default\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Call the REST API and get the access token</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$token</span><span class=\"token plain\"> = </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Invoke-RestMethod</span><span class=\"token plain\"> @params</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">return</span><span class=\"token plain\"> </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$token</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">access_token</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Define the URI for the Azure Communication Services API</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$uri</span><span class=\"token plain\"> = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"https://</span><span class=\"token string variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$communicationendpointurl</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">/emails:send?api-version=2023-03-31\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Define the headers for the REST API call</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$headers</span><span class=\"token plain\"> = @</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"Content-Type\"</span><span class=\"token plain\">  = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"application/json\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"Authorization\"</span><span class=\"token plain\"> = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"Bearer </span><span class=\"token string function\" style=\"color:rgb(80, 250, 123)\">$</span><span class=\"token string function punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token string function\" style=\"color:rgb(80, 250, 123)\">Get-AccessToken</span><span class=\"token string function punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Define the body for the REST API call</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Define the body for the REST API call</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># This includes the email headers, sender address, content, recipients, attachments, reply-to addresses, and tracking settings</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$apiResponse</span><span class=\"token plain\"> = @</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># The headers of the email, including a unique ID generated by New-Guid</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    headers                        = @</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        id = </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">New-Guid</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">Guid</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># The sender's email address</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    senderAddress                  = </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$senderAddress</span><span class=\"token plain\"> </span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># The content of the email, including the subject, plain text body, and HTML body</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    content                        = @</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        subject   = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"Contoso Email Test\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        plainText = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"This is a test email from Contoso. If you received this, our test was successful.\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        html      = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"&lt;html&gt;&lt;head&gt;&lt;title&gt;Contoso Email Test&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;This is a test email from Contoso.&lt;/h1&gt;&lt;p&gt;If you received this, our test was successful.&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># The recipients of the email, including the \"to\", \"cc\", and \"bcc\" addresses</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    recipients                     = @</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        to  = @</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">            @</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">                address     = </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$recipientAddress</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">                displayName = </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$recipientAddress</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">            </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">            @</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">                address     = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"Jane.Doe@contoso.com\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">                displayName = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"Jane Doe\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">            </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        cc  = @</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">            @</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">                address     = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'wendy.smith@contoso.com'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">                displayName = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Wendy Smith'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">            </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">            @</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">                address     = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"jimmy.johns@contoso.com\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">                displayName = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"Jimmy Johns\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">            </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        bcc = @</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">            @</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">                address     = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"bob.jones@contoso.com\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">                displayName = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"Bob Jones\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">            </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">            @</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">                address     = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"alice.johnson@contoso.com\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">                displayName = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"Alice Johnson\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">            </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># The attachments to the email, including the name, content type, and content in Base64</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    attachments                    = @</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        @</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">            name            = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"Attachment.txt\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">            contentType     = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"application/txt\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">            contentInBase64 = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"TG9yZW0gaXBzdW0gZG9sb3Igc2l0IGFtZXQ=\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># The reply-to addresses for the email</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    replyTo                        = @</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        @</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">            address     = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"contoso-support@contoso.com\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">            displayName = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"Contoso Support\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># A flag to disable user engagement tracking</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    userEngagementTrackingDisabled = </span><span class=\"token boolean\">$true</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Convert the PowerShell object to JSON</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># The -Depth parameter is set to 10 to ensure all levels of the object are converted</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$body</span><span class=\"token plain\"> = </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$apiResponse</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">|</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">ConvertTo-Json</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">Depth 10</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Send the email</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">try</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$response</span><span class=\"token plain\"> = </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Invoke-RestMethod</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">Uri </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$uri</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">Method Post </span><span class=\"token operator\">-</span><span class=\"token plain\">Headers </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$headers</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">Body </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$body</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">UseBasicParsing</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$response</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">catch</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Write-Error</span><span class=\"token plain\"> </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$_</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">Exception</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">Message</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<blockquote>\n<p>Congratulations, you have now stood up Azure Communications Services and successfully sent and received an email using the Azure Communication Service API.</p>\n</blockquote>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"additional-reading\">Additional Reading<a href=\"https://luke.geek.nz/azure/azure-email-communication-services#additional-reading\" class=\"hash-link\" aria-label=\"Direct link to Additional Reading\" title=\"Direct link to Additional Reading\">​</a></h2>\n<ul>\n<li><a href=\"https://azure.microsoft.com/contact/pricing/?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Communication Services pricing</a></li>\n<li><a href=\"https://learn.microsoft.com/en-us/training/modules/intro-azure-communication-services/?source=recommendations&amp;WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Introduction to Azure Communication Services</a></li>\n<li><a href=\"https://learn.microsoft.com/en-us/azure/communication-services/quickstarts/email/handle-email-events?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Quick-start: Handle Email events</a></li>\n</ul>",
            "url": "https://luke.geek.nz/azure/azure-email-communication-services",
            "title": "Deploying and Testing Azure Email Communication Services",
            "summary": "Use Azure Bicep to create Email Communication Services, then REST API to send an email.",
            "date_modified": "2024-01-02T06:54:06.568Z",
            "author": {
                "name": "Luke Murray",
                "url": "https://luke.geek.nz"
            },
            "tags": [
                "Azure"
            ]
        },
        {
            "id": "https://luke.geek.nz/azure/microsoft-copilot-azure-preview",
            "content_html": "<p><a href=\"https://azure.microsoft.com/en-us/products/copilot?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Copilot for Azure</a> is an AI companion that simplifies how you design, operate, optimize, and troubleshoot apps and infrastructure from cloud to edge.</p>\n<p>With Copilot, gain new insights, discover more benefits of the cloud, and orchestrate data across both the cloud and the edge. Copilot AI assistance <strong>utilizes language models</strong>, the <strong>Azure control plane</strong>, and <strong>insights</strong> about <strong>your</strong> <strong>Azure</strong> and <strong>Arc–enabled</strong> assets.</p>\n<p>This is carried out within Azure's steadfast commitment to safeguarding your data security and privacy.</p>\n<blockquote>\n<p>This article contains my own personal thoughts and experiences; make sure you approach this capability with an open eye; my views may not necessarily be your own.</p>\n</blockquote>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"overview\">Overview<a href=\"https://luke.geek.nz/azure/microsoft-copilot-azure-preview#overview\" class=\"hash-link\" aria-label=\"Direct link to Overview\" title=\"Direct link to Overview\">​</a></h2>\n<p>Microsoft Copilot for Azure is designed to generate the best possible responses within the context it can access.</p>\n<p><strong>However, like any AI system, Microsoft Copilot for Azure's responses will not always be perfect. All of Microsoft Copilot for Azure's responses should be carefully tested, reviewed, and vetted before making changes to your Azure environment.</strong></p>\n<blockquote>\n<p>Microsoft Copilot for Azure <em>(preview)</em> requires registration and is only available to approved enterprise customers and partners. Customers who wish to use Microsoft Copilot for Azure <em>(preview)</em> must submit a&nbsp;registration form.\nAccess to Microsoft Copilot for Azure <em>(preview)</em> is subject to Microsoft's sole discretion based on eligibility criteria and a vetting process, and customers must acknowledge that they have read and understand the Azure terms of service for Microsoft Copilot for Azure <em>(preview)</em>.</p>\n</blockquote>\n<p><img loading=\"lazy\" alt=\"Microsoft Copilot for Azure - Mission Statement\" src=\"https://luke.geek.nz/assets/images/MicrosoftCopilotForAzure_MissionStatement-f8609fe34a6b20f7d7c7235a16866abd.PNG\" width=\"1680\" height=\"945\" class=\"img_ev3q\"></p>\n<p>Copilot for Azure can be accessed directly in the Azure Portal.</p>\n<p><img loading=\"lazy\" alt=\"Microsoft Copilot for Azure\" src=\"https://luke.geek.nz/assets/images/MicrosoftCopilotForAzure_PortalView-174fecdc0dc3af43ea7b340b7c00ab69.png\" width=\"1680\" height=\"945\" class=\"img_ev3q\"></p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"limitations\">Limitations<a href=\"https://luke.geek.nz/azure/microsoft-copilot-azure-preview#limitations\" class=\"hash-link\" aria-label=\"Direct link to Limitations\" title=\"Direct link to Limitations\">​</a></h3>\n<blockquote>\n<p>It is in preview! But there are some <a href=\"https://learn.microsoft.com/azure/copilot/capabilities?WT.mc_id=AZ-MVP-5004796#current-limitations\" target=\"_blank\" rel=\"noopener noreferrer\">limitations</a>, to be aware of.</p>\n</blockquote>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<table><thead><tr><th><strong>Limitation</strong></th><th><strong>Notes</strong></th></tr></thead><tbody><tr><td>10 questions per conversation (5 convos per day)</td><td>Essentially, 10 prompts (and competitions) per memory-aware conversation and 5 conversations. Reducing potential hallucinations and API exhaustion.</td></tr><tr><td>Responses that use lists are limited to the top 5</td><td>When requesting a list of resources, the completions will be restricted to 5. The token length for hundreds of resources can be very slow</td></tr><tr><td>Some tasks won't accept Resource Names; resource ID required</td><td>Resource ID of the resources may need to be specified when referencing a resource.</td></tr><tr><td>Available in English only</td><td>English only</td></tr><tr><td>Cost management scope at Subscription (not Management Group)</td><td>Able to reference Cost analysis against Subscription and Resource Groups but not across multiple subscriptions across Management Groups</td></tr><tr><td>Limited number of skills</td><td>Can only complete a certain amount of tasks; no doubt more will be added over time due to increasing capabilities and user feedback.</td></tr></tbody></table>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"copilot-stack\">Copilot Stack<a href=\"https://luke.geek.nz/azure/microsoft-copilot-azure-preview#copilot-stack\" class=\"hash-link\" aria-label=\"Direct link to Copilot Stack\" title=\"Direct link to Copilot Stack\">​</a></h3>\n<p>So, how does Microsoft Copilot for Azure work? Let us take a closer look:</p>\n<p><img loading=\"lazy\" alt=\"Microsoft Copilot for Azure\" src=\"https://luke.geek.nz/assets/images/MicrosoftCopilotforAzure_CopilotStack-d8813f3b2e7d48c7052dbfb977c6a43d.gif\" width=\"1894\" height=\"1053\" class=\"img_ev3q\"></p>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<table><thead><tr><th><strong>Step</strong></th><th><strong>Stack</strong></th><th><strong>Action</strong></th></tr></thead><tbody><tr><td>1</td><td>Apps</td><td>User enters prompt in portal web interface</td></tr><tr><td>2</td><td>Apps</td><td>Microsoft Bot Framework takes the prompt and sends it to AI orchestration</td></tr><tr><td>3</td><td>AI orchestration</td><td>Does prompt filtering (i.e. Content Safety)</td></tr><tr><td>4</td><td>AI orchestration</td><td>Brings in context (i.e. Azure resource/blade that is opened)</td></tr><tr><td>5</td><td>AI orchestration</td><td>RAG (Retrieval Augmented generation), brings in Microsoft Learn documentation, Azure Resource Graph, Cost Management, Skills, Guardrials (i.e. Azure policy, RBAC (Role Based Access Control), Budgets</td></tr><tr><td>6</td><td>AI orchestration</td><td>Added additional context to Prompt (i.e. metapromot) and ground the data</td></tr><tr><td>7</td><td>Foundational Model</td><td>Metaprompt, supplied to foundational model.</td></tr><tr><td>8</td><td>Foundational Model</td><td>Competition prompt response from foundational model (based on Copilot system prompt and context)</td></tr><tr><td>9</td><td>Apps</td><td>Competition prompt, supplied to user</td></tr></tbody></table>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"functionality\">Functionality<a href=\"https://luke.geek.nz/azure/microsoft-copilot-azure-preview#functionality\" class=\"hash-link\" aria-label=\"Direct link to Functionality\" title=\"Direct link to Functionality\">​</a></h2>\n<p>Microsoft Copilot for Azure is designed to help with the following:</p>\n<ul>\n<li>Design</li>\n<li>Operate</li>\n<li>Optimize</li>\n<li>Troubleshoot</li>\n</ul>\n<p><img loading=\"lazy\" alt=\"Microsoft Copilot for Azure\" src=\"https://luke.geek.nz/assets/images/MicrosoftCopilotforAzure_Circle-2bb2fa719e3f09268a99ba4f269a1ded.PNG\" width=\"1680\" height=\"945\" class=\"img_ev3q\"></p>\n<p>So let us go through trialling this! All tests below will be done with an account with Owner permissions across Azure.</p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"design\">Design<a href=\"https://luke.geek.nz/azure/microsoft-copilot-azure-preview#design\" class=\"hash-link\" aria-label=\"Direct link to Design\" title=\"Direct link to Design\">​</a></h3>\n<blockquote>\n<p><strong>Design</strong> - Configure and create the right services.</p>\n</blockquote>\n<p>To test the design pillar of Microsoft Copilot for Azure, I will be using the following prompts to ease in and look at my design elements:</p>\n<ul>\n<li>I want to set up a new web application for Internet shopping; what infrastructure should I use?</li>\n<li>When setting up a new web service that allows people to purchase my products using Azure services, what infrastructure should I use?</li>\n<li>List all suggested Azure services for my internet shopping service and how they could connect together, including considerations.</li>\n<li>Create these services</li>\n<li>Are there any services I am missing? Also, list all the suggested services in a table, including a column on what each service could be used for when looking at my internet shopping application</li>\n<li>What are the recommended requirements that I need to gather to create my scalable and secure Internet shopping application? List requirements, as a list</li>\n<li>Give me examples of security requirement questions.</li>\n</ul>\n<p>Although these prompts are very high-level and not as specific as they could be, I approached this as someone who was new to Azure design, with a specific outcome I wanted, with one prompt building on the next.</p>\n<p><img loading=\"lazy\" alt=\"Microsoft Copilot for Azure - Design\" src=\"https://luke.geek.nz/assets/images/MicrosoftCopilotforAzure_PillarTest_Design-ab68d192751a14f4094311564e171fa0.gif\" width=\"1905\" height=\"983\" class=\"img_ev3q\"></p>\n<blockquote>\n<p>Overall, Copilot for Azure responded to each prompt, and starting off with a generic prompt, I was able to use the completition prompts, supplied back to me. I did like how most prompts included links to additional Microsoft Learn documentation <em>(including Azure architecture centre references)</em> based on the subjects at the time. I did ask Microsoft Copilot for Azure to create a range of Cloud-native services, and it failed, so from my perspective, it is missing either additional error handling or the Skills/Tasks to complete the creation of these services <em>(which would have been my ideal state)</em>.</p>\n</blockquote>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"operate\">Operate<a href=\"https://luke.geek.nz/azure/microsoft-copilot-azure-preview#operate\" class=\"hash-link\" aria-label=\"Direct link to Operate\" title=\"Direct link to Operate\">​</a></h3>\n<blockquote>\n<p><strong>Operate</strong> - Answer questions, author complex commands, and manage resources.</p>\n</blockquote>\n<p>To test the Operate pillar of Microsoft Copilot for Azure, I will be using the following prompts to ease in and look at the Operate elements:</p>\n<ul>\n<li>Take me to view all resources</li>\n<li>Change portal theme to light</li>\n<li>Change back</li>\n<li>Create a table of all resources and their region?</li>\n<li>Give me a list of the top resource types?</li>\n<li>List all virtual machines and their power state?</li>\n<li>Shutdown all virtual machines currently running</li>\n<li>Start all virtual machines currently stopped</li>\n</ul>\n<p><img loading=\"lazy\" alt=\"Microsoft Copilot for Azure - Operate\" src=\"https://luke.geek.nz/assets/images/MicrosoftCopilotforAzure_PillarTest_Operate-bb30d59919e4768156c980e9664f8c5a.gif\" width=\"1905\" height=\"983\" class=\"img_ev3q\"></p>\n<blockquote>\n<p>Copilot for Azure responded to each prompt; it did a great job of taking us to the resources within the Azure Portal when prompted <em>(i.e. take me to view all resources)</em>; it even successfully changed our portal theme and reverted the change. However, I ran into a bug when attempting to shut down and start running Virtual Machines, where the selection prompt wasn't fully loaded, and I had to reset the selection to get it to display. Multiple times, I ran into issues with Azure Resource Graph, not being fully capable of creating and running queries, such as listing all resources and their regions, which I know is accessible by a Resource Graph query. However, Copilot, for Microsoft Azure, was able to successfully stop and start my virtual machines in bulk, making it a lot easier to make adjustments at scale; overall, I believe there are some improvements needed in this area to make it more functional.</p>\n</blockquote>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"optimize\">Optimize<a href=\"https://luke.geek.nz/azure/microsoft-copilot-azure-preview#optimize\" class=\"hash-link\" aria-label=\"Direct link to Optimize\" title=\"Direct link to Optimize\">​</a></h3>\n<blockquote>\n<p><strong>Optimize</strong> - Improve costs, scalability, and reliability through recommendations for your environment.</p>\n</blockquote>\n<p>To test the Optimize pillar of Microsoft Copilot for Azure, I will be using the following prompts to ease in and look at the Optimize elements:</p>\n<ul>\n<li>List all recommendations from Azure Advisor?</li>\n<li>Show me the highest resource costs for the past 12 months?</li>\n<li>How can I optimize my environment?</li>\n<li>Create a naming convention for SQL databases?</li>\n<li>How can I protect my storage accounts?</li>\n</ul>\n<blockquote>\n<p>Copilot for Azure responded to each prompt, and it was able to achieve and display the highest resource costs for the past 12 months; once my scope was set <em>(as per current limitations)</em>, it gave me recommendations on how I could generally optimize my environment, Copilot was also able to give recommendations on <em>(non-Azure)</em> SQL Database naming standards and implementations. Being able to review and recommend security recommendations is an enhanced Azure Copilot skill; so glad to know this worked and came back with valid recommendations for my test storage account; the automated implementation of security recommendations, however, isn't currently implemented.</p>\n</blockquote>\n<p><img loading=\"lazy\" alt=\"Microsoft Copilot for Azure - Optimize\" src=\"https://luke.geek.nz/assets/images/MicrosoftCopilotforAzure_PillarTest_Optimize-82074dcd1b4c816d6af571c4dc0a5c97.gif\" width=\"1905\" height=\"983\" class=\"img_ev3q\"></p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"troubleshoot\">Troubleshoot<a href=\"https://luke.geek.nz/azure/microsoft-copilot-azure-preview#troubleshoot\" class=\"hash-link\" aria-label=\"Direct link to Troubleshoot\" title=\"Direct link to Troubleshoot\">​</a></h3>\n<blockquote>\n<p><strong>Troubleshoot</strong> - Orchestrate across Azure services for insights to summarize issues, identify causes and suggest solutions.</p>\n</blockquote>\n<p>In this section, one of my Virtual Machines <em>(VM-1)</em> is turned off, so I am unable to RDP to it; let us see if we can use Microsoft Copilot for Azure to troubleshoot this.</p>\n<p>To test the Troubleshoot pillar of Microsoft Copilot for Azure, I will be using the following prompts to ease in and look at the Troubleshoot elements:</p>\n<ul>\n<li>How can I troubleshoot not being able to RDP to VM-1?</li>\n<li>Check if port 3390 is open on VM-1?</li>\n<li>What are the security implications of opening port 3389?</li>\n<li>Create a PowerShell script to test 3389 is opened on VM-1</li>\n<li>Adjust the script to use its public IP instead</li>\n<li>Take me to VM-1</li>\n<li>What is the Public IP of VM-1?</li>\n<li>What is this resource?</li>\n<li>What are the open alerts?</li>\n</ul>\n<blockquote>\n<p>Overall, using Microsoft Copilot for Azure to Troubleshoot RDP to connectivity to 'VM-1' would have helped, though the scenario that Copilot had come back with was due to being unable to RDP due to a potential brute force attack, had I followed the recommendations, it would have directed me to the appropriate blades, where I saw that the Virtual Machine was turned off. However, Copilot itself didn't have a status check that the Virtual Machine was even started or triggered any alerts that the Virtual Machine was deallocated. There was a delay, when I first prompted for how I troubleshoot, enough of a delay that I cancelled it and then reprompted again, which returned a result resulting in 2 of my 10 requests being used up. It was able to supply information on what resource I had opened in the portal and any active alerts on that resource <em>(Had I been at the All Resources blade; it would have viewed all alerts)</em>.</p>\n</blockquote>\n<p><img loading=\"lazy\" alt=\"Microsoft Copilot for Azure - Troubleshoot\" src=\"https://luke.geek.nz/assets/images/MicrosoftCopilotforAzure_PillarTest_Troubleshoot-ae412b8e15ea12ba2193b542ac5c86e0.gif\" width=\"1842\" height=\"945\" class=\"img_ev3q\"></p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"conclusion\">Conclusion<a href=\"https://luke.geek.nz/azure/microsoft-copilot-azure-preview#conclusion\" class=\"hash-link\" aria-label=\"Direct link to Conclusion\" title=\"Direct link to Conclusion\">​</a></h2>\n<p>Overall, I feel Copilot for Microsoft Azure is a suitable companion to working with Microsoft Azure as a <em>copilot</em> in the Azure Portal. However, it is clear that this is very much in Preview, and I would argue, unfortunately, not for Commercial or Generally available functionality yet, although I could have high standards on what this could be capable of, so make sure you draw your own conclusions and run your own tests.</p>\n<p>As with any prompt, working with LLM <em>(Large Language Models)</em>, context is key - and having a curious mindset in your questioning can help draw out more information.</p>\n<p>If you are a beginner user of Azure, I feel that Microsoft Copilot for Azure can help point you in the right direction and to the right information.</p>\n<p>Context is key – the service takes context on what resource you are at in the Azure Portal, so the more context it has on the resource, the better outputs you will get.</p>\n<p>As with all generative AI services, clear prompts are key and don’t trust the outputs; not all Graph queries are right.</p>\n<p>In terms of more intermediate and advanced services, it won’t replace full-on Azure management capabilities and troubleshooting yet, remember this is a copilot, an assistant.</p>\n<blockquote>\n<p>The more feedback can be offered using the built-in feedback buttons as part of the user interface, as part of its use – the better it will be, and the more skills and tasks it will be able to complete.</p>\n</blockquote>\n<p>Remember that users can only use Microsoft Copilot for Azure to view resource data and make changes to areas they already have the privilege to do! So as you prepare to roll this out, use it as an opportunity to increase your security and apply just in time and with just enough practice. If you using Infrastructure as Code, then your users may only need Reader access to view data regardless, then Copilot cannot make any changes outside of the toolsets like Terraform you may be deploying.</p>\n<p>Overall, this is a product I will be following and cannot wait to see what it becomes; where this product shines at the moment is really in the Enhanced Skills and being able to bring the correct Microsoft Learn documentation straight to you while you are in the Azure Portal, making your learning and engagement a lot more streamlined!</p>\n<p><img loading=\"lazy\" alt=\"Microsoft Copilot for Azure - Enchanced SKills\" src=\"https://luke.geek.nz/assets/images/MicrosoftCopilotforAzure_CopilotEnchancedSkills-b3c321b1a0f32547637997e7a442fa74.png\" width=\"1680\" height=\"945\" class=\"img_ev3q\"></p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"reference\">Reference<a href=\"https://luke.geek.nz/azure/microsoft-copilot-azure-preview#reference\" class=\"hash-link\" aria-label=\"Direct link to Reference\" title=\"Direct link to Reference\">​</a></h2>\n<p>The links below are some relevant reference material for further reading.</p>\n<ul>\n<li><a href=\"https://learn.microsoft.com/azure/copilot/overview?wt.mc_id=copilot_1a_webpage_gdc&amp;WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">What is Microsoft Copilot for Azure?</a></li>\n<li><a href=\"https://learn.microsoft.com/azure/copilot/overview?wt.mc_id=copilot_1a_webpage_gdc&amp;WT.mc_id=AZ-MVP-5004796#join-the-preview\" target=\"_blank\" rel=\"noopener noreferrer\">Join the Preview</a></li>\n<li><a href=\"https://learn.microsoft.com/azure/copilot/get-information-resource-graph?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Enchanced Scenarios</a></li>\n<li><a href=\"https://techcommunity.microsoft.com/t5/azure-infrastructure-blog/simplify-it-management-with-microsoft-copilot-for-azure-save/ba-p/3981106?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Simplify IT management with Microsoft Copilot for Azure – save time and get answers fast</a></li>\n</ul>",
            "url": "https://luke.geek.nz/azure/microsoft-copilot-azure-preview",
            "title": "Microsoft Copilot for Azure - Preview",
            "summary": "Microsoft Copilot for Azure is designed to generate the best possible responses within the context it can access. Lets take a look at the Public Preview.",
            "date_modified": "2023-12-26T00:00:00.000Z",
            "author": {
                "name": "Luke Murray",
                "url": "https://luke.geek.nz"
            },
            "tags": [
                "Azure"
            ]
        },
        {
            "id": "https://luke.geek.nz/azure/Azure-DevTest-Subscription-Considerations",
            "content_html": "<p>When looking at your Dev/Test workloads in Azure, you may be considering the <a href=\"https://azure.microsoft.com/en-us/pricing/offers/ms-azr-0148p?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Plan for Dev/Test Enterprise</a> subscription type, available on both the <a href=\"https://learn.microsoft.com/azure/cost-management-billing/understand/mca-overview?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Microsoft Customer Agreement (MCA)</a> and <a href=\"https://www.microsoft.com/en-us/licensing/licensing-programs/enterprise?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Enterprise Agreement (EA)</a> billing account types.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"overview\">Overview<a href=\"https://luke.geek.nz/azure/Azure-DevTest-Subscription-Considerations#overview\" class=\"hash-link\" aria-label=\"Direct link to Overview\" title=\"Direct link to Overview\">​</a></h2>\n<p>So, let us look at what this entails...</p>\n<blockquote>\n<p>You get <strong>Azure Plan for DevTest</strong> when you sign the <strong>Microsoft Customer Agreement</strong>. The <strong>Enterprise DevTest</strong> offer is available only to <strong>Enterprise Agreement</strong> customers, but they are <em>essentially</em> the <strong>same plan</strong>. The SKU value for Enterprise Dev/Test is: <a href=\"https://azure.microsoft.com/en-in/pricing/offers/ms-azr-0148p?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">ms-azr-0148p</a> and Azure Plan for Dev/Test Enterprise is: <a href=\"https://azure.microsoft.com/pricing/offers/ms-azr-0148g?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">ms-azr-0148g</a>, but as usual <strong>make sure you clarify and confirm with your direct Microsoft licensing/customer success manager, as these could change</strong>.</p>\n</blockquote>\n<p>There are a few gotchas to using the Dev/Test Enterprise Azure Plan that you need to be aware of, but before we go into that - let us take a look at some of the benefits:</p>\n<p>Run your development and testing workloads on Azure by using the Azure Plan for DevTest, which includes:</p>\n<ul>\n<li>Access to exclusive DevTest images in the gallery, including Windows 8.1 and Windows 10/11 images.</li>\n<li>Lower DevTest rates running Windows on Azure Virtual Machines, Azure App Service, Azure Cloud Services, Azure HDInsight, Azure Logic Apps, and Azure SQL Database.</li>\n<li>Centralized management via the Azure portal.</li>\n<li>The ability to create multiple subscriptions makes the plan ideal for development teams.</li>\n</ul>\n<p>When looking at the DevTest plan, this particular one will catch your eye:</p>\n<blockquote>\n<p><strong>Lower DevTest rates</strong> running Windows on Azure Virtual Machines, Azure App Service, Azure Cloud Services, Azure HDInsight, Azure Logic Apps, and Azure SQL Database. You can save even more with reservations.</p>\n</blockquote>\n<p>What this means is that for items like Azure Virtual Machines running Windows as an example, you won't be charged the OS <em>(Operating System)</em> license costs, so essentially the same cost as if you were running a Linux workload, the same for the SQL services. However, this is a small number of resources <em>(in comparison to the entire set of services offered by Microsoft Azure)</em>, which covers standard services that over time can make a huge difference to the cost of running these services.</p>\n<blockquote>\n<p>Provision fast, lean, and highly secure dev/test workloads on Azure—and realize substantial cost savings compared to your production workloads. Your dev/test discounted rates continue as long as you maintain your Visual Studio subscription.</p>\n</blockquote>\n<p>It is worth noting that although the intended readers of this are those with MCA or Enterprise Agreements with Microsoft, for those Visual Studio subscribers, you can go down the Dev/Test subscription route with <a href=\"https://azure.microsoft.com/en-gb/pricing/offers/ms-azr-0023p/?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">PayAsYouGo/DevTest</a> with a credit card as well, keep in mind the considerations below.</p>\n<p>CSP <em>(Cloud Solution Provider)</em> doesn't currently have a DevTest offer, but you could fall back to the Pay As You Go route.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"considerations\">Considerations<a href=\"https://luke.geek.nz/azure/Azure-DevTest-Subscription-Considerations#considerations\" class=\"hash-link\" aria-label=\"Direct link to Considerations\" title=\"Direct link to Considerations\">​</a></h2>\n<p>Now that we know some of the benefits of the DevTest plans, there are a few things to keep in mind that I have found a few people either didn't know *(and these subscriptions were deployed like candy at Halloween across organisations)*or were confused about, so let us cover it here.</p>\n<p><img loading=\"lazy\" alt=\"VisualStudio Subscription Types\" src=\"https://luke.geek.nz/assets/images/BlobHeading_Azure-DevTest-Considerations-194ee71309647c901bde4b80dc797b53.gif\" width=\"1200\" height=\"628\" class=\"img_ev3q\"></p>\n<p>I want it to be perfectly clear: if you meet the criteria to use the DevTest subscriptions, you should! But you might find you will end up with a mix of Pay As You Go and DevTest subscriptions, depending on your requirements <em>(and that's ok!)</em>.</p>\n<blockquote>\n<p>Remember: The Dev/Test plan is exclusively intended for developing and testing your applications.</p>\n</blockquote>\n<p>The considerations that you need to consider when selecting a Dev/Test subscription type over a Pay As You Go are as follows:</p>\n<ul>\n<li>The Dev/Test Azure Plan doesn't contain a financially backed service-level agreement <em>(SLA)</em>. The only exceptions are Azure DevOps, Azure Monitor and Visual Studio App Center. The entire purpose of this subscription is to give you the ability to trial and test services - and NOT run production workloads or services. This makes sense.</li>\n<li>Only active Visual Studio subscribers with standard subscriptions can use the Azure resources running within an Enterprise Dev/Test subscription (yes, that's right, everyone who has access to modify/create/delete resources needs to be a Visual Studio subscriber). This is the one that usually catches people out; although there are no technical guardrails preventing subscription use by unlicensed users, you still need to comply with the license agreement. Although it's worth pointing out, end users can also access the applications you build on top of the platform to provide feedback or perform acceptance tests without requiring a license.</li>\n<li>DevTest subscriptions are also compute quota limited, ie the compute quota restrictions are more restrictive (ie 10 cores on DevTest subscriptions vs 350 quota limit on non-devtest subscriptions).</li>\n</ul>\n<blockquote>\n<p>Even though there is no SLA for any resources deployed in the subscription, Support is still available <em>(i.e. open support tickets for resources)</em> if a suitable support plan exists as part of your MCA or Enterprise Agreement or is purchased for that subscription.</p>\n</blockquote>\n<p>Those are the two primary considerations that you need to consider when deciding on what subscription type to use; you will find for some teams that have relevant Visual Studio subscriptions, DevTest will work fine, but for others, Pay As You Go will be the right choice - your environment, may end up with a mix of both subscription types - make sure its clear what subscription license type it is, an example is I usually encourage subscriptions to be standing by pre-created ready to go and named something like 'PLACEHOLDER-PAYASYOUGO' or 'PLACEHOLDER-DEVTEST', although you can use Tags for this as well - the Overview pane of the Subscription resource also indicates the Subscription type.</p>\n<p>The last thing I will cover is what <em>Visual Studio subscribers</em> actually mean. To do that, we will take a look at the <a href=\"https://visualstudio.microsoft.com/subscriptions?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Visual Studio subscriptions</a>.</p>\n<p>If you navigate down the page, you will see a dropdown list with all the Visual Studio subscription types.</p>\n<p><img loading=\"lazy\" alt=\"VisualStudio Subscription Types\" src=\"https://luke.geek.nz/assets/images/VisualStudio_Subscription-Types-9cb7d1b6168c55f6baa12f9ae4d87846.png\" width=\"1153\" height=\"469\" class=\"img_ev3q\"></p>\n<p>If you click on the Azure tab, you will see the Azure credit <em>(for their own non-EA or MCA subscription)</em> and whether they are eligible as a valid Azure Dev/Test subscription user. To make it easier, here is a current table:</p>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<table><thead><tr><th><strong>Visual Studio Subscription Type</strong></th><th><strong>Azure Personal Credit</strong></th><th><strong>Valid Azure Dev/Test user</strong></th></tr></thead><tbody><tr><td>Visual Studio Enterprise monthly subscriptions</td><td>$0</td><td>No</td></tr><tr><td>Visual Studio Enterprise subscription</td><td>$150</td><td>Yes</td></tr><tr><td>Visual Studio subscriptions with GitHub Enterprise</td><td>$150</td><td>Yes</td></tr><tr><td>Visual Studio Professional monthly subscriptions</td><td>$0</td><td>No</td></tr><tr><td>Visual Studio Professional</td><td>$50</td><td>Yes</td></tr><tr><td>Visual Studio Professional subscriptions with GitHub Enterprise</td><td>$50</td><td>Yes</td></tr><tr><td>Visual Studio Test Professional subscription</td><td>$50</td><td>Yes</td></tr><tr><td>MSDN Platforms</td><td>$100</td><td>Yes</td></tr></tbody></table>\n<p><em>Azure personal credit is in USD.</em></p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"reference\">Reference<a href=\"https://luke.geek.nz/azure/Azure-DevTest-Subscription-Considerations#reference\" class=\"hash-link\" aria-label=\"Direct link to Reference\" title=\"Direct link to Reference\">​</a></h2>\n<p>The links below are some relevant reference material for further reading.</p>\n<ul>\n<li><a href=\"https://azure.microsoft.com/en-us/pricing/offers/ms-azr-0148p?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Enterprise Dev/Test</a></li>\n<li><a href=\"https://azure.microsoft.com/pricing/offers/ms-azr-0148g?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Plan for DevTest</a></li>\n<li><a href=\"https://learn.microsoft.com/azure/cost-management-billing/manage/create-enterprise-subscription?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Create an Enterprise Agreement subscription</a></li>\n<li><a href=\"https://learn.microsoft.com/en-us/azure/cost-management-billing/manage/create-subscription?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Create a Microsoft Customer Agreement subscription</a></li>\n<li><a href=\"https://visualstudio.microsoft.com/subscriptions?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Visual Studio subscriptions</a></li>\n</ul>",
            "url": "https://luke.geek.nz/azure/Azure-DevTest-Subscription-Considerations",
            "title": "Azure Dev/Test Subscription considerations",
            "summary": "When looking at your Dev/Test workloads in Azure, you may be considering the Azure Plan for Dev/Test Enterprise subscription type, available on both the Microsoft Customer Agreement (MCA) and Enterprise Agreement (EA) billing account types.",
            "date_modified": "2023-12-21T00:00:00.000Z",
            "author": {
                "name": "Luke Murray",
                "url": "https://luke.geek.nz"
            },
            "tags": [
                "Azure"
            ]
        },
        {
            "id": "https://luke.geek.nz/azure/Azure-Image-Builder-Build-Pipeline-with-Azure-DevOps",
            "content_html": "<p><a href=\"https://learn.microsoft.com/azure/virtual-machines/image-builder-overview?tabs=azure-powershell&amp;WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Image Builder</a> is an Azure managed service <em>(running <a href=\"https://www.packer.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Packer</a> underneath)</em> that allows you to create customised Virtual Machine images.</p>\n<blockquote>\n<p>By using standardized virtual machine (VM) images, your organization can more easily migrate to the cloud and help ensure consistency in your deployments. Images ordinarily include predefined security, configuration settings, and any necessary software. Setting up your own imaging pipeline requires time, infrastructure, and many other details. With Azure VM Image Builder, you only need to create a configuration that describes your image and submit it to the service where it is built and distributed.\nWith VM Image Builder, you can migrate your image customization pipeline to Azure as you continue using existing scripts, commands, and processes. You can integrate your core applications into a VM image so that your VMs can take on workloads after the images are created. You can even add configurations to build images for Azure Virtual Desktop as virtual hard discs (VHDs) for use in Azure Stack or for ease of exporting.</p>\n</blockquote>\n<p><img loading=\"lazy\" alt=\"Azure Image Builder Image Build with Bicep and Azure DevOps\" src=\"https://luke.geek.nz/assets/images/BlobHeading_Azure-Image-Builder-Image-Build-Bicep-Azure-DevOps-e125d198e1649cad7773d7316963e11c.png\" width=\"1200\" height=\"628\" class=\"img_ev3q\"></p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"overview\">Overview<a href=\"https://luke.geek.nz/azure/Azure-Image-Builder-Build-Pipeline-with-Azure-DevOps#overview\" class=\"hash-link\" aria-label=\"Direct link to Overview\" title=\"Direct link to Overview\">​</a></h2>\n<p>With the AIB (Azure Image Builder) service, you can quickly and easily create machine images for Azure environments using standardized virtual machine (VM) images, create a configuration that describes your image and submit it to the service for building and distribution.</p>\n<blockquote>\n<p>When you submit the configuration to the service, Azure creates an image template resource. When the image template resource is made, a staging resource group is created in your Azure subscription in the following format: IT_DestinationResourceGroupTemplateName(GUID). The staging resource group contains files and scripts, which are referenced in the File, Shell, and PowerShell customization in the ScriptURI property.</p>\n</blockquote>\n<p>To run the build, you invoke Run on the VM Image Builder template resource. The service then deploys additional resources for the build, such as a VM, network, disk, and network adapter. If you build an image without using an existing virtual network, VM Image Builder also deploys a public IP and network security group, and it connects to the build VM using Secure Shell (SSH) or Windows Remote Management (WinRM) protocol. If you select an existing virtual network, the service is deployed via Azure Private Link, and a public IP address isn't required.</p>\n<p>When the build finishes, all resources are deleted except for the staging resource group and the storage account. You can remove them by deleting the image template resource or leaving them in place to run the build again.</p>\n<p>To use Azure Image Builder, you need to create a configuration that describes your image and submit it to the service where it is built and distributed. A high-level workflow is illustrated in the following diagram:</p>\n<p><img loading=\"lazy\" alt=\"Azure Image Builder Flow\" src=\"https://luke.geek.nz/assets/images/image-builder-flow-848f04a2c5e7a1057278b1a6cca1ca91.png\" width=\"2110\" height=\"790\" class=\"img_ev3q\"></p>\n<p>Today, we will be using Azure Bicep to create the following:</p>\n<ul>\n<li>Azure Compute Gallery <em>(this will be used to hold our Image Template, so we can build our Virtual Machines from it)</em></li>\n<li>Image definition <em>(for the purpose, we will using a Windows Server 2022 Marketplace image, with additional customisations)</em></li>\n<li>Image Template <em>(this will include our customisations)</em></li>\n<li>User Assigned Managed Identity <em>(the user assigned managed identity will be used to build the image and read the blobs from the Azure storage account)</em></li>\n<li>Azure Storage account <em>(the Azure storage account, will hold our Application install files)</em></li>\n</ul>\n<p><img loading=\"lazy\" alt=\"Azure Image Builder - Bicep\" src=\"https://luke.geek.nz/assets/images/AIB_Bicep-dba9b93c7d3d7a985d84304e79e5c8bd.png\" width=\"1311\" height=\"543\" class=\"img_ev3q\"></p>\n<p>And then an Azure DevOps pipeline to deploy and build our template, including an application install of <a href=\"https://azure.microsoft.com/products/storage/storage-explorer?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Storage Explorer</a> and <a href=\"https://learn.microsoft.com/sysinternals/downloads/bginfo?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">bginfo</a>.</p>\n<p>All the code can be found on my public GitHub repository here: <a href=\"https://github.com/lukemurraynz/AzureImageBuilder\" target=\"_blank\" rel=\"noopener noreferrer\">lukemurraynz/AzureImageBuilder</a></p>\n<p>The Azure DevOps pipeline will complete the following steps:</p>\n<ol>\n<li>Create a new Azure Resource Group <em>(if required)</em></li>\n<li>Create an Azure storage account <em>(with public access enabled, and anonymous blob access)</em></li>\n<li>Copy the app install files in the /apps/ directory in git to the Azure storage account <em>(if they don't already exist)</em></li>\n<li>Deploy the Azure Image Builder infrastructure and Template</li>\n<li>Trigger an Azure CLI command to run the template build</li>\n<li>Adjust public access to the Azure storage account to disable.</li>\n</ol>\n<p>The git repository is laid out like so:</p>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<table><thead><tr><th>Folder</th><th>Description</th></tr></thead><tbody><tr><td>.pipelines</td><td>Contains CI/CD pipeline configurations and scripts.</td></tr><tr><td>apps</td><td>Houses application code and related resources.</td></tr><tr><td>iac</td><td>Stores Infrastructure as Code (IaC) configurations.</td></tr><tr><td>scripts</td><td>Contains utility scripts and other automation tools.</td></tr></tbody></table>\n<p>Within the iac folder is a customizations.bicep file. This file is intended for your image customisations; I intended to keep this separate from the infrastructure for easy modification without impacting any other file.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"azure-devops-configuration\">Azure DevOps Configuration<a href=\"https://luke.geek.nz/azure/Azure-Image-Builder-Build-Pipeline-with-Azure-DevOps#azure-devops-configuration\" class=\"hash-link\" aria-label=\"Direct link to Azure DevOps Configuration\" title=\"Direct link to Azure DevOps Configuration\">​</a></h2>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"create-project\">Create Project<a href=\"https://luke.geek.nz/azure/Azure-Image-Builder-Build-Pipeline-with-Azure-DevOps#create-project\" class=\"hash-link\" aria-label=\"Direct link to Create Project\" title=\"Direct link to Create Project\">​</a></h3>\n<p>Before we can build an image using Bicep and Azure DevOps, we need to create a project to hold our code.</p>\n<ol>\n<li>Login to your <strong><a href=\"https://dev.azure.com/\" target=\"_blank\" rel=\"noopener noreferrer\">Azure DevOps</a></strong> instance</li>\n<li>Click <strong>+ New Project</strong></li>\n<li>Type in a <strong>name for the project</strong> <em>(ie AIB (short for Azure Image Builder))</em></li>\n<li>Click <strong>Create</strong></li>\n</ol>\n<p><img loading=\"lazy\" alt=\"Azure DevOps - Create Project\" src=\"https://luke.geek.nz/assets/images/CreateADOAIBProject-06e65288801480aec1de66e1c4a4db1d.gif\" width=\"1904\" height=\"955\" class=\"img_ev3q\"></p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"initialize-repo\">Initialize Repo<a href=\"https://luke.geek.nz/azure/Azure-Image-Builder-Build-Pipeline-with-Azure-DevOps#initialize-repo\" class=\"hash-link\" aria-label=\"Direct link to Initialize Repo\" title=\"Direct link to Initialize Repo\">​</a></h3>\n<p>Now that we have our project, we can initialize the repository by cloning the <a href=\"https://github.com/lukemurraynz/AzureImageBuilder\" target=\"_blank\" rel=\"noopener noreferrer\">lukemurraynz/AzureImageBuilder</a> repository, containing all the code we need.</p>\n<p><em>Note: Due to git limitations, the Azure Storage Explorer install file is unable to be stored in the GitHub repository, for my demo. I will upload it to Azure DevOps after the clone. It's not recommended to store the binary files for large installs in Git directly for production and to store them in an Azure storage account. This process can be modified to skip the copy application step and install existing files from the Azure storage account.</em></p>\n<ol>\n<li>Login to your <strong><a href=\"https://dev.azure.com/\" target=\"_blank\" rel=\"noopener noreferrer\">Azure DevOps</a></strong> instance</li>\n<li><strong>Navigate</strong> to your <strong>AIB</strong> project</li>\n<li>Click <strong>Repos</strong></li>\n<li>Click <strong>Import</strong></li>\n<li>Make sure the repository type is: <strong>Git</strong> and clone <strong>URL</strong> is: <a href=\"https://github.com/lukemurraynz/AzureImageBuilder\" target=\"_blank\" rel=\"noopener noreferrer\">https://github.com/lukemurraynz/AzureImageBuilder</a></li>\n<li>Click <strong>Import</strong></li>\n</ol>\n<p><img loading=\"lazy\" alt=\"Azure DevOps - Create Project\" src=\"https://luke.geek.nz/assets/images/ImportADOAIBProject-3270a96f5d33d3133ee07848017f4104.gif\" width=\"1904\" height=\"974\" class=\"img_ev3q\"></p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"create-azure-service-connection\">Create Azure Service Connection<a href=\"https://luke.geek.nz/azure/Azure-Image-Builder-Build-Pipeline-with-Azure-DevOps#create-azure-service-connection\" class=\"hash-link\" aria-label=\"Direct link to Create Azure Service Connection\" title=\"Direct link to Create Azure Service Connection\">​</a></h3>\n<p>Now that we have our repository and the base code - we need a service connection. This connection will allow our Azure DevOps pipeline authorization to our Microsoft Azure subscription. To do this, we will use, the new <a href=\"https://learn.microsoft.com/entra/workload-id/workload-identity-federation?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Workload Identity Federation</a>, which allows us to authenticate to Azure, without worrying about secret management.</p>\n<ol>\n<li>Login to your <strong><a href=\"https://dev.azure.com/\" target=\"_blank\" rel=\"noopener noreferrer\">Azure DevOps</a></strong> instance</li>\n<li><strong>Navigate</strong> to your <strong>AIB</strong> project</li>\n<li>Click on <strong>Project Settings</strong></li>\n<li>Click on <strong>Service connections</strong></li>\n<li>Click on <strong>Create service connection</strong></li>\n<li>Select <strong>Azure Resource Manager</strong></li>\n<li>Click <strong>Next</strong></li>\n<li>Click <strong>Workload Identity federation (automatic)</strong></li>\n<li>Click <strong>Next</strong></li>\n<li>Select your <strong>Subscription</strong> <em>(after authenticating to Azure)</em>, and give it a <strong>name</strong> <em>(you will need the name for the Pipeline)</em>.</li>\n<li>Click <strong>Save</strong></li>\n</ol>\n<p><img loading=\"lazy\" alt=\"Azure DevOps - Create Service Connection\" src=\"https://luke.geek.nz/assets/images/CreateAzureServiceConnectionAIBProject-a8739909de7868e5ce4faa50c05ec5de.gif\" width=\"1894\" height=\"966\" class=\"img_ev3q\"></p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"import-pipeline\">Import Pipeline<a href=\"https://luke.geek.nz/azure/Azure-Image-Builder-Build-Pipeline-with-Azure-DevOps#import-pipeline\" class=\"hash-link\" aria-label=\"Direct link to Import Pipeline\" title=\"Direct link to Import Pipeline\">​</a></h3>\n<p>Now that we have our Service Connection, let us import our pipeline, which will be used to run our image build.</p>\n<ol>\n<li>Login to your <strong><a href=\"https://dev.azure.com/\" target=\"_blank\" rel=\"noopener noreferrer\">Azure DevOps</a></strong> instance</li>\n<li><strong>Navigate</strong> to your <strong>AIB</strong> project</li>\n<li>Click <strong>Pipelines</strong></li>\n<li>Click <strong>Create pipeline</strong></li>\n<li>Specify <strong>Azure Repos Git</strong></li>\n<li>Select your <strong>repository</strong> <em>(ie AIB)</em></li>\n<li>Select <strong>Existing Azure Pipelines YAML file</strong></li>\n<li>Under the <strong>dropdown</strong> list for the Path, select: <strong>/.pipelines/azure-pipelines.yml</strong></li>\n<li>Click <strong>Continue</strong></li>\n<li>Click on the ellipsis and select <strong>Save</strong></li>\n</ol>\n<p><img loading=\"lazy\" alt=\"Azure DevOps - Create Project\" src=\"https://luke.geek.nz/assets/images/Import-AzureDevOpsPiipeline-AIBProject-f1bb2779f62ea402f3b058ebbeff1a6a.gif\" width=\"1894\" height=\"966\" class=\"img_ev3q\"></p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"edit-pipeline-to-use-service-connection\">Edit Pipeline to use service connection<a href=\"https://luke.geek.nz/azure/Azure-Image-Builder-Build-Pipeline-with-Azure-DevOps#edit-pipeline-to-use-service-connection\" class=\"hash-link\" aria-label=\"Direct link to Edit Pipeline to use service connection\" title=\"Direct link to Edit Pipeline to use service connection\">​</a></h3>\n<p>Now that the pipeline has been imported, we need to edit it to use the Azure resource manager service connection we created earlier. Make sure you know the name of your service connection <em>(ie ServiceConnection-AIB)</em></p>\n<ol>\n<li>\n<p>Login to your <strong><a href=\"https://dev.azure.com/\" target=\"_blank\" rel=\"noopener noreferrer\">Azure DevOps</a></strong> instance</p>\n</li>\n<li>\n<p><strong>Navigate</strong> to your <strong>AIB</strong> project</p>\n</li>\n<li>\n<p>Click <strong>Pipelines</strong></p>\n</li>\n<li>\n<p>Click on your <strong>Pipelines</strong>, select <strong>Edit</strong></p>\n</li>\n<li>\n<p>The Service Connection has been created as a <strong>Variable</strong>, named <strong>serviceconnection</strong> in the pipeline, so we need to update the section:</p>\n<p>serviceconnection: azserviceconnections</p>\n</li>\n</ol>\n<p>To match the name of our service connection:</p>\n<div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">serviceconnection: ServiceConnection-AIB</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>Then click <strong>Save</strong></p>\n<p><em>Note: The Pipeline, by default, is set to run automatically; when it triggers a new commit to the main branch of the repo, you can adjust this to None else. It will try to run and fail <em>(as its missing variables, etc)</em>. If you do this, you can trigger the pipeline manually, but it depends on your requirements; as part of the testing - I liked that it automatically ran on every change to the code without having been manually triggered.</em></p>\n<p><img loading=\"lazy\" alt=\"Azure DevOps - Edit Pipeline\" src=\"https://luke.geek.nz/assets/images/Edit-AzureDevOpsPiipelineServiceConnection-AIBProject-54ba231374150f000c4b091e641d5440.gif\" width=\"1894\" height=\"966\" class=\"img_ev3q\"></p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"edit-pipeline-to-add-variables\">Edit Pipeline to add variables<a href=\"https://luke.geek.nz/azure/Azure-Image-Builder-Build-Pipeline-with-Azure-DevOps#edit-pipeline-to-add-variables\" class=\"hash-link\" aria-label=\"Direct link to Edit Pipeline to add variables\" title=\"Direct link to Edit Pipeline to add variables\">​</a></h3>\n<p>Here is where some of the customisation comes into play. The pipeline is looking for the following variables:</p>\n<ul>\n<li>imagetemplatename</li>\n<li>location</li>\n<li>resourceGroupName</li>\n<li>storageaccountname</li>\n</ul>\n<p>These variables will be consumed by the Azure CLI, to create the Resource Group and Azure Bicep, to create the Image template and Azure storage account, in your preferred region.</p>\n<p>Because in my demo, I am creating a 'Windows Server 2022' image in Australia East, my variables and values will be as follows:</p>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<table><thead><tr><th>Variables</th><th>Values</th></tr></thead><tbody><tr><td>storageaccountname</td><td>saccimg4545</td></tr><tr><td>resourceGroupName</td><td>azimagebuild-rg</td></tr><tr><td>location</td><td>australiaeast</td></tr><tr><td>imagetemplatename</td><td>server2022template</td></tr></tbody></table>\n<p>So let us add them.</p>\n<ol>\n<li>Login to your <strong><a href=\"https://dev.azure.com/\" target=\"_blank\" rel=\"noopener noreferrer\">Azure DevOps</a></strong> instance</li>\n<li><strong>Navigate</strong> to your <strong>AIB</strong> project</li>\n<li>Click <strong>Pipelines</strong></li>\n<li>Click on your <strong>Pipelines</strong>, select <strong>Edit</strong></li>\n<li>Click <strong>Variables</strong></li>\n<li>Select <strong>New Variable</strong></li>\n<li><strong>Add</strong> the required <strong>variables</strong>, make sure they are unique to your own environment <em>(ie the storage account name, needs to be globally unique)</em></li>\n<li>Click <strong>Save</strong></li>\n</ol>\n<p><img loading=\"lazy\" alt=\"Azure DevOps - Edit Pipeline\" src=\"https://luke.geek.nz/assets/images/Save-AzureDevOpsPipelineVariables-AIBProject-063cf5d9532e725cdcad3214a88f23a6.gif\" width=\"1894\" height=\"966\" class=\"img_ev3q\"></p>\n<blockquote>\n<p>There is an <a href=\"https://learn.microsoft.com/en-us/azure/virtual-machines/linux/image-builder-devops-task?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure DevOps Task</a>, to do the build, however its in preview and doesn't support elements such as a Virtual Machine restart at this time, so in my Pipeline, I am triggering the build using the Azure CLI.</p>\n</blockquote>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"bicep-configuration\">Bicep Configuration<a href=\"https://luke.geek.nz/azure/Azure-Image-Builder-Build-Pipeline-with-Azure-DevOps#bicep-configuration\" class=\"hash-link\" aria-label=\"Direct link to Bicep Configuration\" title=\"Direct link to Bicep Configuration\">​</a></h2>\n<p>You can modify the Bicep according to your own environment; items in the 'main.bicep' file you may want to change <em>(that I didn't turn into a variable)</em> are:</p>\n<ul>\n<li>Compute Gallery Name</li>\n<li>Compute Gallery image name</li>\n<li>Paired region that the image template will be replicated to. This is set to the same region as my source.</li>\n<li>Name of the User Assigned Managed Identity</li>\n</ul>\n<blockquote>\n<p>To reduce build time, the build VM size I am using is custom: Standard_D4ds_v5. If you remove this, it will default to the Standard_D2ds_v4 size, as you only pay for the time that the VM is building and sys prepping; I found the extra cores useful.</p>\n</blockquote>\n<p>I separated the Image Template <a href=\"https://learn.microsoft.com/azure/virtual-machines/linux/image-builder-json?tabs=json%2Cazure-powershell&amp;WT.mc_id=AZ-MVP-5004796#properties-customize\" target=\"_blank\" rel=\"noopener noreferrer\">customization</a> components, into its own Bicep module, that gets called into the main variable, I intend the customizations.bicep to be separate from the Azure Image Builder infrastructure components, to reduce impact or data loss, and make it easier for a first timer to customize the image separately, allowing you to revert any changes to the image build itself easily.</p>\n<p>You may also want to test <a href=\"https://learn.microsoft.com/en-us/azure/virtual-machines/vm-boot-optimization?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Image Optimization</a>; I have this enabled; however, it does add time to the image build process, but could improve your Virtual Machine creation time, could be useful to use in conjunction with a service, like Azure Virtual Desktop.</p>\n<blockquote>\n<p>This is the main file you will want to start modifying for your own image customization; I recommend starting small <em>(i.e. create a folder)</em>, then adding the apps and customisations one after the other.</p>\n</blockquote>\n<p>As part of the image build, I am:</p>\n<ol>\n<li>Creating a c:\\Apps\\ folder</li>\n<li>Setting the timezone <em>(although this gets overwritten by the sysprep back to UTC)</em></li>\n<li>Install the latest Windows Updates</li>\n<li>Restart</li>\n<li>Copy bginfo from the storage account <em>(this has been copied to the Azure storage account as part of the pipeline step)</em> to the apps folder. As it is small in size, I am using the File Packer provider to do the copy.</li>\n<li>Copy the Azure Storage Explorer install file from the storage account <em>(this has been copied to the Azure storage account as part of the pipeline step)</em> to the apps folder. As this is a larger file, the File packer provider locked up when attempting to copy, so I am leveraging Invoke-RestMethod to download it to the apps folder.</li>\n<li>Extract the bginfo zip file</li>\n<li>Install the Azure Storage Explorer</li>\n<li>Do a final Windows Update install <em>(in a past life, I've found new updates - ie Visual Studio can popup after application installs, if your image build time is quite long, feel free to remove this step, for me its a personal preference)</em></li>\n<li>Do a final restart</li>\n</ol>\n<p>As you can see, everything is mostly PowerShell-driven. Be aware of the double backslashes needed as well; for directories, using a single backslash will cause issues, as it is classed as an escape character. When editing the Bicep file, make sure you make sure of the <a href=\"https://marketplace.visualstudio.com/items?itemName=ms-azuretools.vscode-bicep\" target=\"_blank\" rel=\"noopener noreferrer\">Bicep Visual Studio code extension</a>. I have also created a base <a href=\"https://luke.geek.nz/azure/Getting-Started-with-GitHub-Codespaces/\" target=\"_blank\" rel=\"noopener noreferrer\">Codespace</a> in the GitHub repo that you could work from as well.</p>\n<p>Then, ideally, you can delete your previous image template every month and create a new one with the latest Windows Updates. Hopefully, this has given you enough of a sample to work from.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"run-image-build-deployment\">Run image build deployment<a href=\"https://luke.geek.nz/azure/Azure-Image-Builder-Build-Pipeline-with-Azure-DevOps#run-image-build-deployment\" class=\"hash-link\" aria-label=\"Direct link to Run image build deployment\" title=\"Direct link to Run image build deployment\">​</a></h2>\n<p>So, we have modified our Bicep and have our pipeline ready to go! It's time to run the build and create our Azure resources. We do this from Azure DevOps.</p>\n<ol>\n<li>Login to your <strong><a href=\"https://dev.azure.com/\" target=\"_blank\" rel=\"noopener noreferrer\">Azure DevOps</a></strong> instance</li>\n<li><strong>Navigate</strong> to your <strong>AIB</strong> project</li>\n<li>Click <strong>Pipelines</strong></li>\n<li>Click on your <strong>Pipeline</strong></li>\n<li>Select <strong>Run pipeline</strong></li>\n<li>Before the pipeline runs, we need to <strong>verify that the Pipeline has permission</strong> to use the service connection</li>\n<li>Select <strong>Verify</strong></li>\n<li>Select <strong>Approve</strong> to allow the pipeline stages, the ability to use the service principal</li>\n</ol>\n<blockquote>\n<p>If your build Build fails halfway through with the following error when attempting to create the Azure Image Builder resources:\nERROR: {\"code\": \"InvalidTemplateDeployment\", \"message\": \"Deployment failed with multiple errors: 'Authorization failed for template resource 'e6eaf07c-bb64-57d4-a69a-6d1463a77bdb' of type 'Microsoft.Authorization/roleAssignments'. The client '1d06bec0-6bb8-4ba2-b33b-98a4eafd5b84' with object id '1d06bec0-6bb8-4ba2-b33b-98a4eafd5b84' does not have permission to perform action 'Microsoft.Authorization/roleAssignments/write\nThis is due to the Service Connection not having Owner rights to the Azure subscription. Owner rights are created for the User Assigned Managed identity role assignments. You can fix this by copying the Object ID of the error, navigating to <a href=\"https://portal.azure.com/#view/Microsoft_AAD_IAM/StartboardApplicationsMenuBlade/~/AppAppsPreview/menuId~/null\" target=\"_blank\" rel=\"noopener noreferrer\">Entra ID Enterprise Apps</a>, and search by your Object ID. This will find an Enterprise Application, that is used by Azure DevOps to talk to Azure. Copy the Name, and navigate to your Azure subscription, and Access Control (IAM) blade, and add in your Enterprise Application as Owner.</p>\n</blockquote>\n<blockquote>\n<p>It can take 30+ minutes to build a Virtual Machine; the more customisations, the longer it will take, so please be patient, after the build has kicked off. As part of the build, you can also download and review the packer logs directly from the Storage account that was created in the IT resource group. I highly recommend testing one customization before proceeding to the next until you have the implementation downpack. The build step, if completed, will move to Optimizing, then Distributing to the Compute Gallery before it can be used.</p>\n</blockquote>\n<p><img loading=\"lazy\" alt=\"Azure DevOps - Run Pipeline\" src=\"https://luke.geek.nz/assets/images/Run-AzureDevOpsBuildPipeline-AIBProject-17a9786e20178b54d27f68e2fe73f4ef.gif\" width=\"1894\" height=\"966\" class=\"img_ev3q\"></p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"build-virtual-machine\">Build Virtual Machine<a href=\"https://luke.geek.nz/azure/Azure-Image-Builder-Build-Pipeline-with-Azure-DevOps#build-virtual-machine\" class=\"hash-link\" aria-label=\"Direct link to Build Virtual Machine\" title=\"Direct link to Build Virtual Machine\">​</a></h2>\n<p>Now that we have successfully built our Windows Server 2022 image, entirely automated using Bicep and Azure DevOps pipeline, let us create a Virtual Machine using the image that now resides in our Compute Gallery. To do this, we will simply use the Azure Portal to build and test from the Compute Gallery.</p>\n<ol>\n<li>Login to the <strong><a href=\"https://portal.azure.com/#home\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Portal</a></strong></li>\n<li>Navigate to your <strong>Azure Compute Gallery</strong></li>\n<li>Click your <strong>Image definition</strong>, which should now have a version associated with it <em>(ie 1.0.0 (latest version))</em></li>\n<li>Click <strong>+ Create VM</strong></li>\n<li>Navigate through the normal steps to create your virtual machine using your custom template.</li>\n</ol>\n<p><img loading=\"lazy\" alt=\"Azure Portal - Create Virtual Machine\" src=\"https://luke.geek.nz/assets/images/Create-TestVM-AIBProject-32c117f9d6fa4a932f34ce811cd4533c.gif\" width=\"1894\" height=\"966\" class=\"img_ev3q\"></p>\n<p>As you can see, the Virtual Machine has the Apps folder, Azure Storage Explorer installed and the bginfo executable stored as part of the image template.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"code\">Code<a href=\"https://luke.geek.nz/azure/Azure-Image-Builder-Build-Pipeline-with-Azure-DevOps#code\" class=\"hash-link\" aria-label=\"Direct link to Code\" title=\"Direct link to Code\">​</a></h2>\n<p>All the code can be found on my public GitHub repository here: <a href=\"https://github.com/lukemurraynz/AzureImageBuilder\" target=\"_blank\" rel=\"noopener noreferrer\">lukemurraynz/AzureImageBuilder</a>. This is the master <em>(and happy to take any contributions to it; just open a Pull Request)</em>,; for reference the code can be reviewed below:</p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"mainbicep\">main.bicep<a href=\"https://luke.geek.nz/azure/Azure-Image-Builder-Build-Pipeline-with-Azure-DevOps#mainbicep\" class=\"hash-link\" aria-label=\"Direct link to main.bicep\" title=\"Direct link to main.bicep\">​</a></h3>\n<div class=\"language-bicep codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockTitle_Ktv7\">main.bicep</div><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-bicep codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Define parameters for the Bicep template</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">param</span><span class=\"token plain\"> location </span><span class=\"token datatype class-name\">string</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">resourceGroup</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">location</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">param</span><span class=\"token plain\"> imagetemplatename </span><span class=\"token datatype class-name\">string</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">param</span><span class=\"token plain\"> azComputeGalleryName </span><span class=\"token datatype class-name\">string</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'myGallery'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token decorator\">@description</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'The name of the Storage account.'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">param</span><span class=\"token plain\"> stgaccountname </span><span class=\"token datatype class-name\">string</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">param</span><span class=\"token plain\"> azUserAssignedManagedIdentity </span><span class=\"token datatype class-name\">string</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'useri'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Define the details for the VM offer</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">var</span><span class=\"token plain\"> vmOfferDetails </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">offer</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'WindowsServer'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">publisher</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'MicrosoftWindowsServer'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">sku</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'2022-datacenter-azure-edition'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Include the customizations module</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">module</span><span class=\"token plain\"> customizationsModule </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'customizations.bicep'</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'customizationsModule'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">params</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">stgaccountname</span><span class=\"token operator\">:</span><span class=\"token plain\"> stgaccountname</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Create a user-assigned managed identity</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">resource</span><span class=\"token plain\"> uami </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.ManagedIdentity/userAssignedIdentities@2023-01-31'</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> azUserAssignedManagedIdentity</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">location</span><span class=\"token operator\">:</span><span class=\"token plain\"> location</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Create a Compute Gallery</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">resource</span><span class=\"token plain\"> azComputeGallery </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Compute/galleries@2022-03-03'</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> azComputeGalleryName</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">location</span><span class=\"token operator\">:</span><span class=\"token plain\"> location</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">description</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'mygallery'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Assign the Contributor role to the managed identity at the resource group scope</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">resource</span><span class=\"token plain\"> uamicontribassignment </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Authorization/roleAssignments@2022-04-01'</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">guid</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">resourceGroup</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">id</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'contributor'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">principalId</span><span class=\"token operator\">:</span><span class=\"token plain\"> uami</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">properties</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">principalId</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">principalType</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'ServicePrincipal'</span><span class=\"token plain\"> </span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">roleDefinitionId</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">resourceId</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Authorization/roleDefinitions'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'b24988ac-6180-42a0-ab88-20f7382dd24c'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Contributor</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">scope</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">resourceGroup</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Assign the Storage Blob Data Reader role to the managed identity at the resource group scope</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">resource</span><span class=\"token plain\"> uamiblobassignment </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Authorization/roleAssignments@2022-04-01'</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">guid</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">resourceGroup</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">id</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'blobreader'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">principalId</span><span class=\"token operator\">:</span><span class=\"token plain\"> uami</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">properties</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">principalId</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">principalType</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'ServicePrincipal'</span><span class=\"token plain\"> </span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">roleDefinitionId</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">resourceId</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Authorization/roleDefinitions'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'2a2b9908-6ea1-4ae2-8e65-a410df84e7d1'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Storage Blob Data Reader</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">scope</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">resourceGroup</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Create an image in the Compute Gallery</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">resource</span><span class=\"token plain\"> azImage </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Compute/galleries/images@2022-03-03'</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\">'</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">${</span><span class=\"token interpolated-string interpolation expression\">azComputeGallery</span><span class=\"token interpolated-string interpolation expression punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token interpolated-string interpolation expression\">name</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\">/myImage'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">location</span><span class=\"token operator\">:</span><span class=\"token plain\"> location</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">description</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'myImage'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">osType</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Windows'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">osState</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Generalized'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">hyperVGeneration</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'V2'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">identifier</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token property\">publisher</span><span class=\"token operator\">:</span><span class=\"token plain\"> vmOfferDetails</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">publisher</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token property\">offer</span><span class=\"token operator\">:</span><span class=\"token plain\"> vmOfferDetails</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">offer</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token property\">sku</span><span class=\"token operator\">:</span><span class=\"token plain\"> vmOfferDetails</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">sku</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">dependsOn</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    uami</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Create an image template</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">resource</span><span class=\"token plain\"> azImageTemplate </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.VirtualMachineImages/imageTemplates@2022-07-01'</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> imagetemplatename</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">location</span><span class=\"token operator\">:</span><span class=\"token plain\"> location</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">identity</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">type</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'UserAssigned'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">userAssignedIdentities</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\">'</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">${</span><span class=\"token interpolated-string interpolation expression\">uami</span><span class=\"token interpolated-string interpolation expression punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token interpolated-string interpolation expression\">id</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\">'</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">buildTimeoutInMinutes</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token number\">360</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">distribute</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token property\">type</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'SharedImage'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token property\">galleryImageId</span><span class=\"token operator\">:</span><span class=\"token plain\"> azImage</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">id</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token property\">runOutputName</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'myImageTemplateRunOutput'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token property\">replicationRegions</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Australia East'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">source</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token property\">type</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'PlatformImage'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token property\">publisher</span><span class=\"token operator\">:</span><span class=\"token plain\"> vmOfferDetails</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">publisher</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token property\">offer</span><span class=\"token operator\">:</span><span class=\"token plain\"> vmOfferDetails</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">offer</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token property\">sku</span><span class=\"token operator\">:</span><span class=\"token plain\"> vmOfferDetails</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">sku</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token property\">version</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'latest'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">customize</span><span class=\"token operator\">:</span><span class=\"token plain\"> customizationsModule</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">outputs</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">customizationsOutput</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">vmProfile</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token property\">vmSize</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Standard_D4ds_v5'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token property\">osDiskSizeGB</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token number\">0</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Leave size as source image size.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">optimize</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token property\">vmBoot</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token property\">state</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Enabled'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"storageaccountbicep\">storageaccount.bicep<a href=\"https://luke.geek.nz/azure/Azure-Image-Builder-Build-Pipeline-with-Azure-DevOps#storageaccountbicep\" class=\"hash-link\" aria-label=\"Direct link to storageaccount.bicep\" title=\"Direct link to storageaccount.bicep\">​</a></h3>\n<div class=\"language-bicep codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockTitle_Ktv7\">storageaccount.bicep</div><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-bicep codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Define the location parameter for all resources</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token decorator\">@description</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Location for all resources.'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">param</span><span class=\"token plain\"> location </span><span class=\"token datatype class-name\">string</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">resourceGroup</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">location</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Define the parameter for the Storage account name</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token decorator\">@description</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'The name of the Storage account.'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">param</span><span class=\"token plain\"> stgaccountname </span><span class=\"token datatype class-name\">string</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Define the parameter for the public access setting of the Storage account</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token decorator\">@description</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Sets the public access of the storage account.'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">param</span><span class=\"token plain\"> publicaccess </span><span class=\"token datatype class-name\">bool</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Create a Storage account</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">resource</span><span class=\"token plain\"> storgeaccount </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Storage/storageAccounts@2023-01-01'</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">toLower</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token plain\">stgaccountname</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Convert the Storage account name to lowercase</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">location</span><span class=\"token operator\">:</span><span class=\"token plain\"> location </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Set the location of the Storage account</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">kind</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'StorageV2'</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Use the 'StorageV2' kind</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">sku</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Standard_LRS'</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Use the 'Standard_LRS' SKU</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">accessTier</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Hot'</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Set the access tier to 'Hot'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">allowBlobPublicAccess</span><span class=\"token operator\">:</span><span class=\"token plain\"> publicaccess </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Set the public access setting</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Create a Blob service for the Storage account</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">resource</span><span class=\"token plain\"> blobService </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Storage/storageAccounts/blobServices@2022-09-01'</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">parent</span><span class=\"token operator\">:</span><span class=\"token plain\"> storgeaccount </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Set the parent resource to the Storage account</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'default'</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Use the 'default' name</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">isVersioningEnabled</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token boolean\">true</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Enable versioning</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Create a container in the Blob service</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">resource</span><span class=\"token plain\"> appcontainer </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Storage/storageAccounts/blobServices/containers@2022-09-01'</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'iac'</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Set the container name to 'iac'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">parent</span><span class=\"token operator\">:</span><span class=\"token plain\"> blobService </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Set the parent resource to the Blob service</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">publicAccess</span><span class=\"token operator\">:</span><span class=\"token plain\"> publicaccess </span><span class=\"token operator\">?</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Blob'</span><span class=\"token plain\"> </span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'None'</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Set the public access setting</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Output the ID of the Storage account</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">output</span><span class=\"token plain\"> storgeaccountid </span><span class=\"token datatype class-name\">string</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> storgeaccount</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">id</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Output the name of the Storage account</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">output</span><span class=\"token plain\"> storgeaccountname </span><span class=\"token datatype class-name\">string</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> storgeaccount</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">name</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Output the name of the container</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">output</span><span class=\"token plain\"> containername </span><span class=\"token datatype class-name\">string</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> appcontainer</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">name</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"customizationsbicep\">customizations.bicep<a href=\"https://luke.geek.nz/azure/Azure-Image-Builder-Build-Pipeline-with-Azure-DevOps#customizationsbicep\" class=\"hash-link\" aria-label=\"Direct link to customizations.bicep\" title=\"Direct link to customizations.bicep\">​</a></h3>\n<div class=\"language-bicep codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockTitle_Ktv7\">customizations.bicep</div><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-bicep codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Define the parameter for the Storage account name</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token decorator\">@description</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'The name of the Storage account.'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">param</span><span class=\"token plain\"> stgaccountname </span><span class=\"token datatype class-name\">string</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Get the environment-specific metadata</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">var</span><span class=\"token plain\"> environmentMetadata </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">environment</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Define the customizations for the image</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">var</span><span class=\"token plain\"> customizations </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Create a apps directory on the OS drive</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">type</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'PowerShell'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Create Apps Directory on OS drive'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">runElevated</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token boolean\">false</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">runAsSystem</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token boolean\">false</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">inline</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Use double backslashes to represent a single backslash in the file path</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'New-Item -ItemType Directory -Force -Path $env:SystemDrive\\\\apps\\\\'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Set the timezone to New Zealand Standard Time</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">type</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'PowerShell'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Set Timezone - New Zealand Standard Time'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">runElevated</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token boolean\">true</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">runAsSystem</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token boolean\">true</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">inline</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Set-TimeZone -Id \"New Zealand Standard Time\"'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Install Windows updates, excluding preview updates</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">type</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'WindowsUpdate'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">searchCriteria</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'IsInstalled=0'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">filters</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'exclude:$_.Title -like \\'*Preview*\\''</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Exclude preview updates</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'include:$true'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">updateLimit</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token number\">20</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Restart the system after Windows updates have completed</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">type</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'WindowsRestart'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">restartCheckCommand</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'write-host \\'restarting post Windows Updates\\''</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">restartTimeout</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'10m'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Copy BGInfo from the Storage account to the temporary directory</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">type</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'File'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Copy BGInfo from Storage account'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">sourceUri</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\">'https://</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">${</span><span class=\"token interpolated-string interpolation expression\">stgaccountname</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\">.blob.</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">${</span><span class=\"token interpolated-string interpolation expression\">environmentMetadata</span><span class=\"token interpolated-string interpolation expression punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token interpolated-string interpolation expression\">suffixes</span><span class=\"token interpolated-string interpolation expression punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token interpolated-string interpolation expression\">storage</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\">/iac/bginfo/BGInfo.zip'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">destination</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'$env:SystemDrive\\\\apps\\\\BGInfo.zip'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Copy Storage Explorer from the Storage account to the temporary directory</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">type</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'PowerShell'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Copy Storage Explorer from Storage account'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">runElevated</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token boolean\">true</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">runAsSystem</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token boolean\">true</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">inline</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Use double backslashes to represent a single backslash in the file path</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\">'Invoke-RestMethod  https://</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">${</span><span class=\"token interpolated-string interpolation expression\">stgaccountname</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\">.blob.</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">${</span><span class=\"token interpolated-string interpolation expression\">environmentMetadata</span><span class=\"token interpolated-string interpolation expression punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token interpolated-string interpolation expression\">suffixes</span><span class=\"token interpolated-string interpolation expression punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token interpolated-string interpolation expression\">storage</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\">/iac/storageexplorer/StorageExplorer-windows-x64.exe -OutFile  $env:SystemDrive\\\\apps\\\\StorageExplorer-windows-x64.exe'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Extract BGInfo</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">type</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'PowerShell'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Extract BGInfo'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">runElevated</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token boolean\">true</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">runAsSystem</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token boolean\">true</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">inline</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Use double backslashes to represent a single backslash in the file path</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Expand-Archive -LiteralPath $env:SystemDrive\\\\apps\\\\BGInfo.zip -DestinationPath $env:SystemDrive\\\\apps\\\\'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Install Storage Explorer</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">type</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'PowerShell'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Install Storage Explorer'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">runElevated</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token boolean\">true</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">runAsSystem</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token boolean\">true</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">inline</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Use double backslashes to represent a single backslash in the file path</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Check if the executable file exists</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'$exePath = \"$env:SystemDrive\\\\apps\\\\StorageExplorer-windows-x64.exe\"'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'if (Test-Path $exePath) {'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'  &amp; $exePath /VERYSILENT /SUPPRESSMSGBOXES /NORESTART /ALLUSERS'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'} else {'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'  Write-Output \"The file $exePath does not exist.\"'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'}'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">   </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Install any Windows updates, that are left or needed after app installs</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">   </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">type</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'WindowsUpdate'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">searchCriteria</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'IsInstalled=0'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">filters</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'exclude:$_.Title -like \\'*Preview*\\''</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Exclude preview updates</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'include:$true'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">updateLimit</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token number\">20</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Restart the system after Windows updates have completed and fresh restart before sysprep.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">type</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'WindowsRestart'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">restartCheckCommand</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'write-host \\'restarting post image customisation\\''</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">restartTimeout</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'10m'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Output the customizations array</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">output</span><span class=\"token plain\"> customizationsOutput </span><span class=\"token datatype class-name\">array</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> customizations</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"azure-pipelinesyml\">azure-pipelines.yml<a href=\"https://luke.geek.nz/azure/Azure-Image-Builder-Build-Pipeline-with-Azure-DevOps#azure-pipelinesyml\" class=\"hash-link\" aria-label=\"Direct link to azure-pipelines.yml\" title=\"Direct link to azure-pipelines.yml\">​</a></h3>\n<div class=\"language-yaml codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockTitle_Ktv7\">azure-pipelines.yml</div><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-yaml codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Define the pipeline name and trigger</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token key atrule\">name</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> Azure Image Builder </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">-</span><span class=\"token plain\"> Build and Publish Image Template</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token key atrule\">trigger</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">-</span><span class=\"token plain\"> main</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Define pipeline variables</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token key atrule\">variables</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token key atrule\">serviceconnection</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> azserviceconnections</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token key atrule\">overwrite</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> </span><span class=\"token boolean important\">false</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Define the VM image for the pipeline</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token key atrule\">pool</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token key atrule\">vmImage</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> ubuntu</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">-</span><span class=\"token plain\">latest</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Define the stages of the pipeline</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token key atrule\">stages</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># First stage: Deploy Azure Storage Account</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">-</span><span class=\"token plain\"> </span><span class=\"token key atrule\">stage</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> ImageBuilderDeploy</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token key atrule\">jobs</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">-</span><span class=\"token plain\"> </span><span class=\"token key atrule\">deployment</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> Bicepstgaccount</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token key atrule\">displayName</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Deploy Azure Storage Account to Azure for Apps'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token key atrule\">environment</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'AzureDeployment'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token key atrule\">strategy</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token key atrule\">runOnce</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token key atrule\">deploy</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token key atrule\">steps</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">-</span><span class=\"token plain\"> </span><span class=\"token key atrule\">checkout</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> self</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">           </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Deploy the Bicep template for the Azure Storage account</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">-</span><span class=\"token plain\"> </span><span class=\"token key atrule\">task</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> AzureCLI@2</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">            </span><span class=\"token key atrule\">displayName</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Deploy Bicep - Azure Storage account and IaC App Container'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">            </span><span class=\"token key atrule\">inputs</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">              </span><span class=\"token key atrule\">azureSubscription</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> $(serviceconnection) </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># replace with your service connection name</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">              </span><span class=\"token key atrule\">scriptType</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'pscore'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">              </span><span class=\"token key atrule\">scriptLocation</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'inlineScript'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">              </span><span class=\"token key atrule\">inlineScript</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">|</span><span class=\"token scalar string\" style=\"color:rgb(255, 121, 198)\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token scalar string\" style=\"color:rgb(255, 121, 198)\">                az group create --name $(ResourceGroupName) --location $(location) </span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token scalar string\" style=\"color:rgb(255, 121, 198)\">                az deployment group create `</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token scalar string\" style=\"color:rgb(255, 121, 198)\">                        --template-file $(Build.SourcesDirectory)/iac/storageaccount.bicep `</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token scalar string\" style=\"color:rgb(255, 121, 198)\">                        --resource-group $(resourceGroupName) `</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token scalar string\" style=\"color:rgb(255, 121, 198)\">                        --parameters location=$(location) stgaccountname=$(storageaccountname) publicaccess=true</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Copy the app install files to the Azure Storage account</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">-</span><span class=\"token plain\"> </span><span class=\"token key atrule\">task</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> AzureCLI@2</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">            </span><span class=\"token key atrule\">displayName</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Copy App install files to Azure Storage Account'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">            </span><span class=\"token key atrule\">inputs</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">              </span><span class=\"token key atrule\">azureSubscription</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> $(serviceconnection)</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">              </span><span class=\"token key atrule\">scriptType</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'bash'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">              </span><span class=\"token key atrule\">scriptLocation</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'inlineScript'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">              </span><span class=\"token key atrule\">inlineScript</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">|</span><span class=\"token scalar string\" style=\"color:rgb(255, 121, 198)\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token scalar string\" style=\"color:rgb(255, 121, 198)\">                az storage blob upload-batch -d 'iac' --account-name $(storageaccountname) -s $(Build.SourcesDirectory)/apps --type block --overwrite $(overwrite) --verbose</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token scalar string\" style=\"color:rgb(255, 121, 198)\">                blobs=$(az storage blob list --account-name $(storageaccountname) --container-name 'iac' --query '[].{name:name, url:properties.url}' -o tsv)</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token scalar string\" style=\"color:rgb(255, 121, 198)\">                echo $blobs</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Second job: Deploy Azure Image Builder Infrastructure</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">-</span><span class=\"token plain\"> </span><span class=\"token key atrule\">job</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> ImageBuilderDeployment</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token key atrule\">dependsOn</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> Bicepstgaccount</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token key atrule\">displayName</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Deploy Azure Image Builder Infrastructure'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token key atrule\">steps</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">     </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Build the Azure Image Builder template</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">-</span><span class=\"token plain\"> </span><span class=\"token key atrule\">task</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> AzureCLI@2</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token key atrule\">displayName</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">' Build Azure Image Builder Template'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token key atrule\">inputs</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token key atrule\">azureSubscription</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> $(serviceconnection) </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># replace with your service connection name</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token key atrule\">scriptType</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'pscore'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token key atrule\">scriptLocation</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'inlineScript'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token key atrule\">inlineScript</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">|</span><span class=\"token scalar string\" style=\"color:rgb(255, 121, 198)\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token scalar string\" style=\"color:rgb(255, 121, 198)\">            az group create --name $(ResourceGroupName) --location $(location) </span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token scalar string\" style=\"color:rgb(255, 121, 198)\">            az deployment group create `</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token scalar string\" style=\"color:rgb(255, 121, 198)\">                    --template-file $(Build.SourcesDirectory)/iac/main.bicep `</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token scalar string\" style=\"color:rgb(255, 121, 198)\">                    --resource-group $(resourceGroupName) `</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token scalar string\" style=\"color:rgb(255, 121, 198)\">                    --parameters location=$(location) imagetemplatename=$(imagetemplatename) stgaccountname=$(storageaccountname) # Add more parameters as needed</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Second stage: Run Azure Image Builder Template Build</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">-</span><span class=\"token plain\"> </span><span class=\"token key atrule\">stage</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> ImageBuilderRun</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token key atrule\">jobs</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">-</span><span class=\"token plain\"> </span><span class=\"token key atrule\">job</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> ImageBuilderRun</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token key atrule\">displayName</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Run Azure Image Builder Template Build'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token key atrule\">steps</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Run the Azure Image Builder</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">-</span><span class=\"token plain\"> </span><span class=\"token key atrule\">task</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> AzureCLI@2</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token key atrule\">displayName</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Run Azure Image Builder'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token key atrule\">inputs</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token key atrule\">azureSubscription</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> $(serviceconnection) </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># replace with your service connection name</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token key atrule\">scriptType</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'pscore'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token key atrule\">scriptLocation</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'inlineScript'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token key atrule\">inlineScript</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">|</span><span class=\"token scalar string\" style=\"color:rgb(255, 121, 198)\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token scalar string\" style=\"color:rgb(255, 121, 198)\">            az image builder run -n $(imagetemplatename) -g $(resourceGroupName) --no-wait --verbose</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token scalar string\" style=\"color:rgb(255, 121, 198)\">                        az image builder wait -n $(imagetemplatename) -g $(resourceGroupName) --custom \"lastRunStatus.runState!='Running'\" --verbose</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">-</span><span class=\"token plain\"> </span><span class=\"token key atrule\">task</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> AzureCLI@2</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token key atrule\">displayName</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Deploy Bicep - Set Azure Storage account public access to false'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token key atrule\">inputs</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">              </span><span class=\"token key atrule\">azureSubscription</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> $(serviceconnection) </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># replace with your service connection name</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">              </span><span class=\"token key atrule\">scriptType</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'pscore'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">              </span><span class=\"token key atrule\">scriptLocation</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'inlineScript'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">              </span><span class=\"token key atrule\">inlineScript</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">|</span><span class=\"token scalar string\" style=\"color:rgb(255, 121, 198)\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token scalar string\" style=\"color:rgb(255, 121, 198)\">                az group create --name $(ResourceGroupName) --location $(location) </span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token scalar string\" style=\"color:rgb(255, 121, 198)\">                az deployment group create `</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token scalar string\" style=\"color:rgb(255, 121, 198)\">                        --template-file $(Build.SourcesDirectory)/iac/storageaccount.bicep `</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token scalar string\" style=\"color:rgb(255, 121, 198)\">                        --resource-group $(resourceGroupName) `</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token scalar string\" style=\"color:rgb(255, 121, 198)\">                        --parameters location=$(location) stgaccountname=$(storageaccountname) publicaccess=false</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>",
            "url": "https://luke.geek.nz/azure/Azure-Image-Builder-Build-Pipeline-with-Azure-DevOps",
            "title": "Azure Image Builder Image Build with Bicep and Azure DevOps",
            "summary": "Azure Image Builder is an Azure managed service (running Packer underneath) that allows you to create customised Virtual Machine images.",
            "date_modified": "2023-11-22T00:00:00.000Z",
            "author": {
                "name": "Luke Murray",
                "url": "https://luke.geek.nz"
            },
            "tags": [
                "Azure"
            ]
        },
        {
            "id": "https://luke.geek.nz/azure/misc/Book-Review-Azure-architecture-explained",
            "content_html": "<p>Book review of <a href=\"https://www.packtpub.com/product/azure-architecture-explained/9781837634811\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Architecture Explained: A comprehensive guide to building effective cloud solutions</a></p>\n<blockquote>\n<p>Disclaimer: This is the first book review I have ever done, and this review is entirely my opinion and may not fully reflect the value you may or may not get from this book. Everyone will have their unique viewpoint and priorities of what they want out of a book, so please take my review as an opinionated view from my own viewpoint; I am, of course, happy to discuss different points of view and discussions on this page comments. We are all here to learn something!</p>\n</blockquote>\n<p>Book synopsis:</p>\n<blockquote>\n<p>\"Azure is a sophisticated technology that requires a detailed understanding to reap its full potential and employ its advanced features. This book provides you with a clear path to designing optimal cloud-based solutions in Azure by delving into the platform's intricacies.\nYou’ll begin by understanding the effective and efficient security management and operation techniques in Azure to implement the appropriate configurations in Microsoft Entra ID. Next, you’ll explore how to modernize your applications for the cloud, examining the different computation and storage options, as well as using Azure data solutions to help migrate and monitor workloads. You’ll also learn how to build your solutions, including containers, networking components, security principles, governance, and advanced observability. With practical examples and step-by-step instructions, you can work on infrastructure-as-code to effectively deploy and manage resources in your environment.\"</p>\n</blockquote>\n<p><img loading=\"lazy\" alt=\"Azure Architecture Explained\" src=\"https://luke.geek.nz/assets/images/Review_AzureArchitectureExplained_TitleBoat-87d96784f7133dd30567a910da6ceeba.jpg\" width=\"1536\" height=\"2040\" class=\"img_ev3q\"></p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"introduction\">Introduction<a href=\"https://luke.geek.nz/azure/misc/Book-Review-Azure-architecture-explained#introduction\" class=\"hash-link\" aria-label=\"Direct link to Introduction\" title=\"Direct link to Introduction\">​</a></h2>\n<p><a href=\"https://www.packtpub.com/product/azure-architecture-explained/9781837634811\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Architecture Explained</a> is a Packtpub published (in September 2023) book written by the following authors:</p>\n<ul>\n<li><a href=\"https://www.linkedin.com/in/daverndn/\" target=\"_blank\" rel=\"noopener noreferrer\">David Rendón</a></li>\n<li><a href=\"https://www.linkedin.com/in/bretthargreaves/\" target=\"_blank\" rel=\"noopener noreferrer\">Brett Hargreaves</a></li>\n</ul>\n<p>Forward by <a href=\"https://www.linkedin.com/in/konger/\" target=\"_blank\" rel=\"noopener noreferrer\">Sarah Kong</a></p>\n<blockquote>\n<p>Although this book was given to me to review (for free, I have no formal relationship with either Packetpub, although I thank them for allowing me to review this book or the Authors, and I am reviewing this book from an entirely independent view), as someone who architects and builds Azure solutions, this is the type of book, I usually would read, based on the title and synopsis, so let us take under the cover...</p>\n</blockquote>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"overview-of-azure-architecture\">Overview of Azure Architecture<a href=\"https://luke.geek.nz/azure/misc/Book-Review-Azure-architecture-explained#overview-of-azure-architecture\" class=\"hash-link\" aria-label=\"Direct link to Overview of Azure Architecture\" title=\"Direct link to Overview of Azure Architecture\">​</a></h2>\n<p>The book's slogan is \"A <strong>comprehensive</strong> guide to <strong>building</strong> effective cloud solutions\".</p>\n<blockquote>\n<p>Architecting solutions in Azure is a <strong>massive</strong> subject, requiring knowledge about the details of specific services, knowledge and understanding of <strong>Cloud adoption</strong>, <strong>well-architected frameworks</strong>, <strong>patterns and practices</strong> and <strong>interoperability</strong> between different services and systems, if one were to use this slogan and book title, I would expect the book to cover across all these areas.</p>\n</blockquote>\n<p><img loading=\"lazy\" alt=\"Azure Architecture Book - Courtesy of Bing Image Creator\" src=\"https://luke.geek.nz/assets/images/AzureBook_AzureArchitectureExplained_AIGenerated-5c503416bccc30fb7cafed69a46dad43.jpg\" width=\"1024\" height=\"1024\" class=\"img_ev3q\"></p>\n<p>So let us look to see if the book meets these details...</p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"cloud-adoption\">Cloud Adoption<a href=\"https://luke.geek.nz/azure/misc/Book-Review-Azure-architecture-explained#cloud-adoption\" class=\"hash-link\" aria-label=\"Direct link to Cloud Adoption\" title=\"Direct link to Cloud Adoption\">​</a></h3>\n<p>The book includes a section on the Microsoft Cloud Adoption Framework, including links, diagrams and explanations of how the Cloud Adoption framework fits in - not only with Microsoft Azure (which is the focus of this book) but with other Clouds as well!</p>\n<p><strong>What I liked about the representation of the <a href=\"https://learn.microsoft.com/azure/cloud-adoption-framework/?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Cloud Adoption</a> within this book was - it was enough for a beginner and intermediate in Cloud adoption, to get going - without the need for third-party resources (i.e. resources outside of this book), but for those after a bit more advanced information or detail - supplied the relevant internet links, to the relevant Microsoft Learn resources <em>(in short format, i.e. bit.ly - so easily can be copied from a hard covered paper book into your browser)</em>, so the authors didn't try to shove a lot of unnecessary detail into the book, but was to the point, as they started the journey into Cloud governance and covered the basics and knowledge at an intermediate level, without a lot of the detail, that you don't necessarily need as part of the book.</strong></p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"well-architected-framework\">Well-Architected Framework<a href=\"https://luke.geek.nz/azure/misc/Book-Review-Azure-architecture-explained#well-architected-framework\" class=\"hash-link\" aria-label=\"Direct link to Well-Architected Framework\" title=\"Direct link to Well-Architected Framework\">​</a></h3>\n<p>In terms of the Well-Architected framework, however, there needed to be more direct representation, which surprised me, as although the Cloud Adoption Framework guides the Cloud adoption journey, the Well-Architected Framework focuses more on helping you make informed decisions for building systems in These frameworks can work side by side - HOWEVER, having said that...</p>\n<p>The Microsoft Well-Architected Framework consists of 5 pillars, these are:</p>\n<ul>\n<li>Performance Efficiency</li>\n<li>Reliability</li>\n<li>Security</li>\n<li>Cost Optimization</li>\n<li>Operational Excellence</li>\n</ul>\n<p>Underneath these pillars are design principles, such as design for business requirements, design for resiliency, design for recovery, etc.</p>\n<p>These design principles were woven throughout the implementation portions of the books and, although not directly called out in some areas, had high-level representation that you can subtly pick up.</p>\n<p><strong>I believe, reading the <a href=\"https://learn.microsoft.com/azure/cloud-adoption-framework/?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Cloud Adoption</a> and <a href=\"https://learn.microsoft.com/azure/well-architected/?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Well-Architected Frameworks</a>, directly on the Microsoft Learn website, can help supplement your understanding of this book, and some of the decisions made by the authors.</strong></p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"patterns-and-practices\">Patterns and practices<a href=\"https://luke.geek.nz/azure/misc/Book-Review-Azure-architecture-explained#patterns-and-practices\" class=\"hash-link\" aria-label=\"Direct link to Patterns and practices\" title=\"Direct link to Patterns and practices\">​</a></h3>\n<p>Let us look at a particular part of the book; my example is the 'Making the Most of the Infrastructure-as-Code for Azure' section.</p>\n<p>When I talk about patterns and practices, I am thinking of 2 things:</p>\n<ol>\n<li>Does a Pattern provide a prescribed solution to a problem?</li>\n<li>Does a Practice provide an established method or way of working?</li>\n</ol>\n<blockquote>\n<p>\"Infrastructure-as-code enables organizations to define and manage their infrastructure and application resources in a programmatic and automated manner. Developers and operations teams can use configuration files or scripts to describe their desired Azure infrastructure and deploy it consistently and reliably. This part will discuss how infrastructure-as-code in Azure empowers organizations to optimize their cloud infrastructure, increase productivity, and drive successful digital transformations.\"</p>\n</blockquote>\n<p>This particular part included Chapters such as:</p>\n<ul>\n<li>Governance in Azure</li>\n<li>Building Solutions using Azure Bicep</li>\n<li>Using Azure Pipelines to Build your Infrastructure in Azure</li>\n<li>Continous integration and deployment using Azure DevOps\nand Tips from the Field!</li>\n</ul>\n<p>Instead of jumping straight into the build, the authors take the time to explain Azure governance by following the premise of a hypothetical company and that company challenges, and then working on the previous parts of the work, where the authors had done a very prescriptive <em>(great)</em> job of the management and creation of relevant Azure resources using the Azure Portal and explain the business challenges that Infrastructure as Code helps with, before jumping into the authoring, management and implementation of Azure Bicep for Infrastructure as Code.</p>\n<p><strong>Patterns and practices, in my opinion, are where this build shone through and where the true value is are the Patterns and practices. Throughout this book, the authors explain the WHY and WHAT before presenting the HOW. It was straightforward to follow and build upon what was learnt and discovered from previous chapters.</strong></p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"interoperability\">Interoperability<a href=\"https://luke.geek.nz/azure/misc/Book-Review-Azure-architecture-explained#interoperability\" class=\"hash-link\" aria-label=\"Direct link to Interoperability\" title=\"Direct link to Interoperability\">​</a></h3>\n<p>Interoperability is always very hard to review - the definition of interoperability I am using is <em>\"the ability of computer systems or software to exchange and make use of information.\"</em> Commonly, how <em>systems work together</em>. In the complex world we live in, systems being able to talk to other systems made by other third-party vendors and individuals can be key to successful business outcomes so that it can be a very technically driven area.</p>\n<p>This is hard to review when discussing a book-related specifically to Azure architecture <em>(i.e., this is not a book about connecting Azure services to AWS, etc.)</em>.</p>\n<p><img loading=\"lazy\" alt=\"Azure Architecture Book - Courtesy of Bing Image Creator\" src=\"https://luke.geek.nz/assets/images/AzureBook_AzureArchitectureExplained_AIGenerated_Interopability-054e908ee0b1b59d2680a383f882f9bb.jpg\" width=\"1024\" height=\"1024\" class=\"img_ev3q\"></p>\n<p>However, interoperability is a key area for a topic such as Entra ID, to which this book has entire chapters dedicated.</p>\n<p>This book has all the problems that all books have! Information Technology changes so rapidly that there's a potential risk that the book you just purchased may be out of date.\nFor context, this book was published in September of 2023 <em>(22 Sept 2023)</em>, which would mean a lot of writing and work, then peer-review, assuming both from a technical standpoint and writing standpoint, after the authors initial 'pre-prod' draft, before it reaches the public. In mid-July of 2023 <em>(11 July 2023)</em> Microsoft announced a rename of Azure Active Directory to Entra ID. There was mention of the rename, but Azure AD was still used in certain areas of the book.</p>\n<p>In the context of this book, Entra ID is referred to by its previous name, Azure Active Directory; as a reader who is aware of that rename, it was still incredibly easy to read and follow.</p>\n<p>The book explains user identities, the differences between authentication and authorization <em>(Which I loved!)</em> and how Azure Active Directory <em>(i.e. Entrea ID)</em> can be used to integrate and secure applications and work alongside the rest of the Microsoft Entra ID suite of products, all within the context of a fictitious company, allowing you to follow on.</p>\n<p><strong>Overall, I believe the interoperability portions of Identity in this book are first class, from the creation of your first tenancy to Role Based Access to Azure resources; the authors do a great job in explaining how identity underpins the platforms and enables connectivity and access to multiple services, that even a beginner can get going quickly, with knowing WHY they are doing the stuff, that the book asks of them!</strong></p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"content-and-coverage\">Content and Coverage<a href=\"https://luke.geek.nz/azure/misc/Book-Review-Azure-architecture-explained#content-and-coverage\" class=\"hash-link\" aria-label=\"Direct link to Content and Coverage\" title=\"Direct link to Content and Coverage\">​</a></h2>\n<p>When considering Content and Coverage, my main concern here is:</p>\n<ul>\n<li>Is the content in this book actually 'actionable'?</li>\n<li>Can I use what I learn in this book in real-world scenarios, or is it entirely hypothetical?</li>\n</ul>\n<p>I am pleased to say <strong>Yes</strong> to this book; it is both actionable and useful in the real world! I was pleasantly surprised by this!</p>\n<p>Architecture can be a very <em>dry</em> subject, and there are so many ways you can approach it, for example:</p>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<table><thead><tr><th>Architect Type</th><th>Focus Area</th></tr></thead><tbody><tr><td><strong>System Architect</strong></td><td>Design and structure of individual systems or applications.</td></tr><tr><td><strong>Enterprise Architect</strong></td><td>Aligning IT strategy with overall business strategy.</td></tr><tr><td><strong>Solution Architect</strong></td><td>Designing solutions that meet specific project requirements.</td></tr><tr><td><strong>Data Architect</strong></td><td>Designing and managing an organization's data architecture.</td></tr><tr><td><strong>Application Architect</strong></td><td>Designing the structure and interaction of applications.</td></tr><tr><td><strong>Network Architect</strong></td><td>Designing and implementing computer networks.</td></tr><tr><td><strong>Security Architect</strong></td><td>Designing and implementing security measures and controls.</td></tr><tr><td><strong>Cloud Architect</strong></td><td>Designing and implementing cloud infrastructure solutions.</td></tr><tr><td><strong>Infrastructure Architect</strong></td><td>Designing and managing IT infrastructure components.</td></tr><tr><td><strong>Integration Architect</strong></td><td>Ensuring seamless integration between different systems.</td></tr><tr><td><strong>Business Architect</strong></td><td>Aligning business processes and IT strategy.</td></tr></tbody></table>\n<p><img loading=\"lazy\" alt=\"Azure Architects - Courtesy of Bing Image Creator\" src=\"https://luke.geek.nz/assets/images/AzureBook_AzureArchitectureExplained_AIGenerated_Architects-ffccadb8a11b85f535d73c75d06c264f.jpg\" width=\"1024\" height=\"1024\" class=\"img_ev3q\"></p>\n<p><strong>When I look at this book, I am looking at it from a mix of Cloud, Solution and Infrastructure architecture, mainly due to my own personal journey, and this is where I feel the book fits.</strong></p>\n<p>When I look at the slogan of the book again, and the word <strong>comprehensive</strong> is used, I believe this is used accurately; the authors did a great book in discussing the WHY, WHAT and HOW of various solutions in the Networking section of this book, the authors covered design considerations for VNET <em>(Virtual Networks)</em>, before delving into more advanced topics, such as Network Security and Azure Virtual Virtual WAN, bringing you on the journey that you would take in real life.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"clarity-and-accessibility\">Clarity and Accessibility<a href=\"https://luke.geek.nz/azure/misc/Book-Review-Azure-architecture-explained#clarity-and-accessibility\" class=\"hash-link\" aria-label=\"Direct link to Clarity and Accessibility\" title=\"Direct link to Clarity and Accessibility\">​</a></h2>\n<p><strong>The authors did a very clear job of explaining, from start to finish, how to create the necessary Azure resources and why you should have created them in the first place. This was very well done. In just about all sections, the words were supplemented with images and diagrams, making it easier to further understand what was happening in the text. Any links to internet websites were done as short links, making it very easy to copy and navigate to, whether you have a physical copy of the book or a digital copy.</strong></p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"hands-on-exercises-and-tutorials\">Hands-On Exercises and Tutorials<a href=\"https://luke.geek.nz/azure/misc/Book-Review-Azure-architecture-explained#hands-on-exercises-and-tutorials\" class=\"hash-link\" aria-label=\"Direct link to Hands-On Exercises and Tutorials\" title=\"Direct link to Hands-On Exercises and Tutorials\">​</a></h2>\n<p><strong>This book contained valid hands-on exercises and tutorials, allowing you to follow along with the content.</strong></p>\n<p>Sample code and exercise files were also provided publically on GitHub <a href=\"https://github.com/PacktPublishing/Azure-Architecture-Explained\" target=\"_blank\" rel=\"noopener noreferrer\">PacktPublishing/Azure-Architecture-Explained</a> and <a href=\"https://github.com/daveRendon/azinsider\" target=\"_blank\" rel=\"noopener noreferrer\">daveRendon/azinsider</a>, allowing readers, to easily fork and get a copy of the code required for the relevant exercises, such as creating resources, such as an Azure Virtual Network with Bicep.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"updates-and-relevance\">Updates and Relevance<a href=\"https://luke.geek.nz/azure/misc/Book-Review-Azure-architecture-explained#updates-and-relevance\" class=\"hash-link\" aria-label=\"Direct link to Updates and Relevance\" title=\"Direct link to Updates and Relevance\">​</a></h2>\n<p>At the time of this review (November 2023), this book (published in September 2023) is still entirely relevant; as mentioned earlier, there have been some renames of products from Microsoft that are a 'gotcha' to know, as part of reading this book, but the theory and implementation steps are entirely relevant.</p>\n<p>I came across one link to a website <a href=\"https://cafbaseline.com/\" target=\"_blank\" rel=\"noopener noreferrer\">cafbaseline.com</a> that was not available at the time of reading, but all other links I used were relevant and working!</p>\n<p><strong>As with all books, if you come across this book 2-3 years down the track <em>(i.e. 2025/2026)</em> make sure you check the publishing date and version and make sure there's not a renewer version of this book! This is a book I personally would love to see various revisions and updates to as the world of Microsoft Azure changes!</strong></p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"authors-expertise\">Author's Expertise<a href=\"https://luke.geek.nz/azure/misc/Book-Review-Azure-architecture-explained#authors-expertise\" class=\"hash-link\" aria-label=\"Direct link to Author's Expertise\" title=\"Direct link to Author's Expertise\">​</a></h2>\n<p>I believe the authors have the correct expertise to make this book viable <em>(and based on my own knowledge, reading this book)</em> and accurate.</p>\n<ul>\n<li><a href=\"https://www.linkedin.com/in/daverndn/\" target=\"_blank\" rel=\"noopener noreferrer\">David Rendón</a> is a Microsoft MVP (Most Valuable Professional) and MCT (Microsoft Certified Trainer); these awards themselves require technical validation, and the display of knowledge to help solve organisation problems, and as an MCT, David, has the experience to explain the concepts, in a way that could be easily understood as a beginner.</li>\n<li><a href=\"https://www.linkedin.com/in/bretthargreaves/\" target=\"_blank\" rel=\"noopener noreferrer\">Brett Hargreaves</a> as a current Cloud Practice Lead, with certifications, such as the Azure Solutions Architect Expert and a background in Architect, Brett has the practical know-how to help make this content relevant, to those looking to Architect solutions in Microsoft Azure.</li>\n</ul>\n<p><strong>It is my opinion that this duo is indeed suited to write this type of book, and this can be seen from the actionable and valid output of the book itself.</strong></p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"conclusion\">Conclusion<a href=\"https://luke.geek.nz/azure/misc/Book-Review-Azure-architecture-explained#conclusion\" class=\"hash-link\" aria-label=\"Direct link to Conclusion\" title=\"Direct link to Conclusion\">​</a></h2>\n<p><strong>Azure Architecture Explained is a book containing 409 pages of actionable content.</strong></p>\n<p>The authors draw on their extensive experience and research to provide practical patterns and practices, to help build on the story of starting from scratch, understanding the <em>big picture</em> of how complex systems within the Azure ecosystem sit together, with the advice actually to get started and create and modify those resources.</p>\n<p>The book is well-structured and full of relevant examples and exercises.</p>\n<blockquote>\n<p><strong>I highly recommend this book to anyone interested in architecting solutions across Microsoft Azure, and it was very easy to read and consume the content! I feel smarter, having read it. Thank you to the authors for making the effort to write and release this book. It is a good addition to my library of books that I will be referencing in the future! I read this book on a Cruise while relaxing, and it didn't feel like I was doing work!</strong></p>\n</blockquote>",
            "url": "https://luke.geek.nz/azure/misc/Book-Review-Azure-architecture-explained",
            "title": "Book Review Azure Architecture Explained",
            "summary": "Book review of Azure Architecture Explained: A comprehensive guide to building effective cloud solutions",
            "date_modified": "2023-11-18T00:00:00.000Z",
            "author": {
                "name": "Luke Murray",
                "url": "https://luke.geek.nz"
            },
            "tags": [
                "Azure",
                "Misc"
            ]
        },
        {
            "id": "https://luke.geek.nz/azure/Working-with-CIDR-Azure-Bicep",
            "content_html": "<p><a href=\"https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing\" target=\"_blank\" rel=\"noopener noreferrer\">Classless Inter-Domain Routing</a> <em>(CIDR)</em> is a method of allocating IP addresses and routing Internet Protocol <em>(IP)</em> packets.</p>\n<p><img loading=\"lazy\" alt=\"Mastering CIDRs With Azure Bicep\" src=\"https://luke.geek.nz/assets/images/BlogHeading_Mastering-CIDRs-with-Azure-Bicep-66efb8cdacf85d6baa1b1350ac084e9a.gif\" width=\"1200\" height=\"628\" class=\"img_ev3q\"></p>\n<p>This article includes sample Bicep functions for working with CIDR, for Azure Virtual Network and Subnet creation.</p>\n<div class=\"language-bicep codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockTitle_Ktv7\">CiDR.bicep</div><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-bicep codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// This function parses the CIDR notation and returns an object with the network address, subnet mask, and other details.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">output</span><span class=\"token plain\"> v6addressspace </span><span class=\"token datatype class-name\">object</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">parseCidr</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'2001:db8:1234::/48'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// This function generates an array of subnets within the specified CIDR block. The subnet size is 64, and the index calculates the subnet.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// The 'range(0, 5)' function generates an array of numbers from 0 to 4. The 'for' loop iterates over these numbers.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// For each number 'i', the 'cidrSubnet' function calculates a subnet within the '2001:db8:1234::/48' CIDR block.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// The subnet size is 64, and 'i' is used as the index. The resulting array contains the calculated subnets.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">output</span><span class=\"token plain\"> v6subnets </span><span class=\"token datatype class-name\">array</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">for</span><span class=\"token plain\"> i </span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">in</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">range</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">,</span><span class=\"token plain\"> </span><span class=\"token number\">5</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">cidrSubnet</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'2001:db8:1234::/48'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">,</span><span class=\"token plain\"> </span><span class=\"token number\">64</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">,</span><span class=\"token plain\"> i</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// This function generates an array of host addresses within the specified CIDR block. The index is used to calculate the host address.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Similar to the 'v6subnets' array, the 'range(0, 5)' function generates an array of numbers from 0 to 4.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// For each number 'i', the 'cidrHost' function calculates a host address within the '2001:db8:1234::/48' CIDR block.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// The resulting array contains the calculated host addresses.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">output</span><span class=\"token plain\"> v6hosts </span><span class=\"token datatype class-name\">array</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">for</span><span class=\"token plain\"> i </span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">in</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">range</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">,</span><span class=\"token plain\"> </span><span class=\"token number\">5</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">cidrHost</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'2001:db8:1234::/48'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">,</span><span class=\"token plain\"> i</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// This function generates a string within the specified CIDR block. The host index is always 3 (Azure Reserved).</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// The 'cidrHost' function calculates a host address within the '2001:db8:1234::/48' CIDR block.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// The host index is '0 + 3', which is 3. This is because the first three addresses in a subnet are reserved in Azure.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">output</span><span class=\"token plain\"> v6hostsazure </span><span class=\"token datatype class-name\">string</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">cidrHost</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'2001:db8:1234::/48'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">,</span><span class=\"token plain\"> </span><span class=\"token number\">0</span><span class=\"token plain\"> </span><span class=\"token operator\">+</span><span class=\"token plain\"> </span><span class=\"token number\">3</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>References:</p>\n<ul>\n<li><a href=\"https://luke.geek.nz/azure/IPv6-on-Azure/\" target=\"_blank\" rel=\"noopener noreferrer\">IPv6 in Microsoft Azure</a></li>\n<li><a href=\"https://learn.microsoft.com/en-us/azure/azure-resource-manager/bicep/bicep-functions-cidr?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">CIDR functions for Bicep</a></li>\n<li><a href=\"https://github.com/Azure/bicep/issues/3975\" target=\"_blank\" rel=\"noopener noreferrer\">CIDR math functions for Azure Networking calculations #3975</a></li>\n</ul>",
            "url": "https://luke.geek.nz/azure/Working-with-CIDR-Azure-Bicep",
            "title": "Mastering CIDRs With Azure Bicep",
            "summary": "Classless Inter-Domain Routing (CIDR) is a method of allocating IP addresses and routing Internet Protocol (IP) packets.",
            "date_modified": "2023-11-18T00:00:00.000Z",
            "author": {
                "name": "Luke Murray",
                "url": "https://luke.geek.nz"
            },
            "tags": [
                "Azure"
            ]
        },
        {
            "id": "https://luke.geek.nz/azure/IPv6-on-Azure",
            "content_html": "<p>With more support for IPv6 being added to native Azure products, its time to take a closer look into IPv6 and its use within Azure.</p>\n<blockquote>\n<p>The <a href=\"https://en.wikipedia.org/wiki/IPv6_deployment\" target=\"_blank\" rel=\"noopener noreferrer\">deployment of IPv6</a>, the latest version of the Internet Protocol (IP), has been in progress since the mid-2000s. IPv6 was designed as the successor protocol for IPv4 with an expanded addressing space. IPv4, which has been in use since 1982, is in the final stages of exhausting its unallocated address space but still carries most Internet traffic.</p>\n</blockquote>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"overview\">Overview<a href=\"https://luke.geek.nz/azure/IPv6-on-Azure#overview\" class=\"hash-link\" aria-label=\"Direct link to Overview\" title=\"Direct link to Overview\">​</a></h2>\n<blockquote>\n<p>Most recently, <a href=\"https://azure.microsoft.com/en-us/updates/general-availability-gateway-load-balancer-ipv6-support/?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Gateway Load Balancer</a> and <a href=\"https://azure.microsoft.com/en-us/updates/public-preview-application-gateway-now-supports-ipv6-frontend/?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Application Gateway</a> has had IPv6 support announced, allowing these services to handle both IPv6 along with IPv4, from client and server.\nIPv6 or Internet Protocol Version 6 is an upgrade of IPv4. A network layer protocol allows data communications to pass packets over a network. IPv6 uses 128-bit addressing and supports over 340 trillion trillion devices, a significant improvement over IPv4’s 32-bit addressing scheme that supports over 4.3 billion devices.</p>\n</blockquote>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<table><thead><tr><th></th><th>IPv4</th><th>IPv6</th></tr></thead><tbody><tr><td>No. of bits on IP Address</td><td>32</td><td>128</td></tr><tr><td>Format</td><td>decimal</td><td>hexadecimal</td></tr><tr><td>Capable of Addresses</td><td>4.3 billion</td><td>infinite number</td></tr><tr><td>How to ping</td><td>&nbsp;ping XXX.XXX.XXX</td><td>ping6</td></tr></tbody></table>\n<blockquote>\n<p>Azure Virtual Network enables you to host applications in Azure with IPv6 and IPv4 connectivity within a virtual network and to and from the Internet. Due to the exhaustion of public IPv4 addresses, new networks for mobility and the Internet of Things (IoT) are often built on IPv6.\nIPv6 provides a larger address space, improved security, and better performance than IPv4. <a href=\"https://learn.microsoft.com/azure/virtual-network/ip-services/ipv6-overview?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Virtual Network</a> enables you to host applications in Azure with IPv6 and IPv4 connectivity both within a virtual network and to and from the Internet, which is beneficial for expanding the reach of your Azure-hosted applications into the growing mobile and Internet of Things markets</p>\n</blockquote>\n<blockquote>\n<p>IPv6 for Azure virtual network is much more full-featured - enabling full IPv6 solution architectures to be deployed in Azure.</p>\n</blockquote>\n<p>There are some current <a href=\"https://learn.microsoft.com/en-us/azure/virtual-network/ip-services/ipv6-overview?WT.mc_id=AZ-MVP-5004796#limitations\" target=\"_blank\" rel=\"noopener noreferrer\">limitations</a> to be aware of, such as:</p>\n<ul>\n<li>VPN gateways currently support IPv4 traffic only, but they can still be deployed in a dual-stacked virtual network using Azure PowerShell and Azure CLI commands only.</li>\n<li>IPv6-only Virtual Machines or Virtual Machines Scale Sets aren't supported; each NIC must include at least one IPv4 IP configuration.</li>\n<li>ICMPv6 isn't currently supported in Network Security Groups.</li>\n<li>Azure Firewall doesn't currently support IPv6. It can operate in a dual-stack virtual network using only IPv4, but the firewall subnet must be IPv4-only.</li>\n</ul>\n<p>Although still in a transitory period with some services, Microsoft has come some way to enabling IPv6 dual stack (IPv4 and IPv6) services, with <a href=\"https://learn.microsoft.com/troubleshoot/azure/active-directory/azure-ad-ipv6-support?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Entra ID even supporting</a> running on IPv6, and with US Government mandates like below:</p>\n<blockquote>\n<p>On November 19, 2020, the United States Office of Management and Budget (OMB) issued the latest U. S. federal government IPv6-only policy in its memorandum (M-21-07) directing all federal government agencies to complete at least 80% of the transition from IPv4 to the single stack of IPv6 by 2025.</p>\n</blockquote>\n<p>This will be an ever-increasing functionality.</p>\n<p>As the world becomes increasingly interconnected, the need for robust and scalable networking solutions has never been greater. IPv6 is the latest version of the Internet Protocol, offering a range of benefits over its predecessor, IPv4.</p>\n<p>There are several benefits of using IPv6 over IPv4, including:</p>\n<ul>\n<li>Larger Address Space: IPv6 uses 128-bit addresses, which provides a much larger address space than IPv4's 32-bit addresses. This means that there are more available addresses, an estimated 340 undecillion addresses, which is essential as the number of devices connected to the internet continues to grow. It was intended to replace&nbsp;IPv4.  <em>(The primary reason for IPv4 address exhaustion is insufficient capacity to design the original Internet infrastructure. The original designers of the network did not anticipate the rapid growth of the internet and the increasing demand for IP addresses.&nbsp;This depletion is one of the reasons for the development and deployment of its successor protocol, IPv6)</em></li>\n<li>Improved Security: IPv6 includes built-in security features such as IPsec, which provides end-to-end encryption and authentication. This helps to ensure that data transmitted over the network is secure and protected from unauthorized access. Since IPv4 was already defined, IPsec is bolted on <em>(IPSec packets are payload)</em>, but IPv6 was still being determined, and IPsec is an integral part of IPv6. From the beginning, IPv6 has had the AH and ESP extension headers, something not possible with IPv4.</li>\n<li>Better Quality of Service: IPv6 includes features that allow for better quality of service <em>(QoS)</em>, such as flow labelling and traffic classification. This helps ensure that critical applications receive the bandwidth and priority they need to function properly. This is especially important for real-time applications like video conferencing and online gaming.</li>\n<li>Future-Proofing: IPv6 supports future technologies and applications, such as the Internet of Things <em>(IoT)</em>, smart homes/farms and cloud computing. By adopting IPv6, organizations can ensure their networks are ready to support these emerging technologies and applications.</li>\n</ul>\n<p>There is <a href=\"https://azure.microsoft.com/updates/azure-public-ipv6-offerings-are-free-as-of-july-31/?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">no charge to use Public IPv6 addresses or prefixes</a>, in Microsoft Azure, resources and bandwidth on Azure are charged at the same rates as for IPv4.</p>\n<p>In addition, Azure provides tools and services for monitoring and managing IPv6 traffic, such as Azure Network Watcher and Azure Traffic Manager. These tools allow you to monitor network traffic with IP flow verification, for example, that checks if packets from IPv6 are allowed or denied and also tells you what security rule allowed or denied the traffic, diagnose issues, and optimize performance, ensuring that your IPv6-enabled applications and services are running smoothly.</p>\n<p>If we look at the Internet Society pulse <em>(current as of this article)</em>, 27% of the top 1000 websites globally support IPv6, growing every day.</p>\n<p><img loading=\"lazy\" alt=\"Internet Society Pulse curates information about levels of IPv6 adoption in countries and networks around the world\" src=\"https://luke.geek.nz/assets/images/IPv6Azure_InternetSecurityPulse_Nov2023-4d4cb24ea5c133dd7ba4e169c81261e3.png\" width=\"1553\" height=\"1137\" class=\"img_ev3q\"></p>\n<p>The transition to IPv6 will take time. While many services and platforms already support IPv6, many still need to, and as more and more devices are connected to the internet, the need for IPv6 will only grow. So, we need to be prepared and start preparation and implementation of IPv6 solutions as soon as possible.</p>\n<p>So, when you hear IPv6, always consider the following:</p>\n<ol>\n<li><strong>Availability</strong>: There is no risk of IPv6 IP exhaustion.</li>\n<li><strong>Cost</strong>: IPv6 IPs cost Azure zero dollars. This could be a trigger for customers to choose Azure.</li>\n<li><strong>Compliance</strong>: IPv6 mandates are helping governments start their journeys to the cloud.</li>\n<li><strong>Network Performance</strong>: NATing (Network Address Translation) adds network latency. IPv6 does not require NATing for cross-region traffic.</li>\n</ol>\n<p><img loading=\"lazy\" alt=\"IPv6 Dual Stack Azure Network\" src=\"https://luke.geek.nz/assets/images/ipv6-sample-diagram-91705225eb4451bf084008b5a92b31af.png\" width=\"480\" height=\"387\" class=\"img_ev3q\"></p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"getting-started-with-ipv6-in-azure\">Getting Started with IPv6 in Azure<a href=\"https://luke.geek.nz/azure/IPv6-on-Azure#getting-started-with-ipv6-in-azure\" class=\"hash-link\" aria-label=\"Direct link to Getting Started with IPv6 in Azure\" title=\"Direct link to Getting Started with IPv6 in Azure\">​</a></h2>\n<blockquote>\n<p>Azure Virtual WAN currently supports IPv4 traffic only.</p>\n</blockquote>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"add-ipv6-address-space-to-an-existing-virtual-network\">Add IPv6 address space to an existing Virtual Network<a href=\"https://luke.geek.nz/azure/IPv6-on-Azure#add-ipv6-address-space-to-an-existing-virtual-network\" class=\"hash-link\" aria-label=\"Direct link to Add IPv6 address space to an existing Virtual Network\" title=\"Direct link to Add IPv6 address space to an existing Virtual Network\">​</a></h3>\n<p>We can add IPV6 ranges to an existing Azure Virtual Network by adding an IPV6 address range and then dual stacking both IPV4 and IPV6 ranges.</p>\n<blockquote>\n<p>The subnets for IPv6 must be exactly /64 in size. This ensures future compatibility should you decide to enable subnet routing to an on-premises network since some routers can only accept /64 IPv6 routes.\nTo add IPv6 to existing IPv4 deployments, you can't add IPv6 ranges to a virtual network with existing resource navigation links.</p>\n</blockquote>\n<p>In my demo, I have a Virtual Network with an IPV4 address space of 10.0.0.0/16 (65,536 addresses)</p>\n<p>For my demo purposes, I will add in an IPV6 address space of: 2001:db8🔢:/48 <em>(1208925819614629174706176 addresses)</em></p>\n<p>With two subnets of:</p>\n<ul>\n<li>2001:db8🔢:/64 <em>(18446744073709551616 addresses)</em></li>\n<li>2001:db8🔢1::/64 <em>(18446744073709551616)</em></li>\n</ul>\n<p>Reference: <a href=\"https://www.cidr.eu/en/calculator\" target=\"_blank\" rel=\"noopener noreferrer\">IPV6 Calculator</a></p>\n<ol>\n<li>Navigate to the <a href=\"https://portal.azure.com/#home\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Portal</a></li>\n<li>Navigate to <a href=\"https://portal.azure.com/#view/HubsExtension/BrowseResource/resourceType/Microsoft.Network%2FvirtualNetworks\" target=\"_blank\" rel=\"noopener noreferrer\">Virtual Networks</a></li>\n<li>Navigate to the Virtual Network you want to add an IPV6 address range into.</li>\n<li>Add in the IPV6 address space, click Save</li>\n<li>Once completed, you can add your subnets.</li>\n</ol>\n<p><img loading=\"lazy\" alt=\"Add IPV6 Address range to existing Azure Virtual Network\" src=\"https://luke.geek.nz/assets/images/Add_IPV6AddressSpace_AzVirtualNetworkExisting-da545269a6b9b515bc3879fc4f974c01.gif\" width=\"1856\" height=\"955\" class=\"img_ev3q\"></p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"add-ipv6-address-space-to-a-new-existing-virtual-network\">Add IPv6 address space to a new existing Virtual Network<a href=\"https://luke.geek.nz/azure/IPv6-on-Azure#add-ipv6-address-space-to-a-new-existing-virtual-network\" class=\"hash-link\" aria-label=\"Direct link to Add IPv6 address space to a new existing Virtual Network\" title=\"Direct link to Add IPv6 address space to a new existing Virtual Network\">​</a></h3>\n<p>Adding an IPV6 range to a New Virtual Network is reasonably easy using the Portal interface.</p>\n<blockquote>\n<p>The subnets for IPv6 must be exactly /64 in size. This ensures future compatibility should you decide to enable subnet routing to an on-premises network since some routers can only accept /64 IPv6 routes.</p>\n</blockquote>\n<ol>\n<li>Navigate to the <a href=\"https://portal.azure.com/#home\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Portal</a></li>\n<li>Navigate to <a href=\"https://portal.azure.com/#view/HubsExtension/BrowseResource/resourceType/Microsoft.Network%2FvirtualNetworks\" target=\"_blank\" rel=\"noopener noreferrer\">Virtual Networks</a></li>\n<li>Click on New Virtual Network</li>\n<li>Select a name for your Virtual Network</li>\n<li>Select the Region and Resource Group, click Next</li>\n<li>Skip the Security pane <em>(unless needed)</em> and click Next</li>\n<li>Select the dropdown for  Add Ipv4 address space, and select Add IPv6 address space</li>\n</ol>\n<p><img loading=\"lazy\" alt=\"Add IPV6 Address range to new Azure Virtual Network\" src=\"https://luke.geek.nz/assets/images/Add_IPV6AddressSpace_AzVirtualNetworkNew-11121dada7c5b288936295b3f4245ab5.gif\" width=\"1856\" height=\"955\" class=\"img_ev3q\"></p>\n<p>Azure provides automatic IPv6 address allocation for resources in a Virtual Network. When you enable IPv6 for a Virtual Network, Azure assigns IPv6 addresses to resources like virtual machines and load balancers. Linux and Windows Virtual Machines can all use IPv6 for Azure Virtual Network.</p>\n<p>If your Virtual Network is peered, sync the connections so that your peered networks can see the IPv6 resources.</p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"create-a-virtual-machine-in-a-ipv6-subnet\">Create a Virtual Machine in a IPV6 subnet<a href=\"https://luke.geek.nz/azure/IPv6-on-Azure#create-a-virtual-machine-in-a-ipv6-subnet\" class=\"hash-link\" aria-label=\"Direct link to Create a Virtual Machine in a IPV6 subnet\" title=\"Direct link to Create a Virtual Machine in a IPV6 subnet\">​</a></h3>\n<ol>\n<li>Navigate to the <a href=\"https://portal.azure.com/#home\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Portal</a></li>\n<li>Navigate to <a href=\"https://portal.azure.com/#view/HubsExtension/BrowseResource/resourceType/Microsoft.Compute%2FVirtualMachines\" target=\"_blank\" rel=\"noopener noreferrer\">Virtual Machines</a></li>\n<li>Click Create Azure Virtual machine</li>\n<li>Go through the Create Virtual Machine wizard until you hit Networking and select the Virtual Network and Subnet with the IPV6 addresses. Your Network Interface needs to sit in the subnet that has IPV6 address ranges.</li>\n</ol>\n<p>You can also also create a separate NIC (Network Interface Card), assign it to the IPv6 subnet, and have this as a secondary NIC.</p>\n<p><img loading=\"lazy\" alt=\"Dual IPV4 and IP6 NIC\" src=\"https://luke.geek.nz/assets/images/DualIPV46Nic-5608fce780da5c54824890c1526a883f.png\" width=\"1832\" height=\"708\" class=\"img_ev3q\"></p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"creating-dual-stack-network-with-azure-bicep\">Creating dual-stack network with Azure Bicep<a href=\"https://luke.geek.nz/azure/IPv6-on-Azure#creating-dual-stack-network-with-azure-bicep\" class=\"hash-link\" aria-label=\"Direct link to Creating dual-stack network with Azure Bicep\" title=\"Direct link to Creating dual-stack network with Azure Bicep\">​</a></h3>\n<div class=\"language-bicep codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-bicep codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// This function parses the CIDR notation and returns an object with the network address, subnet mask, and other details.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">output</span><span class=\"token plain\"> v6addressspace </span><span class=\"token datatype class-name\">object</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">parseCidr</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'2001:db8:1234::/48'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// This function generates an array of subnets within the specified CIDR block. The subnet size is 64, and the index calculates the subnet.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// The 'range(0, 5)' function generates an array of numbers from 0 to 4. The 'for' loop iterates over these numbers.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// For each number 'i', the 'cidrSubnet' function calculates a subnet within the '2001:db8:1234::/48' CIDR block.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// The subnet size is 64, and 'i' is used as the index. The resulting array contains the calculated subnets.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">output</span><span class=\"token plain\"> v6subnets </span><span class=\"token datatype class-name\">array</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">for</span><span class=\"token plain\"> i </span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">in</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">range</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">,</span><span class=\"token plain\"> </span><span class=\"token number\">5</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">cidrSubnet</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'2001:db8:1234::/48'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">,</span><span class=\"token plain\"> </span><span class=\"token number\">64</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">,</span><span class=\"token plain\"> i</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// This function generates an array of host addresses within the specified CIDR block. The index is used to calculate the host address.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Similar to the 'v6subnets' array, the 'range(0, 5)' function generates an array of numbers from 0 to 4.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// For each number 'i', the 'cidrHost' function calculates a host address within the '2001:db8:1234::/48' CIDR block.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// The resulting array contains the calculated host addresses.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">output</span><span class=\"token plain\"> v6hosts </span><span class=\"token datatype class-name\">array</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">for</span><span class=\"token plain\"> i </span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">in</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">range</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">,</span><span class=\"token plain\"> </span><span class=\"token number\">5</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">cidrHost</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'2001:db8:1234::/48'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">,</span><span class=\"token plain\"> i</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// This function generates a string within the specified CIDR block. The host index is always 3 (Azure Reserved).</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// The 'cidrHost' function calculates a host address within the '2001:db8:1234::/48' CIDR block.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// The host index is '0 + 3', which is 3. This is because the first three addresses in a subnet are reserved in Azure.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">output</span><span class=\"token plain\"> v6hostsazure </span><span class=\"token datatype class-name\">string</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">cidrHost</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'2001:db8:1234::/48'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">,</span><span class=\"token plain\"> </span><span class=\"token number\">0</span><span class=\"token plain\"> </span><span class=\"token operator\">+</span><span class=\"token plain\"> </span><span class=\"token number\">3</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// This Bicep file creates an Azure Virtual Network with IPv4 and IPv6 subnets.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Set the default location to the location of the resource group</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">param</span><span class=\"token plain\"> location </span><span class=\"token datatype class-name\">string</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">resourceGroup</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">location</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Set the number of subnets to be created</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">param</span><span class=\"token plain\"> subnetnumber </span><span class=\"token datatype class-name\">int</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token number\">6</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Define the network address for the virtual network</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">var</span><span class=\"token plain\"> vnetAddress </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'2001:db8:1234::'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Define the network size for the virtual network</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">var</span><span class=\"token plain\"> vnetSize </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token number\">48</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Combine the network address and size into a CIDR block for the IPv6 virtual network</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">var</span><span class=\"token plain\"> vnetCidrIPv6 </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\">'</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">${</span><span class=\"token interpolated-string interpolation expression\">vnetAddress</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\">/</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">${</span><span class=\"token interpolated-string interpolation expression\">vnetSize</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\">'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Define the network address for the IPv4 virtual network</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">var</span><span class=\"token plain\"> vnetAddressIPv4 </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'192.168.0.0'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Define the network size for the IPv4 virtual network</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">var</span><span class=\"token plain\"> vnetSizeIPv4 </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token number\">16</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Combine the network address and size into a CIDR block for the IPv4 virtual network</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">var</span><span class=\"token plain\"> vnetCidrIPv4 </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\">'</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">${</span><span class=\"token interpolated-string interpolation expression\">vnetAddressIPv4</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\">/</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">${</span><span class=\"token interpolated-string interpolation expression\">vnetSizeIPv4</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\">'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Define the subnet sizes for IPv4 and IPv6</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">var</span><span class=\"token plain\"> subnetSizeIPv4 </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token number\">24</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">var</span><span class=\"token plain\"> subnetSizeIPv6 </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token number\">64</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Generate the IPv4 subnets</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// This loop will create a number of subnets equal to 'subnetnumber'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Each subnet will have a unique name and address prefix</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">var</span><span class=\"token plain\"> subnetsIPv4 </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">for</span><span class=\"token plain\"> i </span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">in</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">range</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">,</span><span class=\"token plain\"> subnetnumber</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\">'subnetIPv4-</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">${</span><span class=\"token interpolated-string interpolation expression\">subnetSizeIPv4</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\">-</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">${</span><span class=\"token interpolated-string interpolation expression\">i</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\">'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">addressPrefix</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">cidrSubnet</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token plain\">vnetCidrIPv4</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">,</span><span class=\"token plain\"> subnetSizeIPv4</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">,</span><span class=\"token plain\"> i</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Create the virtual network with IPv4 subnets</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// This resource includes both IPv4 and IPv6 address spaces</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// But only the IPv4 subnets are created at this point</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">resource</span><span class=\"token plain\"> vnet </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Network/virtualNetworks@2023-04-01'</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'myVnet'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">location</span><span class=\"token operator\">:</span><span class=\"token plain\"> location</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">addressSpace</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Add the IPv4 and IPv6 CIDR blocks to the address prefixes</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token property\">addressPrefixes</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token plain\"> vnetCidrIPv4</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">,</span><span class=\"token plain\"> vnetCidrIPv6 </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">subnets</span><span class=\"token operator\">:</span><span class=\"token plain\"> subnetsIPv4</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Update the IPv4 subnets to add the IPv6 address prefixes</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Bicep does not currently support dual stack, so the subnets must be updated after the virtual network is created and the IPv6 address space is added. Bicep will attempt to create both the IPv4 and IPv6 subnets at the same time, leading to Retry and failed errors. Redeploy if required.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">resource</span><span class=\"token plain\"> subnetsIPv6 </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Network/virtualNetworks/subnets@2023-04-01'</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">for</span><span class=\"token plain\"> i </span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">in</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">range</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">,</span><span class=\"token plain\"> subnetnumber</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\">'subnetIPv4-</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">${</span><span class=\"token interpolated-string interpolation expression\">subnetSizeIPv4</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\">-</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">${</span><span class=\"token interpolated-string interpolation expression\">i</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\">'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">parent</span><span class=\"token operator\">:</span><span class=\"token plain\"> vnet</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">addressPrefixes</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token plain\"> subnetsIPv4</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token plain\">i</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">properties</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">addressPrefix</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">,</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">cidrSubnet</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token plain\">vnetCidrIPv6</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">,</span><span class=\"token plain\"> subnetSizeIPv6</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">,</span><span class=\"token plain\"> i</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>Reference: <a href=\"https://github.com/Azure/bicep/issues/1013\" target=\"_blank\" rel=\"noopener noreferrer\">Add \"wait\" and \"retry\" deployment options #1013</a></p>\n<p><img loading=\"lazy\" alt=\"IPv6/IPv4 Dual Stack Azure Network\" src=\"https://luke.geek.nz/assets/images/DualIPV46VNET-142a500c999d7c899696e6e3e6d2d67d.png\" width=\"1746\" height=\"497\" class=\"img_ev3q\"></p>\n<p><img loading=\"lazy\" alt=\"IPv6/IPv4 Dual Stack Azure Network\" src=\"https://luke.geek.nz/assets/images/DualIPV46VNETSubnet-5071924702a3391bf5a91fc9a822c753.png\" width=\"1698\" height=\"553\" class=\"img_ev3q\"></p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"configure-virtual-machine-with-a-private-ipv6-address\">Configure Virtual Machine with a private IPv6 address<a href=\"https://luke.geek.nz/azure/IPv6-on-Azure#configure-virtual-machine-with-a-private-ipv6-address\" class=\"hash-link\" aria-label=\"Direct link to Configure Virtual Machine with a private IPv6 address\" title=\"Direct link to Configure Virtual Machine with a private IPv6 address\">​</a></h2>\n<p>Now that we have IPv6 addresses in our Virtual Network, I have a Windows Server 2022 Azure Virtual Machine created in a dual-stacked subnet; we can add an IPv6 IP configuration by navigating to the NIC of the VM and adding ipconfiguration.</p>\n<p><img loading=\"lazy\" alt=\"Azure Virtual Machine IPv6 Config\" src=\"https://luke.geek.nz/assets/images/DualIPV46VM_IPconfiguration-4ebe936fe27d5110be63753a91a889ac.png\" width=\"1761\" height=\"789\" class=\"img_ev3q\">\n<img loading=\"lazy\" alt=\"ipconfig\" src=\"https://luke.geek.nz/assets/images/DualIPV46VM_IPConfig-e9d92e837dc4c992d6f2c502804ae38d.png\" width=\"770\" height=\"550\" class=\"img_ev3q\"></p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"configure-virtual-machine-with-a-public-ipv6-address\">Configure Virtual Machine with a public IPv6 address<a href=\"https://luke.geek.nz/azure/IPv6-on-Azure#configure-virtual-machine-with-a-public-ipv6-address\" class=\"hash-link\" aria-label=\"Direct link to Configure Virtual Machine with a public IPv6 address\" title=\"Direct link to Configure Virtual Machine with a public IPv6 address\">​</a></h2>\n<p>You can add a public IPv6 address to a virtual machine similar to the private IPv6 address, but first, we must create our public IP.</p>\n<ol>\n<li>Navigate to the <a href=\"https://portal.azure.com/#home\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Portal</a></li>\n<li>Navigate to <a href=\"https://portal.azure.com/#view/HubsExtension/BrowseResource/resourceType/Microsoft.Network%2FPublicIpAddresses\" target=\"_blank\" rel=\"noopener noreferrer\">Public IP addresses</a></li>\n<li>Click + Create</li>\n<li>Select your Subscription/Resource Group and Region</li>\n<li>Enter a name for your Public IP and select IP Version as: Ipv6</li>\n<li>Click Review + Create</li>\n<li>Click Create</li>\n<li>Once created, shutdown the Virtual Machine you want to attach the public IP to</li>\n<li>Navigate to Networking on the Virtual Machine blade</li>\n<li>Click Attach network interface, and select your Ipv6 Public IP</li>\n<li>Start your Virtual Machine and navigate to <a href=\"https://whatismyipaddress.com/\" target=\"_blank\" rel=\"noopener noreferrer\">https://whatismyipaddress.com/</a>; your ipv6 public IP address should now match your newly added address.</li>\n</ol>\n<p><img loading=\"lazy\" alt=\"What is my IP\" src=\"https://luke.geek.nz/assets/images/IPv6WhatisMyIP-19ed0e4cebfe5aee141850d927b3a770.png\" width=\"1505\" height=\"749\" class=\"img_ev3q\"></p>\n<p>You can test connectivity to your newly published IPv6 address now.</p>\n<p>Any issues, make sure you checkout <a href=\"https://test-ipv6.com/\" target=\"_blank\" rel=\"noopener noreferrer\">https://test-ipv6.com/</a> and <a href=\"http://www.ipv6scanner.com/cgi-bin/main.py\" target=\"_blank\" rel=\"noopener noreferrer\">http://www.ipv6scanner.com</a>, from your client.</p>",
            "url": "https://luke.geek.nz/azure/IPv6-on-Azure",
            "title": "IPv6 in Microsoft Azure",
            "summary": "Take a look at IPv6 support in Microsoft Azure.",
            "date_modified": "2023-11-09T00:00:00.000Z",
            "author": {
                "name": "Luke Murray",
                "url": "https://luke.geek.nz"
            },
            "tags": [
                "Azure"
            ]
        },
        {
            "id": "https://luke.geek.nz/azure/PrincpalNotFound-bicep-roleassignment",
            "content_html": "<p>Recently, I was deploying an <a href=\"https://learn.microsoft.com/entra/identity/managed-identities-azure-resources/how-manage-user-assigned-managed-identities?pivots=identity-mi-methods-azp&amp;WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">User Assigned Managed identity</a>, and assigning the managed identity a role assignment with Azure Bicep, and ran into an issue, where the assignment would fail, but then after a rerun would work.</p>\n<blockquote>\n<p>Principal e892476361114c90be141d9bf20cc94b does not exist in the directory 73160ae1-aa4a-48b5-a424-d5e43d808f53. Check that you have the correct principal ID. If you are creating this principal and then immediately assigning a role, this error might be related to a replication delay. In this case, set the role assignment principalType property to a value, such as ServicePrincipal, User, or Group. See <a href=\"https://learn.microsoft.com/azure/role-based-access-control/troubleshooting?tabs=bicep&amp;WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">https://aka.ms/docs-principaltype</a></p>\n</blockquote>\n<p><img loading=\"lazy\" alt=\"PrincpalNotFound\" src=\"https://luke.geek.nz/assets/images/PrincipalNotExistinDirectory-30dcbc091e1cb7613fc3c32980a0face.png\" width=\"1044\" height=\"622\" class=\"img_ev3q\"></p>\n<p>What was happening, was that the User Assigned Identity was created, and immediately after the role assignment was attempted, leaving no time for the role assignment API to be aware that the User Assigned Managed identity existed, even with a hard coded dependson!</p>\n<p>The fix was to Set the: <a href=\"https://learn.microsoft.com/en-us/azure/azure-resource-manager/bicep/scenarios-rbac?WT.mc_id=AZ-MVP-5004796#principal\" target=\"_blank\" rel=\"noopener noreferrer\">principalType</a> into the Bicep, as ServicePrincipal, making sure that the Azure platform can wait for the replication to complete, before trying the role assignment.</p>\n<blockquote>\n<p>The principalType property specifies whether the principal is a user, a group, or a service principal. Managed identities are a form of service principal.</p>\n</blockquote>\n<div class=\"language-bicep codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-bicep codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">resource</span><span class=\"token plain\"> uami </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.ManagedIdentity/userAssignedIdentities@2023-01-31'</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> azUserAssignedManagedIdentity</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">location</span><span class=\"token operator\">:</span><span class=\"token plain\"> location</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">resource</span><span class=\"token plain\"> uamiassignment </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Authorization/roleAssignments@2022-04-01'</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">guid</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">resourceGroup</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">id</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'contributor'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">principalId</span><span class=\"token operator\">:</span><span class=\"token plain\"> uami</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">properties</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">principalId</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">principalType</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'ServicePrincipal'</span><span class=\"token plain\"> </span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">roleDefinitionId</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">resourceId</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Authorization/roleDefinitions'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'b24988ac-6180-42a0-ab88-20f7382dd24c'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Contributor</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">scope</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">resourceGroup</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>",
            "url": "https://luke.geek.nz/azure/PrincpalNotFound-bicep-roleassignment",
            "title": "Azure Bicep - Principal does not exist in directory",
            "summary": "PrincpalNotFound when doing Role Assignment of a User Assigned Managed identity",
            "date_modified": "2023-10-31T00:00:00.000Z",
            "author": {
                "name": "Luke Murray",
                "url": "https://luke.geek.nz"
            },
            "tags": [
                "Azure"
            ]
        },
        {
            "id": "https://luke.geek.nz/azure/powershell/azure-management-powershell",
            "content_html": "<blockquote>\n<p>To see a video of these commands in action, take a look at the following YouTube-hosted video: <a href=\"https://youtu.be/a4gehHwlwBQ\" target=\"_blank\" rel=\"noopener noreferrer\">Microsoft Azure Management with PowerShell - Introduction</a></p>\n</blockquote>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"powershell\">PowerShell<a href=\"https://luke.geek.nz/azure/powershell/azure-management-powershell#powershell\" class=\"hash-link\" aria-label=\"Direct link to PowerShell\" title=\"Direct link to PowerShell\">​</a></h2>\n<p>PowerShell is a powerful scripting and automation framework developed by Microsoft. It is designed for task automation and configuration management and is particularly useful for managing and automating Microsoft Windows environments. PowerShell uses a command-line interface with a scriptable approach, and it's built on the .NET Framework.</p>\n<ul>\n<li><a href=\"https://learn.microsoft.com/powershell/scripting/overview?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">What is PowerShell?</a></li>\n</ul>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"powershell-and-microsoft-azure\">PowerShell and Microsoft Azure<a href=\"https://luke.geek.nz/azure/powershell/azure-management-powershell#powershell-and-microsoft-azure\" class=\"hash-link\" aria-label=\"Direct link to PowerShell and Microsoft Azure\" title=\"Direct link to PowerShell and Microsoft Azure\">​</a></h2>\n<p>When it comes to Microsoft Azure, PowerShell provides a robust set of cmdlets (pronounced \"command-lets\") that enable you to interact with and manage Azure resources, making it a valuable tool for working with Azure services.</p>\n<p>When you run a PowerShell cmdlet to, for example, create a virtual machine or retrieve information about an Azure resource, the cmdlet translates your request into an HTTP request to the relevant Azure REST API endpoint.</p>\n<ul>\n<li><a href=\"https://learn.microsoft.com/powershell/azure/?view=azps-10.4.1&amp;WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure PowerShell Documentation</a></li>\n</ul>\n<blockquote>\n<p>There is an assumption, that you have access to an Azure environment, and the ability to create resources, within that environment.</p>\n</blockquote>\n<p><img loading=\"lazy\" alt=\"Microsoft Azure Management with PowerShell\" src=\"https://luke.geek.nz/assets/images/BlogHeading-BlogHeading-Microsoft-Azure-Management-with-PowerShell-788b8586e4737f49ce3303670020bee9.gif\" width=\"1198\" height=\"628\" class=\"img_ev3q\"></p>\n<p>First up, let's verify the version of PowerShell we have, open a Powershell terminal and run:</p>\n<div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$PSVersionTable</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>A supported version of PowerShell version 7 or higher is the recommended version of PowerShell for use with the Az PowerShell module on all platforms including Windows, Linux, and macOS.</p>\n<p>The Az PowerShell module is preinstalled in <a href=\"https://learn.microsoft.com/azure/cloud-shell/overview?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Cloud Shell</a> and in <a href=\"https://learn.microsoft.com/powershell/azure/azureps-in-docker?view=azps-10.4.1&amp;tabs=amd64&amp;WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Docker</a> images.</p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"setting-up-your-azure-environment-for-powershell\">Setting up your Azure environment for PowerShell<a href=\"https://luke.geek.nz/azure/powershell/azure-management-powershell#setting-up-your-azure-environment-for-powershell\" class=\"hash-link\" aria-label=\"Direct link to Setting up your Azure environment for PowerShell\" title=\"Direct link to Setting up your Azure environment for PowerShell\">​</a></h3>\n<p>First thigs first, lets installed the Azure (<a href=\"https://learn.microsoft.com/powershell/azure/new-azureps-module-az?view=azps-10.4.1&amp;WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Az PowerShell module</a>)modules.</p>\n<div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Install Azure Modules</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># The Set-PSRepository cmdlet is used to set values for a registered repository. </span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># The Install-Module cmdlet is used to download one or more modules from an online gallery and installs them on the local computer. In this case, the command is installing the Az module, which provides cmdlets for managing Azure resources.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Set-PSRepository</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">Name </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'PSGallery'</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">InstallationPolicy Trusted</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Install-Module</span><span class=\"token plain\"> Az </span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>If you don't have local administrator rights, you can install it into your user profile like below:</p>\n<div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Install Azure Module as Current User (as opposed to System)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># '-Scope CurrentUser` specifies that the module should be installed only for the current user. If you don't specify a scope, the default is `AllUsers`, which requires administrator permissions.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Install-Module</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">Name Az </span><span class=\"token operator\">-</span><span class=\"token plain\">Repository PSGallery </span><span class=\"token operator\">-</span><span class=\"token plain\">Scope CurrentUser</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>You can install a specific version of the Az module by specifying RequiredVersion, like below:</p>\n<div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Install specific version of Azure Modules</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Install-Module</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">Name Az </span><span class=\"token operator\">-</span><span class=\"token plain\">RequiredVersion 7</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">1</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">0</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>You will find that the Azure powershell cmdlets will constantly get updated, to resolve bugs, offer new functionality, to update the modules to the ltest you can use:</p>\n<div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Update Azure Module</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># The command Get-InstalledModule -Name Az* | Update-Module is used to update all installed PowerShell modules that start with \"Az\".</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Set-PSRepository</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">Name </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'PSGallery'</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">InstallationPolicy Trusted</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Get-InstalledModule</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">Name Az* </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">|</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Update-Module</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>Az is a collection of different cmdlets, across multiple Azure resource types, to view a list of avaliable commands you use 'Get-Command', like below:</p>\n<div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Gets Az Commands</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Note: Will take a while for all the cmdlets to list.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Get-Command</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">Noun Az*</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"getting-started-with-azure-powershell-module\">Getting started with Azure PowerShell module<a href=\"https://luke.geek.nz/azure/powershell/azure-management-powershell#getting-started-with-azure-powershell-module\" class=\"hash-link\" aria-label=\"Direct link to Getting started with Azure PowerShell module\" title=\"Direct link to Getting started with Azure PowerShell module\">​</a></h3>\n<p>Lets connect to Microsoft Azure</p>\n<div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Connect to Azure - Interactive will prompt for credentials</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Connect-AzAccount</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>If your wanting to connect to Azure, from a device that doesn't supoport the credential prompt, like Azure Cloudshell you can connect using another device, using a device code:</p>\n<div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Connect to Azure</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Connect-AzAccount</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">UseDeviceAuthentication</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>If you have a Service principal, you can use this to authenticate, commonly used for automation scripts, Azure DevOps agents and GitHub runners.</p>\n<div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Connect to Azure using Service Principal authentication</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$SecurePassword</span><span class=\"token plain\"> = </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">ConvertTo-SecureString</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">String </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"Password123!\"</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">AsPlainText </span><span class=\"token operator\">-</span><span class=\"token plain\">Force</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$TenantId</span><span class=\"token plain\"> = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'yyyyyyyy-yyyy-yyyy-yyyy-yyyyyyy'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$ApplicationId</span><span class=\"token plain\"> = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'zzzzzzzz-zzzz-zzzz-zzzz-zzzzzzzz'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$Credential</span><span class=\"token plain\"> = </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">New-Object</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">TypeName System</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">Management</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">Automation</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">PSCredential </span><span class=\"token operator\">-</span><span class=\"token plain\">ArgumentList </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$ApplicationId</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">,</span><span class=\"token plain\"> </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$SecurePassword</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Connect-AzAccount</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">ServicePrincipal </span><span class=\"token operator\">-</span><span class=\"token plain\">TenantId </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$TenantId</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">Credential </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$Credential</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>Once, connected - its time to check what Azure subscriptions you can use.</p>\n<div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Get Azure Subscriptions</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Get-AzSubscription</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>Once you have selected the right Azure subscription to connect to, you can set your Subscription context (modify/delete resources). Add your subscription ID, from the earlier step in between ''.</p>\n<div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Select Azure Subscription</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$subid</span><span class=\"token plain\"> = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">''</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Set-AzContext</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">SubscriptionId </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$subid</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>Now you have connected to your, Azure subscription, it is time to get your Azure resources and Resource Groups</p>\n<div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Get Azure resource groups and resources</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Get-AzResourceGroup</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">|</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Format-Table</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Get-AzResource</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">|</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Format-Table</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Get Azure resource</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Get-AzResource</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Get Azure resource by ResourceType</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Get-AzResource</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">|</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Where-Object</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$_</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">ResourceType </span><span class=\"token operator\">-eq</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Network/virtualNetworks'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"> </span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Sort Azure resource by Name and Resource Group</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Get-AzResource</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">|</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Where-Object</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$_</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">ResourceType </span><span class=\"token operator\">-eq</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Storage/storageAccounts'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">|</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Sort-Object</span><span class=\"token plain\"> Name</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Get-AzResource</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">|</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Sort-Object</span><span class=\"token plain\"> ResourceGroupName </span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Working with Variables</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Working with variables and data types in PowerShell</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$resourceType</span><span class=\"token plain\"> = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Network/virtualNetworks'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Get-AzResource</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">|</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Where-Object</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$_</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">ResourceType </span><span class=\"token operator\">-eq</span><span class=\"token plain\"> </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$resourceType</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Using PowerShell operators for comparisons and calculations</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$resources</span><span class=\"token plain\"> = </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Get-AzResource</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$count</span><span class=\"token plain\"> = </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$resources</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">Count</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Write-Host</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"You have </span><span class=\"token string variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$count</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\"> resources in your Azure subscription.\"</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Scripting constructs: loops and conditional statements</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$resources</span><span class=\"token plain\"> = </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Get-AzResource</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">foreach</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$resource</span><span class=\"token plain\"> in </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$resources</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">if</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$resource</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">ResourceType </span><span class=\"token operator\">-eq</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Network/virtualNetworks'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Write-Host</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"Found a virtual network: </span><span class=\"token string function\" style=\"color:rgb(80, 250, 123)\">$</span><span class=\"token string function punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token string function variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$resource</span><span class=\"token string function punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token string function\" style=\"color:rgb(80, 250, 123)\">Name</span><span class=\"token string function punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Write-Host</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"This virtual network is in </span><span class=\"token string function\" style=\"color:rgb(80, 250, 123)\">$</span><span class=\"token string function punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token string function variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$resource</span><span class=\"token string function punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token string function\" style=\"color:rgb(80, 250, 123)\">ResourceGroupName</span><span class=\"token string function punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">ForegroundColor Green</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Scripting constructs: loops and conditional statements</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$subscriptions</span><span class=\"token plain\"> = </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Get-AzSubscription</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">foreach</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$subscription</span><span class=\"token plain\"> in </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$subscriptions</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$resource</span><span class=\"token plain\"> = </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Get-AzResource</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">|</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Where-Object</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$_</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">ResourceType </span><span class=\"token operator\">-eq</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Network/virtualNetworks'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"> </span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">if</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$resource</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">ResourceType </span><span class=\"token operator\">-eq</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Network/virtualNetworks'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Write-Host</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"Found a virtual network: </span><span class=\"token string function\" style=\"color:rgb(80, 250, 123)\">$</span><span class=\"token string function punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token string function variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$resource</span><span class=\"token string function punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token string function\" style=\"color:rgb(80, 250, 123)\">Name</span><span class=\"token string function punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">BackgroundColor Black </span><span class=\"token operator\">-</span><span class=\"token plain\">ForegroundColor White</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Write-Host</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"This virtual network is in </span><span class=\"token string function\" style=\"color:rgb(80, 250, 123)\">$</span><span class=\"token string function punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token string function variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$resource</span><span class=\"token string function punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token string function\" style=\"color:rgb(80, 250, 123)\">ResourceGroupName</span><span class=\"token string function punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">ForegroundColor Green</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Write-Host</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"This Virtual Network is in </span><span class=\"token string function\" style=\"color:rgb(80, 250, 123)\">$</span><span class=\"token string function punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token string function variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$subscription</span><span class=\"token string function punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token string function\" style=\"color:rgb(80, 250, 123)\">Name</span><span class=\"token string function punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">ForegroundColor Green</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Error handling in PowerShell</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">try</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Get-AzResource</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">ResourceGroupName </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"NonexistentResourceGroup\"</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">ErrorAction Stop</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">catch</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Write-Host</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"An error occurred: </span><span class=\"token string variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$_</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">. Make sure you have selected the right Resource Group\"</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">ForegroundColor Red</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"resource-creation\">Resource Creation<a href=\"https://luke.geek.nz/azure/powershell/azure-management-powershell#resource-creation\" class=\"hash-link\" aria-label=\"Direct link to Resource Creation\" title=\"Direct link to Resource Creation\">​</a></h3>\n<div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Import Module</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Import-Module</span><span class=\"token plain\"> Az </span><span class=\"token operator\">-</span><span class=\"token plain\">Verbose</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">#Create Azure Resource Group</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">New-AzResourceGroup</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">Name </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"MyResourceGroup\"</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">Location </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"West US\"</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Get Regions</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Get-AzLocation</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">|</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Select-Object</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">First 1</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Get-AzLocation</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">|</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Select-Object</span><span class=\"token plain\"> DisplayName</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">,</span><span class=\"token plain\"> Location</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">,</span><span class=\"token plain\"> PhysicalLocation</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">,</span><span class=\"token plain\"> GeographyGroup </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">|</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Format-Table</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">ate Azure Resource </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Group</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$region</span><span class=\"token plain\"> = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'AustraliaEast'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">New-AzResourceGroup</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">Name </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"MyResourceGroup</span><span class=\"token string variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$region</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">Location </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$region</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Create a storage account</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$uniqueId</span><span class=\"token plain\"> = </span><span class=\"token namespace\">[guid]</span><span class=\"token plain\">::NewGuid</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">ToString</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">Substring</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token plain\">0</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">,</span><span class=\"token plain\">4</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$region</span><span class=\"token plain\"> = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'AustraliaEast'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$ResourceGroupName</span><span class=\"token plain\"> = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"MyResourceGroup</span><span class=\"token string variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$region</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">New-AzStorageAccount</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">ResourceGroupName </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$ResourceGroupName</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">Name </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"mystgacc</span><span class=\"token string variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$uniqueId</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">Location </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$region</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">SkuName Standard_LRS </span><span class=\"token operator\">-</span><span class=\"token plain\">AllowBlobPublicAccess </span><span class=\"token boolean\">$false</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">verbose</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">#Remove Azure Storage account</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$region</span><span class=\"token plain\"> = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'AustraliaEast'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$ResourceGroupName</span><span class=\"token plain\"> = </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$ResourceGroupName</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Remove-AzStorageAccount</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">ResourceGroupName </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$ResourceGroupName</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">Name </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"mystgacc</span><span class=\"token string variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$uniqueId</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">Force </span><span class=\"token operator\">-</span><span class=\"token plain\">verbose</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Get-AzStorageAccount</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">ResourceGroupName </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$ResourceGroupName</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">Name </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"mystgacc</span><span class=\"token string variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$uniqueId</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">verbose</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Create an Azure Virtual Network</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$region</span><span class=\"token plain\"> = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'AustraliaEast'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$ResourceGroupName</span><span class=\"token plain\"> = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'network-prod-rg'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$VNetname</span><span class=\"token plain\"> = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'vnet-prod'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$subnetname</span><span class=\"token plain\"> = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'infraservers'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$subnetAddressPrefix</span><span class=\"token plain\"> = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'10.0.0.0/24'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Create a resource group</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$ResourceGroup</span><span class=\"token plain\"> = </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Get-AzResourceGroup</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">Name </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$ResourceGroupName</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">ErrorAction SilentlyContinue</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">if</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$null</span><span class=\"token plain\"> </span><span class=\"token operator\">-eq</span><span class=\"token plain\"> </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$ResourceGroup</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Write-Host</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"Creating Resource Group </span><span class=\"token string variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$ResourceGroupName</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\"> in </span><span class=\"token string variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$region</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">ForegroundColor Yellow</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$ResourceGroup</span><span class=\"token plain\"> = </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">New-AzResourceGroup</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">Name </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$ResourceGroupName</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">Location </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$region</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">Force</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">else</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Write-Host</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"Resource Group </span><span class=\"token string variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$ResourceGroupName</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\"> already exists in </span><span class=\"token string variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$region</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">ForegroundColor Green</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Create a virtual network</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$AzVNET</span><span class=\"token plain\"> = </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">New-AzVirtualNetwork</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">ResourceGroupName </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$ResourceGroupName</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">Name </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$VNetname</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">AddressPrefix </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'10.0.0.0/16'</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">Location </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$region</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Create a subnet</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$subnetConfig</span><span class=\"token plain\"> = </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Add-AzVirtualNetworkSubnetConfig</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">Name </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$subnetname</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">AddressPrefix </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$subnetAddressPrefix</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">VirtualNetwork </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$AzVNET</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Get full object output</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Alias (This is a pipeline to the Format-List cmdlet (fl is an alias for Format-List). It formats the output as a list of properties for each object. This can make it easier to read the details of the virtual network.)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Get-AzVirtualNetwork</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">ResourceGroupName </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$ResourceGroupName</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">Name </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$VNetname</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># | fl</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Alias</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Get-Alias</span><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">|</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Select-Object</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">First 2</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">#splat</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$configData</span><span class=\"token plain\"> = @</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    ResourceGroupName = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"MyResourceGroup\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    Location = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"West US\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    StorageAccountName = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"stgacctest100\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">try</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">New-AzStorageAccount</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">ResourceGroupName </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$configData</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">ResourceGroupName </span><span class=\"token operator\">-</span><span class=\"token plain\">Name </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$configData</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">StorageAccountName </span><span class=\"token operator\">-</span><span class=\"token plain\">Location </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$configData</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">Location </span><span class=\"token operator\">-</span><span class=\"token plain\">SkuName Standard_LRS</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">catch</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Write-Error</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"Failed to create storage account: </span><span class=\"token string variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$_</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">#splat as parameters</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$configData</span><span class=\"token plain\"> = @</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"ResourceGroupName\"</span><span class=\"token plain\"> = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"MyResourceGroup\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"Location\"</span><span class=\"token plain\"> = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"West US\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"StorageAccountName\"</span><span class=\"token plain\"> = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"stgacctest100\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"SkuName\"</span><span class=\"token plain\"> = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"Standard_LRS\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">try</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">New-AzStorageAccount</span><span class=\"token plain\"> @configData</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">catch</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Write-Error</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"Failed to create storage account: </span><span class=\"token string variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$_</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Tags</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$ResourceGroupName</span><span class=\"token plain\"> = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'TagTestRG'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">New-AzResourceGroup</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">Name </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$ResourceGroupName</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">Location </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'AustraliaEast'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Set-AzResourceGroup</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">Name </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$ResourceGroupName</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">Tag @</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"> Department = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"Finance\"</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">;</span><span class=\"token plain\"> Project = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"Q1\"</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\"># Get Tag Resource Group</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$ResourceGroupName</span><span class=\"token plain\"> = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'TagTestRG'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Get-AzResourceGroup</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">Name </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$ResourceGroupName</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">Tags</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$ResourceGroupName</span><span class=\"token plain\"> = </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'TagTestRG'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$tags</span><span class=\"token plain\"> = </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Get-AzResourceGroup</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">Name </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$ResourceGroupName</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">Tags</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$tags</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">Remove</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">\"Project\"</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">Set-AzResourceGroup</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">Name </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$ResourceGroupName</span><span class=\"token plain\"> </span><span class=\"token operator\">-</span><span class=\"token plain\">Tag </span><span class=\"token variable\" style=\"color:rgb(189, 147, 249);font-style:italic\">$tags</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>",
            "url": "https://luke.geek.nz/azure/powershell/azure-management-powershell",
            "title": "Microsoft Azure Management with PowerShell - Introduction",
            "summary": "Delve into the common ways to work with Microsoft Azure, using PowerShell.",
            "date_modified": "2023-10-30T00:00:00.000Z",
            "author": {
                "name": "Luke Murray",
                "url": "https://luke.geek.nz"
            },
            "tags": [
                "Azure",
                "PowerShell"
            ]
        },
        {
            "id": "https://luke.geek.nz/azure/Monitor-Azure-LandingZones-with-AMBA",
            "content_html": "<blockquote>\n<p>When deploying Azure resources, it is crucial to configure alerts to ensure your resources' health, performance, and security.</p>\n</blockquote>\n<p>By setting up alerts, you can proactively monitor your resources and take timely actions to address any issues that may arise.</p>\n<p>Here are the key reasons why configuring alerts is essential:</p>\n<ul>\n<li>Early detection of issues: Alerts enable you to identify potential problems or anomalies in your Azure resources at an early stage. By monitoring key metrics and logs, you can detect high CPU usage, low memory, network connectivity problems, or security breaches. This allows you to take immediate action and prevent any negative impact on your applications or services.</li>\n<li>Reduced downtime: By configuring alerts, you can minimise downtime by being notified of critical events or failures in real time. This allows you to quickly investigate and resolve issues before they escalate, ensuring the availability and reliability of your applications.</li>\n<li>Optimized resource utilisation: Alerts help you optimise resource utilization by providing insights into resource usage patterns and trends. By monitoring metrics such as CPU utilisation, memory consumption, or storage capacity, you can identify opportunities for optimisation and cost savings.</li>\n<li>Compliance and security: Configuring alerts is essential for maintaining compliance with regulatory requirements and ensuring the security of your Azure resources. By monitoring security logs and detecting suspicious activities or unauthorised access attempts, you can immediately mitigate potential risks and protect your data.</li>\n<li>Proactive capacity planning: Alerts provide valuable information for capacity planning and scaling your resources. By monitoring resource utilisation trends over time, you can identify patterns and forecast future resource requirements. This helps you avoid performance bottlenecks and ensure a smooth user experience.\"</li>\n</ul>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"overview\">Overview<a href=\"https://luke.geek.nz/azure/Monitor-Azure-LandingZones-with-AMBA#overview\" class=\"hash-link\" aria-label=\"Direct link to Overview\" title=\"Direct link to Overview\">​</a></h2>\n<p><a href=\"https://azure.github.io/azure-monitor-baseline-alerts/welcome/\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Monitor Baseline Alerts (AMBA)</a> exists to help you get started with proactive and reactive monitoring straight out of the bat, focused on standard scenarios for your platform and application Landing Zone that are not industry or application-specific.</p>\n<p>Previously under the azure/alz-monitor repository, it is now generally available under the <a href=\"https://github.com/Azure/azure-monitor-baseline-alerts\" target=\"_blank\" rel=\"noopener noreferrer\">Azure/azure-monitor-baseline-alerts</a> GitHub repository.</p>\n<p>The objectives of AMBA are to:</p>\n<ul>\n<li>Help simplify onboarding to Azure Monitor through a scalable and consistent approach.</li>\n<li>Reduce time to identify failure within Azure tenants and platforms (i.e., outages).</li>\n</ul>\n<p>More documentation can be found on the official Microsoft Learn documentation page: <a href=\"https://learn.microsoft.com/azure/cloud-adoption-framework/ready/landing-zone/design-area/management-monitor?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Monitor Azure platform landing zone components</a>.</p>\n<p><img loading=\"lazy\" alt=\"Monitor your Azure Landing Zone with Azure Monitor Baseline Alerts\" src=\"https://luke.geek.nz/assets/images/BlogHeading_AMBA-4541fb6c736b8f04e653ed4bfa7018fb.gif\" width=\"1200\" height=\"628\" class=\"img_ev3q\"></p>\n<blockquote>\n<p>\"AMBA Provides best practice guidance around creating and configuring Azure Monitor Alerts for Azure services and workload pattern/scenarios).\"</p>\n</blockquote>\n<p>One of the ways that makes Azure Monitor Baseline Alerts (AMBA) so useful is the details around the Alerts.</p>\n<p>Reference: <a href=\"https://azure.github.io/azure-monitor-baseline-alerts/patterns/alz/Alerts-Details/\" target=\"_blank\" rel=\"noopener noreferrer\">Alerts Details</a></p>\n<p>Out-of-the-box alerts that are part of the base AMBA solution include (but are not limited to) alerts such as:</p>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<table><thead><tr><th><strong>Resource Type</strong></th><th><strong>Name</strong></th><th><strong>Description</strong></th><th><strong>metricName</strong></th></tr></thead><tbody><tr><td>automationAccounts</td><td>TotalJob</td><td>The total number of jobs</td><td>TotalJob</td></tr><tr><td>storageAccounts</td><td>Availability</td><td>The percentage of availability for the storage service or the specified API operation. Availability is calculated by taking the TotalBillableRequests value and dividing it by the number of applicable requests, including those that produced unexpected errors. All unexpected errors result in reduced availability for the storage service or the specified API operation.</td><td>Availability</td></tr><tr><td>virtualMachines</td><td>Available Memory Bytes (MBytes)</td><td>Amount of physical memory, in bytes, immediately available for allocation to a process or for system use in the Virtual Machine</td><td>Available Memory Bytes</td></tr><tr><td>virtualMachineScaleSets</td><td>Percentage CPU</td><td>The percentage of allocated compute units that are currently in use by the Virtual Machine(s)</td><td>Percentage CPU</td></tr><tr><td>virtualMachineScaleSets</td><td>OS Disk IOPS Consumed Percentage</td><td>Percentage of operating system disk I/Os consumed per minute</td><td>OS Disk IOPS Consumed Percentage</td></tr><tr><td>virtualMachineScaleSets</td><td>Data Disk IOPS Consumed Percentage</td><td>Percentage of data disk I/Os consumed per minute</td><td>Data Disk IOPS Consumed Percentage</td></tr><tr><td>virtualMachineScaleSets</td><td>Outbound Flows</td><td>Outbound Flows are number of current flows in the outbound direction (traffic going out of the VM)</td><td>Outbound Flows</td></tr><tr><td>virtualMachineScaleSets</td><td>Inbound Flows</td><td>Inbound Flows are number of current flows in the inbound direction (traffic going into the VM)</td><td>Inbound Flows</td></tr><tr><td>virtualMachineScaleSets</td><td>Available Memory Bytes</td><td>Amount of physical memory, in bytes, immediately available for allocation to a process or for system use in the Virtual Machine</td><td>Available Memory Bytes</td></tr><tr><td>virtualMachineScaleSets</td><td>Network In Total</td><td>The number of bytes received on all network interfaces by the Virtual Machine(s) (Incoming Traffic)</td><td>Network In Total</td></tr><tr><td>virtualMachineScaleSets</td><td>Network Out Total</td><td>The number of bytes out on all network interfaces by the Virtual Machine(s) (Outgoing Traffic)</td><td>Network Out Total</td></tr><tr><td>virtualMachineScaleSets</td><td>VmAvailabilityMetric</td><td>Measure of Availability of Virtual machines over time.</td><td>VmAvailabilityMetric</td></tr><tr><td>virtualMachineScaleSets</td><td>Disk Read Operations/Sec</td><td>Disk Read IOPS</td><td>Disk Read Operations/Sec</td></tr><tr><td>virtualMachineScaleSets</td><td>Disk Write Operations/Sec</td><td>Disk Write IOPS</td><td>Disk Write Operations/Sec</td></tr><tr><td>virtualNetworks</td><td>If Under DDoS Attack</td><td>Metric Alert for VNet DDOS Attack</td><td>ifunderddosattack</td></tr><tr><td>publicIPAddresses</td><td>Bytes In DDoS</td><td>Metric Alert for Public IP Address Bytes IN DDOS</td><td>bytesinddos</td></tr><tr><td>publicIPAddresses</td><td>If Under DDoS Attack</td><td>Metric Alert for Public IP Address Under Attack</td><td>ifunderddosattack</td></tr><tr><td>publicIPAddresses</td><td>Packets In DDoS</td><td>Inbound packets DDoS</td><td>PacketsInDDoS</td></tr><tr><td>publicIPAddresses</td><td>VIP Availability</td><td>Average IP Address availability per time duration</td><td>VipAvailability</td></tr><tr><td>expressRouteCircuits</td><td>ARP Availability</td><td>ARP Availability from MSEE towards all peers.</td><td>ArpAvailability</td></tr><tr><td>expressRouteCircuits</td><td>BGP Availability</td><td>BGP Availability from MSEE towards all peers.</td><td>BgpAvailability</td></tr></tbody></table>\n<p>For:</p>\n<ul>\n<li>Metric Alerts</li>\n<li>Log Alerts</li>\n<li>Activity Logs</li>\n<li>Service health alerts</li>\n</ul>\n<p><img loading=\"lazy\" alt=\"Graph 1\" src=\"https://luke.geek.nz/assets/images/AMBA_Graph1-f30bccd2d6df4eab870db69e9e353897.png\" width=\"601\" height=\"402\" class=\"img_ev3q\"></p>\n<p><img loading=\"lazy\" alt=\"Graph 2\" src=\"https://luke.geek.nz/assets/images/AMBA_Graph1-f30bccd2d6df4eab870db69e9e353897.png\" width=\"601\" height=\"402\" class=\"img_ev3q\"></p>\n<p><img loading=\"lazy\" alt=\"Monitoring Management Resource Group\" src=\"https://luke.geek.nz/assets/images/AMBA_MangementRG-903b2179cc0ace1ffb95df070e136ec1.png\" width=\"903\" height=\"567\" class=\"img_ev3q\"></p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"deployment\">Deployment<a href=\"https://luke.geek.nz/azure/Monitor-Azure-LandingZones-with-AMBA#deployment\" class=\"hash-link\" aria-label=\"Direct link to Deployment\" title=\"Direct link to Deployment\">​</a></h2>\n<p>The Azure Monitor Baseline Alerts are deployed using Azure Policy <em>(DINE – Deploy If Not Exist)</em> and are included in the <a href=\"https://github.com/Azure/Enterprise-Scale\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Enterprise-Scale landing zone accelerator</a>.</p>\n<p>Deployment is currently done via an Azure Resource Manager (ARM) template and can be deployed with the following:</p>\n<ul>\n<li>PowerShell</li>\n<li>Azure CLI</li>\n<li>GitHub Actions\nDevOps</li>\n</ul>\n<p>Because the Azure Monitor Baseline alerts are intended to follow the Azure Landing Zone framework, in accordance with the Ready phase of the Cloud Adoption Framework, the deployment can be scaled across multiple Management groups, such as:</p>\n<ul>\n<li>Connectivity</li>\n<li>Identity</li>\n<li>Management</li>\n<li>Service Health</li>\n<li>Landing Zone (i.e., Application)</li>\n</ul>\n<p>Or a single management group/subscription consisting of all features, with Alert processing rules sending relevant subscription alerts to an Action group that will notify by email if an alert is raised.</p>\n<p>For my own Azure environment, I only have 2 Subscriptions that sit under the following Management Group hierarchy:</p>\n<p><img loading=\"lazy\" alt=\"Management Group structure\" src=\"https://luke.geek.nz/assets/images/AMBA_LukeGeekNZMG-e1e01c737a3d7e5424f03b226e4325b6.png\" width=\"503\" height=\"346\" class=\"img_ev3q\"></p>\n<p>We will deploy these initiatives to the MG Management Group, which allows us to then Assign those initiatives to anything beneath it, in our case, the mg-landingzones and trey-platform management groups.</p>\n<p>As part of the deployment, we will adjust the following parameters to match our environment:</p>\n<ul>\n<li>Management groups</li>\n<li>Assignment of PolicySetDefinitions</li>\n<li>Resource Group Name and Tags</li>\n<li>Location</li>\n<li>Action group emails</li>\n</ul>\n<p>We can adjust the alert rule parameters, such as the severity, and change their effect, whether they automitigate or adjust the MonitorDisable tag, which can be used to exclude from alert monitoring; we will leave these to the default.</p>\n<p>Make sure you review and test these policies first! Before proceeding to Production.</p>\n<p>We will deploy the ARM template using the <a href=\"https://learn.microsoft.com/azure/cloud-shell/overview?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Cloud Shell</a>.</p>\n<ol>\n<li>\n<p>Login to the Azure Portal</p>\n</li>\n<li>\n<p>Click on Cloud Shell <em>(top right)</em></p>\n</li>\n<li>\n<p>Select your subscription and create a Storage account to host your Cloud Shell drives <em>(if it hasn't already been done)</em></p>\n</li>\n<li>\n<p>I'm going to adjust the parameters to match my environment by changing the following (these will need to be tuned to your specific environment):.</p>\n</li>\n<li>\n<p>Type in:</p>\n<p>git clone <a href=\"https://github.com/Azure/azure-monitor-baseline-alerts\" target=\"_blank\" rel=\"noopener noreferrer\">https://github.com/Azure/azure-monitor-baseline-alerts</a></p>\n</li>\n</ol>\n<p>Type in:</p>\n<div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">cd azure-monitor-baseline-alerts\\patterns\\alz\\</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>Type in:</p>\n<div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">nano alzArm.param.json</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>I'm going to adjust the parameters to match my environment by changing the following <em>(these will need to be tuned to your specific environment)</em>:</p>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<table><thead><tr><th>Parameters</th><th>Values</th></tr></thead><tbody><tr><td>enterpriseScaleCompanyPrefix</td><td>lukegeeknz</td></tr><tr><td>platformManagementGroup</td><td>trey-platform</td></tr><tr><td>IdentityManagementGroup</td><td>mg-landingzones</td></tr><tr><td>managementManagementGroup</td><td>trey-platform</td></tr><tr><td>connectivityManagementGroup</td><td>trey-platform</td></tr><tr><td>LandingZoneManagementGroup</td><td>mg-landingzones</td></tr><tr><td>ALZMonitorResourceGroupName</td><td>rg-management-monitoring-001</td></tr><tr><td>ALZMonitorResourceGroupLocation</td><td>australiaeast</td></tr><tr><td>ALZMonitorActionGroupEmail</td><td><a href=\"mailto:email@luke.geek.nz\" target=\"_blank\" rel=\"noopener noreferrer\">email@luke.geek.nz</a></td></tr></tbody></table>\n<blockquote>\n<p>If you want the alerts to go to more than one email address, add them as comma-separated (i.e. \"<a href=\"mailto:email1@contos.com\" target=\"_blank\" rel=\"noopener noreferrer\">email1@contos.com</a>, <a href=\"mailto:email2@contoso.com\" target=\"_blank\" rel=\"noopener noreferrer\">email2@contoso.com</a>, <a href=\"mailto:email3@contoso.com\" target=\"_blank\" rel=\"noopener noreferrer\">email3@contoso.com</a>\")</p>\n</blockquote>\n<ol start=\"8\">\n<li>\n<p>Press Ctrl+X</p>\n</li>\n<li>\n<p>Press Y to save buffer</p>\n</li>\n<li>\n<p>Press Enter to overwrite the parameter json file.</p>\n</li>\n<li>\n<p>Before proceeding to the next step, you can cat the file <em>(cat ./alzArm.param.json)</em> to view it and make sure the parameters are correct and nothing else needs changing.</p>\n</li>\n<li>\n<p>Now that the parameters are sorted, it is time to deploy:</p>\n<p>$location = 'AustraliaEast'\n$psedudoRootManagementGroup = \"mg\"\nNew-AzManagementGroupDeployment -ManagementGroupId $psedudoRootManagementGroup -Location $location -TemplateUri  '<a href=\"https://raw.githubusercontent.com/Azure/azure-monitor-baseline/alerts/main/patterns/alz/alzArm.json\" target=\"_blank\" rel=\"noopener noreferrer\">https://raw.githubusercontent.com/Azure/azure-monitor-baseline/alerts/main/patterns/alz/alzArm.json</a>' -TemplateParameterFile  'alzArm.param.json'</p>\n</li>\n</ol>\n<blockquote>\n<p>The ARM template location needs to be internet accessible due to links in the ARM template to dependent resources, although the parameter file can be sourced locally.\nError: Code=InvalidTemplate; Message=Deployment template validation failed: 'The template variable 'deploymentUris' is not valid: The language expression property 'templateLink' doesn't exist, available properties are 'template, templateHash, parameters, mode, provisioningState'.. Please see <a href=\"https://learn.microsoft.com/azure/azure-resource-manager/templates/template-functions?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">https://aka.ms/arm-functions</a> for usage details.'</p>\n</blockquote>\n<p>All going well after a few minutes – your initiatives and policies have been deployed.</p>\n<p><img loading=\"lazy\" alt=\"Deploy - AMBA\" src=\"https://luke.geek.nz/assets/images/AzureCloudShell_DeployAMBA-23886b882c8d0f43f1a06280188e1e3c.gif\" width=\"1911\" height=\"1004\" class=\"img_ev3q\"></p>\n<p><img loading=\"lazy\" alt=\"AMBA - Policy Definition\" src=\"https://luke.geek.nz/assets/images/AMBA_PolicyDefinitions-2e4f93fa6cf7999fddaa91476403efda.png\" width=\"601\" height=\"170\" class=\"img_ev3q\"></p>\n<p><img loading=\"lazy\" alt=\"AMBA - Policy Assignments\" src=\"https://luke.geek.nz/assets/images/AMBA_PolicyAssignments-2706da3e9a0ed0b2c419b846a0ace244.png\" width=\"601\" height=\"199\" class=\"img_ev3q\"></p>\n<p>If you have already existing Azure resources, you can remediate the policies, forcing them to create the Resource Group, Alerts and action groups by running the following PowerShell commands:</p>\n<div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">cd scripts</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">$pseudoRootManagementGroup = \"mg\"</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">$identityManagementGroup = \"mg-landingzones\"</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">$managementManagementGroup = \"trey-platform\"</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">$connectivityManagementGroup = \"trey-platform\"</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">$LZManagementGroup= \"mg-landingzones\"</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">#Run the following commands to initiate remediation</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">.\\\\Start-AMBARemediation.ps1 -managementGroupName $managementManagementGroup -policyName Alerting-Management</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">.\\Start-AMBARemediation.ps1 -managementGroupName $connectivityManagementGroup -policyName Alerting-Connectivity</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">.\\Start-AMBARemediation.ps1 -managementGroupName $identityManagementGroup -policyName Alerting-Identity</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">.\\Start-AMBARemediation.ps1 -managementGroupName $LZManagementGroup -policyName Alerting-LandingZone</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">.\\Start-AMBARemediation.ps1 -managementGroupName $pseudoRootManagementGroup -policyName Alerting-ServiceHealth</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>You can check the Alert rules in Azure Monitor:</p>\n<p><img loading=\"lazy\" alt=\"AMBA - Alert Rules\" src=\"https://luke.geek.nz/assets/images/AMBA_AlertRules-ec20907d6410a8a8054ce07039e29a07.png\" width=\"601\" height=\"225\" class=\"img_ev3q\"></p>\n<blockquote>\n<p>It won't deploy all alert rules unless you have the resources; an example is the Deploy VNetG Tunnel Bandwidth alert; the policy rule will only deploy if it matches:\nThe existence of a Virtual Network Gateway, with a VPN Gateway type, doesn't include the MonitorDisable tag; if I were to deploy a VPN Gateway, it would create the alert rule for me.</p>\n</blockquote>\n<p>Finally, if you want to clean up <em>(delete the resources)</em>, you can leverage the Start-AMBACleanup.ps1 script; it will leave the Resource Group, Alert processing rules and action group.</p>",
            "url": "https://luke.geek.nz/azure/Monitor-Azure-LandingZones-with-AMBA",
            "title": "Monitor your Azure Landing Zone with Baseline Alerts",
            "summary": "Monitor your Azure Landing Zone with Azure Monitor Baseline Alerts (AMBA).",
            "date_modified": "2023-10-21T00:00:00.000Z",
            "author": {
                "name": "Luke Murray",
                "url": "https://luke.geek.nz"
            },
            "tags": [
                "Azure"
            ]
        },
        {
            "id": "https://luke.geek.nz/azure/private-endpoint-traffic-not-appearing-azure-firewall",
            "content_html": "<p>You may have a situation where you have implemented <a href=\"https://learn.microsoft.com/azure/private-link/private-endpoint-overview?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Private endpoints</a> and the traffic from on-premises to those Private Endpoints, either doesn't work, even though on-premises firewalls say otherwise, or is working, but doesn't appear in the Azure Firewall.</p>\n<p>I had this recently with <a href=\"https://learn.microsoft.com/azure/azure-arc/overview?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Arc</a>, where the endpoints failed to connect once a site-to-site VPN connection <em>(which was working)</em> was replaced with an expressroute connection, but going through the Azure Firewall logs, was unable to see any 443 traffic for Arc, hitting the Firewall even when the connection was working.</p>\n<p><img loading=\"lazy\" alt=\"Private Endpoint traffic not appearing in Azure Firewall\" src=\"https://luke.geek.nz/assets/images/BlobHeading_PrivateEndpointtrafficnotappearing-46abd44f0fd04636f0a349e00b724711.gif\" width=\"1200\" height=\"628\" class=\"img_ev3q\"></p>\n<blockquote>\n<p>Traffic flow: Onpremises -- (ER Circuit) -- ER gateway -- Secured hub Azure Firewall -- (Vnet Connection) -- PE (Private Endpoint)</p>\n</blockquote>\n<p>The issue was related to how private endpoint traffic is routed differently.</p>\n<p>If the traffic has reached the Expressroute gateway from on-premises, with routing intent, normal traffic will be forced to the AzFW first before reaching its destination, as you would think and expect.</p>\n<blockquote>\n<p>However, for the private endpoint scenario, once a Private Endpoint is deployed to any VNET, there will be an automatic system route with the PE IP and prefix /32 installed on all of the linked NICs.\nThe next hop for this route will be InterfaceEndpoint.\nThis route will allow the traffic to go directly to the PE, bypassing the routing intent and other user-defined routes that are larger than /32. The /32 route propagates to these areas: Any VPN or ExpressRoute connection to an on-premises system.</p>\n</blockquote>\n<p>See: <a href=\"https://learn.microsoft.com/en-us/azure/architecture/guide/networking/private-link-hub-spoke-network?WT.mc_id=AZ-MVP-5004796#considerations\" target=\"_blank\" rel=\"noopener noreferrer\">Considerations for Hub and Spoke topology</a>.</p>\n<p>In an Azure Virtual Wide Area Network (VWAN), you could see this route in the virtual hub <a href=\"https://learn.microsoft.com/azure/virtual-wan/effective-routes-virtual-hub?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">effective routes</a> and which gets propagated to the expressroute gateway.</p>\n<p>My traffic from on-premises to the Azure Arc went directly to the private endpoints (bypassing the Azure Firewall). Still, the route back via the Azure Firewall was completely different, leading to asymmetric routing <em>(a packet traverses from a source to a destination in one path and takes a different path when it returns to the source)</em>.</p>\n<p><strong>To resolve this</strong>, we need to enable network security policies for User-Defined Routes on the subnet of the private endpoint(s):</p>\n<p><img loading=\"lazy\" alt=\"Azure Portal - Private Endpoint - Routes\" src=\"https://luke.geek.nz/assets/images/AzurePortal_RouteTables_PrivateEndpoint-036eb8b544141f79ad204b3acd2aeb93.png\" width=\"1816\" height=\"708\" class=\"img_ev3q\"></p>\n<p>Once enabled, you should see the traffic connect and flow through your Azure Firewall almost immediately.</p>\n<p>Reference:</p>\n<ul>\n<li><a href=\"https://learn.microsoft.com/azure/private-link/disable-private-endpoint-network-policy?tabs=network-policy-portal&amp;WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Manage network policies for private endpoints</a></li>\n<li><a href=\"https://learn.microsoft.com/azure/firewall-manager/private-link-inspection-secure-virtual-hub?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Secure traffic destined to private endpoints in Azure Virtual WAN</a></li>\n</ul>",
            "url": "https://luke.geek.nz/azure/private-endpoint-traffic-not-appearing-azure-firewall",
            "title": "Private Endpoint traffic not appearing in Azure Firewall",
            "summary": "Private Endpoint traffic can take a different route than your standard traffic and cause some confusion and dropped packets.",
            "date_modified": "2023-10-03T00:00:00.000Z",
            "author": {
                "name": "Luke Murray",
                "url": "https://luke.geek.nz"
            },
            "tags": [
                "Azure"
            ]
        },
        {
            "id": "https://luke.geek.nz/azure/Empowering-Resilience-with-Azure-backup-services",
            "content_html": "<p>This article is part of <a href=\"https://azurebacktoschool.github.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Back to School</a> - 2023 event! Make sure to check out the fantastic content created by the community!</p>\n<p><img loading=\"lazy\" alt=\"Empowering Resilience with Azure backup services\" src=\"https://luke.geek.nz/assets/images/Header-Blog-AzureBackup_Services_Innovations-f2d9510f5e2dd62c9ae8c7b0cb844b2b.gif\" width=\"1200\" height=\"628\" class=\"img_ev3q\"></p>\n<p>Along with the basics of the Azure Backup solutions, particularly on Virtual Machines running on Microsoft Azure, there have been a lot of changes in the last year, including Immutable vaults, enhanced policies, intelligence tiering, and cross-region restore.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"introduction\">Introduction<a href=\"https://luke.geek.nz/azure/Empowering-Resilience-with-Azure-backup-services#introduction\" class=\"hash-link\" aria-label=\"Direct link to Introduction\" title=\"Direct link to Introduction\">​</a></h2>\n<p>Let us start with the basics with a user story; what do we need to achieve:</p>\n<blockquote>\n<p>\"As a Cloud Infrastructure Administrator at Contoso, I want to implement an automated backup solution for virtual machines (Windows and Linux) hosted in Microsoft Azure,\nSo that I can ensure data reliability, disaster recovery, and compliance with minimal manual intervention.\"</p>\n</blockquote>\n<p>With some assumptions around further requirements, we can jump into solutions using native Microsoft Azure services to fulfil the Cloud Administrator's need.\nIt is worth mentioning, especially around disaster recovery, that there is much more you can (and should do) do around <a href=\"https://learn.microsoft.com/azure/well-architected/mission-critical/mission-critical-overview?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">mission-critical</a> Azure architecture. This article will focus primarily on the data loss portion of disaster recovery with Azure Backup services.</p>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<table><thead><tr><th><strong>Requirement</strong></th><th><strong>Azure Service(s) Used</strong></th></tr></thead><tbody><tr><td>Specific (S): Backup virtual machines in Azure</td><td><a href=\"https://learn.microsoft.com/azure/backup/?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Backup</a>, <a href=\"https://learn.microsoft.com/azure/site-recovery/site-recovery-overview?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Site Recovery (ASR)</a></td></tr><tr><td>Measurable (M):</td><td></td></tr><tr><td>- Achieve 99% backup success rate</td><td><a href=\"https://learn.microsoft.com/azure/backup/?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Backup</a>, <a href=\"https://learn.microsoft.com/azure/azure-monitor/overview?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Monitor</a></td></tr><tr><td>- Define and meet RTO <em>(recovery time objective)</em> for critical VMs</td><td><a href=\"https://learn.microsoft.com/azure/backup/?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Backup</a>, <a href=\"https://learn.microsoft.com/azure/site-recovery/site-recovery-overview?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Site Recovery (ASR)</a></td></tr><tr><td>- Monitor and optimise storage consumption</td><td><a href=\"https://learn.microsoft.com/azure/azure-monitor/overview?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Monitor</a>, <a href=\"https://learn.microsoft.com/azure/cost-management-billing/costs/reporting-get-started?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Microsoft Cost Management</a></td></tr><tr><td>Achievable (A):</td><td></td></tr><tr><td>- Select and configure Azure-native backup solution</td><td><a href=\"https://learn.microsoft.com/azure/backup/?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Backup</a></td></tr><tr><td>- Configure Azure permissions and access controls</td><td><a href=\"https://learn.microsoft.com/azure/role-based-access-control/rbac-and-directory-admin-roles?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Role-Based Access Control (RBAC)</a></td></tr><tr><td>- Define backup schedules and retention policies</td><td><a href=\"https://learn.microsoft.com/azure/backup/?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Backup</a>, <a href=\"https://learn.microsoft.com/azure/governance/policy/overview?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Policy</a></td></tr><tr><td>Relevant (R):</td><td></td></tr><tr><td>- Align with Azure best practices</td><td><a href=\"https://learn.microsoft.com/en-us/azure/well-architected/?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Well-Architected Framework</a>, <a href=\"https://learn.microsoft.com/azure/advisor/advisor-overview?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Advisor</a></td></tr><tr><td>- Comply with data protection regulations</td><td><a href=\"https://learn.microsoft.com/azure/compliance/?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Compliance Center</a>, <a href=\"https://learn.microsoft.com/azure/governance/policy/overview?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Policy</a></td></tr><tr><td>- Support disaster recovery and business continuity</td><td><a href=\"https://learn.microsoft.com/azure/site-recovery/site-recovery-overview?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Site Recovery (ASR)</a></td></tr><tr><td>Time-bound (T):</td><td></td></tr><tr><td>- Implement within the next two Azure sprint cycles</td><td><a href=\"https://learn.microsoft.com/azure/devops/boards/get-started/what-is-azure-boards?view=azure-devops&amp;WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure DevOps - Boards</a></td></tr><tr><td>- Regular progress reviews during sprint planning</td><td><a href=\"https://learn.microsoft.com/azure/devops/boards/get-started/what-is-azure-boards?view=azure-devops&amp;WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure DevOps - Boards</a></td></tr></tbody></table>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<table><thead><tr><th><strong>Definition of Done (DoD):</strong></th><th></th></tr></thead><tbody><tr><td>1. Select a cost-effective Azure-native backup solution</td><td><a href=\"https://learn.microsoft.com/azure/backup/?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Backup</a></td></tr><tr><td>2. Configure Azure permissions and access controls</td><td><a href=\"https://learn.microsoft.com/azure/role-based-access-control/rbac-and-directory-admin-roles?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Role-Based Access Control (RBAC)</a></td></tr><tr><td>3. Define backup policies and RTOs</td><td><a href=\"https://learn.microsoft.com/azure/backup/?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Backup</a>, <a href=\"https://learn.microsoft.com/azure/governance/policy/overview?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Policy</a></td></tr><tr><td>4. Monitor and meet 99% backup success rate</td><td><a href=\"https://learn.microsoft.com/azure/azure-monitor/overview?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Monitor</a></td></tr><tr><td>5. Optimize backup storage utilisation</td><td><a href=\"https://learn.microsoft.com/azure/cost-management-billing/costs/reporting-get-started?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Microsoft Cost Management</a></td></tr><tr><td>6. Create backup and recovery documentation</td><td><a href=\"https://learn.microsoft.com/azure/backup/backup-azure-restore-files-from-vm?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Microsoft Learn documentation</a></td></tr><tr><td>7. Train the team to manage and monitor the backup system</td><td><a href=\"https://learn.microsoft.com/training/modules/intro-to-azure-backup/?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Training</a></td></tr><tr><td>8. Integrate with Azure monitoring and alerting</td><td><a href=\"https://learn.microsoft.com/azure/azure-monitor/overview?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Monitor</a></td></tr><tr><td>9. Conduct disaster recovery tests</td><td><a href=\"https://learn.microsoft.com/azure/site-recovery/site-recovery-overview?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Site Recovery (ASR)</a></td></tr></tbody></table>\n<p><em>Note: <a href=\"https://learn.microsoft.com/azure/devops/boards/get-started/what-is-azure-boards?view=azure-devops&amp;WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure DevOps - Boards</a> are outside of the scope of this article; the main reflection here is to make sure that your decisions and designs are documented in line with business requirements.</em>\n<em>There are also some further assumptions we will make, particularly around security and RTO requirements for the organisation of Contoso.</em></p>\n<p>We know to fulfil the requirements, we need to implement the following:</p>\n<ul>\n<li><a href=\"https://learn.microsoft.com/azure/backup/?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Backup</a></li>\n<li><a href=\"https://learn.microsoft.com/azure/site-recovery/site-recovery-overview?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Site Recovery (ASR)</a></li>\n<li><a href=\"https://learn.microsoft.com/azure/azure-monitor/overview?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Monitor</a></li>\n<li><a href=\"https://learn.microsoft.com/azure/cost-management-billing/costs/reporting-get-started?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Microsoft Cost Management</a></li>\n<li><a href=\"https://learn.microsoft.com/azure/role-based-access-control/rbac-and-directory-admin-roles?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Role-Based Access Control (RBAC)</a></li>\n<li><a href=\"https://learn.microsoft.com/azure/governance/policy/overview?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Policy</a></li>\n</ul>\n<p>So, let us take our notebooks and look at the Backup sections.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"backup-center\">Backup Center<a href=\"https://luke.geek.nz/azure/Empowering-Resilience-with-Azure-backup-services#backup-center\" class=\"hash-link\" aria-label=\"Direct link to Backup Center\" title=\"Direct link to Backup Center\">​</a></h2>\n<p>When needing a single control plane for your Backups across multiple tenancies <em>(using <a href=\"https://learn.microsoft.com/azure/lighthouse/overview?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Lighthouse</a></em>), Subscriptions and regions, then Backup Center is the place to start with.</p>\n<blockquote>\n<p>\"Backup center provides a single unified management experience in Azure for enterprises to govern, monitor, operate, and analyze backups at scale. It also provides at-scale monitoring and management capabilities for Azure Site Recovery. So, it's consistent with Azure's native management experiences. Backup center is designed to function well across a large and distributed Azure environment. You can use Backup center to efficiently manage backups spanning multiple workload types, vaults, subscriptions, regions, and Azure Lighthouse tenants.\"</p>\n</blockquote>\n<p><img loading=\"lazy\" alt=\"Backup center\" src=\"https://luke.geek.nz/assets/images/AzureBackupCenter_Portal_Overview-4d2a2bcbdbca103d57558ce738180967.png\" width=\"1589\" height=\"874\" class=\"img_ev3q\"></p>\n<p>As you can see, Backup center can be used to see manage:</p>\n<ul>\n<li>Backup instances</li>\n<li>Backup policies</li>\n<li>Vaults</li>\n<li>Monitor and report on backup jobs</li>\n<li>Compliance <em>(ie Azure Virtual Machines that are not configured for backup)</em></li>\n</ul>\n<p>You can find the <a href=\"https://portal.azure.com/#view/Microsoft_Azure_DataProtection/BackupCenterMenuBlade/~/gettingstarted\" target=\"_blank\" rel=\"noopener noreferrer\">Backup Center</a> directly in the Azure Portal.</p>\n<p><img loading=\"lazy\" alt=\"Backup center\" src=\"https://luke.geek.nz/assets/images/AzurePortal-SearchBackupCenter-1a62aa5a6eb2dbcca94a4e8b9040767e.png\" width=\"738\" height=\"524\" class=\"img_ev3q\"></p>\n<p>We can create and manage these resources by ourselves, but throughout this article, we will refer back to the Backup Center, to take advantage of the single pane of glass and integrate these resources.</p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"create-vault\">Create Vault<a href=\"https://luke.geek.nz/azure/Empowering-Resilience-with-Azure-backup-services#create-vault\" class=\"hash-link\" aria-label=\"Direct link to Create Vault\" title=\"Direct link to Create Vault\">​</a></h3>\n<p>In Microsoft Azure, there are two types of Vaults that the Backup center works with. These vaults are:</p>\n<ul>\n<li><a href=\"https://learn.microsoft.com/azure/backup/backup-azure-recovery-services-vault-overview?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Recovery Services vault</a></li>\n<li><a href=\"https://learn.microsoft.com/azure/backup/backup-vault-overview?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Backup vault</a></li>\n</ul>\n<p><img loading=\"lazy\" alt=\"Backup center\" src=\"https://luke.geek.nz/assets/images/AzurePortal_CreateVault_VaultTypes-25f7a11e956f7d8ae2072f6d923862c0.png\" width=\"1142\" height=\"486\" class=\"img_ev3q\"></p>\n<p>Depending on your requirements depends on which Vault you will need to create <em>(for our purposes, we will need the Recovery Services vault)</em>; Backup Center makes it remarkably easy to configure a new vault and select the right vault type by using the wizard.</p>\n<p><em>Please refer to: <a href=\"https://learn.microsoft.com/en-us/azure/backup/backup-support-matrix?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Support matrix for Azure Backup</a> for further information.</em></p>\n<ol>\n<li>Navigate to <strong><a href=\"https://portal.azure.com/#view/Microsoft_Azure_DataProtection/BackupCenterMenuBlade/~/gettingstarted\" target=\"_blank\" rel=\"noopener noreferrer\">Backup Center</a></strong></li>\n<li>Click on <strong>Vaults</strong></li>\n<li>Click <strong>+ Vault</strong></li>\n<li>Select <strong>Recovery Services vault</strong></li>\n<li>Select <strong>Continue</strong></li>\n<li>Specify a <strong>location</strong> and <strong>Resource Group</strong> to house your Recovery Services vault</li>\n<li>Specify your <strong>vault name</strong> <em><a href=\"https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/resource-abbreviations?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">(abbreviation examples for Azure resources)</a></em></li>\n<li>Click <strong>Next: Vault properties</strong></li>\n</ol>\n<blockquote>\n<p>Immutability:\nI talked a bit about immutability in another blog article: <a href=\"https://luke.geek.nz/azure/you-can-t-touch-this-how-to-make-your-azure-backup-immutable-and-secure/\" target=\"_blank\" rel=\"noopener noreferrer\">You Can't Touch This: How to Make Your Azure Backup Immutable and Secure</a>. Essentially an immutable vault, prevents unauthorised changes and restore point deletions, for this article, we will enable it to prevent unintended or malicious data loss (keep in mind with immutable vaults, reducing retention of recovery points is not allowed).</p>\n</blockquote>\n<ol>\n<li>Check <strong>enabled immutability</strong>, and click <strong>Next: Networking</strong>.</li>\n<li>We can join our Recovery Services vault to our <a href=\"https://learn.microsoft.com/azure/backup/private-endpoints?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">private network using private endpoints</a>, forcing Azure Backup and Site Recovery to traverse a private network, for the purposes of this article, we will skip it. <strong>Click Next: Tags</strong></li>\n<li><strong>Enter in Tags</strong> <em>(tags useful for a Recovery Service vault, could be: Application, Support Team, Environment, Cost Center, Criticality)</em></li>\n<li>Click <strong>Review + Create</strong></li>\n</ol>\n<p><img loading=\"lazy\" alt=\"Create Azure Recovery Services Vault\" src=\"https://luke.geek.nz/assets/images/Create_RSV_BackupCenter_AzurePortal-d198cfdd2dfbb36d0ce11db49921f333.gif\" width=\"1893\" height=\"907\" class=\"img_ev3q\"></p>\n<p>If we navigate back to the <a href=\"https://portal.azure.com/#view/Microsoft_Azure_DataProtection/BackupCenterMenuBlade/~/gettingstarted\" target=\"_blank\" rel=\"noopener noreferrer\">Backup Center</a> and then Vaults (under Manage), we will be able to see the newly created vault.</p>\n<p>We now have our Backup solution provisioned for the Cloud Administrator to use, but we next need to define the policies for the backup.</p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"create-backup-policies\">Create Backup Policies<a href=\"https://luke.geek.nz/azure/Empowering-Resilience-with-Azure-backup-services#create-backup-policies\" class=\"hash-link\" aria-label=\"Direct link to Create Backup Policies\" title=\"Direct link to Create Backup Policies\">​</a></h3>\n<p>Now that we have our Recovery Services vault, we need to create backup policies; these backup policies will help define the frequency of backups, the retention (Daily, weekly, monthly, yearly) and <a href=\"https://learn.microsoft.com/azure/backup/use-archive-tier-support?pivots=client-portaltier&amp;WT.mc_id=AZ-MVP-5004796#enable-smart-tiering-to-vault-archive-using-a-backup-policy-preview\" target=\"_blank\" rel=\"noopener noreferrer\">vault tiering</a>, which enables the Recovery Services Vault to move recovery vaults to an <a href=\"https://learn.microsoft.com/en-us/azure/backup/archive-tier-support?WT.mc_id=AZ-MVP-5004796#archive-recommendations-only-for-azure-virtual-machines\" target=\"_blank\" rel=\"noopener noreferrer\">archive tier</a> <em>(slower to restore, but can be cheaper overall, for those long retention policies)</em>.</p>\n<blockquote>\n<p>Backup policies are very organisation-specific and can depend a lot on operational and industry requirements; some industries have a legal obligation to store their backups for a certain number of years, the <a href=\"https://learn.microsoft.com/en-us/azure/compliance/?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure compliance center documentation</a> may help, around security and data requirements, make sure your backup policies are understood by the business you are working with.</p>\n</blockquote>\n<p>For Contoso, we have the following requirements:</p>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<table><thead><tr><th>Resource</th><th>Daily</th><th>Weekly</th><th>Monthly</th><th>Yearly</th><th>Snapshot Retention (Hot)</th></tr></thead><tbody><tr><td><strong>Critical Application DB - Prod</strong></td><td>7 days - Every 4 Hours</td><td>4 weeks</td><td>6 months</td><td>7 years</td><td>5 days</td></tr><tr><td><strong>File Server- Prod</strong></td><td>7 days   - Every 4 Hours</td><td>6 weeks</td><td>6 months</td><td>7 years</td><td>5 days</td></tr><tr><td><strong>Web Application VM - Dev</strong></td><td>20 days</td><td>8 weeks</td><td>12 months</td><td>2 years</td><td>2 days</td></tr><tr><td><strong>Database Server - Dev</strong></td><td>30 days</td><td>8 weeks</td><td>12 months</td><td>2 years</td><td>2 days</td></tr></tbody></table>\n<p>There are a few things to call out here:</p>\n<ul>\n<li>We can see that for Development, items need to be retained for 2 years</li>\n<li>For Production, its 7 years</li>\n<li>Snapshots need to be stored for 5 days and 2 days to allow fast restore</li>\n<li>Production requires a backup to be taken every 4 hours to reduce RTO <em>(Recovery point objective)</em></li>\n</ul>\n<p><img loading=\"lazy\" alt=\"Create Azure Recovery Services Vault\" src=\"https://luke.geek.nz/assets/images/rpo-rto-infographic-eaf32ded76ae2a92856df60086ef4c3d.jpg\" width=\"800\" height=\"312\" class=\"img_ev3q\"></p>\n<p>If we take a look at the Snapshot retention, we can leverage <a href=\"https://learn.microsoft.com/en-us/azure/backup/backup-instant-restore-capability?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Instant restore</a> snapshots, to restore the workloads, quickly from the previous 5 days, reducing our time RTO (recovery time objective), and overall impact of an outage or restore, by storing the snapshots locally (as close to the original disk) without putting it (waiting for it) into archive (slower disk), this will incurr more cost, but dramatically reduces restores time. I recommend always keeping a few Instant restore snapshots available for all production systems.</p>\n<p><img loading=\"lazy\" alt=\"Snapshot\" src=\"https://luke.geek.nz/assets/images/instant-rp-flow-6fd5403e878ce8ea549e7aeaadecb9a8.png\" width=\"1503\" height=\"390\" class=\"img_ev3q\"></p>\n<p>Let us create the policies <em>(we will only create one policy, but the same process can be used to create the others)</em>.</p>\n<ol>\n<li>Navigate to <strong><a href=\"https://portal.azure.com/#view/Microsoft_Azure_DataProtection/BackupCenterMenuBlade/~/gettingstarted\" target=\"_blank\" rel=\"noopener noreferrer\">Backup Center</a></strong></li>\n<li>Click on <strong>Backup policies</strong></li>\n<li>Click <strong>+ Add</strong>\n1 .Select <strong>Azure Virtual Machines</strong></li>\n<li><strong>Select</strong> the <strong>Vault</strong> created earlier</li>\n<li>Click <strong>Continue</strong></li>\n<li>As this will be the policy for the Critical Application DB, we will specify: <strong>Enhanced</strong> <em>(due to the multiple backups, <a href=\"https://learn.microsoft.com/en-us/azure/storage/common/storage-redundancy?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Zone-redundant storage (ZRS)</a> snapshots)</em></li>\n<li>Specify a <strong>Policy name</strong>, ie Tier-1-Prod-AppDB</li>\n<li>Specify <strong>Frequency</strong> to: Hourly, Schedule to Every 4 Hours, and Duration: 24 Hours</li>\n<li>Specify <strong>Retain instance recovery snapshots</strong> for '5' days</li>\n<li>Update <strong>Daily Backup point</strong> to: 7 days</li>\n<li><strong>Configure the Weekly backup point</strong> to occur every Sunday and retain for 4 weeks</li>\n<li><strong>Configure the Monthly backup point</strong> to occur on the first Sunday of the month and retain for 6 months</li>\n<li><strong>Configure the yearly backup point</strong> to occur on the first Sunday of the year and retain for 7 years</li>\n<li>Select <strong>enable Tiering</strong>, and specify Recommended recovery points</li>\n<li>You can also update the Resource Group name used to store the Snapshots.</li>\n<li>Click <strong>Create</strong></li>\n</ol>\n<p><img loading=\"lazy\" alt=\"Snapshot\" src=\"https://luke.geek.nz/assets/images/Create_RSV_AzurePolicyEnhanced-cf9bf2264746adf2a84ee130fce7eb2e.gif\" width=\"1893\" height=\"907\" class=\"img_ev3q\"></p>\n<p>Note: If you want, you can repeat the same process to create any others you need. Remember, with immutable vaults, you cannot reduce the retention (but you can add), so if starting for the first time, keep the retention low until you have a clear direction of what is required. A workload can use the same policy. A Standard <em>(not Enhanced)</em> policy may be all you need for Development workloads.</p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"add-virtual-machines\">Add Virtual Machines<a href=\"https://luke.geek.nz/azure/Empowering-Resilience-with-Azure-backup-services#add-virtual-machines\" class=\"hash-link\" aria-label=\"Direct link to Add Virtual Machines\" title=\"Direct link to Add Virtual Machines\">​</a></h3>\n<p>Now that we have our Recovery Services Vault and custom backup policies, it's time to add our Virtual Machines to the backup! To do this, we can use the Backup center to view Virtual Machines that are not getting backed up, and then configure the backup.</p>\n<ol>\n<li>Navigate to <strong><a href=\"https://portal.azure.com/#view/Microsoft_Azure_DataProtection/BackupCenterMenuBlade/~/gettingstarted\" target=\"_blank\" rel=\"noopener noreferrer\">Backup Center</a></strong></li>\n<li>Click on <strong>Protectable data sources</strong></li>\n<li>Click on the <strong>ellipsis</strong> of a  Virtual Machine you want to backup</li>\n<li>Click on <strong>Backup</strong></li>\n<li><strong>Select</strong> the appropriate <strong>Backup vault</strong> and <strong>policy</strong></li>\n<li>Click <strong>Enable backup</strong></li>\n</ol>\n<blockquote>\n<p>Although cross-region restore is now supported on a Recovery Services vault, the second region is read-only (RA-GRS), so make sure you have a backup recovery vault created in the region (and subscription) of the virtual machines you are trying to protect. Backup center, can see all Recovery services vaults across multiple regions and subscriptions that you have access to.</p>\n</blockquote>\n<p><img loading=\"lazy\" alt=\"Add Virtual Machines\" src=\"https://luke.geek.nz/assets/images/BackupItem_BackupCenter_RSV_AzurePolicyEnhanced-596ff07a42ef094acce54b682d8f2b7f.gif\" width=\"1893\" height=\"907\" class=\"img_ev3q\"></p>\n<p>Once added, the Virtual Machine will now get backed up according to the specified policy.</p>\n<blockquote>\n<p>Its worth noting that you can backup a Virtual Machine if it is deallocated, but it will Crash-consistent <em>(Only the data that already exists on the disk at the time of backup is captured and backed up, and it triggers a disk check during recovery)</em> compared to Application consistent, which is more application and OS aware, so can prepare to the OS and applications for the backups to make sure that everything is written successfully to the disk ahead of the backup. You can read more about <a href=\"https://learn.microsoft.com/en-us/azure/backup/backup-azure-vms-introduction?WT.mc_id=AZ-MVP-5004796#snapshot-consistency\" target=\"_blank\" rel=\"noopener noreferrer\">Snapshot consistency</a>.</p>\n</blockquote>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"monitor-backups\">Monitor Backups<a href=\"https://luke.geek.nz/azure/Empowering-Resilience-with-Azure-backup-services#monitor-backups\" class=\"hash-link\" aria-label=\"Direct link to Monitor Backups\" title=\"Direct link to Monitor Backups\">​</a></h2>\n<p>Now that we have our Recovery Services Vault, policies and protected items <em>(backed up Virtual Machines)</em>, we need to monitor to make sure that the backups are working. Backup center gives us a complete view of Failed, In Progress, and Completed jobs in the overview pane, which is excellent for a quick view of the status across subscriptions and regions.</p>\n<p><img loading=\"lazy\" alt=\"Azure BackupCenter\" src=\"https://luke.geek.nz/assets/images/Azure_BackupCenter_Overview-d1d90cb6e818858550ab15ac1055d547.png\" width=\"1236\" height=\"815\" class=\"img_ev3q\"></p>\n<p>But you may want something a bit more detailed; let us look into some of the options for monitoring your backups.</p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"alerts\">Alerts<a href=\"https://luke.geek.nz/azure/Empowering-Resilience-with-Azure-backup-services#alerts\" class=\"hash-link\" aria-label=\"Direct link to Alerts\" title=\"Direct link to Alerts\">​</a></h3>\n<p>As part of operational checks, you may want assurance or a ticket raised if there's an issue with a backup; one of the ways to achieve this is to set up an email alert that will send an email if a backup fails.</p>\n<p>By default, these types of alerts are enabled out-of-the-box on a recovery services vault; examples of alerts can be found here: <a href=\"https://learn.microsoft.com/azure/backup/backup-azure-monitoring-built-in-monitor?tabs=recovery-services-vaults&amp;WT.mc_id=AZ-MVP-5004796#azure-monitor-alerts-for-azure-backup\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Monitor alerts for Azure Backup</a>, these can be displayed in the Recovery Services Vault or Backup Center blade, immediately.</p>\n<blockquote>\n<p>If a destructive operation, such as stop protection with deleted data is performed, an alert is raised, and an email is sent to subscription owners, admins, and co-admins even if notifications aren't configured for the Recovery Services vault.</p>\n</blockquote>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<table><thead><tr><th>Type</th><th>Description</th><th>Example alert scenarios</th><th>Benefits</th></tr></thead><tbody><tr><td>Built-in Azure Monitor alerts (AMP alerts)</td><td>These are alerts that will be available out-of-the-box for customers without needing additional configuration by the customer.</td><td>Security scenarios like deleting backup data, soft-delete disabled, vault deleted, etc.</td><td>Useful for critical scenarios where the customer needs to receive alerts without the possibility of alerts being subverted by a malicious admin. Alerts for destructive operations fall under this category</td></tr><tr><td>Metric alerts</td><td>Here, Azure Backup will surface backup health-related metrics for customers' Recovery Services vaults and Backup vaults. Customers can write alert rules on these metrics.</td><td>Backup health-related scenarios such as backup success alerts, restore success, schedule missed, RPO missed, etc.</td><td>Useful for scenarios where customers would like some control over the creation of alert rules but without the overhead of setting up LA or any other custom data store.</td></tr><tr><td>Custom Log Alerts</td><td>Customers configure their vaults to send data to the Log Analytics workspace and write alert rules on logs.</td><td>'N' consecutive failed backup jobs, Spike in storage consumed, etc.</td><td>Useful for scenarios where there is a relatively complex, customer-specific logic needed to generate an alert.</td></tr></tbody></table>\n<p>Backup alerts are supported by Azure Monitor, so under <a href=\"https://learn.microsoft.com/azure/azure-monitor/overview?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Monitor</a>, and Alerts pane you can see all your other alerts, including Azure Backup alerts from a single pane.</p>\n<p><img loading=\"lazy\" alt=\"Azure BackupCenter\" src=\"https://luke.geek.nz/assets/images/AzureMonitor_BackupAlert_AzurePortal-d6f1419a3fbbae2c89f25dc019b71c5e.png\" width=\"1920\" height=\"1009\" class=\"img_ev3q\"></p>\n<p>If you want to configure notifications via emails for other types of alerts, such as Backup failures, we can use <a href=\"https://learn.microsoft.com/azure/azure-monitor/overview?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Monitor</a> Action Groups and Alert processing rules, to let us know, without having to login to the Azure Portal directly, so let us create an email alert.</p>\n<p>To do this, we will create an Action Group and Alert Processing rule.</p>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<table><thead><tr><th>Component</th><th>Description</th></tr></thead><tbody><tr><td>Action Group</td><td>An Action Group is a collection of actions or tasks that are executed automatically when an alert that matches specific criteria is triggered. Actions can include sending notifications, running scripts, triggering automation, or escalating the alert. Action Groups help streamline incident response and automate actions based on the nature and severity of an alert.</td></tr><tr><td>Alert Processing Rule</td><td>An Alert Processing Rule is a set of conditions and criteria used to filter, categorize, or route incoming alerts within a monitoring or alerting system. These rules enable organizations to define how alerts are processed, prioritize them, and determine the appropriate actions to take when specific conditions are met. Alert Processing Rules are crucial for managing and efficiently responding to alerts.</td></tr></tbody></table>\n<ol>\n<li>Navigate to <strong><a href=\"https://portal.azure.com/#view/Microsoft_Azure_DataProtection/BackupCenterMenuBlade/~/gettingstarted\" target=\"_blank\" rel=\"noopener noreferrer\">Backup Center</a></strong></li>\n<li>Click on <strong>Alerts</strong></li>\n<li>Click on <strong>Alert Processing rule</strong></li>\n<li>Click <strong>+ Select Scope</strong></li>\n<li>Click <strong>All Resource Types</strong>, and Filter by: <strong>Recovery Services Vault</strong></li>\n<li><strong>Select</strong> your <strong>Recovery Services vault</strong>, you would like to alert on</li>\n<li>Click <strong>Apply</strong></li>\n<li>Click on <strong>Filter, and change: Alert condition = Fired</strong>.</li>\n<li>Click Next: <strong>Rule Settings</strong></li>\n<li>Click <strong>Apply action group</strong></li>\n<li>Click <strong>+ Create action group</strong></li>\n<li><strong>Select</strong> the Subscription, <strong>Resource Group</strong> to store your action group (i.e. monitor resource group)</li>\n<li>Give the <strong>Action Group</strong> a <strong>name</strong>, and give it a Display name</li>\n<li>Specify <strong>Notification</strong> type <em>(ie Email/SMS message/push/voice)</em></li>\n<li>For this article, we will add an Email <em>(but you can have it ring a number, push a notification to the <a href=\"https://azure.microsoft.com/en-us/get-started/azure-portal/mobile-app?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Mobile App</a>)</em></li>\n<li>Enter in <strong>your details</strong>, then click <strong>Next: Actions</strong></li>\n<li>In the Actions pane, is where you can trigger automation, such as Azure Logic Apps, Runbooks, ITSM connections, Webhooks etc., to help self-remediate the issues, or better notifications, such as a Logic App that posts in a Teams channel when an alert is fired, or a wehbook that triggers a webpage to update. In this example, we will leave it empty and rely on email notifications and click Next: Tags</li>\n<li>Enter any Tags and click <strong>Review + create</strong></li>\n<li>Make note of Suppress Notifications; this could be handy during scheduled maintenance windows where backups may fail due to approved work.</li>\n<li>Once the Action Group has been created, click <strong>Next: Scheduling</strong></li>\n<li>Select <strong>Always</strong></li>\n<li>Click <strong>Next: Details</strong></li>\n<li>Enter in a <strong>Resource Group</strong>, for the Alert processing rule to be placed</li>\n<li>Enter in <strong>Rule name</strong>, <strong>description</strong> and click <strong>Review + Create</strong></li>\n</ol>\n<p><img loading=\"lazy\" alt=\"Azure BackupCenter\" src=\"https://luke.geek.nz/assets/images/BackupItem_BackupCenter_RSV_BackupAlertRuleCreation-cad908e18b35d4b3a12f5c9313330fa5.gif\" width=\"1893\" height=\"907\" class=\"img_ev3q\"></p>\n<p>As you can see Azure Monitor integration into backups, gives you some great options to keep on top of your backups, and integrate with other systems, like your IT Service Management toolsets.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"azure-site-recovery\">Azure Site Recovery<a href=\"https://luke.geek.nz/azure/Empowering-Resilience-with-Azure-backup-services#azure-site-recovery\" class=\"hash-link\" aria-label=\"Direct link to Azure Site Recovery\" title=\"Direct link to Azure Site Recovery\">​</a></h2>\n<p><a href=\"https://learn.microsoft.com/azure/site-recovery/site-recovery-overview?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Site Recovery (ASR)</a> can be used to migrate workloads, across <a href=\"https://learn.microsoft.com/azure/reliability/availability-zones-overview?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Availability Zones and regions</a>, by replicating the disks of a Virtual Machine to another region (GRS) or zone (ZRS), in fact <a href=\"https://learn.microsoft.com/azure/resource-mover/overview?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Resource Mover</a> uses Azure Site Recovery when moving virtual machines between regions. Azure Site Recovery can also help with migrating workloads outside of Azure, to Azure, for disaster recovery.</p>\n<p>When looking at migrating workloads, to Azure from the VMWare stack, consider the <a href=\"https://learn.microsoft.com/azure/site-recovery/site-recovery-deployment-planner?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Site Recovery Deployment Planner for VMware</a> to Azure to assist.</p>\n<p>For the purposes of this guide, we will achieve disaster recovery of our virtual machine, by replicating it to another region <em>(i.e. from Australia East to Central India)</em>.</p>\n<blockquote>\n<p>Azure Recovery Services contributes to your BCDR strategy:\nSite Recovery service: Site Recovery helps ensure business continuity by keeping business apps and workloads running during outages. Site Recovery replicates workloads running on physical and virtual machines (VMs) from a primary site to a secondary location. When an outage occurs at your primary site, you fail over to a secondary location, and access apps from there. After the primary location is running again, you can fail back to it.\nBackup service: The Azure Backup service keeps your data safe and recoverable.</p>\n</blockquote>\n<p><img loading=\"lazy\" alt=\"Azure BackupCenter\" src=\"https://luke.geek.nz/assets/images/CausesITDisasters-88a4da45105538385af17f8e3982ecb9.png\" width=\"1098\" height=\"684\" class=\"img_ev3q\"></p>\n<blockquote>\n<p>Just as important (if not more) than the technology to enable this, clear business requirements and preparation is paramount for a successful disaster recovery solution, I highly recommend the <a href=\"https://techcommunity.microsoft.com/t5/fasttrack-for-azure/introducing-the-azure-business-continuity-guide/ba-p/3905424?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Business Continuity Guide</a>. Supplied by the Microsoft Fastrack team, this guide includes resources to prepare for thorough disaster recovery plan.</p>\n</blockquote>\n<p>The key to successful disaster recovery is not only the workloads themselves but supporting services, such as DNS, Firewall rules, connectivity etc., that need to be considered, These are out of the scope of this article but the following Microsoft Azure architecture references are worth a read:</p>\n<ul>\n<li><a href=\"https://learn.microsoft.com/azure/architecture/solution-ideas/articles/disaster-recovery-enterprise-scale-dr?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Enterprise-scale disaster recovery</a></li>\n<li><a href=\"https://learn.microsoft.com/azure/architecture/solution-ideas/articles/disaster-recovery-smb-azure-site-recovery?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">SMB disaster recovery with Azure Site Recovery</a></li>\n<li><a href=\"https://learn.microsoft.com/azure/site-recovery/azure-to-azure-architecture?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure to Azure disaster recovery architecture</a></li>\n<li><a href=\"https://learn.microsoft.com/azure/architecture/reference-architectures/n-tier/multi-region-sql-server?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Multi-region N-tier application</a></li>\n<li><a href=\"https://learn.microsoft.com/azure/architecture/solution-ideas/articles/build-high-availability-into-your-bcdr-strategy?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Build high availability into your BCDR strategy</a></li>\n<li><a href=\"https://learn.microsoft.com/azure/site-recovery/site-recovery-retain-ip-azure-vm-failover?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Retain IP addresses during failover</a></li>\n<li><a href=\"https://techcommunity.microsoft.com/t5/azure-architecture-blog/empowering-disaster-recovery-for-azure-vms-with-azure-site/ba-p/3885378?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Empowering Disaster Recovery for Azure VMs with Azure Site Recovery and Terraform</a></li>\n</ul>\n<p>For Azure Site Recovery to work, it relies on a mobility service running within the Virtual Machine to replicate changes, the source virtual machine needs to be on to replicate the changes.</p>\n<blockquote>\n<p>When you enable replication for a VM to set up disaster recovery, the Site Recovery Mobility service extension installs on the VM and registers it with Azure Site Recovery. During replication, VM disk writes are sent to a cache storage account in the source region. Data is sent from there to the target region, and recovery points are generated from the data.</p>\n</blockquote>\n<p>Azure Site Recovery, does not currently support virtual machines protected with <a href=\"https://learn.microsoft.com/azure/virtual-machines/trusted-launch?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Trusted Launch</a>.</p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"enable-azure-site-recovery\">Enable Azure Site Recovery<a href=\"https://luke.geek.nz/azure/Empowering-Resilience-with-Azure-backup-services#enable-azure-site-recovery\" class=\"hash-link\" aria-label=\"Direct link to Enable Azure Site Recovery\" title=\"Direct link to Enable Azure Site Recovery\">​</a></h3>\n<p>For now, we have 'VM1' a Ubuntu workload, running in Australia East, with a Public IP, that we will failover to Central India. The source Virtual Machine can be backed up normally by a vault in the source region, and replicated to another vault in the destination region.</p>\n<blockquote>\n<p>Azure Site Recovery has a specific Operating System and Linux kernel <a href=\"https://learn.microsoft.com/azure/site-recovery/azure-to-azure-support-matrix?WT.mc_id=AZ-MVP-5004796#replicated-machine-operating-systems\" target=\"_blank\" rel=\"noopener noreferrer\">support</a>. Make sure you confirm that your workloads are supported.</p>\n</blockquote>\n<ol>\n<li>Navigate to <strong><a href=\"https://portal.azure.com/#view/Microsoft_Azure_DataProtection/BackupCenterMenuBlade/~/gettingstarted\" target=\"_blank\" rel=\"noopener noreferrer\">Backup Center</a></strong></li>\n<li>Click on <strong>Vaults</strong></li>\n<li><strong>Create</strong> a new Recovery Services <strong>vault</strong> in your <strong>DR</strong> <em>(Disaster Recovery <strong>region</strong> - ie Central India)</em></li>\n<li>Click on <strong>Site Recovery</strong></li>\n<li>Under Azure Virtual Machines, click on: <strong>Enable replication</strong></li>\n<li>Specify the <strong>source Virtual Machine</strong>, you wish to migrate</li>\n<li>Click <strong>Next</strong></li>\n<li>Select your <strong>source Virtual Machine</strong></li>\n<li>Click <strong>Next</strong></li>\n<li>Select the <strong>target location (i.e. Central India)</strong></li>\n<li>Select the <strong>target Resource Group</strong></li>\n<li>Select the <strong>Target Virtual Network</strong> <em>(create one if it doesn't exist)</em></li>\n<li>Select the <strong>target subnet</strong></li>\n<li>Under the Storage, you can consider changing the replica disk to Standard, to reduce cost (this can be <a href=\"https://learn.microsoft.com/azure/virtual-machines/disks-convert-types?tabs=azure-portal&amp;WT.mc_id=AZ-MVP-5004796#change-the-type-of-an-individual-managed-disk\" target=\"_blank\" rel=\"noopener noreferrer\">changed</a> later).</li>\n<li>Select a cache storage account <em>(The cache storage account is a storage account used for transferring the replication data before its written to the destination disk)</em></li>\n<li>You can then adjust the availability zone of the destination virtual machine</li>\n<li>Click <strong>Next</strong></li>\n<li>Here we can <strong>define a Replication Policy</strong> <em>(a replication policy in Azure Site Recovery is a set of rules and configurations that determine how data is replicated from the source environment to the target environment (Azure) in case of a disaster or planned failover, such as retention, ie you can restore a point within the retention period)</em> we will leave the default 24-hour retention policy.</li>\n<li>We can specify a Replication Group, An example of a replication group is application servers that need to be consistent with each other, in terms of data <em>( replication policy in Azure Site Recovery is a set of rules and configurations that determine how data is replicated from the source environment to the target environment (Azure) in case of a disaster or planned failover.)</em>.</li>\n<li>Specify an automation account to manage the mobility service, and we will leave the update extension to be ASR (Azure Site Recovery) managed.</li>\n<li>Click <strong>Next</strong></li>\n<li>Click <strong>Enable replication</strong></li>\n<li>At the Recovery Services Vault, under Site Recovery Jobs you can monitor the registration, registration and initial replication can take 30-60 minutes to install the agent and start the replication.</li>\n</ol>\n<p><img loading=\"lazy\" alt=\"Azure BackupCenter\" src=\"https://luke.geek.nz/assets/images/BackupCenter_RSV_EnableAzureSiteRecovery-4fa0daaa292bf6f9113604942480f26a.gif\" width=\"1893\" height=\"907\" class=\"img_ev3q\"></p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"failover-to-the-secondary-region-using-azure-site-recovery\">Failover to the secondary region using Azure Site Recovery<a href=\"https://luke.geek.nz/azure/Empowering-Resilience-with-Azure-backup-services#failover-to-the-secondary-region-using-azure-site-recovery\" class=\"hash-link\" aria-label=\"Direct link to Failover to the secondary region using Azure Site Recovery\" title=\"Direct link to Failover to the secondary region using Azure Site Recovery\">​</a></h3>\n<p>Once your virtual machine has been replicated in the secondary region. you can do a Failover, or Test failover. A Test failover is recommended, in your DR testing, and application testing.</p>\n<p><img loading=\"lazy\" alt=\"Azure BackupCenter\" src=\"https://luke.geek.nz/assets/images/ASR_AUE_to_CentralIndia-90bc7c5b21d98f57d02164881d88ae43.png\" width=\"1248\" height=\"616\" class=\"img_ev3q\"></p>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<table><thead><tr><th>Aspect</th><th>Failover</th><th>Test Failover</th></tr></thead><tbody><tr><td>Purpose</td><td>To switch to a secondary site during a disaster or planned maintenance event.</td><td>To validate your disaster recovery plan without impacting production.</td></tr><tr><td>Impact on Production</td><td>Disrupts production services as the primary site becomes unavailable during the failover process.</td><td>No impact on production services; the primary site remains operational.</td></tr><tr><td>Data Replication</td><td>Replicates data from primary to secondary site, making it the active site during the failover.</td><td>Uses the same replicated data but doesn't make the secondary site the active site; it's for testing purposes only.</td></tr><tr><td>Recovery Time</td><td>Longer recovery time, as it involves setting up and activating the secondary site.</td><td>Faster recovery time, as it doesn't require making the secondary site the active site.</td></tr><tr><td>Data Consistency</td><td>Ensures data consistency and integrity during the failover process.</td><td>Ensures data consistency for testing but doesn't make the secondary site the primary site.</td></tr><tr><td>Cost</td><td>May incur additional costs due to the resources activated at the secondary site.</td><td>Typically incurs minimal additional costs as it's for testing purposes.</td></tr><tr><td>Use Cases</td><td>Actual disaster recovery scenarios or planned maintenance events.</td><td>Testing and validating disaster recovery procedures, training, and compliance.</td></tr><tr><td>Post-Operation</td><td>The secondary site becomes the new primary site until failback is initiated.</td><td>No change to the primary site; the secondary site remains inactive.</td></tr><tr><td>Rollback Option</td><td>Failback operation is required to return to the primary site once it's available.</td><td>No need for a rollback; the primary site remains unaffected.</td></tr></tbody></table>\n<ol>\n<li>Navigate to your destination Recovery Services Vault</li>\n<li>Click on REplicated Items</li>\n<li>Select the Virtual Machine you wish to recover in your second region</li>\n<li>Select Test Failover (or Failover, depending on your requirements)</li>\n<li>Select your Recovery point and destination Virtual network</li>\n<li>Select Failover</li>\n<li>If it is a test failover, you can then Clean up your Test failover <em>(deleted replicated item)</em> after you have tested</li>\n</ol>\n<p><img loading=\"lazy\" alt=\"Azure BackupCenter\" src=\"https://luke.geek.nz/assets/images/BackupCenter_RSV_TestFailoverAzureSiteRecovery-de77d87bfe5d8f04707caba95ad6c4b2.gif\" width=\"1893\" height=\"907\" class=\"img_ev3q\"></p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"azure-policies\">Azure Policies<a href=\"https://luke.geek.nz/azure/Empowering-Resilience-with-Azure-backup-services#azure-policies\" class=\"hash-link\" aria-label=\"Direct link to Azure Policies\" title=\"Direct link to Azure Policies\">​</a></h2>\n<p>Automatically, mapping of Virtual Machines, to backup policies can be done using <a href=\"https://learn.microsoft.com/azure/governance/policy/overview?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Policy</a>.</p>\n<p>Azure policies such as:</p>\n<ul>\n<li>Azure Backup should be enabled for Virtual Machines</li>\n<li>Configure backup on virtual machines without a given tag to an existing recovery services vault in the same location</li>\n<li>Disable Cross Subscription Restore for Backup Vaults</li>\n<li>Soft delete should be enabled for Backup Vaults</li>\n</ul>\n<p>More, are built-in to the Azure policy engine and can be easily assigned, across subscriptions and management groups, found in the Backup Center.</p>\n<ol>\n<li>Navigate to <strong><a href=\"https://portal.azure.com/#view/Microsoft_Azure_DataProtection/BackupCenterMenuBlade/~/gettingstarted\" target=\"_blank\" rel=\"noopener noreferrer\">Backup Center</a></strong></li>\n<li>Click on <strong>Azure policies for backup</strong></li>\n<li>Click on a policy and click <strong>Assign</strong></li>\n</ol>\n<blockquote>\n<p>You can find a list of custom and built-in policies at the <a href=\"https://www.azadvertizer.net/azpolicyadvertizer_all.html\" target=\"_blank\" rel=\"noopener noreferrer\">AzPolicyAdvertizerPro</a> website.</p>\n</blockquote>\n<p><img loading=\"lazy\" alt=\"Azure AutoManage\" src=\"https://luke.geek.nz/assets/images/azure-automanage-intelligently-onboard-services-5a54eeaf53941404cadf42cb7046b4e1.png\" width=\"802\" height=\"562\" class=\"img_ev3q\"></p>\n<p><a href=\"https://learn.microsoft.com/azure/automanage/overview-about?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Automanage</a> can be used alongside Azure policy, to onboard Virtual Machines, into backup, patching etc automatically, with reduced manual intervention, and although not directly part of this article, what you have learned can be used to develop your automanage profiles.</p>",
            "url": "https://luke.geek.nz/azure/Empowering-Resilience-with-Azure-backup-services",
            "title": "Empowering Resilience with Azure backup services",
            "summary": "This article is part of Azure Back to School - 2023 event! Make sure to check out the fantastic content created by the community!",
            "date_modified": "2023-09-23T00:00:00.000Z",
            "author": {
                "name": "Luke Murray",
                "url": "https://luke.geek.nz"
            },
            "tags": [
                "Azure"
            ]
        },
        {
            "id": "https://luke.geek.nz/azure/hosted-agents-container-apps-job",
            "content_html": "<p>When considering <a href=\"https://learn.microsoft.com/azure/devops/pipelines/agents/agents?view=azure-devops&amp;tabs=yaml%2Cbrowser&amp;WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">build agents</a> to use in <a href=\"https://azure.microsoft.com/products/devops?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure DevOps</a> <em>(or <a href=\"https://docs.github.com/en/actions/using-github-hosted-runners/about-github-hosted-runners\" target=\"_blank\" rel=\"noopener noreferrer\">GitHub</a>)</em>, there are 2 main options to consider:</p>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<table><thead><tr><th>Agent type</th><th>Description</th></tr></thead><tbody><tr><td><a href=\"https://learn.microsoft.com/azure/devops/pipelines/agents/agents?view=azure-devops&amp;tabs=yaml%2Cbrowser&amp;WT.mc_id=AZ-MVP-5004796#microsoft-hosted-agents\" target=\"_blank\" rel=\"noopener noreferrer\">Microsoft-hosted agents</a></td><td>Agents hosted and managed by Microsoft</td></tr><tr><td><a href=\"https://learn.microsoft.com/azure/devops/pipelines/agents/agents?view=azure-devops&amp;tabs=yaml%2Cbrowser&amp;WT.mc_id=AZ-MVP-5004796#install\" target=\"_blank\" rel=\"noopener noreferrer\">Self-hosted agents</a></td><td>Agents that you configure and manage, hosted on your VMs</td></tr></tbody></table>\n<p><a href=\"https://learn.microsoft.com/en-us/azure/devops/pipelines/agents/hosted?view=azure-devops&amp;tabs=yaml&amp;WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Microsoft-hosted agents</a>, can be used for most things, but there are times where you may need to talk to internal company resources, or security is a concern, which is when you would consider self-hosting the agent yourself.</p>\n<p>Here is a table that summarizes the pros and cons of self-hosted Azure DevOps agents and Microsoft-hosted agents:</p>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<table><thead><tr><th><strong>Agent Type</strong></th><th><strong>Pros</strong></th><th><strong>Cons</strong></th></tr></thead><tbody><tr><td>Self-hosted</td><td>More control over the environment, ability to install dependent software needed for builds and deployments, machine-level caches and configuration persist from run to run, which can boost speed.</td><td>Maintenance and upgrades are not taken care of for you; you must manage the agent yourself.</td></tr><tr><td>Microsoft-hosted</td><td>Maintenance and upgrades are taken care of for you; each time you run a pipeline, you get a fresh virtual machine discarded after one use. Microsoft-hosted agents can run jobs directly on the VM or in a container. The pre-defined Azure Pipelines agent pool offers several virtual machine images, each including various tools and software. You can see the installed software for each hosted agent by choosing the Included Software link in the table. Microsoft-hosted agents run on a secure Azure platform.</td><td>You have less control over the environment, you cannot install dependent software needed for builds and deployments, and machine-level caches and configurations do not persist from run to run.</td></tr></tbody></table>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"overview\">Overview<a href=\"https://luke.geek.nz/azure/hosted-agents-container-apps-job#overview\" class=\"hash-link\" aria-label=\"Direct link to Overview\" title=\"Direct link to Overview\">​</a></h2>\n<p>Self-hosted agents give you more control over your environment, allowing you to install dependent software needed for your builds and deployments.</p>\n<p>As Azure DevOps pipeline jobs come and go as they complete each task required, you want to be able to scale the agents out as required and pay for only what you use, you could consider <a href=\"https://learn.microsoft.com/azure/devops/pipelines/agents/scale-set-agents?view=azure-devops&amp;WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Virtual Machine Scale Set agents</a>. Still, you have to have to maintain virtual machine images and storage, they can be slow to provision and start, and they could become inconsistent as manual changes can be easier to do.</p>\n<p>Here is a table that summarizes the comparison between Container Apps Jobs for an Azure DevOps Agent and using an Azure Virtual Machine scale set:</p>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<table><thead><tr><th><strong>Agent Type</strong></th><th><strong>Pros</strong></th><th><strong>Cons</strong></th></tr></thead><tbody><tr><td>Container Apps Jobs</td><td>Can run containerized tasks that execute for a finite duration and exit, allowing you to perform tasks such as data processing, machine learning, or any scenario requiring on-demand processing. Container apps and jobs run in the same environment, allowing them to share capabilities such as networking and logging.</td><td>You have less control over the environment, you cannot install dependent software needed for builds and deployments, and machine-level caches and configurations do not persist from run to run.</td></tr><tr><td>Azure Virtual Machine scale set</td><td>You have more control over the environment, allowing you to install dependent software needed for your builds and deployments. Machine-level caches and configuration persist from run to run, which can boost speed.</td><td>Maintenance and upgrades are not taken care of for you; you need to manage the agent yourself.</td></tr></tbody></table>\n<p>Container Apps Jobs allows you to run containerized tasks that execute for a finite duration and exit, performing tasks such as data processing, machine learning, or any scenario requiring on-demand processing. Container apps and jobs run in the same environment, allowing them to share capabilities such as networking and logging. However, you have less control over the environment, you cannot install dependent software needed for builds and deployments, and machine-level caches and configurations do not persist from run to run.</p>\n<p><em>The choice between Container Apps and VM scale sets for Azure DevOps agents should consider your specific project requirements and constraints. Each option has its own set of advantages and trade-offs.</em></p>\n<p>For our discussion today, we will provision Azure DevOps Agents using <a href=\"https://learn.microsoft.com/azure/container-apps/jobs?tabs=azure-cli&amp;WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Container Apps Jobs</a>.</p>\n<p><img loading=\"lazy\" alt=\"Get Ahead with Self-Hosted Agents and Container Apps Jobs\" src=\"https://luke.geek.nz/assets/images/BlogHeader-GetAheadwithSelf-HostedAgentsandContainerAppsJobs-615cf198386d2518210ba9d27883e035.gif\" width=\"1200\" height=\"628\" class=\"img_ev3q\"></p>\n<p>As we want a self-hosted agent to have access to our internal resources, we will deploy a <a href=\"https://learn.microsoft.com/en-us/azure/container-apps/networking?tabs=azure-cli&amp;WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Consumption based Internal Container Apps Environment</a>, to host our jobs.</p>\n<p><a href=\"https://learn.microsoft.com/azure/container-apps/overview?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Container Apps</a> is a service that allows you to run containerized applications in the cloud. It provides a platform for running and scaling containerized applications, and it can be used to deploy and manage containerized applications in a variety of environments.</p>\n<p>There are two types of compute resources in Azure Container Apps: <strong>apps</strong> and <strong>jobs</strong>.</p>\n<p>Apps are services that run continuously. If a container in an app fails, it's restarted automatically. Examples of apps include HTTP APIs, web apps, and background services that continuously process input.</p>\n<p>Without <a href=\"https://github.com/microsoft/azure-container-apps/issues/24\" target=\"_blank\" rel=\"noopener noreferrer\">scaled job</a> support by Azure Container App Jobs, a job could fail during execution; this has now been resolved with Container App Jobs.</p>\n<blockquote>\n<p>Azure Container Apps jobs enable you to run containerized tasks that execute for a finite duration and exit. You can use jobs to perform tasks such as data processing, machine learning, or any scenario where on-demand processing is required.\nJobs are tasks that start, run for a finite duration, and exit when finished. Each execution of a job typically performs a single unit of work. Job executions start manually, on a schedule, or in response to events. <a href=\"https://learn.microsoft.com/azure/container-apps/jobs?tabs=azure-cli&amp;WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Examples of jobs include batch processes that run on demand and scheduled tasks</a>.</p>\n</blockquote>\n<p>Running self-hosted agents as event-driven jobs allows you to take advantage of the serverless nature of Azure Container Apps. Jobs execute automatically when a workflow is triggered and exit when the job completes.</p>\n<blockquote>\n<p>Container apps and jobs don't support running Docker in containers. Any steps in your workflows that use Docker commands will fail when run on a self-hosted runner or agent in a Container Apps job; other <a href=\"https://learn.microsoft.com/en-us/azure/container-apps/jobs?tabs=azure-cli&amp;WT.mc_id=AZ-MVP-5004796#jobs-restrictions\" target=\"_blank\" rel=\"noopener noreferrer\">restrictions also exist</a>.</p>\n</blockquote>\n<p>For an Azure DevOps Agent, we want to execute tasks or remove them. This is where Container Apps Jobs and <a href=\"https://keda.sh/\" target=\"_blank\" rel=\"noopener noreferrer\">KEDA</a> come in handy.</p>\n<blockquote>\n<p>KEDA (Kubernetes-based Event Driven Autoscaling) is an open-source project that provides event-driven autoscaling for Kubernetes workloads. KEDA can scale any container in response to events from various sources such as Azure Service Bus, Azure Event Hubs, Azure Storage Queues, Azure Storage Blobs, RabbitMQ, Kafka, and more.</p>\n</blockquote>\n<p>One of the supported scalers is <a href=\"https://keda.sh/docs/2.11/scalers/azure-pipelines/\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Pipelines</a>.</p>\n<p><em>This specification describes the azure-pipelines trigger for Azure Pipelines. It scales based on the number of pipeline runs pending in a given agent pool.</em></p>\n<p>Jobs can be triggered in three ways:</p>\n<ul>\n<li>Manual jobs are triggered on demand.</li>\n<li>Scheduled jobs are triggered at specific times and can run repeatedly.</li>\n<li>Event-driven jobs are triggered by a message arriving in a queue.</li>\n</ul>\n<p>We will use both <strong>Manual</strong> and <strong>Event-driven</strong>.</p>\n<p>The <strong>Manual</strong> job will be run once to create a <a href=\"https://keda.sh/blog/2021-05-27-azure-pipelines-scaler/#placeholder-agent\" target=\"_blank\" rel=\"noopener noreferrer\">placeholder</a>, Azure DevOps agent in the pool.</p>\n<blockquote>\n<p>\"You cannot queue an Azure Pipelines job on an empty agent pool because Azure Pipelines cannot validate if the pool matches the requirements for the job.\"</p>\n</blockquote>\n<p>As our Container Jobs are temporary, a placeholder agent <strong>needs to remain</strong> in the Agent pool <em>(i.e. don't delete it)</em> to keep it active. This agent will be offline and can be Disabled if required in Azure DevOps. The Azure resource, however, can then be deleted.</p>\n<p>For the actual agents themselves that will run our code, they will be <strong>event-driven</strong>.</p>\n<p>To provision our Azure Container App Job build agents, we will use <a href=\"https://learn.microsoft.com/azure/azure-resource-manager/bicep/overview?tabs=bicep&amp;WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Bicep</a> to create our resources.</p>\n<p>Our resources will consist of:</p>\n<ul>\n<li><a href=\"https://learn.microsoft.com/azure/container-apps/networking?tabs=azure-cli&amp;WT.mc_id=AZ-MVP-5004796#accessibility-levels\" target=\"_blank\" rel=\"noopener noreferrer\">Internal Container Apps Environment</a> (Internal environments have no public endpoints and are deployed with a virtual IP (VIP) mapped to an internal IP address)</li>\n<li><a href=\"https://learn.microsoft.com/azure/virtual-network/virtual-networks-overview?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Virtual Network</a> with 2 subnets (One subnet for resources, such as Azure Key vault, Container Registry, the other subnet dedicated to the Container App environment)</li>\n<li><a href=\"https://learn.microsoft.com/azure/container-registry/container-registry-intro?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Container Registry</a> (this registry will be used to build and contain our container for the DevOps agent. The container registry will have a private endpoint to the internal network)</li>\n<li><a href=\"https://learn.microsoft.com/azure/azure-monitor/logs/log-analytics-workspace-overview?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Log Analytics workspace</a> (to hold the Logs from the Container App Environment)</li>\n<li><a href=\"https://learn.microsoft.com/azure/key-vault/general/overview?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Key Vault</a> (the key vault will hold our PAT (Personal Access Token), which will be used to join our COntainer App Job agents to the agent pool. The key vault will also be on the internal network, accessed via a private endpoint)</li>\n<li><a href=\"https://learn.microsoft.com/azure/dns/private-dns-privatednszone?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Private DNS zones</a> (the DNS zones, will allow the Container App Environment, to reach the Key vault and Container Registry over the internal network)</li>\n<li><a href=\"https://learn.microsoft.com/azure/azure-resource-manager/templates/deployment-script-template?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Deployment scripts</a> (these can be deleted afterwards, but they will run the scripts to build our container image, and placeholder agent within the confines of Bicep)*</li>\n</ul>\n<p>We will also need a <a href=\"https://learn.microsoft.com/azure/active-directory/managed-identities-azure-resources/overview?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">User Assigned Managed Identity</a> for this article*(and the scope only being to the Resource Group)*I have a pre-created User Assigned Managed identity named:<em>usrmi</em>. This Managed identity has the following role assignments to the Resource Group to which the resources will be deployed.</p>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<table><thead><tr><th><strong>Role</strong></th><th><strong>Assigned To</strong></th><th><strong>Notes</strong></th></tr></thead><tbody><tr><td>Contributor</td><td>usrmi</td><td>Contributor role on the container registry resource to push the container image and create the Container App Jobs and resources.</td></tr><tr><td>Key Vault Secrets User</td><td>usrmi</td><td>Secret Reader to access the Key Vault secrets.</td></tr></tbody></table>\n<p>The cost of the overall solution 'depends' on how active it is and how it is used.</p>\n<ul>\n<li>Resources such as <a href=\"https://azure.microsoft.com/pricing/details/container-apps/?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Container Apps</a>, under Consumption, are pay-per-use and dependent on the number of requests and the length of those requests. The idea here is that they only cost something if in use.</li>\n<li><a href=\"https://azure.microsoft.com/en-us/pricing/details/container-registry/?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Container Registry</a> requires the Premium SKU for Private Endpoint support, but for demo environments, you could get away with a Basic.</li>\n<li><a href=\"https://azure.microsoft.com/pricing/details/key-vault/?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Key Vault</a> also depends on the number of transactions and functionality.</li>\n</ul>\n<p>It is recommended to do an estimate using the <a href=\"https://azure.microsoft.com/pricing/calculator/?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Pricing Calculator</a> in your currency and region to work out the costs, but the true reflection will be once your Azure DevOps pipelines start consuming the infrastructure.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"let-us-get-building\">Let us get building<a href=\"https://luke.geek.nz/azure/hosted-agents-container-apps-job#let-us-get-building\" class=\"hash-link\" aria-label=\"Direct link to Let us get building\" title=\"Direct link to Let us get building\">​</a></h2>\n<p>To deploy our environment:</p>\n<p><img loading=\"lazy\" alt=\"Container App Jobs - High-level architecture\" src=\"https://luke.geek.nz/assets/images/privatecontainerappsjob_architecture-2be093d885ec027ba59730cb9c0940be.png\" width=\"4000\" height=\"2250\" class=\"img_ev3q\"></p>\n<p>We will Azure Bicep, a User Managed Identity and Resource Group.</p>\n<p>The <a href=\"https://learn.microsoft.com/azure/azure-resource-manager/bicep/overview?tabs=bicep&amp;WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Bicep</a> file I have written is scoped to a single Resource Group, but to do this in production and work with your existing resources, it may be better to move it to <a href=\"https://learn.microsoft.com/azure/azure-resource-manager/bicep/modules?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">modules</a>.</p>\n<blockquote>\n<p>All the code required to get this to work can be found in the following GitHub repository: <a href=\"https://github.com/lukemurraynz/containerapps-selfhosted-agent\" target=\"_blank\" rel=\"noopener noreferrer\">lukemurraynz/containerapps-selfhosted-agent</a>, including the <a href=\"https://luke.geek.nz/azure/Getting-Started-with-GitHub-Codespaces/\" target=\"_blank\" rel=\"noopener noreferrer\">GitHub Codespace</a>, configuration I am using to deploy.</p>\n</blockquote>\n<p>We will start with a Resource Group consisting of our Managed Identity.</p>\n<p><img loading=\"lazy\" alt=\"Azure Container Apps - Resource Group\" src=\"https://luke.geek.nz/assets/images/AzureContainerApps_AzurePortal_ado-containerapp-rg-1934b5fbf126cb559156b84c4224fe49.png\" width=\"1794\" height=\"347\" class=\"img_ev3q\"></p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"prepare---azure-devops-agent-pool\">Prepare - Azure DevOps Agent Pool<a href=\"https://luke.geek.nz/azure/hosted-agents-container-apps-job#prepare---azure-devops-agent-pool\" class=\"hash-link\" aria-label=\"Direct link to Prepare - Azure DevOps Agent Pool\" title=\"Direct link to Prepare - Azure DevOps Agent Pool\">​</a></h3>\n<p>Before deploying anything into Azure, we must prepare our Azure DevOps environment.</p>\n<ol>\n<li>Login to your <strong><a href=\"https://aex.dev.azure.com/\" target=\"_blank\" rel=\"noopener noreferrer\">Azure DevOps</a></strong> organisation</li>\n<li>Click on <strong>Organization Settings</strong></li>\n<li>Click on <strong>Agent Pools</strong></li>\n<li>Click <strong>Add Pool</strong></li>\n<li>Select <strong>Self-hosted</strong></li>\n<li>Give the Agent pool a <strong>name</strong> <em>(ie containerapp-adoagent - we will need the name later in our Bicep code)</em></li>\n<li>Enter a description and click <strong>Create</strong></li>\n</ol>\n<p><img loading=\"lazy\" alt=\"Create Azure DevOps - Agent Pool\" src=\"https://luke.geek.nz/assets/images/AzureDevOps_CreateAgentPool_CAPPS-4c24c77aced2d7f1024ebe41a9276e9a.gif\" width=\"1893\" height=\"952\" class=\"img_ev3q\"></p>\n<p>Once the agent pool has been created, we need our token to allow the Agents to register to the Agent Pool we have just created.</p>\n<p><em>This token is a secret and will be stored in an Azure Key Vault as part of our deployment, allowing the secret to be protected from unauthorised people and allowing you to regenerate the secret when required by updating the key vault secret without having to redeploy any of the infrastructure.</em></p>\n<ol>\n<li>Login to your <strong><a href=\"https://aex.dev.azure.com/\" target=\"_blank\" rel=\"noopener noreferrer\">Azure DevOps</a></strong> organisation.</li>\n<li>Click on the little User icon at the top right <em>(next to your initials)</em></li>\n<li>Click on <strong>Personal Access Tokens</strong></li>\n<li>Click <strong>+ New Token</strong></li>\n<li>Type in a <strong>name</strong> <em>(ie JoinADOPool)</em></li>\n<li>Specify a valid <strong>expiration date</strong> <em>(for our demo purposes, we will go with 30 days)</em>.</li>\n<li>Click <strong>Show all scopes</strong></li>\n<li>Find <strong>Agent Pools</strong></li>\n<li>Click <strong>Read &amp; manage</strong></li>\n<li>Click <strong>Create</strong></li>\n<li>Copy the Token for later; if you lose this token before it can be uploaded to Key Vault, you will have to generate a new Token.</li>\n</ol>\n<p><img loading=\"lazy\" alt=\"Create Azure DevOps - Agent Pool\" src=\"https://luke.geek.nz/assets/images/AzureDevOps_CreatePATToken_CAPPS-f22f871f0c6d80f01dc0b94d8b139140.gif\" width=\"1893\" height=\"955\" class=\"img_ev3q\"></p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"deploy---azure-container-apps-environment\">Deploy - Azure Container Apps Environment<a href=\"https://luke.geek.nz/azure/hosted-agents-container-apps-job#deploy---azure-container-apps-environment\" class=\"hash-link\" aria-label=\"Direct link to Deploy - Azure Container Apps Environment\" title=\"Direct link to Deploy - Azure Container Apps Environment\">​</a></h3>\n<p>Now that we have our Azure DevOps Agent Pool and PAT token - it is time to deploy our Container Apps infrastructure.</p>\n<blockquote>\n<p>The <a href=\"https://learn.microsoft.com/azure/azure-resource-manager/templates/deployment-script-template?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">deployment scripts</a> used by this solution do not currently support Private Endpoints*(this is coming)*, so during the build process the Container Registry has Public endpoint enabled. This can be disabled after your initial build has been completed if required. If needed, you could add another deployment script to the Container Registry back to private at the end.\nIf this is the first time you have deployed Container Apps or Container Registry, you may need to register the <a href=\"https://learn.microsoft.com/azure/azure-resource-manager/management/resource-providers-and-types?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">providers</a>. This can be done with the following PowerShell commands, against your target subscription, else the deployment will fail:</p>\n</blockquote>\n<div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">Register-AzResourceProvider -ProviderNamespace Microsoft.ContainerRegistry</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">Register-AzResourceProvider -ProviderNamespace Microsoft.KeyVault</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>To proceed, I will use my GitHub Codespace to deploy the Bicep; you could either run your own Codespace if you need it or fork the code <a href=\"https://github.com/lukemurraynz/containerapps-selfhosted-agent\" target=\"_blank\" rel=\"noopener noreferrer\">lukemurraynz/containerapps-selfhosted</a> and run it locally or from the <a href=\"https://learn.microsoft.com/azure/cloud-shell/overview?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure CloudShell</a>. The repository will have any updated code.</p>\n<p>The Bicep code will be deployed as follows:</p>\n<div class=\"language-bicep codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockTitle_Ktv7\">main.bicep</div><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-bicep codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Define parameters</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// https://github.com/lukemurraynz/containerapps-selfhosted-agent</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">param</span><span class=\"token plain\"> location </span><span class=\"token datatype class-name\">string</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">resourceGroup</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">location</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token decorator\">@description</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'The location where the resources will be deployed. Based on the Resource Group location.'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">param</span><span class=\"token plain\"> poolName </span><span class=\"token datatype class-name\">string</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'containerapp-adoagent'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token decorator\">@description</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'The name of the Azure DevOps agent pool.'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token decorator\">@maxLength</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token number\">50</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">param</span><span class=\"token plain\"> containerregistryName </span><span class=\"token datatype class-name\">string</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'adoregistry'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token decorator\">@description</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'The name of the Azure Container Registry.'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">param</span><span class=\"token plain\"> adourl </span><span class=\"token datatype class-name\">string</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'https://dev.azure.com/contoso'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token decorator\">@description</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'The URL of the Azure DevOps organization.'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Don't include an end '/' in the URL. Else the ADO agent will fail to register.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token decorator\">@secure</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">param</span><span class=\"token plain\"> token </span><span class=\"token datatype class-name\">string</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'tokenstringhere'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token decorator\">@description</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'The personal access token (PAT) used to authenticate with Azure DevOps.'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">param</span><span class=\"token plain\"> imagename </span><span class=\"token datatype class-name\">string</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'adoagent:1.0'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token decorator\">@description</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'The name of the container image.'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">param</span><span class=\"token plain\"> managedenvname </span><span class=\"token datatype class-name\">string</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'cnapps'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token decorator\">@description</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'The name of the managed environment.'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">param</span><span class=\"token plain\"> containerappsspokevnetName </span><span class=\"token datatype class-name\">string</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'containerappsspokevnet'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token decorator\">@description</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'The name of the virtual network.'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">param</span><span class=\"token plain\"> userassignedminame </span><span class=\"token datatype class-name\">string</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'usrmi'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token decorator\">@description</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'The name of the managed environment.'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">param</span><span class=\"token plain\"> isProduction </span><span class=\"token datatype class-name\">bool</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token boolean\">true</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token decorator\">@description</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Determines whether the environment is production or development and updates Tag accordingly.'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Define tags</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">var</span><span class=\"token plain\"> tags </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">environment</span><span class=\"token operator\">:</span><span class=\"token plain\"> isProduction </span><span class=\"token operator\">?</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Production'</span><span class=\"token plain\"> </span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Development'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">createdBy</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Luke Murray'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token decorator\">@description</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Tags to apply to the resources.'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Define virtual network resource</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">var</span><span class=\"token plain\"> sharedServicesSubnet </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'sharedservices'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">addressPrefix</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'10.0.0.0/24'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">var</span><span class=\"token plain\"> containerAppsSubnet </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'containerappssnet'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">addressPrefix</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'10.0.2.0/23'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">resource</span><span class=\"token plain\"> containerappsspokevnet </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Network/virtualNetworks@2023-04-01'</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> containerappsspokevnetName</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">location</span><span class=\"token operator\">:</span><span class=\"token plain\"> location</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">tags</span><span class=\"token operator\">:</span><span class=\"token plain\"> tags</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">addressSpace</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token property\">addressPrefixes</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'10.0.0.0/16'</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">subnets</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token plain\"> sharedServicesSubnet</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">,</span><span class=\"token plain\"> containerAppsSubnet </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Define Key Vault resource</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">var</span><span class=\"token plain\"> keyvaultName </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'keyvault-ado'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">resource</span><span class=\"token plain\"> keyvault </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.KeyVault/vaults@2023-02-01'</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> keyvaultName</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">location</span><span class=\"token operator\">:</span><span class=\"token plain\"> location</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">tags</span><span class=\"token operator\">:</span><span class=\"token plain\"> tags</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">sku</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token property\">family</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'A'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'standard'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">tenantId</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">tenant</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">tenantId</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">networkAcls</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token property\">bypass</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'AzureServices'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token property\">defaultAction</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Deny'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token property\">ipRules</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token property\">virtualNetworkRules</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">enableRbacAuthorization</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token boolean\">true</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">accessPolicies</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">publicNetworkAccess</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Disabled'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">enableSoftDelete</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token boolean\">false</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Change SoftDelete to True for Production</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">enabledForTemplateDeployment</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token boolean\">true</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Define Key Vault secrets</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">var</span><span class=\"token plain\"> kvtokensecretName </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'personal-access-token'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">resource</span><span class=\"token plain\"> kvtokensecret </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.KeyVault/vaults/secrets@2023-02-01'</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> kvtokensecretName</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">parent</span><span class=\"token operator\">:</span><span class=\"token plain\"> keyvault</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">value</span><span class=\"token operator\">:</span><span class=\"token plain\"> token</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Define Private Endpoint resource</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">var</span><span class=\"token plain\"> kvprivatelinkName </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\">'pe-</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">${</span><span class=\"token interpolated-string interpolation expression\">keyvaultName</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\">'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">resource</span><span class=\"token plain\"> kvprivatelink </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Network/privateEndpoints@2023-04-01'</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> kvprivatelinkName</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">location</span><span class=\"token operator\">:</span><span class=\"token plain\"> location</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">tags</span><span class=\"token operator\">:</span><span class=\"token plain\"> tags</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">privateLinkServiceConnections</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'keyvault'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">privateLinkServiceId</span><span class=\"token operator\">:</span><span class=\"token plain\"> keyvault</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">id</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">groupIds</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'vault'</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">subnet</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token property\">id</span><span class=\"token operator\">:</span><span class=\"token plain\"> containerappsspokevnet</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">properties</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">subnets</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">id</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Define Private DNS Zone resource</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">var</span><span class=\"token plain\"> keyvaultdnszoneName </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'privatelink.vaultcore.azure.net'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">resource</span><span class=\"token plain\"> keyvaultdnszone </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Network/privateDnsZones@2020-06-01'</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> keyvaultdnszoneName</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">location</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'global'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Define Private DNS Zone Group resource</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">resource</span><span class=\"token plain\"> keyvaultprivatednszonegrp </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Network/privateEndpoints/privateDnsZoneGroups@2023-04-01'</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> keyvaultdnszoneName</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">parent</span><span class=\"token operator\">:</span><span class=\"token plain\"> kvprivatelink</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">privateDnsZoneConfigs</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'keyvault'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">privateDnsZoneId</span><span class=\"token operator\">:</span><span class=\"token plain\"> keyvaultdnszone</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">id</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Define Private DNS Zone VNet Link resource</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">resource</span><span class=\"token plain\"> keyVaultPrivateDnsZoneVnetLink </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Network/privateDnsZones/virtualNetworkLinks@2020-06-01'</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">uniqueString</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token plain\">keyvault</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">id</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">parent</span><span class=\"token operator\">:</span><span class=\"token plain\"> keyvaultdnszone</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">location</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'global'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">registrationEnabled</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token boolean\">false</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">virtualNetwork</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token property\">id</span><span class=\"token operator\">:</span><span class=\"token plain\"> containerappsspokevnet</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">id</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Define A record resource</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">resource</span><span class=\"token plain\"> aarecord </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Network/privateDnsZones/A@2020-06-01'</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> keyvaultName</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">parent</span><span class=\"token operator\">:</span><span class=\"token plain\"> keyvaultdnszone</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">aRecords</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token property\">ipv4Address</span><span class=\"token operator\">:</span><span class=\"token plain\"> kvprivatelink</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">properties</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">customDnsConfigs</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">ipAddresses</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">ttl</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token number\">300</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Define Managed Environment resource</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">resource</span><span class=\"token plain\"> cnapps </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.App/managedEnvironments@2023-05-01'</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> managedenvname</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">location</span><span class=\"token operator\">:</span><span class=\"token plain\"> location</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">tags</span><span class=\"token operator\">:</span><span class=\"token plain\"> tags</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">appLogsConfiguration</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token property\">destination</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'azure-monitor'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">vnetConfiguration</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token property\">infrastructureSubnetId</span><span class=\"token operator\">:</span><span class=\"token plain\"> containerappsspokevnet</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">properties</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">subnets</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">id</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token property\">internal</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token boolean\">true</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">zoneRedundant</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token boolean\">true</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Define Diagnostic Settings resource</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">resource</span><span class=\"token plain\"> cnappsdiag </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Insights/diagnosticSettings@2021-05-01-preview'</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'cnappsdiag'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">scope</span><span class=\"token operator\">:</span><span class=\"token plain\"> cnapps</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">logs</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token property\">categoryGroup</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'allLogs'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token property\">enabled</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token boolean\">true</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">metrics</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token property\">category</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'AllMetrics'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token property\">enabled</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token boolean\">true</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">workspaceId</span><span class=\"token operator\">:</span><span class=\"token plain\"> law</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">id</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Define Container Registry resource</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">resource</span><span class=\"token plain\"> containerregistry </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.ContainerRegistry/registries@2023-06-01-preview'</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> containerregistryName</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">location</span><span class=\"token operator\">:</span><span class=\"token plain\"> location</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">tags</span><span class=\"token operator\">:</span><span class=\"token plain\"> tags</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">identity</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">type</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'UserAssigned'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">userAssignedIdentities</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\">'</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">${</span><span class=\"token interpolated-string interpolation expression\">usrmi</span><span class=\"token interpolated-string interpolation expression punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token interpolated-string interpolation expression\">id</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\">'</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Identity required to allow Container Apps job to talk to the Registry.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">sku</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Premium'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">//Premium is required for private endpoint support.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">publicNetworkAccess</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Enabled'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">//Required for the Deployment Scripts to build the images. Public Network access, can be disabled after.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">networkRuleBypassOptions</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'AzureServices'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">adminUserEnabled</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token boolean\">false</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Define Private DNS Zone resource for Container registry</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Define Private DNS Zone resource</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">var</span><span class=\"token plain\"> containerregistrydnszoneName </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'privatelink.azurecr.io'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">resource</span><span class=\"token plain\"> containerregistrydnszone </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Network/privateDnsZones@2020-06-01'</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> containerregistrydnszoneName</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">location</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'global'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Define Private DNS Zone Group resource</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">resource</span><span class=\"token plain\"> containerregistrydnszonegrp </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Network/privateEndpoints/privateDnsZoneGroups@2023-04-01'</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> containerregistrydnszoneName</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">parent</span><span class=\"token operator\">:</span><span class=\"token plain\"> conregprivatelink</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">privateDnsZoneConfigs</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'containerregistry'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">privateDnsZoneId</span><span class=\"token operator\">:</span><span class=\"token plain\"> containerregistrydnszone</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">id</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Define Private Endpoint resource</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">var</span><span class=\"token plain\"> containerregistryprivatelinkName </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\">'pe-</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">${</span><span class=\"token interpolated-string interpolation expression\">containerregistry</span><span class=\"token interpolated-string interpolation expression punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token interpolated-string interpolation expression\">name</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\">'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">resource</span><span class=\"token plain\"> conregprivatelink </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Network/privateEndpoints@2023-04-01'</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> containerregistryprivatelinkName</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">location</span><span class=\"token operator\">:</span><span class=\"token plain\"> location</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">tags</span><span class=\"token operator\">:</span><span class=\"token plain\"> tags</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">privateLinkServiceConnections</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'registry'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">privateLinkServiceId</span><span class=\"token operator\">:</span><span class=\"token plain\"> containerregistry</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">id</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">groupIds</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'registry'</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">subnet</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token property\">id</span><span class=\"token operator\">:</span><span class=\"token plain\"> containerappsspokevnet</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">properties</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">subnets</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">id</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Define Private DNS Zone VNet Link resource</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">resource</span><span class=\"token plain\"> containerregistryPrivateDnsZoneVnetLink </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Network/privateDnsZones/virtualNetworkLinks@2020-06-01'</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">uniqueString</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token plain\">containerregistry</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">id</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">parent</span><span class=\"token operator\">:</span><span class=\"token plain\"> containerregistrydnszone</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">location</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'global'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">registrationEnabled</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token boolean\">false</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">virtualNetwork</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token property\">id</span><span class=\"token operator\">:</span><span class=\"token plain\"> containerappsspokevnet</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">id</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Define A record resource</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">resource</span><span class=\"token plain\"> containerregistryarc </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Network/privateDnsZones/A@2020-06-01'</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> containerregistry</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">name</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">parent</span><span class=\"token operator\">:</span><span class=\"token plain\"> containerregistrydnszone</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">aRecords</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token property\">ipv4Address</span><span class=\"token operator\">:</span><span class=\"token plain\"> kvprivatelink</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">properties</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">customDnsConfigs</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">ipAddresses</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">ttl</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token number\">300</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Define User Assigned Managed Identity resource</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// The user managed identity associated with the container app job needs to have the following permissions to run this script:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// 1. Secret Reader to access the Key Vault secrets.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// 2. Contributor role on the container registry resource to push the container image.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// 3. Contributor role on the managed environment resource to create the job.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// 4. Contributor role on the log analytics workspace resource to enable diagnostic settings.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// 5. Contributor role on the virtual network resource to create the private endpoint.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// 6. Contributor role on the private DNS zone resource to create the A record.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// You can grant these permissions by adding the managed identity to the appropriate role assignments in Azure.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">resource</span><span class=\"token plain\"> usrmi </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.ManagedIdentity/userAssignedIdentities@2023-01-31'</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">existing</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> userassignedminame</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Define Log Analytics Workspace resource</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">var</span><span class=\"token plain\"> lawName </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\">'law-</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">${</span><span class=\"token interpolated-string interpolation expression function\" style=\"color:rgb(80, 250, 123)\">uniqueString</span><span class=\"token interpolated-string interpolation expression punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token interpolated-string interpolation expression function\" style=\"color:rgb(80, 250, 123)\">resourceGroup</span><span class=\"token interpolated-string interpolation expression punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token interpolated-string interpolation expression punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token interpolated-string interpolation expression punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token interpolated-string interpolation expression\">id</span><span class=\"token interpolated-string interpolation expression punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\">'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">resource</span><span class=\"token plain\"> law </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.OperationalInsights/workspaces@2022-10-01'</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> lawName</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">location</span><span class=\"token operator\">:</span><span class=\"token plain\"> location</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">tags</span><span class=\"token operator\">:</span><span class=\"token plain\"> tags</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">sku</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'PerGB2018'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">retentionInDays</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token number\">30</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">publicNetworkAccessForIngestion</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Enabled'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">publicNetworkAccessForQuery</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Enabled'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Define Deployment Script resource for ACR build</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">var</span><span class=\"token plain\"> arcbuildName </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'acrbuild'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">resource</span><span class=\"token plain\"> arcbuild </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Resources/deploymentScripts@2020-10-01'</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> arcbuildName</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">location</span><span class=\"token operator\">:</span><span class=\"token plain\"> location</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">tags</span><span class=\"token operator\">:</span><span class=\"token plain\"> tags</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">kind</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'AzureCLI'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">identity</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">type</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'UserAssigned'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">userAssignedIdentities</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\">'</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">${</span><span class=\"token interpolated-string interpolation expression\">usrmi</span><span class=\"token interpolated-string interpolation expression punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token interpolated-string interpolation expression\">id</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\">'</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">azCliVersion</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'2.50.0'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">retentionInterval</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'P1D'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">timeout</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'PT30M'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">arguments</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\">'</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">${</span><span class=\"token interpolated-string interpolation expression\">containerregistryName</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\"> </span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">${</span><span class=\"token interpolated-string interpolation expression\">imagename</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\">'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">scriptContent</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'''</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">    az login --identity</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">    az acr build --registry $1 --image $2  --file Dockerfile.azure-pipelines https://github.com/lukemurraynz/containerapps-selfhosted-agent.git</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">    '''</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">cleanupPreference</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'OnSuccess'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Define Deployment Script resource for ACR placeholder</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">var</span><span class=\"token plain\"> arcplaceholderName </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'arcplaceholder'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">resource</span><span class=\"token plain\"> arcplaceholder </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Resources/deploymentScripts@2020-10-01'</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> arcplaceholderName</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">location</span><span class=\"token operator\">:</span><span class=\"token plain\"> location</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">tags</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">union</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token plain\">tags</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">,</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"> Note</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Can be deleted after original ADO registration (along with the Placeholder Job). Although the Azure resource can be deleted, Agent placeholder in ADO cannot be.'</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">kind</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'AzureCLI'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">identity</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">type</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'UserAssigned'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">userAssignedIdentities</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\">'</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">${</span><span class=\"token interpolated-string interpolation expression\">usrmi</span><span class=\"token interpolated-string interpolation expression punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token interpolated-string interpolation expression\">id</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\">'</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">azCliVersion</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'2.50.0'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">retentionInterval</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'P1D'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">timeout</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'PT30M'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">arguments</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\">'</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">${</span><span class=\"token interpolated-string interpolation expression\">containerregistryName</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\"> </span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">${</span><span class=\"token interpolated-string interpolation expression\">imagename</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\"> </span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">${</span><span class=\"token interpolated-string interpolation expression\">poolName</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\"> </span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">${</span><span class=\"token interpolated-string interpolation expression function\" style=\"color:rgb(80, 250, 123)\">resourceGroup</span><span class=\"token interpolated-string interpolation expression punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token interpolated-string interpolation expression punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token interpolated-string interpolation expression punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token interpolated-string interpolation expression\">name</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\"> </span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">${</span><span class=\"token interpolated-string interpolation expression\">adourl</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\"> </span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">${</span><span class=\"token interpolated-string interpolation expression\">token</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\"> </span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">${</span><span class=\"token interpolated-string interpolation expression\">managedenvname</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\"> </span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">${</span><span class=\"token interpolated-string interpolation expression\">usrmi</span><span class=\"token interpolated-string interpolation expression punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token interpolated-string interpolation expression\">id</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\">'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">scriptContent</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'''</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">    az login --identity</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">    az extension add --name containerapp --upgrade --only-show-errors</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">    az containerapp job create -n 'placeholder' -g $4 --environment $7 --trigger-type Manual --replica-timeout 300 --replica-retry-limit 1 --replica-completion-count 1 --parallelism 1 --image \"$1.azurecr.io/$2\" --cpu \"2.0\" --memory \"4Gi\" --secrets \"personal-access-token=$6\" \"organization-url=$5\" --env-vars \"AZP_TOKEN=$6\" \"AZP_URL=$5\" \"AZP_POOL=$3\" \"AZP_PLACEHOLDER=1\" \"AZP_AGENT_NAME=dontdelete-placeholder-agent\" --registry-server \"$1.azurecr.io\" --registry-identity \"$8\"  </span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">    az containerapp job start -n \"placeholder\" -g $4</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">    '''</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">cleanupPreference</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'OnSuccess'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">dependsOn</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    arcbuild</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    cnapps</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    cnappsdiag</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// Define App Service Job resource for ADO agent</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">var</span><span class=\"token plain\"> adoagentjobName </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'adoagentjob'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">resource</span><span class=\"token plain\"> adoagentjob </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.App/jobs@2023-05-01'</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> adoagentjobName</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">location</span><span class=\"token operator\">:</span><span class=\"token plain\"> location</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">tags</span><span class=\"token operator\">:</span><span class=\"token plain\"> tags</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">identity</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">type</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'UserAssigned'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">userAssignedIdentities</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\">'</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">${</span><span class=\"token interpolated-string interpolation expression\">usrmi</span><span class=\"token interpolated-string interpolation expression punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token interpolated-string interpolation expression\">id</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\">'</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">environmentId</span><span class=\"token operator\">:</span><span class=\"token plain\"> cnapps</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">id</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">configuration</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token property\">triggerType</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Event'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token property\">secrets</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'personal-access-token'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">keyVaultUrl</span><span class=\"token operator\">:</span><span class=\"token plain\"> kvtokensecret</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">properties</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">secretUri</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">identity</span><span class=\"token operator\">:</span><span class=\"token plain\"> usrmi</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">id</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'organization-url'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">value</span><span class=\"token operator\">:</span><span class=\"token plain\"> adourl</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'azp-pool'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">value</span><span class=\"token operator\">:</span><span class=\"token plain\"> poolName</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token property\">replicaTimeout</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token number\">1800</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token property\">replicaRetryLimit</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token number\">1</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token property\">eventTriggerConfig</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token property\">replicaCompletionCount</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token number\">1</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token property\">parallelism</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token number\">1</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token property\">scale</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">minExecutions</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token number\">0</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">maxExecutions</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token number\">10</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">pollingInterval</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token number\">30</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">rules</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">            </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">              </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'azure-pipelines'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">              </span><span class=\"token property\">type</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'azure-pipelines'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">              </span><span class=\"token comment\" style=\"color:rgb(98, 114, 164)\">// https://keda.sh/docs/2.11/scalers/azure-pipelines/</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">              </span><span class=\"token property\">metadata</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">                </span><span class=\"token property\">poolName</span><span class=\"token operator\">:</span><span class=\"token plain\"> poolName</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">                </span><span class=\"token property\">targetPipelinesQueueLength</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'1'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">              </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">              </span><span class=\"token property\">auth</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">                </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">                  </span><span class=\"token property\">secretRef</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'personal-access-token'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">                  </span><span class=\"token property\">triggerParameter</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'personalAccessToken'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">                </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">                </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">                  </span><span class=\"token property\">secretRef</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'organization-url'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">                  </span><span class=\"token property\">triggerParameter</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'organizationURL'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">                </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">              </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">            </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token property\">registries</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">server</span><span class=\"token operator\">:</span><span class=\"token plain\"> containerregistry</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">properties</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">loginServer</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">identity</span><span class=\"token operator\">:</span><span class=\"token plain\"> usrmi</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">id</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">template</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token property\">containers</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">image</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\">'</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">${</span><span class=\"token interpolated-string interpolation expression\">containerregistry</span><span class=\"token interpolated-string interpolation expression punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token interpolated-string interpolation expression\">properties</span><span class=\"token interpolated-string interpolation expression punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token interpolated-string interpolation expression\">loginServer</span><span class=\"token interpolated-string interpolation punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token interpolated-string string\" style=\"color:rgb(255, 121, 198)\">/adoagent:1.0'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'adoagent'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">env</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">            </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">              </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'AZP_TOKEN'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">              </span><span class=\"token property\">secretRef</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'personal-access-token'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">            </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">            </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">              </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'AZP_URL'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">              </span><span class=\"token property\">secretRef</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'organization-url'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">            </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">            </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">              </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'AZP_POOL'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">              </span><span class=\"token property\">secretRef</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'azp-pool'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">            </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">resources</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">            </span><span class=\"token property\">cpu</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token number\">2</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">            </span><span class=\"token property\">memory</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'4Gi'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">dependsOn</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    arcplaceholder</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    cnappsdiag</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>We will need our Azure DevOps token created earlier, the name of the Agent Pool and the Azure DevOps URL.</p>\n<p>We can adjust the parameters to suit our environment and deploy.</p>\n<p><em>The token is classified as a secure value, so although it is visible in plain text here, it will not be parsed through in the deployment logs.</em></p>\n<p>Verify that the Resource Group and the User-Assigned managed identity exist with appropriate permissions.</p>\n<ol>\n<li>Open the <strong>Codespace</strong></li>\n<li>Navigate to the <strong>IaC</strong> folder and select main.bicep</li>\n<li>Select the <strong><a href=\"https://luke.geek.nz/azure/Azure-Bicep-Deploy-Pane/\" target=\"_blank\" rel=\"noopener noreferrer\">Deployment Pane</a></strong> <em>(top right)</em></li>\n<li>Select your <strong>Scope</strong> - i.e. the Resource Group you will want to deploy to; you will need to log in with your Azure credentials</li>\n<li><strong>Update the parameters</strong>, such as your ADO URL <em>(make sure it doesn't include an end '/')</em>, token and Agent Pool, and add the name of your user assigned managed identity.</li>\n<li>Click <strong>Validate</strong> to validate that Bicep code syntax is correct, then click <strong>Deploy</strong></li>\n</ol>\n<p>The bicep code will now do the following:</p>\n<ul>\n<li>Create Azure Virtual Network</li>\n<li>Create Azure Key Vault and private link to the virtual network</li>\n<li>Create DNS zone for Key Vault</li>\n<li>Create a Container Registry and a private link to the virtual network</li>\n<li>Create DNS zone for container registry</li>\n<li>Places the token into a Key Vault secret</li>\n<li>Run a deployment script, which will build the Azure DevOps Agent Container image from the following docker file: <a href=\"https://github.com/lukemurraynz/containerapps-selfhosted-agent/blob/main/Dockerfile.azure-pipelines\" target=\"_blank\" rel=\"noopener noreferrer\">containerapps-selfhosted-agent/Dockerfile.azure-pipelines</a></li>\n<li>Create the Consumption Container Apps environment</li>\n<li>Create a Log Analytics workspace and attach it to the Container Apps environment as a diagnostic setting</li>\n<li>Run a deployment script that runs the acrbuild command to deploy the placeholder Azure DevOps agent</li>\n<li>Creates the Azure Container Apps job, used for DevOps agents, with the azure-pipelines KEDA scaler configuration.</li>\n</ul>\n<p><img loading=\"lazy\" alt=\"Create Azure DevOps - Agent Pool\" src=\"https://luke.geek.nz/assets/images/Create_AzureContainerApps_BicepCodeSpace-d858e16d90e2d6218391f22dd7505d24.gif\" width=\"1887\" height=\"941\" class=\"img_ev3q\"></p>\n<p><em>In my testing, end-to-end deployment seemed to range between 12 to 15 minutes.</em></p>\n<p>To validate it worked, you can go into the Azure DevOps and Agent Pools, and you should now have a placeholder agent. This agent needs to stay to keep the Agent pool active but can be toggled to Disabled.</p>\n<p><img loading=\"lazy\" alt=\"Create Azure DevOps - Agent Pool\" src=\"https://luke.geek.nz/assets/images/AzureDevOps_ContainerApp_AgentPlaceholder-e8a02d5a0dcc505639450285c0d4dcea.png\" width=\"1278\" height=\"278\" class=\"img_ev3q\"></p>\n<p>Once deployed, you can go into the Container Registry, Networking blade and change Public network access to Disabled. You can also delete the DeploymentScript resources, as these are no longer required.</p>\n<p><img loading=\"lazy\" alt=\"Public Access disabled - Container Registry\" src=\"https://luke.geek.nz/assets/images/AzureContainerRegistry_PublicAccess_Disabled-fb55b477234d1fb7b96375227f025aaa.png\" width=\"656\" height=\"323\" class=\"img_ev3q\"></p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"testing\">Testing<a href=\"https://luke.geek.nz/azure/hosted-agents-container-apps-job#testing\" class=\"hash-link\" aria-label=\"Direct link to Testing\" title=\"Direct link to Testing\">​</a></h2>\n<p>To test that it is working - I have deployed a Virtual Machine into the sharedservices subnet with RDP open internally.</p>\n<p>Let's import a test Azure pipeline to test that the event scaling is working and that the Container App job can communicate with internal resources.</p>\n<div class=\"language-yml codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockTitle_Ktv7\">azure-pipelines.yml</div><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-yml codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token key atrule\">trigger</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">-</span><span class=\"token plain\"> main</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token key atrule\">pool</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token key atrule\">name</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> containerapp</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">-</span><span class=\"token plain\">adoagent</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token key atrule\">jobs</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">-</span><span class=\"token plain\"> </span><span class=\"token key atrule\">job</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> Setup</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token key atrule\">displayName</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> Get Environment </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">-</span><span class=\"token plain\"> Linux</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">-</span><span class=\"token plain\"> </span><span class=\"token key atrule\">job</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> GetIPAddress</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token key atrule\">displayName</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> Get IP Address</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token key atrule\">dependsOn</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> Setup</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token key atrule\">steps</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">-</span><span class=\"token plain\"> </span><span class=\"token key atrule\">script</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> echo Hello</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">,</span><span class=\"token plain\"> world</span><span class=\"token tag\" style=\"color:rgb(255, 121, 198)\">!</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token key atrule\">displayName</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Run a one-line script'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">-</span><span class=\"token plain\"> </span><span class=\"token key atrule\">bash</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">|</span><span class=\"token scalar string\" style=\"color:rgb(255, 121, 198)\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token scalar string\" style=\"color:rgb(255, 121, 198)\">      apt install net-tools -y</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token scalar string\" style=\"color:rgb(255, 121, 198)\">      Current_IP=$(curl ipinfo.io/ip)</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token scalar string\" style=\"color:rgb(255, 121, 198)\">      echo \"Current IP address is: $Current_IP\"</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token scalar string\" style=\"color:rgb(255, 121, 198)\">      echo \"##vso[task.setvariable variable=IP_ADDR;isOutput=true]$Current_IP\"</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token scalar string\" style=\"color:rgb(255, 121, 198)\">      ifconfig</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token scalar string\" style=\"color:rgb(255, 121, 198)\">      hostname</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token key atrule\">displayName</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> Get IP on Linux</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">-</span><span class=\"token plain\"> </span><span class=\"token key atrule\">job</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> CheckRDP</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token key atrule\">displayName</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> Check RDP Port  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">-</span><span class=\"token plain\"> PowerShell</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token key atrule\">dependsOn</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> GetIPAddress</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token key atrule\">steps</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">-</span><span class=\"token plain\"> </span><span class=\"token key atrule\">script</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">|</span><span class=\"token scalar string\" style=\"color:rgb(255, 121, 198)\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token scalar string\" style=\"color:rgb(255, 121, 198)\">      # Check if PowerShell is installed, and if not, install it</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token scalar string\" style=\"color:rgb(255, 121, 198)\">      if ! command -v pwsh &amp;&gt; /dev/null; then</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token scalar string\" style=\"color:rgb(255, 121, 198)\">          echo \"PowerShell is not installed. Installing PowerShell...\"</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token scalar string\" style=\"color:rgb(255, 121, 198)\">          apt-get install wget</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token scalar string\" style=\"color:rgb(255, 121, 198)\">          # Install PowerShell Core</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token scalar string\" style=\"color:rgb(255, 121, 198)\">          wget https://packages.microsoft.com/config/ubuntu/20.04/packages-microsoft-prod.deb -O packages-microsoft-prod.deb</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token scalar string\" style=\"color:rgb(255, 121, 198)\">          dpkg -i packages-microsoft-prod.deb</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token scalar string\" style=\"color:rgb(255, 121, 198)\">          apt-get update</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token scalar string\" style=\"color:rgb(255, 121, 198)\">          apt-get install -y powershell</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token scalar string\" style=\"color:rgb(255, 121, 198)\">      else</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token scalar string\" style=\"color:rgb(255, 121, 198)\">          echo \"PowerShell is already installed.\"</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token scalar string\" style=\"color:rgb(255, 121, 198)\">      fi</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token key atrule\">displayName</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> Install PowerShell if not installed</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">-</span><span class=\"token plain\"> </span><span class=\"token key atrule\">powershell</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">|</span><span class=\"token scalar string\" style=\"color:rgb(255, 121, 198)\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token scalar string\" style=\"color:rgb(255, 121, 198)\">      $IP_ADDR = $env:IP_ADDR</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token scalar string\" style=\"color:rgb(255, 121, 198)\">      $Target_IP = \"10.0.0.5\"</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token scalar string\" style=\"color:rgb(255, 121, 198)\">      $Port = '3389'</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token scalar string\" style=\"color:rgb(255, 121, 198)\">      $connection = New-Object System.Net.Sockets.TcpClient($Target_IP, $Port)</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token scalar string\" style=\"color:rgb(255, 121, 198)\">      if ($connection.Connected) { Write-Host \"Success\"   } else {   Write-Host \"Failed\"  }</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token key atrule\">displayName</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">:</span><span class=\"token plain\"> Check RDP Port</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<ol>\n<li>Login to your <strong><a href=\"https://aex.dev.azure.com/\" target=\"_blank\" rel=\"noopener noreferrer\">Azure DevOps</a></strong> organisation.</li>\n<li>Navigate to a <strong>repository</strong> that you can test <em>(create one if it doesn't exist and initialize it)</em>.</li>\n<li>Create a new file called <strong>azure-pipelines.yml</strong>, and copy the pipeline into it.</li>\n<li>Note: I am not talking from experience or anything, but make sure you <strong>update the RDP IP</strong> to make sure it's a valid destination IP in the YML.</li>\n<li>You can then navigate to <strong>Pipelines</strong></li>\n<li><strong>Import Pipeline</strong></li>\n<li><strong>Run</strong></li>\n</ol>\n<p><img loading=\"lazy\" alt=\"Run Azure DevOps - Agent Pool\" src=\"https://luke.geek.nz/assets/images/Run_AzureContainerApps_Agent-168b5b867933d31dd2f14e713357aa07.gif\" width=\"1887\" height=\"941\" class=\"img_ev3q\"></p>\n<p>As the Container App agent runs, the Container App Job will execute (in some cases, multiple job instances will be spawned to fulfil your pipeline needs across multiple parallel jobs and tasks), and the resources get spawned in Azure.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"logging\">Logging<a href=\"https://luke.geek.nz/azure/hosted-agents-container-apps-job#logging\" class=\"hash-link\" aria-label=\"Direct link to Logging\" title=\"Direct link to Logging\">​</a></h2>\n<p>The Container App Environment logs are stored in the Log Analytics workspace.</p>\n<ol>\n<li>Login to the <strong>Azure Portal</strong></li>\n<li>Navigate to the <strong>Log Analytics workspace</strong> created <em>(i.e. law-jcdbxrheta7ug)</em></li>\n<li>Navigate to <strong>Logs</strong></li>\n<li>The default logs rules look for an incorrect table <em>(ContainerAppConsoleLogs_CL)</em>.</li>\n<li>To retrieve the Logs, click on <strong>Category</strong> and uncollapse <strong>Azure Resources</strong></li>\n</ol>\n<p>Table names are called:</p>\n<ul>\n<li>ContainerAppSystemLogs</li>\n<li>ContainerAppConsoleLogs</li>\n</ul>\n<p><img loading=\"lazy\" alt=\"Run Azure DevOps - Agent Pool\" src=\"https://luke.geek.nz/assets/images/Run_AzureContainerApps_LogAnalytics-7bc345cd7c1516ca4c84b452a83f7cfa.gif\" width=\"1887\" height=\"941\" class=\"img_ev3q\"></p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"additional-reading\">Additional Reading<a href=\"https://luke.geek.nz/azure/hosted-agents-container-apps-job#additional-reading\" class=\"hash-link\" aria-label=\"Direct link to Additional Reading\" title=\"Direct link to Additional Reading\">​</a></h2>\n<ul>\n<li>A great tutorial exists to use Azure CLI to build the self-hosted Azure DevOps and GitHub Runners: <a href=\"https://learn.microsoft.com/azure/container-apps/tutorial-ci-cd-runners-jobs?tabs=bash&amp;pivots=container-apps-jobs-self-hosted-ci-cd-azure-pipelines&amp;WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Tutorial: Deploy self-hosted CI/CD runners and agents with Azure Container Apps jobs</a></li>\n<li><a href=\"https://learn.microsoft.com/azure/container-apps/jobs?tabs=azure-cli&amp;WT.mc_id=AZ-MVP-5004796#event-driven-jobs\" target=\"_blank\" rel=\"noopener noreferrer\">Jobs in Azure Container Apps</a></li>\n<li><a href=\"https://keda.sh/\" target=\"_blank\" rel=\"noopener noreferrer\">KEDA - Kubernetes Event-driven Autoscaling</a></li>\n</ul>",
            "url": "https://luke.geek.nz/azure/hosted-agents-container-apps-job",
            "title": "Get Ahead with Self-Hosted Agents and Container Apps Jobs",
            "summary": "When considering build agents to use in Azure DevOps (or GitHub), there are 2 main options to consider:",
            "date_modified": "2023-09-13T00:00:00.000Z",
            "author": {
                "name": "Luke Murray",
                "url": "https://luke.geek.nz"
            },
            "tags": [
                "Azure"
            ]
        },
        {
            "id": "https://luke.geek.nz/azure/Azure-Bicep-Deployment-with-Deployment-Stacks",
            "content_html": "<p><a href=\"https://learn.microsoft.com/azure/azure-resource-manager/bicep/deployment-stacks?tabs=azure-powershell&amp;WT.mc*id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Deployment Stacks</a>! What is it? <em>insert confused look</em></p>\n<p>Maybe you have been browsing the Microsoft Azure Portal and noticed a new section in the management blade called: Deployment stacks and wondered what it was, and how you can use it.</p>\n<p>Let us take a look!</p>\n<blockquote>\n<p>Before we get started its worth noting that as of the time of this article, this feature is under Public Preview. Features or ways of working with Deployment Stacks may change, when it becomes generally available. If you run into issues, make sure you have a look at the current <a href=\"https://learn.microsoft.com/en-us/azure/azure-resource-manager/bicep/deployment-stacks?tabs=azure-powershell&amp;WT.mc*id=AZ-MVP-5004796#known-issues\" target=\"_blank\" rel=\"noopener noreferrer\">known issues</a>.</p>\n</blockquote>\n<p><img loading=\"lazy\" alt=\"Automate your Azure Bicep deployment with ease using Deployment Stacks\" src=\"https://luke.geek.nz/assets/images/Blog-Header-AzureDeploymentStacks-564504ae73ac88f9d1e0596f5c6ab693.gif\" width=\"1200\" height=\"628\" class=\"img_ev3q\"></p>\n<h5 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"overview\">Overview<a href=\"https://luke.geek.nz/azure/Azure-Bicep-Deployment-with-Deployment-Stacks#overview\" class=\"hash-link\" aria-label=\"Direct link to Overview\" title=\"Direct link to Overview\">​</a></h5>\n<p><a href=\"https://learn.microsoft.com/azure/azure-resource-manager/bicep/deployment-stacks?tabs=azure-powershell&amp;WT.mc*id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Deployment Stacks</a> are a type of Azure resource that allows you to manage a group of Azure resources as an atomic unit.</p>\n<p>When you submit a Bicep file or an ARM template to a deployment stack, it defines the resources that are managed by the stack.</p>\n<p>You can create and update deployment stacks using Azure CLI, Azure PowerShell, or the Azure portal along with Bicep files. These Bicep files are transpiled into ARM JSON templates, which are then deployed as a deployment object by the stack.</p>\n<p>Deployment stacks offer additional capabilities beyond regular deployment resources, such as simplified provisioning and management of resources, preventing undesired modifications to managed resources, efficient environment cleanup, and the ability to utilize standard templates like Bicep, ARM templates, or Template specs.</p>\n<blockquote>\n<p>When planning your deployment and determining which resource groups should be part of the same stack, it's important to consider the management lifecycle of those resources, which includes creation, updating, and deletion. For instance, suppose you need to provision some test VMs for various application teams across different resource group scopes.</p>\n</blockquote>\n<h5 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"comparisons\">Comparisons<a href=\"https://luke.geek.nz/azure/Azure-Bicep-Deployment-with-Deployment-Stacks#comparisons\" class=\"hash-link\" aria-label=\"Direct link to Comparisons\" title=\"Direct link to Comparisons\">​</a></h5>\n<p>Before we dig into it further, it may help to give you a comparison between the different products and where Deployment Stacks, could be used, lets us take a look at a comparison, between similar products, that may come to mind, such as:</p>\n<ul>\n<li>Azure Blueprints</li>\n<li>Bicep <em>(on its own)</em></li>\n<li>Template Specs</li>\n<li>Terraform</li>\n</ul>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<table><thead><tr><th>Feature</th><th>Deployment Stacks</th><th>Azure Blueprints</th><th>Using Bicep</th><th>Template Specs</th><th>Terraform</th></tr></thead><tbody><tr><td>Management of Resources</td><td>Manages a group of Azure resources as an atomic unit.</td><td>Defines and deploys a repeatable set of Azure resources that adhere to organizational standards.</td><td>Defines and deploys Azure resources using a declarative language.</td><td>Defines and deploys reusable infrastructure code using template specs.</td><td>Defines and provisions infrastructure resources across various cloud providers using a declarative language.</td></tr><tr><td>Resource Definition</td><td>Bicep files or ARM JSON templates are used to define the resources managed by the stack.</td><td>Blueprint artifacts, including ARM templates, policy assignments, role assignments, and resource groups, are used to define the blueprint.</td><td>Bicep files are used to define the Azure resources.</td><td>Template specs are used to define reusable infrastructure code.</td><td>Terraform configuration files are used to define the infrastructure resources.</td></tr><tr><td>Access Control</td><td>Access to the deployment stack can be restricted using Azure role-based access control (Azure RBAC).</td><td>Access to blueprints is managed through Azure role-based access control (Azure RBAC).</td><td>Access to Azure resources is managed through Azure role-based access control (Azure RBAC).</td><td>Access to template specs is managed through Azure role-based access control (Azure RBAC).</td><td>Access to cloud resources is managed through provider-specific authentication mechanisms.</td></tr><tr><td>Benefits</td><td><em>Simplified provisioning and management of resources as a cohesive entity.</em>  Preventing undesired modifications to managed resources.*Efficient environment cleanup.*Utilizing standard templates such as Bicep, ARM templates, or Template specs for your deployment stacks.</td><td><em>Rapidly build and start up new environments with organizational compliance.</em>  Built-in components for speeding up development and delivery.</td><td>*Easier management and deployment of Azure resources.*Improved readability and understanding of resource configurations.</td><td>*  Publish libraries of reusable infrastructure code.</td><td>*  Infrastructure-as-Code approach for provisioning resources across multiple cloud providers.</td></tr><tr><td>Deprecation</td><td>N/A</td><td>Azure Blueprints (Preview) will be deprecated.</td><td>N/A</td><td>N/A</td><td>N/A</td></tr></tbody></table>\n<p><em>It is always recommended to refer to the <a href=\"https://learn.microsoft.com/?WT.mc*id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">official documentation</a> for the most up-to-date and comprehensive information. The comparison table above, was created with the help of AI.</em></p>\n<p>It is hard to do a complete comparison, as always 'it depends' on your use cases and requirements, but hopefully this makes it clear where Deployment Stacks come into play (and it does not replace Bicep but works with it for better governance), with out-of-the-box benefits such as:</p>\n<ul>\n<li>Simplified provisioning and management of resources across different scopes as a cohesive entity.</li>\n<li>Preventing undesired modifications to managed resources through deny settings.</li>\n<li>Efficient environment cleanup by employing delete flags during deployment stack updates.</li>\n<li>Utilizing standard templates such as Bicep, ARM templates, or Template specs for your deployment stacks.</li>\n</ul>\n<blockquote>\n<p>The key here is that Azure Deployment Stacks, is a native way to treat your infrastructure components as an atmonic unit or stack, so you manage the lifecycle of the resources as a whole vs every resource separately.</p>\n</blockquote>\n<h5 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"using-deployment-stacks\">Using Deployment Stacks<a href=\"https://luke.geek.nz/azure/Azure-Bicep-Deployment-with-Deployment-Stacks#using-deployment-stacks\" class=\"hash-link\" aria-label=\"Direct link to Using Deployment Stacks\" title=\"Direct link to Using Deployment Stacks\">​</a></h5>\n<p>Deployment stacks requires <a href=\"https://learn.microsoft.com/powershell/azure/install-azure-powershell?WT.mc*id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure PowerShell</a> <em>(version 10.1.0 or later)</em> or <a href=\"https://learn.microsoft.com/cli/azure/install-azure-cli?WT.mc*id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure CLI</a> <em>(version 2.50.0 or later)</em>.</p>\n<p>For the purposes of this article, I will be using PowerShell.</p>\n<h6 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"powershell\">PowerShell<a href=\"https://luke.geek.nz/azure/Azure-Bicep-Deployment-with-Deployment-Stacks#powershell\" class=\"hash-link\" aria-label=\"Direct link to PowerShell\" title=\"Direct link to PowerShell\">​</a></h6>\n<p>Once you have the latest Azure PowerShell modules, its time to take a look at the cmdlets, that are offered to us for Deployment Stacks.</p>\n<p>Open your PowerShell terminal and type in:</p>\n<div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">Get-Command -Name *DeploymentStack*</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p><img loading=\"lazy\" alt=\"Get-Command -Name DeploymentStack\" src=\"https://luke.geek.nz/assets/images/DeploymentStacks-PowerShellCmdlets-026dd255d9fafc37ec418ee45204b5a6.gif\" width=\"1025\" height=\"309\" class=\"img_ev3q\">\nAs you can see, there are a range of cmdlets we have to work with.</p>\n<p>For the purpose of this article, I will be using a Bicep file, I already have on hand (unmodified for Deployment Stacks). This bicep file will create:</p>\n<ul>\n<li>2 Virtual Networks</li>\n<li>4 Subnets <em>(2 subnets in each Virtual Network)</em></li>\n<li>4 NSGs <em>(and assign to each subnet, with Deny All rules)</em></li>\n<li>Then finally, peer the virtual networks.</li>\n</ul>\n<p>This is the Bicep file:</p>\n<div class=\"language-bicep codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockTitle_Ktv7\">main.bicep</div><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-bicep codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token decorator\">@description</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Name of the virtual network.'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">param</span><span class=\"token plain\"> vnetName </span><span class=\"token datatype class-name\">string</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'myVnet'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token decorator\">@description</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Name of the first subnet.'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">param</span><span class=\"token plain\"> subnet1Name </span><span class=\"token datatype class-name\">string</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'subnet1'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token decorator\">@description</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Name of the second subnet.'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">param</span><span class=\"token plain\"> subnet2Name </span><span class=\"token datatype class-name\">string</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'subnet2'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token decorator\">@description</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Name of the first network security group.'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">param</span><span class=\"token plain\"> nsg1Name </span><span class=\"token datatype class-name\">string</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'nsg1'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token decorator\">@description</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Name of the second network security group.'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">param</span><span class=\"token plain\"> nsg2Name </span><span class=\"token datatype class-name\">string</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'nsg2'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token decorator\">@description</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Name of the second virtual network.'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">param</span><span class=\"token plain\"> vnet2Name </span><span class=\"token datatype class-name\">string</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'myVnet2'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token decorator\">@description</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Name of the third subnet.'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">param</span><span class=\"token plain\"> subnet3Name </span><span class=\"token datatype class-name\">string</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'subnet3'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token decorator\">@description</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Name of the fourth subnet.'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">param</span><span class=\"token plain\"> subnet4Name </span><span class=\"token datatype class-name\">string</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'subnet4'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token decorator\">@description</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Name of the third network security group.'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">param</span><span class=\"token plain\"> nsg3Name </span><span class=\"token datatype class-name\">string</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'nsg3'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token decorator\">@description</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Name of the fourth network security group.'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">param</span><span class=\"token plain\"> nsg4Name </span><span class=\"token datatype class-name\">string</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'nsg4'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token decorator\">@description</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Location for all resources.'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">param</span><span class=\"token plain\"> location </span><span class=\"token datatype class-name\">string</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">resourceGroup</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">location</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">resource</span><span class=\"token plain\"> vnet </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Network/virtualNetworks@2023-04-01'</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> vnetName</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">location</span><span class=\"token operator\">:</span><span class=\"token plain\"> location</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">addressSpace</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token property\">addressPrefixes</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'10.0.0.0/16'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">resource</span><span class=\"token plain\"> subnet1 </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Network/virtualNetworks/subnets@2023-04-01'</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">parent</span><span class=\"token operator\">:</span><span class=\"token plain\"> vnet</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> subnet1Name</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">addressPrefix</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'10.0.1.0/24'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">networkSecurityGroup</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token property\">id</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">resourceId</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Network/networkSecurityGroups'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">,</span><span class=\"token plain\"> nsg1Name</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">resource</span><span class=\"token plain\"> subnet2 </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Network/virtualNetworks/subnets@2023-04-01'</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">parent</span><span class=\"token operator\">:</span><span class=\"token plain\"> vnet</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> subnet2Name</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">addressPrefix</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'10.0.2.0/24'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">networkSecurityGroup</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token property\">id</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">resourceId</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Network/networkSecurityGroups'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">,</span><span class=\"token plain\"> nsg2Name</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">resource</span><span class=\"token plain\"> nsg1 </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Network/networkSecurityGroups@2023-04-01'</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> nsg1Name</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">location</span><span class=\"token operator\">:</span><span class=\"token plain\"> location</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">flushConnection</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token boolean\">false</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">securityRules</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Deny-All-Inbound'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">priority</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token number\">4096</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">access</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Deny'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">direction</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Inbound'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">destinationPortRange</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'*'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">protocol</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Tcp'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">sourcePortRange</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'*'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">destinationAddressPrefix</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'*'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">sourceAddressPrefix</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'*'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">resource</span><span class=\"token plain\"> nsg2 </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Network/networkSecurityGroups@2023-04-01'</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> nsg2Name</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">location</span><span class=\"token operator\">:</span><span class=\"token plain\"> location</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">flushConnection</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token boolean\">false</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">securityRules</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Deny-All-Inbound'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">priority</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token number\">4096</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">access</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Deny'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">direction</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Inbound'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">destinationPortRange</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'*'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">protocol</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Tcp'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">sourcePortRange</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'*'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">destinationAddressPrefix</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'*'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">sourceAddressPrefix</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'*'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">resource</span><span class=\"token plain\"> vnet2 </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Network/virtualNetworks@2023-04-01'</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> vnet2Name</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">location</span><span class=\"token operator\">:</span><span class=\"token plain\"> location</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">addressSpace</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token property\">addressPrefixes</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'10.1.0.0/16'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">resource</span><span class=\"token plain\"> subnet3 </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Network/virtualNetworks/subnets@2023-04-01'</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">parent</span><span class=\"token operator\">:</span><span class=\"token plain\"> vnet2</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> subnet3Name</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">addressPrefix</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'10.1.1.0/24'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">networkSecurityGroup</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token property\">id</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">resourceId</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Network/networkSecurityGroups'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">,</span><span class=\"token plain\"> nsg3Name</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">resource</span><span class=\"token plain\"> subnet4 </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Network/virtualNetworks/subnets@2023-04-01'</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">parent</span><span class=\"token operator\">:</span><span class=\"token plain\"> vnet2</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> subnet4Name</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">addressPrefix</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'10.1.2.0/24'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">networkSecurityGroup</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token property\">id</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:rgb(80, 250, 123)\">resourceId</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">(</span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Network/networkSecurityGroups'</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">,</span><span class=\"token plain\"> nsg4Name</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">resource</span><span class=\"token plain\"> nsg3 </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Network/networkSecurityGroups@2023-04-01'</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> nsg3Name</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">location</span><span class=\"token operator\">:</span><span class=\"token plain\"> location</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">flushConnection</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token boolean\">false</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">securityRules</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Deny-All-Inbound'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">priority</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token number\">4096</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">access</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Deny'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">direction</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Inbound'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">destinationPortRange</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'*'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">protocol</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Tcp'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">sourcePortRange</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'*'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">destinationAddressPrefix</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'*'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">sourceAddressPrefix</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'*'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">resource</span><span class=\"token plain\"> nsg4 </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Network/networkSecurityGroups@2023-04-01'</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> nsg4Name</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">location</span><span class=\"token operator\">:</span><span class=\"token plain\"> location</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">flushConnection</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token boolean\">false</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">securityRules</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Deny-All-Inbound'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">priority</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token number\">4096</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">access</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Deny'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">direction</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Inbound'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">destinationPortRange</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'*'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">protocol</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Tcp'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">sourcePortRange</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'*'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">destinationAddressPrefix</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'*'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">          </span><span class=\"token property\">sourceAddressPrefix</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'*'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">resource</span><span class=\"token plain\"> vnetPeering </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Network/virtualNetworks/virtualNetworkPeerings@2023-04-01'</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">parent</span><span class=\"token operator\">:</span><span class=\"token plain\"> vnet</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> vnet2Name</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">remoteVirtualNetwork</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token property\">id</span><span class=\"token operator\">:</span><span class=\"token plain\"> vnet2</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">id</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">allowVirtualNetworkAccess</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token boolean\">true</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">allowForwardedTraffic</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token boolean\">false</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">allowGatewayTransit</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token boolean\">false</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">useRemoteGateways</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token boolean\">false</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">dependsOn</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    subnet1</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    subnet3</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:rgb(189, 147, 249);font-style:italic\">resource</span><span class=\"token plain\"> vnetPeering2 </span><span class=\"token string\" style=\"color:rgb(255, 121, 198)\">'Microsoft.Network/virtualNetworks/virtualNetworkPeerings@2023-04-01'</span><span class=\"token plain\"> </span><span class=\"token operator\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">parent</span><span class=\"token operator\">:</span><span class=\"token plain\"> vnet2</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">name</span><span class=\"token operator\">:</span><span class=\"token plain\"> vnetName</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">properties</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">remoteVirtualNetwork</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">      </span><span class=\"token property\">id</span><span class=\"token operator\">:</span><span class=\"token plain\"> vnet</span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">.</span><span class=\"token plain\">id</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">allowVirtualNetworkAccess</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token boolean\">true</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">allowForwardedTraffic</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token boolean\">false</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">allowGatewayTransit</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token boolean\">false</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    </span><span class=\"token property\">useRemoteGateways</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token boolean\">false</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token property\">dependsOn</span><span class=\"token operator\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">[</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    subnet2</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    subnet4</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    vnetPeering</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:rgb(248, 248, 242)\">}</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>I have already deployed a new Resource Group to deploy our virtual network into:</p>\n<div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">New-AzResourceGroup -Name 'rg-network' -Location 'Australia East'</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>So let us create our first Deployment Stack!</p>\n<h6 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"new-azresourcegroupdeploymentstack\">New-AzResourceGroupDeploymentStack<a href=\"https://luke.geek.nz/azure/Azure-Bicep-Deployment-with-Deployment-Stacks#new-azresourcegroupdeploymentstack\" class=\"hash-link\" aria-label=\"Direct link to New-AzResourceGroupDeploymentStack\" title=\"Direct link to New-AzResourceGroupDeploymentStack\">​</a></h6>\n<p>The 'New-AzResourceGroupDeploymentStack' cmdlet is the first one we will look into.</p>\n<p>Let us look at the most common syntax that you may use:</p>\n<div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">New-AzResourceGroupDeploymentStack -Name \"&lt;deployment-stack-name&gt;\" -TemplateFile \"&lt;bicep-file-name&gt;\" -DeploymentResourceGroupName \"&lt;resource-group-name&gt;\" -DenySettingsMode \"none\"</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<table><thead><tr><th>Parameter</th><th>Description</th></tr></thead><tbody><tr><td><code>-Name</code></td><td>Specifies the name of the deployment stack.</td></tr><tr><td><code>-Location</code></td><td>Specifies the Azure region where the deployment stack will be created. This is valid for Subscription based DeploymentStacks.</td></tr><tr><td><code>-TemplateFile</code></td><td>Specifies the Bicep file that defines the resources to be managed by the deployment stack.</td></tr><tr><td><code>-DeploymentResourceGroupName</code></td><td>Specifies the name of the resource group where the managed resources will be stored.</td></tr><tr><td><code>-DenySettingsMode</code></td><td>Specifies the operations that are prohibited on the managed resources to safeguard against unauthorized deletion or updates. Possible values include \"none\", \"DenyDelete\", \"DenyWriteAndDelete\".</td></tr><tr><td><code>-DeleteResources</code></td><td>Deletes the managed resources associated with the deployment stack.</td></tr><tr><td><code>-DeleteAll</code></td><td>Deletes all deployment stacks and their associated resources.</td></tr><tr><td><code>-DeleteResourceGroups</code></td><td>Deletes the resource groups associated with the deployment stacks.</td></tr></tbody></table>\n<p>These parameters allow you to customize the creation and management of deployment stacks.</p>\n<p>The DenySettingsMode parameter is used in Azure Deployment Stacks to assign specific permissions to managed resources, preventing their deletion by unauthorized security principals, this is a key differentiator to some of the other solutions mentioned earlier, but it does mean you need to think about how your resources will be managed, let us take a look at the DenySettingsMode a bit deeper.</p>\n<p>The DenySettingsMode parameter accepts different values to define the level of deny settings. Some of the possible values include:</p>\n<ul>\n<li>\"none\": No deny settings are applied, allowing all operations on the managed resources.</li>\n<li>\"DenyDelete\": Denies the delete operation on the managed resources, preventing their deletion.</li>\n<li>\"DenyWriteAndDelete\": Denies all operations on the managed resources, preventing any modifications or deletions.</li>\n</ul>\n<p>By specifying the appropriate DenySettingsMode value, you can control the level of permissions and restrictions on the managed resources within the deployment stack.</p>\n<p>For our testing, we will deploy our Azure Virtual Networks, NSGs to a new Deployment Stack, using the DenyDelete DenySettingMode.</p>\n<div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">$RGName = 'rg-network'</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">$DenySettings = 'DenyDelete'</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">$BicepFileName = 'main.bicep'</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">$DeploymentStackName = 'NetworkProd'</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">New-AzResourceGroupDeploymentStack -Name $DeploymentStackName -TemplateFile $BicepFileName -ResourceGroupName $RGName -DenySettingsMode $DenySettings -DenySettingsApplyToChildScopes</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p><img loading=\"lazy\" alt=\"New-AzResourceGroupDeploymentStack\" src=\"https://luke.geek.nz/assets/images/DeploymentStacks-NewAzResourceGroupDeployment-9bddf7b908a3977665163564aa2050d7.gif\" width=\"1072\" height=\"386\" class=\"img_ev3q\"></p>\n<p>As you can see, creating a new Azure Deployment Stack is easy, with no adjustments to the underlying Bicep configuration needed.</p>\n<p><em>Note: If you get an error, that the cmdlet is missing -Name parameter, make sure that the -ResourceGroupName parameter has been added.</em></p>\n<p>If we navigate to the Azure Portal, we can see the Deployment Stack natively, including the Stack properties, such as what are the actions if resources are removed, what the denyDelete mode is.</p>\n<p><img loading=\"lazy\" alt=\"New-AzResourceGroupDeploymentStack\" src=\"https://luke.geek.nz/assets/images/DeploymentStacks-AzurePortalOverview-2549a0ef65077b64ea30eea043d768e7.gif\" width=\"1697\" height=\"874\" class=\"img_ev3q\"></p>\n<h6 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"testing-deny-assignment\">Testing Deny-Assignment<a href=\"https://luke.geek.nz/azure/Azure-Bicep-Deployment-with-Deployment-Stacks#testing-deny-assignment\" class=\"hash-link\" aria-label=\"Direct link to Testing Deny-Assignment\" title=\"Direct link to Testing Deny-Assignment\">​</a></h6>\n<p>As we deployed our virtual networks, using the denyDelete assignment, lets take a look and attempt to delete a Network Security Group, before we do that we need to dissociate it from the subnet.</p>\n<p><em>Note: Its worth noting my permissions are: Owner.</em></p>\n<p>When I attempted to delete a Network Security Group I get the error below:</p>\n<blockquote>\n<p>Failed to delete network security group 'nsg1'. Error: The client '************' with object id 'cb059544-e63c-4543-930f-4b6e6b7aece1' has permission to perform action 'Microsoft.Network/networkSecurityGroups/delete' on scope 'rg-network/providers/Microsoft.Network/networkSecurityGroups/nsg1'&gt;nsg1'; however, the access is denied because of the deny assignment with name 'Deny assignment '55ebfe82-255d-584a-8579-0e0c9f0219ff' created by Deployment Stack '/subscriptions/f0ee3c31-ff51-4d47-beb2-b1204a511f63'.</p>\n</blockquote>\n<p><img loading=\"lazy\" alt=\"Azure Deployment Stack - Delete Resource Test\" src=\"https://luke.geek.nz/assets/images/DeploymentStacks-AzurePortal-DenyAssignmentTest-c5eb08ba80367c9b541c85fa0f77b600.gif\" width=\"1697\" height=\"874\" class=\"img_ev3q\"></p>\n<p>To delete the resource, I would need to, do one of the following:</p>\n<ul>\n<li>Delete the Deployment Stack (and detach the resources and delete it manually)</li>\n<li>Delete the Deployment Stack (and delete all the resources)</li>\n<li>Remove from the bicep code and update deployment stack.</li>\n</ul>\n<p>Note: In our testing, we were able to disassociate the Network Security Group, from the Subnet, because when the deployment stack was deployed - it was with the: denyDelete assignment, not the:'DenyWriteAndDelete'.</p>\n<h6 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"redeploy---deployment-stack-portal\">Redeploy - Deployment Stack (Portal)<a href=\"https://luke.geek.nz/azure/Azure-Bicep-Deployment-with-Deployment-Stacks#redeploy---deployment-stack-portal\" class=\"hash-link\" aria-label=\"Direct link to Redeploy - Deployment Stack (Portal)\" title=\"Direct link to Redeploy - Deployment Stack (Portal)\">​</a></h6>\n<p>Using the Azure Portal, we can Edit and re-deploy our existing Deployment stack, if you have changes or resources that you may want to roll back:</p>\n<p><img loading=\"lazy\" alt=\"Azure Deployment Stack - Delete Resource Test\" src=\"https://luke.geek.nz/assets/images/DeploymentStacks-AzurePortal-RedeployDeploymentStack-21280487c4e7d54cdd121c45554f2b17.gif\" width=\"1697\" height=\"874\" class=\"img_ev3q\"></p>\n<h6 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"redeploy---deployment-stack-bicep\">Redeploy - Deployment Stack (Bicep)<a href=\"https://luke.geek.nz/azure/Azure-Bicep-Deployment-with-Deployment-Stacks#redeploy---deployment-stack-bicep\" class=\"hash-link\" aria-label=\"Direct link to Redeploy - Deployment Stack (Bicep)\" title=\"Direct link to Redeploy - Deployment Stack (Bicep)\">​</a></h6>\n<p>What if we want to make further changes, such as removing resources from our Deployment Stack?</p>\n<p>In this example, we will modify our bicep code to remove the second Virtual network, subnets and associated NSGs (Network Security Groups), and remove the resources from Azure completely <em>(we can unattach them, which will remove them from being managed by the deployment stack)</em>, but I want my Virtual Network resources to be managed completely by Bicep.</p>\n<p>We could use the: Save-AzResourceGroupDeploymentStackTemplate, to save the Deployment Stack to an ARM template, if we wanted to deploy it later.</p>\n<p><em>Note: In the bicep code example supplied earlier I removed everything after NSG2.</em></p>\n<p>We will run the Set-AzResourceGroupDeploymentStack, pointing to the modified bicep code:</p>\n<div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">$RGName = 'rg-network'</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">$DenySettings = 'DenyWriteAndDelete'</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">$BicepFileName = 'main.bicep'</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">$DeploymentStackName = 'NetworkProd'</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">Set-AzResourceGroupDeploymentStack -Name $DeploymentStackName -ResourceGroupName $RGName -TemplateFile $BicepFileName -DenySettingsMode $DenySettings -DeleteResources -Verbose -DenySettingsApplyToChildScopes</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>In this example, we tell Deployment Stacks to Delete Resources that are no longer part of the stack, and this time we will add the Verbose flag, so we can see what it is doing.</p>\n<p><img loading=\"lazy\" alt=\"Azure Deployment Stack - Delete Resource Test\" src=\"https://luke.geek.nz/assets/images/DeploymentStacks-PowerShell-RedeployDeploymentStack-411460fee235b420a83aac2092f36ab0.gif\" width=\"1068\" height=\"292\" class=\"img_ev3q\"></p>\n<p><em>Note: I cut the gif, thats why the timestamps don't match, or you could be spending 10 minutes staring at the verbose output.</em></p>\n<p>If we navigate to the Azure Portal, we can see the deleted resources listed in the Deployment stack history <em>(only displays the last Deployment stack changes vs keeping a history of everything)</em>, and the Resource un-managed state has changed to: delete.</p>\n<p><img loading=\"lazy\" alt=\"Azure Deployment Stack - Delete Resource Test\" src=\"https://luke.geek.nz/assets/images/DeploymentStacks-PowerShell-RedeployDeploymentStackOverview-beaaa4632febe9a02e66ec9b09fefd17.gif\" width=\"1714\" height=\"894\" class=\"img_ev3q\"></p>\n<p>Note: A manually created Virtual Network in the same Resource Group (but not part of the deployment stack) remained untouched.</p>\n<p><em>I forgot to update, the DenySettings variable, so once I re-deployed with the 'DenyWriteAndDelete' instead of: 'DenyDelete'. I was unable to disassociate my Network Security Group.</em></p>\n<p><img loading=\"lazy\" alt=\"Azure Deployment Stack - Delete Resource Test\" src=\"https://luke.geek.nz/assets/images/DeploymentStacks-Portal-NSG_Modification-86f57308017f532e5445c2f920e9865a.gif\" width=\"1714\" height=\"894\" class=\"img_ev3q\"></p>\n<h6 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"permissions\">Permissions<a href=\"https://luke.geek.nz/azure/Azure-Bicep-Deployment-with-Deployment-Stacks#permissions\" class=\"hash-link\" aria-label=\"Direct link to Permissions\" title=\"Direct link to Permissions\">​</a></h6>\n<p>I have 'Owner' rights over my own demo subscriptions, so a bit more flexibility than I would have in a Production environment.</p>\n<p>You can add <a href=\"https://learn.microsoft.com/azure/azure-resource-manager/bicep/deployment-stacks?tabs=azure-powershell&amp;WT.mc_id=AZ-MVP-5004796#protect-managed-resources-against-deletion\" target=\"_blank\" rel=\"noopener noreferrer\">exclusions</a> to your Deployment Stack, allowing certain principals or actions to be completed.</p>\n<p>You could also create custom role (Microsoft.Resources/deploymentStacks) to be able to Read, Update or delete deployment stacks, giving you the flexibility to allow people to modify their own stacks and redeploy, without accessing to other tooling required and self-service functionality, such as being able to give someone a deployment stack, that the users can then delete the resources and redeploy later straight from the Azure Portal when required for testing.</p>",
            "url": "https://luke.geek.nz/azure/Azure-Bicep-Deployment-with-Deployment-Stacks",
            "title": "Azure Bicep Deployment with Deployment Stacks",
            "summary": "Deployment Stacks! What is it? insert confused look*",
            "date_modified": "2023-08-28T00:00:00.000Z",
            "author": {
                "name": "Luke Murray",
                "url": "https://luke.geek.nz"
            },
            "tags": [
                "Azure"
            ]
        },
        {
            "id": "https://luke.geek.nz/azure/Azure-Bicep-Deploy-Pane",
            "content_html": "<p>Working with <a href=\"https://learn.microsoft.com/en-us/azure/azure-resource-manager/bicep/overview?tabs=bicep&amp;WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Bicep</a> using Visual Studio Code, is as native as an experience as you can get, made even better by the <a href=\"https://marketplace.visualstudio.com/items?itemName=ms-azuretools.vscode-bicep\" target=\"_blank\" rel=\"noopener noreferrer\">Bicep Visual Studio Code extension</a>.</p>\n<p>The Bicep Visual Studio Code extension keeps evolving, with a recent (Experimental) feature being added called the <strong>Deploy Pane</strong>.</p>\n<blockquote>\n<p>The Deployment Pane is a UI panel in VSCode that allows you to connect to your Azure subscription and execute validate, deploy &amp; whatif operations and get instant feedback without leaving the editor.</p>\n</blockquote>\n<p><img loading=\"lazy\" alt=\"Azure Bicep - Deploy Pane\" src=\"https://luke.geek.nz/assets/images/VisualStudioCode_DeployPane-b366d4a8a89b7496c00e15ea6b328464.png\" width=\"1491\" height=\"760\" class=\"img_ev3q\"></p>\n<p>The Deploy Pane, brings together some key actions:</p>\n<ul>\n<li>Deploy</li>\n<li>Validate</li>\n<li>What-If</li>\n</ul>\n<p>The Deploy step, will deploy the Bicep file using the Subscription Scope and ID specified in the pane.\nThe validate step, will validate that the Bicep syntax is correct for the Azure Resource Manager to process the template.\nThe What-If step, will let you know what it will deploy and what changes will be made, without having to deploy or touch any resources.</p>\n<p>To enable the new Experimental Feature, make sure you are running the latest version of both Bicep, and the Bicep Visual Studio Code extension.</p>\n<ol>\n<li>Click on <strong>Settings</strong></li>\n<li>Expand <strong>Extensions</strong></li>\n<li>Navigate to: <strong>Bicep</strong></li>\n<li>Check the box labelled: <strong>Experimental: Deploy Pane</strong></li>\n</ol>\n<p><img loading=\"lazy\" alt=\"Azure Bicep - Deploy Pane\" src=\"https://luke.geek.nz/assets/images/Bicep-DeploymentPreviewPane-9355040071cca56c4bd58e411f280351.gif\" width=\"1908\" height=\"944\" class=\"img_ev3q\"></p>\n<p>Once enabled, you will see the new Deploy Pane, appear in the top right of your Visual Studio code interface, next to Bicep Visualizer, once you have a Bicep file loaded.</p>\n<p><img loading=\"lazy\" alt=\"Azure Bicep - Deploy Pane\" src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAANUAAAAlCAYAAADV0qyaAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAAB3RJTUUH5wgSBB4rcgE7DAAADBpJREFUeJztnHtYVGUexz9nLoBMsoIZ1Iq6E5Zja2hBIrum1YpmUxu1aje8NLUiFWqBpaWOT2k9iq3Srk4X0lUrxW3bbCIXutDuqmhjSaWYmbdh81bMegGEuZz9YxyYwzkgN0njfJ5nHs+c93Jenffr93femxATEyOioqLSbmh+6gaoqPzcUEWlotLO6H7qBqicm67hMChOww0mDcYrNER1hZgoDT26CQAc/5/IkQofFafgv8dFtpV5KSnzcarqJ254J0VQ36kuTC79Bdx9o47bkrT079O6gGLXAR9F27289ZGHH060cwNVGkUV1QXGAKOGCSO13DpYR6i+fer0eEU2bvOxcqObHXvVn/t8o4rqAiFEJzJ9jJ5Jt+rQaYXz9pzVhR4WrnVTXXPeHtHpUUV1ATAwTmDh5FCMVzQupl0HfGzZ6aFkp5uKU3Ckwscxlw+AyyI1xET537WSrtEz5BpdkyFj+XGRGbYatu1Wf/rzgSqqnxBRFBl1g5alj4UoupPzmI9V/6xlfbGbipM+xfIAgiAvG2EQSB2q56HbQukdIxeYxysy9aVaNm7zKpZXaT2qqBpgGm1hWKzSy0wFX67JZ3Nl+zynKUE5j/mYv/oMhZ95cHvkYmoJgiAwMlHHM+O7yMTl8Yq88KabFR94Wi6sfmYsw3rSpte+E7tZt7YYV1vquABRRSXBQq49FWMjqa4tC0ibv7nNTxFFkZsHaVn+uFRQHq/IXze6WbT2DJXVcjE1t+MHHCyYsBCBaWNCmXxHqEzEs16tZd0nLRBWPwu5z6dibIeBFNd2G5lz7T8rYanzVApUbs1h3LPFQXf8YovWhLS5blEUiYkSWJwhF9SjS6p5f0utrExwZz9XxxdFsS5PsLjO1Iq88MYZPv7cy+qnwwkPq6/nmTQ9m772Un5cbJawho9JwajfxzvmTPIayzN7HVmDjzYjTwp3YW80z8WIuqKiAwl08gUPhxBhqO+8NW5kghIEQfbRaDR1190GpDD23glMmHgf95qH0itSnif4E2BbmZu0+VVUnakXXHiYwJJH/Q6m5HIqLUN1qg4i0FlvS9IwLF4rSXtulbKgAteSP8MTsczJ4KZYqWvePm4C39iXsnj9TqoEoc6xgkUSuN5W5mZ2XjWLHwmvSxvUV8NdQzXkF3slbqfSclSn6kBEUWTczdIXkZJdXlZ+4J80UnIYqfsM5Ykl2YyKC+MHRz4vTk0jLe0xZq/8hCO+KAaMeZq5E66WlFFyLoD8T2opKHFL2nLvLTrVqdoB1akUCIlJJn1yv6A7sUS2ob5AR+3ZQ+A3v5a61DOv+RfoBTtS/cfAL4enMCr+Wq4M/4H9ofEMjdZywG5let7us3lOcPDjFcwocTL7zxlcd/uD3P/2TN48x7o/URSxrqgmJbF+svnaK7VcFavh23JRdas2oIpKQim7ys0Yeydj7t0wzUXpl9+1umZRFDEPkbrU53u8fHPIKxGURuMPHoSrzMx67H4Seoah0WjQaDQMEASEw0W88vo3sg4vVH3Ic+uH8daUeG4YK/DmSqkoAqFgsBMd/tFH8Q4Pv7u+vl1336jj+TdqVUG1AVVUEhzY0lOx9Utn+fNmYj1u3F30nN6aS/qzhbRmiiq4E5t6S6PtvxXXyAQlCAIYbubppx4ksbvI95tWs2LFu2yviMQ4KJG4sE3sbuxhHxzgWMZArrx7A+/dWcmhz97m5SXr+bJSkDlP4Pv6T2olouoVLc+j0jLUdyoZJiyPjCRW78Lxyizs37qJHJxG9ghDq2sMOETvaGkH3XnACyB73xmWOYkbLhU5VDCHRxe/y/YKABf7viikcEu9tE0PWMldmElKXdMKeX/9+xT8+yvKT4TSK2k885fPZYRBObwEOHhUOh8W20Mjc7SLCxPmjCyyMsyYFFINQ8aSlZ3F2CFKv6cJc4YV61Tlss1FdaoGmB6egvlXelxbV7OoqIzKPXbil6SSMD6blM1WCtuwoqJPgxUNB4/KO7kg3MiwayLQ/m8ra15r1JMwPbAI6z0mDEDmsksgYwGFlU4KV9nO5jCQnLmUrBGJWJ408+Hc9wH50qby41Lx9OwhFf7F5laxGZmkj44FhmPq4sSyuDQodSzWGeMx6YHkaEjNJj8oNf6JLNJvigYSiA1xYllUSmtQnSqYfhamjDaidzlY/eLZcO9gHos27MMdmUDa4ym01q+a+p9fKqw4Lu2mperg5zgayR8sKAC6J5O5bFaQYwFUsjnXhqNC4BLTEO5UfFbL26pyblRR1WHC8ogZo96FY9UiiSM5Vyw6GwZaWhQGNuycB45IQ60+MfLOLQinqXVDiKGbYp3RY+f7BeVyYP+iEnBS/N4+3N2TyVyWRbIkt4OjJ4EuXemOfDWGIAjEXibtAgHnuliF5VyWi62gmOICGzmLGzpNPtaFqyj+tJhVC60SlwIoXZyDrcCBo8hGTitdClRR1RE76WzYtyUPa1HDGM9J3hI7+9wGEiZlN3CEpgl+P2koqn69lKLvEr47JhAS91ssshFIOJq/hsKtm7FNs7K7FsCN6+WZWN9zsHldHtKViQlER4BwyoUz6G6wuPrESIf4ncfr23hxCqsM+7IccpbZKVNIrdyST86iHPK3KMXxZdiXWbEuVS7bXFRRAfS2kH2HEb1rM3nzi5XzBMLAiAQsM1oXBu5xeiXf7xzqH3WThmPlrPm7A5feiHnOLMzdG9ZSRt6zC7D/GHyvktKXrSwoCF6WaiB+8ngSu0Pldw4KG9QSeN7tyVJhHzjsRaVtdNqBCtMDVqZcHwWAPiqWWD04t7xDcRNlnPmFlI5IJ+F6C7l/Mvvfudx7sc/LbdYAxrub3GTdE1b3Pam/lt4xGpzHpPkqi+axoE8uC36fTPrr60gtP0qlZJ3tIQqn53A66E78JCuWa6PqvusjoomNNoDLwfIX7Irt6dFNICVR2gXe2+xWzKvSfDqpqCxMuSdBtsUjdvQULMsaX1WdPG0cCREABqL7BkobSZvmoLAZW0IOHvFRsstLUv/6kGvOhFAeWngGkIZlZa9m8uCedGaNv4m4nkaipVEa0SARVWRPE8a+Qf7prcS5dRW2F/MpVRC8KIo8eV+YZKX8zv1evtrnu6hG+y5EOqmo/ARv8fBvQ2g6f4gmBAje8tC8LSGB1QyCILD2o1qS+nepS7vlOh1/GKbj7X/Jwy7XpzayP7XJ7gcYHnRd/Oy4Jl02GFEUuXWw/7nBrP1Yuu1EFVfr6NSiOt8o7WvasMnN/SP0JPar/6efNymUg0dr2L7Hd17nhQLtSLhaS86UUEnazv1e3iiqD/2aaoPr5GkgEuPkdNIbyRMVE9K8PO4aTjX/r3BRoIqqgwi4lccrMjW3ig9f7Fq3UTA8TGDlU6FMfMEvrPPJ9VdpWPlUqGSTYo0bpr5UhccrnnMOC6B0aSa5l9jIvN1MfJM5I4lvKo97H+/MzJYNbV/sdGpRGQZnYbdnNTt/ra8WMJJqt5MadN/lk+/WVSLQWZ3HfMx8pZqlmfX7mcLDBFY/HYZtg5uXN7ipcZ87/GpuyCeKIjqtwMRROh4fGyI7T3Deiir2OH2SNjZss5RKCuenyUYUVfx02jMqlA54cTs/Ja+giRkKQzJjH7iWKMnNpg+ECYRcgfkqn89Xd/2QOZS5E7vIyuz7XsS6spZNX7f9pCNRFBls0vBMWojisWXzVlbzmr1Gcf8WqO9VraHTiqojCYhI6TM6Sc9fpocrHlG264CPNUUe/vEfD7WelnXuEJ1/MGLiKB0DjMrTkUqCamwbvkrzUUXVATTlVgDDB+pYOCWcy7srd/4aN+zY6x+OL93r44gLqs6IHKnwp8dE+cPHmEiIj9OQ1F/LwDhNo8dGV5z08aStmo3b/AMTSmdgBO6rtBxVVB1EY04VSIswCFgnhTNmeDsdoN4IBSVuZr5SXXc4p+pS7Y8qqg6ioVspiQtgyDU6/nhHKMMHtu+Z6sU7POTZz1C8w1N3rykxqaJqPaqoOpCmhBWcDtArWsv4kSGMTtLLVpI3F+cxH4WfeVhTVMPe8vrJZeXzMFRBtReqqDqYlggrQK9oLYP6ahncX0ffnloiwgW6hsPl3f2d//CPIqeq4GSVyP7DXhy7PZTs8nLoqHyVhiqo88//AfU4B6Dp6Uk/AAAAAElFTkSuQmCC\" width=\"213\" height=\"37\" class=\"img_ev3q\"></p>\n<p>If you have any feedback regarding this extension, make sure to add your feedback to the <a href=\"https://github.com/Azure/bicep/issues\" target=\"_blank\" rel=\"noopener noreferrer\">azure/bicep issues</a></p>",
            "url": "https://luke.geek.nz/azure/Azure-Bicep-Deploy-Pane",
            "title": "Azure Bicep - Deploy Pane",
            "summary": "Working with Azure Bicep using Visual Studio Code, is as native as an experience as you can get, made even better by the Bicep Visual Studio Code extension.",
            "date_modified": "2023-08-18T00:00:00.000Z",
            "author": {
                "name": "Luke Murray",
                "url": "https://luke.geek.nz"
            },
            "tags": [
                "Azure"
            ]
        },
        {
            "id": "https://luke.geek.nz/azure/Getting-Started-with-GitHub-Codespaces",
            "content_html": "<p><a href=\"https://github.com/features/codespaces\" target=\"_blank\" rel=\"noopener noreferrer\">Github Codespaces</a> gives you the full capability of your favourite IDE (Integrated Development Environment) like Visual Studio Code, Jupyter, or JetBrains and an extension, to your web browser. With it, you can develop your applications without needing any dependant service or tool installed or configured locally, giving developers a standard way of working on applications and scripts.</p>\n<p><img loading=\"lazy\" alt=\"Github Codespaces - Getting Started\" src=\"https://luke.geek.nz/assets/images/Header_Getting_Started_with_GitHub_Codespace-091780758856bdf85c365aeca18a401d.gif\" width=\"1200\" height=\"628\" class=\"img_ev3q\"></p>\n<p>Github Codespaces does this by leveraging the power of the Cloud and GitHub to run containers that you can personalize to run your IDE, extensions, and any dependencies that you may need, whether you are a developer needing Python, apache, react, or a devops engineer requiring Bicep and Terraform support, Codespaces is an ideal enabler for our toolkit, in fact, this article was written in a Github Codespace, using Visual Studio Code and Markdown extensions.</p>\n<blockquote>\n<p>A codespace is a development environment that's hosted in the cloud. You can customize your project for GitHub Codespaces by configuring dev container files to your repository (often known as Configuration-as-Code), creating a repeatable codespace configuration for all project users.\nGitHub Codespaces run on various VM-based compute options hosted by GitHub.com, which you can configure from 2-core machines up to 32-core machines. You can connect to your codespaces from the browser or locally using an IDE like Visual Studio Code or IntelliJ.</p>\n</blockquote>\n<p>Let's delve into <a href=\"https://github.com/features/codespaces\" target=\"_blank\" rel=\"noopener noreferrer\">Github Codespaces</a> a bit more!</p>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"introduction\">Introduction<a href=\"https://luke.geek.nz/azure/Getting-Started-with-GitHub-Codespaces#introduction\" class=\"hash-link\" aria-label=\"Direct link to Introduction\" title=\"Direct link to Introduction\">​</a></h4>\n<p>GitHub Codespaces is a cloud-based development environment provided by GitHub, designed to enhance the coding experience and streamline collaboration for developers. It allows you to create, manage, and access your development environments directly from your web browser. With GitHub Codespaces, you can code, build, test, and debug your projects without setting up complex local development environments on your machine.</p>\n<p><img loading=\"lazy\" alt=\"Github Codespaces\" src=\"https://luke.geek.nz/assets/images/github_codespaces-a1be408d4805fff58871dea78b9fc88d.png\" width=\"728\" height=\"380\" class=\"img_ev3q\"></p>\n<p>Key features and benefits of GitHub Codespaces include:</p>\n<ul>\n<li>Access Anywhere: You can access your coding environment from anywhere with an internet connection. This is particularly useful for remote work, collaboration, and coding on the go.</li>\n<li>Consistency: Codespaces ensure consistency across development environments, which can help avoid the \"it works on my machine\" issue often encountered in software development.</li>\n<li>Collaboration: Multiple developers can collaborate on the same Codespace simultaneously, making it easier to pair programs, review code, and troubleshoot together in real-time.</li>\n<li>Isolation: Each project or repository can have its own isolated Codespace, preventing conflicts between dependencies and configurations.</li>\n<li>Quick Setup: Setting up a development environment is quick and easy. You don't need to spend time installing and configuring software locally.</li>\n<li>Configurability: Codespaces can be customized with extensions, tools, and settings to match your preferred development environment.</li>\n<li>Scalability: GitHub Codespaces can scale according to your needs, making it suitable for individual developers and larger teams.</li>\n<li>Version Control Integration: Codespaces is tightly integrated with GitHub repositories, making it seamless to switch between your code and the development environment.</li>\n<li>Security: Codespaces offer a secure environment for development, as it doesn't store sensitive data and is protected by GitHub's security measures.</li>\n<li>Project Setup: Codespaces can be configured to automatically set up a project with required dependencies and tools, reducing the time needed to get started.</li>\n</ul>\n<p>Github Codespaces went into <a href=\"https://azure.microsoft.com/updates/general-availability-github-codespaces/?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">general availability</a> on August 2021 and is built on top of the <a href=\"https://containers.dev/\" target=\"_blank\" rel=\"noopener noreferrer\">devcontainers</a> schema.</p>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"prerequisites\">Prerequisites<a href=\"https://luke.geek.nz/azure/Getting-Started-with-GitHub-Codespaces#prerequisites\" class=\"hash-link\" aria-label=\"Direct link to Prerequisites\" title=\"Direct link to Prerequisites\">​</a></h4>\n<p>You need a <a href=\"https://github.com/\" target=\"_blank\" rel=\"noopener noreferrer\">Github</a> account to use GitHub Codespaces.</p>\n<p>GitHub Codespaces are available for developers in every organization. However, organizations can choose whether codespaces created from their repositories will be user-owned or organization-owned.. All personal GitHub.com accounts include a monthly quota of free usage each month.</p>\n<p>GitHub will provide <strong>users in the Free plan 120 core hours, or 60 hours of run time on a two core codespace, plus 15 GB of storage each month</strong>.</p>\n<p>For further pricing information, make sure you review:</p>\n<ul>\n<li><a href=\"https://docs.github.com/en/billing/managing-billing-for-github-codespaces/about-billing-for-github-codespaces\" target=\"_blank\" rel=\"noopener noreferrer\">About billing for GitHub Codespaces</a></li>\n<li><a href=\"https://github.com/pricing/calculator\" target=\"_blank\" rel=\"noopener noreferrer\">Pricing calculator</a></li>\n</ul>\n<blockquote>\n<p>Pricing, features and offerings could change at any time. For the most up-to-date information, make sure you review the documentation on github.com.</p>\n</blockquote>\n<p>To use GitHub Codespaces, you need an active repository; by default, Github Codespaces is configured for the repository you set.</p>\n<p>You will also need a <a href=\"https://docs.github.com/en/get-started/using-github/supported-browsers\" target=\"_blank\" rel=\"noopener noreferrer\">supported browser</a> (the latest versions of Chrome, Edge, Firefox, or Safari are recommended) to view your IDE; in this article, we will be using Visual Studio Code.</p>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"setting-up-github-codespaces\">Setting Up GitHub Codespaces<a href=\"https://luke.geek.nz/azure/Getting-Started-with-GitHub-Codespaces#setting-up-github-codespaces\" class=\"hash-link\" aria-label=\"Direct link to Setting Up GitHub Codespaces\" title=\"Direct link to Setting Up GitHub Codespaces\">​</a></h4>\n<p>Github Codespaces can be accessed directly from the GitHub interface.</p>\n<ol>\n<li><strong>Navigate</strong> to a new <strong>repository</strong></li>\n<li>Click <strong>Code</strong></li>\n<li>Click <strong>+</strong> in the Codespaces tab to open a new <strong>Codespace</strong> on your repo, by default a Visual Studio Code instance will open in your browser; note the 'funky' name and URL that create to give you a unique container.</li>\n</ol>\n<p><em>Note: Don't worry; nothing is saved to your repository unless you want to commit any changes.</em></p>\n<p>Your Codespace is now started and running in a default GitHub-supplied development container.</p>\n<blockquote>\n<p>A development container is a running Docker container with a well-defined tool/runtime stack and its prerequisites.</p>\n</blockquote>\n<p><img loading=\"lazy\" alt=\"Github Codespaces - Run\" src=\"https://luke.geek.nz/assets/images/OpenCodespace-7ded5b93f6b3d8f25a98c42f2503235b.gif\" width=\"2239\" height=\"1201\" class=\"img_ev3q\"></p>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"exploring-the-interface\">Exploring the Interface<a href=\"https://luke.geek.nz/azure/Getting-Started-with-GitHub-Codespaces#exploring-the-interface\" class=\"hash-link\" aria-label=\"Direct link to Exploring the Interface\" title=\"Direct link to Exploring the Interface\">​</a></h4>\n<p>Once you have your Codespace running, you have access to most native <a href=\"https://code.visualstudio.com/\" target=\"_blank\" rel=\"noopener noreferrer\">Visual Studio Code</a> capability's and all the files in your repository.</p>\n<p><img loading=\"lazy\" alt=\"Github Codespaces - Overview\" src=\"https://luke.geek.nz/assets/images/Codespaces_VSCode_Overview-27a520ddf59bae72c1ff31de985af961.png\" width=\"1920\" height=\"845\" class=\"img_ev3q\"></p>\n<p>We now have our workspace, consisting of Visual Studio code, running in your own docker container! The Host field <em>(lower left)</em> indicates that you are running in a Codespace.</p>\n<p>Out of the box, Visual Studio Code has git integration, so you can easily commit any changes to the repository as you would if you were working from your local development workstation - this is critical to remember when making a change to your devcontainer configuration - you have to commit it before you can rebuild or you will lose your configuration (we will get to this further in the article).</p>\n<p>As its runs in a hosted container, you can switch easily between computers and browsers by opening the Codespace (the same way you created your Codespace, but instead selecting an already running instance) or copying the URL of your Codespace and log back into Github on another computer to go directly to the container instance:</p>\n<p><img loading=\"lazy\" alt=\"Github Codespaces - Run\" src=\"https://luke.geek.nz/assets/images/Github_Codespaces_OpenRunning-44c5d51040f54cc74e8432a631715740.png\" width=\"1033\" height=\"466\" class=\"img_ev3q\"></p>\n<p>If you leave your Codespace running without interaction, or if you exit your codespace without explicitly stopping it, the codespace will timeout after a period of inactivity and stop running. You can <a href=\"https://docs.github.com/en/codespaces/customizing-your-codespace/setting-your-timeout-period-for-github-codespaces\" target=\"_blank\" rel=\"noopener noreferrer\">adjust the timeout</a> of your codespace to a maximum of 240 minutes (4 hours) for new Codespaces, but keep in mind you will be charged unless the Codespace is stopped. If the Codespace remains inactive for some time, it could be deleted. You should get an email notification before this happens, but I suggest keeping an eye on your Codespace and ensuring it's only running when needed.</p>\n<blockquote>\n<p>Warning: Codespaces compute usage is billed for the duration a codespace is active. If you're not using a codespace that remains running and hasn't yet timed out, you are billed for the total time that the codespace was active, irrespective of whether you were using it. For more information, see \"<a href=\"https://docs.github.com/en/billing/managing-billing-for-github-codespaces/about-billing-for-github-codespaces#codespaces-pricing\" target=\"_blank\" rel=\"noopener noreferrer\">About billing for GitHub Codespaces</a>.\"</p>\n</blockquote>\n<p>As with any Visual Studio Code instance, you can also log in to your GitHub account to pull your settings and extensions, but to keep things clean and distraction-free, you can customize your Codespace instead for only what you or others working in the same repository need.</p>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"customizing-your-codespace\">Customizing Your Codespace<a href=\"https://luke.geek.nz/azure/Getting-Started-with-GitHub-Codespaces#customizing-your-codespace\" class=\"hash-link\" aria-label=\"Direct link to Customizing Your Codespace\" title=\"Direct link to Customizing Your Codespace\">​</a></h4>\n<p>You can customize your Codespace to suit the project you are working on; some examples I use personally are:</p>\n<ul>\n<li>Markdown editing <em>(for example, my website is hosted on Github Pages, and the formatting is done using Markdown, so I have a devcontainer preconfigured to run Markdown Visual Studio Code extensions and linting, so as soon as I open it - its good to go!)</em></li>\n<li>Infrastructure as Code development <em>(I have preconfigured devcontainer, running on a container, that has the latest version of PowerShell, Terraform, Bicep installed and relevant Visual Studio extensions)</em></li>\n</ul>\n<p>I used to install everything locally, to the point when I would be reinstalling Windows every few months. To keep my device clean, I moved to an Azure Virtual Desktop host as my development environment, but Codespaces now give me the flexibility to install what I need (when I need it) within a Linux environment, and I know when I rebuild the Codespace, I will have the latest libraries.</p>\n<p>There are a lot of customisation you can do, we won't be able to cover all possible customisations in this article, but I aim to cover the basics to get you up and running!</p>\n<h5 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"setting-sync\">Setting Sync<a href=\"https://luke.geek.nz/azure/Getting-Started-with-GitHub-Codespaces#setting-sync\" class=\"hash-link\" aria-label=\"Direct link to Setting Sync\" title=\"Direct link to Setting Sync\">​</a></h5>\n<p>Before delving into some of the customisation of the devcontainer configuration itself, let us remember the Visual Studio Code settings sync.</p>\n<p>If you are someone who works on the same products and services and has invested time in configuring Visual Studio profiles, there's nothing indicating that you can't use this in a Github Codespace, especially if it is a trusted repository.</p>\n<p>You will already be logged into Visual Studio Code with your GitHub account; you can turn on Setting Sync to have your Visual Studio code settings and profiles sync straight into your devcontainer.</p>\n<p><img loading=\"lazy\" alt=\"Github Codespaces - Setting Sync\" src=\"https://luke.geek.nz/assets/images/VisualStudioCode_Codespace_TurnonSettingSync-7dc0899258fb4295e7903df8c63a50d4.gif\" width=\"654\" height=\"277\" class=\"img_ev3q\"></p>\n<p>One of the downsides of this method is the container can get bloated with extensions and configurations you don't need, and you will have to turn on Setting Sync each time a Codespace is launched.</p>\n<p><a href=\"https://docs.github.com/en/codespaces/customizing-your-codespace/personalizing-github-codespaces-for-your-account#turning-on-settings-sync-in-a-codespace\" target=\"_blank\" rel=\"noopener noreferrer\">Setting Sync</a> is an easy way to import your configuration from your Desktop into the Cloudspace.</p>\n<h5 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"codespace-templates\">Codespace templates<a href=\"https://luke.geek.nz/azure/Getting-Started-with-GitHub-Codespaces#codespace-templates\" class=\"hash-link\" aria-label=\"Direct link to Codespace templates\" title=\"Direct link to Codespace templates\">​</a></h5>\n<p>Instead of spending time, developing your template, you may find a devcontainer template already exists for your use case; some examples consist of:</p>\n<ul>\n<li>Ruby on Rails</li>\n<li>React</li>\n<li>Juypter Notebooks and more.</li>\n</ul>\n<p>These <a href=\"https://github.com/codespaces/templates\" target=\"_blank\" rel=\"noopener noreferrer\">Codespace Templates</a> can easily be launched from the web browser and are a great resource to test the power of Codespace and refer to when customising your own devcontainer.</p>\n<p>See <a href=\"https://github.com/devcontainers/template-starter\" target=\"_blank\" rel=\"noopener noreferrer\">devcontainers/template-starter</a> and <a href=\"https://github.com/devcontainers/feature-starter\" target=\"_blank\" rel=\"noopener noreferrer\">devcontainers/feature-starter</a> for information on creating your own!</p>\n<h5 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"devcontainers\">Devcontainers<a href=\"https://luke.geek.nz/azure/Getting-Started-with-GitHub-Codespaces#devcontainers\" class=\"hash-link\" aria-label=\"Direct link to Devcontainers\" title=\"Direct link to Devcontainers\">​</a></h5>\n<p>Within each customised Codespace is a \"<a href=\"https://containers.dev/implementors/json_reference/\" target=\"_blank\" rel=\"noopener noreferrer\">devcontainer.json</a>\" json file, and some containers will have a <a href=\"https://code.visualstudio.com/docs/devcontainers/create-dev-container#_dockerfile\" target=\"_blank\" rel=\"noopener noreferrer\">dockerfile</a>.</p>\n<p>These files will sit inside a /.devcontainer/ folder at the root of your git repository. It is worth noting that you can have multiple devcontainer files within a single repository; you will be prompted which one to be used when you start the Codespace up.</p>\n<p>These files are crucial to customising your devcontainer.</p>\n<p>Although they serve different purposes they can work standalone or together to create a consistent and reproducible development environment for your project.</p>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<table><thead><tr><th>File</th><th>Purpose</th></tr></thead><tbody><tr><td>devcontainer.json</td><td>The devcontainer.json file configures how your development environment is set up within the Docker container when using the Remote - Containers extension.</td></tr><tr><td>dockerfile</td><td>The dockerfile defines the environment you need for your project. When you create a Codespace, GitHub will use the specified Dockerfile to build a container image that includes all the tools, libraries, and configurations required to work on your project.</td></tr></tbody></table>\n<p>When you open your project in a GitHub Codespace that uses a devcontainer.json file, Visual Studio Code will automatically detect the configuration and set up your development environment according to the specified settings.</p>\n<p>You can use a dockerfile to define the environment you need for your project. When you create a Codespace, GitHub will use the specified Dockerfile to build a container image that includes all the tools, libraries, and configurations required to work on your project.</p>\n<p>Even without using a dockerfile, you can install any dependant libraries onto your codespace, but they are lost when the container gets rebuilt; there are certain approved features you can add to your devcontainer file that will be installed when a container is launched, which is great when making sure you are working on with the latest component.</p>\n<p>The idea with both these files is to <em>keep them lean</em> and make sure that you are running the components you only need. To keep launch time and performance as quick as possible, it is possible to '<a href=\"https://docs.github.com/en/codespaces/prebuilding-your-codespaces/about-github-codespaces-prebuilds\" target=\"_blank\" rel=\"noopener noreferrer\">prebuild</a>' your image if it is largely complex, but we won't be covering that here.</p>\n<h6 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"devcontainerjson\">devcontainer.json<a href=\"https://luke.geek.nz/azure/Getting-Started-with-GitHub-Codespaces#devcontainerjson\" class=\"hash-link\" aria-label=\"Direct link to devcontainer.json\" title=\"Direct link to devcontainer.json\">​</a></h6>\n<p>Let us take a look at the 'devcontainer.json' file. As Codespaces uses the <a href=\"https://containers.dev/implementors/spec/\" target=\"_blank\" rel=\"noopener noreferrer\">devcontainer</a> schema, all the customisations offered such as:</p>\n<ul>\n<li>entrypoint</li>\n<li>onCreateCommand</li>\n<li>customizations</li>\n<li>features</li>\n</ul>\n<p>Can be used, offering a vast range of customisation opportunities to suit your needs.</p>\n<p>For most purposes, you may be able to find you can get away with a devcontainer.json file without having to delve into building your own dockerfile.</p>\n<p>Let us look into the devcontainer.json file I am using for this blog article:</p>\n<div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">// For format details, see https://aka.ms/devcontainer.json. For config options, see the</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">// README at: https://github.com/devcontainers/templates/tree/main/src/markdown</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">{</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    \"name\": \"Markdown Editing\",</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    // Or use a Dockerfile or Docker Compose file. More info: https://containers.dev/guide/dockerfile</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    \"image\": \"mcr.microsoft.com/devcontainers/base:bullseye\",</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    // Features to add to the dev container. More info: https://containers.dev/features.</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    // \"features\": {},</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    // Configure tool-specific properties.</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    \"customizations\": {</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        // Configure properties specific to VS Code.</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        \"vscode\": {            </span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">            // Add the IDs of extensions you want to be installed when the container is created.</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">            \"extensions\": [</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">                \"yzhang.markdown-all-in-one\",</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">                \"streetsidesoftware.code-spell-checker\",</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">                \"DavidAnson.vscode-markdownlint\",</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">                \"shd101wyy.markdown-preview-enhanced\",</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">                \"bierner.github-markdown-preview\"</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">            ]</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">        }</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    }</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    // Use 'forwardPorts' to make a list of ports inside the container available locally.</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    // \"forwardPorts\": [],</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    // Use 'postCreateCommand' to run commands after the container is created.</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    // \"postCreateCommand\": \"uname -a\",</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    // Uncomment to connect as root instead. More info: https://aka.ms/dev-containers-non-root.</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    // \"remoteUser\": \"root\"</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">}</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>This was from an already existing template, that had everything I needed from: <a href=\"https://github.com/devcontainers/templates/tree/main/src\" target=\"_blank\" rel=\"noopener noreferrer\">devcontainers/templates</a>.</p>\n<p>A few things stand out:</p>\n<ul>\n<li>image</li>\n<li>customizations</li>\n<li>features</li>\n</ul>\n<ol>\n<li>The image is the docker image, that this Codespace is running.</li>\n<li>Customizations are application-specific customisations, in my example vscode, and the extensions that are automatically provisioned for me when I started this codespace.</li>\n<li>Features, which are currently blank, but will allow us to run scripts to install any relevant dependencies when the container is started.</li>\n</ol>\n<p>This json file is a great reference point, as we go into creating our own. You can create your own devcontainer.json file - or we can do it within the devcontainer itself using the Codespaces extension, preinstalled into your new Codespace.</p>\n<p>In our newly created Codespace from the Setting up Codespace step earlier, it's time to create our own devcontainer. The project we will be working on will be Terraform development, so we want to customise our own codespace for Infrastructure as Code development.</p>\n<ol>\n<li>Press <strong>Ctrl+Shift+P</strong> (or click View, Command Palette)</li>\n<li>Type in: <strong>Codespaces</strong> <em>(with the codespaces commands you can rebuild your container, resize and modify your codespace)</em></li>\n<li>Select <strong>Add Dev Container Configuration Files</strong></li>\n<li>Select <strong>Create a new Configuration</strong></li>\n<li>Type in <strong>Ubuntu</strong></li>\n<li>Select the latest version (or default)</li>\n<li>In the <strong><a href=\"https://github.com/devcontainers/features\" target=\"_blank\" rel=\"noopener noreferrer\">features</a></strong> list we have the option to install third-party tools and dependencies that will be installed when we launch our Codespace, search for <strong>Terraform</strong></li>\n<li>Select <strong>Terraform, tflint, and TFGrunt</strong></li>\n<li>Click <strong>Ok</strong></li>\n<li>Select <strong>Configure Options</strong></li>\n<li>Check the <strong>installTFsec</strong> and <strong>instalLTerraformDocs</strong></li>\n<li>Click <strong>Ok</strong></li>\n<li>Select the <strong>latest</strong> Terraform version</li>\n<li>Select the latest <strong>Tflint</strong> version</li>\n</ol>\n<p>This will now create a devcontainer json file, using a base Ubuntu image, with the latest version of Terraform, tflint and Terragrunt installed!</p>\n<p><img loading=\"lazy\" alt=\"Github Codespaces - Create\" src=\"https://luke.geek.nz/assets/images/VisualStudioCode_Codespace_CreateTerraform-eda65f694f8e7a7a4643e0c1e06845ff.gif\" width=\"1908\" height=\"840\" class=\"img_ev3q\"></p>\n<p><strong>Make sure you save and commit the devcontainer.json file to the repository! You have now created your first custom codespace</strong>.</p>\n<p>You can now rebuild your container, to run inside your Terraform container:</p>\n<ol>\n<li>Press <strong>Ctrl+Shift+P</strong> (or click View, Command Palette)</li>\n<li>Type in <strong>Codespaces</strong></li>\n<li>Select <strong>Full Rebuild Container</strong></li>\n<li>Accept the prompt. that it will be rebuild with the devcontainer configuration.</li>\n<li>GitHub Codespaces will then grab the Ubuntu image, and the Terraform feature and run.</li>\n</ol>\n<blockquote>\n<p>Note: If the build fails, at the time of writing, there looked to be an issue with the latest version of <a href=\"https://terragrunt.gruntwork.io/docs/getting-started/supported-terraform-versions/\" target=\"_blank\" rel=\"noopener noreferrer\">terragrunt</a>, I pined it to this specific version: 0.48.0, and it fixed it. So edit the JSON file and update latest to the version. Feel free to review my example codespace here: <a href=\"https://github.com/lukemurraynz/codespaces/tree/main\" target=\"_blank\" rel=\"noopener noreferrer\">lukemurraynz/codespaces</a>.</p>\n</blockquote>\n<ol>\n<li>Once loaded, I can immediately run 'terraform init'</li>\n</ol>\n<p><img loading=\"lazy\" alt=\"Github Codespaces - Terraform init\" src=\"https://luke.geek.nz/assets/images/VisualStudioCode_Codespace_Terraforminit-eddd7311faf520ee0d4ce0ff442201ef.gif\" width=\"1908\" height=\"840\" class=\"img_ev3q\"></p>\n<p>Now that we have Terraform installed, the Azure Terraform and HashiCorp extension - we may want the <a href=\"https://marketplace.visualstudio.com/items?itemName=eamodio.gitlens\" target=\"_blank\" rel=\"noopener noreferrer\">GitLens</a> extension, to help with working with other developers, so let us add this!</p>\n<ol>\n<li>Navigate to the <strong>Extensions</strong></li>\n<li>Search for <strong>GitLens</strong></li>\n<li><strong>Right</strong> click the <strong>extension</strong> button and select '<strong>Add to devcontainer.json</strong>'</li>\n<li>Then commit your save, you have now added the GitLens extension into your devcontainer, this will automatically be installed on your next rebuild.</li>\n</ol>\n<p><img loading=\"lazy\" alt=\"Github Codespaces - Install Extension\" src=\"https://luke.geek.nz/assets/images/VisualStudioCode_Codespace_AddGitLens-cf7f0f3b8dcaf74572b8a7764f01810b.gif\" width=\"1908\" height=\"840\" class=\"img_ev3q\"></p>\n<p>Now we have created our own Github Codespaces using devcontainers, using features and adding in extensions, last thing to add is a few settings to Visual Studio Code, such as Format on Save Mode.</p>\n<ol>\n<li>\n<p>Click on the <strong>Settings</strong> gear</p>\n</li>\n<li>\n<p>Click <strong>Settings</strong></p>\n</li>\n<li>\n<p>Search for: <strong>Format</strong></p>\n</li>\n<li>\n<p>Click on the <strong>gear</strong> next to: <strong>Editor: Format On Save</strong></p>\n</li>\n<li>\n<p>Click <strong>Copy</strong> <strong>Setting</strong> <strong>ID</strong></p>\n</li>\n<li>\n<p><strong>Navigate</strong> to your <strong>devcontainer</strong>.json <strong>file</strong></p>\n</li>\n<li>\n<p><strong>Under</strong> vscode <strong>customization</strong>, <strong>add</strong> a new <strong>item</strong> called <strong>Settings</strong> and add:</p>\n<div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"> \"settings\": {</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">         \"editor.formatOnSave\": true </span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">     },</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n</li>\n<li>\n<p>Intellisense should help you, add it in and any other settings you may want configured. you may want to consider configuring a default formatter or linter for your project.</p>\n</li>\n</ol>\n<p><img loading=\"lazy\" alt=\"Github Codespaces - Set Setting\" src=\"https://luke.geek.nz/assets/images/VisualStudioCode_Codespace_AddVSCodeSetting-e49f7d9011398781ed177fe9b5f50b09.gif\" width=\"1908\" height=\"840\" class=\"img_ev3q\"></p>\n<p>As usual, make sure you <strong>Commit the change to the repository</strong>, before you rebuild to confirm the settings have worked.</p>\n<h6 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"dockerfile\">dockerfile<a href=\"https://luke.geek.nz/azure/Getting-Started-with-GitHub-Codespaces#dockerfile\" class=\"hash-link\" aria-label=\"Direct link to dockerfile\" title=\"Direct link to dockerfile\">​</a></h6>\n<p>For those more complex scenarios, where there may not be a feature or shellscript that you can run as part of the launch, you may want to consider your own dockerfile.</p>\n<p>In this example, I am going to use the same scenario, but use a non-devcontainer image for Apache.</p>\n<p>You can create a dockerfile in the same repository.</p>\n<p>To make this work, you need an adjustment to your devcontainer.json file.</p>\n<ol>\n<li>\n<p><strong>Create</strong> a new <strong>file</strong> called: <strong>dockerfile</strong> - in the same location as the 'devcontainer.json' file</p>\n</li>\n<li>\n<p>In the dockerfile <strong>add</strong> the following line:</p>\n</li>\n<li>\n<div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"> FROM httpd:latest</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n</li>\n<li>\n<p><strong>Save</strong></p>\n</li>\n<li>\n<p>In the devcontainer.json file <strong>replace</strong> the image section with:</p>\n<div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"> \"build\": {</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"> // Path is relataive to the devcontainer.json file.</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"> \"dockerfile\": \"Dockerfile\"</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\"> },</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n</li>\n<li>\n<p>Now <strong>start</strong> your <strong>Codespace</strong></p>\n</li>\n<li>\n<p>Github will now grab the image directly from dockerhub and overly your devcontainers configuration on top of it.</p>\n</li>\n</ol>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"port-forwarding\">Port Forwarding<a href=\"https://luke.geek.nz/azure/Getting-Started-with-GitHub-Codespaces#port-forwarding\" class=\"hash-link\" aria-label=\"Direct link to Port Forwarding\" title=\"Direct link to Port Forwarding\">​</a></h4>\n<p>Github Codespaces can do port forwarding, which is either Private (ie visible only to your GitHub user), or Public (open to the internet). This is useful for local development and testing.</p>\n<p>Let us take our Apache, httpd image supplied earlier.</p>\n<p>In the same directory, we will <strong>create an index.html</strong> page:</p>\n<div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">&lt;!DOCTYPE html&gt;</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">&lt;html lang=\"en\"&gt;</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">&lt;head&gt;</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    &lt;meta charset=\"UTF-8\"&gt;</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    &lt;meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\"&gt;</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    &lt;title&gt;GitHub Codespace Port Forwarding Test&lt;/title&gt;</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">&lt;/head&gt;</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">&lt;body&gt;</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    &lt;h1&gt;Hello, GitHub Codespaces!&lt;/h1&gt;</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">    &lt;p&gt;This is a test webpage for port forwarding.&lt;/p&gt;</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">&lt;/body&gt;</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">&lt;/html&gt;</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>And <strong>adjust the dockerfile</strong> like so:</p>\n<div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">FROM httpd:latest</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">COPY index.html /usr/local/apache2/htdocs</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">EXPOSE 80</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>This will take our index.html page and feed it to the apache htdocs folder.</p>\n<p>Then we go to our <strong>devcontainer.json</strong> file and add these:</p>\n<div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  \"forwardPorts\": [\"80\"],</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">  \"postStartCommand\": \"httpd\"</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>Now <strong>save the changes</strong> and <strong>launch</strong> your Codespace.</p>\n<p>Feel free to review my example codespace here: <a href=\"https://github.com/lukemurraynz/codespaces/tree/main\" target=\"_blank\" rel=\"noopener noreferrer\">lukemurraynz/codespaces</a>.</p>\n<p><img loading=\"lazy\" alt=\"Github Codespaces - Port Forwarding\" src=\"https://luke.geek.nz/assets/images/VisualStudioCode_Codespace_PortFowarding-44396600763815d43925c5614251c41b.gif\" width=\"1908\" height=\"840\" class=\"img_ev3q\"></p>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"working-from-your-own-device\">Working from your own device<a href=\"https://luke.geek.nz/azure/Getting-Started-with-GitHub-Codespaces#working-from-your-own-device\" class=\"hash-link\" aria-label=\"Direct link to Working from your own device\" title=\"Direct link to Working from your own device\">​</a></h4>\n<p>This is all great, but sometimes it feels more natural to work from a locally installed Visual Studio Code instance.</p>\n<p>Using the: <a href=\"https://marketplace.visualstudio.com/items?itemName=GitHub.codespaces\" target=\"_blank\" rel=\"noopener noreferrer\">GitHub Codespaces</a> Visual Studio Code extension, you can connect to a Codespace (or start one), directly from your own Visual Studio Code installation.</p>\n<ol>\n<li>Install <strong><a href=\"https://marketplace.visualstudio.com/items?itemName=GitHub.codespaces\" target=\"_blank\" rel=\"noopener noreferrer\">GitHub Codespaces</a></strong> extension</li>\n<li>Press <strong>Ctrl+Shift+P</strong> (or click View, Command Palette)</li>\n<li>Type in <strong>Codespaces</strong></li>\n<li>Click <strong>Connect to a Codespace</strong></li>\n<li>Select your codespace</li>\n</ol>\n<p><img loading=\"lazy\" alt=\"Github Codespaces - Connect to Codespace\" src=\"https://luke.geek.nz/assets/images/VisualStudioCode_Codespace_CodespaceLocally-c80bf1a89e74f685400cb01ed18e51de.gif\" width=\"1908\" height=\"944\" class=\"img_ev3q\"></p>\n<p>As you can see you can now connect to one or multiple GitHub Codespaces, from your own locally installed Visual Studio instance!</p>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"additional-settings\">Additional Settings<a href=\"https://luke.geek.nz/azure/Getting-Started-with-GitHub-Codespaces#additional-settings\" class=\"hash-link\" aria-label=\"Direct link to Additional Settings\" title=\"Direct link to Additional Settings\">​</a></h4>\n<p>Additional settings, that can be configured are:</p>\n<ul>\n<li>Setup <a href=\"https://docs.github.com/en/codespaces/prebuilding-your-codespaces/configuring-prebuilds\" target=\"_blank\" rel=\"noopener noreferrer\">Prebuild</a></li>\n<li>Codespace <a href=\"https://docs.github.com/en/codespaces/managing-your-codespaces/managing-encrypted-secrets-for-your-codespaces\" target=\"_blank\" rel=\"noopener noreferrer\">Secrets</a> (Repo &amp; Org Level)</li>\n<li><a href=\"https://docs.github.com/en/codespaces/customizing-your-codespace/personalizing-github-codespaces-for-your-account#dotfiles\" target=\"_blank\" rel=\"noopener noreferrer\">Dotfiles</a> (Org Level)\nOrganisation</li>\n<li><a href=\"https://docs.github.com/en/codespaces/customizing-your-codespace/configuring-automatic-deletion-of-your-codespaces\" target=\"_blank\" rel=\"noopener noreferrer\">Configuring automatic deletion of your codespaces</a></li>\n</ul>\n<p>Hopefully this article has given you a taste of what GitHub Codespaces can do.</p>",
            "url": "https://luke.geek.nz/azure/Getting-Started-with-GitHub-Codespaces",
            "title": "Coding on the Cloud - Getting Started with GitHub Codespaces",
            "summary": "Github Codespaces gives you the full capability of your favourite IDE (Integrated Development Environment) like Visual Studio Code, Jupyter, or JetBrains and an extension, to your web browser. With it, you can develop your applications without needing any dependant service or tool installed or configured locally, giving developers a standard way of working on applications and scripts.",
            "date_modified": "2023-08-15T00:00:00.000Z",
            "author": {
                "name": "Luke Murray",
                "url": "https://luke.geek.nz"
            },
            "tags": [
                "Azure"
            ]
        },
        {
            "id": "https://luke.geek.nz/azure/Move-Azure-Public-IP-to-another-subscription",
            "content_html": "<p>You can move a <a href=\"https://learn.microsoft.com/azure/virtual-network/ip-services/public-ip-addresses?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Public IP</a> address in Microsoft Azure, to a new Subscription (BUT NOT A <a href=\"https://learn.microsoft.com/azure/virtual-network/move-across-regions-publicip-portal?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">DIFFERENT REGION</a>).</p>\n<p>There are some limitations as below:</p>\n<blockquote>\n<p>You can't move a VPN Gateway that is associated with a Standard SKU public IP address to a new subscription.\nAzure Public IPs are region specific and can't be moved from one region to another.</p>\n</blockquote>\n<p>Some resources aren't <a href=\"https://learn.microsoft.com/azure/azure-resource-manager/management/move-support-resources?WT.mc_id=AZ-MVP-5004796#microsoftnetwork\" target=\"_blank\" rel=\"noopener noreferrer\">supported</a> to be moved, but a Public IP is.</p>\n<p>Before you move the Public IP, make sure its dissociated (unattached) from a resource.</p>\n<p><img loading=\"lazy\" alt=\"Dissociate IP\" src=\"https://luke.geek.nz/assets/images/PublicIP_dissociate-8c977cae9c35e1e31c2cabe19f22cbd6.png\" width=\"1174\" height=\"202\" class=\"img_ev3q\"></p>\n<p>Then once dissociated, you can trigger the move.</p>\n<p><img loading=\"lazy\" alt=\"Dissociate IP\" src=\"https://luke.geek.nz/assets/images/PublicIP_MoveAnotherSub-4bc302c7d8a3f9c42a43417d402efb26.png\" width=\"834\" height=\"237\" class=\"img_ev3q\"></p>",
            "url": "https://luke.geek.nz/azure/Move-Azure-Public-IP-to-another-subscription",
            "title": "Move an Azure public IP to another subscription",
            "summary": "You can move a Public IP address in Microsoft Azure, to a new Subscription (BUT NOT A DIFFERENT REGION).",
            "date_modified": "2023-08-11T00:00:00.000Z",
            "author": {
                "name": "Luke Murray",
                "url": "https://luke.geek.nz"
            },
            "tags": [
                "Azure"
            ]
        },
        {
            "id": "https://luke.geek.nz/azure/AADDS-Referenced-account-locked-out",
            "content_html": "<p>So you have just stood up <a href=\"https://learn.microsoft.com/azure/active-directory-domain-services/?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Entra ID Domain Services</a> <em>(formally - or still known as of July 2023 as: Active Directory Domain Services (AAD DS)</em>) and trying to login and join a computer to the AAD DS domain and you get the following error:</p>\n<blockquote>\n<p>The referenced account is currently locked out and may not be logged on to.</p>\n</blockquote>\n<p><img loading=\"lazy\" alt=\"The referenced account is currently locked out and may not be logged on to.\" src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAZAAAAC0CAYAAAC69XpYAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAAB3RJTUUH5wceFBM2cAmigQAAF9tJREFUeJzt3W+IG+edB/Dv2F5T/6lj6iP2kQQ7RVr39nSUsMako5qQYA6kbZvFLxTuIGyaF5oehJMIuMTJpibt5g8xHNJd4CK9SL0EckQvgpJmNRBMgkmlhuClHFH3nJXo2TTl7HLO2W5iF6/tuRfSSKPR/H00+rPW9wMLu5qZZ37PM8/Ob+YZ6ZGkaZoGIiIinzYMOwAiIlqfWgnk9u3b4M0IERF5JXEIi4iIRHAIi4iIhDCBEBGRECYQIiISwgRCRERCmECIiMaMJElYXl62Xb68vAxJklzL8ZFA6shGJUhS8yeaRd37xiNOhSJJkBTV4vUosoOsqKo042jGZPiJDjKQehZR4brb9ZUhtCcRdTlz5gy+F/2+ZRJZXl7G96Lfx5kzZ1zL8ZZA6llEpTBW5jVoWvNnEVgyn2+HIqiTkgy5GkdXDhmoOrILVWSOxloxZWp6m5cQSYctklyfhFIoa2WkQj63G+m+QkQAMD09jd+Uf92VRPTk8ZvyrzE9Pe1ajocEUkd2Lo1ISUMuZng5lEIqZrvRupSYz6C6MMQ7q/oSCpF5m5N2DLlaBnK+iNE9F49PXyFa78xJxG/yALwkkPoSCpUkZp1OAPUsooahlvZFcvPuQG0vV1Sgno1aDMt0r9u1rG4qt65CkeLIo4J02DAE1RGP0jzhNrZRlKjhNZNwCvORNOZsbmdUxTAs06qknzraxaY3dQERp4YOzSAh51HUNwqk3V3qVTf8nlWch9O89BUAqFkdY5c47PZdN5aV7ewnlm3dObw23DtOouEyJhG/yQPwOoQlTyFsu1CFEm5cdWqaBq2WQTVuPNlXkF4AFjUNWimJfFzCHBYb65aSqKRPGE6ihnVrGSA95zI0FUNOKyGpD/XkYs14CkjoQz8lYKFVSAXVqUVoWg5257hYroSIzX5jufZwUjK/IFBHp9hUnEhH3E++LcG1u329jCpIr8zaHDcDx77SHZe3OOz23dkGiygg39E+Fm2tnkA6UmoNr+V4Z0QkzFsCqaygZresvooqDFedoRTmkxWstDaQkVlMIQQAsVkkISMx0xyjic0iiSpW6xbrdpXjUX0VVf2ORJIgxfOotAox7NtWDLlSBOkTFqdHVb8KjhtOVD7q6BSbWkQ1c9Q2sRn3NRVGsO1uWy9THfVnM13HzcCpr1jG5SUOm33XV1GVM9AXhVLzSOqb2LV1eApyPj7YNyQQjSjjsJXVMxE37gnEPGwyMHWsVkW3TaKkGR7i+r3MjB1FxvxAvZ5FNI5muTVk5CBjazw8d01u9SUUKhFM+n2w7VhmUPVCb30lyDhaLNo6lEJZ07CIOQ5h0VgzP/Owe7DuxMMdSAip+cYQiPmEmlUBhCYRQee4/ELewzi4pQoKS80rw47x9DCmZMPVtVq0v1JuxrPQ0xVmCKnFDKpxw5VwbQUVfXimvoRCRaRYm9gcH57r9OGa5vBbUO0eRL1aXPpK0HGEJhGppHGi9ehroX28XPpBKFVGLSOjankbRXRns3tg7jeJeBvCiuWaY+yGh5xzwEwM0N8d1FoWLiBRs3/G4ExGZGWuWY7hZGk4MUmSBKmI9lAFYphNGh+iN+JBOmzxQNaHUAqLxsvg2FFkkEZYkiDNrSAidIVsHZv9w3PDEIy0gKmaccw+oHYPpF7G8pz6StBxxJArtfvFHBId/cKyH6jth/HhdATzvt+nTLT+HThwwPaBuZ5EDhw44FrOCE3nrkKRFjBVE/jswbqmQomu4mi5+VyAxNWziIZXMO/wJgkiCs6mYQdAMeTKPN0FQT2RRkXOuLwLjIiCwgRC61gd2WgY6dbzkiRKGu/kiAZlhIawiIhoPeFsvEREJIQJhIiIhDCBEBGRECYQIiISwgRCRERCmECIiEgIEwgREQlhAiEiIiFMIEREJIQJhIiIhDCBEBGRECYQIiISwgRCRERCmECIiEgIEwgREQlhAiEiIiFMIEREJIQJhIiIhDCBEBGRECYQIiISwgRCRERCmECIiEgIEwgREQlhAiEiIiFMIEREJIQJhIiIhDCBEBGRECYQIiISwgRCRERCmECIiEgIEwgREQnZNMyd37h6BV+cKuHip2V8/cc/4E+fljuW330wim333IfdB6O493Acm3fcNaRIiYjITNI0TRv0Tm9cvYLll57DF6dK2HL9z9izWcK3JiTs2CRhQmqss6YBV29q+HJNw4UbGq5v+SbuPRzH9LMvMpEQEY2AgQ9hnT35Ot595AGsqQUcmriGQzs3Irx1A3ZNtJMHAExIwK4JCeGtG3Bo50YcmriGNbWAdx95AGdPvt5zHIokQer4iSJbBwAVSut3MarSKDPqWohxX73vt7NcBWoQRZEDv8fMvH6Qx9zvfoPsH6L18BqHSLz9butBHLvR/z8e2BCWftdx4b23Mb19A3Zt95e7tmwAvrt9Ay6tfY3/fPV5/N/Zak93IzlNQw4qFGkBU7UyUiGhYiyoKOZlZAIt068YclpsWDunkTcq/cNrHKMS76CNfr0Hcgdy4+oVnHr8UVz61ds4tHMjdhlvNXzaNSHh0M6NuPSrt3Hq8Udx4+qVACM1WFJadyeddxJq++5FMV8bqFCkOPKoIB2W0F5s2MbzVYv1NqpijMd0FaQqzZgs7myy7vWJZrMOV1VW9W6UrShRSNEs6l1/O9Xdal33+jvHYnzN6QrUZ9wdx9n4etHyyAF1ZKOSqb07+0ajrY1/1y3Kt2jnZnn6Xa55HeNxbiwy77eOYPuHVflux8/qmDht4ydep5gg+H9ttY752Hvo57bHzqq/iNR78AaSQJZfeg6367/Dg3dtRA+5o2VCAh68ayNu13+H5Zee673ALhWkV2ahaRq0UhKV9InWbaSqxIGSBk2rIVNdMP1jxJDTSkhCRqamIRdrb1PN1JrlRZCeszphdrLbJjwlo7JSa65URFUGCkvNU14xD3kq7Ls++n4WUUDeIR7reldQnVqEVk4hZPG3c93N27rXX1+WT5Yay5qNbPWaM/e4rerbEdcsbNorhFRZa6yjlRBJn4Bq6hvlVMr0d8hbO9cyQDqM4qwGrZaBnC8ahjg6j3M+rljs1+q2uJf+YV1+kH3eT7xOMYn/X1vEZzr2nvq57bGz6i8i9R68vieQsydfx4X33g4seej0JHLhvbcDeSbSSUbmaPMkFJtFElWsNq8CinkgH5cgSWGkKxXo53J7jSGtxEyoXV6lgCXH/yb7bUIziVbHU4tVJOYTQGEJddSxWjVs47k+7W1CqXkkbeOxq7d5n8a/3epuF6/Tds0hwqOxrvU7X3PjFrdVfS3isite1a8U48i32tuNh3YOTSICGVNhNH83lm13nN3borf+YVWP4Pq893jd9PJ/7XTsPfZzp2Pnqb+I1rt/+ppAbly9gs9eexXf3b6hI3lI2+/CttfewcZwxHNZG8MRbHvtHUjb2888JqTGc5HPXnu1f0NZXRpXNY2rhfZdxsCEZpCQq1itqyhWE5iJzSCBFdTqSyggAcvzcSCGXO+B66G+qgJpYQq15hWlt5NuAPulHgyx3XvqL8PV1wSy/NJz2L32Vdczj62v/BKbHpA9JxE9eWx6QMbWV37ZsWzXhITda1/1aSjLLIwpudIaMvImhtmkYRu1iLzsdqJ32iaEmQRQmFtANTGDEEKYSVRRPLECJGa6hoJ81Uct2gzJiNTbrR6i21nFYv9a60rStm5W7Orrtb0ARCYbxyKQ/XrV3raeXfDY1j7i8VyXoPt8v3lpd6e2CCB2of4yfH1LIPqHBCe3du/iL9mfQfvqKqTtO1yTSPvOYwe0r67iL9mfda0zuXUDvjhVGsBdSAipxcY4ZuN209tb7GK5EiL6NvEqMovdY/5+tglNRlCpVBCZDLX+zufzrb+F61OEzdWPWL3d6iG2XQipsmGZotq/Np9sDks41c1PfT22V2wWyXzcYp3Giab9YNf8t3g7N8iIrMxBkiSE0zC0mXk/gu1g24bd5Qfd5/3zU2cv7e7cFj3FbttfRl/fPkj4+3f+AyvP/zMO7dxoudycGL5+6ghu1aq+19F9fPkWpn7xr/j2kX8IvC7jop6NIlxIoGbxUJtGXT/ekt4p8P6hKpDiQEnLgSN161Pf7kAuflrGns32T81v1ar4+qkjtncifpIHAOzZLOGiaSoUclfPRltvC+y8aiXqV/9ovuU1nkeyxOSxnvXtDuTU44/i259/4vqZD6tEAcBX8gCAS2safr//QRx+893A6kBERPb6lkDe2v9X+Ptdmzy9ddecRAD4Sh5AY+6sDy7dxD9+/r+9hk5ERB709V1YXj/3YR7O8ps8/OyLiIiCMb7fB1LPIqqoqGcVn5MZDmoCvCHE0dUmRET2+ppA1jwOjpmHsLy+xVdkX0REFIy+JZC7D0Zx9ab7Wd3qIbrTu7PsXL2p4e6DUe8BhlIo52IIpXIWb3v0OhV0490klpMmepiQrXtyOi8T+FmVa47DFLfFBGzGd9e0yjW3SWtyRiKibn1LINvuuQ9futwW2L1V1+0tvla+XNOw7Z77gqyCizqy0QVMmSZN9DMhm3lyOqcJ/OzL7Y6jk/UEbKFUuTV5WxJJlDhnBhH51LcEsvtgFBdu2CcQt895+E0iF25o2O3nDqRHhbkwVuaNH9ryPyFb5+R0ThP42ZfbHYeZ8wRsjeRk8178WM7jzLZENI76lkDuPRzH9S3fxPXb3cu8fkjQaxK5fhutr7wdjAoAGdWuqTB7nZDNbnu71+3i8EhVEEeJE/YRkZC+JZDNO+7CvYfjWL3WnUG+kfq557fqmpPIN1I/71pn9dpt3Hs4HuB3pbtNxCcjsVjG/ErYMM+O3YRsxq+ldJqQzeMEfq5x+Pia0Dich674DISIHPT1XVjTz76IixPbccn0LOTaMz/Gzd9WPH/OQ08iN39bwbVnftyx7NKahosT2zH97IsBRu5tIr5YroZEIdyevK+nCdk8TuBnUW5nHN6oShx55BHXH6JbfisgEZG9vn0SXXf25Ov4r1efx6GdwX6hFNB46+7Hl2/hb376C3zniZ8EW/gAcPJCIlrP+v5Bwu888RPs+dFj+OTKrUA/q7GmAZ9cuYU9P3psXSUPTl5IRHeKvt+BAI3vBjn1+KOBfS+6njw2hP4Wh998N8BnH0RE5NVApjLZvOMuHH7zXez64WP4+PKtrmciflxa0/Dx5VvY9cPHmDyIiIZoIHcgRmdPvo7PXnsVu9e+wuTWDdjiMYVdv914t9XFie34u6d+uq6GrYiI7kQDTyBAY0hr+aXn8MWpErZc/zP2bJbwrQkJOzZJreGtNa0xPcmXaxou3NBan/OYfvZF3nUQEY2AoSQQnf696Rc/LePrP/4BfzJ9o+DdB6PYds992H0wGvDnPIiIqFdDTSBERLR+je/3gRARUU+YQIiISAgTCBERCWECISIiIUwgREQkhAmEiIiEMIEQEZEQJhAiIhLCBEJEREKYQIiISMjYJhBF/yrX1k8Uja8VV6G0fu8vVWnsOzqInQkbXHv0zilWr98VPyrMdfFzHHo5Zr0e76D7S7/7353Sv4dj07ADGJacpiEHFYq0gKlaGamBfy2gimJeRmYo+x5HMeS02LCDILqjjO0diKslpXV30nmHoLbvXhSr69nGVYKiRCFFs6hbbqNCkeLIo4J0WEK7GKuyvZTXXi+b9RO3XV2MrxdtGqiObFTqcV+G1xyvto1/29Wzs0277+o6y2x/tbDdXYnVMXOOqX2Mej1mTnVptHu7CMWwDzt27WwXV+cy5/5pft2uvzjFYde2bsfUrg/6+V+wi9dwDJvb6yMG7bpb7d/L8fERX0cfc2qLIdHGWklLQtYyNfNr0JAsNf9MakBSK+lLk9Aai2paRjZv295eNiyw3qZ73/breS3POe7WMpe6lJKG/ZWSGrrayKrO7vuyeq1jP3JGq7XKM+7T+LdTPa2Op10Z7Xgt1+6K1z2m9jEK4pjZ76+WkVvb1DJyx36sYrVvZ6d6dvfvXvuL+PF263/6esa2c/5fcI/XcAxrGU1Gs+61jCZb9p32/r0dHx/x2bbT8PEOxJKMzNHmcEdsFklUsdq8CijmgXxcgiSFka5UsFKz3j4xo49Led3GaT2v5TnFbVjmWE5j3db+YrNI2jWTql9BxZF33Zf1ax37qRSw5OnCyq6eXoUxJecRt7yDtIvXPab2MTL/LXLM7IVmEpCrq6ijjqUCTPu1rot1O9vXszAXxsq8cXi11/7Sy/F2qp5VHwTc/hc89W/9GIYmEYGMqTCavxv2Y7F/b8fHR3xBtFOfMIH4JiNT06BpjZ+cp3OM122CXi+ouCyoCqSFKdQ0DZpWcvgnHEUhpMoaalMLDkNYQQvqmAEIzSCBApbUJRSQgGP+EFIBIKPalckCrEMQht0H7fbf9+MzOphAfAljSq6g4OtywOs2Qa/nto1dOabX1SLydsVGJhHqWsfrvmKYTZr2I+v/bI31W1fpTjH0IJRaREa2uuK3r4NYTCLHzEkIMwlgpbgCJGbgfH5yb+fuuGQkFsuYXwkbxtp77S99Ot6WfdCJj/4tvH8/x8fMqZ1GDxOILyGkFjNAOuzyAFZkm6DXM21TLiGib6OoDuWYXi/C+souNotkPm6xjs2+ul4DYjnDa/EqMoup5j9bCKn5ZHO4xCGG7qAwm/TykFF/SBlGOjJv8S44mzoIxdQsz/cxc65LaDKCfL7qMnzVLMmpnS2OS3u7GhKFcDD9xS0O27Z1aAfbPujEe7yuHPbv5/h0FWvbTl779+DwK22J1qF6NopwIYFaOeXzCpcGYVyOD+9AiNaVxttEw2kYrkxpdIzX8eEdCBERCeEdCBERCWECISIiIWOcQEZt0rhRjGNU6khEo2iMEwgREfWCCcQwaWLn2+DdJk008zZhXTSbtZg4zn1ZXyavs53MTV/HavI2p3oS0TgZ8wRSQXpltjE1QymJfLz9AS9ViQMlDZpWQ6a64HqiVJU4qplas6wI0nPtGTiNyxZR6Pjkq9syqxg69jUL20/SOsVkrnslfcL04bYYcloJyeb0FeXmp+2cyySicTLmCaTXSRN17hPW6ctCqXnDJ1bdlvVz8jqRCQnX10RvRNRfY55AnIzCxHGjEAMRkbUxTyDtScvq2QUPk8zZ8TFhndPEg66TErpt4zUmUU5lrrevjCWiXo15ApERWZmDJJmnHvA/+Z3jRHG2k7f5WBbo5HVedU/e1nuZRHSn4FQmA+Y0ydq4TMBGRHeGMb8DGYz29293T7LmtIyIaJTxDoSIiITwDoSIiIQwgRARkRAmECIiEsIEQkREQphAiIhICBMIEREJYQIhIiIhTCBERCSECYSIiIQwgRARkRAmECIiEsIEQkREQphAiIhICBMIEREJYQIhIiIhTCBERCSECYSIiIQwgRARkRAmECIiEsIEQkREQphAiIhICBMIEREJ2XTlypVhx0BEROsQ70CIiEgIEwgREQlhAiEiIiFMIEREJIQJhIiIhDCBEBGRECYQIiISwgRCRERCmECIiEjIpmEHQETUTztf+Z9hhzDyLj/z10Lb8Q6EiIiE8A6EiMbC+X/aOuwQRs7ef7/W0/a8AyEiIiFMIEREJIQJhIiIhDCBEBGRECYQIqJ++egY9u7d2/o58sY540Ic23sE+ksfHduLvcc+GkKQ4phAiIj64NwbR7D3CeDk+fM4f/48zp8/jR+8/5B1kvjoGJ7ASZx/+eGBx9kLJhAiosCdw4fvA8dPv4x2StiHJ//lOKbf+gCdKeQjHHsCOLnOkgfABEJEFLxzH+L95f24f5/p9X2P4AfTb+EDQwZ5/+l/Q7gj0awfTCBERAM1jfD9+u/LWF5exvsfnhtiPOKYQIiIgrbvfuzH5/jvc6bXu+5MpnH89Ensf+FpvGFedx1gAiEiCtzDUI4DLzx0zPC84xzeePoF4LhiGq56GC+f3I8Xnn4D5wYcZa84FxYRUR/se/IdnMYRPLR3b+u16eOn8c6T+7pXfvhlnPxgLx46Apx+50lYrDGSpMuXL2vDDoKIqF/06dw5mWI3fTJFTudOREQDxQRCRERCmECIiEgIH6IT0Vjo9cuTqBvvQIiISAjfhUVEREJ4B0JEREKYQIiISAgTCBERCWECISIiIUwgREQkhAmEiIiEMIEQEZEQJhAiIhLy/yKfQeIk/iSMAAAAAElFTkSuQmCC\" width=\"400\" height=\"180\" class=\"img_ev3q\"></p>\n<p>This is commonly due to the following:</p>\n<blockquote>\n<p>Entra ID doesn't generate or store password hashes in the format that's required for NTLM or Kerberos authentication until you enable Azure AD DS for your tenant. For security reasons, Entra ID also doesn't store any password credentials in clear-text form. Therefore, Azure AD can't automatically generate these NTLM or Kerberos password hashes based on users' existing credentials.</p>\n</blockquote>\n<p>Essentially this means, that the password hashes are not comaptible with Entra ID Domain Services, and the fix is to <strong>reset the password of an Entra ID account</strong> used to access Entra ID services, to allow Entra ID Domain Services, to hash and validate the Entra ID credentials. The reset only needs to happen, if the password for the accounts haven't been reset since Entra ID Domain Services has been deployed.</p>\n<p>After resetting the password to my Entra ID account, and waiting an hour for replication I was successfully able to login and join a Windows Server to Entra ID Domain Services.</p>\n<p><img loading=\"lazy\" alt=\"Entra ID Domain Services - Join account\" src=\"https://luke.geek.nz/assets/images/AADDS_JoinAccount-7115b6ef7a68ce94b8de457c9c0871fb.png\" width=\"548\" height=\"458\" class=\"img_ev3q\"></p>",
            "url": "https://luke.geek.nz/azure/AADDS-Referenced-account-locked-out",
            "title": "Entra ID Domain Services - Referenced account locked out",
            "summary": "So you have just stood up Entra ID Domain Services (formally - or still known as of July 2023 as",
            "date_modified": "2023-07-31T00:00:00.000Z",
            "author": {
                "name": "Luke Murray",
                "url": "https://luke.geek.nz"
            },
            "tags": [
                "Azure"
            ]
        },
        {
            "id": "https://luke.geek.nz/azure/Entra-ID-login-to-a-CIS-Hardened-Linux-Azure-Virtual-Machine",
            "content_html": "<p>Currently, <a href=\"https://www.cisecurity.org/\" target=\"_blank\" rel=\"noopener noreferrer\">CIS</a> (Center for Internet Security) <a href=\"https://azuremarketplace.microsoft.com/en-us/marketplace/apps?search=CIS&amp;page=1?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Marketplace images</a>, do not support being Entra ID (Azure Active Directory) Joined.</p>\n<p>Although this article is about allowing Entra ID login to a Ubuntu machine, its worth noting the current decisions around Windows as well currently:</p>\n<blockquote>\n<p>'The Windows CIS Benchmarks are written for Active Directory domain-joined systems using Group Policy, not standalone/workgroup systems. Adjustments/tailoring to some recommendations will be needed to maintain functionality if attempting to implement CIS hardening on standalone systems or a system running in the cloud.\n'Currently, we do not support Azure Active Directory and it is not compatible with our EXISTING Hardened Images.</p>\n</blockquote>\n<p>In fact when you, attempt to create a CIS Level 1 Ubuntu image in the Azure Portal, you get:</p>\n<p>\"This image does not support Login with Azure AD.\"</p>\n<p><img loading=\"lazy\" alt=\"CIS Image does not support Login with Azure AD\" src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAq0AAACNCAYAAACdb0O0AAAACXBIWXMAAA7EAAAOxAGVKw4bAAAAB3RJTUUH5wcbBDUaqvceBAAAFYBJREFUeJzt3X9Q1Pedx/GX1hmYVikmXYpJqC5wo4N6wmpT2OauaDXSzmg9DXjgjWGotOYikTk7wnDmmowOB8ykY8RcmJJjPG+AU6p3xVwHXZJwcxnYSxXhYhjsAYunN6UQW7PGO7i54v2xv2GXXX4I30yejxlG9rvf7+fH16/ja9/fzxcWPfnEiocCAAAADGzxQg8AAAAACIfQCgAAAMMjtAIAAMDwCK0AAAAwPEIrAAAADI/QCgAAAMMjtAIAAMDw5iC05qjuA4ccDofefnn2rc1egl79Z9d4PnhrZ+BbVTY5HA7f13/0qrvjbb3+/NqFGSoAAAAiMvvQWvSnsppGNDIkrU1/VQlzMKhZeeaINqeMaWRoTKY/3KW9k3ZwqvOnh3X4ldM6d+Wahr+4VjtfuSBb1eYFGCwAAAAiMevQemRziqJuteu1D25LKZv1o2fcbxTUq9u/qulwyOHoVv2bru22Kk8LharvdsjRWilJqmh1yNFt09v/2uvav0BK2Pmq3r7mqY52y/ba/pDh2JprUcKDHp1t6NGYyaqcosn7jP6mWc1/95pKX9ynbTvL1f7bKCV/t0iHZnsyAAAA8EjMLrSufFWb10fpdvd5nfvJe/ro/xKUlm11vffOGzp65LAOHzmsw39zXU5JTvtplf4ygnZjEhT1wVH9sXmD9r1Tpjer9iv5fovKc/fpx+98ouTdZToZJIxKOTrw9QSN9byr09X/oPaRKK39ozBR9Fat3rDflr6UpIznpzd9AAAAzI9ZhdaEF61aq4/03k/apVtv6dqvpISMA9opSbfadflis5ovRmtXdppinO06XVqr25E0/KBHLUeaXfv+cLPWRjl17ewLqrW36+zBDvUpSslP7598XMH3tNE0ovam05LO6/JHI4pKy1JZmO7aH4y5vvlC5HMHAADA/Fky80Ot+tHTydISaX+bQ74IuU67sqXmJterwr//S202OdX+16WqvRVh07//Hznd3xaa4yTFyPqyQw6/B72cS6ImHXYoa6NiFKXNVQ45vMsPTLK+kiC9Ejou73zsy5I+0f1fRTg+AAAAzKuZh9bdB5SxUuprOqxqu2fjN1VUmSNr9iGp6bQSflCvQ8/EyGkvV+lPA0Nj1BcSJN2WZNKXvxi6m9rbwypLH9N7R59WQdNUAypTVlqURt5/TSf+8T/d276mvaVHZM08IquK1R7ssJVH9Hy6Sbr1c519P7KpAwAAYH7NOLTu3bFOJvXp3Tea1eytoF6X9c9zlJyyRYdWjinjh1bFPPhIZ5t/o7TdO5Wm/9XHvXc0LCk5s0JHdl9WzJ/t0tqpRtHcqb4/yZH1L+r16hfP6dr9r8n6vEVj3yvQj/12S3jFqrVLnGp/77SaL/q2fzW7UNZ0i/Y+I29ojf7qTu18/g9kffqbsn47TQnq07njIUItAAAAFtwMQ+sh5XzdJN255hdYJem2mm/e1t6kNO09u1JPPSZJa7W//HX38gGn2o9v0FvNFr36XasOvWbViL1Fnc4sWUJ19X6Jik+Z9OaBzdr/ilX7JTnvtOh0wE5W/ShzrfTgujrrAg+v/WW/jqSnKeP7OdKIJMXI8oPXXf2NOTVy8+f68cvFOvvvMzsTAAAAePQWPfnEiocLPQgAAABgKvwaVwAAABgeoRUAAACGR2gFAACA4RFaAQAAYHiEVgAAABgeoRUAAACGR2gFAACA4RFaAQAAYHiEVgAAABgeoRUAAACGR2gFAACA4S1Z6AEAmLmVK1cqMSlZixdP7/Pn+Pi4Bvr7dOvWrUc0MgAA5hahFfgMS0xKVtf16xobG53WcVFR0UpNSyO0AgA+M1geAHyGLV68eNqBVZLGxkanXZ0FAGAh8b8WAAAADI/QCgAAAMMjtAIAAMDwCK0IsHz5ci1fvnyhhwEAABBgFqG1UjaHTRVzMoxK2Rzdqi+Yk8bCt1lQr+7uehVOqy2HbFVzN7ppq7LJMel8F6q+2yGHw+9rWvNyMZvNKjzwfe3Zs1tbtmzWc3t2a8+e3TKbzXM3fgAAgFkwyI+8KtE2c8kjbbOi1aGNnWZtOzqDpqosiuvvk7bXq/DoPtXO3SAjVmGJU1+/9J3GQpXm+o/AqfbjG7SvzvWqsLFbZQ6bkszbVBpBuxstFlksaap9628nvbdnz24lms16591352QOAAAAM8XygAhUWOJ0o+G8bmidMue0GhypSm003dD5hhtSSuaUldTa3A0qt8fpO43h663Lly/XKvOqgMDqvzTgwoWLil0ey3IBAACw4B5BaJ1wy7q10vdWlc1ve73quz237/2WGrhv3Vc0drv3DXKLf8Lt/YpWh7q9Ia1Stu56Ffq1WdHq0N4kKTk78PZ50lR9eLkCY1tdrdp6pHXbCn1jcATemrdVufryX0bg/7qi1SFbo+s413gDz1XI5QdVFsX1tKm2ri2i4FxrCx9uJWnLls26cOFiwLbY2NiA1xcuXNSWLZvDtAQAAPBozXFoLVR9d5nW9ZTLbDbLbDbrnHJcAa2gXt3ZcWo/7tpu7oyTNSZEMzFWfUenZTabVW6XrHmVge/X3dFwTJySJLlCpdMX0qosSh65E3ALv3SrWef6pb4ms8wb3Lf3w/XhmVFjliswakIYrNunDe45mpv6pP7zES09SE6RTpvN2pAr1Xcfkl53t2E+L2UHWyNcqPrtcbphq5U0ITjPUmKQNatbv70lov0AAADm0xyH1mTFqV2n/dZclja0u4LemjjF9Ld4117q6Hm1O0M04/S1UWu7IafpqQlVwxJd60/Wxiq5q5AtuiFXiC1MiFNfZwTrY8P2IUmFykyROzBKClrprJRt+7DKt0a2JrfvsmdNbLLiYmJkfdlTac1RsuKUMKmqnKl1uqE293mLtIqqCcE9mAGHI6IxAwAALLR5exDrGwlxco70zVl7pZ19clgqVTgi3bCVqE3dyqkqVELKsK7lzlEnBZlaFxOjmJcdcrzs2+zcVijV1cpVWc7S8OsbZvhwVp/OhXlgqnDbOsXExKjM4VCZbwTKLJBq64IfU5FnlUbKw/aeaDZr+fLl+t3vfhdyH9azAgAAI5jjSmufhmXVIb+HgCryrFJPmw7YbkjpOb7b31U5oZcHROJop/pMFuWYhtVW56pAxm0/pHUjnRE9NR+Jwm3rJLtvqYPZbJb5eLt3HhWtZYq77HtyX5L6R5xKtniWGlRqY1Ko1vs07EwO88CUq9LrXVLh/ppqOUNFq0N7TYHV7lB+duGiLGlpAcG0s/N6wD7P7dmtn01Y9woAADDfZhlak7U34EGkWu3bcF7D6WXebXt1Xhtya6W6fTptj/PtbxkOvTwgIiW6NpKsuBHXelPXrfsYDYdYGlDa2TfpQaypTVga4FHXphvOZG181+Z7uMs9p+7GQtXmtqgvKce9zSL1h2p/8rmaNLaCwKUB3iNtN+RMsrg/APgvMXCdb++63TAc7uUB/sH1Wmen7wwc+L46O69794PxjI+PKyoqetrHRUVFa3x8/BGMCACAR2PRk0+seLgwXVfK5rDoWoQ/TxSPjtls9j6A9Vu/pQIEVuNbuXKlEpOStXjx9D5/jo+Pa6C/T7du3XpEIwMAYG4tWGgtbOxWmalF5ggfYML8CLfGFQAAYCHM42/EqpTNkaNkz0tnu8o3EFiNhsAKAACMaAGXBwAAAACR4de4AgAAwPAIrQAAADA8QisAAAAMj9AKAAAAwyO0AgAAwPAIrQAAADA8QisAAAAMj9AKAAAAwyO0AgAAwPAIrQAAADA8QisAAAAMj9AKAAAAwyO0AgAAwPAIrQAAADA8QisAAAAMj9AKAAAAwyO0AgAAwPAIrQAAADA8QisAAAAMj9AKAAAAwyO0AgAAwPAIrQAAADA8QisAAAAMj9AKAAAAwyO0AgAAwPAIrQAAADA8QisAAAAMj9AKAAAAwyO0AgAAwPAIrQAAADA8QisAAAAMj9AKAAAAwyO0AgAAwPCWzPTAL+lTLV10X4vmcjQAAAD4XHko6dOHy/RAS6fcb8aVVgIrAAAAZmuRXLkynBmHVgIrAAAA5kIkuZI1rQAAADA8QisAAAAMj9AKAAAAwyO0AgAAwPAIrQAAADA8QisAAAAMj9AKAAAAwyO0AgAAwPAIrQAAADA8QisAAAAMj9AKAAAAwyO0AgAAwPAIrQAAADA8Q4XWv9oqvZAumZYu9EgAAABgJEsWegAez62XUuIkxUkjD6SffbjQIwIAAIBRGKLSalrqCq0ez62n2goAAAAfQ4TWF9Jdf0avzFD0ygxJ0rfM02+ncWBUHRO+GiuLVd3VpbIg+5fZRnWloThsu5HuN28quwwznryGITVWLvQoQgs9vho1drUob7YdVHapYy7akaSCFl0Z8FyrgeMrsw2puiCyZspso+qw1czFiKansksdAxP+rRW06Mqkf5PzPzQAwGffgofWlDj3sgBJT73YrqdebJc0s2prbmK0MhKjdan/nq6ecH2fWxJ6//Jt0Xo272TYdiPdD59DJanKSM1Sw1y0VZelZxNTVT6rRmq0Pume7pt2RRxy50qZZY3uO+OVOfEDVf8ZZbj/bWYknpGyDfYhEADwmbDgofVguu/7/+79hcb+q9P7+oX0IAfM0IqGIXelx1exymvocn9frOouTyVoclU2cL8uVXvastX4VZL82x3yVZb8Kl7+2xtt/tXSGl+VOETVLuBYi/87NQEVZl8VK/icAtqZWPGq7NKVhhZfe/7Vusouv2qZq728hiEVpcdqVXawyt7kOZXZ/M+tr5JYZhtSdaVfRc7TVmWXrjTUhPi7CT7vMtuQqhtcY/3Fv001vhCCzFNSYMXQ1uWrgha0qLGhWJOujYEglVH/CnlAVdVzN6BGjbYa99zytSomU0X+7WztCv135+0jXY/bK3SmR1q9Ncj15R1bsaptftdaQYuuuM+R/zl09RP++pRqtN7UpjOnuqSUrCkqzweVe6JNSs8PevcDAIBQFjS0PrdeivOrpv5+9BONjzq9r1PipG8lzkVPa7RaFa5KT9OQNuUGBpi8hlKt7il1V4LCVbp8bV1Svjpeks5MaLchL95bWbokd8WroEX56UO65N7+oda42ytWdVe6PvRUoi7HK39iFWrKY/OlJvexJ9r0eLYrCJXZSqVTnu1DynQH7PyULlUnhq5CL0uPd4+lVFdNvrFfyZa3/2p7vHbYatSQF69q+z0NNkUrY9vBgHbKbH7jCluJjNWm7e7zmFiqq6Z8byhblr7LOw9Pv1PNW4rVJpNdGYnR+u43Qo8vqBDzlIpV/VKm7nr665RWBW1g6utMN4e8gS5va6qWKV4rCiQVZGn1iN3vujuo3MQzGnS2qToxXkV1gfPKONGmx7cHD49llnjdbD2phlb/8HjQexcio6lX9+0V7jZD8fWVWxLB9Sm5wnJPixrqWnRTqcqYqspb16KbzineBwAgiAULrRMfvpKk8VGnxkc/Cdi2Z91cPJTVqzbP7f0SuwYnvNvQ2iWlV0S41s7X1uDIPQ1edgeygHZ9lakdSbH6ympXSJH9jDeYlHf2ur4pyNLqmDXa4alkZa/RMtMa/w6nPlZtuuQJn3VZauuP14qCGq1PitWmY+42j2VqmWmV8upadFOZKpqi6njf289JdfQMBe2/Ie+fNGhaNeU6zvLOXq3KjnQd5j1dPeUJtifV0XNPjycUu8fjC1gNrV26b1qlvJDzdrfVGEFADSLkPCf2F+Qacpn6OlNdi24qXqskrTIN6VLTkKsaujpeGukNMzq/edW16OZIsH1qtN7UpY46T18TwmNBi65Y7BEsdfHrK4LrU/KFZdffn3+VFwCAubFgoTXYg1a//+SOxu5cDdgWt3RmD2VNS12Wnk2M1oeW4MsDpqdY1V279PEJT7XuXvhDnG3e6mdGYoRVwbB6vRVDX7XzpIpSo5XRmf7oH4gpSVVGYoX00lS3lD9vTqqjJ17rK2u0XnaVl9h117TGL/DNTl7DLveSglF1DFRoU0ysX3gsVvVL8WqbybUV7vosaFGm34ekovRYLZtqiUBBllZrKETwBwAguAUJrcGqrJL02Pbjemz78Unb5+tHYJVvi9Ylb8VuptboKzFD+nWdJBUrIyVWktRweyjgP/Iyi7taVTeouzGZ2jFFgAx9rKty6j22oEWZSUP6dV2vPnaumfxAjEdJqjKaer3VzHBcleh8v3Wxu7RqZDCCh49Oqii1VFfd1UVpjdZX+rXh3S82YP3ljnR5Q1zAvHMzJe8t6GDzjmg6IYWcZ92g7sb4VS0r00MsD4igj9tDenz7Lj0+0iupVx+bdilT7urorBQrI0XeBxA9Dz3ddc8nr6FUX7k8YemLyTenstxMLQvWbATXp6tCXerXb7QujYQ4pqBFV45l6u7lLDWoRo2z/pAIAPi8WJBfLvDcuuDb773/+pTHvGl/NOPxPFAkyfWk86wCxEFdsg+paGBUO3RPg/3uSmtJqi5ZRlU0MKoiSYP9vd79c0+s0pVjo+rIdm0ZbJqw3jTksSdVdCrL79h7unoi3hVMUteocaBCHQMVkqT79lI925qlK8c84aRXlxIjrO7VZenMVs+c5Kq8pbqqbQ2tXco/NqoOy5mAClyZbVQ7kuTtu0iSGtu8Y71vb/OrtN3TXVOpd6yDTdGuJQGV0v2ReOW7563+M8pw39oONe+JASjU+CRJ7qpkkfd8pIacZ25TujqOjarjmKT+3plXCUvsupu9Sx+7Q3lHT6k2mYJ9ADioD0dGVTQwpIwT8fp1uHYLsrRaXToTcO0e1If9o1p/sUWZqbFalj7hGruc753ToL1N903BGg53fbrC8s1TgddSeWevOiw10k1JSfnqGMh3v+P6yR5Tr6kFAGCyRU8+seLhTA6MXxT2v9GQTu0MfAArEsOfSi81z7hLwymzjWp959Q/kuvzosw2pBWN8ZODTGWXriScMd6PG6vsUofFPkfLOAAAgCQNPVwx5fsLUmk9/u7016n+i+PRjGXeuG+Lem7B3reX6lkC62dEsaq7KrQpxv3SrwILAADmx4JUWgEAAAB/4SqtC/7LBQAAAIBwCK0AAAAwPEIrAAAADI/QCgAAAMMjtAIAAMDwCK0AAAAwPEIrAAAADI/QCgAAAMMjtAIAAMDwCK0AAAAwPEIrAAAADI/QCgAAAMMjtAIAAMDwCK0AAAAwvBmH1odzOQoAAAB8bkWSK2ccWj99uIzgCgAAgFl5KFeuDGfJTDt4oKV68HDpTA8HAAAAIsaaVgAAABgeoRUAAACGR2gFAACA4RFaAQAAYHiEVgAAABgeoRUAAACGR2gFAACA4RFaAQAAYHiEVgAAABgeoRUAAACGR2gFAACA4RFaAQAAYHj/D44jftvkknYUAAAAAElFTkSuQmCC\" width=\"685\" height=\"141\" class=\"img_ev3q\"></p>\n<p>However, as I go into below, we can indeed login to the CIS hardened image, using the <a href=\"https://learn.microsoft.com/en-us/azure/active-directory/devices/howto-vm-sign-in-azure-ad-linux?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Microsoft Azure AD based SSH Login</a> extension.</p>\n<blockquote>\n<p>Be wary, that although this works, you may run into issues with operational support of this from CIS, due to the hardening. This is also Entra ID LOGIN (not JOINED!). You won't see the device under Entra ID Devices.</p>\n</blockquote>\n<p><img loading=\"lazy\" alt=\"Entra ID login to a CIS Hardened Linux Azure Virtual Machine\" src=\"https://luke.geek.nz/assets/images/Blog_Headler-EntraID_login_CIS_Linux_Azure_Virtual_Machine-509aed112ffc335de9109abb2c734e43.gif\" width=\"1200\" height=\"628\" class=\"img_ev3q\"></p>\n<p>There are many security benefits of using Azure AD with SSH log in to Linux VMs in Azure, including:</p>\n<ol>\n<li>Use of your Entra ID (Azure AD) credentials to log in to Azure Linux VMs.</li>\n<li>Get SSH certificate-based authentication without needing to distribute SSH keys to users or provision SSH public keys on any Azure Linux VMs you deploy.</li>\n<li>Reduce reliance on local administrator accounts, credential theft, and weak credentials.</li>\n<li>Password complexity and password lifetime policies configured for Azure AD help secure Linux VMs as well.</li>\n<li>With Azure role-based access control, specify who can login to a VM as a regular user or with administrator privileges. When users join or leave your team, you can update the Azure RBAC policy for the VM to grant access as appropriate. When employees leave your organization and their user account is disabled or removed from Azure AD, they no longer have access to your resources.</li>\n<li>With Conditional Access, configure policies to require multi-factor authentication and/or require client device you are using to SSH be a managed device (for example: compliant device or hybrid Azure AD joined) before you can SSH to Linux VMs.</li>\n<li>Use Azure deploy and audit policies to require Azure AD login for Linux VMs and to flag use of non-approved local accounts on the VMs.</li>\n</ol>\n<p>So after your CIS Hardened Image, in my case I am using Ubuntu 20.04 has been deployed in Azure. Lets set this up.</p>\n<p>You will need to make sure you have a few prerequsites.</p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"prerequisites\">Prerequisites<a href=\"https://luke.geek.nz/azure/Entra-ID-login-to-a-CIS-Hardened-Linux-Azure-Virtual-Machine#prerequisites\" class=\"hash-link\" aria-label=\"Direct link to Prerequisites\" title=\"Direct link to Prerequisites\">​</a></h3>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"network\">Network<a href=\"https://luke.geek.nz/azure/Entra-ID-login-to-a-CIS-Hardened-Linux-Azure-Virtual-Machine#network\" class=\"hash-link\" aria-label=\"Direct link to Network\" title=\"Direct link to Network\">​</a></h4>\n<p>VM network configuration must permit outbound access to the following endpoints over TCP port 443.</p>\n<p><a href=\"https://packages.microsoft.com/\" target=\"_blank\" rel=\"noopener noreferrer\">https://packages.microsoft.com</a>: For package installation and upgrades.\n<a href=\"http://169.254.169.254/\" target=\"_blank\" rel=\"noopener noreferrer\">http://169.254.169.254</a>: Azure Instance Metadata Service endpoint.\n<a href=\"https://login.microsoftonline.com/\" target=\"_blank\" rel=\"noopener noreferrer\">https://login.microsoftonline.com</a>: For PAM-based (pluggable authentication modules) authentication flows.\n<a href=\"https://pas.windows.net/\" target=\"_blank\" rel=\"noopener noreferrer\">https://pas.windows.net</a>: For Azure RBAC (Role Based Access Control) flows.</p>\n<p>Also make sure you have enabled TCP Port 80 for: ubuntu.com, specifically <a href=\"http://archive.ubuntu.com/\" target=\"_blank\" rel=\"noopener noreferrer\">http://archive.ubuntu.com</a> as the Microsoft Azure AD based SSH Login, will need to download and install the following packages: aadsshlogin and aadsshlogin-selinux as needed.</p>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"virtual-machine\">Virtual Machine<a href=\"https://luke.geek.nz/azure/Entra-ID-login-to-a-CIS-Hardened-Linux-Azure-Virtual-Machine#virtual-machine\" class=\"hash-link\" aria-label=\"Direct link to Virtual Machine\" title=\"Direct link to Virtual Machine\">​</a></h4>\n<p>The CIS hardened image, will need to have a <a href=\"https://learn.microsoft.com/azure/active-directory/managed-identities-azure-resources/overview?WT.mc_id=AZ-MVP-5004796#managed-identity-types\" target=\"_blank\" rel=\"noopener noreferrer\">System Managed Identity</a> setup. This can be easily enabled in the Identity blade of the Virtual Machine.</p>\n<p>The Entra ID (Azure Active Directory) users that need to login with to the Linux Virtual Machine are a member of one of the following Azure RBAC (Role Based Access Control) groups, as per their requirements:</p>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<table><thead><tr><th>RBAC Role</th><th>Notes</th></tr></thead><tbody><tr><td>Virtual Machine Administrator Login</td><td>View Virtual Machines in the portal and login as administrator</td></tr><tr><td>Virtual Machine User Login</td><td>View Virtual Machines in the portal and login as a regular user.</td></tr></tbody></table>\n<p>Only one role is required. These roles are supported for both Windows and Linux.</p>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"client\">Client<a href=\"https://luke.geek.nz/azure/Entra-ID-login-to-a-CIS-Hardened-Linux-Azure-Virtual-Machine#client\" class=\"hash-link\" aria-label=\"Direct link to Client\" title=\"Direct link to Client\">​</a></h4>\n<p>On the jumphost, client PC you will be connecting to the Linux virtual machine from, you need the latest <a href=\"https://learn.microsoft.com/cli/azure/install-azure-cli?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure CLI</a> with the Azure CLI extension 'ssh' installed.</p>\n<div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">az extension add --name ssh</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>The minimum version required for the extension is 0.1.4.</p>\n<div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">az extension show --name ssh</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"install-extension\">Install Extension<a href=\"https://luke.geek.nz/azure/Entra-ID-login-to-a-CIS-Hardened-Linux-Azure-Virtual-Machine#install-extension\" class=\"hash-link\" aria-label=\"Direct link to Install Extension\" title=\"Direct link to Install Extension\">​</a></h3>\n<p>Make sure the Virtual Machine is on, for the extension to install.</p>\n<h5 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"install-using-the-azure-portal\">Install using the Azure Portal<a href=\"https://luke.geek.nz/azure/Entra-ID-login-to-a-CIS-Hardened-Linux-Azure-Virtual-Machine#install-using-the-azure-portal\" class=\"hash-link\" aria-label=\"Direct link to Install using the Azure Portal\" title=\"Direct link to Install using the Azure Portal\">​</a></h5>\n<p>Once the pre-requsites have been met, it is time to install the extension.</p>\n<ol>\n<li>Login to the <a href=\"https://portal.azure.com/\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Portal</a></li>\n<li>Navigate to your CIS Hardened Virtual Machine</li>\n<li>Click on Extensions + Applications</li>\n<li>Click + Add</li>\n<li><img loading=\"lazy\" alt=\"Azure Portal - Extensions\" src=\"https://luke.geek.nz/assets/images/AzurePortal_CISHardenedVM_Extensions-7d80816f877407cbfbe4483d8369a2ca.png\" width=\"859\" height=\"706\" class=\"img_ev3q\"></li>\n<li>Search for: Azure AD based SSH Login</li>\n<li><img loading=\"lazy\" alt=\"Azure Portal - SSH Extension\" src=\"https://luke.geek.nz/assets/images/AzurePortal_CISHardenedVM_SSH_Extension-7d33b8acf511a51b6a05e24ccffa30d9.png\" width=\"1887\" height=\"897\" class=\"img_ev3q\"></li>\n<li>Select the Azure AD base SSH Login extension</li>\n<li>Click Next</li>\n<li>Click Review and Create</li>\n<li>Click Create</li>\n</ol>\n<p>After a few moments, the extension and supporting components, will be installed. You can check the status under the Extensions + Application blade make sure that Provisioning has been succeded, before provisioning to the next step to login.</p>\n<p><img loading=\"lazy\" alt=\"Azure Virtual Machine Extension\" src=\"https://luke.geek.nz/assets/images/AzurePortal_CIS_Level1_Ubuntu_ADSSHExtensionStatus-89350aa724ec1ef5de7c256dd04422fe.png\" width=\"1879\" height=\"703\" class=\"img_ev3q\"></p>\n<h5 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"install-using-terraform\">Install using Terraform<a href=\"https://luke.geek.nz/azure/Entra-ID-login-to-a-CIS-Hardened-Linux-Azure-Virtual-Machine#install-using-terraform\" class=\"hash-link\" aria-label=\"Direct link to Install using Terraform\" title=\"Direct link to Install using Terraform\">​</a></h5>\n<p>You can use the following Terraform code snippet, to install the extension to a Linux Virtual Machine:</p>\n<p>Make sure you assign the extension, to the virtual machine, using the ID.</p>\n<div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">resource \"azurerm_virtual_machine_extension\" \"aad_login\" {</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">name                 = \"AADLogin\"</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">virtual_machine_id   = </span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">publisher            = \"Microsoft.Azure.ActiveDirectory\"</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">type                 = \"AADSSHLoginForLinux\" # For Windows VMs: AADLoginForWindows</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">type_handler_version = \"1.0\"                 # There may be a more recent version</span><br></span><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">}</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<h5 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"install-using-powershell\">Install using PowerShell<a href=\"https://luke.geek.nz/azure/Entra-ID-login-to-a-CIS-Hardened-Linux-Azure-Virtual-Machine#install-using-powershell\" class=\"hash-link\" aria-label=\"Direct link to Install using PowerShell\" title=\"Direct link to Install using PowerShell\">​</a></h5>\n<p>To install the AADLogin extension to a Linux Virtual Machine in Microsoft Azure using PowerShell, you can follow these steps:</p>\n<ol>\n<li>\n<p>Open PowerShell on your local machine, or <a href=\"https://learn.microsoft.com/azure/cloud-shell/overview?WT.mc_id=AZ-MVP-5004796\" target=\"_blank\" rel=\"noopener noreferrer\">Azure Cloud Shell</a>.</p>\n<p>Connect-AzAccount\nSelect-AzSubscription -SubscriptionName \"Your Subscription Name\"\n$vm = Get-AzVM -ResourceGroupName \"Your Resource Group Name\" -Name \"Your VM Name\"\nSet-AzVMExtension -ResourceGroupName $vm.ResourceGroupName -VMName $vm.Name -Name \"AADLoginForLinux\" -Publisher \"Microsoft.Azure.ActiveDirectory.LinuxSSH\" -Type \"AADLoginForLinux\" -TypeHandlerVersion \"1.0\"</p>\n</li>\n</ol>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"login-to-virtual-machine\">Login to Virtual Machine<a href=\"https://luke.geek.nz/azure/Entra-ID-login-to-a-CIS-Hardened-Linux-Azure-Virtual-Machine#login-to-virtual-machine\" class=\"hash-link\" aria-label=\"Direct link to Login to Virtual Machine\" title=\"Direct link to Login to Virtual Machine\">​</a></h3>\n<p>Now that the extension is stood, up its time to connect.</p>\n<p>REMEMBER to make sure that the Entra ID (AAD) accounts you want to login to the Linux image is a member of either of the following roles, directly assigned to the Virtual Machine/Resource Group, or in an Entra ID (AAD) group that has been delegated the permissions.</p>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<table><thead><tr><th>RBAC Role</th><th>Notes</th></tr></thead><tbody><tr><td>Virtual Machine Administrator Login</td><td>View Virtual Machines in the portal and login as administrator</td></tr><tr><td>Virtual Machine User Login</td><td>View Virtual Machines in the portal and login as a regular user.</td></tr></tbody></table>\n<ol>\n<li>Open a Command Prompt</li>\n<li>Log in to the Azure using:\naz login</li>\n<li>A web browser will prompt and ask you to authenticate, where you will go through the MFA (Multifactor Authentication) and complete login to your Entra ID account.</li>\n<li>Once authenicated you can run:\naz ssh vm -n cistest -g cistest\nNote: -n is the VM name and -g is the Resource Group, that the VM is located inside.</li>\n</ol>\n<p><img loading=\"lazy\" alt=\"Entra ID Login - Linux VM\" src=\"https://luke.geek.nz/assets/images/CISHardenedImageEntraIDLogin-57ade4e971d8a17ca09fccf77b983a04.gif\" width=\"1632\" height=\"688\" class=\"img_ev3q\"></p>\n<p>You should now have successfully authenticated to your Linux virtual machine using Entra ID credendials.</p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"troubleshooting\">Troubleshooting<a href=\"https://luke.geek.nz/azure/Entra-ID-login-to-a-CIS-Hardened-Linux-Azure-Virtual-Machine#troubleshooting\" class=\"hash-link\" aria-label=\"Direct link to Troubleshooting\" title=\"Direct link to Troubleshooting\">​</a></h3>\n<p>If you are unable to connect, it may be due to an issue with the AADSSHLogin extension. You can troubleshoot by reviewing the extension log.</p>\n<div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#F8F8F2;--prism-background-color:#282A36\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#F8F8F2;background-color:#282A36\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#F8F8F2\"><span class=\"token plain\">cat /var/log/azure/Microsoft.Azure.ActiveDirectory.AADSSHLoginForLinux/CommandExecution.log</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>The Azure directory is protected, so you will need Administrator rights to delve into the logs.</p>",
            "url": "https://luke.geek.nz/azure/Entra-ID-login-to-a-CIS-Hardened-Linux-Azure-Virtual-Machine",
            "title": "Entra ID login to a CIS Hardened Linux Azure Virtual Machine",
            "summary": "Currently, CIS (Center for Internet Security) Azure Marketplace images, do not support being Entra ID (Azure Active Directory) Joined.",
            "date_modified": "2023-07-28T00:00:00.000Z",
            "author": {
                "name": "Luke Murray",
                "url": "https://luke.geek.nz"
            },
            "tags": [
                "Azure"
            ]
        }
    ]
}