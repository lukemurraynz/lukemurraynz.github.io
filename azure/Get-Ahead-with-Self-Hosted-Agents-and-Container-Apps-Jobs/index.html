<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.1">
<title data-rh="true">Get Ahead with Self-Hosted Agents and Container Apps Jobs | luke.geek.nz</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://luke.geek.nz/img/social-card.png"><meta data-rh="true" name="twitter:image" content="https://luke.geek.nz/img/social-card.png"><meta data-rh="true" property="og:url" content="https://luke.geek.nz/azure/Get-Ahead-with-Self-Hosted-Agents-and-Container-Apps-Jobs/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Get Ahead with Self-Hosted Agents and Container Apps Jobs | luke.geek.nz"><meta data-rh="true" name="description" content="When considering build agents to use in Azure DevOps (or GitHub), there are 2 main options to consider:"><meta data-rh="true" property="og:description" content="When considering build agents to use in Azure DevOps (or GitHub), there are 2 main options to consider:"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2023-09-13T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://luke.geek.nz"><meta data-rh="true" property="article:tag" content="Azure"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://luke.geek.nz/azure/Get-Ahead-with-Self-Hosted-Agents-and-Container-Apps-Jobs/"><link data-rh="true" rel="alternate" href="https://luke.geek.nz/azure/Get-Ahead-with-Self-Hosted-Agents-and-Container-Apps-Jobs/" hreflang="en"><link data-rh="true" rel="alternate" href="https://luke.geek.nz/azure/Get-Ahead-with-Self-Hosted-Agents-and-Container-Apps-Jobs/" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="luke.geek.nz RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="luke.geek.nz Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="luke.geek.nz JSON Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0QDLBY7NNN"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-0QDLBY7NNN",{anonymize_ip:!0})</script><link rel="stylesheet" href="/assets/css/styles.4a383e58.css">
<script src="/assets/js/runtime~main.c45408b7.js" defer="defer"></script>
<script src="/assets/js/main.677f59ab.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"dark")}(),function(){try{const a=new URLSearchParams(window.location.search).entries();for(var[t,e]of a)if(t.startsWith("docusaurus-data-")){var n=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(n,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:#D3D3D3" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY">Happy New Year! This is a redesign of my website, hopefully you like it!</div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="luke.geek.nz" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.png" alt="luke.geek.nz" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">luke.geek.nz</b></a><a class="navbar__item navbar__link" href="/Tags/">Tags</a><a class="navbar__item navbar__link" href="/Archive/">Blog Archive</a></div><div class="navbar__items navbar__items--right"><a href="https://twitter.com/lukemurraynz" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-icon" aria-label="X"><svg height="20" width="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 8.586l4.293-4.293a1 1 0 011.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 011.414-1.414L10 8.586z" clip-rule="evenodd"/>
          </svg></a><a href="https://www.linkedin.com/in/ljmurray/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-icon" aria-label="LinkedIn"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" height="20" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854V1.146zm4.943 12.248V6.169H2.542v7.225h2.401zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248-.822 0-1.359.54-1.359 1.248 0 .694.521 1.248 1.327 1.248h.016zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274 0-1.845.7-2.165 1.193v.025h-.016a5.54 5.54 0 0 1 .016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225h2.4z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure/azure-email-communication-services/">Deploying and Testing Azure Email Communication Services</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure/microsoft-copilot-azure-preview/">Microsoft Copilot for Azure - Preview</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure/Azure-DevTest-Subscription-Considerations/">Azure Dev/Test Subscription considerations</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure/Azure-Image-Builder-Build-Pipeline-with-Azure-DevOps/">Azure Image Builder Image Build with Bicep and Azure DevOps</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure/misc/Book-Review-Azure-architecture-explained/">Book Review Azure Architecture Explained</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="https://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="When considering build agents to use in Azure DevOps (or GitHub), there are 2 main options to consider:"><header><h1 class="title_f1Hy" itemprop="headline">Get Ahead with Self-Hosted Agents and Container Apps Jobs</h1><div class="container_mt6G margin-vert--md"><time datetime="2023-09-13T00:00:00.000Z" itemprop="datePublished">September 13, 2023</time> · <!-- -->15 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://luke.geek.nz/img/logo.png" alt="Luke Murray" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Luke Murray</span></a></div><small class="avatar__subtitle" itemprop="description">Author</small></div></div></div></div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><p>When considering <a href="https://learn.microsoft.com/azure/devops/pipelines/agents/agents?view=azure-devops&amp;tabs=yaml%2Cbrowser&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">build agents</a> to use in <a href="https://azure.microsoft.com/products/devops?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure DevOps</a> <em>(or <a href="https://docs.github.com/en/actions/using-github-hosted-runners/about-github-hosted-runners" target="_blank" rel="noopener noreferrer">GitHub</a>)</em>, there are 2 main options to consider:</p>

















<table><thead><tr><th>Agent type</th><th>Description</th></tr></thead><tbody><tr><td><a href="https://learn.microsoft.com/azure/devops/pipelines/agents/agents?view=azure-devops&amp;tabs=yaml%2Cbrowser&amp;WT.mc_id=AZ-MVP-5004796#microsoft-hosted-agents" target="_blank" rel="noopener noreferrer">Microsoft-hosted agents</a></td><td>Agents hosted and managed by Microsoft</td></tr><tr><td><a href="https://learn.microsoft.com/azure/devops/pipelines/agents/agents?view=azure-devops&amp;tabs=yaml%2Cbrowser&amp;WT.mc_id=AZ-MVP-5004796#install" target="_blank" rel="noopener noreferrer">Self-hosted agents</a></td><td>Agents that you configure and manage, hosted on your VMs</td></tr></tbody></table>
<p><a href="https://learn.microsoft.com/en-us/azure/devops/pipelines/agents/hosted?view=azure-devops&amp;tabs=yaml&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Microsoft-hosted agents</a>, can be used for most things, but there are times where you may need to talk to internal company resources, or security is a concern, which is when you would consider self-hosting the agent yourself.</p>
<p>Here is a table that summarizes the pros and cons of self-hosted Azure DevOps agents and Microsoft-hosted agents:</p>




















<table><thead><tr><th><strong>Agent Type</strong></th><th><strong>Pros</strong></th><th><strong>Cons</strong></th></tr></thead><tbody><tr><td>Self-hosted</td><td>More control over the environment, ability to install dependent software needed for builds and deployments, machine-level caches and configuration persist from run to run, which can boost speed.</td><td>Maintenance and upgrades are not taken care of for you; you must manage the agent yourself.</td></tr><tr><td>Microsoft-hosted</td><td>Maintenance and upgrades are taken care of for you; each time you run a pipeline, you get a fresh virtual machine discarded after one use. Microsoft-hosted agents can run jobs directly on the VM or in a container. The pre-defined Azure Pipelines agent pool offers several virtual machine images, each including various tools and software. You can see the installed software for each hosted agent by choosing the Included Software link in the table. Microsoft-hosted agents run on a secure Azure platform.</td><td>You have less control over the environment, you cannot install dependent software needed for builds and deployments, and machine-level caches and configurations do not persist from run to run.</td></tr></tbody></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">​</a></h2>
<p>Self-hosted agents give you more control over your environment, allowing you to install dependent software needed for your builds and deployments.</p>
<p>As Azure DevOps pipeline jobs come and go as they complete each task required, you want to be able to scale the agents out as required and pay for only what you use, you could consider <a href="https://learn.microsoft.com/azure/devops/pipelines/agents/scale-set-agents?view=azure-devops&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Virtual Machine Scale Set agents</a>. Still, you have to have to maintain virtual machine images and storage, they can be slow to provision and start, and they could become inconsistent as manual changes can be easier to do.</p>
<p>Here is a table that summarizes the comparison between Container Apps Jobs for an Azure DevOps Agent and using an Azure Virtual Machine scale set:</p>




















<table><thead><tr><th><strong>Agent Type</strong></th><th><strong>Pros</strong></th><th><strong>Cons</strong></th></tr></thead><tbody><tr><td>Container Apps Jobs</td><td>Can run containerized tasks that execute for a finite duration and exit, allowing you to perform tasks such as data processing, machine learning, or any scenario requiring on-demand processing. Container apps and jobs run in the same environment, allowing them to share capabilities such as networking and logging.</td><td>You have less control over the environment, you cannot install dependent software needed for builds and deployments, and machine-level caches and configurations do not persist from run to run.</td></tr><tr><td>Azure Virtual Machine scale set</td><td>You have more control over the environment, allowing you to install dependent software needed for your builds and deployments. Machine-level caches and configuration persist from run to run, which can boost speed.</td><td>Maintenance and upgrades are not taken care of for you; you need to manage the agent yourself.</td></tr></tbody></table>
<p>Container Apps Jobs allows you to run containerized tasks that execute for a finite duration and exit, performing tasks such as data processing, machine learning, or any scenario requiring on-demand processing. Container apps and jobs run in the same environment, allowing them to share capabilities such as networking and logging. However, you have less control over the environment, you cannot install dependent software needed for builds and deployments, and machine-level caches and configurations do not persist from run to run.</p>
<p><em>The choice between Container Apps and VM scale sets for Azure DevOps agents should consider your specific project requirements and constraints. Each option has its own set of advantages and trade-offs.</em></p>
<p>For our discussion today, we will provision Azure DevOps Agents using <a href="https://learn.microsoft.com/azure/container-apps/jobs?tabs=azure-cli&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Container Apps Jobs</a>.</p>
<p><img loading="lazy" alt="Get Ahead with Self-Hosted Agents and Container Apps Jobs" src="/assets/images/BlogHeader-GetAheadwithSelf-HostedAgentsandContainerAppsJobs-615cf198386d2518210ba9d27883e035.gif" width="1200" height="628" class="img_ev3q"></p>
<p>As we want a self-hosted agent to have access to our internal resources, we will deploy a <a href="https://learn.microsoft.com/en-us/azure/container-apps/networking?tabs=azure-cli&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Consumption based Internal Container Apps Environment</a>, to host our jobs.</p>
<p><a href="https://learn.microsoft.com/azure/container-apps/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Container Apps</a> is a service that allows you to run containerized applications in the cloud. It provides a platform for running and scaling containerized applications, and it can be used to deploy and manage containerized applications in a variety of environments.</p>
<p>There are two types of compute resources in Azure Container Apps: <strong>apps</strong> and <strong>jobs</strong>.</p>
<p>Apps are services that run continuously. If a container in an app fails, it&#x27;s restarted automatically. Examples of apps include HTTP APIs, web apps, and background services that continuously process input.</p>
<p>Without <a href="https://github.com/microsoft/azure-container-apps/issues/24" target="_blank" rel="noopener noreferrer">scaled job</a> support by Azure Container App Jobs, a job could fail during execution; this has now been resolved with Container App Jobs.</p>
<blockquote>
<p>Azure Container Apps jobs enable you to run containerized tasks that execute for a finite duration and exit. You can use jobs to perform tasks such as data processing, machine learning, or any scenario where on-demand processing is required.
Jobs are tasks that start, run for a finite duration, and exit when finished. Each execution of a job typically performs a single unit of work. Job executions start manually, on a schedule, or in response to events. <a href="https://learn.microsoft.com/azure/container-apps/jobs?tabs=azure-cli&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Examples of jobs include batch processes that run on demand and scheduled tasks</a>.</p>
</blockquote>
<p>Running self-hosted agents as event-driven jobs allows you to take advantage of the serverless nature of Azure Container Apps. Jobs execute automatically when a workflow is triggered and exit when the job completes.</p>
<blockquote>
<p>Container apps and jobs don&#x27;t support running Docker in containers. Any steps in your workflows that use Docker commands will fail when run on a self-hosted runner or agent in a Container Apps job; other <a href="https://learn.microsoft.com/en-us/azure/container-apps/jobs?tabs=azure-cli&amp;WT.mc_id=AZ-MVP-5004796#jobs-restrictions" target="_blank" rel="noopener noreferrer">restrictions also exist</a>.</p>
</blockquote>
<p>For an Azure DevOps Agent, we want to execute tasks or remove them. This is where Container Apps Jobs and <a href="https://keda.sh/" target="_blank" rel="noopener noreferrer">KEDA</a> come in handy.</p>
<blockquote>
<p>KEDA (Kubernetes-based Event Driven Autoscaling) is an open-source project that provides event-driven autoscaling for Kubernetes workloads. KEDA can scale any container in response to events from various sources such as Azure Service Bus, Azure Event Hubs, Azure Storage Queues, Azure Storage Blobs, RabbitMQ, Kafka, and more.</p>
</blockquote>
<p>One of the supported scalers is <a href="https://keda.sh/docs/2.11/scalers/azure-pipelines/" target="_blank" rel="noopener noreferrer">Azure Pipelines</a>.</p>
<p><em>This specification describes the azure-pipelines trigger for Azure Pipelines. It scales based on the number of pipeline runs pending in a given agent pool.</em></p>
<p>Jobs can be triggered in three ways:</p>
<ul>
<li>Manual jobs are triggered on demand.</li>
<li>Scheduled jobs are triggered at specific times and can run repeatedly.</li>
<li>Event-driven jobs are triggered by a message arriving in a queue.</li>
</ul>
<p>We will use both <strong>Manual</strong> and <strong>Event-driven</strong>.</p>
<p>The <strong>Manual</strong> job will be run once to create a <a href="https://keda.sh/blog/2021-05-27-azure-pipelines-scaler/#placeholder-agent" target="_blank" rel="noopener noreferrer">placeholder</a>, Azure DevOps agent in the pool.</p>
<blockquote>
<p>&quot;You cannot queue an Azure Pipelines job on an empty agent pool because Azure Pipelines cannot validate if the pool matches the requirements for the job.&quot;</p>
</blockquote>
<p>As our Container Jobs are temporary, a placeholder agent <strong>needs to remain</strong> in the Agent pool <em>(i.e. don&#x27;t delete it)</em> to keep it active. This agent will be offline and can be Disabled if required in Azure DevOps. The Azure resource, however, can then be deleted.</p>
<p>For the actual agents themselves that will run our code, they will be <strong>event-driven</strong>.</p>
<p>To provision our Azure Container App Job build agents, we will use <a href="https://learn.microsoft.com/azure/azure-resource-manager/bicep/overview?tabs=bicep&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Bicep</a> to create our resources.</p>
<p>Our resources will consist of:</p>
<ul>
<li><a href="https://learn.microsoft.com/azure/container-apps/networking?tabs=azure-cli&amp;WT.mc_id=AZ-MVP-5004796#accessibility-levels" target="_blank" rel="noopener noreferrer">Internal Container Apps Environment</a> (Internal environments have no public endpoints and are deployed with a virtual IP (VIP) mapped to an internal IP address)</li>
<li><a href="https://learn.microsoft.com/azure/virtual-network/virtual-networks-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Virtual Network</a> with 2 subnets (One subnet for resources, such as Azure Key vault, Container Registry, the other subnet dedicated to the Container App environment)</li>
<li><a href="https://learn.microsoft.com/azure/container-registry/container-registry-intro?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Container Registry</a> (this registry will be used to build and contain our container for the DevOps agent. The container registry will have a private endpoint to the internal network)</li>
<li><a href="https://learn.microsoft.com/azure/azure-monitor/logs/log-analytics-workspace-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Log Analytics workspace</a> (to hold the Logs from the Container App Environment)</li>
<li><a href="https://learn.microsoft.com/azure/key-vault/general/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Key Vault</a> (the key vault will hold our PAT (Personal Access Token), which will be used to join our COntainer App Job agents to the agent pool. The key vault will also be on the internal network, accessed via a private endpoint)</li>
<li><a href="https://learn.microsoft.com/azure/dns/private-dns-privatednszone?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Private DNS zones</a> (the DNS zones, will allow the Container App Environment, to reach the Key vault and Container Registry over the internal network)</li>
<li><a href="https://learn.microsoft.com/azure/azure-resource-manager/templates/deployment-script-template?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Deployment scripts</a> (these can be deleted afterwards, but they will run the scripts to build our container image, and placeholder agent within the confines of Bicep)*</li>
</ul>
<p>We will also need a <a href="https://learn.microsoft.com/azure/active-directory/managed-identities-azure-resources/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">User Assigned Managed Identity</a> for this article*(and the scope only being to the Resource Group)*I have a pre-created User Assigned Managed identity named:<em>usrmi</em>. This Managed identity has the following role assignments to the Resource Group to which the resources will be deployed.</p>




















<table><thead><tr><th><strong>Role</strong></th><th><strong>Assigned To</strong></th><th><strong>Notes</strong></th></tr></thead><tbody><tr><td>Contributor</td><td>usrmi</td><td>Contributor role on the container registry resource to push the container image and create the Container App Jobs and resources.</td></tr><tr><td>Key Vault Secrets User</td><td>usrmi</td><td>Secret Reader to access the Key Vault secrets.</td></tr></tbody></table>
<p>The cost of the overall solution &#x27;depends&#x27; on how active it is and how it is used.</p>
<ul>
<li>Resources such as <a href="https://azure.microsoft.com/pricing/details/container-apps/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Container Apps</a>, under Consumption, are pay-per-use and dependent on the number of requests and the length of those requests. The idea here is that they only cost something if in use.</li>
<li><a href="https://azure.microsoft.com/en-us/pricing/details/container-registry/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Container Registry</a> requires the Premium SKU for Private Endpoint support, but for demo environments, you could get away with a Basic.</li>
<li><a href="https://azure.microsoft.com/pricing/details/key-vault/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Key Vault</a> also depends on the number of transactions and functionality.</li>
</ul>
<p>It is recommended to do an estimate using the <a href="https://azure.microsoft.com/pricing/calculator/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Pricing Calculator</a> in your currency and region to work out the costs, but the true reflection will be once your Azure DevOps pipelines start consuming the infrastructure.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="let-us-get-building">Let us get building<a href="#let-us-get-building" class="hash-link" aria-label="Direct link to Let us get building" title="Direct link to Let us get building">​</a></h2>
<p>To deploy our environment:</p>
<p><img loading="lazy" alt="Container App Jobs - High-level architecture" src="/assets/images/privatecontainerappsjob_architecture-2be093d885ec027ba59730cb9c0940be.png" width="4000" height="2250" class="img_ev3q"></p>
<p>We will Azure Bicep, a User Managed Identity and Resource Group.</p>
<p>The <a href="https://learn.microsoft.com/azure/azure-resource-manager/bicep/overview?tabs=bicep&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Bicep</a> file I have written is scoped to a single Resource Group, but to do this in production and work with your existing resources, it may be better to move it to <a href="https://learn.microsoft.com/azure/azure-resource-manager/bicep/modules?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">modules</a>.</p>
<blockquote>
<p>All the code required to get this to work can be found in the following GitHub repository: <a href="https://github.com/lukemurraynz/containerapps-selfhosted-agent" target="_blank" rel="noopener noreferrer">lukemurraynz/containerapps-selfhosted-agent</a>, including the <a href="https://luke.geek.nz/azure/Getting-Started-with-GitHub-Codespaces/" target="_blank" rel="noopener noreferrer">GitHub Codespace</a>, configuration I am using to deploy.</p>
</blockquote>
<p>We will start with a Resource Group consisting of our Managed Identity.</p>
<p><img loading="lazy" alt="Azure Container Apps - Resource Group" src="/assets/images/AzureContainerApps_AzurePortal_ado-containerapp-rg-1934b5fbf126cb559156b84c4224fe49.png" width="1794" height="347" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="prepare---azure-devops-agent-pool">Prepare - Azure DevOps Agent Pool<a href="#prepare---azure-devops-agent-pool" class="hash-link" aria-label="Direct link to Prepare - Azure DevOps Agent Pool" title="Direct link to Prepare - Azure DevOps Agent Pool">​</a></h3>
<p>Before deploying anything into Azure, we must prepare our Azure DevOps environment.</p>
<ol>
<li>Login to your <strong><a href="https://aex.dev.azure.com/" target="_blank" rel="noopener noreferrer">Azure DevOps</a></strong> organisation</li>
<li>Click on <strong>Organization Settings</strong></li>
<li>Click on <strong>Agent Pools</strong></li>
<li>Click <strong>Add Pool</strong></li>
<li>Select <strong>Self-hosted</strong></li>
<li>Give the Agent pool a <strong>name</strong> <em>(ie containerapp-adoagent - we will need the name later in our Bicep code)</em></li>
<li>Enter a description and click <strong>Create</strong></li>
</ol>
<p><img loading="lazy" alt="Create Azure DevOps - Agent Pool" src="/assets/images/AzureDevOps_CreateAgentPool_CAPPS-4c24c77aced2d7f1024ebe41a9276e9a.gif" width="1893" height="952" class="img_ev3q"></p>
<p>Once the agent pool has been created, we need our token to allow the Agents to register to the Agent Pool we have just created.</p>
<p><em>This token is a secret and will be stored in an Azure Key Vault as part of our deployment, allowing the secret to be protected from unauthorised people and allowing you to regenerate the secret when required by updating the key vault secret without having to redeploy any of the infrastructure.</em></p>
<ol>
<li>Login to your <strong><a href="https://aex.dev.azure.com/" target="_blank" rel="noopener noreferrer">Azure DevOps</a></strong> organisation.</li>
<li>Click on the little User icon at the top right <em>(next to your initials)</em></li>
<li>Click on <strong>Personal Access Tokens</strong></li>
<li>Click <strong>+ New Token</strong></li>
<li>Type in a <strong>name</strong> <em>(ie JoinADOPool)</em></li>
<li>Specify a valid <strong>expiration date</strong> <em>(for our demo purposes, we will go with 30 days)</em>.</li>
<li>Click <strong>Show all scopes</strong></li>
<li>Find <strong>Agent Pools</strong></li>
<li>Click <strong>Read &amp; manage</strong></li>
<li>Click <strong>Create</strong></li>
<li>Copy the Token for later; if you lose this token before it can be uploaded to Key Vault, you will have to generate a new Token.</li>
</ol>
<p><img loading="lazy" alt="Create Azure DevOps - Agent Pool" src="/assets/images/AzureDevOps_CreatePATToken_CAPPS-f22f871f0c6d80f01dc0b94d8b139140.gif" width="1893" height="955" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="deploy---azure-container-apps-environment">Deploy - Azure Container Apps Environment<a href="#deploy---azure-container-apps-environment" class="hash-link" aria-label="Direct link to Deploy - Azure Container Apps Environment" title="Direct link to Deploy - Azure Container Apps Environment">​</a></h3>
<p>Now that we have our Azure DevOps Agent Pool and PAT token - it is time to deploy our Container Apps infrastructure.</p>
<blockquote>
<p>The <a href="https://learn.microsoft.com/azure/azure-resource-manager/templates/deployment-script-template?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">deployment scripts</a> used by this solution do not currently support Private Endpoints*(this is coming)*, so during the build process the Container Registry has Public endpoint enabled. This can be disabled after your initial build has been completed if required. If needed, you could add another deployment script to the Container Registry back to private at the end.
If this is the first time you have deployed Container Apps or Container Registry, you may need to register the <a href="https://learn.microsoft.com/azure/azure-resource-manager/management/resource-providers-and-types?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">providers</a>. This can be done with the following PowerShell commands, against your target subscription, else the deployment will fail:</p>
</blockquote>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Register-AzResourceProvider -ProviderNamespace Microsoft.ContainerRegistry</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Register-AzResourceProvider -ProviderNamespace Microsoft.KeyVault</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>To proceed, I will use my GitHub Codespace to deploy the Bicep; you could either run your own Codespace if you need it or fork the code <a href="https://github.com/lukemurraynz/containerapps-selfhosted-agent" target="_blank" rel="noopener noreferrer">lukemurraynz/containerapps-selfhosted</a> and run it locally or from the <a href="https://learn.microsoft.com/azure/cloud-shell/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure CloudShell</a>. The repository will have any updated code.</p>
<p>The Bicep code will be deployed as follows:</p>
<p>{% gist f2f2242ab8580a69db76f01b537d477c %}</p>
<p>We will need our Azure DevOps token created earlier, the name of the Agent Pool and the Azure DevOps URL.</p>
<p>We can adjust the parameters to suit our environment and deploy.</p>
<p><em>The token is classified as a secure value, so although it is visible in plain text here, it will not be parsed through in the deployment logs.</em></p>
<p>Verify that the Resource Group and the User-Assigned managed identity exist with appropriate permissions.</p>
<ol>
<li>Open the <strong>Codespace</strong></li>
<li>Navigate to the <strong>IaC</strong> folder and select main.bicep</li>
<li>Select the <strong><a href="https://luke.geek.nz/azure/Azure-Bicep-Deploy-Pane/" target="_blank" rel="noopener noreferrer">Deployment Pane</a></strong> <em>(top right)</em></li>
<li>Select your <strong>Scope</strong> - i.e. the Resource Group you will want to deploy to; you will need to log in with your Azure credentials</li>
<li><strong>Update the parameters</strong>, such as your ADO URL <em>(make sure it doesn&#x27;t include an end &#x27;/&#x27;)</em>, token and Agent Pool, and add the name of your user assigned managed identity.</li>
<li>Click <strong>Validate</strong> to validate that Bicep code syntax is correct, then click <strong>Deploy</strong></li>
</ol>
<p>The bicep code will now do the following:</p>
<ul>
<li>Create Azure Virtual Network</li>
<li>Create Azure Key Vault and private link to the virtual network</li>
<li>Create DNS zone for Key Vault</li>
<li>Create a Container Registry and a private link to the virtual network</li>
<li>Create DNS zone for container registry</li>
<li>Places the token into a Key Vault secret</li>
<li>Run a deployment script, which will build the Azure DevOps Agent Container image from the following docker file: <a href="https://github.com/lukemurraynz/containerapps-selfhosted-agent/blob/main/Dockerfile.azure-pipelines" target="_blank" rel="noopener noreferrer">containerapps-selfhosted-agent/Dockerfile.azure-pipelines</a></li>
<li>Create the Consumption Container Apps environment</li>
<li>Create a Log Analytics workspace and attach it to the Container Apps environment as a diagnostic setting</li>
<li>Run a deployment script that runs the acrbuild command to deploy the placeholder Azure DevOps agent</li>
<li>Creates the Azure Container Apps job, used for DevOps agents, with the azure-pipelines KEDA scaler configuration.</li>
</ul>
<p><img loading="lazy" alt="Create Azure DevOps - Agent Pool" src="/assets/images/Create_AzureContainerApps_BicepCodeSpace-2abaf725db173dc4dc34413afb85757a.gif" width="1887" height="941" class="img_ev3q"></p>
<p><em>In my testing, end-to-end deployment seemed to range between 12 to 15 minutes.</em></p>
<p>To validate it worked, you can go into the Azure DevOps and Agent Pools, and you should now have a placeholder agent. This agent needs to stay to keep the Agent pool active but can be toggled to Disabled.</p>
<p><img loading="lazy" alt="Create Azure DevOps - Agent Pool" src="/assets/images/AzureDevOps_ContainerApp_AgentPlaceholder-e8a02d5a0dcc505639450285c0d4dcea.png" width="1278" height="278" class="img_ev3q"></p>
<p>Once deployed, you can go into the Container Registry, Networking blade and change Public network access to Disabled. You can also delete the DeploymentScript resources, as these are no longer required.</p>
<p><img loading="lazy" alt="Public Access disabled - Container Registry" src="/assets/images/AzureContainerRegistry_PublicAccess_Disabled-fb55b477234d1fb7b96375227f025aaa.png" width="656" height="323" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="testing">Testing<a href="#testing" class="hash-link" aria-label="Direct link to Testing" title="Direct link to Testing">​</a></h2>
<p>To test that it is working - I have deployed a Virtual Machine into the sharedservices subnet with RDP open internally.</p>
<p>Let&#x27;s import a test Azure pipeline to test that the event scaling is working and that the Container App job can communicate with internal resources.</p>
<p>{% gist 128e5d6ace94909436f94535d612f955 %}</p>
<ol>
<li>Login to your <strong><a href="https://aex.dev.azure.com/" target="_blank" rel="noopener noreferrer">Azure DevOps</a></strong> organisation.</li>
<li>Navigate to a <strong>repository</strong> that you can test <em>(create one if it doesn&#x27;t exist and initialize it)</em>.</li>
<li>Create a new file called <strong>azure-pipelines.yml</strong>, and copy the pipeline into it.</li>
<li>Note: I am not talking from experience or anything, but make sure you <strong>update the RDP IP</strong> to make sure it&#x27;s a valid destination IP in the YML.</li>
<li>You can then navigate to <strong>Pipelines</strong></li>
<li><strong>Import Pipeline</strong></li>
<li><strong>Run</strong></li>
</ol>
<p><img loading="lazy" alt="Run Azure DevOps - Agent Pool" src="/assets/images/Run_AzureContainerApps_Agent-168b5b867933d31dd2f14e713357aa07.gif" width="1887" height="941" class="img_ev3q"></p>
<p>As the Container App agent runs, the Container App Job will execute (in some cases, multiple job instances will be spawned to fulfil your pipeline needs across multiple parallel jobs and tasks), and the resources get spawned in Azure.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="logging">Logging<a href="#logging" class="hash-link" aria-label="Direct link to Logging" title="Direct link to Logging">​</a></h2>
<p>The Container App Environment logs are stored in the Log Analytics workspace.</p>
<ol>
<li>Login to the <strong>Azure Portal</strong></li>
<li>Navigate to the <strong>Log Analytics workspace</strong> created <em>(i.e. law-jcdbxrheta7ug)</em></li>
<li>Navigate to <strong>Logs</strong></li>
<li>The default logs rules look for an incorrect table <em>(ContainerAppConsoleLogs_CL)</em>.</li>
<li>To retrieve the Logs, click on <strong>Category</strong> and uncollapse <strong>Azure Resources</strong></li>
</ol>
<p>Table names are called:</p>
<ul>
<li>ContainerAppSystemLogs</li>
<li>ContainerAppConsoleLogs</li>
</ul>
<p><img loading="lazy" alt="Run Azure DevOps - Agent Pool" src="/assets/images/Run_AzureContainerApps_LogAnalytics-7bc345cd7c1516ca4c84b452a83f7cfa.gif" width="1887" height="941" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="additional-reading">Additional Reading<a href="#additional-reading" class="hash-link" aria-label="Direct link to Additional Reading" title="Direct link to Additional Reading">​</a></h2>
<ul>
<li>A great tutorial exists to use Azure CLI to build the self-hosted Azure DevOps and GitHub Runners: <a href="https://learn.microsoft.com/azure/container-apps/tutorial-ci-cd-runners-jobs?tabs=bash&amp;pivots=container-apps-jobs-self-hosted-ci-cd-azure-pipelines&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Tutorial: Deploy self-hosted CI/CD runners and agents with Azure Container Apps jobs</a></li>
<li><a href="https://learn.microsoft.com/azure/container-apps/jobs?tabs=azure-cli&amp;WT.mc_id=AZ-MVP-5004796#event-driven-jobs" target="_blank" rel="noopener noreferrer">Jobs in Azure Container Apps</a></li>
<li><a href="https://keda.sh/" target="_blank" rel="noopener noreferrer">KEDA - Kubernetes Event-driven Autoscaling</a></li>
</ul></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/azure/">Azure</a></li></ul></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/azure/Empowering-Resilience-with-Azure-backup-services/"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Empowering Resilience with Azure backup services</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/azure/Azure-Bicep-Deployment-with-Deployment-Stacks/"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Azure Bicep Deployment with Deployment Stacks</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#let-us-get-building" class="table-of-contents__link toc-highlight">Let us get building</a><ul><li><a href="#prepare---azure-devops-agent-pool" class="table-of-contents__link toc-highlight">Prepare - Azure DevOps Agent Pool</a></li><li><a href="#deploy---azure-container-apps-environment" class="table-of-contents__link toc-highlight">Deploy - Azure Container Apps Environment</a></li></ul></li><li><a href="#testing" class="table-of-contents__link toc-highlight">Testing</a></li><li><a href="#logging" class="table-of-contents__link toc-highlight">Logging</a></li><li><a href="#additional-reading" class="table-of-contents__link toc-highlight">Additional Reading</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 luke.geek.nz. Powered by coffee, clouds and hamsters on wheels!</div></div></div></footer></div>
</body>
</html>