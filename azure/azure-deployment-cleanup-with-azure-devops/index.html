<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.1">
<title data-rh="true">Azure Deployment history cleanup with Azure DevOps | luke.geek.nz</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://luke.geek.nz/img/social-card.png"><meta data-rh="true" name="twitter:image" content="https://luke.geek.nz/img/social-card.png"><meta data-rh="true" property="og:url" content="https://luke.geek.nz/azure/azure-deployment-cleanup-with-azure-devops/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Azure Deployment history cleanup with Azure DevOps | luke.geek.nz"><meta data-rh="true" name="description" content="Microsoft Azure has a limit of 800 deployments per resource group. This means that a single resource group can only contain 800 historical deployments at most."><meta data-rh="true" property="og:description" content="Microsoft Azure has a limit of 800 deployments per resource group. This means that a single resource group can only contain 800 historical deployments at most."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2023-02-03T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://luke.geek.nz"><meta data-rh="true" property="article:tag" content="Azure"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://luke.geek.nz/azure/azure-deployment-cleanup-with-azure-devops/"><link data-rh="true" rel="alternate" href="https://luke.geek.nz/azure/azure-deployment-cleanup-with-azure-devops/" hreflang="en"><link data-rh="true" rel="alternate" href="https://luke.geek.nz/azure/azure-deployment-cleanup-with-azure-devops/" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://ZBH2T1WJQD-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="luke.geek.nz RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="luke.geek.nz Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="luke.geek.nz JSON Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0QDLBY7NNN"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-0QDLBY7NNN",{anonymize_ip:!0})</script><link rel="stylesheet" href="/assets/css/styles.94a74a36.css">
<script src="/assets/js/runtime~main.36ced030.js" defer="defer"></script>
<script src="/assets/js/main.a2a1c3cd.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"dark")}(),function(){try{const a=new URLSearchParams(window.location.search).entries();for(var[t,e]of a)if(t.startsWith("docusaurus-data-")){var n=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(n,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:#D3D3D3" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY">If you haven't already make sure you sign up for my Weekly Azure Newsletter, straight to your inbox! <a target="_blank" rel="noopener noreferrer" href="https://newsletter.azurefeeds.com/join">Subscribe now!</a></div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="luke.geek.nz" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.png" alt="luke.geek.nz" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">luke.geek.nz</b></a><a class="navbar__item navbar__link" href="/Tags/">Tags</a><a class="navbar__item navbar__link" href="/Archive/">Blog</a><a class="navbar__item navbar__link" href="/about/">About</a></div><div class="navbar__items navbar__items--right"><a href="https://www.youtube.com/channel/UCUG3TKDTAZz4UXshGrjBBoQ" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-icon" aria-label="YouTube">
              <svg width="24" height="24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path d="M23.498,6.186c-0.273-1.186-1.143-2.144-2.332-2.417C18.389,3.153,12,3.153,12,3.153s-6.389,0-9.166,0.616
                  c-1.19,0.273-2.06,1.23-2.332,2.417C0,8.07,0,12,0,12s0,3.93,0.502,5.814c0.272,1.187,1.142,2.062,2.332,2.335
                  C5.611,20.847,12,20.847,12,20.847s6.389,0,9.166-0.698c1.189-0.273,2.059-1.148,2.332-2.335C24,15.93,24,12,24,12
                  S24,8.07,23.498,6.186z M9.545,15.568V8.432l6.545,3.568L9.545,15.568z"/>
              </svg>
            </a><a href="https://aus.social/@lukemurray" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-icon" aria-label="Mastodon">
              <svg height="20" width="20" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" xml:space="preserve">
                <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                <g id="SVGRepo_iconCarrier">
                  <path d="M21.327 8.566c0-4.339-2.843-5.61-2.843-5.61-1.433-.658-3.894-.935-6.451-.956h-.063c-2.557.021-5.016.298-6.45.956 0 0-2.843 1.272-2.843 5.61 0 .993-.019 2.181.012 3.441.103 4.243.778 8.425 4.701 9.463 1.809.479 3.362.579 4.612.510 2.268-.126 3.541-.809 3.541-.809l-.075-1.646s-1.621.511-3.441.449c-1.804-.062-3.707-.194-3.999-2.409a4.523 4.523 0 0 1-.04-.621s1.77.433 4.014.536c1.372.063 2.658-.08 3.965-.236 2.506-.299 4.688-1.843 4.962-3.254.434-2.223.398-5.424.398-5.424zm-3.353 5.59h-2.081V9.057c0-1.075-.452-1.62-1.357-1.62-1 0-1.501.647-1.501 1.927v2.791h-2.069V9.364c0-1.28-.501-1.927-1.502-1.927-.905 0-1.357.546-1.357 1.62v5.099H6.026V8.903c0-1.074.273-1.927.823-2.558.566-.631 1.307-.955 2.228-.955 1.065 0 1.872.409 2.405 1.228l.518.869.519-.869c.533-.819 1.34-1.228 2.405-1.228.92 0 1.662.324 2.228.955.549.631.822 1.484.822 2.558v5.253z"></path>
                </g>
              </svg>
            </a><a href="https://bsky.app/profile/lukemurraynz.bsky.social" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-icon" aria-label="Bluesky">
              <svg class="octicon" xmlns="http://www.w3.org/2000/svg" role="img" viewBox="0 0 16 16" height="20" width="20" fill="currentColor">
                <title>Bluesky</title>
                <path d="M8 7.2c-.72-1.4-2.7-4.04-4.53-5.33C1.7.63 1.04.84.6 1.04.1 1.27 0 2.05 0 2.51c0 .46.25 3.77.42 4.32.54 1.82 2.47 2.45 4.25 2.25-2.6.38-4.92 1.33-1.88 4.71 3.33 3.46 4.57-.74 5.21-2.87.64 2.13 1.37 6.18 5.16 2.87 2.84-2.87.78-4.33-1.83-4.71 1.78.2 3.71-.43 4.25-2.25.17-.55.42-3.86.42-4.32 0-.46-.09-1.24-.6-1.47-.44-.2-1.11-.42-2.87.83A17.87 17.87 0 0 0 8 7.2Z"></path>
              </svg>
            </a><a href="https://twitter.com/lukemurraynz" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-icon" aria-label="X"><svg height="20" width="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 8.586l4.293-4.293a1 1 0 011.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 011.414-1.414L10 8.586z" clip-rule="evenodd"/>
          </svg></a><a href="https://www.linkedin.com/in/ljmurray/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-icon" aria-label="LinkedIn"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" height="20" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854V1.146zm4.943 12.248V6.169H2.542v7.225h2.401zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248-.822 0-1.359.54-1.359 1.248 0 .694.521 1.248 1.327 1.248h.016zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274 0-1.845.7-2.165 1.193v.025h-.016a5.54 5.54 0 0 1 .016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225h2.4z"></path></svg></a><a href="https://luke.geek.nz/rss" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-rss-link" aria-label="RSS"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure/book-review-cloud-solution-architects-career-master-plan/">Book Review Cloud Solution Architects Career Master Plan</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure/microsoft-azure-sandbox-design-considerations/">Microsoft Azure - Sandbox Design Considerations</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure/tag-azure-resources-owner-azure-automation-runbook/">Tag Azure Resources with Owner using Azure Automation</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure/enterprise-policy-code-azure-devops/">Enterprise Policy as Code with Azure DevOps</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure/accessing-keyvault-azure-devops/">Accessing KeyVault from Azure DevOps</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="https://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="Microsoft Azure has a limit of 800 deployments per resource group. This means that a single resource group can only contain 800 historical deployments at most."><header><h1 class="title_f1Hy" itemprop="headline">Azure Deployment history cleanup with Azure DevOps</h1><div class="container_mt6G margin-vert--md"><time datetime="2023-02-03T00:00:00.000Z" itemprop="datePublished">February 3, 2023</time> · <!-- -->7 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://luke.geek.nz/img/logo.png" alt="Luke Murray" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Luke Murray</span></a></div><small class="avatar__subtitle" itemprop="description">Author</small></div></div></div></div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><p>Microsoft Azure has a limit of <a href="https://learn.microsoft.com/azure/azure-resource-manager/management/azure-subscription-service-limits?WT.mc_id=AZ-MVP-5004796#resource-group-limits" target="_blank" rel="noopener noreferrer" title="Resource group limits">800 deployments per resource group</a>. This means that a single resource group can only contain 800 historical deployments at most.</p>
<blockquote>
<p>A deployment in Azure refers to the process of creating or updating resources in a resource group.</p>
</blockquote>
<p>When deploying resources in Azure, it is essential to keep track of the number of <a href="https://learn.microsoft.com/en-us/azure/azure-resource-manager/templates/deployment-history?tabs=azure-portal&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="View deployment history with Azure Resource Manager">historic deployments</a> in a resource group to ensure that the limit is not exceeded. This is because new deployments will fail if the limit is exceeded, and creating or updating resources in that resource group will not be possible.</p>
<p>If you have CI/CD <em>(Continuous Integration and Continuous Deployment)</em> set up to deploy or change your infrastructure or services with code, it can be easy to reach this limit. <a href="https://learn.microsoft.com/azure/azure-resource-manager/troubleshooting/deployment-quota-exceeded?tabs=azure-cli&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Resolve error when deployment count exceeds 800">Azure will attempt to do this automatically</a> when reaching your limit. Still, you may want to pre-empt any problems if you make many deployments and the system hasn&#x27;t had time to prune automatically, or this is <a href="https://learn.microsoft.com/en-us/azure/azure-resource-manager/templates/deployment-history-deletions?WT.mc_id=AZ-MVP-5004796&amp;tabs=azure-powershell" target="_blank" rel="noopener noreferrer">disabed</a>.</p>
<p>This came up in conversations on Microsoft Q&amp;A, so I thought I would dig into it and put together a possible option.</p>
<p>To avoid exceeding the deployment limit, it may be necessary to clean up old deployments.</p>
<p>This can be done by using a script to remove deployments that are no longer needed.</p>
<p>So let&#x27;s build an Azure DevOps pipeline that runs weekly to connect to our Microsoft Azure environment and clean up historical deployments.</p>
<p><img loading="lazy" alt="Microsoft Azure Deployment History Cleanup with Azure DevOps" src="/assets/images/azdeploycleanupazdevopsheader-a7837813d2c9d39f1e3b2642b6c8c8c0.png" title="Microsoft Azure Deployment History Cleanup with Azure DevOps" width="1080" height="1080" class="img_ev3q"></p>
<p>For this article, I will assume you have an Azure DevOps repository setup and the permissions <em>(Owner)</em> to make the necessary privileged actions to the Microsoft Azure environment to do the design.</p>
<blockquote>
<p>Note: Scripts and pipeline are &quot;<a href="https://github.com/lukemurraynz/AzDeploymeantCleanup" target="_blank" rel="noopener noreferrer" title="lukemurraynz / AzDeploymeantCleanup">here</a>&quot;.</p>
</blockquote>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="deploy-and-configure">Deploy and Configure<a href="#deploy-and-configure" class="hash-link" aria-label="Direct link to Deploy and Configure" title="Direct link to Deploy and Configure">​</a></h4>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="create-service-prinicipal">Create Service Prinicipal<a href="#create-service-prinicipal" class="hash-link" aria-label="Direct link to Create Service Prinicipal" title="Direct link to Create Service Prinicipal">​</a></h5>
<ol>
<li>Navigate to the <a href="https://portal.azure.com/#home" target="_blank" rel="noopener noreferrer" title="Microsoft Azure"><strong>Microsoft Azure Portal</strong></a></li>
<li>Click on <a href="https://portal.azure.com/#view/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/~/Overview" target="_blank" rel="noopener noreferrer" title="Microsoft Entra ID"><strong>Microsoft Entra ID</strong></a></li>
<li>Click on <a href="https://portal.azure.com/#view/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/~/RegisteredApps" target="_blank" rel="noopener noreferrer" title="Azure App Registrations"><strong>App Registrations</strong></a></li>
<li>Click on: <strong>+ New Registration</strong></li>
<li>Enter the following information:
<ul>
<li><strong>Name</strong> (i.e. SPN.AzDeploymentCleanup)</li>
</ul>
</li>
<li>Click <strong>Register</strong></li>
<li>Copy the following for later when we add the SPN to Azure DevOps.
<ul>
<li>Application (client) ID</li>
<li>Directory (tenant ID)</li>
</ul>
</li>
<li>Click on <strong>Certificates &amp; Secrets</strong></li>
<li>Press <strong>+ New Client Secret</strong></li>
<li>Enter a relevant description and expiry date and click Add</li>
<li><strong>Copy</strong> the <strong>value</strong> of the new secret (this is essentially your password), and you won&#x27;t be able to see the matter again.</li>
</ol>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="create-custom-role--assign-permissions">Create Custom Role &amp; Assign permissions<a href="#create-custom-role--assign-permissions" class="hash-link" aria-label="Direct link to Create Custom Role &amp; Assign permissions" title="Direct link to Create Custom Role &amp; Assign permissions">​</a></h5>
<p>Now that your service principal has been created, it is time to assign permissions because this script targets all subscriptions under a management group; we are going to set the permissions to that management group so that it flows to all subscriptions underneath it - and in the view of least privileged we will create a Custom Role to apply to our Service Principal.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="create-custom-role">Create Custom Role<a href="#create-custom-role" class="hash-link" aria-label="Direct link to Create Custom Role" title="Direct link to Create Custom Role">​</a></h5>
<p>For the deployment history to be completed, we will need the following permissions:</p>
<ul>
<li>Microsoft.Resources/deployments/delete</li>
<li>Microsoft.Resources/subscriptions/resourceGroups/read</li>
<li>Microsoft.Management/managementGroups/read</li>
<li>Microsoft.Resources/subscriptions/read</li>
<li>Microsoft.Management/managementGroups/descendants/read</li>
<li>Microsoft.Management/managementGroups/subscriptions/read</li>
<li>Microsoft.Resources/subscriptions/resourcegroups/deployments/operations/read</li>
<li>Microsoft.Resources/subscriptions/resourcegroups/deployments/read</li>
<li>Microsoft.Resources/subscriptions/resourcegroups/deployments/write</li>
<li>Microsoft.Resources/deployments/read</li>
</ul>
<ol>
<li>Navigate to the <a href="https://portal.azure.com/#home" target="_blank" rel="noopener noreferrer" title="Microsoft Azure"><strong>Microsoft Azure Portal</strong></a></li>
<li>In the search bar above, type in and navigate to <a href="https://portal.azure.com/#view/Microsoft_Azure_ManagementGroups/ManagementGroupBrowseBlade/~/MGBrowse_overview" target="_blank" rel="noopener noreferrer" title="Management Groups"><strong>Management Groups</strong></a></li>
<li>Click a management group, click on <strong>Access Control (IAM)</strong></li>
<li>Click <strong>+ Add</strong></li>
<li>Click <strong>Add Custom Role</strong></li>
<li>Type in a role name <em>(an example is: AzDeploymentHistoryCleanup)</em></li>
<li>Check Start from <strong>Scratch</strong> and next click</li>
<li>Click <strong>+ Add permissions</strong> and the permissions above <em>(you can search for them)</em>. Feel free to import the role from a JSON file &quot;<a href="https://github.com/lukemurraynz/AzDeploymeantCleanup" target="_blank" rel="noopener noreferrer" title="AzDeploymeantCleanup">here</a>&quot;.</li>
<li>Click <strong>Next</strong></li>
<li>Add <strong>Assignable Scopes</strong> <em>(this is the scope you can use to assign a role to - this won&#x27;t give it to the Service Principal; it will only open it up so we can post it)</em>. Make sure you set it at the management group level you are targetting.</li>
<li>Click <strong>Review + Create</strong></li>
<li>Click <strong>Create</strong></li>
</ol>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="assign-permissions">Assign Permissions<a href="#assign-permissions" class="hash-link" aria-label="Direct link to Assign Permissions" title="Direct link to Assign Permissions">​</a></h5>
<p>Now that the custom role has been created, it is time to assign it to the service principal we made earlier.</p>
<ol>
<li>Navigate to the <a href="https://portal.azure.com/#home" target="_blank" rel="noopener noreferrer" title="Microsoft Azure"><strong>Microsoft Azure Portal</strong></a></li>
<li>In the search bar above, type in and navigate to <a href="https://portal.azure.com/#view/Microsoft_Azure_ManagementGroups/ManagementGroupBrowseBlade/~/MGBrowse_overview" target="_blank" rel="noopener noreferrer" title="Management Groups"><strong>Management Groups</strong></a></li>
<li>Click on the management group you want to manage and click on <strong>Access Control (IAM)</strong></li>
<li>Click <strong>Add</strong></li>
<li>Click <strong>Add Role Assignment</strong></li>
<li>Select your custom role <em>(you can toggle the type column, so CustomRoles are first in the list)</em></li>
<li><img loading="lazy" alt="Microsoft Azure - add role assignments" src="/assets/images/microsoft-azure-add-roleassignments-44ba3750dba22a07e84fe886d31b0ed5.png" title="Microsoft Azure - add role assignments" width="1268" height="301" class="img_ev3q"></li>
<li>Click <strong>Members</strong></li>
<li>Make sure &#x27;<em>User, group or service principal</em>&#x27; is selected and click <strong>+ Select Members</strong></li>
<li><img loading="lazy" alt="Microsoft Azure - Add Roles" src="/assets/images/azdeploycleanupaddrolemembers-eefe616f23e9b8893322680e54162f08.png" title="Microsoft Azure - Add Roles" width="1460" height="363" class="img_ev3q">.</li>
<li>Select your Service Principal created earlier <em>(i.e. SPN.AzDeploymentCleanup)</em></li>
<li>Click <strong>Select</strong></li>
<li>Click <strong>Review + assign</strong> to assign the role.</li>
</ol>
<p>Note: Copy the Management Group ID and name, as we will need the information, along with the Service Principal and tenant IDs from earlier, in the next step of setting up Azure DevOps.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="configure-azure-devops-service-endpoint">Configure Azure DevOps Service Endpoint<a href="#configure-azure-devops-service-endpoint" class="hash-link" aria-label="Direct link to Configure Azure DevOps Service Endpoint" title="Direct link to Configure Azure DevOps Service Endpoint">​</a></h5>
<p>Now that the Service Principal and permissions have been assigned in Azure, it&#x27;s time to create the service connection endpoint that will allow Azure DevOps to connect to Azure.</p>
<ol>
<li>Navigate to your <a href="http://dev.azure.com/" target="_blank" rel="noopener noreferrer" title="Azure DevOps"><strong>Azure DevOps</strong></a> organisation.</li>
<li>Create a <strong>Project</strong>, if you haven&#x27;t already</li>
<li>Click on <strong>Project Settings</strong></li>
<li>Navigate to <strong>Service Connection</strong></li>
<li>Click on <strong>New service connection</strong></li>
<li>Select <strong>Azure Resource Manager</strong></li>
<li>Click <strong>Next</strong></li>
<li>Select <strong>Service principal (manual)</strong></li>
<li>Click <strong>Next</strong></li>
<li>For the scope, choose Group Management</li>
<li>Enter the <strong>Management Group ID</strong>, the <strong>Management Group Name</strong></li>
<li>Time to enter in the Service Principal details copied earlier, for the Service Principal Id paste in the Application ID.</li>
<li>The Service Principal key, enter the secret client value and select the Tenant ID</li>
<li>Click <strong>Verify</strong> - to verify the connectivity to the azure platform from Azure DevOps</li>
<li>Select <strong>Grant access permission to all pipelines</strong> and click <strong>Verify and save</strong></li>
</ol>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="configure-script-and-pipeline">Configure script and pipeline<a href="#configure-script-and-pipeline" class="hash-link" aria-label="Direct link to Configure script and pipeline" title="Direct link to Configure script and pipeline">​</a></h5>
<p>Now that we have our:</p>
<ul>
<li>Azure Service Principal</li>
<li>Custom role and assignment</li>
<li>Service connection</li>
</ul>
<p>We now need to import the script and pipeline.</p>
<p>If you haven&#x27;t already done - <a href="https://learn.microsoft.com/azure/devops/repos/git/create-new-repo?view=azure-devops&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Create a new Git repo in your project">create a Repo</a> for the AzHistoryCleanup writing.</p>
<p>You can clone <em>(or copy)</em> the files in the <a href="https://github.com/lukemurraynz/AzDeploymeantCleanup" target="_blank" rel="noopener noreferrer" title="AzDeploymeantCleanup"><strong>AzDeploymentCleanup</strong></a> Repo to your own.</p>
<p>First, we need to copy the name of the Service Principal.</p>
<ol>
<li>Click <strong>Project settings</strong></li>
<li>Click <strong>Service Connections</strong></li>
<li>Click on your <strong>Service Connection</strong> and copy the <strong>name</strong> <em>(i.e. SC.AzDeploymentCleanup)</em></li>
<li><img loading="lazy" alt="Azure DevOps Service Principal" src="/assets/images/azuredevops_spn-03e00cb34617a4158450359ebc328f09.png" title="Azure DevOps Service Principal" width="531" height="316" class="img_ev3q"></li>
<li>Navigate back to your Repo, and click on <strong>AzDeploymentCleanup.yml</strong> (this will become your pipeline)</li>
<li>Click <strong>Edit</strong></li>
<li><img loading="lazy" alt="Edit AzDeploymentCleanup YML" src="/assets/images/select-azure-devops-edityaml-babd1138d1d5b1045dabc98350278290.png" title="Edit AzDeploymentCleanup YML" width="735" height="491" class="img_ev3q"></li>
<li>Update the variable for <strong>ConnectedServiceNameARM</strong> to the name of your service connection</li>
<li>Here you can also edit the <strong>Script Arguments</strong> - for example, in my demo, I am targeting the <strong>ManagementGroup</strong> named: mg-landing zones and keeping the latest five <strong>deployments</strong>.</li>
<li>By default, I also have a <a href="https://learn.microsoft.com/azure/devops/pipelines/process/scheduled-triggers?view=azure-devops&amp;tabs=yaml&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Configure schedules for pipelines">cron job</a> to schedule this pipeline at 6 AM UTC every Sunday, and you can remove or edit this.</li>
<li>Once your changes are made, click <strong>Commit.</strong></li>
<li>Now that your pipeline has been updated, its time to create it - click on <strong>Pipelines.</strong></li>
<li>Click <strong>New Pipeline</strong></li>
<li>Select <strong>Azure Repos Git (YAML)</strong></li>
<li>Select your <strong>Repo</strong></li>
<li><img loading="lazy" alt="Select Azure DevOps repo" src="data:image/png;base64,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" title="Select Azure DevOps repo" width="433" height="148" class="img_ev3q"></li>
<li>Select <strong>Existing Azure Pipelines YAML file</strong></li>
<li><img loading="lazy" alt="Select YAML" src="/assets/images/azdeploycleanupazdevopsselectyaml-b81c2ec52cb0c709c4b5163611d359d7.png" title="Select YAML" width="467" height="277" class="img_ev3q"></li>
<li>Select your Pipeline YAML file and click <strong>Continue</strong></li>
<li>Click <strong>Save</strong> to create the pipeline</li>
<li>Now it&#x27;s time to run the pipeline! Click <strong>Run pipeline</strong></li>
<li><img loading="lazy" alt="Azure DevOps - Pipeline run" src="/assets/images/azdeploycleanupazdevopsscriptrun-83226c31820ad48c32426c9b7155444d.png" title="Azure DevOps - Pipeline run" width="1316" height="889" class="img_ev3q"></li>
<li>If successful, <strong>your script will trigger and clean up the oldest deployment history</strong>! This can take several minutes to run if you have a lot of deployments.</li>
</ol>
<p><img loading="lazy" alt="Azure Deployments - Cleanup - Comparison 1" src="/assets/images/azdeploycleanupazdevopsheader_compare1-e2fc4f6edd527019091df53bb0878edd.png" title="Azure Deployments - Cleanup - Comparison 1" width="1080" height="1080" class="img_ev3q"></p>
<p><img loading="lazy" alt="Azure Deployments - Cleanup - Comparison 2" src="/assets/images/azdeploycleanupazdevopsheader_compare2-c920b63e53f72ef81341ff1785d0d56f.png" title="Azure Deployments - Cleanup - Comparison 2" width="1080" height="1080" class="img_ev3q"></p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/azure/">Azure</a></li></ul></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/azure/azure-architecture-solution-requirement-consideration-checklist/"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Azure Architecture - Solution Requirement Consideration Checklist</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/2023/01/18/you-can-t-touch-this-how-to-make-your-azure-backup-immutable-and-secure/"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">You Can&#x27;t Touch This: How to Make Your Azure Backup Immutable and Secure</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#deploy-and-configure" class="table-of-contents__link toc-highlight">Deploy and Configure</a><ul><li><a href="#create-service-prinicipal" class="table-of-contents__link toc-highlight">Create Service Prinicipal</a></li><li><a href="#create-custom-role--assign-permissions" class="table-of-contents__link toc-highlight">Create Custom Role &amp; Assign permissions</a></li><li><a href="#create-custom-role" class="table-of-contents__link toc-highlight">Create Custom Role</a></li><li><a href="#assign-permissions" class="table-of-contents__link toc-highlight">Assign Permissions</a></li><li><a href="#configure-azure-devops-service-endpoint" class="table-of-contents__link toc-highlight">Configure Azure DevOps Service Endpoint</a></li><li><a href="#configure-script-and-pipeline" class="table-of-contents__link toc-highlight">Configure script and pipeline</a></li></ul></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 luke.geek.nz. Powered by coffee, clouds and hamsters on wheels!</div></div></div></footer></div>
</body>
</html>