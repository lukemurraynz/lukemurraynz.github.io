<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.1">
<title data-rh="true">Create Azure Bastion with Shareable Link support with PowerShell | luke.geek.nz</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://luke.geek.nz/img/social-card.png"><meta data-rh="true" name="twitter:image" content="https://luke.geek.nz/img/social-card.png"><meta data-rh="true" property="og:url" content="https://luke.geek.nz/azure/create-azure-bastion-with-shareable-link-support-with-powershell/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Create Azure Bastion with Shareable Link support with PowerShell | luke.geek.nz"><meta data-rh="true" name="description" content="Azure Bastion is a service you deploy that lets you connect to a virtual machine using your browser and the Azure portal or via the native SSH or RDP client installed on your local computer."><meta data-rh="true" property="og:description" content="Azure Bastion is a service you deploy that lets you connect to a virtual machine using your browser and the Azure portal or via the native SSH or RDP client installed on your local computer."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2023-03-16T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://luke.geek.nz"><meta data-rh="true" property="article:tag" content="Azure"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://luke.geek.nz/azure/create-azure-bastion-with-shareable-link-support-with-powershell/"><link data-rh="true" rel="alternate" href="https://luke.geek.nz/azure/create-azure-bastion-with-shareable-link-support-with-powershell/" hreflang="en"><link data-rh="true" rel="alternate" href="https://luke.geek.nz/azure/create-azure-bastion-with-shareable-link-support-with-powershell/" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="luke.geek.nz RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="luke.geek.nz Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="luke.geek.nz JSON Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0QDLBY7NNN"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-0QDLBY7NNN",{anonymize_ip:!0})</script><link rel="stylesheet" href="/assets/css/styles.4a383e58.css">
<script src="/assets/js/runtime~main.c45408b7.js" defer="defer"></script>
<script src="/assets/js/main.a6f7ae69.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"dark")}(),function(){try{const a=new URLSearchParams(window.location.search).entries();for(var[t,e]of a)if(t.startsWith("docusaurus-data-")){var n=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(n,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:#D3D3D3" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY">Happy New Year! This is a redesign of my website, hopefully you like it!</div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="luke.geek.nz" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.png" alt="luke.geek.nz" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">luke.geek.nz</b></a><a class="navbar__item navbar__link" href="/Tags/">Tags</a><a class="navbar__item navbar__link" href="/Archive/">Blog Archive</a></div><div class="navbar__items navbar__items--right"><a href="https://twitter.com/lukemurraynz" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-icon" aria-label="X"><svg height="20" width="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 8.586l4.293-4.293a1 1 0 011.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 011.414-1.414L10 8.586z" clip-rule="evenodd"/>
          </svg></a><a href="https://www.linkedin.com/in/ljmurray/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-icon" aria-label="LinkedIn"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" height="20" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854V1.146zm4.943 12.248V6.169H2.542v7.225h2.401zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248-.822 0-1.359.54-1.359 1.248 0 .694.521 1.248 1.327 1.248h.016zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274 0-1.845.7-2.165 1.193v.025h-.016a5.54 5.54 0 0 1 .016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225h2.4z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure/azure-email-communication-services/">Deploying and Testing Azure Email Communication Services</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure/microsoft-copilot-azure-preview/">Microsoft Copilot for Azure - Preview</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure/Azure-DevTest-Subscription-Considerations/">Azure Dev/Test Subscription considerations</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure/Azure-Image-Builder-Build-Pipeline-with-Azure-DevOps/">Azure Image Builder Image Build with Bicep and Azure DevOps</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure/misc/Book-Review-Azure-architecture-explained/">Book Review Azure Architecture Explained</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="https://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="Azure Bastion is a service you deploy that lets you connect to a virtual machine using your browser and the Azure portal or via the native SSH or RDP client installed on your local computer."><header><h1 class="title_f1Hy" itemprop="headline">Create Azure Bastion with Shareable Link support with PowerShell</h1><div class="container_mt6G margin-vert--md"><time datetime="2023-03-16T00:00:00.000Z" itemprop="datePublished">March 16, 2023</time> · <!-- -->9 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://luke.geek.nz/img/logo.png" alt="Luke Murray" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Luke Murray</span></a></div><small class="avatar__subtitle" itemprop="description">Author</small></div></div></div></div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><p><a href="https://learn.microsoft.com/en-us/azure/bastion/bastion-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="What is Azure Bastion?">Azure Bastion</a> is a service you deploy that lets you connect to a virtual machine using your browser and the Azure portal or via the native SSH or RDP client installed on your local computer.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">​</a></h4>
<blockquote>
<p>The Azure Bastion service is a fully platform-managed PaaS service you provision inside your virtual network. It provides secure and seamless RDP/SSH connectivity to your virtual machines directly from the Azure portal over TLS.</p>
</blockquote>
<p>Because of this, if you don&#x27;t have line-of-sight access to your Virtual Machines (<em>via express route, Site-to-Site VPN etc.)</em>, Bastion becomes your jump box, allowing secure access to your virtual machines without needing a public IP.</p>
<p>There is a downside, though. To connect to a Virtual Machine secured by Bastion, you need access to the Azure Portal, or command line connectivity to Azure, to create the tunnel; this means that you may need to grant people elevated rights and access they may not need to connect.</p>
<p>As of November 2022, Microsoft introduced shareable links into public preview, solving two key pain points:</p>
<ul>
<li>Administrators will no longer have to provide full access to their Azure accounts to one-time VM users—helping to maintain their privacy and security.</li>
<li>Users without Azure subscriptions can seamlessly connect to VMs without exposing RDP/SSH ports to the public internet.</li>
</ul>
<blockquote>
<p>The Bastion <strong>Shareable Link</strong> feature lets users connect to a target resource (virtual machine or virtual machine scale set) using Azure Bastion without accessing the Azure portal.</p>
</blockquote>
<p>At the time of this writing, there are some <a href="https://learn.microsoft.com/en-us/azure/bastion/shareable-link?WT.mc_id=AZ-MVP-5004796#considerations" target="_blank" rel="noopener noreferrer" title="Create a shareable link for Bastion">scenarios</a> where shareable links won&#x27;t work - particularly across Network peering across subscriptions and regions.</p>
<p>Because the service is in Public Preview - native PowerShell cmdlet support, enabling and configuring this feature isn&#x27;t available - but you can easily allow it via the <a href="https://learn.microsoft.com/en-us/azure/bastion/shareable-link?WT.mc_id=AZ-MVP-5004796#enable-shareable-link-feature" target="_blank" rel="noopener noreferrer" title="Enable Shareable Link feature">Azure Portal</a>.</p>
<p><img loading="lazy" alt="Create Azure Bastion with Shareable Link Support" src="/assets/images/azurebastion_shareablelinkheader-04f37669be8563ef51a6f9d7b1836a05.png" title="Create Azure Bastion with Shareable Link Support" width="1080" height="1080" class="img_ev3q"></p>
<p>To get around that, we will leverage the <a href="https://learn.microsoft.com/rest/api/azure/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Azure REST API reference">Azure Rest API</a> directly, using PowerShell to enable the Shareable Link feature and create and obtain a shareable link for a Virtual Machine.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-azure-bastion">Create Azure Bastion<a href="#create-azure-bastion" class="hash-link" aria-label="Direct link to Create Azure Bastion" title="Direct link to Create Azure Bastion">​</a></h4>
<p>I will assume there is already an Azure Virtual Network created; if not, you can follow the <a href="https://learn.microsoft.com/azure/virtual-network/quick-create-portal?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Quickstart: Create a virtual network using the Azure portal">Microsoft documentation</a> to get it up and running!</p>
<p>Also, make sure you have the <a href="https://learn.microsoft.com/powershell/azure/new-azureps-module-az?view=azps-9.5.0&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Introducing the Azure Az PowerShell module">Az Module</a> installed.</p>
<p>The PowerShell function we will run will require a few parameters to create the Azure Bastion resource and enable Shared Link functionality; these parameters are:</p>





































<table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Parameters</td><td>Note</td></tr><tr><td>RGName</td><td>The Resource Group of your Virtual Network</td></tr><tr><td>VNetName</td><td>The Virtual Network name</td></tr><tr><td>addressPrefix</td><td>The address prefix for your new Bastion subnet. For Azure Bastion resources deployed on or after November 2, 2021, the minimum AzureBastionSubnet size is /26 or larger (/25, /24, etc.).</td></tr><tr><td>region</td><td>The region, that Azure Bastion is deployed into (this needs to match your Virtual Network)</td></tr><tr><td>BastionPubIPName</td><td>The name of the Public IP, used by the Azure Bastion resource (this is the Azure resource name, it doesn&#x27;t have an external DNS alias, so doesn&#x27;t need to be globally unique)</td></tr><tr><td>BastionResourceName</td><td>The name of your Azure Bastion resource</td></tr></tbody></table>
<ol>
<li>
<p>Copy the script below into a file named: New-AzBastionSharedLinkEnabled.ps1</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">function New-AzBastionSharedLinkEnabled {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &lt;#</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      .SYNOPSIS</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      Creates an Azure Bastion resource with shared link enabled, on an already existing Azure Virtual Network.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    #&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    [CmdletBinding()]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    param</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    (</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      [Parameter(Mandatory = $false, Position = 0)]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      [System.String]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      $RGName = &quot;BastionTest&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      [Parameter(Mandatory = $false, Position = 1)]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      [System.String]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      $VNetName = &#x27;vnet-aue-dev&#x27;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      [Parameter(Mandatory = $false, Position = 2)]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      [System.String]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      $addressPrefix = &#x27;10.2.1.0/26&#x27;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      [Parameter(Mandatory = $false, Position = 3)]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      [System.String]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      $region = &#x27;AustraliaEast&#x27;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      [Parameter(Mandatory = $false, Position = 4)]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      [System.String]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      $BastionPubIPName = &#x27;VNet1-ip&#x27;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      [Parameter(Mandatory = $false, Position = 5)]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      [Object]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      $BastionResourceName = &quot;$VNetName-bastion&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # Set variable values for Resource Group name, Virtual Network name, address prefix, region, and bastion-related resources.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # Connect to Azure using Get-AzAccount cmdlet.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Connect-AzAccount</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # Use Get-AzSubscription cmdlet to get all the subscriptions that the account has access to and allow the user to choose one using Out-GridView.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Get-AzSubscription | Out-GridView -PassThru | Select-AzSubscription</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    $token = (Get-AzAccessToken).Token</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    $subscription = Get-AzContext | Select-Object Subscription</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # Use Get-AzVirtualNetwork cmdlet to get the virtual network object and then use Add-AzVirtualNetworkSubnetConfig cmdlet to create a new subnet for Azure Bastion service. Finally, use Set-AzVirtualNetwork cmdlet to update the virtual network configuration.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    $VNET = Get-AzVirtualNetwork -ResourceGroupName $RGName -Name $VNetName </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Add-AzVirtualNetworkSubnetConfig -VirtualNetwork $VNET -Name &quot;AzureBastionSubnet&quot; -AddressPrefix $addressPrefix | Set-AzVirtualNetwork</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    $VNET = Get-AzVirtualNetwork -ResourceGroupName $RGName -Name $VNetName </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # Note: If there is an error message, it could indicate that the address prefix for the new subnet overlaps with existing address ranges or is too small.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # Use New-AzPublicIpAddress cmdlet to create a new public IP address resource for the Bastion service.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    $publicip = New-AzPublicIpAddress -ResourceGroupName $RGName -name $BastionPubIPName -location $region -AllocationMethod Static -Sku Standard</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    $publicip = Get-AzPublicIpAddress -ResourceGroupName $RGName -Name $BastionPubIPName</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # Use New-AzBastion cmdlet to create a new Azure Bastion resource with the specified configuration, including the virtual network and public IP address resources created earlier.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    New-AzBastion -ResourceGroupName $RGName -Name $BastionResourceName -PublicIpAddressRgName $publicip.ResourceGroupName -PublicIpAddressName $publicip.Name  -VirtualNetwork $VNET -Sku &#x27;Standard&#x27; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    #Enable Shareable links for VMs in Azure Bastion.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    $BastionSubnet = Get-AzVirtualNetworkSubnetConfig -Name &#x27;AzureBastionSubnet&#x27; -VirtualNetwork $VNET</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    $Body = [PSCustomObject]@{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      location   = $region</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      properties = @{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        enableShareableLink = &quot;true&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ipConfigurations    = @(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          @{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            name       = &quot;bastionHostIpConfiguration&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            properties = @{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              subnet          = @{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                id = $BastionSubnet.id</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              publicIPAddress = @{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                id = $publicip.Id</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }  | ConvertTo-Json -Depth 6</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    $params = @{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      Uri         = &quot;https://management.azure.com/subscriptions/&quot; + $subscription.Subscription.Id + </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      &quot;/resourceGroups/$($RGName)/providers/Microsoft.Network/bastionHosts/$($BastionResourceName)?api-version=2022-07-01&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      Headers     = @{ &#x27;Authorization&#x27; = &quot;Bearer $token&quot; }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      Method      = &#x27;Put&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      Body        = $body</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      ContentType = &#x27;application/json&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # Invoke the REST API and store the response</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Invoke-RestMethod @Params</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>Open a Terminal or PowerShell prompt, and navigate to the folder containing the script.</p>
</li>
<li>
<p>Dot source the script so that you can run it from the session: <strong>. .\New-AzBastionSharedLinkEnabled.ps1</strong></p>
</li>
<li>
<p><img loading="lazy" alt=". .\New-AzBastionSharedLinkEnabled.ps1" src="data:image/png;base64,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" title=". .\New-AzBastionSharedLinkEnabled.ps1" width="612" height="42" class="img_ev3q"></p>
</li>
<li>
<p>Once it&#x27;s imported - we can now run it; make sure you replace your parameters that match your environment:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">New-AzBastionSharedLinkEnabled -RGName BastionTest -VNetName vnet-aue-dev -addressPrefix 10.2.1.0/26 -region AustraliaEast -BastionPubIPName VNet1-ip -BastionResourceName net-aue-dev-bastion</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>The script will then prompt for your credentials to authenticate</p>
</li>
<li>
<p>You will then need to select the Azure subscription containing your Azure Virtual Network, then select Ok</p>
</li>
<li>
<p><img loading="lazy" alt="Select Azure subscription" src="/assets/images/select-azsubscription_outgridview-339836f2117a2caac80d58fb2469abc5.png" title="Select Azure subscription" width="572" height="214" class="img_ev3q"></p>
</li>
<li>
<p>The script will then go and provision Azure Bastion and enable Shared Links. It will take a few minutes to run while it provisions Bastion. Then you will get JSON output, indicating it has been completed.</p>
</li>
<li>
<p><img loading="lazy" alt="Windows PowerShell - New Azure Bastion" src="/assets/images/windowsterminal_new-azbastionsharedlinkenabledrun-c3f0ed7ce23909b43bf7d6bc3899b026.png" title="Windows PowerShell - New Azure Bastion" width="1373" height="626" class="img_ev3q"></p>
</li>
<li>
<p><img loading="lazy" alt="Azure Bastion - Shareable Link" src="/assets/images/azureportal_azurebastion_shareablelinkconfig-522a6e1dc1a539ac4e8b9ef609a6f6ca.png" title="Azure Bastion - Shareable Link" width="973" height="520" class="img_ev3q"></p>
</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-shareable-link">Create Shareable Link<a href="#create-shareable-link" class="hash-link" aria-label="Direct link to Create Shareable Link" title="Direct link to Create Shareable Link">​</a></h4>
<p>Now that we have an Azure Bastion instance and have Shareable Links enabled - it&#x27;s time to create a Shareable Link for a Virtual Machine; this triggers 2 API endpoints - creating the shareable link and then retrieving the shareable link.</p>
<p>The same assumptions are made, so make sure you have the <a href="https://learn.microsoft.com/powershell/azure/new-azureps-module-az?view=azps-9.5.0&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Introducing the Azure Az PowerShell module">Az Module</a> installed.</p>
<p>The script relies on the following parameters:</p>

























<table><thead><tr><th>Parameters</th><th>Note</th></tr></thead><tbody><tr><td>BastionResourceName</td><td>The name of your Azure Bastion resource</td></tr><tr><td>RGName</td><td>The Resource Group of your Bastion resource</td></tr><tr><td>VMRGName</td><td>The Resource Group of your Virtual Machine, you want a Shareable Link for</td></tr><tr><td>Vmname</td><td>The name of the Virtual Machine you want a shareable link for</td></tr></tbody></table>
<ol>
<li>
<p>Copy the script below into a file named: New-AzBastionShareableLink.ps1</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">function New-AzBastionShareableLink {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  &lt;#</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    .SYNOPSIS</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      Creates an Azure Bastion shareable link.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  #&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  [CmdletBinding()]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  param</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  (</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    [Parameter(Mandatory = $false, Position = 0)]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    [System.String]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    $BastionResourceName = &#x27;vnet-aue-dev-bastion&#x27;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    [Parameter(Mandatory = $false, Position = 1)]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    [System.String]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    $RGName = &quot;BastionTest&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    [Parameter(Mandatory = $false, Position = 1)]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    [System.String]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    $VMRGName = &quot;BastionTest&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    [Parameter(Mandatory = $false, Position = 2)]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    [System.String]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    $VMname = &quot;2022ServerVM-2&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  # Connect to Azure using Get-AzAccount</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  Connect-AzAccount</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  # Get all subscriptions that the account has access to</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  Get-AzSubscription | Out-GridView -PassThru | Select-AzSubscription</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  $subscription = Get-AzContext | Select-Object Subscription</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  # Get the access token for the authenticated user</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  $token = (Get-AzAccessToken).Token</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  $ID = Get-AzVM -ResourceGroupName $VMRGName -Name $VMName | Select-Object Id -ExpandProperty id</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  $body = @{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    vms = @(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      @{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        vm = @{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          id = $ID.Id</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }  | ConvertTo-Json -Depth 3</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    #creates the shareable link for the VM</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  $params = @{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Uri         = &quot;https://management.azure.com/subscriptions/&quot; + $subscription.Subscription.Id + </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;/resourceGroups/$RGName/providers/Microsoft.Network/bastionHosts/$BastionResourceName/createShareableLinks?api-version=2022-07-01&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Headers     = @{ &#x27;Authorization&#x27; = &quot;Bearer $token&quot; }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Method      = &#x27;POST&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Body        = $body</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ContentType = &#x27;application/json&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  # Invoke the REST API and store the response</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  Invoke-RestMethod @Params</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  #Gets the shareable link for the VM</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> $params = @{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Uri         = &quot;https://management.azure.com/subscriptions/&quot; + $subscription.Subscription.Id + </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;/resourceGroups/$($RGName)/providers/Microsoft.Network/bastionHosts/$BastionResourceName/getShareableLinks?api-version=2022-09-01&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Headers     = @{ &#x27;Authorization&#x27; = &quot;Bearer $token&quot; }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Method      = &#x27;POST&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # Body        = $body</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ContentType = &#x27;application/json&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  # Invoke the REST API and store the response</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  $ShareableLink = Invoke-RestMethod @Params</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  Write-Output $ShareableLink.value.bsl </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>Open a Terminal or PowerShell prompt, and navigate to the folder containing the script.</p>
</li>
<li>
<p>Dot source the script so that you can run it from the session: <strong>. .\New-AzBastionShareableLink.ps1</strong></p>
</li>
<li>
<p>s</p>
</li>
<li>
<p>Once it&#x27;s imported - we can now run it; make sure you replace your parameters that match your environment:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">New-AzBastionShareableLink -BastionResourceName net-aue-dev-bastion -RGName BastionTest -VMRGName BastionTest -VMname 2022ServerVM-2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p><img loading="lazy" alt="Azure Bastion - Create Shared Link" src="/assets/images/windowsterminal_new-azbastionsharedlink-5b507179b1017dee08d5e1b93a2e064b.png" title="Azure Bastion - Create Shared Link" width="1531" height="85" class="img_ev3q"></p>
</li>
<li>
<p>The script will then prompt for your credentials to authenticate</p>
</li>
<li>
<p>You will then need to select the Azure subscription containing your Azure Virtual Network, then select Ok</p>
</li>
<li>
<p><img loading="lazy" alt="Select Azure subscription" src="/assets/images/select-azsubscription_outgridview-339836f2117a2caac80d58fb2469abc5.png" title="Select Azure subscription" width="572" height="214" class="img_ev3q"></p>
</li>
<li>
<p>The script will then go and collect the ID of the Virtual Machine, pass that through to the Create a Shareable Link, then wait 10 seconds for the Bastion Resource to update properly, then collect the Shareable Link and output it to the terminal.</p>
</li>
<li>
<p><img loading="lazy" alt="Azure Bastion - Shared Link" src="/assets/images/windowsterminal_azurebastionsharedlink-fbe50dcc675e5bfbbc4bda824bce75d7.png" title="Azure Bastion - Shared Link" width="1607" height="265" class="img_ev3q"></p>
</li>
<li>
<p>You can also see the link created in the Azure Portal</p>
</li>
<li>
<p><img loading="lazy" alt="Microsoft Azure Portal - Shareable Link" src="/assets/images/azureportal_azurebastion_shareablelinks-b2ad8a231445af2f063b421666d87e51.png" title="Microsoft Azure Portal - Shareable Link" width="1417" height="364" class="img_ev3q"></p>
</li>
<li>
<p>I can then copy the URL into my favourite browser and connect to your Virtual Machine securely!</p>
</li>
<li>
<p><img loading="lazy" alt="Microsoft Azure Bastion - Connect" src="/assets/images/azurebastionshareablelink_vmconnect-16d5725cd9d358a53d93b41f134ffc85.gif" title="Microsoft Azure Bastion - Connect" width="1624" height="1078" class="img_ev3q"></p>
</li>
</ol>
<p>The scripts can also be found directly on GitHub here: <a href="https://github.com/lukemurraynz/Azure" target="_blank" rel="noopener noreferrer" title="https://github.com/lukemurraynz/Azure">https://github.com/lukemurraynz/Azure</a></p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/azure/">Azure</a></li></ul></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/azure/azure-quick-review/"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Azure Quick Review</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/azure/azure-budget-filters-a-key-tool-for-effective-cloud-cost-management/"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Azure Budget Filters: A Key Tool for Effective Cloud Cost Management</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#create-azure-bastion" class="table-of-contents__link toc-highlight">Create Azure Bastion</a></li><li><a href="#create-shareable-link" class="table-of-contents__link toc-highlight">Create Shareable Link</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 luke.geek.nz. Powered by coffee, clouds and hamsters on wheels!</div></div></div></footer></div>
</body>
</html>