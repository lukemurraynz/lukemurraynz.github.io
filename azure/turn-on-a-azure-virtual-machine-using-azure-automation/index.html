<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Turn on a Azure Virtual Machine using Azure Automation | luke.geek.nz</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://luke.geek.nz/img/social-card.png"><meta data-rh="true" name="twitter:image" content="https://luke.geek.nz/img/social-card.png"><meta data-rh="true" property="og:url" content="https://luke.geek.nz/azure/turn-on-a-azure-virtual-machine-using-azure-automation/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Turn on a Azure Virtual Machine using Azure Automation | luke.geek.nz"><meta data-rh="true" name="description" content="Turning off a Virtual Machine in Microsoft Azure on a schedule can quickly be done using the built-in Shutdown controls in the Virtual Machine blade (part of Azure Lab Services, but not a requirement)_, but what about starting it?"><meta data-rh="true" property="og:description" content="Turning off a Virtual Machine in Microsoft Azure on a schedule can quickly be done using the built-in Shutdown controls in the Virtual Machine blade (part of Azure Lab Services, but not a requirement)_, but what about starting it?"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2022-06-05T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://luke.geek.nz"><meta data-rh="true" property="article:tag" content="Azure"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://luke.geek.nz/azure/turn-on-a-azure-virtual-machine-using-azure-automation/"><link data-rh="true" rel="alternate" href="https://luke.geek.nz/azure/turn-on-a-azure-virtual-machine-using-azure-automation/" hreflang="en"><link data-rh="true" rel="alternate" href="https://luke.geek.nz/azure/turn-on-a-azure-virtual-machine-using-azure-automation/" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://ZBH2T1WJQD-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://luke.geek.nz/azure/turn-on-a-azure-virtual-machine-using-azure-automation","mainEntityOfPage":"https://luke.geek.nz/azure/turn-on-a-azure-virtual-machine-using-azure-automation","url":"https://luke.geek.nz/azure/turn-on-a-azure-virtual-machine-using-azure-automation","headline":"Turn on a Azure Virtual Machine using Azure Automation","name":"Turn on a Azure Virtual Machine using Azure Automation","description":"Turning off a Virtual Machine in Microsoft Azure on a schedule can quickly be done using the built-in Shutdown controls in the Virtual Machine blade (part of Azure Lab Services, but not a requirement)_, but what about starting it?","datePublished":"2022-06-05T00:00:00.000Z","author":{"@type":"Person","name":"Luke Murray","description":"Author","url":"https://luke.geek.nz","image":"https://luke.geek.nz/img/logo.png"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://luke.geek.nz/","name":"Lukes Tech Blog - Unleashing the power of the cloud and other technologies!"}}</script><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="luke.geek.nz RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="luke.geek.nz Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="luke.geek.nz JSON Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0QDLBY7NNN"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-0QDLBY7NNN",{anonymize_ip:!0})</script><link rel="stylesheet" href="/assets/css/styles.a8967c60.css">
<script src="/assets/js/runtime~main.1bc7c312.js" defer="defer"></script>
<script src="/assets/js/main.93e11f81.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"dark")}(),function(){try{const a=new URLSearchParams(window.location.search).entries();for(var[t,e]of a)if(t.startsWith("docusaurus-data-")){var n=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(n,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:#D3D3D3" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY">If you haven't already, make sure you sign up for my Weekly Azure updates Newsletter, straight to your inbox! <a target="_blank" rel="noopener noreferrer" href="https://newsletter.azurefeeds.com/join">Subscribe now!</a></div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="luke.geek.nz" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.png" alt="luke.geek.nz" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">luke.geek.nz</b></a><a class="navbar__item navbar__link" href="/Tags/">Tags</a><a class="navbar__item navbar__link" href="/Archive/">Blog</a><a class="navbar__item navbar__link" href="/about/">About</a></div><div class="navbar__items navbar__items--right"><a href="https://www.youtube.com/channel/UCUG3TKDTAZz4UXshGrjBBoQ" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-icon" aria-label="YouTube">
              <svg width="24" height="24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path d="M23.498,6.186c-0.273-1.186-1.143-2.144-2.332-2.417C18.389,3.153,12,3.153,12,3.153s-6.389,0-9.166,0.616
                  c-1.19,0.273-2.06,1.23-2.332,2.417C0,8.07,0,12,0,12s0,3.93,0.502,5.814c0.272,1.187,1.142,2.062,2.332,2.335
                  C5.611,20.847,12,20.847,12,20.847s6.389,0,9.166-0.698c1.189-0.273,2.059-1.148,2.332-2.335C24,15.93,24,12,24,12
                  S24,8.07,23.498,6.186z M9.545,15.568V8.432l6.545,3.568L9.545,15.568z"/>
              </svg>
            </a><a href="https://aus.social/@lukemurray" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-icon" aria-label="Mastodon">
              <svg height="20" width="20" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" xml:space="preserve">
                <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                <g id="SVGRepo_iconCarrier">
                  <path d="M21.327 8.566c0-4.339-2.843-5.61-2.843-5.61-1.433-.658-3.894-.935-6.451-.956h-.063c-2.557.021-5.016.298-6.45.956 0 0-2.843 1.272-2.843 5.61 0 .993-.019 2.181.012 3.441.103 4.243.778 8.425 4.701 9.463 1.809.479 3.362.579 4.612.510 2.268-.126 3.541-.809 3.541-.809l-.075-1.646s-1.621.511-3.441.449c-1.804-.062-3.707-.194-3.999-2.409a4.523 4.523 0 0 1-.04-.621s1.77.433 4.014.536c1.372.063 2.658-.08 3.965-.236 2.506-.299 4.688-1.843 4.962-3.254.434-2.223.398-5.424.398-5.424zm-3.353 5.59h-2.081V9.057c0-1.075-.452-1.62-1.357-1.62-1 0-1.501.647-1.501 1.927v2.791h-2.069V9.364c0-1.28-.501-1.927-1.502-1.927-.905 0-1.357.546-1.357 1.62v5.099H6.026V8.903c0-1.074.273-1.927.823-2.558.566-.631 1.307-.955 2.228-.955 1.065 0 1.872.409 2.405 1.228l.518.869.519-.869c.533-.819 1.34-1.228 2.405-1.228.92 0 1.662.324 2.228.955.549.631.822 1.484.822 2.558v5.253z"></path>
                </g>
              </svg>
            </a><a href="https://bsky.app/profile/lukemurraynz.bsky.social" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-icon" aria-label="Bluesky">
              <svg class="octicon" xmlns="http://www.w3.org/2000/svg" role="img" viewBox="0 0 16 16" height="20" width="20" fill="currentColor">
                <title>Bluesky</title>
                <path d="M8 7.2c-.72-1.4-2.7-4.04-4.53-5.33C1.7.63 1.04.84.6 1.04.1 1.27 0 2.05 0 2.51c0 .46.25 3.77.42 4.32.54 1.82 2.47 2.45 4.25 2.25-2.6.38-4.92 1.33-1.88 4.71 3.33 3.46 4.57-.74 5.21-2.87.64 2.13 1.37 6.18 5.16 2.87 2.84-2.87.78-4.33-1.83-4.71 1.78.2 3.71-.43 4.25-2.25.17-.55.42-3.86.42-4.32 0-.46-.09-1.24-.6-1.47-.44-.2-1.11-.42-2.87.83A17.87 17.87 0 0 0 8 7.2Z"></path>
              </svg>
            </a><a href="https://twitter.com/lukemurraynz" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-icon" aria-label="X"><svg height="20" width="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 8.586l4.293-4.293a1 1 0 011.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 011.414-1.414L10 8.586z" clip-rule="evenodd"/>
          </svg></a><a href="https://www.linkedin.com/in/ljmurray/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-icon" aria-label="LinkedIn"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" height="20" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854V1.146zm4.943 12.248V6.169H2.542v7.225h2.401zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248-.822 0-1.359.54-1.359 1.248 0 .694.521 1.248 1.327 1.248h.016zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274 0-1.845.7-2.165 1.193v.025h-.016a5.54 5.54 0 0 1 .016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225h2.4z"></path></svg></a><a href="https://luke.geek.nz/rss" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-rss-link" aria-label="RSS"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)" aria-live="polite" aria-pressed="true"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><div role="group"><h3 class="yearGroupHeading_rMGB">2025</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure/kubebuddy-scanning-clusters/">Scan Your Kubernetes Cluster with KubeBuddy</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/misc/codespace-secrets/">GitHub Codespace Secrets</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure/acr-continuous-patching-security/">Azure Container Registry Continuous Patching for Security</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure/sftp-event-hub-function/">Processing SFTP Events with Azure Function and Event Hub</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure/mcp-acs-email-integration/">Sending Emails with MCP and Azure Communication Services</a></li></ul></div></nav></aside><main class="col col--7"><article class=""><header><h1 class="title_f1Hy">Turn on a Azure Virtual Machine using Azure Automation</h1><div class="container_mt6G margin-vert--md"><time datetime="2022-06-05T00:00:00.000Z">June 5, 2022</time> · <!-- -->11 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://luke.geek.nz/img/logo.png" alt="Luke Murray"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">Luke Murray</span></a></div><small class="authorTitle_nd0D" title="Author">Author</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><p>Turning off a Virtual Machine in Microsoft Azure on a schedule can quickly be done using the built-in Shutdown controls in the Virtual Machine blade <em>(part of</em> <a href="https://azure.microsoft.com/en-us/services/lab-services/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title=" Azure Lab Services"><em>Azure Lab Services</em></a><em>, but not a requirement)</em>, but what about starting it?</p>
<p>You have a few options, Logic Apps, PowerShell, Functions and Runbooks; most of the time, these will run on a standard 7 AM to 5 PM Monday to Friday schedule <em>(meaning the Virtual Machine is off during off-peak hours and weekends, reducing compute cost)</em>.</p>
<p>This works fine for most scenarios, but what happens if a Bank or Public Holiday falls during the week? With the normal schedule, your Virtual Machine starts.</p>
<p>Because all your users are on Holiday, it wastes money while you and your users drink snicker cocktails at the beach?</p>
<p>This is where using a third party timezone API like &#x27;<a href="https://www.abstractapi.com/" target="_blank" rel="noopener noreferrer" title="Automate routine dev work with Abstract&#x27;s suite of APIs">AbstractApi</a>&#x27; comes in handy; incorporating a lookup to check if it&#x27;s a Public Holiday before starting that Virtual Machine can help reduce unnecessary costs.</p>
<p><a href="https://azure.microsoft.com/en-us/overview/what-is-a-virtual-machine/?WT.mc_id=AZ-MVP-5004796#overview" target="_blank" rel="noopener noreferrer" title=" What is a virtual machine (VM)?">Virtual Machines</a> in Microsoft Azure have different states and, depending on what state the Virtual Machine is in, will determine whether you get billed or not <em>(for the Compute, storage and network adapters are still billed)</em>.</p>








































<table><thead><tr><th>Power state</th><th>Description</th><th>Billing</th></tr></thead><tbody><tr><td>Starting</td><td>Virtual Machine is powering up.</td><td>Billed</td></tr><tr><td>Running</td><td>Virtual Machine is fully up. This is the standard working state.</td><td>Billed</td></tr><tr><td>Stopping</td><td>This is a transitional state between running and stopped.</td><td>Billed</td></tr><tr><td>Stopped</td><td>The Virtual Machine is allocated on a host but not running. Also called PoweredOff state or Stopped (Allocated). This can be result of invoking the PowerOff API operation or invoking shutdown from within the guest OS. The Stopped state may also be observed briefly during VM creation or while starting a VM from Deallocated state.</td><td>Billed</td></tr><tr><td>Deallocating</td><td>This is the transitional state between running and deallocated.</td><td>Not billed</td></tr><tr><td>Deallocated</td><td>The Virtual Machine has released the lease on the underlying hardware and is completely powered off. This state is also referred to as Stopped (Deallocated).</td><td>Not billed</td></tr></tbody></table>
<p>I have written a base runbook that does precisely that, every time the runbook runs, it checks if it is a public Holiday. If it is - then the Virtual Machine isn&#x27;t started; if it isn&#x27;t, then the virtual machine is started.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">​</a></h3>
<p>Today, we are going to set up an Azure Automation runbook, triggered by a scheduled will go through the following steps:</p>
<ol>
<li>On a schedule <em>(7 AM, it will trigger an Azure Automation runbook)</em></li>
<li>The Azure Automation runbook will do a lookup to an external API, in this case, AbstractApi.</li>
<li>The runbook will check the date and detect if it falls on a Public Holiday; if it is a Public Holiday, it will exit the Azure Automation runbook; if it is a standard workday, it will start the Virtual Machine.</li>
</ol>
<p>To do this, we need a few resources.</p>
<ul>
<li><a href="https://learn.microsoft.com/en-us/azure/automation/overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="What is Azure Automation?">Azure Automation</a> Account</li>
<li>Azure Automation <a href="https://learn.microsoft.com/en-us/azure/automation/automation-runbook-types?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Azure Automation runbook types">runbook</a> <em>(I will supply a PowerShell runbook below)</em></li>
<li><a href="https://www.abstractapi.com/" target="_blank" rel="noopener noreferrer" title="Automate routine dev work with Abstract&#x27;s suite of APIs">AbstractAPI </a> API Key</li>
</ul>
<p>And, of course, &#x27;Contributor&#x27; rights to the Microsoft Azure subscription to create the resources and the schedule, along with setting up the System Managed identity to grant the Azure Automation account access to start the Virtual Machine.</p>
<p>We will set up this from scratch using the Azure Portal and use an already created PowerShell Azure Automation runbook.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="deploy-start-vm-solution">Deploy Start VM Solution<a href="#deploy-start-vm-solution" class="hash-link" aria-label="Direct link to Deploy Start VM Solution" title="Direct link to Deploy Start VM Solution">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="setup-azure-automation-account">Setup Azure Automation Account<a href="#setup-azure-automation-account" class="hash-link" aria-label="Direct link to Setup Azure Automation Account" title="Direct link to Setup Azure Automation Account">​</a></h4>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="create-azure-automation-account">Create Azure Automation Account<a href="#create-azure-automation-account" class="hash-link" aria-label="Direct link to Create Azure Automation Account" title="Direct link to Create Azure Automation Account">​</a></h5>
<p>First, we need an <a href="https://learn.microsoft.com/en-us/azure/automation/automation-create-standalone-account?tabs=azureportal&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Create a standalone Azure Automation account">Azure Automation</a> resource.</p>
<ol>
<li>Log into the <a href="https://portal.azure.com/#home" target="_blank" rel="noopener noreferrer" title="Microsoft Azure Portal"><strong>Microsoft Azure Portal</strong></a>.</li>
<li>Click <strong>+ Create a resource.</strong></li>
<li>Type in <strong>automation</strong></li>
<li>Select <strong>Create</strong> under Automation, and select <strong>Automation.</strong></li>
<li><img decoding="async" loading="lazy" alt="Create Azure Automation Account" src="/assets/images/azureportal-create-automation-f17fe5866b2554fab2016911fdae4250.jpg" title="Create Azure Automation Account" width="426" height="573" class="img_ev3q"></li>
<li>Select your <strong>subscription</strong></li>
<li>Select your <strong>Resource Group</strong> or Create one if you don&#x27;t already have one <em>(I recommend placing your automation resources in an Azure Management or Automation resource group, this will also contain your Runbooks)</em></li>
<li>Select your <strong>region</strong></li>
<li><img decoding="async" loading="lazy" alt="Create Azure Automation Account" src="/assets/images/azureportal-create-automation_basics-1389cb6873b6fc1b5c884f01279f38c4.jpg" title="Create Azure Automation Account" width="749" height="479" class="img_ev3q"></li>
<li>Select <strong>Next</strong></li>
<li>Make sure: <strong>System assigned</strong> is selected for Managed identities <em>(this will be required for giving your automation account permissions to deallocate your Virtual Machine, but it can be enabled later if you already have an Azure Automation account)</em>.</li>
<li>Click <strong>Next</strong></li>
<li>Leave Network connectivity as default (<strong>Public access</strong>)</li>
<li>Click <strong>Next</strong></li>
<li><strong>Enter</strong> in appropriate <strong>tags</strong></li>
<li><img decoding="async" loading="lazy" alt="Create Azure Automation Account" src="/assets/images/azureportal-create-automation_tags-cf8d12ea6a602ac7d4d3019f34458da0.jpg" title="Create Azure Automation Account" width="753" height="524" class="img_ev3q"></li>
<li>Click <strong>Review + Create</strong></li>
<li>After validation has passed, select <strong>Create</strong></li>
</ol>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="configure-system-identity">Configure System Identity<a href="#configure-system-identity" class="hash-link" aria-label="Direct link to Configure System Identity" title="Direct link to Configure System Identity">​</a></h5>
<p>Now that we have our Azure Automation account, its time to set up the System Managed Identity and grant it the following roles:</p>
<ul>
<li>Virtual Machine Contributor <em>(to deallocate the Virtual Machine)</em></li>
</ul>
<p>You can set up a custom role to be least privileged and use that instead. But in this article, we will stick to the built-in roles.</p>
<ol>
<li>Log into the <a href="https://portal.azure.com/#home" target="_blank" rel="noopener noreferrer" title="Microsoft Azure Portal"><strong>Microsoft Azure Portal</strong></a>.</li>
<li>Navigate to your Azure <strong>Automation account</strong></li>
<li>Click on: <strong>Identity</strong></li>
<li>Make sure that the <strong>System assigned</strong> toggle is: <strong>On</strong> and click <strong>Azure role assignments.</strong></li>
<li><img decoding="async" loading="lazy" alt="Azure Automation Account managed identity" src="/assets/images/azureportal-automation_managedidentity-46173e0eb415b07c841cfd616266eb7c.jpg" title="Azure Automation Account managed identity" width="773" height="706" class="img_ev3q"></li>
<li>Click <strong>+ Add role assignments</strong></li>
<li>Select the <strong>Subscription</strong> <em>(make sure this subscription matches the same subscription your Virtual Machines are in)</em></li>
<li>Select Role: <strong>Virtual Machine Contributor</strong></li>
<li>Click <strong>Save</strong></li>
<li>Click <strong>Refresh</strong> <em>(it may take a few seconds to update the Portal, so if it is blank - give it 10 seconds and try again)</em>.</li>
<li>You have now set up the System Managed identity and granted it the roles necessary to execute the automation.</li>
</ol>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="setup-abstract-api-key">Setup Abstract API Key<a href="#setup-abstract-api-key" class="hash-link" aria-label="Direct link to Setup Abstract API Key" title="Direct link to Setup Abstract API Key">​</a></h5>
<p>Now we need to create an API key, which will be used in the runbook to start the Virtual Machine, the API key will allow connections to the Abstract API to retrieve public Holliday information.</p>
<ol>
<li>Create an <a href="https://www.abstractapi.com/" target="_blank" rel="noopener noreferrer" title="Abstract API"><strong>Abstract API</strong></a> account</li>
<li><strong>Log in</strong> to the newly created account</li>
<li>On the left-hand navigation bar, click on <strong>Holidays</strong></li>
<li><img decoding="async" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAPQAAAG5CAYAAAC5nhn4AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAACF/SURBVHhe7Z3/zyXXXd/5Y/ihSKiqKkDlhxYhvkhgQdsUC1QrBMVWSLtp1aJVMJU2CIIB7Q/AYn5wIpQA+YW1woP0NLhR3Yq2itZlvc3Wm8QOdmS09m5XibSpjSPjtdfPMO8z87n3M2fOzJ2598x9nnv29ZLeeu7M+TJzr+Y158zcuzvf9d3f84MVIaSMIDQhBQWhCSkoCE1IQUFoQgoKQhNSUBCakIKC0IQUFIQmpKAgNCEFBaEJKSgITUhBQWhCCgpCE1JQEJqQgoLQhBSUvQn9D/7hj1b//IOXq1/4pRdDfvxfPZmsRwjZPnsT+pF/f6366IW7nfzkz302WZcQsl32IvT3/7Nf7Mls0cidakMImZ+9CP3DP/3bSZkVyZ5qQwiZn70I/Y/+ySNJmZV/+hMXkm2Wzn/9b/8zJFVGyKFmb9fQP/3Bp5NC/+wv/mWy/tIxUmW58lP/8uerPzv6QvVDP/qBZPlZy2f/+E+r3/it30uWkWn5mUd+vXrsY5/eKT/zyK8l+56SvQmtaDT+wKN/Uf3sR/9HR+rTmHYbqbJc+f0/+MOwDf1NlZ+1GKkyMi15hP71ZN9Tsleh4+ja+tFffq169PHX9i61kSrLFYQm+05Wob/3+/5FLeZHZt251vW1pLbp9w//1G+FPtRXqv6maJr7r3/+326c5hq2/I9/4MdCO8XXG4qvr9epOpuEVjvf1vZdf309n7n7abE2Y5+LkSojh5EsQkvgD3z4C51ptEbfVN1Uhu6C64coqfqpXKqluXXr/7WHZMOLL71c/ZuP/XKyviFBdJ3refNv3wr9pdqp/v/+q//T1lyjdSaipNGy7Y/+ajm+Caf12pbaxfv+R3/Sfe+qE29XbXXd608KcfQ+VM/j91VRH75vvVaGPjtydpNFaP1AJCXkD/7If0zWj6MTQqq98uMf2PyLMi/ks//9f4UR8aWvv9KuqaqP/6ff6LUxJL2wdvprqN+4ndVX/6ov8W7dvhPWSRzJ9ciHzlV/G0kkVM/3ZaidytSX+vyzP/+Ljkx6bWi7qqc6tg3tU0pq21fViz8XbdNGa/9ZeRD68JJF6A/90ktJGXVnO1U/lfhGmeWRf/d8sr5FsgoJEU9VJZYRTzUNHexxOy2bLP5koD5ELKZiJwMvltYJ/fV1LYbkTJUr6s9G2PjEpDKTMR7Rbdsqj9+7+tF70Ofj1xt+HZmXIu5y2zVwHN3RTtVPJfXTUEUni1R9i01V44PTYgd2LI2RGr0VO1FIUr9eSLCh7flMFTo+ofjoayQR74dFUgubHdh6+1zG+o5jpMrItBRxl3voO+apPxoZm3Jv+r230GiaKlN0QIu/uvrlznrDr4tj+HUmupA0mpZ//Fc+2ZHJMlXoVJnFLgHGpr96b8JOMib52OeSipEqI4eRbDfF4hF2znR76KaYpuFjd8xtChzLGsfYtC6OEa/XSUIjvqathkbIeLTPIXQsaypxnaGT2KYYqTJyGMkitEXfJUtOfRWVKk8lfG31eDNl1/RaI7JuhE39XtpIjZCKv6Hk15uM8fWlZex62Uf1TFzh+8shtE4cYujSQLGbX156oZOMr7cpRqqMHEayCj0nGnn1nbPJPOdrLh+bkg5Jo6+KDL9eN5FEfDPJYnfO4/Kh739TU2MTemgbRqrMYickTe9TJy1/wvJC26g956ecxtDJkZz97FXo8NPPD38h/IDET613+QcaOogNfedqB6NGyvj7Zd9O5XYn23+Xq79aFipPjbjx97jaB7sT7dfb1FdlHz338d7JwPDrUrE72RqJff+6drftCi+0bVt88jd/t/P+9LmoL//eFNuOyjf9CIWks+mm2C53sKdkb0IP/uOM+jo5VX9O/I2qGJuyiridDnqTOkbrvTyb6ovU109++8KPmIavn4q2O/RdsdZbmRda0ecytL9qY5Jb4vc3d8pOpgi9/R3sKdmL0GP/fHLbqXYcHcySR1NNRa9NSE2Hh6bkOqhVZu0ULccHu68vKdWn6koMvR67xlWZ9e1PEpqKq62vOxS/n9qm/to2rf/UiKp12o5vp/0fen/aP/schy4VyNnNXoQeuout8B8cEJIvexFa0qZkVsa+liKEzMverqFTvwSb8101IWRz9ia0RmIJrO+alSn/6IIQMi97E5oQsnwQmpCCgtCEFBSEJqSgIDQhBQWhCSkoCE1IQUFoQgoKQhNSUBCakIKC0IQUFIQmpKAgNCEFBaEJKSgITUhBQWhCCgpCE1JQEJqQgoLQhBQUhCakoHxX+5AEACgAhAYoCIQGKAiEBigIhAYoCIQGKAiEBigIhAYoCIQGKAiEBigIhAYoCIQGKAiEBigIhAYoCIQGKAiEBigIhAYoCIQGKAiEBigIhAYoCIQGKAiEBigIhAYoCIQGKAiEBiiIvQn9zr0mALAcexH6O2+fVM/duBei1wCwDIsLvZL5hTZIDbAYiwrtZdbrsIzUAIuxmNCxzAZSAyzHIkIPyWwsIfWVS49WDz0c56nqSlu+Pbery+cvVJdvtYs9rlUXs2xnB24dV+fOH1evt4vw4JJd6E0yG7mlltDnjm63Sw2vH10IYl+82q7YCoSGwyGr0Cbzl65Pk1R1VDeH1CmhRSP1LsIhNBwO2YTWd8wmszIVq6+2u3xPPSR0I5wT8upTbkreFdVG9O503YRWP3GZMKF9eXwCUB9WVieWb3Cf2m1frYUNZbZdv616BnKE0NCQVegbr7xbPf/V+UKrjdouI3Qjk027r9QH/+rAl0gmgkY5L+rVa05oL1OzrYcuXWuXTC7fVoLactt+Vb89cTgBB/fJ2nZkbdb59xr2B6GhJvs1tMSMhZaob751EhJLq7pqsytThe5io2tNEDoeWYXaR+s7U1z1kR6RwzbjE0Ug0ecKt0+pfU/119kfeJBZXGi7Tvbx18taXlToWNSwrBHV4uRwZWuJpggdC+v2pzPiGlGfg/uU2Haqv87+wIPM4kLfvHM/LN/+1v0QvdY6Y2mhw3TUprudqbBIy9isN6mnCB2V+5G1t03h+hzdpwGh4/5SksMDyd6EfqOebiv7FDrI7A/+6MDv3AGvy7qj8hyh3UmjpnuN3PTVK/cnmaF9Sm273d76vbb9IzTUFCX0esrapD9itwf/qvx4PRrG096VgFOErvsII6e1dyeRQCu9pSPfyD4lha7p7GtdrrvgCA012YV+8dX3gqR2E+zlm82yn3JrnZVrWW0AYHeyC/3Nu+8HSedEbQBgd7ILLfTVlE2xN2WX754BoMsiQgPA6YDQAAWB0AAFgdAABYHQAAWB0AAFgdAABYHQAAWB0AAFgdAABYHQAAWB0AAFgdAABYHQAAWB0AAFgdAABYHQAAWB0AAFgdAABYHQAAWB0AAFgdAABYHQAAWB0AAFgdAABYHQAAWB0AAFgdAABYHQAAWB0AAFgdAABYHQAAWB0AAFgdAABYHQAAWB0AAFgdAABYHQAAWB0AAFgdAABYHQAAWRXehrn/l09dhnvtEuGd+oPvWxev0qT1fHd9qiUPZsdc1eP3Gtuh1e11x/1rWxOmvCtjr9NvnEM9+O2rbrEqiPXpnahvcQ7/enq09dV4Wh9SJ6P1E9bWt8mwDbk1foO9eqTzzxbC2lF1bowF6vu/3M09VjK3EjAWy9+vIS18vHK2liuv03Mvt9+HZ1/MSA1AmRJNxa3Pi9iNT2vMT+daJ9/N7C/qW2AzCPrEJLVEljf9fEB7ZfjgQwoSWJH61H8f018q5HzJaeRC299dH+pITsrffLU9pHMwNGZ8hERqHdKCNJOjJOFcCj9QOjag/X35C4g6NgdALoyBXvtxGt75x8/PsZal+z+owGTkAAW5BP6I7EsTzdA3t4yh3THOzda9QUrv/eycQYFsfPKNbTbaF+/TWwF9Wt74yu/v3E7bvbD9t6Zmh/AeaTTeh4mh2k7Yx0/sD2AnsBBgij7pjU6sMJnewvPsk4OqPl8Ilozdj2/PsZat8Srr3H3hfAPDIJrQPXCxuLO3ZgewGG6Z4gYnz/AyPxoOiiFfm6iW0M7Xd3ffdk5t/PUHtjUznAPPIInbyB5cUaO3C9AI5arnX9pq/h6+mo/zDy+T5VPn49Hk4YvTpD+x2v98t6jdBwOmQROvm9as16VB07cL0AHq13o/3g6CwS/bfTWcvGaW0YweN9jPahTvM++9sL7zWc1Pz7SexXh03lAPPId1MMAE4dhAYoCIQGKAiEBigIhAYoCIQGKAiEBigIhAYoCIQGKAiEBigIhAYoCIQGKAiEBigIhAYoCIQGKAiEBigIhAYoCIQGKIisQn/n7ZPq1Vv3q6+88u6sqI3aAsBuZBP6/v2qeu7GvepL17eL2qoPANiebEK/8dZJEPPmnflWqo3aqg8A2J7sQr/46nuzRlrVVZtdhb5y6dHqoYe7uXi1LczF1afqfi9Ul29p4Vp18eGnqiuhIBeuz862Etw6rs6dP65ebxdnsalvOFiyC61o+nz3jffbkmFUx0/TdxX63NE+HyizsNCbmCO0BL7U/4+SoTyyC60bXM+90Ag6NFr7UVl11QahBULDbmQXWn87wkajtR+VTXjfdluGhb5dXT5fTy+v1gLYdDwc3JLHpueRRGFKamV+auqFG5YvtS+vH12oHjIBt+rf7299OXEUCT3QZ9iubxcuQ+K+9Rmt66z2M9B+frf89tPvG06fRYQ2grxutPajspc8l9CrA7Jz0LUH6+ogtQMzOujdCHallqUjSqftkHCOIFdfGLumn99/096fJML7deIN91mj5c4I3e/bl3dOPlbu3k/YNiP+mWRRoYVG4JdvNiIreh1Pw3MJPTpCuxtAOmA7dUenr0OS+dcxXYF37l/t421N7rNmTOhU353PrP/5jW8bTpPFhTbeudckxZkTOhzkGpUsdsAPydfHj/q9fZvbfzziisn7XDMmdKpvhD5Y9ib0GGdKaB3gXoZBif3rBEEwlUf1tum/16bGizjaZ43Kx4SO+0bogyW70Kf1w5KsQruDNYy0qwN+SL402qeLlyKZtupfr/3703uqR+FJ+1wzJrT15cpD+9UyQh8S2YTWdbHdANsmahtfW89B8qynm00aAWYKbQf4qo/jEcmcNCnC6BfJsG3/YcS3dnWfums/aZ+F+mrK0ne51+UhHVkR+pDIJrSwf5xx45V3Z4V/nAGQh6xCA8DpgtAABYHQAAWB0AAFgdAABYHQAAWB0AAFgdAABYHQAAWB0AAFgdAABYHQAAWB0AAFgdAABYHQAAWB0AAFgdAABYHQAAWB0AAFgdAABYHQAAWB0AAFgdAABYHQAAWRXWg9zuZNl6EH1AFAfrIKff2ld5OPudnlmVUAMJ1sQtvD6vRoG722aJ0e9A4Ay5NdaP31SGat3+VBdAAwjexCf/Pu++2aBi2n1gNAfrILHT8fWiOz1i897e4/TtY/AjXxSNSDwz0CNvmYWscuj3vd1DecabIJbeK+fHMtru5wa3lfQnee+dw5MAsTehNzhO49DB4OmWxCi+e/eq96/mvN91SS+bkbzV1u3Shb+hq6J3T7EPShh74fHggNm8kqtB7cLoHtxph9jbWPh7kPCX3xqr2W0JLCpuSxHE391ZS9I8SU9r7Mttunv59V9frRhfX2wszC+vEnIS90LHe07aNI6IE+w3Z9u7DPcd+7fi6wT7IKrVFZAn+lHpGFRNby9a83y0LrVK4puG6U5Rq5Y1Gag9UOLjso1web6q9HprbcjVQdySa2X29fB7iX0RHk6gtjJ4ArtYwdEVf74EXzr+Ntt/vmxBvus0bLnRG63/f2nwvsm6xCC7tmvvtGc1dbN8lMasms6beWfSR3/HXXXMKBtBolugdZc+BFgvlpqV536gvfZkP7WJIa7U88Ejc0EqxG8NHp8ZDE7nVq3yf3WTMm9K6fC+yd7EKHa+cX7oXrZ5tqm9QWSa+RWSO0fU+t7PIz0WGBxHwhZx24at85mTQZ2p8wyrUS9fY7SOT7MaEGhE7teyzVYJ81Y0Lv+rnA3skutLCptpdaf3VNLdljce0rr11G6Z2F9gd5YKbQcw7iIJi2lxgtO/sxIHEsXadNjd+f0T5rVD4mdNw3Qp9pFhFa2A9KJLVNv0VqFD51oUN5PXK5A9uPopvbS4Kx7ffR/l68FMnkRazp3gcYELq37fa9eKEH+6wZE3rnzwX2zWJCC43KGpElq26EDQl7+kKLRozVtLRTtkV7L02KMPpFfZpAbR/njo4jcVOva7Qvq+3WfV71+zbWp1jvd/oud/S+Zn8usE8WFVpoRLYbZYq+p9bya/V1tUZx/RNLya4ym54DwHYsLrQhsfU9tX58YnL7SHIA2I29Ce3RHW5Nry2MzAB5OBWhAWAZEBqgIBAaoCAQGqAgEBqgIBAaoCAQGqAgEBqgIBAaoCAQGqAgEBqgIBAaoCAQGqAgEBqgIBAaoCAQGqAgEBqgIBAaoCAQGqAgEBqgIBAaoCAQGqAgFhFa/02v/gP9VABgObILHT9pMo6ekpHrmdAA0CWr0CaznoKhx9z4/0xf8c+KRmqA/GQTWoKazGPYUymRGiA/2YTWCCxRJazQs6A1IqdAaoBlyC60/grJbK9T5JRaj5LtPuN4Tfd5xjXto1ebR6c2hPb+kakWHosKB8ZiQk8hm9ThWcv+mcZG82zjWN7eg9ZXxM9GBjgsTlVo4aXenr64gZ7oJuyQuAgNh82pCy3s7rddf29DatqtdeeObrdLNRK8rdMrCyA0HDbZhR66ETZGDqGba+N4NL5QXb7VLtaE6baN4pK7d42M0HDYZBNa3Hjl3dlirqbcL+0y5Ra3q8vnR4SdIDxCw6GTVWjd2JKYU6X2Muf4+mp9R7uR20+pQ5m/g23pTNMRGg6brEKLqVLnljkQRuF61L0aj8bR6G0M3jQDOEyyCy02Sb2IzIF2ZD6f+u45JWosOkLDYbOI0GJI6uVkbgmjbnc0Tt0BN7o/PEFoOGwWE1p4qV+7cz9kUZkBHnAWFVp4qZEZYFkWF9rQVDt1PQ0A+dib0ACwPAgNUBAIDVAQCA1QEAgNUBAIDVAQCA1QEAgNUBAIDVAQCA1QEAgNUBAIDVAQCA1QEAgNUBAIDVAQCA1QEAgNUBAIDVAQCA1QEAgNUBAIDVAQCA1QEHsT+jtvn4QAwHIsLvTdN96vvtI+ZlbRa60DgPwsIrSejKH/VP/5rzUSKy/ffC/EllWmOjxFAyAfWYV+514Vnl/13I1G2udeuFfdrJe13tBrrVNZqFPXVRtfBwC2I5vQuj5ejb5f3Tz6rkbxuq614xobYDeyCS1BNaXe5vpYbdR2l+l397Gw7SNkH/YZeExseHZ04mHw7bOjk+30yNqBx9NOf3RtCvc42/BY3AvV5VuhoI/2+/xx9Xq7OItNfcPBklVoe2Tstskt9Lmj2+1SK1pCAK2/eCklqAmdEHRE6EaW1MlDsqZOHJ4Zz6eeI/TY/kJRZBP6jbfWU+5toz62ZZPQ4aDuCWACpURqhL54VWXRaDYqyIC4g6J7EBp2I+tNsVdvNQ90v/2t+0HOKVFdtVHbXRgXupGzI7hwB3rvBLASuu3by7NBkDAbiMo7/Qe529G/c7LwQsdyNycKa3fxKBJ6oM+w775dONHEfbvZiNI5UahM/fntTzzpwN7JKrTuXvuR1k+h9TpeFqqrNmq7CymhVwdo7yBtUJ3VSCohegeylfvXNRuEbq7LYxnXkl2pZeyIuNquF82/brbvTzjh/bn9He6zpre//b59efcE1pa795M6YcHZYDGh9TWUjdbixivvhggblVVnSaE7I64Oai/ZBumSElv9niAxibadk4VnSGL3urevNaNTbt9PzZjQqb7D/ttn4V+3jG4bTpPFhI5F9UKP1duWjUJHksVT0VVWfURS1qz63Ci035+mn86+BIn8dk2oAaFTJ4RYqsE+a8aETp5sEPpQeUCF7ssa0MG9EiFVRyLUB/fRZqEbweq6V/U3kssvD0kcS9dpU+NFHO2zRuVjQsd9I/TBspjQukbWr8Hse2n76afQOpWpzr6Ebkbk9sANssUHsdgsfeinPsDPbRK6bX+urtuRyYtY09mvUbn9+2n67gg92GfNmNDWlyvvfpYqR+hDYdGbYlNYUuj19FNZH+ChrHOAr1n3kxY6JcAgYfSL+2jbt/t17uh4RGInZTgJWbt25F9JNdanaE4IKmv2JerblYd0ZEXoQyKr0PaPL3TT681a1CmxG2Q2egPA9mQT2kbaXTJnZAeAPllHaAm5SwBgN7IKDQCnC0IDFARCAxQEQgMUBEIDFARCAxQEQgMUBEIDFARCAxQEQgMUBEIDFARCAxQEQgMUBEIDFARCAxQEQgMUBEIDFARCAxQEQgMUBEIDFARCAxQEQgMUBEIDFARCAxQEQgMUBEIDFARCAxQEQgMUBEIDFARCAxQEQgMUBEIDFARCAxQEQgMUBEIDFARCAxQEQgMUBEIDFARCAxQEQgMUBEIDFER2oa995tPVY5/5RrtkfKP61Mfq9as8XR3faYtC2bPVNXv9xLXqdnhdc/1Z18bqrAnb6vTb5BPPfDtq265Lou37/YmY0s9onbj/b1fHT9T1wmeU2rZfp9frfrufG0CfvELfuVZ94olnaynHDtKquv3M09VjK3FVlhBafXmJ6+Xj6+3rHt3+G8H8PjQSpaWO2nqm9LOxTrd/nYSGyhr8um5593MD6JNVaB1wOljt75r4wI0P2oTQEmXywev7a4T6VCx/fIJYEe+bMaWfKXXW/QchO7OX1Lb9urh8aF8BGjIKrYO7Pdh0QHdkHDsw9XpItKFRNcb1Nyiu278O8b61TOln0rba/p9JnaBS2/br4vKBfQVoySd0R+JYnu6BODzljlE/zfVjbxTs4PrvnUyMpq9+PwOSTOln0rbU/9B7SG3br+uWM+WGTWQTOp5md6eX64O6iRdYZUNCt4SRcExqd+CHuptGTU9XmhVT+pm0rbb/66obbye1bb9Or4c+N4A+mYSOD7z4AEwduIbKNh+o/etPj+/fj46OQfmG9m1KP1PquP7DDTS/D178lqG2ABPII3TyBpY/2McOTJUlRKtHtHX9pq/h6+mo/544Kh9qP7JvU/rZWKfbfzxtDl+9xcudmQ1Cw3SyCN39KmbNelQdOzBVlhC6FWM12g+OziLRfxBt3X58uu62U6cv7IZ+Ruv0960rcXOyWrXvnBgT7wtghHw3xQDg1EFogIJAaICCQGiAgkBogIJAaICCQGiAgkBogIJAaICCQGiAgkBogIJAaICCQGiAgkBogIJAaICCQGiAgtib0G+8dVK9WQcAlmNRoe++8X71/NfuVV+63o3WqQwA8rKI0PfvV9WLr77XyPvVe9XLN9+rbn/rfohea53KVEd1ASAPiwh945V3g7Cv3rqfFFbrVKY6X6nrAkAesgutUdhk9kjiWG6TWm0AYHeyC/3cC8002+SNr6P1WjfIhOqo7nM37oXlXXj96EL10KX1/x165dKj1UMP+1yoLt9qC/fKteriw09VV9qlvXD1qVN8v3CaZBX6O2+fBGlv3mlslrCSVZLr2lnRa60z4VVXbdR2F1JCnzty/1P4qR3kexBa7829d3hwySr0N+++H+S0EVh/teyn3zbNjuuo7S5sFLq6XV0+H6/bBwgN+yOr0Hb9HMvqr5Gn1NmGqUJfvNou9pB46yn6xaPj6tz54+r1trRX3umn6dvKHuq180KP1RVRubUNMwxbt55phPe9Wm/7NWebKlN//v0tfAKCxcgqdCynTcF13awRWLHr6Xfay+ZY8G3ZJHRz4A8dqM0Bv67fCrA68ONyHfwmVVvXbTtsa9XWy7Wpbqr8OLS9Uv9dSSi5vZS9EXqLbbrPJtx/6PQHh0JWoXVdLDn1/bJhU2wfPwW376t3JSX0akTaNOrcqkfjuFzr7KCPBapZnTBSbYMkJryTa1PdMAqP7OcKL2zNmNAb98+/bvHvHQ6KrEILE9T/EkwjtUZixd/8Uh3V9SeAbUkJ3Z1yj5AQtid05+TQJPSfajsk9Ka6yfKWIKbf/kShN+4fQpdEdqHDne32TvbYnWuVqY7/imsXsgvt142JprLRETCSa6zu0HZ67WaM0Bv3D6FLIrvQwq6lh6Q2mVVn12tnYyehgwC+vg7yehRcHdRxuaet67bd3Rcv35S63e2Ea+hI9NBmqtAbt4nQJbGI0MK+woql9jLv+lWVZzehazpT2voAvxof1I1sySlvXNZrN7WuSJW3UrbrztWSD/WZvss9tk2ELonFhBax1EvJvAi9UQ/g7LOo0MKk9jnzMrcj2vB31gBnk8WFFhqZ7aeffvp9duhOaddTV4DDYi9CA8B+QGiAgkBogIJAaICCQGiAgkBogIJAaICCQGiAgkBogIJAaICCQGiAgkBogIJAaICCmC30e++dVO/ce796++8IIbkjt+TYtkwW+qTeBiITsp/INTk3l8lCIzMh+42cm8skoTUFSG2QELJs5k6/JwnN6EzI6WTuKD1J6NSGCCH7yRwQmpAznjkgNCFnPHNAaELOeOawqNDXXzqp7v7//nqt+79f768nhPQzh8WE/uu/eb/64ONV9Z//sv+V1+X/chLKXrvTXU8I6WcOWYWWxH/05yfVJ586qX7ld6sg7X/47Sos+2idylRHy2qjtqk+CXnQM4dsQmsa/ZFfbUTdJmqbmp4T8qBnDtmE1vWyxNR0OrXsY1Nu1UktE0LWmUN2ob2Unx2YSmudymw51XZurnyuqh7/Yn/9q1+sZwCfm9rvSfXk4yfVFb3+crNPn38trtPmtZPq8d85qV5NlRGSMXNYVOipOZNCbwpCkz1lDosJrWl0fDMszuUvNnURmpDhzGExoR9v73KPRXVSbbfJHKE//ztuPzpSeqFjubW8bvdkfTLqCN1O0S02VU/ul+q2bcP+rdpNPJmQBypzKGrKvRYjihM6yOyWg1ArMYeFVjsvZtieE/pKLXhHbisLondFVV9Pfrl+rVHel9V1EZrEmcODdQ0dC9RGgjUj6oDQqXajU+7+ySAIrGXfV3g9cuONkDpzeLCE9iOny0ahU+1ioVs5w4wgZC203we97uyna7eSnhCXOTx4QjvRLJOEjtt5yXvl3RF6vay/QyNyU4bUJM4cHiyh60hev9wt9yLGr7v9h3680G60Dn12hG7278l6O37baucF7kzNCWkzhwdOaJNT2wvpTKWHhK4TTak/X8vop9xB8Lbs8S9GbZUwikfCxtP0zn4S0mQO2YXW98v6p5FzojZqu4vQZz7RKE7I1Mwhm9DKlO+eh2LfSZcajeCpGQQhmzKHrEIrGmW3SaqvEqJLgXDSYjpNtswcsgtNCMmbOSA0IWc8c0BoQs545oDQhJzxzGGS0DwKh5DTySKPwuFhdYScThZ5WJ1glCZkv5k7OovJQvPAd0L2F7m26APfDU0BEJuQZSK35k6zPbOFBoCzSlX9PSsHO45CrXEJAAAAAElFTkSuQmCC" width="244" height="441" class="img_ev3q"></li>
<li>Click on &#x27;<strong>Try it out</strong></li>
<li><strong>Copy</strong> the <strong>API key</strong></li>
<li><img decoding="async" loading="lazy" alt="Abstract API - API Key" src="/assets/images/abstractapi_key-c213ebd8ac4b031f65e3b4a98dc2bddd.png" title="Abstract API - API Key" width="1070" height="777" class="img_ev3q"></li>
<li>Copy the API key, as we will need it for the next steps.</li>
</ol>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="import-runbook">Import Runbook<a href="#import-runbook" class="hash-link" aria-label="Direct link to Import Runbook" title="Direct link to Import Runbook">​</a></h5>
<p>Now that the modules have been imported into your Azure Automation account, it is time to import the Azure Automation runbook.</p>
<ol>
<li>Log into the <a href="https://portal.azure.com/#home" target="_blank" rel="noopener noreferrer" title="Microsoft Azure Portal"><strong>Microsoft Azure Portal</strong></a>.</li>
<li>Navigate to your Azure <strong>Automation account</strong></li>
<li>Click on <strong>Runbooks</strong></li>
<li>Click <strong>+ Create a runbook</strong></li>
<li>Specify a <strong>name</strong> <em>(i.e. Start-AzureVirtualMachine)</em></li>
<li>Select Runbook type of <strong>PowerShell</strong>
<ol>
<li>A select Runtime version of: <strong>5.1</strong> <em>(7.1 works as well).</em></li>
</ol>
</li>
<li>Type in a <strong>Description</strong> that explains the runbook <em>(this isn&#x27;t mandatory, but like Tags is recommended, this is an opportunity to indicate to others what it is for and who set it up)</em></li>
<li><img decoding="async" loading="lazy" src="/assets/images/azure-createazurerunbook-39ce2398dc02876db33ee67526176902.png" width="733" height="457" class="img_ev3q"></li>
<li>Click <strong>Create</strong></li>
<li>Now you will be greeted with a blank edit pane; paste in the Runbook from below:</li>
</ol>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">Start-AzureVirtualMachine.ps1</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">#requires -Version 3.0 -Modules Az.Accounts, Az.Resources</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">&lt;#</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    .SYNOPSIS</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    PowerShell Azure Automation Runbook for Starting/Stopping Virtual Machines. </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    .AUTHOR</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    Luke Murray (https://github.com/lukemurraynz/)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    .VERSION</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    1.0 - 28/04/22 - script versioned to &#x27;1.0&#x27;.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    .DESCRIPTION</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    1. The script first checks if today is a holiday by making a call to the Abstract API.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    The Abstract API returns a JSON object containing the holiday name and (optional) description.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    The script checks if the name property is null. If it is not null, the script displays a message indicating that today is a holiday.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    If the name property is null, the script displays a message indicating that today is not a holiday.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    2. The script then checks if the virtual machine is running or not. If it is running, the script will stop the virtual machine.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">    If it is not running, the script will start the virtual machine, depending on the Shutdown tag value</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">#&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">Param</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token namespace">[Parameter(Mandatory = $true)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token namespace">[String]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$TagName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token namespace">[Parameter(Mandatory = $true)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token namespace">[String]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$TagValue</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token namespace">[Parameter(Mandatory = $true)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token namespace">[Boolean]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$Shutdown</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$CountryCode</span><span class="token plain"> = </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;NZ&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$tDate</span><span class="token plain"> =</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token function" style="color:rgb(80, 250, 123)">Get-Date</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ToUniversalTime</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$tz</span><span class="token plain"> = </span><span class="token namespace">[System.TimeZoneInfo]</span><span class="token plain">::FindSystemTimeZoneById</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;New Zealand Standard Time&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$Date</span><span class="token plain">  = </span><span class="token namespace">[System.TimeZoneInfo]</span><span class="token plain">::ConvertTimeFromUtc</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$tDate</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$tz</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$API</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-AutomationVariable</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name AbstractApiKey</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$Holiday</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Invoke-WebRequest</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Uri </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;https://holidays.abstractapi.com/v1/?api_key={0}&amp;country={1}&amp;year={2}&amp;month={3}&amp;day={4}&#x27;</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">f </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$API</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$CountryCode</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$Date</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Year</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$Date</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Month</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$Date</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Day</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$Holidays</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$Holiday</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Content</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$Holidays</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$Holidays</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">ConvertFrom-Json</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">IF</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$null</span><span class="token plain"> </span><span class="token operator">-ne</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$Holidays</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">InputObject </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Today is a holiday. The Holiday today is: {0}. The Azure Virtual Machine won&#x27;t be started.&quot;</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">f </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$Holidays</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">ELSE</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Message </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;No holiday today. The Virtual Machine will be started.&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Ensures you do not inherit an AzContext in your runbook</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token function" style="color:rgb(80, 250, 123)">Disable-AzContextAutosave</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Scope </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">Process</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Connect to Azure with system-assigned managed identity (Azure Automation account, which has been given VM Start permissions)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$AzureContext</span><span class="token plain"> = </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token function" style="color:rgb(80, 250, 123)">Connect-AzAccount</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Identity</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">context</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">InputObject </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$AzureContext</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># set and store context</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$AzureContext</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Set-AzContext</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">SubscriptionName </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$AzureContext</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Subscription </span><span class="token operator">-</span><span class="token plain">DefaultProfile </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$AzureContext</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">InputObject </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$AzureContext</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$vms</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzResource</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">TagName </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$TagName</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">TagValue </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$TagValue</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Where-Object</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">FilterScript </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ResourceType </span><span class="token operator">-like</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Microsoft.Compute/virtualMachines&#x27;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">Foreach</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$vm</span><span class="token plain"> in </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$vms</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$Shutdown</span><span class="token plain"> </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token boolean">$true</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">InputObject </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Stopping </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$vm</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Name</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;</span><span class="token plain">        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token function" style="color:rgb(80, 250, 123)">Stop-AzVM</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$vm</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Name </span><span class="token operator">-</span><span class="token plain">ResourceGroupName </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$vm</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ResourceGroupName </span><span class="token operator">-</span><span class="token plain">Force</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">InputObject </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Starting </span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$vm</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string function" style="color:rgb(80, 250, 123)">Name</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;</span><span class="token plain">        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token function" style="color:rgb(80, 250, 123)">Start-AzVM</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$vm</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Name </span><span class="token operator">-</span><span class="token plain">ResourceGroupName </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$vm</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ResourceGroupName</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="12">
<li><strong>Change</strong> the <strong>country code</strong> to align with your own country. You can use the IP <a href="https://app.abstractapi.com/api/ip-geolocation/tester" target="_blank" rel="noopener noreferrer" title="IP geolocation API">geolocation API</a> in Abstract API to do a live test, which will give you your country code. Feel free to amend the Write-Output messages to make sense for your environment.</li>
<li>Click <strong>Save</strong></li>
<li><img decoding="async" loading="lazy" alt="Azure Runbook - PowerShell" src="/assets/images/azurerunbook_publishedsource-f7e6de348d83dd7068cf302b98d22c49.png" title="Azure Runbook - PowerShell" width="784" height="690" class="img_ev3q"></li>
<li>Click <strong>Publish</strong> <em>(so the runbook is actually in production and can be used)</em></li>
<li>You can select View or Edit at any stage, but you have now imported the Azure Automation runbook!</li>
</ol>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="setup-variables">Setup Variables<a href="#setup-variables" class="hash-link" aria-label="Direct link to Setup Variables" title="Direct link to Setup Variables">​</a></h5>
<p>Now that the Azure runbook has been imported, we need to set up the variables, which include the API key.</p>
<ol>
<li>Log into the <a href="https://portal.azure.com/#home" target="_blank" rel="noopener noreferrer" title="Microsoft Azure Portal"><strong>Microsoft Azure Portal</strong></a>.</li>
<li>Navigate to your Azure <strong>Automation account</strong></li>
<li>Click <strong>Variables</strong></li>
<li>Click <strong>+ Add a variable</strong></li>
<li><strong>Create</strong> a Variable named: <strong>AbstractApiKey</strong> <em>(this needs to match the variable name as part of the &#x27;Get-AutomationVariable&#x27; cmdlet)</em>.</li>
<li>Enter in a <strong>description</strong></li>
<li>Select <strong>String</strong></li>
<li><strong>Enter</strong> in the <strong>API</strong> key you retrieved earlier from Abstract API.</li>
<li><img decoding="async" loading="lazy" alt="Azure Automation - Variables" src="/assets/images/azure-azautomate_variables-c2f7dc12053dd8a54d84af4715988f41.png" width="566" height="605" class="img_ev3q"></li>
<li>Click <strong>Save</strong></li>
</ol>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="setup-schedule">Setup Schedule<a href="#setup-schedule" class="hash-link" aria-label="Direct link to Setup Schedule" title="Direct link to Setup Schedule">​</a></h5>
<p>Now that the variables have been set up, we need to set up the schedule. This is the schedule that will be used to start the Virtual Machine. In the example below we are going to use a Standard Monday -&gt; Friday work week, but adjust the time and date for when you need to start the virtual machine up.</p>
<ol>
<li>Log into the <a href="https://portal.azure.com/#home" target="_blank" rel="noopener noreferrer" title="Microsoft Azure Portal"><strong>Microsoft Azure Portal</strong></a>.</li>
<li>Navigate to your Azure <strong>Automation account</strong></li>
<li>Click <strong>Schedule</strong></li>
<li>Click <strong>+ Add a schedule</strong></li>
<li><strong>Type</strong> in a <strong>name</strong> for the <strong>schedule</strong> <em>(ie Azure Virtual Machine - Start)</em>.</li>
<li>Type in a <strong>Description</strong></li>
<li><strong>Select</strong> the <strong>Start Date</strong> to match when you want to start the Schedule <em>(ie first Monday of the week)</em>.</li>
<li><strong>Select</strong> your <strong>Timezone</strong>, so that the script runs on the right time/date which makes your timezone.</li>
<li>For Recurrance, specify: <strong>Recurring</strong></li>
<li>Set it to Recur every: <strong>1 Day</strong></li>
<li>Check <strong>Monday</strong>, <strong>Tuesday</strong>, <strong>Wednesday</strong>, <strong>Thursday</strong>, and <strong>Friday</strong></li>
<li>Leave Saturday and Sunday unchecked.</li>
<li>Click <strong>Create</strong></li>
<li>Now that the Schedule has been created, we need to bind it to a Runbook</li>
<li>On the Automation account blade, click on <strong>Runbooks</strong></li>
<li>Click on your &#x27;Start Azure Virtual Machine&#x27; runbook</li>
<li>Select <strong>Schedules</strong></li>
<li>Click <strong>Add a Schedule</strong></li>
<li>Press: <strong>Link a schedule to your runbook</strong></li>
<li>Select <strong>your</strong> newly created <strong>Schedule</strong></li>
<li>For the Tag Name, select <strong>Shutdown</strong></li>
<li>For the Tag Value name, Select <strong>Yes</strong></li>
<li>For Shutdown, select <strong>false</strong></li>
<li>Click <strong>Ok</strong></li>
<li>Your schedule has now been configured and the runbook will run the next time it matches your scheduled date and time.</li>
</ol>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="configure-tags">Configure Tags<a href="#configure-tags" class="hash-link" aria-label="Direct link to Configure Tags" title="Direct link to Configure Tags">​</a></h5>
<p>The runbook is written, so it doesn&#x27;t need to be adjusted for future machines and making changes on the fly, this relies on each Virtual Machine that you want started to be started using the Runbook to be tagged.</p>
<ol>
<li>Log into the <a href="https://portal.azure.com/#home" target="_blank" rel="noopener noreferrer" title="Microsoft Azure Portal"><strong>Microsoft Azure Portal</strong></a>.</li>
<li>Navigate to your Azure <strong>Virtual Machine</strong></li>
<li>Click <strong>Tags</strong></li>
<li><strong>Add the following tag</strong>:</li>
</ol>













<table><thead><tr><th>Tag Key</th><th>Tag Value</th></tr></thead><tbody><tr><td>Shutdown</td><td>Yes</td></tr></tbody></table>
<p>Congratulations, the next time your schedule triggers, every runbook with the Shutdown tag will be started, according to your schedule, and workday. If it&#x27;s a Public Holiday or a Weekend, the Virtual Machine will remain off - saving cost.</p></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/azure/">Azure</a></li></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/azure/you-don-t-have-authorization-to-perform-action-microsoft.resources-deployments-validate-action/"><div class="pagination-nav__sublabel">Newer post</div><div class="pagination-nav__label">You don’t have authorization to perform action &#x27;Microsoft.Resources/deployments/validate/action&#x27;</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/azure/microsoft-azure-naming-conventions/"><div class="pagination-nav__sublabel">Older post</div><div class="pagination-nav__label">Microsoft Azure Naming Conventions</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#deploy-start-vm-solution" class="table-of-contents__link toc-highlight">Deploy Start VM Solution</a><ul><li><a href="#setup-azure-automation-account" class="table-of-contents__link toc-highlight">Setup Azure Automation Account</a><ul><li><a href="#create-azure-automation-account" class="table-of-contents__link toc-highlight">Create Azure Automation Account</a></li><li><a href="#configure-system-identity" class="table-of-contents__link toc-highlight">Configure System Identity</a></li><li><a href="#setup-abstract-api-key" class="table-of-contents__link toc-highlight">Setup Abstract API Key</a></li><li><a href="#import-runbook" class="table-of-contents__link toc-highlight">Import Runbook</a></li><li><a href="#setup-variables" class="table-of-contents__link toc-highlight">Setup Variables</a></li><li><a href="#setup-schedule" class="table-of-contents__link toc-highlight">Setup Schedule</a></li><li><a href="#configure-tags" class="table-of-contents__link toc-highlight">Configure Tags</a></li></ul></li></ul></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 luke.geek.nz. Powered by coffee, clouds and hamsters on wheels!</div></div></div></footer></div>
</body>
</html>