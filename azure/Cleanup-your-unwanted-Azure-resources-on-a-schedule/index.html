<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.1">
<title data-rh="true">Cleanup your unwanted Azure resources on a schedule | luke.geek.nz</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://luke.geek.nz/img/social-card.png"><meta data-rh="true" name="twitter:image" content="https://luke.geek.nz/img/social-card.png"><meta data-rh="true" property="og:url" content="https://luke.geek.nz/azure/Cleanup-your-unwanted-Azure-resources-on-a-schedule/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Cleanup your unwanted Azure resources on a schedule | luke.geek.nz"><meta data-rh="true" name="description" content="Cleanup your unwanted Azure resources on a schedule"><meta data-rh="true" property="og:description" content="Cleanup your unwanted Azure resources on a schedule"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2023-06-06T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://luke.geek.nz"><meta data-rh="true" property="article:tag" content="Azure"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://luke.geek.nz/azure/Cleanup-your-unwanted-Azure-resources-on-a-schedule/"><link data-rh="true" rel="alternate" href="https://luke.geek.nz/azure/Cleanup-your-unwanted-Azure-resources-on-a-schedule/" hreflang="en"><link data-rh="true" rel="alternate" href="https://luke.geek.nz/azure/Cleanup-your-unwanted-Azure-resources-on-a-schedule/" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://ZBH2T1WJQD-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="luke.geek.nz RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="luke.geek.nz Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="luke.geek.nz JSON Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0QDLBY7NNN"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-0QDLBY7NNN",{anonymize_ip:!0})</script><link rel="stylesheet" href="/assets/css/styles.59c32649.css">
<script src="/assets/js/runtime~main.aa799c28.js" defer="defer"></script>
<script src="/assets/js/main.fd293aef.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"dark")}(),function(){try{const a=new URLSearchParams(window.location.search).entries();for(var[t,e]of a)if(t.startsWith("docusaurus-data-")){var n=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(n,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:#D3D3D3" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY">Happy New Year! This is a redesign of my website, hopefully you like it!</div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="luke.geek.nz" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.png" alt="luke.geek.nz" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">luke.geek.nz</b></a><a class="navbar__item navbar__link" href="/Tags/">Tags</a><a class="navbar__item navbar__link" href="/Archive/">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://www.youtube.com/channel/UCUG3TKDTAZz4UXshGrjBBoQ" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-icon" aria-label="YouTube">
              <svg width="24" height="24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path d="M23.498,6.186c-0.273-1.186-1.143-2.144-2.332-2.417C18.389,3.153,12,3.153,12,3.153s-6.389,0-9.166,0.616
                  c-1.19,0.273-2.06,1.23-2.332,2.417C0,8.07,0,12,0,12s0,3.93,0.502,5.814c0.272,1.187,1.142,2.062,2.332,2.335
                  C5.611,20.847,12,20.847,12,20.847s6.389,0,9.166-0.698c1.189-0.273,2.059-1.148,2.332-2.335C24,15.93,24,12,24,12
                  S24,8.07,23.498,6.186z M9.545,15.568V8.432l6.545,3.568L9.545,15.568z"/>
              </svg>
            </a><a href="https://aus.social/@lukemurray" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-icon" aria-label="Mastodon">
              <svg height="20" width="20" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" xml:space="preserve">
                <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                <g id="SVGRepo_iconCarrier">
                  <path d="M21.327 8.566c0-4.339-2.843-5.61-2.843-5.61-1.433-.658-3.894-.935-6.451-.956h-.063c-2.557.021-5.016.298-6.45.956 0 0-2.843 1.272-2.843 5.61 0 .993-.019 2.181.012 3.441.103 4.243.778 8.425 4.701 9.463 1.809.479 3.362.579 4.612.510 2.268-.126 3.541-.809 3.541-.809l-.075-1.646s-1.621.511-3.441.449c-1.804-.062-3.707-.194-3.999-2.409a4.523 4.523 0 0 1-.04-.621s1.77.433 4.014.536c1.372.063 2.658-.08 3.965-.236 2.506-.299 4.688-1.843 4.962-3.254.434-2.223.398-5.424.398-5.424zm-3.353 5.59h-2.081V9.057c0-1.075-.452-1.62-1.357-1.62-1 0-1.501.647-1.501 1.927v2.791h-2.069V9.364c0-1.28-.501-1.927-1.502-1.927-.905 0-1.357.546-1.357 1.62v5.099H6.026V8.903c0-1.074.273-1.927.823-2.558.566-.631 1.307-.955 2.228-.955 1.065 0 1.872.409 2.405 1.228l.518.869.519-.869c.533-.819 1.34-1.228 2.405-1.228.92 0 1.662.324 2.228.955.549.631.822 1.484.822 2.558v5.253z"></path>
                </g>
              </svg>
            </a><a href="https://bsky.app/profile/lukemurraynz.bsky.social" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-icon" aria-label="Bluesky">
              <svg class="octicon" xmlns="http://www.w3.org/2000/svg" role="img" viewBox="0 0 16 16" height="20" width="20" fill="currentColor">
                <title>Bluesky</title>
                <path d="M8 7.2c-.72-1.4-2.7-4.04-4.53-5.33C1.7.63 1.04.84.6 1.04.1 1.27 0 2.05 0 2.51c0 .46.25 3.77.42 4.32.54 1.82 2.47 2.45 4.25 2.25-2.6.38-4.92 1.33-1.88 4.71 3.33 3.46 4.57-.74 5.21-2.87.64 2.13 1.37 6.18 5.16 2.87 2.84-2.87.78-4.33-1.83-4.71 1.78.2 3.71-.43 4.25-2.25.17-.55.42-3.86.42-4.32 0-.46-.09-1.24-.6-1.47-.44-.2-1.11-.42-2.87.83A17.87 17.87 0 0 0 8 7.2Z"></path>
              </svg>
            </a><a href="https://twitter.com/lukemurraynz" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-icon" aria-label="X"><svg height="20" width="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 8.586l4.293-4.293a1 1 0 011.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 011.414-1.414L10 8.586z" clip-rule="evenodd"/>
          </svg></a><a href="https://www.linkedin.com/in/ljmurray/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-icon" aria-label="LinkedIn"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" height="20" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854V1.146zm4.943 12.248V6.169H2.542v7.225h2.401zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248-.822 0-1.359.54-1.359 1.248 0 .694.521 1.248 1.327 1.248h.016zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274 0-1.845.7-2.165 1.193v.025h-.016a5.54 5.54 0 0 1 .016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225h2.4z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure/azure-naming-tool-api-bicep-resources/">Using the Azure Naming Tool API to name your Bicep resources</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure/existing-resource-deploymentstack/">Add existing Azure resource to a Deployment Stack</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure/service-namespace-invalid-eventhub/">The specified service namespace is invalid EventHub</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure/azure-email-communication-services/">Deploying and Testing Azure Email Communication Services</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure/microsoft-copilot-azure-preview/">Microsoft Copilot for Azure - Preview</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="https://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="Cleanup your unwanted Azure resources on a schedule"><header><h1 class="title_f1Hy" itemprop="headline">Cleanup your unwanted Azure resources on a schedule</h1><div class="container_mt6G margin-vert--md"><time datetime="2023-06-06T00:00:00.000Z" itemprop="datePublished">June 6, 2023</time> · <!-- -->12 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://luke.geek.nz/img/logo.png" alt="Luke Murray" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Luke Murray</span></a></div><small class="avatar__subtitle" itemprop="description">Author</small></div></div></div></div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><p>Cleanup your unwanted Azure resources on a schedule</p>
<p>Every few months, I get that dreaded email &quot;Your Microsoft Azure subscription has been suspended&quot; - this is due to creating resources, and leaving them provisioned, so I needed a method of deleting the resources I didn&#x27;t need, or wanted to spin up for a few days. I also needed away to creating resources that can stay, either for learning or a demo, independent of how the resources were deployed into the environment <em>(via the Azure Portal, Terraform, Bicep)</em>.</p>
<p>Naturally I went straight to <a href="https://learn.microsoft.com/azure/automation/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Azure Automation documentation">Azure Automation</a> and using PowerShell.</p>
<p>What I ended up with was a Runbook capable of <strong>EXTREME AZURE DESTRUCTION</strong> which was exactly what I wanted.</p>
<blockquote>
<p>This script is provided as-is with no warranties or guarantees. Use at your own risk. This is not intended to be a script to use in Production, mainly test environments, as this WILL CAUSE massive destruction and irretrievable data loss... You have been warned.</p>
</blockquote>
<p>I am not going to go into setting up Azure Automation, if interested you can refer to a few of my blog posts I have done previously that goes through the process:</p>
<ul>
<li><a href="https://luke.geek.nz/azure/deallocate-stopped-virtual-machines-using-azure-automation/" target="_blank" rel="noopener noreferrer" title="Deallocate ‘Stopped’ Virtual Machines using Azure Automation">Deallocate ‘Stopped’ Virtual Machines using Azure Automation</a></li>
<li><a href="https://luke.geek.nz/azure/turn-on-a-azure-virtual-machine-using-azure-automation/" target="_blank" rel="noopener noreferrer" title="Turn on a Azure Virtual Machine using Azure Automation">Turn on a Azure Virtual Machine using Azure Automation</a></li>
<li><a href="https://luke.geek.nz/azure/disable-sftp-support-on-an-azure-storage-account-on-a-schedule/" target="_blank" rel="noopener noreferrer" title="Disable SFTP support on an Azure Storage account on a Schedule">Disable SFTP support on an Azure Storage account on a Schedule</a></li>
</ul>
<p>The script named: Invoke-DakaraSuperWeapon, aptly named as a reference to the Dakara weapon from the TV series Stargate SG1 - a weapon if great power.</p>
<blockquote>
<p>The <a href="https://stargate.fandom.com/wiki/Dakara_superweapon" target="_blank" rel="noopener noreferrer">Dakara superweapon</a> was a Ancient device capable of reducing all matter to its basic elemental components, and/or restructuring it. Possessing the ability to pass through the shields of known ships it also functions (and has been used) as a devastating weapon to kill the entire crew of orbiting ships or wipe out all life on the surface of hundreds of planets at a time. &quot;It is not only capable of destroying the Replicators but all life in the galaxy.&quot;</p>
</blockquote>
<p><img loading="lazy" alt="Azure Dakara superweapon" src="/assets/images/CleanupyourUnwantedAzureResourcesonaSchedule-12c7b44ba5ec86e0b52839f1e1857ac2.png" title="Azure Dakara superweapon" width="1200" height="628" class="img_ev3q"></p>
<p>Using the latest Windows PowerShell release - 7.2 (Preview), this script is built around the following capabilities:</p>
<ul>
<li><strong>Delete ALL resource groups</strong> (without a specific Tag) <strong>under all subscriptions</strong>, under a specific <strong>Management Group</strong></li>
<li><strong>Delete all resources</strong> within those resource groups</li>
<li><strong>Delete</strong> Azure <strong>Recovery Vaults</strong> and their backed up items</li>
<li><strong>Delete</strong> any <strong>Azure policy assignments</strong>, assigned directly to any subscription under the Management Group</li>
<li><strong>Delete</strong> any Azure <strong>RBAC role assignments</strong>, assigned directly to any subscription under the Management Group.</li>
</ul>
<p>In my demo environment, I have a range of Management Groups, and 2 Azure subscriptions.</p>
<p><img loading="lazy" alt="Luke&amp;#39;s Azure Management Group structure" src="/assets/images/VisualStudio_Luke_MG_Structure-40dc226f63445dd3e2d69fded3754f0b.png" title="Luke&amp;#39;s Azure Management Group structure" width="837" height="932" class="img_ev3q">`</p>
<p>For my purposes, I created a <a href="https://learn.microsoft.com/azure/automation/enable-managed-identity-for-automation?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="Using a system-assigned managed identity for an Azure Automation account">System Managed Identity</a> from the Azure Automation account, and applied it to the: &#x27;mg&#x27; Management Group as &#x27;Owner&#x27; (Contributor will work, as long as you don&#x27;t plan on removing the rights from the Azure subscriptions - theoretically, so could Contributor + User Access Administrator roles).</p>
<p>Again - this was created for my own environment - if you decide to run this, TEST IT! And Make sure it has as limited permissions as possible, potentially the Managed Identity will only have access to a specific test Subscription that you may not care about. I take no responsibily.</p>
<p>The System Identity will be used to execute the runbook.</p>
<p>I also needed a Tag <em>(ie a Safe word)</em> to save the Resource Groups that I need to remain, an example is a project I am working on, demo etc. This Tag is in name only - as Tags are Key/Value pairs in Azure - in this case I only cared about the Key (ie NotDelete) - what was in the value, didn&#x27;t matter.</p>
<p><img loading="lazy" alt="NotDelete - Azure Tag" src="/assets/images/Initiate-DakaraSuperWeapon_SafeWord-92859365cce18c815d763468ba530288.png" title="NotDelete - Azure Tag" width="1311" height="323" class="img_ev3q"></p>
<p>Important: When importing the Runbook it is imperative that you Tag the Resource Group it is in, with your safe word! Or else could will be deleted!</p>
<p>The script has a couple of parameters:</p>



































<table><thead><tr><th>Parameter</th><th>Type</th><th>Notes</th></tr></thead><tbody><tr><td>ManagementGroupId</td><td>String</td><td>The ID of the management group to delete resource groups under. WARNING: This script will delete all resource groups under the specified management group except for the ones with the specified tag. Make sure you have specified the correct management group ID, or you may accidentally delete resources that you did not intend to delete.</td></tr><tr><td>TagName</td><td>String</td><td>The name of the tag to check for. WARNING: This script will delete all resource groups that do not have this tag. Make sure you have specified the correct tag name, or you may accidentally delete resources that you did not intend to delete.</td></tr><tr><td>RemoveResourceGroups</td><td>Boolean</td><td>True or False, do you want to Remove the Resource Groups? True means it will, and False means it will skip the Resource Group deletion.</td></tr><tr><td>DeletePolicyAssignments</td><td>Boolean</td><td>True or False, do you want to Remove the Azure Policy assignments on the subscriptions? True means it will, and False means it will skip the Azure Policy assignment deletion.</td></tr><tr><td>DeleteSubRoleAssignments</td><td>Boolean</td><td>This will need Owner rights (or User Administrator role) in order to remove roles from a Subscription. Make sure your rights are set to be inherited from a Management Group, before running this. True or False, True means it will delete the Subscription direct assignments, False means it will skip it.</td></tr></tbody></table>
<p>As you can tell, you can enable or disable specific parts of the script, for example - if you just want to use it to clean up direct role assignments on your subscriptions, while not deleting Azure resources you can by entering True or False.</p>
<p><img loading="lazy" alt="Initiate-DakaraSuperWeapon - Azure Runbook Parameters" src="/assets/images/Initiate-DakaraSuperWeapon_Parameters-8252d698d141f7eca306f1cb0f5d66cf.png" title="Initiate-DakaraSuperWeapon - Azure Runbook Parameters" width="1655" height="850" class="img_ev3q"></p>
<p>When ran it will stream the Logs to the Azure Automation Log Stream, there is no waiting time or approval - it will just run.</p>
<p><img loading="lazy" alt="Initiate-DakaraSuperWeapon - Azure Automation Log Stream" src="/assets/images/Initiate-DakaraSuperWeapon_Delete-48239d0a516933a4176e00ab9890b332.png" title="Initiate-DakaraSuperWeapon - Azure Automation Log Stream" width="933" height="912" class="img_ev3q"></p>
<p>As below, you can see the Resource Groups get removed (at the time of this recording, I had a limit on the amount of <a href="https://devblogs.microsoft.com/powershell/powershell-foreach-object-parallel-feature/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer" title="PowerShell ForEach-Object Parallel Feature">parallel</a> delete tasks:</p>
<p><img loading="lazy" alt="Remove Azure Resoure Groups" src="/assets/images/Remove_AzResource-4a5dfc5be3e3278355fa4b961d132457.gif" title="Remove Azure Resoure Groups" width="1343" height="836" class="img_ev3q"></p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">Initiate-DakaraSuperWeapon.ps1</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># This runbook deletes all resource groups under a management group except for the ones with a specific tag.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">&lt;#</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">.SYNOPSIS</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">Deletes all resource groups under a management group except for the ones with a specific tag.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">.DESCRIPTION</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">This script deletes all resource groups under a specified management group except for the ones with a specific tag. It can also delete policy assignments and subscription role assignments if specified.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">.PARAMETER ManagementGroupId</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">The ID of the management group to delete resource groups under. WARNING: This script will delete all resource groups under the specified management group except for the ones with the specified tag. Make sure you have specified the correct management group ID, or you may accidentally delete resources that you did not intend to delete.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">.PARAMETER TagName</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">The name of the tag to check for. WARNING: This script will delete all resource groups that do not have this tag. Make sure you have specified the correct tag name, or you may accidentally delete resources that you did not intend to delete.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">.PARAMETER RemoveResourceGroups</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">If specified, deletes the resource groups that do not have the specified tag.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">.PARAMETER DeletePolicyAssignments</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">If specified, deletes the policy assignments for the management group and all child subscriptions.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">.PARAMETER DeleteSubRoleAssignments</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">If specified, deletes the subscription role assignments for all child subscriptions.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">.EXAMPLE</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">.\Initiate-DakaraSuperWeapon.ps1 -ManagementGroupId &quot;my-management-group&quot; -TagName &quot;my-tag&quot; -RemoveResourceGroups -DeletePolicyAssignments -DeleteSubRoleAssignments</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">Deletes all resource groups under the &quot;my-management-group&quot; management group that do not have the &quot;my-tag&quot; tag, and deletes the policy assignments and subscription role assignments for all child subscriptions.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">.NOTES</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">This script requires the Azure PowerShell module to be installed. It also requires Owner rights (or User Administrator role) in order to remove roles from a subscription. Make sure your rights are set to be inherited from a management group before running this script.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">#&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">Parameter</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">Mandatory = </span><span class="token boolean">$true</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> HelpMessage = </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;The ID of the management group to delete resource groups under. WARNING: This script will delete all resource groups under the specified management group except for the ones with the specified tag. Make sure you have specified the correct management group ID, or you may accidentally delete resources that you did not intend to delete.&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token namespace">[string]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ManagementGroupId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">Parameter</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">Mandatory = </span><span class="token boolean">$true</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> HelpMessage = </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;The name of the tag to check for. WARNING: This script will delete all resource groups that do not have this tag. Make sure you have specified the correct tag name, or you may accidentally delete resources that you did not intend to delete.&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token namespace">[string]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$TagName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token namespace">[Parameter(Mandatory = $false)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token namespace">[switch]</span><span class="token namespace">[bool]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$RemoveResourceGroups</span><span class="token plain"> = </span><span class="token boolean">$false</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token namespace">[Parameter(Mandatory = $false)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token namespace">[switch]</span><span class="token namespace">[bool]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$DeletePolicyAssignments</span><span class="token plain"> = </span><span class="token boolean">$false</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">Parameter</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">Mandatory = </span><span class="token boolean">$false</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> HelpMessage = </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;This will need Owner rights (or User Administrator role) in order to remove roles from a Subscription. Make sure your rights are set to be inherited from an Management Group, before running this.&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token namespace">[switch]</span><span class="token namespace">[bool]</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$DeleteSubRoleAssignments</span><span class="token plain"> = </span><span class="token boolean">$false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Convert string values to boolean values</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$RemoveResourceGroups</span><span class="token plain"> = </span><span class="token namespace">[System.Boolean]</span><span class="token plain">::Parse</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$RemoveResourceGroups</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$DeletePolicyAssignments</span><span class="token plain"> = </span><span class="token namespace">[System.Boolean]</span><span class="token plain">::Parse</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$DeletePolicyAssignments</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$DeleteSubRoleAssignments</span><span class="token plain"> = </span><span class="token namespace">[System.Boolean]</span><span class="token plain">::Parse</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$DeleteSubRoleAssignments</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Ensures you do not inherit an AzContext in your runbook</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Disable-AzContextAutosave</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Scope </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">Process</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">#Toggle to stop warnings with regards to Breaking Changes in Azure PowerShell</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Set-Item</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Path Env:\SuppressAzurePowerShellBreakingChangeWarnings </span><span class="token operator">-</span><span class="token plain">Value </span><span class="token boolean">$true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Connect to Azure with system-assigned managed identity</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token function" style="color:rgb(80, 250, 123)">Connect-AzAccount</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Identity</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">context</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Write an initial log message</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Initilizing superweapon....&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Get the subscription IDs under the specified management group AND child management groups</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzSubscriptionsFromManagementGroup</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ManagementGroupName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$mg</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzManagementGroup</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">GroupId </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ManagementGroupName</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Expand</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">foreach</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$child</span><span class="token plain"> in </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$mg</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Children</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$child</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Type</span><span class="token plain"> </span><span class="token operator">-match</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;/managementGroups$&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzSubscriptionsFromManagementGroup</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ManagementGroupName </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$child</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$child</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Select-Object</span><span class="token plain"> @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">N = </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Name&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> E = </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">DisplayName </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> @</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">N = </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Id&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> E = </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Name </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$mgid</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzManagementGroup</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">GroupId </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ManagementGroupID</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Expand</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$subIds</span><span class="token plain"> = </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzSubscriptionsFromManagementGroup</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ManagementGroupName </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$mgid</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">DisplayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">id</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Delete the policy assignments</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$DeletePolicyAssignments</span><span class="token plain"> </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token boolean">$true</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Deleting management group policy assignments...&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzPolicyAssignment</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Scope </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$mgid</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Id </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Remove-AzPolicyAssignment</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Verbose</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Deleting subscription group policy assignments...&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">foreach</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$subId</span><span class="token plain"> in </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$subIds</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Setting subscription context...&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Set-AzContext</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Subscription </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$subId</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Deleting subscription group policy assignments...&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzPolicyAssignment</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Scope </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;/subscriptions/</span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$subId</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Remove-AzPolicyAssignment</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Verbose</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Skipping policy assignment deletion...&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Delete the resource groups</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$RemoveResourceGroups</span><span class="token plain"> </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token boolean">$true</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Deleting resource groups...&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$null</span><span class="token plain"> </span><span class="token operator">-ne</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$subIds</span><span class="token plain"> </span><span class="token operator">-and</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$subIds</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Count </span><span class="token operator">-gt</span><span class="token plain"> 0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">foreach</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$subId</span><span class="token plain"> in </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$subIds</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Setting subscription context...&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Set-AzContext</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Subscription </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$subId</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceGroupsfordeletion</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzResourceGroup</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Where-Object</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Tags </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$null</span><span class="token plain"> </span><span class="token operator">-or</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Tags</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ContainsKey</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$tagName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token boolean">$false</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;The following Resource Groups will be deleted...&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">InputObject </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceGroupsfordeletion</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token comment" style="color:rgb(98, 114, 164)">## Checks to see if a Recovery Services Vaults exists, the Recovery Services Vault and backups need to be deleted first.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$RSV</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzRecoveryServicesVault</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Where-Object</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ResourceGroupName </span><span class="token operator">-in</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceGroupsfordeletion</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ResourceGroupName </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$null</span><span class="token plain"> </span><span class="token operator">-ne</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$RSV</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">ForEach</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$RV</span><span class="token plain"> in </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$RSV</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain">  </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Backup Vault deletion supports deletion of Azure VM backup vaults ONLY currently.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token comment" style="color:rgb(98, 114, 164)">#Credit to Wim Matthyssen for reference in the backup section of the script - https://wmatthyssen.com/2020/11/17/azure-backup-remove-a-recovery-services-vault-and-all-cloud-backup-items-with-azure-powershell/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token function" style="color:rgb(80, 250, 123)">Set-AzRecoveryServicesVaultProperty</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Vault </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$RV</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ID </span><span class="token operator">-</span><span class="token plain">SoftDeleteFeatureState Disable</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token function" style="color:rgb(80, 250, 123)">Set-AzRecoveryServicesVaultContext</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Vault </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$RV</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$containerSoftDelete</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzRecoveryServicesBackupItem</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">BackupManagementType AzureVM </span><span class="token operator">-</span><span class="token plain">WorkloadType AzureVM </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Where-Object</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">DeleteState </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;ToBeDeleted&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">foreach</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$item</span><span class="token plain"> in </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$containerSoftDelete</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        </span><span class="token function" style="color:rgb(80, 250, 123)">Undo-AzRecoveryServicesBackupItemDeletion</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Item </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$item</span><span class="token plain">  </span><span class="token operator">-</span><span class="token plain">Force </span><span class="token operator">-</span><span class="token plain">Verbose</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$containerBackup</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzRecoveryServicesBackupItem</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">BackupManagementType AzureVM </span><span class="token operator">-</span><span class="token plain">WorkloadType AzureVM  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Where-Object</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">DeleteState </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;NotDeleted&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">foreach</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$item</span><span class="token plain"> in </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$containerBackup</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        </span><span class="token function" style="color:rgb(80, 250, 123)">Disable-AzRecoveryServicesBackupProtection</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Item </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$item</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">RemoveRecoveryPoints </span><span class="token operator">-</span><span class="token plain">Force </span><span class="token operator">-</span><span class="token plain">Verbose</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token function" style="color:rgb(80, 250, 123)">Remove-AzRecoveryServicesVault</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Vault </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$RV</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Verbose</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token comment" style="color:rgb(98, 114, 164)">## Checks to see if a Azure Resource Mover resource exists, as this need to be deleted first.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ARM</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzResource</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Where-Object</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ResourceGroupName </span><span class="token operator">-in</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceGroupsfordeletion</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ResourceGroupName </span><span class="token operator">-and</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ResourceType </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Microsoft.Migrate/moveCollections&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">InputObject </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ARM</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$null</span><span class="token plain"> </span><span class="token operator">-ne</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ARM</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">ForEach</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$RM</span><span class="token plain"> in </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ARM</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain">  </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Azure Resource Mover collections exists.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">InputObject </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$RM</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$a</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzResourceMoverMoveResource</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ResourceGroupName </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$RM</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ResourceGroupName </span><span class="token operator">-</span><span class="token plain">MoveCollectionName </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$RM</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">Foreach</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$b</span><span class="token plain"> in </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$a</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">InputObject </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$b</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Remove a resource using the resource ID</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        </span><span class="token function" style="color:rgb(80, 250, 123)">Invoke-AzResourceMoverDiscard</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ResourceGroupName </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$RM</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ResourceGroupName </span><span class="token operator">-</span><span class="token plain">MoveResourceInputType </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$b</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Id </span><span class="token operator">-</span><span class="token plain">MoveResource </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$b</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        </span><span class="token function" style="color:rgb(80, 250, 123)">Remove-AzResourceMoverMoveResource</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ResourceGroupName </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$RM</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ResourceGroupName </span><span class="token operator">-</span><span class="token plain">MoveCollectionName </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$RM</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Name </span><span class="token operator">-</span><span class="token plain">Name </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$b</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Name </span><span class="token operator">-</span><span class="token plain">Verbose</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token function" style="color:rgb(80, 250, 123)">Remove-AzResourceMoverMoveCollection</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ResourceGroupName </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$RM</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ResourceGroupName </span><span class="token operator">-</span><span class="token plain">MoveCollectionName </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$RM</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Deleting resource groups...&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$ResourceGroupsfordeletion</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">ForEach-Object</span><span class="token plain"> </span><span class="token operator">-</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">Parallel</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token function" style="color:rgb(80, 250, 123)">Remove-AzResourceGroup</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ResourceGroupName </span><span class="token operator">-</span><span class="token plain">Force</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">ThrottleLimit 20 </span><span class="token operator">-</span><span class="token plain">Verbose</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token comment" style="color:rgb(98, 114, 164)"># Remove the Network Watcher resource group - if remaining - in some scenarios the script left this RG behind.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token comment" style="color:rgb(98, 114, 164)"># Get the resource group with the specified tag</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$networkWatcherRG</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzResourceGroup</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Where-Object</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ResourceGroupName </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;NetworkWatcherRG&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$null</span><span class="token plain"> </span><span class="token operator">-ne</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$networkWatcherRG</span><span class="token plain"> </span><span class="token operator">-and</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$null</span><span class="token plain"> </span><span class="token operator">-ne</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$networkWatcherRG</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Tags </span><span class="token operator">-and</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$networkWatcherRG</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Tags</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ContainsKey</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$tagName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token boolean">$false</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token function" style="color:rgb(80, 250, 123)">Remove-AzResourceGroup</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Name </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$networkWatcherRG</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ResourceGroupName </span><span class="token operator">-</span><span class="token plain">Force </span><span class="token operator">-</span><span class="token plain">ErrorAction </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">Continue</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Verbose</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">     </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Write a final log message</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Resource group deletion process completed.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;No child subscriptions found under the specified management group.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Skipping resource group deletion...&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$DeleteSubRoleAssignments</span><span class="token plain"> </span><span class="token operator">-eq</span><span class="token plain"> </span><span class="token boolean">$true</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$null</span><span class="token plain"> </span><span class="token operator">-ne</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$subIds</span><span class="token plain"> </span><span class="token operator">-and</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$subIds</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Count </span><span class="token operator">-gt</span><span class="token plain"> 0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">foreach</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$subId</span><span class="token plain"> in </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$subIds</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Setting subscription context...&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Set-AzContext</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Subscription </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$subId</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$roleAssignments</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Get-AzRoleAssignment</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Scope </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;/subscriptions/</span><span class="token string function" style="color:rgb(80, 250, 123)">$</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string function variable" style="color:rgb(189, 147, 249);font-style:italic">$subId</span><span class="token string function punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">IncludeClassicAdministrators</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">InputObject </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$roleAssignments</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token comment" style="color:rgb(98, 114, 164)"># Loop through each role assignment and delete it if it is not inherited a management group</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">foreach</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$roleAssignment</span><span class="token plain"> in </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$roleAssignments</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$roleAssignment</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Scope </span><span class="token operator">-like</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;/subscriptions/*&quot;</span><span class="token plain"> </span><span class="token operator">-and</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$null</span><span class="token plain"> </span><span class="token operator">-ne</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$roleAssignment</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ObjectId </span><span class="token operator">-and</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$roleAssignment</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ObjectId </span><span class="token operator">-ne</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Deleting role assignment...&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token function" style="color:rgb(80, 250, 123)">Remove-AzRoleAssignment</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Scope </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$roleAssignment</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Scope </span><span class="token operator">-</span><span class="token plain">ObjectId </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$roleAssignment</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ObjectId </span><span class="token operator">-</span><span class="token plain">RoleDefinitionName </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$roleAssignment</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">RoleDefinitionName </span><span class="token operator">-</span><span class="token plain">Verbose </span><span class="token operator">-</span><span class="token plain">ErrorAction </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">Continue</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Deleting subscription role assignments...&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Skipping policy subscription role assignments deletion...&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Using the Azure Automation schedule, I can then set this Runbook to run every Day, Week etc - knowing my environment will be fresh for my next project, learning exercise.</p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/azure/">Azure</a></li></ul></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/azure/Management-Groups-not-displaying-AzurePortal/"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Azure Management Groups not displaying in the Azure Portal</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/azure/Bytes-Blocks-and-Elasticity-Getting-Started-with-Azure-Elastic-SAN/"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Getting Started with Azure Elastic SAN</div></a></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 luke.geek.nz. Powered by coffee, clouds and hamsters on wheels!</div></div></div></footer></div>
</body>
</html>