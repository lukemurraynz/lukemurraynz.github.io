<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Implementing AI Gateway capabilities in API Management | luke.geek.nz</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://luke.geek.nz/img/social-card.png"><meta data-rh="true" name="twitter:image" content="https://luke.geek.nz/img/social-card.png"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" name="author" content="Luke Murray"><meta data-rh="true" property="og:url" content="https://luke.geek.nz/azure/implementing-ai-gateway-in-api-management"><meta data-rh="true" name="twitter:title" content="Implementing AI Gateway capabilities in API Management"><meta data-rh="true" name="twitter:description" content="Comprehensive guide on implementing an AI Gateway in API Management, covering key concepts, benefits, and implementation details."><meta data-rh="true" property="og:title" content="Implementing AI Gateway capabilities in API Management | luke.geek.nz"><meta data-rh="true" name="description" content="Comprehensive guide on implementing an AI Gateway in API Management, covering key concepts, benefits, and implementation details."><meta data-rh="true" property="og:description" content="Comprehensive guide on implementing an AI Gateway in API Management, covering key concepts, benefits, and implementation details."><meta data-rh="true" name="keywords" content="azure,apim,AzureOpenAI,AIGateway,API Management"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2024-08-14T06:40:06.774Z"><meta data-rh="true" property="article:author" content="https://luke.geek.nz"><meta data-rh="true" property="article:tag" content="Azure"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="alternate" href="https://luke.geek.nz/azure/implementing-ai-gateway-in-api-management/" hreflang="en"><link data-rh="true" rel="alternate" href="https://luke.geek.nz/azure/implementing-ai-gateway-in-api-management/" hreflang="x-default"><link data-rh="true" rel="canonical" href="https://luke.geek.nz/azure/implementing-ai-gateway-in-api-management"><link data-rh="true" rel="preconnect" href="https://ZBH2T1WJQD-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","headline":"Implementing AI Gateway capabilities in API Management","description":"Comprehensive guide on implementing an AI Gateway in API Management, covering key concepts, benefits, and implementation details.","url":"https://luke.geek.nz/azure/implementing-ai-gateway-in-api-management","datePublished":"2024-08-14T06:40:06.774Z","dateModified":"2024-08-14T06:40:06.774Z","author":{"@type":"Person","name":"Luke Murray","url":"https://luke.geek.nz/about"},"publisher":{"@type":"Organization","name":"luke.geek.nz","logo":{"@type":"ImageObject","url":"https://luke.geek.nz/img/logo.png"}},"mainEntityOfPage":{"@type":"WebPage","@id":"https://luke.geek.nz/azure/implementing-ai-gateway-in-api-management"},"keywords":"azure, apim, AzureOpenAI, AIGateway, API Management, Azure, Azure, Microsoft, Cloud Computing, Technical Blog","articleSection":"Technology","inLanguage":"en-US"}</script><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://luke.geek.nz/azure/implementing-ai-gateway-in-api-management","mainEntityOfPage":"https://luke.geek.nz/azure/implementing-ai-gateway-in-api-management","url":"https://luke.geek.nz/azure/implementing-ai-gateway-in-api-management","headline":"Implementing AI Gateway capabilities in API Management","name":"Implementing AI Gateway capabilities in API Management","description":"Comprehensive guide on implementing an AI Gateway in API Management, covering key concepts, benefits, and implementation details.","datePublished":"2024-08-14T06:40:06.774Z","author":{"@type":"Person","name":"Luke Murray","description":"Author","url":"https://luke.geek.nz","image":"https://luke.geek.nz/img/logo.png"},"keywords":["azure","apim","AzureOpenAI","AIGateway","API Management"],"isPartOf":{"@type":"Blog","@id":"https://luke.geek.nz/","name":"Luke's Tech Blog - Unleashing the power of the cloud and other technologies!"}}</script><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="luke.geek.nz RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="luke.geek.nz Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="luke.geek.nz JSON Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0QDLBY7NNN"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-0QDLBY7NNN",{anonymize_ip:!0})</script>






<meta property="og:type" content="website">
<meta property="og:site_name" content="luke.geek.nz">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@lukemurraynz">
<meta name="twitter:creator" content="@lukemurraynz">
<meta name="author" content="Luke Murray">
<meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1">
<script type="application/ld+json">{"@context":"https://schema.org","@type":"WebSite","name":"luke.geek.nz","description":"Microsoft MVP - Microsoft Azure ‚òÅ, Technical Consultant, Azure Solutions Architect Expert, Technologist and a drinker of coffee.","url":"https://luke.geek.nz","author":{"@type":"Person","name":"Luke Murray","url":"https://luke.geek.nz/about","sameAs":["https://twitter.com/lukemurraynz","https://www.linkedin.com/in/ljmurray/","https://aus.social/@lukemurray","https://bsky.app/profile/lukemurraynz.bsky.social"]},"publisher":{"@type":"Person","name":"Luke Murray"},"potentialAction":{"@type":"SearchAction","target":"https://luke.geek.nz/search?q={search_term_string}","query-input":"required name=search_term_string"}}</script><link rel="stylesheet" href="/assets/css/styles.dd27eb3d.css">
<script src="/assets/js/runtime~main.2087ad63.js" defer="defer"></script>
<script src="/assets/js/main.8184f009.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="dark";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="theme-announcement-bar announcementBar_mb4j" style="background-color:#D3D3D3" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY">If you haven't already, sign up for my Weekly Azure updates Newsletter, straight to your inbox! <a target="_blank" rel="noopener noreferrer" href="https://newsletter.azurefeeds.com/join">Subscribe now!</a></div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="luke.geek.nz" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.png" alt="luke.geek.nz" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">luke.geek.nz</b></a><a class="navbar__item navbar__link" href="/tags/">Tags</a><a class="navbar__item navbar__link" href="/archive/">Blog</a><a class="navbar__item navbar__link" href="/about/">About</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://www.youtube.com/channel/UCUG3TKDTAZz4UXshGrjBBoQ" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-icon" aria-label="YouTube">
              <svg width="24" height="24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path d="M23.498,6.186c-0.273-1.186-1.143-2.144-2.332-2.417C18.389,3.153,12,3.153,12,3.153s-6.389,0-9.166,0.616
                  c-1.19,0.273-2.06,1.23-2.332,2.417C0,8.07,0,12,0,12s0,3.93,0.502,5.814c0.272,1.187,1.142,2.062,2.332,2.335
                  C5.611,20.847,12,20.847,12,20.847s6.389,0,9.166-0.698c1.189-0.273,2.059-1.148,2.332-2.335C24,15.93,24,12,24,12
                  S24,8.07,23.498,6.186z M9.545,15.568V8.432l6.545,3.568L9.545,15.568z"/>
              </svg>
            </a><a href="https://aus.social/@lukemurray" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-icon" aria-label="Mastodon">
              <svg height="20" width="20" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" xml:space="preserve">
                <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                <g id="SVGRepo_iconCarrier">
                  <path d="M21.327 8.566c0-4.339-2.843-5.61-2.843-5.61-1.433-.658-3.894-.935-6.451-.956h-.063c-2.557.021-5.016.298-6.45.956 0 0-2.843 1.272-2.843 5.61 0 .993-.019 2.181.012 3.441.103 4.243.778 8.425 4.701 9.463 1.809.479 3.362.579 4.612.510 2.268-.126 3.541-.809 3.541-.809l-.075-1.646s-1.621.511-3.441.449c-1.804-.062-3.707-.194-3.999-2.409a4.523 4.523 0 0 1-.04-.621s1.77.433 4.014.536c1.372.063 2.658-.08 3.965-.236 2.506-.299 4.688-1.843 4.962-3.254.434-2.223.398-5.424.398-5.424zm-3.353 5.59h-2.081V9.057c0-1.075-.452-1.62-1.357-1.62-1 0-1.501.647-1.501 1.927v2.791h-2.069V9.364c0-1.28-.501-1.927-1.502-1.927-.905 0-1.357.546-1.357 1.62v5.099H6.026V8.903c0-1.074.273-1.927.823-2.558.566-.631 1.307-.955 2.228-.955 1.065 0 1.872.409 2.405 1.228l.518.869.519-.869c.533-.819 1.34-1.228 2.405-1.228.92 0 1.662.324 2.228.955.549.631.822 1.484.822 2.558v5.253z"></path>
                </g>
              </svg>
            </a><a href="https://bsky.app/profile/lukemurraynz.bsky.social" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-icon" aria-label="Bluesky">
              <svg class="octicon" xmlns="http://www.w3.org/2000/svg" role="img" viewBox="0 0 16 16" height="20" width="20" fill="currentColor">
                <title>Bluesky</title>
                <path d="M8 7.2c-.72-1.4-2.7-4.04-4.53-5.33C1.7.63 1.04.84.6 1.04.1 1.27 0 2.05 0 2.51c0 .46.25 3.77.42 4.32.54 1.82 2.47 2.45 4.25 2.25-2.6.38-4.92 1.33-1.88 4.71 3.33 3.46 4.57-.74 5.21-2.87.64 2.13 1.37 6.18 5.16 2.87 2.84-2.87.78-4.33-1.83-4.71 1.78.2 3.71-.43 4.25-2.25.17-.55.42-3.86.42-4.32 0-.46-.09-1.24-.6-1.47-.44-.2-1.11-.42-2.87.83A17.87 17.87 0 0 0 8 7.2Z"></path>
              </svg>
            </a><a href="https://twitter.com/lukemurraynz" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-icon" aria-label="X"><svg height="20" width="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 8.586l4.293-4.293a1 1 0 011.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 011.414-1.414L10 8.586z" clip-rule="evenodd"/>
          </svg></a><a href="https://www.linkedin.com/in/ljmurray/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-icon" aria-label="LinkedIn"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" height="20" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854V1.146zm4.943 12.248V6.169H2.542v7.225h2.401zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248-.822 0-1.359.54-1.359 1.248 0 .694.521 1.248 1.327 1.248h.016zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274 0-1.845.7-2.165 1.193v.025h-.016a5.54 5.54 0 0 1 .016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225h2.4z"></path></svg></a><a href="https://luke.geek.nz/rss" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-rss-link" aria-label="RSS"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><div role="group"><h3 class="yearGroupHeading_rMGB">2025</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure/container-apps-vnc-dosbox/">Azure Container Apps with VNC and DOSBox</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure/partner-admin-link-tool/">Bulk Link Partner Admin Link (PAL) to Azure Tenants</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure/microsoft-learn-contributor-chatmode/">Microsoft Learn Contributor Chatmode</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure/service-groups-terraform-azapi/">Deploying Azure Service Groups with Terraform AzAPI</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/azure/mcp-vscode-microsoft-learn/">Model Context Protocol (MCP) in VS Code with Microsoft Learn</a></li></ul></div></nav></aside><main class="col col--7"><article class=""><header><h1 class="title_f1Hy">Implementing AI Gateway capabilities in API Management</h1><div class="container_mt6G margin-vert--md"><time datetime="2024-08-14T06:40:06.774Z">August 14, 2024</time> ¬∑ <!-- -->27 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://luke.geek.nz/img/logo.png" alt="Luke Murray"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://luke.geek.nz" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">Luke Murray</span></a></div><small class="authorTitle_nd0D" title="Author">Author</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><p>Today, we are going to delve into some of the Generative <a href="https://learn.microsoft.com/ai/playbook/technology-guidance/generative-ai/dev-starters/genai-gateway/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">AI Gateway capabilities</a> <em>(commonly referred to as AI Gateway)</em> that are available in the <a href="https://learn.microsoft.com/azure/api-management/api-management-key-concepts?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">API Management</a> service.</p>
<p>These capabilities are designed to help secure and monitor your OpenAI endpoints in your applications as you head toward production.</p>
<!-- -->
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-overview">üåê Overview<a href="#-overview" class="hash-link" aria-label="Direct link to üåê Overview" title="Direct link to üåê Overview">‚Äã</a></h2>
<p>Common scenarios that the AI Gateway capabilities can help with include:</p>
<ul>
<li>How can we track token usage across multiple applications? How can we do cross charges for multiple applications/teams that use Azure OpenAI models?</li>
<li>How can we make sure that a single app does not consume the whole TPM quota, leaving other apps with no option to use Azure OpenAI models?</li>
<li>How can we make sure that the API key is securely distributed across multiple applications?</li>
<li>How can we distribute load across multiple Azure OpenAI endpoints? How can we make sure that PTUs are used first before falling back to Pay-as-you-go instances?</li>
</ul>
<p>In this post, we will explore how to use the AI Gateway capabilities in API Management to address these scenarios.</p>
<p><img decoding="async" loading="lazy" alt="APIM + Azure OpenAI" src="/assets/images/AI_Gateway_APIMOpenAI-80ae2388688f19a95cc432db3e783854.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="AI Gateway" src="/assets/images/ai-gateway-d9353e29e0749e3ad7ac37733aff7831.gif" width="1265" height="387" class="img_ev3q"></p>
<p>The first step is to <a href="https://learn.microsoft.com/azure/api-management/azure-openai-api-from-specification?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">import the Azure OpenAI</a> service and definition into API Management. This will allow you to create a new API in API Management that can act as a gateway to the Azure OpenAI service.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>You can import an Azure OpenAI API directly from the Azure OpenAI Service to API Management. When you import the API, API Management automatically configures:</p><ul>
<li>Operations for each of the Azure OpenAI REST API endpoints.</li>
<li>A system-assigned identity with the necessary permissions to access the Azure OpenAI resource.</li>
<li>A backend resource and set-backend-service policy that directs API requests to the Azure OpenAI Service endpoint.</li>
<li>An authentication-managed-identity policy that can authenticate to the Azure OpenAI resource using the instance&#x27;s system-assigned identity.</li>
<li><em>(optionally)</em> Policies help you monitor and manage token consumption using the Azure OpenAI API.</li>
</ul><p>The general availability of this functionality went into May 2024. <a href="https://azure.microsoft.com/en-us/updates/ga-import-azure-openai-enpoints-as-an-apis-in-azure-api-management/?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">GA Import Azure OpenAI endpoints as an API in Azure API Management</a>.</p></div></div>
<p>So, let us take a look at how to import the Azure OpenAI service and definition into API Management.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-request-forwarding">üì¨ Request Forwarding<a href="#-request-forwarding" class="hash-link" aria-label="Direct link to üì¨ Request Forwarding" title="Direct link to üì¨ Request Forwarding">‚Äã</a></h2>
<p>Let us take a look at forwarding the request.</p>
<p><img decoding="async" loading="lazy" alt="Request Forwarding" src="/assets/images/AI_Gateway_APIMRequestForwarding-367920bce5a96a3bc6faafe060dab2e3.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>For this article, I have the following resources pre-deployed already:</p>
<table><thead><tr><th><strong>Name</strong></th><th><strong>Type</strong></th><th><strong>Region</strong></th></tr></thead><tbody><tr><td>openai-ca-res-eastus</td><td>Azure OpenAI</td><td>East US</td></tr><tr><td>openai-ca-res-uksouth</td><td>Azure OpenAI</td><td>UK South</td></tr><tr><td>apim-lmv01-dev-eastus-aka</td><td>API Management service</td><td>East US</td></tr></tbody></table>
<p>We will start by adding openai-ca-res-eastus to the Azure API Management service first before looking at adding the other resources.</p>
<blockquote>
<p>This will automatically, enable the System Managed Identity of API Management, to access the Azure OpenAI service with the role of <a href="https://learn.microsoft.com/azure/ai-services/openai/how-to/role-based-access-control?WT.mc_id=AZ-MVP-5004796#cognitive-services-openai-user" target="_blank" rel="noopener noreferrer">Cognitive Services OpenAI User</a>, and create a new Backend instance, and operations.</p>
</blockquote>
<p><img decoding="async" loading="lazy" alt="Add Azure OpenAI to API Management" src="/assets/images/apim_add_azureopenaibackend-bef0dddd0efac4ec71aabab47f30cd83.gif" width="1896" height="963" class="img_ev3q"></p>
<p>We can see the police changes applied, pointing to the backend and system-managed identity.</p>
<p><img decoding="async" loading="lazy" alt="Azure OpenAI API Management Policies" src="/assets/images/apim_api_openaipolicybase-a73f2a7fae5ab39b84c8c0bf3336d43d.png" width="2685" height="821" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>There is Azure Portal integration to enable a few API policies that are out of the box to help you manage the token consumption of the Azure OpenAI API.</p><p>These are:</p><p>Manage token consumption <em>(Use the Azure OpenAI token limit policy to protect the API from overuse and to control Azure OpenAI cost. If selected, API Management will add the policy with the configured TPM value. You can add, edit, or remove this policy after the API is created.)</em>
Track token usage <em>(Use the Azure OpenAI emit token policy to log the consumed total, completion, and prompt tokens. If selected, API Management will add the policy with the specified configuration. You can add, edit, or remove this policy after the API is created)</em></p></div></div>
<p>Now that we have a frontend for our Azure OpenAI service, it&#x27;s time to test the Azure OpenAI endpoint through Azure API Management.</p>
<p>To do this, we will need a:</p>
<ul>
<li>deployment-id _(this is the name of the Model deployment, in Azure OpenAI)</li>
<li>api-version <em>(this is the version of the Azure OpenAI API, that we want to use)</em></li>
</ul>
<p>We can get this information from the Azure AI Studio, in the Azure Portal, in the Deployment blade.</p>
<p><img decoding="async" loading="lazy" alt="Azure OpenAI Deployment ID and API Version" src="/assets/images/AzureAIStudio-gpt4odeploymenturl-8e01e250dd05e2d036ffd133e8742176.png" width="1911" height="631" class="img_ev3q"></p>
<p>Now, we can test the Azure OpenAI endpoint, through Azure API Management. In Azure API Management, navigate to the openai API that you created, and select the Creates a completion for the chat message operation and the Test tab.</p>
<p>Add in your deployment ID and API version, and in the request body, enter a sample prompt like the one below:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">&quot;messages&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token property">&quot;role&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;system&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token property">&quot;content&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;You are a knowledgeable assistant in an ice cream parlor.&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token property">&quot;role&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;user&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token property">&quot;content&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;What are the ingredients typically used to make a classic vanilla ice cream?&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">&quot;max_tokens&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="Azure OpenAI Test" src="/assets/images/apim_test_azureopenaibackend-df1f2fafd998f9f09f6a837854f26665.gif" width="1896" height="963" class="img_ev3q"></p>
<p>This confirms that we can now communicate with the Azure OpenAI service, through Azure API Management.</p>
<p>So let us test Request forwarding, from a client application, such as Postman.</p>
<p>We will need to get the subscription key from the Azure API Management instance and add this to the request header as &#x27;API-key&#x27; after first associating the open API with a Product and the subscription key is generated.</p>
<p><img decoding="async" loading="lazy" alt="Azure OpenAI Postman Request Forwarding" src="/assets/images/apim_test_postmanrequestforwarding-7e4ea8153e19804af9f2e5c19dc519d3.gif" width="1896" height="963" class="img_ev3q"></p>
<p>Here is a sample PowerShell script for invoking the Azure OpenAI endpoint, through Azure API Management, as well.</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$headers</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">New-Object</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;System.Collections.Generic.Dictionary[[String],[String]]&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$headers</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Add</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;api-key&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;YOURSUBSCRIPTIONKEY&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$headers</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Add</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Content-Type&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;application/json&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$body</span><span class="token plain"> = @</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    `&quot;messages`&quot;: [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            `&quot;role`&quot;: `&quot;system`&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            `&quot;content`&quot;: `&quot;You are a knowledgeable assistant in an ice cream parlor.`&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        },</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            `&quot;role`&quot;: `&quot;user`&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            `&quot;content`&quot;: `&quot;What are the ingredients typically used to make a classic vanilla ice cream?`&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    ],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    `&quot;max_tokens`&quot;: 100</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">&quot;</span><span class="token plain">@</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$response</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Invoke-RestMethod</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;https://apim-lmv01-dev-eastus-aka.azure-api.net/openai/deployments/gpt-4o/chat/completions?api-version=2024-02-15-preview&#x27;</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Method </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;POST&#x27;</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Headers </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$headers</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Body </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$body</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$response</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">ConvertTo-Json</span><br></span></code></pre></div></div>
<p>We have successfully implemented Request forwarding, through API Management to the Azure OpenAI endpoint.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-backend-circuit-breaking">üîå Backend circuit breaking<a href="#-backend-circuit-breaking" class="hash-link" aria-label="Direct link to üîå Backend circuit breaking" title="Direct link to üîå Backend circuit breaking">‚Äã</a></h2>
<p>Now, let us take a look at Backend circuit breaking. The <a href="https://learn.microsoft.com/azure/architecture/patterns/circuit-breaker?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Circuit Breaker</a> pattern, follows the same principles as the electrical circuit breaker. It is used to detect failures and encapsulate the logic of preventing a failure from constantly recurring, during maintenance, temporary overloads, or unexpected spikes in traffic. When the circuit breaker trips, it can return an error immediately, without trying to execute the operation.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>The Circuit Breaker pattern is mentioned in my <a href="https://luke.geek.nz/azure/cloud-design-patterns/" target="_blank" rel="noopener noreferrer">Cloud Design Patterns</a> blog post.</p></div></div>
<p>A circuit breaker acts as a proxy for operations that might fail. The proxy should monitor the number of recent failures that have occurred, and use this information to decide whether to allow the operation to proceed, or simply return an exception immediately, when the circuit is Closed the requests are allowed to pass through, when the circuit is Open, the requests are blocked.</p>
<p><img decoding="async" loading="lazy" alt="Backend Circuit Breaking" src="/assets/images/AI_Gateway_APIMCircuitBreaker-9ff007d6e10e3e0dbc9d0e6bfb72fa62.png" width="1402" height="766" class="img_ev3q"></p>
<p>To implement a circuit breaker in API Management, we will need to add a policy to the Azure OpenAI API that monitors the number of recent failures and uses this information to decide whether to allow the operation to proceed or simply return an exception immediately.</p>
<p>Unlike Request forwarding, configuring the Circuit Breaker cannot currently be done in the Azure Portal and will require configuration through Infrastructure as Code (i.e., Bicep)_ or the API Management REST API.</p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>Before you configure a circuitbreaker policy, make sure you have a backup of your Backend configuration and test this in a non-production environment.</p></div></div>
<p>Today, we will configure it using Bicep, by referencing the backend of an already existing API Management resource, and adding in the circuitBreaker rule.</p>
<p><img decoding="async" loading="lazy" alt="Backend Circuit Breaking Bicep" src="/assets/images/AI_Gateway_APIMCircuitBreakerBicepDeploy-004cb18c8010a4b41fa1edf77a2bb50f.png" width="2595" height="823" class="img_ev3q"></p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> backend </span><span class="token datatype class-name">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> existingUrl </span><span class="token datatype class-name">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Use the parameters to update properties</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> updatedBackend </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Microsoft.ApiManagement/service/backends@2023-09-01-preview&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> backend</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">url</span><span class="token operator">:</span><span class="token plain"> existingUrl  </span><span class="token comment" style="color:rgb(98, 114, 164)">// Use the parameter to keep the existing URL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">protocol</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;http&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">circuitBreaker</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">rules</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">failureCondition</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">count</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">3</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Number of failures before tripping the circuit breaker</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">errorReasons</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Server errors&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Reasons for the failure</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">interval</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;PT1H&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Time interval to count the failures</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">statusCodeRanges</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token property">min</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">500</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Minimum status code to consider as a failure</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token property">max</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">599</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Maximum status code to consider as a failure</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;myBreakerRule&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Name of the circuit breaker rule</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">tripDuration</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;PT1H&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Duration for which the circuit breaker remains tripped</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">acceptRetryAfter</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Whether to accept retry after the trip duration</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>In the Circuit Breaker rule above, the following behavior will occur:</p>
<table><thead><tr><th><strong>Parameter</strong></th><th><strong>Description</strong></th></tr></thead><tbody><tr><td><strong>Number of Failures</strong></td><td>The circuit breaker will trip if there are 3 or more failures within the specified time interval.</td></tr><tr><td><strong>Error Reasons</strong></td><td>Failures considered are those matching the reason &#x27;Server errors&#x27;. The application or service should categorize errors with this reason.</td></tr><tr><td><strong>Status Code Ranges</strong></td><td>Failures are identified based on HTTP status codes ranging from 500 to 599, covering server-side errors such as internal server errors (500), service unavailable (503), and similar issues.</td></tr><tr><td><strong>Time Interval</strong></td><td>Failures are counted within a time interval of 1 hour (&#x27;PT1H&#x27;). If there are 3 or more failures with status codes in the 500‚Äì599 range within any 1-hour window, the circuit breaker will trip.</td></tr><tr><td><strong>Trip Duration</strong></td><td>Once tripped, the circuit breaker remains in the tripped state for 1 hour (&#x27;PT1H&#x27;). During this period, requests will not pass through until the breaker is reset.</td></tr><tr><td><strong>Retry Behavior</strong></td><td>After the trip duration of 1 hour, the circuit breaker is designed to allow retries (acceptRetryAfter: true). Requests will be accepted again after the trip duration, and the service will attempt to recover.</td></tr><tr><td><strong>Scenarios Where the Circuit Breaker Will Trip</strong></td><td>If, within any 1-hour period, there are 3 or more server-side errors (HTTP status codes 500‚Äì599) with the reason &#x27;Server errors&#x27;, the circuit breaker will trip. Once tripped, the circuit breaker will block requests for 1 hour. After the 1-hour block period, the circuit breaker will reset and start accepting requests again.</td></tr></tbody></table>
<p>There is nothing in the Azure Portal for API management, but if we take a look at the backend provider resource, we can confirm that the configuration for the backend has been set.</p>
<p><img decoding="async" loading="lazy" alt="Backend Circuit Breaking Bicep" src="/assets/images/AI_Gateway_APIMCircuitBreakerPostBicepDeploy-190c9f1188abcb165e1ba9054103a4f8.png" width="1539" height="509" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-backend-load-balancing">‚öñÔ∏è Backend Load Balancing<a href="#Ô∏è-backend-load-balancing" class="hash-link" aria-label="Direct link to ‚öñÔ∏è Backend Load Balancing" title="Direct link to ‚öñÔ∏è Backend Load Balancing">  ‚Äã</a></h2>
<p>Let us now take a look at Backend Load Balancing with <a href="https://learn.microsoft.com/azure/api-management/backends?tabs=bicep&amp;WT.mc_id=AZ-MVP-5004796#load-balanced-pool" target="_blank" rel="noopener noreferrer">Load-Balanced Pools</a>. Load balancing is the process of distributing network traffic across multiple endpoints. This ensures that no single server bears too much demand. By spreading the work evenly, load balancing improves application responsiveness.</p>
<p><img decoding="async" loading="lazy" alt="Backend Load Balancing" src="/assets/images/AI_Gateway_APIMBackendLoadBalancing-9b8309c78822bc9e5aacb67487938eae.PNG" width="1396" height="764" class="img_ev3q"></p>
<p>Backend pooling your Azure OpenAI endpoints, allows you to:</p>
<ul>
<li>Spread the load to multiple backends, which may have individual backend circuit breakers.</li>
<li>Shift the load from one set of backends to another for upgrade <em>(blue-green deployment)</em>.</li>
</ul>
<p>Note Backend pools don&#x27;t need any policy configuration. The rules are just properties of the backend.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>API Management supports the following load balancing options for backend pools:</p><ul>
<li>Round-robin: By default, requests are distributed evenly across the backends in the pool.</li>
<li>Weighted: Weights are assigned to the backends in the pool, and requests are distributed across the backends based on the relative weight assigned to each backend. Use this option for scenarios such as conducting a blue-green deployment.</li>
<li>Priority-based: Backends are organized in priority groups, and requests are sent to the backends in order of the priority groups. Within a priority group, requests are distributed either evenly across the backends, or (if assigned) according to the relative weight assigned to each backend.</li>
</ul><p><em>(Backends in lower priority groups will only be used when all backends in higher priority groups are unavailable because circuit breaker rules are tripped.)</em></p></div></div>
<p>If we go back to my environment, we are currently operating with the following resources:</p>
<table><thead><tr><th><strong>Name</strong></th><th><strong>Type</strong></th><th><strong>Region</strong></th></tr></thead><tbody><tr><td>openai-ca-res-eastus</td><td>Azure OpenAI</td><td>East US</td></tr><tr><td>openai-ca-res-uksouth</td><td>Azure OpenAI</td><td>UK South</td></tr><tr><td>apim-lmv01-dev-eastus-aka</td><td>API Management service</td><td>East US</td></tr></tbody></table>
<p>So so far, the Azure OpenAI backend of eastus is being used, but we can add the uksouth backend to the backend pool, and configure it to be used in a round-robin fashion.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>One of the reasons you may want to do this is not only to ensure reliability, using a priority group - that your Azure OpenAI service is highly available and can be accessed from multiple regions, but you may also want to ensure that you are not hitting the <a href="https://learn.microsoft.com/azure/ai-services/openai/quotas-limits?WT.mc_id=AZ-MVP-5004796#regional-quota-limits" target="_blank" rel="noopener noreferrer">TPM <em>(Tokens Per Minute)</em> regional limits</a> of the Azure OpenAI service, and that you are distributing the load across multiple regions.</p><p>A common scenario here would be to have a primary region, that has a <a href="https://learn.microsoft.com/azure/ai-services/openai/concepts/provisioned-throughput?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">PTU <em>(Proviosned Throughout)</em></a> assigned, and failover to a pay as you go region.</p></div></div>
<p>Similar to the Circuit Breaker rule capability, we need to configure Backend Pools using the Azure RestAPI or an Infrastructure as Code method, such as Bicep.</p>
<p>In my example, I will be adding the openai-ca-res-uksouth to the backend pool of the Azure OpenAI API and configuring it to use EastUS first and failover to UKSouth if east us stops responding.</p>
<p>To do this, we need to add a new backend and then reference that in a new pool configuration.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>When we initially added our first Azure OpenAI resource, a lot of the configuration was done for us, including adding the <a href="https://learn.microsoft.com/azure/ai-services/openai/how-to/role-based-access-control?WT.mc_id=AZ-MVP-5004796#cognitive-services-openai-user" target="_blank" rel="noopener noreferrer">Cognitive Services OpenAI User</a> role to the System Managed Identity of the API Management instance to authenticate with the Azure OpenAI resource, so make sure you grant Azure API Management the necessary permissions to access any other Azure OpenAI resource.</p><p><img decoding="async" loading="lazy" alt="Azure OpenAI API Management Policies" src="/assets/images/apim_add_cognitiveaiuserrbacuksouth-9fc00c5bb551804001531619f03c852e.gif" width="1896" height="824" class="img_ev3q"></p></div></div>
<p>Navigate to your secondary Azure OpenAI instance, and navigate to Keys and Endpoints, we need to grab the endpoint URL ie <em>(<a href="https://openai-ca-res-uksouth.openai.azure.com/" target="_blank" rel="noopener noreferrer">https://openai-ca-res-uksouth.openai.azure.com/</a>)</em>, to add as another Backend and append with /openai.</p>
<p><img decoding="async" loading="lazy" alt="Azure OpenAI UKSouth Endpoint" src="/assets/images/apim_add_cognitiveaiserviceuksouth-da040a214e8a8ad004a7bfd6f067a0cd.gif" width="1896" height="824" class="img_ev3q"></p>
<p>Now that its added as a backend, we can add it to the backend pool, and configure it.</p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> backendnane </span><span class="token datatype class-name">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> subscriptionID </span><span class="token datatype class-name">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> resourceGroupName </span><span class="token datatype class-name">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> APIManagementName </span><span class="token datatype class-name">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> backend1 </span><span class="token datatype class-name">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">param</span><span class="token plain"> backend2 </span><span class="token datatype class-name">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Use the parameters to update properties</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">resource</span><span class="token plain"> updatedBackend </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Microsoft.ApiManagement/service/backends@2023-09-01-preview&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">&#x27;</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">APIManagementName</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">/</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">backendnane</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">properties</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">description</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Load balancer for multiple backends&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Pool&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">pool</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">services</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)">// Define the backend pool configuration for an API Management service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token comment" style="color:rgb(98, 114, 164)">// Define the first backend with a specific ID, priority, and weight</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">id</span><span class="token operator">:</span><span class="token plain"> </span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">&#x27;/subscriptions/</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">subscriptionID</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">/resourceGroups/</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">resourceGroupName</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">/providers/Microsoft.ApiManagement/service/</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">APIManagementName</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">/backends/</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">backend1</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">priority</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Higher priority backend</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">weight</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain">   </span><span class="token comment" style="color:rgb(98, 114, 164)">// Weight of the backend</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token comment" style="color:rgb(98, 114, 164)">// Define the second backend with a specific ID, priority, and weight</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">id</span><span class="token operator">:</span><span class="token plain"> </span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">&#x27;/subscriptions/</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">subscriptionID</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">/resourceGroups/</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">resourceGroupName</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">/providers/Microsoft.ApiManagement/service/</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">APIManagementName</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">/backends/</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token interpolated-string interpolation expression">backend2</span><span class="token interpolated-string interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token interpolated-string string" style="color:rgb(255, 121, 198)">&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">priority</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Higher priority backend</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">weight</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">2</span><span class="token plain">   </span><span class="token comment" style="color:rgb(98, 114, 164)">// Weight of the backend</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="Backend Pool Bicep" src="/assets/images/AI_Gateway_APIMBackendPoolBicepDeploy-289231677f28105dc86256ef5761cfda.png" width="1476" height="713" class="img_ev3q"></p>
<p>Once the deploy is done, we can see the backend pool configuration in the Azure Portal.</p>
<p><img decoding="async" loading="lazy" alt="Backend Pool Bicep" src="/assets/images/AI_Gateway_APIMBackendPool-6986a7ac57ecfcc77e0e21d5a6209b60.png" width="1808" height="682" class="img_ev3q"></p>
<p>Now we need to update the Azure API Managememt OpenAI API, to use the backend pool, instead of the single backend.</p>
<p>Navigate to APIs, and your OpenAI API, select All Operations and then select the edit button.</p>
<p>Change the backend it to the name of your Backend Pool.</p>
<p><img decoding="async" loading="lazy" alt="Backend Pool Bicep" src="/assets/images/AI_Gateway_APIMBackendPoolAPIPolicyConfig-2ff002f67a62ca29b6851a20c3f1e569.png" width="1837" height="659" class="img_ev3q"></p>
<p>Now if we test the Azure OpenAI endpoint, through Azure API Management, we can see that the requests are being distributed across the two backends in the backend pool.</p>
<p>If we enable, Tracing we can see the handoff, and our API callers are oblivious to the fact that their API call is getting redirected.</p>
<p><img decoding="async" loading="lazy" alt="Backend Pool Bicep" src="/assets/images/apim_test_loadbalancedpools-754ac7221f305622d6840c97763440ef.gif" width="1896" height="824" class="img_ev3q"></p>
<p>You can use the Circuitbreaker and Backend Pooling in conjunction with each other, to ensure that your Azure OpenAI service is highly available, and can be accessed from multiple regions.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>The Circuitbreaker policies are on the Backends, not the Pools.</p></div></div>
<p>For example, I changed the circuitBreaker rule, status code range to: 401 <em>(Permission Denied)</em> and removed the Cogniative User role from the System Managed Identity of the API Management instance, to simulate a backend failure, and moved the UkSouth endpoint to priority group 2.</p>
<p><img decoding="async" loading="lazy" alt="Backend Pool Bicep" src="/assets/images/AI_Gateway_APIMBackendPoolPermissionDenied-b445246a6e53b17e7a817f37c014481e.png" width="1004" height="522" class="img_ev3q"></p>
<div class="language-bicep codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bicep codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">         statusCodeRanges</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">               </span><span class="token comment" style="color:rgb(98, 114, 164)">// Define the range of HTTP status codes that will be considered as failures for the circuit breaker</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token property">min</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">401</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Minimum status code to consider as a failure (e.g., Unauthorized)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token property">max</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">401</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Maximum status code to consider as a failure (e.g., Unauthorized)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><br></span></code></pre></div></div>
<p>And it worked as expected, the circuit breaker tripped, and the requests were redirected to the UKSouth backend.</p>
<p><img decoding="async" loading="lazy" alt="Backend Pool Bicep" src="/assets/images/apim_test_loadbalancedcircuitbreakerpools-cc8d8e9284555389d1e559a788bc6bd1.gif" width="1483" height="811" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-response-streaming">üì° Response Streaming<a href="#-response-streaming" class="hash-link" aria-label="Direct link to üì° Response Streaming" title="Direct link to üì° Response Streaming">‚Äã</a></h2>
<p>Let us take a look at Response Streaming. Response streaming is a technique used to send a response to a client in chunks, rather than all at once. This can be useful when the response is large, or when the response is being generated in real-time.</p>
<p><img decoding="async" loading="lazy" alt="Response Streaming" src="/assets/images/AI_Gateway_APIMResponseStreaming-01d33957f271809e6df6789b672156a3.PNG" width="4000" height="2250" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>Follow the <a href="https://learn.microsoft.com/en-us/azure/api-management/how-to-server-sent-events?WT.mc_id=AZ-MVP-5004796#guidelines-for-sse" target="_blank" rel="noopener noreferrer">guidelines</a> when using API Management to reach a backend API that implements SSE (Server side streaming).</p></div></div>
<p>If I go back to our Creates a completion for the chat message, operation, and edit the policy and add the following to the inbound and outbound Azure policies.</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">inbound</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)">&lt;!-- Base inbound processing --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">base</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)">&lt;!-- Conditional logic to check if the request body contains a non-null &quot;stream&quot; property --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">choose</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">when</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">condition</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">@(context.Request.Body.As&lt;JObject&gt;(true)[</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">&quot;</span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">stream&quot;]</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">!</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)"> null</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">&amp;&amp;</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">context.Request.Body.As&lt;JObject</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">(true)[&quot;stream&quot;].Type != JTokenType.Null)&quot;&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token comment" style="color:rgb(98, 114, 164)">&lt;!-- Set a variable &quot;isStream&quot; with the value of the &quot;stream&quot; property from the request body --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">set-variable</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">name</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">isStream</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">&quot;</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">value</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">@{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token tag attr-value" style="color:rgb(255, 121, 198)">                    var content = (context.Request.Body?.As&lt;JObject&gt;(true));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token tag attr-value" style="color:rgb(255, 121, 198)">                    string streamValue = content[</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">&quot;</span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">stream&quot;].ToString();</span><span class="token tag" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token tag" style="color:rgb(255, 121, 198)">                    </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">return</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">streamValue;</span><span class="token tag" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token tag" style="color:rgb(255, 121, 198)">                </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">}&quot;</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">when</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">choose</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">inbound</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">&lt;!-- Control if and how the requests are forwarded to services --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">backend</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)">&lt;!-- Base backend processing --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">base</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">backend</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">&lt;!-- Customize the responses --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">outbound</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)">&lt;!-- Base outbound processing --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">base</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)">&lt;!-- Set a custom header &quot;x-ms-stream&quot; based on the value of the &quot;isStream&quot; variable --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">set-header</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">name</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">x-ms-stream</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">&quot;</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">exists-action</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">override</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">&quot;</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">value</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">@{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    return context.Variables.GetValueOrDefault</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">string</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">(&quot;isStream&quot;,&quot;false&quot;).Equals(&quot;true&quot;, StringComparison.OrdinalIgnoreCase).ToString();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                }</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">value</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">set-header</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">outbound</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><br></span></code></pre></div></div>
<p>This sets the x-ms-stream header to true, if the request body contains a non-null &quot;stream&quot; property, allowing streaming, so let us test this in Postman</p>
<p>By using the following prompt:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">&quot;messages&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">&quot;role&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;system&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">&quot;content&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;You are a knowledgeable assistant in an ice cream parlor.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">&quot;role&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;user&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">&quot;content&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;What are the ingredients typically used to make a classic vanilla ice cream?&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">&quot;max_tokens&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">100</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">&quot;stream&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="Response Streaming" src="/assets/images/apim_test_responsestreamingpostman-30c067a88313695c3ea3d6fb1b5f9c4e.gif" width="1483" height="922" class="img_ev3q"></p>
<p>Note: Full JSON streaming support <a href="https://github.com/postmanlabs/postman-app-support/issues/12713" target="_blank" rel="noopener noreferrer">is not avaliable</a> at this time of this article in postman, so again - you need a client to support this.</p>
<p>We can, however see the response does include the response being streamed and broken up into chunks:</p>
<p><img decoding="async" loading="lazy" alt="Response Streaming" src="/assets/images/AI_Gateway_APIMResponseStreamingPostmanOutput-c3cc800d5ded2012e1aaaa49afcd6449.PNG" width="542" height="357" class="img_ev3q"></p>
<p>To remove the streaming component, we can either remove the stream from the body or change the stream from true to false.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-token-rate-limiting">‚è≥ Token rate limiting<a href="#-token-rate-limiting" class="hash-link" aria-label="Direct link to ‚è≥ Token rate limiting" title="Direct link to ‚è≥ Token rate limiting">‚Äã</a></h2>
<p>Let us take a look at Token rate limiting. Token rate limiting is a technique used to limit the number of requests that can be made to an API within a certain time period. This can help prevent abuse of the API, and ensure that all users have fair access to the API.</p>
<p><img decoding="async" loading="lazy" alt="Token Rate Limiting" src="/assets/images/AI_Gateway_APIMTokenRateLimiting-9abe8628c0c20291dee7af1511cac346.PNG" width="1280" height="682" class="img_ev3q"></p>
<p>To implement token rate limiting in API Management, we need to add a policy to the Azure OpenAI API, that will limit the number of requests that can be made to the API within a certain time period, the tokens per minute.</p>
<p>This is an Inbound policy, and will limit the tokens per minute, with a 429 <em>(Too Many Requests)</em> response, that can be called from a single IP address <em>(each unqiue IP address will have its own counter)</em>.</p>
<p><img decoding="async" loading="lazy" alt="Token Rate Limiting" src="/assets/images/apim_set_RateLimitPolicy-e931dbbcf9a4be862ab32818a0310f84.gif" width="1895" height="960" class="img_ev3q"></p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">azure-openai-token-limit</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">counter-key</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">@(context.Request.IpAddress)</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">&quot;</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">tokens-per-minute</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">500</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">&quot;</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">estimate-prompt-tokens</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">false</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">&quot;</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">remaining-tokens-variable-name</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">remainingTokens</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">&quot;</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">/&gt;</span><br></span></code></pre></div></div>
<table><thead><tr><th><strong>Property</strong></th><th><strong>Description</strong></th></tr></thead><tbody><tr><td><code>&lt;azure-openai-token-limit&gt;</code></td><td>This is a custom tag or directive used to define the rate-limiting policy for Azure OpenAI tokens.</td></tr><tr><td><code>counter-key=&quot;@(context.Request.IpAddress)&quot;</code></td><td>This specifies that the rate-limiting should be based on the client&#x27;s IP address. Each unique IP address will have its own counter.</td></tr><tr><td><code>tokens-per-minute=&quot;500&quot;</code></td><td>This sets the limit to 500 tokens per minute for each IP address. Once an IP address consumes 500 tokens within a minute, further requests will be restricted until the next minute.</td></tr><tr><td><code>estimate-prompt-tokens=&quot;false&quot;</code></td><td>This indicates whether to estimate the number of tokens in the prompt. Setting it to false means the actual token count will be used rather than an estimate.</td></tr><tr><td><code>remaining-tokens-variable-name=&quot;remainingTokens&quot;</code></td><td>This specifies the variable name (<code>remainingTokens</code>) that will store the number of tokens remaining for the current minute.</td></tr></tbody></table>
<p>So lets test it, in my test, I am using a PowerShell script to call the Azure OpenAI endpoint, through Azure API Management, and I am calling it 20 times, in a loop, to test the rate limiting.</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Define the headers</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$headers</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">New-Object</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;System.Collections.Generic.Dictionary[[String],[String]]&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$headers</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Add</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;api-key&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;YOURSUBSCRIPTIONKEY&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$headers</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Add</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Content-Type&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;application/json&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Define the body</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$body</span><span class="token plain"> = @</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    `&quot;messages`&quot;: [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            `&quot;role`&quot;: `&quot;system`&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            `&quot;content`&quot;: `&quot;You are a knowledgeable assistant in an ice cream parlor.`&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        },</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            `&quot;role`&quot;: `&quot;user`&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            `&quot;content`&quot;: `&quot;What are the ingredients typically used to make a classic vanilla ice cream?`&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    ],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    `&quot;max_tokens`&quot;: 100</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">&quot;</span><span class="token plain">@</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Loop to run the script 20 times</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$i</span><span class="token plain"> = 1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$i</span><span class="token plain"> </span><span class="token operator">-le</span><span class="token plain"> 20</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$i</span><span class="token operator">++</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">try</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Send the request and capture the response</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$response</span><span class="token plain"> = </span><span class="token function" style="color:rgb(80, 250, 123)">Invoke-RestMethod</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;https://apim-lmv01-dev-eastus-aka.azure-api.net/openai/deployments/gpt-4o/chat/completions?api-version=2024-02-15-preview&#x27;</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Method </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;POST&#x27;</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Headers </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$headers</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Body </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$body</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Output the response as JSON</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$responseJson</span><span class="token plain"> = </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$response</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">ConvertTo-Json</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Depth 10</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Output</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$responseJson</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Handle any errors that occur during the request</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">Write-Error</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Exception</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Message</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="Token Rate Limit test" src="/assets/images/apim_test_RateLimitPolicy-5f10867ab873c57a2602495a9fee6e9f.gif" width="1547" height="884" class="img_ev3q"></p>
<p>As we can see, it instantly gets declined after the 500th token; however, traffic from other IP addresses can still access the API.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-semantic-caching">üóÇÔ∏è Semantic Caching<a href="#Ô∏è-semantic-caching" class="hash-link" aria-label="Direct link to üóÇÔ∏è Semantic Caching" title="Direct link to üóÇÔ∏è Semantic Caching">‚Äã</a></h2>
<p>Let us take a look at <a href="https://learn.microsoft.com/en-us/azure/api-management/azure-openai-enable-semantic-caching?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Semantic Caching</a>. Semantic caching is a technique used to cache responses from an API based on the content of the request. This can help improve performance by reducing the number of requests that need to be made to the API.</p>
<blockquote>
<p>With semantic caching, you can return cached responses for identical prompts and also for prompts that are similar in meaning, even if the text isn&#x27;t the same.</p>
</blockquote>
<p>To use Semantic Caching, we need an Embedding model to generate embeddings for the prompts and a Cache policy to cache the responses based on the embeddings.</p>
<p>In my example, I will deploy an Embedding model <em>(text-embedding-ada-002)</em> to the East US Azure OpenAI resource.</p>
<p><img decoding="async" loading="lazy" alt="Semantic Caching - text-embedding-ada-002 deployment" src="/assets/images/AI_Gateway_APIMSemanticCaching_EmbeddingDeployment-bc8c70a25d269d8de2b7ea10232b0fd1.PNG" width="1633" height="981" class="img_ev3q"></p>
<p>Now, we need to add a Backend for the embedding endpoint, similar to how we originally added the US East backend. If you are using load balancing, you can add this to a new backend pool as well, as long as the model is deployed across all endpoints.</p>
<p>However, instead of a /chat endpoint, we will use the /embed endpoint, and the deployment will be the name of the embedding model deployment, as an example <em>(<a href="https://openai-ca-res-eastus.openai.azure.com/openai/deployments/text-embedding-ada-002/embeddings" target="_blank" rel="noopener noreferrer">https://openai-ca-res-eastus.openai.azure.com/openai/deployments/text-embedding-ada-002/embeddings</a>)</em>.</p>
<p>Once we have our URL we can add a new Backend.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>This could be deployed to another Azure OpenAI instance, but make sure you enable the Cognitive Services OpenAI User role on the System Managed Identity of the API Management instance to authenticate with the Azure OpenAI resource.</p></div></div>
<p><img decoding="async" loading="lazy" alt="Semantic Caching - Embedding Backend" src="/assets/images/apim_set_SemanticCachingModelBackend-d84de613221c75aec46d7ab782fecddb.gif" width="1906" height="884" class="img_ev3q"></p>
<p>Now, it is time to configure our <a href="https://learn.microsoft.com/azure/api-management/azure-openai-semantic-cache-lookup-policy?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">semantic caching policy</a>.</p>
<blockquote>
<p>We will need a <strong><a href="https://learn.microsoft.com/azure/api-management/api-management-howto-cache-external?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Redis Enterprise Cache deployed</a></strong>, and configured as an External cache to API Management, with <strong><a href="https://learn.microsoft.com/azure/azure-cache-for-redis/cache-redis-modules?WT.mc_id=AZ-MVP-5004796#redisearch" target="_blank" rel="noopener noreferrer">RediSearch module</a> enabled</strong> and then we can add the semantic caching policy to the Azure OpenAI API. Without the Redis cache, the semantic caching policy will not work, and the azure-openai-semantic-cache-lookup policy will be skipped.</p>
</blockquote>
<p>Navigate to our OpenAI API, select the Creates a completion for the chat message operation, and add the following policy to the inbound section.</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">azure-openai-semantic-cache-lookup</span><span class="token tag" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token tag" style="color:rgb(255, 121, 198)">    </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">score-threshold</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">0.5</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">&quot;</span><span class="token tag" style="color:rgb(255, 121, 198)">  </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">&lt;!--</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">Adjusted</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">threshold</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">for</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">better</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">precision</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">--</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    embeddings-backend-id=&quot;azureaiembeddingbackend&quot;  </span><span class="token comment" style="color:rgb(98, 114, 164)">&lt;!-- Updated backend ID --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    embeddings-backend-auth=&quot;system-assigned&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ignore-system-messages=&quot;false&quot;  </span><span class="token comment" style="color:rgb(98, 114, 164)">&lt;!-- Include system messages if they add value --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    max-message-count=&quot;15&quot;&gt; </span><span class="token comment" style="color:rgb(98, 114, 164)">&lt;!-- Increased message count for more context --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">vary-by</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">@(context.Subscription.Id)</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">vary-by</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">azure-openai-semantic-cache-lookup</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><br></span></code></pre></div></div>
<table><thead><tr><th><strong>Element</strong></th><th><strong>Description</strong></th></tr></thead><tbody><tr><td><code>&lt;azure-openai-semantic-cache-lookup&gt;</code></td><td>A custom tag used to define the semantic cache lookup policy for Azure OpenAI.</td></tr><tr><td><code>score-threshold=&quot;0.8&quot;</code></td><td>Sets the threshold for similarity scores. Only results with a score of 0.5 or higher are considered.</td></tr><tr><td><code>embeddings-backend-id=&quot;embeddings-deployment&quot;</code></td><td>Specifies the ID of the embeddings backend deployment used for the cache lookup.</td></tr><tr><td><code>embeddings-backend-auth=&quot;system-assigned&quot;</code></td><td>Indicates that the system-assigned managed identity is used for authentication with the embeddings backend.</td></tr><tr><td><code>ignore-system-messages=&quot;true&quot;</code></td><td>Specifies that system messages should be ignored during the cache lookup.</td></tr><tr><td><code>max-message-count=&quot;10&quot;</code></td><td>Sets the maximum number of messages to be considered in the cache lookup.</td></tr><tr><td><code>&lt;vary-by&gt;@(context.Subscription.Id)&lt;/vary-by&gt;</code></td><td>Specifies that the cache should vary by subscription ID, meaning each subscription will have its own cache.</td></tr></tbody></table>
<p>In the Outbound processing section for the API, add the azure-openai-semantic-cache-store policy.</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">azure-openai-semantic-cache-store</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">duration</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">60</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">&quot;</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">/&gt;</span><br></span></code></pre></div></div>
<table><thead><tr><th><strong>Attribute</strong></th><th><strong>Description</strong></th></tr></thead><tbody><tr><td><code>&lt;azure-openai-semantic-cache-store&gt;</code></td><td>This is a custom tag or directive used to define the semantic cache store policy for Azure OpenAI.</td></tr><tr><td><code>duration=&quot;60&quot;</code></td><td>This specifies the duration for which the cached data should be stored in minutes. In this case, the cache will be stored for 60 minutes.</td></tr></tbody></table>
<p><img decoding="async" loading="lazy" alt="Semantic Caching - Embedding Backend" src="/assets/images/apim_Add_SemanticCachingAPIPolicies-ffe7cbcdb9019d67cef34df899be4ce6.gif" width="1906" height="895" class="img_ev3q"></p>
<p>Once added, we can test it.</p>
<p>We can do this, using the <a href="https://learn.microsoft.com/azure/api-management/api-management-howto-api-inspector?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Trace</a> feature in Azure API Management, and we can see the cache hit, and the response being returned from the cache.</p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>If you get HTTP/1.1 415 model_error, make sure you are using a <a href="https://learn.microsoft.com/azure/ai-services/openai/concepts/models?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">model that supports embeddings</a>, and that the model is deployed.
Also if you are testing, make sure that the content-type is application/json.</p></div></div>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>I was not able to test this end-to-end in my environment due to needing a payment instance for Redis, not covered under my Visual Studio Enterprise subscription.</p></div></div>
<p>If this is all configured you should see something like the below in a Trace:</p>
<p><img decoding="async" loading="lazy" alt="Semantic Caching - Semantic Cache lookup" src="data:image/png;base64,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" width="902" height="305" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-logging">üìú Logging<a href="#-logging" class="hash-link" aria-label="Direct link to üìú Logging" title="Direct link to üìú Logging">‚Äã</a></h2>
<p>Now let us take a look at Logging. Logging is the process of recording events that occur during the execution of a process. Logs can be used to monitor and troubleshoot requests, as well as to analyze and report on application performance.</p>
<p><img decoding="async" loading="lazy" alt="APIM Built in Logging" src="/assets/images/AI_Gateway_APIMBuiltinLogging-3eb67482fcc9ca685d10242055dc315d.PNG" width="4000" height="2250" class="img_ev3q"></p>
<p>To do this, we need to enable <a href="https://learn.microsoft.com/azure/azure-monitor/app/app-insights-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Application Insights</a>, which will create a <a href="https://learn.microsoft.com/azure/templates/microsoft.apimanagement/service/loggers?pivots=deployment-language-bicep&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Logger entity</a> to Application Insights from API Management.</p>
<p><img decoding="async" loading="lazy" alt="APIM Built in Logging" src="/assets/images/AI_Gateway_APIMLogging_AppInsights-287e0ea93ebe8c5df5e6cb53bdaac841.PNG" width="1361" height="487" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>If you&#x27;re not using Azure API Management, I recommend you check out the workbook by Dolev Shor (Microsoft Fastrack Engineer). You can read more about it here: <a href="https://techcommunity.microsoft.com/t5/fasttrack-for-azure/azure-openai-insights-monitoring-ai-with-confidence/ba-p/4026850?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure OpenAI Insights: Monitoring AI with Confidence</a>.</p></div></div>
<p>So, let&#x27;s take a look at some of the logs generated by the Azure OpenAI API through Azure API Management and visible through the Application Insights and Log Analytics workspace.</p>
<p><img decoding="async" loading="lazy" alt="APIM Built in Logging" src="/assets/images/AI_Gateway_APIMBuiltinLoggingAppInsights-178892bf52e262e9009cb8600c5e0bba.PNG" width="1669" height="889" class="img_ev3q"></p>
<p>The first thing you could do is configure an availability test for your API Management endpoint.</p>
<p>The API Management Gateway health probe URL is: /status-0123456789abcdef</p>
<p>So our availability test URL would be: &#x27;<a href="https://apim-lmv01-dev-eastus-aka.azure-api.net/status-0123456789abcdef" target="_blank" rel="noopener noreferrer">https://apim-lmv01-dev-eastus-aka.azure-api.net/status-0123456789abcdef</a>&#x27;</p>
<p><img decoding="async" loading="lazy" alt="API Management avaliability test" src="/assets/images/AI_Gateway_APIMLogging_AppInsightsAvaliabilityTest-cdb16c486eeb95f7d06665fc5c9c5ba7.PNG" width="1679" height="680" class="img_ev3q"></p>
<p>Next, we need to make sure that we are logging the information from the API requests, such as client IP, request URL, response code, and response time, to do that, we need to <a href="https://learn.microsoft.com/en-us/azure/api-management/api-management-howto-app-insights?tabs=rest&amp;WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">enable the Application Insights logging on our openai</a> API in API Management.</p>
<p><img decoding="async" loading="lazy" alt="APIM Built in Logging" src="/assets/images/AI_Gateway_APIMBuiltinLoggingAppInsightsEnable-fcff727a466f91ea50c8b4719b747fff.PNG" width="1413" height="790" class="img_ev3q"></p>
<p>Let&#x27;s take a look at a custom <a href="https://learn.microsoft.com/azure/azure-monitor/visualize/workbooks-overview?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure Monitor workbook</a> that helps visualize and bring out a lot of the data you need to make informed decisions without having to delve into KQL <em>(Kusto Query Language)</em> queries in Log Analytics.</p>
<p>In Application Insights, navigate to Workbooks, click + New, click on the Code and paste the workbook data from: <a href="https://github.com/Azure-Samples/AI-Gateway/blob/main/labs/built-in-logging/openai-usage-analysis-workbook.json" target="_blank" rel="noopener noreferrer">AI-Gateway/main/labs/built-in-logging/openai-usage-analysis-workbook.json</a>.</p>
<p>You can see the APIs getting called, the subscription key being used, the response time, and the response code.</p>
<p><img decoding="async" loading="lazy" alt="APIM Built in Logging" src="/assets/images/apim_test_OpenAIWorkbook-2c7ebb1f779b8e751890e56c81927e6e.gif" width="1895" height="960" class="img_ev3q"></p>
<p>If you are using a Token Limit policy, you can trace the OpenAITokenLimitExeeded exceptions. This can help you determine if you need to block any particular IP addresses either using an ip-filter policy or Application Gateway if that is in front of your API Management or if you need to increase the TPM limit.</p>
<p><img decoding="async" loading="lazy" alt="App Insights - Token Limit" src="/assets/images/AI_Gateway_APIMBuiltinLoggingAppInsights_TokenLimit-f8be079f178c67e719247ebb6082bd22.PNG" width="1847" height="905" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-conclusion">üîö Conclusion<a href="#-conclusion" class="hash-link" aria-label="Direct link to üîö Conclusion" title="Direct link to üîö Conclusion">‚Äã</a></h2>
<p>In this article, we have taken a look at how we can use Azure OpenAI as a backend to Azure API Management, how to test the Azure OpenAI endpoint, through Azure API Management, and how to implement Request forwarding, Backend circuit breaking, Backend Load Balancing, Response Streaming, Token rate limiting, Semantic Caching, and Logging.</p>
<p>All code can be found here: <a href="https://github.com/lukemurraynz/AI_Gateway_Tests" target="_blank" rel="noopener noreferrer">lukemurraynz/AI_Gateway_Tests</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-reference">üìö Reference<a href="#-reference" class="hash-link" aria-label="Direct link to üìö Reference" title="Direct link to üìö Reference">‚Äã</a></h2>
<ul>
<li>üîó<a href="https://learn.microsoft.com/azure/api-management/api-management-key-concepts?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">What is Azure API Management</a></li>
<li>üîó<a href="https://learn.microsoft.com/azure/ai-services/openai?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Azure OpenAI</a></li>
<li>üîó<a href="https://techcommunity.microsoft.com/t5/azure-integration-services-blog/introducing-genai-gateway-capabilities-in-azure-api-management/ba-p/4146525?WT.mc_id=AZ-MVP-5004796" target="_blank" rel="noopener noreferrer">Introducing GenAI Gateway Capabilities in Azure API Management</a></li>
<li>üîó<a href="https://luke.geek.nz/azure/cloud-design-patterns/" target="_blank" rel="noopener noreferrer">Cloud Design Patterns</a></li>
<li>üîó<a href="https://luke.geek.nz/azure/api-management-overview/" target="_blank" rel="noopener noreferrer">Features and Benefits of Azure API Management</a></li>
<li>üîó<a href="https://aka.ms/apim/genai/labs" target="_blank" rel="noopener noreferrer">Azure-Samples/AI-Gateway</a></li>
</ul></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/tags/azure/">Azure</a></li></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/azure/implementing-correlation-id-in-api-management/"><div class="pagination-nav__sublabel">Newer post</div><div class="pagination-nav__label">Implementing Correlation ID for API Management requests</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/azure/secure-container-supply-chain/"><div class="pagination-nav__sublabel">Older post</div><div class="pagination-nav__label">Securing Container Supply Chains with CSSC Framework</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#-overview" class="table-of-contents__link toc-highlight">üåê Overview</a></li><li><a href="#-request-forwarding" class="table-of-contents__link toc-highlight">üì¨ Request Forwarding</a></li><li><a href="#-backend-circuit-breaking" class="table-of-contents__link toc-highlight">üîå Backend circuit breaking</a></li><li><a href="#Ô∏è-backend-load-balancing" class="table-of-contents__link toc-highlight">‚öñÔ∏è Backend Load Balancing</a></li><li><a href="#-response-streaming" class="table-of-contents__link toc-highlight">üì° Response Streaming</a></li><li><a href="#-token-rate-limiting" class="table-of-contents__link toc-highlight">‚è≥ Token rate limiting</a></li><li><a href="#Ô∏è-semantic-caching" class="table-of-contents__link toc-highlight">üóÇÔ∏è Semantic Caching</a></li><li><a href="#-logging" class="table-of-contents__link toc-highlight">üìú Logging</a></li><li><a href="#-conclusion" class="table-of-contents__link toc-highlight">üîö Conclusion</a></li><li><a href="#-reference" class="table-of-contents__link toc-highlight">üìö Reference</a></li></ul></div></div></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright ¬© 2025 luke.geek.nz. Powered by coffee, clouds and hamsters on wheels!</div></div></div></footer></div>
</body>
</html>